/**
 * @license
 * lodash 4.11.1 (Custom Build) <https://lodash.com/>
 * Build: `lodash -o ./dist/lodash.js`
 * Copyright jQuery Foundation and other contributors <https://jquery.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */
;(function() {

  /** Used as a safe reference for `undefined` in pre-ES5 environments. */
  var undefined;

  /** Used as the semantic version number. */
  var VERSION = '4.11.1';

  /** Used as the size to enable large array optimizations. */
  var LARGE_ARRAY_SIZE = 200;

  /** Used as the `TypeError` message for "Functions" methods. */
  var FUNC_ERROR_TEXT = 'Expected a function';

  /** Used to stand-in for `undefined` hash values. */
  var HASH_UNDEFINED = '__lodash_hash_undefined__';

  /** Used as the internal argument placeholder. */
  var PLACEHOLDER = '__lodash_placeholder__';

  /** Used to compose bitmasks for wrapper metadata. */
  var BIND_FLAG = 1,
      BIND_KEY_FLAG = 2,
      CURRY_BOUND_FLAG = 4,
      CURRY_FLAG = 8,
      CURRY_RIGHT_FLAG = 16,
      PARTIAL_FLAG = 32,
      PARTIAL_RIGHT_FLAG = 64,
      ARY_FLAG = 128,
      REARG_FLAG = 256,
      FLIP_FLAG = 512;

  /** Used to compose bitmasks for comparison styles. */
  var UNORDERED_COMPARE_FLAG = 1,
      PARTIAL_COMPARE_FLAG = 2;

  /** Used as default options for `_.truncate`. */
  var DEFAULT_TRUNC_LENGTH = 30,
      DEFAULT_TRUNC_OMISSION = '...';

  /** Used to detect hot functions by number of calls within a span of milliseconds. */
  var HOT_COUNT = 150,
      HOT_SPAN = 16;

  /** Used to indicate the type of lazy iteratees. */
  var LAZY_FILTER_FLAG = 1,
      LAZY_MAP_FLAG = 2,
      LAZY_WHILE_FLAG = 3;

  /** Used as references for various `Number` constants. */
  var INFINITY = 1 / 0,
      MAX_SAFE_INTEGER = 9007199254740991,
      MAX_INTEGER = 1.7976931348623157e+308,
      NAN = 0 / 0;

  /** Used as references for the maximum length and index of an array. */
  var MAX_ARRAY_LENGTH = 4294967295,
      MAX_ARRAY_INDEX = MAX_ARRAY_LENGTH - 1,
      HALF_MAX_ARRAY_LENGTH = MAX_ARRAY_LENGTH >>> 1;

  /** `Object#toString` result references. */
  var argsTag = '[object Arguments]',
      arrayTag = '[object Array]',
      boolTag = '[object Boolean]',
      dateTag = '[object Date]',
      errorTag = '[object Error]',
      funcTag = '[object Function]',
      genTag = '[object GeneratorFunction]',
      mapTag = '[object Map]',
      numberTag = '[object Number]',
      objectTag = '[object Object]',
      promiseTag = '[object Promise]',
      regexpTag = '[object RegExp]',
      setTag = '[object Set]',
      stringTag = '[object String]',
      symbolTag = '[object Symbol]',
      weakMapTag = '[object WeakMap]',
      weakSetTag = '[object WeakSet]';

  var arrayBufferTag = '[object ArrayBuffer]',
      dataViewTag = '[object DataView]',
      float32Tag = '[object Float32Array]',
      float64Tag = '[object Float64Array]',
      int8Tag = '[object Int8Array]',
      int16Tag = '[object Int16Array]',
      int32Tag = '[object Int32Array]',
      uint8Tag = '[object Uint8Array]',
      uint8ClampedTag = '[object Uint8ClampedArray]',
      uint16Tag = '[object Uint16Array]',
      uint32Tag = '[object Uint32Array]';

  /** Used to match empty string literals in compiled template source. */
  var reEmptyStringLeading = /\b__p \+= '';/g,
      reEmptyStringMiddle = /\b(__p \+=) '' \+/g,
      reEmptyStringTrailing = /(__e\(.*?\)|\b__t\)) \+\n'';/g;

  /** Used to match HTML entities and HTML characters. */
  var reEscapedHtml = /&(?:amp|lt|gt|quot|#39|#96);/g,
      reUnescapedHtml = /[&<>"'`]/g,
      reHasEscapedHtml = RegExp(reEscapedHtml.source),
      reHasUnescapedHtml = RegExp(reUnescapedHtml.source);

  /** Used to match template delimiters. */
  var reEscape = /<%-([\s\S]+?)%>/g,
      reEvaluate = /<%([\s\S]+?)%>/g,
      reInterpolate = /<%=([\s\S]+?)%>/g;

  /** Used to match property names within property paths. */
  var reIsDeepProp = /\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,
      reIsPlainProp = /^\w*$/,
      rePropName = /[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]/g;

  /**
   * Used to match `RegExp`
   * [syntax characters](http://ecma-international.org/ecma-262/6.0/#sec-patterns).
   */
  var reRegExpChar = /[\\^$.*+?()[\]{}|]/g,
      reHasRegExpChar = RegExp(reRegExpChar.source);

  /** Used to match leading and trailing whitespace. */
  var reTrim = /^\s+|\s+$/g,
      reTrimStart = /^\s+/,
      reTrimEnd = /\s+$/;

  /** Used to match non-compound words composed of alphanumeric characters. */
  var reBasicWord = /[a-zA-Z0-9]+/g;

  /** Used to match backslashes in property paths. */
  var reEscapeChar = /\\(\\)?/g;

  /**
   * Used to match
   * [ES template delimiters](http://ecma-international.org/ecma-262/6.0/#sec-template-literal-lexical-components).
   */
  var reEsTemplate = /\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g;

  /** Used to match `RegExp` flags from their coerced string values. */
  var reFlags = /\w*$/;

  /** Used to detect hexadecimal string values. */
  var reHasHexPrefix = /^0x/i;

  /** Used to detect bad signed hexadecimal string values. */
  var reIsBadHex = /^[-+]0x[0-9a-f]+$/i;

  /** Used to detect binary string values. */
  var reIsBinary = /^0b[01]+$/i;

  /** Used to detect host constructors (Safari). */
  var reIsHostCtor = /^\[object .+?Constructor\]$/;

  /** Used to detect octal string values. */
  var reIsOctal = /^0o[0-7]+$/i;

  /** Used to detect unsigned integer values. */
  var reIsUint = /^(?:0|[1-9]\d*)$/;

  /** Used to match latin-1 supplementary letters (excluding mathematical operators). */
  var reLatin1 = /[\xc0-\xd6\xd8-\xde\xdf-\xf6\xf8-\xff]/g;

  /** Used to ensure capturing order of template delimiters. */
  var reNoMatch = /($^)/;

  /** Used to match unescaped characters in compiled string literals. */
  var reUnescapedString = /['\n\r\u2028\u2029\\]/g;

  /** Used to compose unicode character classes. */
  var rsAstralRange = '\\ud800-\\udfff',
      rsComboMarksRange = '\\u0300-\\u036f\\ufe20-\\ufe23',
      rsComboSymbolsRange = '\\u20d0-\\u20f0',
      rsDingbatRange = '\\u2700-\\u27bf',
      rsLowerRange = 'a-z\\xdf-\\xf6\\xf8-\\xff',
      rsMathOpRange = '\\xac\\xb1\\xd7\\xf7',
      rsNonCharRange = '\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf',
      rsQuoteRange = '\\u2018\\u2019\\u201c\\u201d',
      rsSpaceRange = ' \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000',
      rsUpperRange = 'A-Z\\xc0-\\xd6\\xd8-\\xde',
      rsVarRange = '\\ufe0e\\ufe0f',
      rsBreakRange = rsMathOpRange + rsNonCharRange + rsQuoteRange + rsSpaceRange;

  /** Used to compose unicode capture groups. */
  var rsApos = "['\u2019]",
      rsAstral = '[' + rsAstralRange + ']',
      rsBreak = '[' + rsBreakRange + ']',
      rsCombo = '[' + rsComboMarksRange + rsComboSymbolsRange + ']',
      rsDigits = '\\d+',
      rsDingbat = '[' + rsDingbatRange + ']',
      rsLower = '[' + rsLowerRange + ']',
      rsMisc = '[^' + rsAstralRange + rsBreakRange + rsDigits + rsDingbatRange + rsLowerRange + rsUpperRange + ']',
      rsFitz = '\\ud83c[\\udffb-\\udfff]',
      rsModifier = '(?:' + rsCombo + '|' + rsFitz + ')',
      rsNonAstral = '[^' + rsAstralRange + ']',
      rsRegional = '(?:\\ud83c[\\udde6-\\uddff]){2}',
      rsSurrPair = '[\\ud800-\\udbff][\\udc00-\\udfff]',
      rsUpper = '[' + rsUpperRange + ']',
      rsZWJ = '\\u200d';

  /** Used to compose unicode regexes. */
  var rsLowerMisc = '(?:' + rsLower + '|' + rsMisc + ')',
      rsUpperMisc = '(?:' + rsUpper + '|' + rsMisc + ')',
      rsOptLowerContr = '(?:' + rsApos + '(?:d|ll|m|re|s|t|ve))?',
      rsOptUpperContr = '(?:' + rsApos + '(?:D|LL|M|RE|S|T|VE))?',
      reOptMod = rsModifier + '?',
      rsOptVar = '[' + rsVarRange + ']?',
      rsOptJoin = '(?:' + rsZWJ + '(?:' + [rsNonAstral, rsRegional, rsSurrPair].join('|') + ')' + rsOptVar + reOptMod + ')*',
      rsSeq = rsOptVar + reOptMod + rsOptJoin,
      rsEmoji = '(?:' + [rsDingbat, rsRegional, rsSurrPair].join('|') + ')' + rsSeq,
      rsSymbol = '(?:' + [rsNonAstral + rsCombo + '?', rsCombo, rsRegional, rsSurrPair, rsAstral].join('|') + ')';

  /** Used to match apostrophes. */
  var reApos = RegExp(rsApos, 'g');

  /**
   * Used to match [combining diacritical marks](https://en.wikipedia.org/wiki/Combining_Diacritical_Marks) and
   * [combining diacritical marks for symbols](https://en.wikipedia.org/wiki/Combining_Diacritical_Marks_for_Symbols).
   */
  var reComboMark = RegExp(rsCombo, 'g');

  /** Used to match [string symbols](https://mathiasbynens.be/notes/javascript-unicode). */
  var reComplexSymbol = RegExp(rsFitz + '(?=' + rsFitz + ')|' + rsSymbol + rsSeq, 'g');

  /** Used to match complex or compound words. */
  var reComplexWord = RegExp([
    rsUpper + '?' + rsLower + '+' + rsOptLowerContr + '(?=' + [rsBreak, rsUpper, '$'].join('|') + ')',
    rsUpperMisc + '+' + rsOptUpperContr + '(?=' + [rsBreak, rsUpper + rsLowerMisc, '$'].join('|') + ')',
    rsUpper + '?' + rsLowerMisc + '+' + rsOptLowerContr,
    rsUpper + '+' + rsOptUpperContr,
    rsDigits,
    rsEmoji
  ].join('|'), 'g');

  /** Used to detect strings with [zero-width joiners or code points from the astral planes](http://eev.ee/blog/2015/09/12/dark-corners-of-unicode/). */
  var reHasComplexSymbol = RegExp('[' + rsZWJ + rsAstralRange  + rsComboMarksRange + rsComboSymbolsRange + rsVarRange + ']');

  /** Used to detect strings that need a more robust regexp to match words. */
  var reHasComplexWord = /[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/;

  /** Used to assign default `context` object properties. */
  var contextProps = [
    'Array', 'Buffer', 'DataView', 'Date', 'Error', 'Float32Array', 'Float64Array',
    'Function', 'Int8Array', 'Int16Array', 'Int32Array', 'Map', 'Math', 'Object',
    'Promise', 'Reflect', 'RegExp', 'Set', 'String', 'Symbol', 'TypeError',
    'Uint8Array', 'Uint8ClampedArray', 'Uint16Array', 'Uint32Array', 'WeakMap',
    '_', 'clearTimeout', 'isFinite', 'parseInt', 'setTimeout'
  ];

  /** Used to make template sourceURLs easier to identify. */
  var templateCounter = -1;

  /** Used to identify `toStringTag` values of typed arrays. */
  var typedArrayTags = {};
  typedArrayTags[float32Tag] = typedArrayTags[float64Tag] =
  typedArrayTags[int8Tag] = typedArrayTags[int16Tag] =
  typedArrayTags[int32Tag] = typedArrayTags[uint8Tag] =
  typedArrayTags[uint8ClampedTag] = typedArrayTags[uint16Tag] =
  typedArrayTags[uint32Tag] = true;
  typedArrayTags[argsTag] = typedArrayTags[arrayTag] =
  typedArrayTags[arrayBufferTag] = typedArrayTags[boolTag] =
  typedArrayTags[dataViewTag] = typedArrayTags[dateTag] =
  typedArrayTags[errorTag] = typedArrayTags[funcTag] =
  typedArrayTags[mapTag] = typedArrayTags[numberTag] =
  typedArrayTags[objectTag] = typedArrayTags[regexpTag] =
  typedArrayTags[setTag] = typedArrayTags[stringTag] =
  typedArrayTags[weakMapTag] = false;

  /** Used to identify `toStringTag` values supported by `_.clone`. */
  var cloneableTags = {};
  cloneableTags[argsTag] = cloneableTags[arrayTag] =
  cloneableTags[arrayBufferTag] = cloneableTags[dataViewTag] =
  cloneableTags[boolTag] = cloneableTags[dateTag] =
  cloneableTags[float32Tag] = cloneableTags[float64Tag] =
  cloneableTags[int8Tag] = cloneableTags[int16Tag] =
  cloneableTags[int32Tag] = cloneableTags[mapTag] =
  cloneableTags[numberTag] = cloneableTags[objectTag] =
  cloneableTags[regexpTag] = cloneableTags[setTag] =
  cloneableTags[stringTag] = cloneableTags[symbolTag] =
  cloneableTags[uint8Tag] = cloneableTags[uint8ClampedTag] =
  cloneableTags[uint16Tag] = cloneableTags[uint32Tag] = true;
  cloneableTags[errorTag] = cloneableTags[funcTag] =
  cloneableTags[weakMapTag] = false;

  /** Used to map latin-1 supplementary letters to basic latin letters. */
  var deburredLetters = {
    '\xc0': 'A',  '\xc1': 'A', '\xc2': 'A', '\xc3': 'A', '\xc4': 'A', '\xc5': 'A',
    '\xe0': 'a',  '\xe1': 'a', '\xe2': 'a', '\xe3': 'a', '\xe4': 'a', '\xe5': 'a',
    '\xc7': 'C',  '\xe7': 'c',
    '\xd0': 'D',  '\xf0': 'd',
    '\xc8': 'E',  '\xc9': 'E', '\xca': 'E', '\xcb': 'E',
    '\xe8': 'e',  '\xe9': 'e', '\xea': 'e', '\xeb': 'e',
    '\xcC': 'I',  '\xcd': 'I', '\xce': 'I', '\xcf': 'I',
    '\xeC': 'i',  '\xed': 'i', '\xee': 'i', '\xef': 'i',
    '\xd1': 'N',  '\xf1': 'n',
    '\xd2': 'O',  '\xd3': 'O', '\xd4': 'O', '\xd5': 'O', '\xd6': 'O', '\xd8': 'O',
    '\xf2': 'o',  '\xf3': 'o', '\xf4': 'o', '\xf5': 'o', '\xf6': 'o', '\xf8': 'o',
    '\xd9': 'U',  '\xda': 'U', '\xdb': 'U', '\xdc': 'U',
    '\xf9': 'u',  '\xfa': 'u', '\xfb': 'u', '\xfc': 'u',
    '\xdd': 'Y',  '\xfd': 'y', '\xff': 'y',
    '\xc6': 'Ae', '\xe6': 'ae',
    '\xde': 'Th', '\xfe': 'th',
    '\xdf': 'ss'
  };

  /** Used to map characters to HTML entities. */
  var htmlEscapes = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
    '`': '&#96;'
  };

  /** Used to map HTML entities to characters. */
  var htmlUnescapes = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&#39;': "'",
    '&#96;': '`'
  };

  /** Used to determine if values are of the language type `Object`. */
  var objectTypes = {
    'function': true,
    'object': true
  };

  /** Used to escape characters for inclusion in compiled string literals. */
  var stringEscapes = {
    '\\': '\\',
    "'": "'",
    '\n': 'n',
    '\r': 'r',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
  };

  /** Built-in method references without a dependency on `root`. */
  var freeParseFloat = parseFloat,
      freeParseInt = parseInt;

  /** Detect free variable `exports`. */
  var freeExports = (objectTypes[typeof exports] && exports && !exports.nodeType)
    ? exports
    : undefined;

  /** Detect free variable `module`. */
  var freeModule = (objectTypes[typeof module] && module && !module.nodeType)
    ? module
    : undefined;

  /** Detect the popular CommonJS extension `module.exports`. */
  var moduleExports = (freeModule && freeModule.exports === freeExports)
    ? freeExports
    : undefined;

  /** Detect free variable `global` from Node.js. */
  var freeGlobal = checkGlobal(freeExports && freeModule && typeof global == 'object' && global);

  /** Detect free variable `self`. */
  var freeSelf = checkGlobal(objectTypes[typeof self] && self);

  /** Detect free variable `window`. */
  var freeWindow = checkGlobal(objectTypes[typeof window] && window);

  /** Detect `this` as the global object. */
  var thisGlobal = checkGlobal(objectTypes[typeof this] && this);

  /**
   * Used as a reference to the global object.
   *
   * The `this` value is used if it's the global object to avoid Greasemonkey's
   * restricted `window` object, otherwise the `window` object is used.
   */
  var root = freeGlobal ||
    ((freeWindow !== (thisGlobal && thisGlobal.window)) && freeWindow) ||
      freeSelf || thisGlobal || Function('return this')();

  /*--------------------------------------------------------------------------*/

  /**
   * Adds the key-value `pair` to `map`.
   *
   * @private
   * @param {Object} map The map to modify.
   * @param {Array} pair The key-value pair to add.
   * @returns {Object} Returns `map`.
   */
  function addMapEntry(map, pair) {
    // Don't return `Map#set` because it doesn't return the map instance in IE 11.
    map.set(pair[0], pair[1]);
    return map;
  }

  /**
   * Adds `value` to `set`.
   *
   * @private
   * @param {Object} set The set to modify.
   * @param {*} value The value to add.
   * @returns {Object} Returns `set`.
   */
  function addSetEntry(set, value) {
    set.add(value);
    return set;
  }

  /**
   * A faster alternative to `Function#apply`, this function invokes `func`
   * with the `this` binding of `thisArg` and the arguments of `args`.
   *
   * @private
   * @param {Function} func The function to invoke.
   * @param {*} thisArg The `this` binding of `func`.
   * @param {Array} args The arguments to invoke `func` with.
   * @returns {*} Returns the result of `func`.
   */
  function apply(func, thisArg, args) {
    var length = args.length;
    switch (length) {
      case 0: return func.call(thisArg);
      case 1: return func.call(thisArg, args[0]);
      case 2: return func.call(thisArg, args[0], args[1]);
      case 3: return func.call(thisArg, args[0], args[1], args[2]);
    }
    return func.apply(thisArg, args);
  }

  /**
   * A specialized version of `baseAggregator` for arrays.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} setter The function to set `accumulator` values.
   * @param {Function} iteratee The iteratee to transform keys.
   * @param {Object} accumulator The initial aggregated object.
   * @returns {Function} Returns `accumulator`.
   */
  function arrayAggregator(array, setter, iteratee, accumulator) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      var value = array[index];
      setter(accumulator, value, iteratee(value), array);
    }
    return accumulator;
  }

  /**
   * Creates a new array concatenating `array` with `other`.
   *
   * @private
   * @param {Array} array The first array to concatenate.
   * @param {Array} other The second array to concatenate.
   * @returns {Array} Returns the new concatenated array.
   */
  function arrayConcat(array, other) {
    var index = -1,
        length = array.length,
        othIndex = -1,
        othLength = other.length,
        result = Array(length + othLength);

    while (++index < length) {
      result[index] = array[index];
    }
    while (++othIndex < othLength) {
      result[index++] = other[othIndex];
    }
    return result;
  }

  /**
   * A specialized version of `_.forEach` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {Array} Returns `array`.
   */
  function arrayEach(array, iteratee) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      if (iteratee(array[index], index, array) === false) {
        break;
      }
    }
    return array;
  }

  /**
   * A specialized version of `_.forEachRight` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {Array} Returns `array`.
   */
  function arrayEachRight(array, iteratee) {
    var length = array.length;

    while (length--) {
      if (iteratee(array[length], length, array) === false) {
        break;
      }
    }
    return array;
  }

  /**
   * A specialized version of `_.every` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} predicate The function invoked per iteration.
   * @returns {boolean} Returns `true` if all elements pass the predicate check,
   *  else `false`.
   */
  function arrayEvery(array, predicate) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      if (!predicate(array[index], index, array)) {
        return false;
      }
    }
    return true;
  }

  /**
   * A specialized version of `_.filter` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} predicate The function invoked per iteration.
   * @returns {Array} Returns the new filtered array.
   */
  function arrayFilter(array, predicate) {
    var index = -1,
        length = array.length,
        resIndex = 0,
        result = [];

    while (++index < length) {
      var value = array[index];
      if (predicate(value, index, array)) {
        result[resIndex++] = value;
      }
    }
    return result;
  }

  /**
   * A specialized version of `_.includes` for arrays without support for
   * specifying an index to search from.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {*} target The value to search for.
   * @returns {boolean} Returns `true` if `target` is found, else `false`.
   */
  function arrayIncludes(array, value) {
    return !!array.length && baseIndexOf(array, value, 0) > -1;
  }

  /**
   * This function is like `arrayIncludes` except that it accepts a comparator.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {*} target The value to search for.
   * @param {Function} comparator The comparator invoked per element.
   * @returns {boolean} Returns `true` if `target` is found, else `false`.
   */
  function arrayIncludesWith(array, value, comparator) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      if (comparator(value, array[index])) {
        return true;
      }
    }
    return false;
  }

  /**
   * A specialized version of `_.map` for arrays without support for iteratee
   * shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {Array} Returns the new mapped array.
   */
  function arrayMap(array, iteratee) {
    var index = -1,
        length = array.length,
        result = Array(length);

    while (++index < length) {
      result[index] = iteratee(array[index], index, array);
    }
    return result;
  }

  /**
   * Appends the elements of `values` to `array`.
   *
   * @private
   * @param {Array} array The array to modify.
   * @param {Array} values The values to append.
   * @returns {Array} Returns `array`.
   */
  function arrayPush(array, values) {
    var index = -1,
        length = values.length,
        offset = array.length;

    while (++index < length) {
      array[offset + index] = values[index];
    }
    return array;
  }

  /**
   * A specialized version of `_.reduce` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @param {*} [accumulator] The initial value.
   * @param {boolean} [initAccum] Specify using the first element of `array` as
   *  the initial value.
   * @returns {*} Returns the accumulated value.
   */
  function arrayReduce(array, iteratee, accumulator, initAccum) {
    var index = -1,
        length = array.length;

    if (initAccum && length) {
      accumulator = array[++index];
    }
    while (++index < length) {
      accumulator = iteratee(accumulator, array[index], index, array);
    }
    return accumulator;
  }

  /**
   * A specialized version of `_.reduceRight` for arrays without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @param {*} [accumulator] The initial value.
   * @param {boolean} [initAccum] Specify using the last element of `array` as
   *  the initial value.
   * @returns {*} Returns the accumulated value.
   */
  function arrayReduceRight(array, iteratee, accumulator, initAccum) {
    var length = array.length;
    if (initAccum && length) {
      accumulator = array[--length];
    }
    while (length--) {
      accumulator = iteratee(accumulator, array[length], length, array);
    }
    return accumulator;
  }

  /**
   * A specialized version of `_.some` for arrays without support for iteratee
   * shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} predicate The function invoked per iteration.
   * @returns {boolean} Returns `true` if any element passes the predicate check,
   *  else `false`.
   */
  function arraySome(array, predicate) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      if (predicate(array[index], index, array)) {
        return true;
      }
    }
    return false;
  }

  /**
   * The base implementation of methods like `_.max` and `_.min` which accepts a
   * `comparator` to determine the extremum value.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The iteratee invoked per iteration.
   * @param {Function} comparator The comparator used to compare values.
   * @returns {*} Returns the extremum value.
   */
  function baseExtremum(array, iteratee, comparator) {
    var index = -1,
        length = array.length;

    while (++index < length) {
      var value = array[index],
          current = iteratee(value);

      if (current != null && (computed === undefined
            ? current === current
            : comparator(current, computed)
          )) {
        var computed = current,
            result = value;
      }
    }
    return result;
  }

  /**
   * The base implementation of methods like `_.find` and `_.findKey`, without
   * support for iteratee shorthands, which iterates over `collection` using
   * `eachFunc`.
   *
   * @private
   * @param {Array|Object} collection The collection to search.
   * @param {Function} predicate The function invoked per iteration.
   * @param {Function} eachFunc The function to iterate over `collection`.
   * @param {boolean} [retKey] Specify returning the key of the found element
   *  instead of the element itself.
   * @returns {*} Returns the found element or its key, else `undefined`.
   */
  function baseFind(collection, predicate, eachFunc, retKey) {
    var result;
    eachFunc(collection, function(value, key, collection) {
      if (predicate(value, key, collection)) {
        result = retKey ? key : value;
        return false;
      }
    });
    return result;
  }

  /**
   * The base implementation of `_.findIndex` and `_.findLastIndex` without
   * support for iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {Function} predicate The function invoked per iteration.
   * @param {boolean} [fromRight] Specify iterating from right to left.
   * @returns {number} Returns the index of the matched value, else `-1`.
   */
  function baseFindIndex(array, predicate, fromRight) {
    var length = array.length,
        index = fromRight ? length : -1;

    while ((fromRight ? index-- : ++index < length)) {
      if (predicate(array[index], index, array)) {
        return index;
      }
    }
    return -1;
  }

  /**
   * The base implementation of `_.indexOf` without `fromIndex` bounds checks.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {*} value The value to search for.
   * @param {number} fromIndex The index to search from.
   * @returns {number} Returns the index of the matched value, else `-1`.
   */
  function baseIndexOf(array, value, fromIndex) {
    if (value !== value) {
      return indexOfNaN(array, fromIndex);
    }
    var index = fromIndex - 1,
        length = array.length;

    while (++index < length) {
      if (array[index] === value) {
        return index;
      }
    }
    return -1;
  }

  /**
   * This function is like `baseIndexOf` except that it accepts a comparator.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {*} value The value to search for.
   * @param {number} fromIndex The index to search from.
   * @param {Function} comparator The comparator invoked per element.
   * @returns {number} Returns the index of the matched value, else `-1`.
   */
  function baseIndexOfWith(array, value, fromIndex, comparator) {
    var index = fromIndex - 1,
        length = array.length;

    while (++index < length) {
      if (comparator(array[index], value)) {
        return index;
      }
    }
    return -1;
  }

  /**
   * The base implementation of `_.mean` and `_.meanBy` without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {number} Returns the mean.
   */
  function baseMean(array, iteratee) {
    var length = array ? array.length : 0;
    return length ? (baseSum(array, iteratee) / length) : NAN;
  }

  /**
   * The base implementation of `_.reduce` and `_.reduceRight`, without support
   * for iteratee shorthands, which iterates over `collection` using `eachFunc`.
   *
   * @private
   * @param {Array|Object} collection The collection to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @param {*} accumulator The initial value.
   * @param {boolean} initAccum Specify using the first or last element of
   *  `collection` as the initial value.
   * @param {Function} eachFunc The function to iterate over `collection`.
   * @returns {*} Returns the accumulated value.
   */
  function baseReduce(collection, iteratee, accumulator, initAccum, eachFunc) {
    eachFunc(collection, function(value, index, collection) {
      accumulator = initAccum
        ? (initAccum = false, value)
        : iteratee(accumulator, value, index, collection);
    });
    return accumulator;
  }

  /**
   * The base implementation of `_.sortBy` which uses `comparer` to define the
   * sort order of `array` and replaces criteria objects with their corresponding
   * values.
   *
   * @private
   * @param {Array} array The array to sort.
   * @param {Function} comparer The function to define sort order.
   * @returns {Array} Returns `array`.
   */
  function baseSortBy(array, comparer) {
    var length = array.length;

    array.sort(comparer);
    while (length--) {
      array[length] = array[length].value;
    }
    return array;
  }

  /**
   * The base implementation of `_.sum` and `_.sumBy` without support for
   * iteratee shorthands.
   *
   * @private
   * @param {Array} array The array to iterate over.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {number} Returns the sum.
   */
  function baseSum(array, iteratee) {
    var result,
        index = -1,
        length = array.length;

    while (++index < length) {
      var current = iteratee(array[index]);
      if (current !== undefined) {
        result = result === undefined ? current : (result + current);
      }
    }
    return result;
  }

  /**
   * The base implementation of `_.times` without support for iteratee shorthands
   * or max array length checks.
   *
   * @private
   * @param {number} n The number of times to invoke `iteratee`.
   * @param {Function} iteratee The function invoked per iteration.
   * @returns {Array} Returns the array of results.
   */
  function baseTimes(n, iteratee) {
    var index = -1,
        result = Array(n);

    while (++index < n) {
      result[index] = iteratee(index);
    }
    return result;
  }

  /**
   * The base implementation of `_.toPairs` and `_.toPairsIn` which creates an array
   * of key-value pairs for `object` corresponding to the property names of `props`.
   *
   * @private
   * @param {Object} object The object to query.
   * @param {Array} props The property names to get values for.
   * @returns {Object} Returns the new array of key-value pairs.
   */
  function baseToPairs(object, props) {
    return arrayMap(props, function(key) {
      return [key, object[key]];
    });
  }

  /**
   * The base implementation of `_.unary` without support for storing wrapper metadata.
   *
   * @private
   * @param {Function} func The function to cap arguments for.
   * @returns {Function} Returns the new function.
   */
  function baseUnary(func) {
    return function(value) {
      return func(value);
    };
  }

  /**
   * The base implementation of `_.values` and `_.valuesIn` which creates an
   * array of `object` property values corresponding to the property names
   * of `props`.
   *
   * @private
   * @param {Object} object The object to query.
   * @param {Array} props The property names to get values for.
   * @returns {Object} Returns the array of property values.
   */
  function baseValues(object, props) {
    return arrayMap(props, function(key) {
      return object[key];
    });
  }

  /**
   * Used by `_.trim` and `_.trimStart` to get the index of the first string symbol
   * that is not found in the character symbols.
   *
   * @private
   * @param {Array} strSymbols The string symbols to inspect.
   * @param {Array} chrSymbols The character symbols to find.
   * @returns {number} Returns the index of the first unmatched string symbol.
   */
  function charsStartIndex(strSymbols, chrSymbols) {
    var index = -1,
        length = strSymbols.length;

    while (++index < length && baseIndexOf(chrSymbols, strSymbols[index], 0) > -1) {}
    return index;
  }

  /**
   * Used by `_.trim` and `_.trimEnd` to get the index of the last string symbol
   * that is not found in the character symbols.
   *
   * @private
   * @param {Array} strSymbols The string symbols to inspect.
   * @param {Array} chrSymbols The character symbols to find.
   * @returns {number} Returns the index of the last unmatched string symbol.
   */
  function charsEndIndex(strSymbols, chrSymbols) {
    var index = strSymbols.length;

    while (index-- && baseIndexOf(chrSymbols, strSymbols[index], 0) > -1) {}
    return index;
  }

  /**
   * Checks if `value` is a global object.
   *
   * @private
   * @param {*} value The value to check.
   * @returns {null|Object} Returns `value` if it's a global object, else `null`.
   */
  function checkGlobal(value) {
    return (value && value.Object === Object) ? value : null;
  }

  /**
   * Compares values to sort them in ascending order.
   *
   * @private
   * @param {*} value The value to compare.
   * @param {*} other The other value to compare.
   * @returns {number} Returns the sort order indicator for `value`.
   */
  function compareAscending(value, other) {
    if (value !== other) {
      var valIsNull = value === null,
          valIsUndef = value === undefined,
          valIsReflexive = value === value;

      var othIsNull = other === null,
          othIsUndef = other === undefined,
          othIsReflexive = other === other;

      if ((value > other && !othIsNull) || !valIsReflexive ||
          (valIsNull && !othIsUndef && othIsReflexive) ||
          (valIsUndef && othIsReflexive)) {
        return 1;
      }
      if ((value < other && !valIsNull) || !othIsReflexive ||
          (othIsNull && !valIsUndef && valIsReflexive) ||
          (othIsUndef && valIsReflexive)) {
        return -1;
      }
    }
    return 0;
  }

  /**
   * Used by `_.orderBy` to compare multiple properties of a value to another
   * and stable sort them.
   *
   * If `orders` is unspecified, all values are sorted in ascending order. Otherwise,
   * specify an order of "desc" for descending or "asc" for ascending sort order
   * of corresponding values.
   *
   * @private
   * @param {Object} object The object to compare.
   * @param {Object} other The other object to compare.
   * @param {boolean[]|string[]} orders The order to sort by for each property.
   * @returns {number} Returns the sort order indicator for `object`.
   */
  function compareMultiple(object, other, orders) {
    var index = -1,
        objCriteria = object.criteria,
        othCriteria = other.criteria,
        length = objCriteria.length,
        ordersLength = orders.length;

    while (++index < length) {
      var result = compareAscending(objCriteria[index], othCriteria[index]);
      if (result) {
        if (index >= ordersLength) {
          return result;
        }
        var order = orders[index];
        return result * (order == 'desc' ? -1 : 1);
      }
    }
    // Fixes an `Array#sort` bug in the JS engine embedded in Adobe applications
    // that causes it, under certain circumstances, to provide the same value for
    // `object` and `other`. See https://github.com/jashkenas/underscore/pull/1247
    // for more details.
    //
    // This also ensures a stable sort in V8 and other engines.
    // See https://bugs.chromium.org/p/v8/issues/detail?id=90 for more details.
    return object.index - other.index;
  }

  /**
   * Gets the number of `placeholder` occurrences in `array`.
   *
   * @private
   * @param {Array} array The array to inspect.
   * @param {*} placeholder The placeholder to search for.
   * @returns {number} Returns the placeholder count.
   */
  function countHolders(array, placeholder) {
    var length = array.length,
        result = 0;

    while (length--) {
      if (array[length] === placeholder) {
        result++;
      }
    }
    return result;
  }

  /**
   * Creates a function that performs a mathematical operation on two values.
   *
   * @private
   * @param {Function} operator The function to perform the operation.
   * @returns {Function} Returns the new mathematical operation function.
   */
  function createMathOperation(operator) {
    return function(value, other) {
      var result;
      if (value === undefined && other === undefined) {
        return 0;
      }
      if (value !== undefined) {
        result = value;
      }
      if (other !== undefined) {
        result = result === undefined ? other : operator(result, other);
      }
      return result;
    };
  }

  /**
   * Used by `_.deburr` to convert latin-1 supplementary letters to basic latin letters.
   *
   * @private
   * @param {string} letter The matched letter to deburr.
   * @returns {string} Returns the deburred letter.
   */
  function deburrLetter(letter) {
    return deburredLetters[letter];
  }

  /**
   * Used by `_.escape` to convert characters to HTML entities.
   *
   * @private
   * @param {string} chr The matched character to escape.
   * @returns {string} Returns the escaped character.
   */
  function escapeHtmlChar(chr) {
    return htmlEscapes[chr];
  }

  /**
   * Used by `_.template` to escape characters for inclusion in compiled string literals.
   *
   * @private
   * @param {string} chr The matched character to escape.
   * @returns {string} Returns the escaped character.
   */
  function escapeStringChar(chr) {
    return '\\' + stringEscapes[chr];
  }

  /**
   * Gets the index at which the first occurrence of `NaN` is found in `array`.
   *
   * @private
   * @param {Array} array The array to search.
   * @param {number} fromIndex The index to search from.
   * @param {boolean} [fromRight] Specify iterating from right to left.
   * @returns {number} Returns the index of the matched `NaN`, else `-1`.
   */
  function indexOfNaN(array, fromIndex, fromRight) {
    var length = array.length,
        index = fromIndex + (fromRight ? 0 : -1);

    while ((fromRight ? index-- : ++index < length)) {
      var other = array[index];
      if (other !== other) {
        return index;
      }
    }
    return -1;
  }

  /**
   * Checks if `value` is a host object in IE < 9.
   *
   * @private
   * @param {*} value The value to check.
   * @returns {boolean} Returns `true` if `value` is a host object, else `false`.
   */
  function isHostObject(value) {
    // Many host objects are `Object` objects that can coerce to strings
    // despite having improperly defined `toString` methods.
    var result = false;
    if (value != null && typeof value.toString != 'function') {
      try {
        result = !!(value + '');
      } catch (e) {}
    }
    return result;
  }

  /**
   * Checks if `value` is a valid array-like index.
   *
   * @private
   * @param {*} value The value to check.
   * @param {number} [length=MAX_SAFE_INTEGER] The upper bounds of a valid index.
   * @returns {boolean} Returns `true` if `value` is a valid index, else `false`.
   */
  function isIndex(value, length) {
    value = (typeof value == 'number' || reIsUint.test(value)) ? +value : -1;
    length = length == null ? MAX_SAFE_INTEGER : length;
    return value > -1 && value % 1 == 0 && value < length;
  }

  /**
   * Converts `iterator` to an array.
   *
   * @private
   * @param {Object} iterator The iterator to convert.
   * @returns {Array} Returns the converted array.
   */
  function iteratorToArray(iterator) {
    var data,
        result = [];

    while (!(data = iterator.next()).done) {
      result.push(data.value);
    }
    return result;
  }

  /**
   * Converts `map` to an array.
   *
   * @private
   * @param {Object} map The map to convert.
   * @returns {Array} Returns the converted array.
   */
  function mapToArray(map) {
    var index = -1,
        result = Array(map.size);

    map.forEach(function(value, key) {
      result[++index] = [key, value];
    });
    return result;
  }

  /**
   * Replaces all `placeholder` elements in `array` with an internal placeholder
   * and returns an array of their indexes.
   *
   * @private
   * @param {Array} array The array to modify.
   * @param {*} placeholder The placeholder to replace.
   * @returns {Array} Returns the new array of placeholder indexes.
   */
  function replaceHolders(array, placeholder) {
    var index = -1,
        length = array.length,
        resIndex = 0,
        result = [];

    while (++index < length) {
      var value = array[index];
      if (value === placeholder || value === PLACEHOLDER) {
        array[index] = PLACEHOLDER;
        result[resIndex++] = index;
      }
    }
    return result;
  }

  /**
   * Converts `set` to an array.
   *
   * @private
   * @param {Object} set The set to convert.
   * @returns {Array} Returns the converted array.
   */
  function setToArray(set) {
    var index = -1,
        result = Array(set.size);

    set.forEach(function(value) {
      result[++index] = value;
    });
    return result;
  }

  /**
   * Gets the number of symbols in `string`.
   *
   * @private
   * @param {string} string The string to inspect.
   * @returns {number} Returns the string size.
   */
  function stringSize(string) {
    if (!(string && reHasComplexSymbol.test(string))) {
      return string.length;
    }
    var result = reComplexSymbol.lastIndex = 0;
    while (reComplexSymbol.test(string)) {
      result++;
    }
    return result;
  }

  /**
   * Converts `string` to an array.
   *
   * @private
   * @param {string} string The string to convert.
   * @returns {Array} Returns the converted array.
   */
  function stringToArray(string) {
    return string.match(reComplexSymbol);
  }

  /**
   * Used by `_.unescape` to convert HTML entities to characters.
   *
   * @private
   * @param {string} chr The matched character to unescape.
   * @returns {string} Returns the unescaped character.
   */
  function unescapeHtmlChar(chr) {
    return htmlUnescapes[chr];
  }

  /*--------------------------------------------------------------------------*/

  /**
   * Create a new pristine `lodash` function using the `context` object.
   *
   * @static
   * @memberOf _
   * @since 1.1.0
   * @category Util
   * @param {Object} [context=root] The context object.
   * @returns {Function} Returns a new `lodash` function.
   * @example
   *
   * _.mixin({ 'foo': _.constant('foo') });
   *
   * var lodash = _.runInContext();
   * lodash.mixin({ 'bar': lodash.constant('bar') });
   *
   * _.isFunction(_.foo);
   * // => true
   * _.isFunction(_.bar);
   * // => false
   *
   * lodash.isFunction(lodash.foo);
   * // => false
   * lodash.isFunction(lodash.bar);
   * // => true
   *
   * // Use `context` to mock `Date#getTime` use in `_.now`.
   * var mock = _.runInContext({
   *   'Date': function() {
   *     return { 'getTime': getTimeMock };
   *   }
   * });
   *
   * // Create a suped-up `defer` in Node.js.
   * var defer = _.runInContext({ 'setTimeout': setImmediate }).defer;
   */
  function runInContext(context) {
    context = context ? _.defaults({}, context, _.pick(root, contextProps)) : root;

    /** Built-in constructor references. */
    var Date = context.Date,
        Error = context.Error,
        Math = context.Math,
        RegExp = context.RegExp,
        TypeError = context.TypeError;

    /** Used for built-in method references. */
    var arrayProto = context.Array.prototype,
        objectProto = context.Object.prototype,
        stringProto = context.String.prototype;

    /** Used to resolve the decompiled source of functions. */
    var funcToString = context.Function.prototype.toString;

    /** Used to check objects for own properties. */
    var hasOwnProperty = objectProto.hasOwnProperty;

    /** Used to generate unique IDs. */
    var idCounter = 0;

    /** Used to infer the `Object` constructor. */
    var objectCtorString = funcToString.call(Object);

    /**
     * Used to resolve the
     * [`toStringTag`](http://ecma-international.org/ecma-262/6.0/#sec-object.prototype.tostring)
     * of values.
     */
    var objectToString = objectProto.toString;

    /** Used to restore the original `_` reference in `_.noConflict`. */
    var oldDash = root._;

    /** Used to detect if a method is native. */
    var reIsNative = RegExp('^' +
      funcToString.call(hasOwnProperty).replace(reRegExpChar, '\\$&')
      .replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g, '$1.*?') + '$'
    );

    /** Built-in value references. */
    var Buffer = moduleExports ? context.Buffer : undefined,
        Reflect = context.Reflect,
        Symbol = context.Symbol,
        Uint8Array = context.Uint8Array,
        clearTimeout = context.clearTimeout,
        enumerate = Reflect ? Reflect.enumerate : undefined,
        getOwnPropertySymbols = Object.getOwnPropertySymbols,
        iteratorSymbol = typeof (iteratorSymbol = Symbol && Symbol.iterator) == 'symbol' ? iteratorSymbol : undefined,
        objectCreate = Object.create,
        propertyIsEnumerable = objectProto.propertyIsEnumerable,
        setTimeout = context.setTimeout,
        splice = arrayProto.splice;

    /* Built-in method references for those with the same name as other `lodash` methods. */
    var nativeCeil = Math.ceil,
        nativeFloor = Math.floor,
        nativeGetPrototype = Object.getPrototypeOf,
        nativeIsFinite = context.isFinite,
        nativeJoin = arrayProto.join,
        nativeKeys = Object.keys,
        nativeMax = Math.max,
        nativeMin = Math.min,
        nativeParseInt = context.parseInt,
        nativeRandom = Math.random,
        nativeReplace = stringProto.replace,
        nativeReverse = arrayProto.reverse,
        nativeSplit = stringProto.split;

    /* Built-in method references that are verified to be native. */
    var DataView = getNative(context, 'DataView'),
        Map = getNative(context, 'Map'),
        Promise = getNative(context, 'Promise'),
        Set = getNative(context, 'Set'),
        WeakMap = getNative(context, 'WeakMap'),
        nativeCreate = getNative(Object, 'create');

    /** Used to store function metadata. */
    var metaMap = WeakMap && new WeakMap;

    /** Detect if properties shadowing those on `Object.prototype` are non-enumerable. */
    var nonEnumShadows = !propertyIsEnumerable.call({ 'valueOf': 1 }, 'valueOf');

    /** Used to lookup unminified function names. */
    var realNames = {};

    /** Used to detect maps, sets, and weakmaps. */
    var dataViewCtorString = toSource(DataView),
        mapCtorString = toSource(Map),
        promiseCtorString = toSource(Promise),
        setCtorString = toSource(Set),
        weakMapCtorString = toSource(WeakMap);

    /** Used to convert symbols to primitives and strings. */
    var symbolProto = Symbol ? Symbol.prototype : undefined,
        symbolValueOf = symbolProto ? symbolProto.valueOf : undefined,
        symbolToString = symbolProto ? symbolProto.toString : undefined;

    /*------------------------------------------------------------------------*/

    /**
     * Creates a `lodash` object which wraps `value` to enable implicit method
     * chain sequences. Methods that operate on and return arrays, collections,
     * and functions can be chained together. Methods that retrieve a single value
     * or may return a primitive value will automatically end the chain sequence
     * and return the unwrapped value. Otherwise, the value must be unwrapped
     * with `_#value`.
     *
     * Explicit chain sequences, which must be unwrapped with `_#value`, may be
     * enabled using `_.chain`.
     *
     * The execution of chained methods is lazy, that is, it's deferred until
     * `_#value` is implicitly or explicitly called.
     *
     * Lazy evaluation allows several methods to support shortcut fusion.
     * Shortcut fusion is an optimization to merge iteratee calls; this avoids
     * the creation of intermediate arrays and can greatly reduce the number of
     * iteratee executions. Sections of a chain sequence qualify for shortcut
     * fusion if the section is applied to an array of at least `200` elements
     * and any iteratees accept only one argument. The heuristic for whether a
     * section qualifies for shortcut fusion is subject to change.
     *
     * Chaining is supported in custom builds as long as the `_#value` method is
     * directly or indirectly included in the build.
     *
     * In addition to lodash methods, wrappers have `Array` and `String` methods.
     *
     * The wrapper `Array` methods are:
     * `concat`, `join`, `pop`, `push`, `shift`, `sort`, `splice`, and `unshift`
     *
     * The wrapper `String` methods are:
     * `replace` and `split`
     *
     * The wrapper methods that support shortcut fusion are:
     * `at`, `compact`, `drop`, `dropRight`, `dropWhile`, `filter`, `find`,
     * `findLast`, `head`, `initial`, `last`, `map`, `reject`, `reverse`, `slice`,
     * `tail`, `take`, `takeRight`, `takeRightWhile`, `takeWhile`, and `toArray`
     *
     * The chainable wrapper methods are:
     * `after`, `ary`, `assign`, `assignIn`, `assignInWith`, `assignWith`, `at`,
     * `before`, `bind`, `bindAll`, `bindKey`, `castArray`, `chain`, `chunk`,
     * `commit`, `compact`, `concat`, `conforms`, `constant`, `countBy`, `create`,
     * `curry`, `debounce`, `defaults`, `defaultsDeep`, `defer`, `delay`,
     * `difference`, `differenceBy`, `differenceWith`, `drop`, `dropRight`,
     * `dropRightWhile`, `dropWhile`, `extend`, `extendWith`, `fill`, `filter`,
     * `flatMap`, `flatMapDeep`, `flatMapDepth`, `flatten`, `flattenDeep`,
     * `flattenDepth`, `flip`, `flow`, `flowRight`, `fromPairs`, `functions`,
     * `functionsIn`, `groupBy`, `initial`, `intersection`, `intersectionBy`,
     * `intersectionWith`, `invert`, `invertBy`, `invokeMap`, `iteratee`, `keyBy`,
     * `keys`, `keysIn`, `map`, `mapKeys`, `mapValues`, `matches`, `matchesProperty`,
     * `memoize`, `merge`, `mergeWith`, `method`, `methodOf`, `mixin`, `negate`,
     * `nthArg`, `omit`, `omitBy`, `once`, `orderBy`, `over`, `overArgs`,
     * `overEvery`, `overSome`, `partial`, `partialRight`, `partition`, `pick`,
     * `pickBy`, `plant`, `property`, `propertyOf`, `pull`, `pullAll`, `pullAllBy`,
     * `pullAllWith`, `pullAt`, `push`, `range`, `rangeRight`, `rearg`, `reject`,
     * `remove`, `rest`, `reverse`, `sampleSize`, `set`, `setWith`, `shuffle`,
     * `slice`, `sort`, `sortBy`, `splice`, `spread`, `tail`, `take`, `takeRight`,
     * `takeRightWhile`, `takeWhile`, `tap`, `throttle`, `thru`, `toArray`,
     * `toPairs`, `toPairsIn`, `toPath`, `toPlainObject`, `transform`, `unary`,
     * `union`, `unionBy`, `unionWith`, `uniq`, `uniqBy`, `uniqWith`, `unset`,
     * `unshift`, `unzip`, `unzipWith`, `update`, `updateWith`, `values`,
     * `valuesIn`, `without`, `wrap`, `xor`, `xorBy`, `xorWith`, `zip`,
     * `zipObject`, `zipObjectDeep`, and `zipWith`
     *
     * The wrapper methods that are **not** chainable by default are:
     * `add`, `attempt`, `camelCase`, `capitalize`, `ceil`, `clamp`, `clone`,
     * `cloneDeep`, `cloneDeepWith`, `cloneWith`, `deburr`, `divide`, `each`,
     * `eachRight`, `endsWith`, `eq`, `escape`, `escapeRegExp`, `every`, `find`,
     * `findIndex`, `findKey`, `findLast`, `findLastIndex`, `findLastKey`, `first`,
     * `floor`, `forEach`, `forEachRight`, `forIn`, `forInRight`, `forOwn`,
     * `forOwnRight`, `get`, `gt`, `gte`, `has`, `hasIn`, `head`, `identity`,
     * `includes`, `indexOf`, `inRange`, `invoke`, `isArguments`, `isArray`,
     * `isArrayBuffer`, `isArrayLike`, `isArrayLikeObject`, `isBoolean`, `isBuffer`,
     * `isDate`, `isElement`, `isEmpty`, `isEqual`, `isEqualWith`, `isError`,
     * `isFinite`, `isFunction`, `isInteger`, `isLength`, `isMap`, `isMatch`,
     * `isMatchWith`, `isNaN`, `isNative`, `isNil`, `isNull`, `isNumber`,
     * `isObject`, `isObjectLike`, `isPlainObject`, `isRegExp`, `isSafeInteger`,
     * `isSet`, `isString`, `isUndefined`, `isTypedArray`, `isWeakMap`, `isWeakSet`,
     * `join`, `kebabCase`, `last`, `lastIndexOf`, `lowerCase`, `lowerFirst`,
     * `lt`, `lte`, `max`, `maxBy`, `mean`, `meanBy`, `min`, `minBy`, `multiply`,
     * `noConflict`, `noop`, `now`, `nth`, `pad`, `padEnd`, `padStart`, `parseInt`,
     * `pop`, `random`, `reduce`, `reduceRight`, `repeat`, `result`, `round`,
     * `runInContext`, `sample`, `shift`, `size`, `snakeCase`, `some`, `sortedIndex`,
     * `sortedIndexBy`, `sortedLastIndex`, `sortedLastIndexBy`, `startCase`,
     * `startsWith`, `subtract`, `sum`, `sumBy`, `template`, `times`, `toInteger`,
     * `toJSON`, `toLength`, `toLower`, `toNumber`, `toSafeInteger`, `toString`,
     * `toUpper`, `trim`, `trimEnd`, `trimStart`, `truncate`, `unescape`,
     * `uniqueId`, `upperCase`, `upperFirst`, `value`, and `words`
     *
     * @name _
     * @constructor
     * @category Seq
     * @param {*} value The value to wrap in a `lodash` instance.
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * var wrapped = _([1, 2, 3]);
     *
     * // Returns an unwrapped value.
     * wrapped.reduce(_.add);
     * // => 6
     *
     * // Returns a wrapped value.
     * var squares = wrapped.map(square);
     *
     * _.isArray(squares);
     * // => false
     *
     * _.isArray(squares.value());
     * // => true
     */
    function lodash(value) {
      if (isObjectLike(value) && !isArray(value) && !(value instanceof LazyWrapper)) {
        if (value instanceof LodashWrapper) {
          return value;
        }
        if (hasOwnProperty.call(value, '__wrapped__')) {
          return wrapperClone(value);
        }
      }
      return new LodashWrapper(value);
    }

    /**
     * The function whose prototype chain sequence wrappers inherit from.
     *
     * @private
     */
    function baseLodash() {
      // No operation performed.
    }

    /**
     * The base constructor for creating `lodash` wrapper objects.
     *
     * @private
     * @param {*} value The value to wrap.
     * @param {boolean} [chainAll] Enable explicit method chain sequences.
     */
    function LodashWrapper(value, chainAll) {
      this.__wrapped__ = value;
      this.__actions__ = [];
      this.__chain__ = !!chainAll;
      this.__index__ = 0;
      this.__values__ = undefined;
    }

    /**
     * By default, the template delimiters used by lodash are like those in
     * embedded Ruby (ERB). Change the following template settings to use
     * alternative delimiters.
     *
     * @static
     * @memberOf _
     * @type {Object}
     */
    lodash.templateSettings = {

      /**
       * Used to detect `data` property values to be HTML-escaped.
       *
       * @memberOf _.templateSettings
       * @type {RegExp}
       */
      'escape': reEscape,

      /**
       * Used to detect code to be evaluated.
       *
       * @memberOf _.templateSettings
       * @type {RegExp}
       */
      'evaluate': reEvaluate,

      /**
       * Used to detect `data` property values to inject.
       *
       * @memberOf _.templateSettings
       * @type {RegExp}
       */
      'interpolate': reInterpolate,

      /**
       * Used to reference the data object in the template text.
       *
       * @memberOf _.templateSettings
       * @type {string}
       */
      'variable': '',

      /**
       * Used to import variables into the compiled template.
       *
       * @memberOf _.templateSettings
       * @type {Object}
       */
      'imports': {

        /**
         * A reference to the `lodash` function.
         *
         * @memberOf _.templateSettings.imports
         * @type {Function}
         */
        '_': lodash
      }
    };

    // Ensure wrappers are instances of `baseLodash`.
    lodash.prototype = baseLodash.prototype;
    lodash.prototype.constructor = lodash;

    LodashWrapper.prototype = baseCreate(baseLodash.prototype);
    LodashWrapper.prototype.constructor = LodashWrapper;

    /*------------------------------------------------------------------------*/

    /**
     * Creates a lazy wrapper object which wraps `value` to enable lazy evaluation.
     *
     * @private
     * @constructor
     * @param {*} value The value to wrap.
     */
    function LazyWrapper(value) {
      this.__wrapped__ = value;
      this.__actions__ = [];
      this.__dir__ = 1;
      this.__filtered__ = false;
      this.__iteratees__ = [];
      this.__takeCount__ = MAX_ARRAY_LENGTH;
      this.__views__ = [];
    }

    /**
     * Creates a clone of the lazy wrapper object.
     *
     * @private
     * @name clone
     * @memberOf LazyWrapper
     * @returns {Object} Returns the cloned `LazyWrapper` object.
     */
    function lazyClone() {
      var result = new LazyWrapper(this.__wrapped__);
      result.__actions__ = copyArray(this.__actions__);
      result.__dir__ = this.__dir__;
      result.__filtered__ = this.__filtered__;
      result.__iteratees__ = copyArray(this.__iteratees__);
      result.__takeCount__ = this.__takeCount__;
      result.__views__ = copyArray(this.__views__);
      return result;
    }

    /**
     * Reverses the direction of lazy iteration.
     *
     * @private
     * @name reverse
     * @memberOf LazyWrapper
     * @returns {Object} Returns the new reversed `LazyWrapper` object.
     */
    function lazyReverse() {
      if (this.__filtered__) {
        var result = new LazyWrapper(this);
        result.__dir__ = -1;
        result.__filtered__ = true;
      } else {
        result = this.clone();
        result.__dir__ *= -1;
      }
      return result;
    }

    /**
     * Extracts the unwrapped value from its lazy wrapper.
     *
     * @private
     * @name value
     * @memberOf LazyWrapper
     * @returns {*} Returns the unwrapped value.
     */
    function lazyValue() {
      var array = this.__wrapped__.value(),
          dir = this.__dir__,
          isArr = isArray(array),
          isRight = dir < 0,
          arrLength = isArr ? array.length : 0,
          view = getView(0, arrLength, this.__views__),
          start = view.start,
          end = view.end,
          length = end - start,
          index = isRight ? end : (start - 1),
          iteratees = this.__iteratees__,
          iterLength = iteratees.length,
          resIndex = 0,
          takeCount = nativeMin(length, this.__takeCount__);

      if (!isArr || arrLength < LARGE_ARRAY_SIZE ||
          (arrLength == length && takeCount == length)) {
        return baseWrapperValue(array, this.__actions__);
      }
      var result = [];

      outer:
      while (length-- && resIndex < takeCount) {
        index += dir;

        var iterIndex = -1,
            value = array[index];

        while (++iterIndex < iterLength) {
          var data = iteratees[iterIndex],
              iteratee = data.iteratee,
              type = data.type,
              computed = iteratee(value);

          if (type == LAZY_MAP_FLAG) {
            value = computed;
          } else if (!computed) {
            if (type == LAZY_FILTER_FLAG) {
              continue outer;
            } else {
              break outer;
            }
          }
        }
        result[resIndex++] = value;
      }
      return result;
    }

    // Ensure `LazyWrapper` is an instance of `baseLodash`.
    LazyWrapper.prototype = baseCreate(baseLodash.prototype);
    LazyWrapper.prototype.constructor = LazyWrapper;

    /*------------------------------------------------------------------------*/

    /**
     * Creates a hash object.
     *
     * @private
     * @constructor
     * @returns {Object} Returns the new hash object.
     */
    function Hash() {}

    /**
     * Removes `key` and its value from the hash.
     *
     * @private
     * @param {Object} hash The hash to modify.
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function hashDelete(hash, key) {
      return hashHas(hash, key) && delete hash[key];
    }

    /**
     * Gets the hash value for `key`.
     *
     * @private
     * @param {Object} hash The hash to query.
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function hashGet(hash, key) {
      if (nativeCreate) {
        var result = hash[key];
        return result === HASH_UNDEFINED ? undefined : result;
      }
      return hasOwnProperty.call(hash, key) ? hash[key] : undefined;
    }

    /**
     * Checks if a hash value for `key` exists.
     *
     * @private
     * @param {Object} hash The hash to query.
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function hashHas(hash, key) {
      return nativeCreate ? hash[key] !== undefined : hasOwnProperty.call(hash, key);
    }

    /**
     * Sets the hash `key` to `value`.
     *
     * @private
     * @param {Object} hash The hash to modify.
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     */
    function hashSet(hash, key, value) {
      hash[key] = (nativeCreate && value === undefined) ? HASH_UNDEFINED : value;
    }

    // Avoid inheriting from `Object.prototype` when possible.
    Hash.prototype = nativeCreate ? nativeCreate(null) : objectProto;

    /*------------------------------------------------------------------------*/

    /**
     * Creates a map cache object to store key-value pairs.
     *
     * @private
     * @constructor
     * @param {Array} [values] The values to cache.
     */
    function MapCache(values) {
      var index = -1,
          length = values ? values.length : 0;

      this.clear();
      while (++index < length) {
        var entry = values[index];
        this.set(entry[0], entry[1]);
      }
    }

    /**
     * Removes all key-value entries from the map.
     *
     * @private
     * @name clear
     * @memberOf MapCache
     */
    function mapClear() {
      this.__data__ = {
        'hash': new Hash,
        'map': Map ? new Map : [],
        'string': new Hash
      };
    }

    /**
     * Removes `key` and its value from the map.
     *
     * @private
     * @name delete
     * @memberOf MapCache
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function mapDelete(key) {
      var data = this.__data__;
      if (isKeyable(key)) {
        return hashDelete(typeof key == 'string' ? data.string : data.hash, key);
      }
      return Map ? data.map['delete'](key) : assocDelete(data.map, key);
    }

    /**
     * Gets the map value for `key`.
     *
     * @private
     * @name get
     * @memberOf MapCache
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function mapGet(key) {
      var data = this.__data__;
      if (isKeyable(key)) {
        return hashGet(typeof key == 'string' ? data.string : data.hash, key);
      }
      return Map ? data.map.get(key) : assocGet(data.map, key);
    }

    /**
     * Checks if a map value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf MapCache
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function mapHas(key) {
      var data = this.__data__;
      if (isKeyable(key)) {
        return hashHas(typeof key == 'string' ? data.string : data.hash, key);
      }
      return Map ? data.map.has(key) : assocHas(data.map, key);
    }

    /**
     * Sets the map `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf MapCache
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the map cache instance.
     */
    function mapSet(key, value) {
      var data = this.__data__;
      if (isKeyable(key)) {
        hashSet(typeof key == 'string' ? data.string : data.hash, key, value);
      } else if (Map) {
        data.map.set(key, value);
      } else {
        assocSet(data.map, key, value);
      }
      return this;
    }

    // Add methods to `MapCache`.
    MapCache.prototype.clear = mapClear;
    MapCache.prototype['delete'] = mapDelete;
    MapCache.prototype.get = mapGet;
    MapCache.prototype.has = mapHas;
    MapCache.prototype.set = mapSet;

    /*------------------------------------------------------------------------*/

    /**
     *
     * Creates a set cache object to store unique values.
     *
     * @private
     * @constructor
     * @param {Array} [values] The values to cache.
     */
    function SetCache(values) {
      var index = -1,
          length = values ? values.length : 0;

      this.__data__ = new MapCache;
      while (++index < length) {
        this.push(values[index]);
      }
    }

    /**
     * Checks if `value` is in `cache`.
     *
     * @private
     * @param {Object} cache The set cache to search.
     * @param {*} value The value to search for.
     * @returns {number} Returns `true` if `value` is found, else `false`.
     */
    function cacheHas(cache, value) {
      var map = cache.__data__;
      if (isKeyable(value)) {
        var data = map.__data__,
            hash = typeof value == 'string' ? data.string : data.hash;

        return hash[value] === HASH_UNDEFINED;
      }
      return map.has(value);
    }

    /**
     * Adds `value` to the set cache.
     *
     * @private
     * @name push
     * @memberOf SetCache
     * @param {*} value The value to cache.
     */
    function cachePush(value) {
      var map = this.__data__;
      if (isKeyable(value)) {
        var data = map.__data__,
            hash = typeof value == 'string' ? data.string : data.hash;

        hash[value] = HASH_UNDEFINED;
      }
      else {
        map.set(value, HASH_UNDEFINED);
      }
    }

    // Add methods to `SetCache`.
    SetCache.prototype.push = cachePush;

    /*------------------------------------------------------------------------*/

    /**
     * Creates a stack cache object to store key-value pairs.
     *
     * @private
     * @constructor
     * @param {Array} [values] The values to cache.
     */
    function Stack(values) {
      var index = -1,
          length = values ? values.length : 0;

      this.clear();
      while (++index < length) {
        var entry = values[index];
        this.set(entry[0], entry[1]);
      }
    }

    /**
     * Removes all key-value entries from the stack.
     *
     * @private
     * @name clear
     * @memberOf Stack
     */
    function stackClear() {
      this.__data__ = { 'array': [], 'map': null };
    }

    /**
     * Removes `key` and its value from the stack.
     *
     * @private
     * @name delete
     * @memberOf Stack
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function stackDelete(key) {
      var data = this.__data__,
          array = data.array;

      return array ? assocDelete(array, key) : data.map['delete'](key);
    }

    /**
     * Gets the stack value for `key`.
     *
     * @private
     * @name get
     * @memberOf Stack
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function stackGet(key) {
      var data = this.__data__,
          array = data.array;

      return array ? assocGet(array, key) : data.map.get(key);
    }

    /**
     * Checks if a stack value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf Stack
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function stackHas(key) {
      var data = this.__data__,
          array = data.array;

      return array ? assocHas(array, key) : data.map.has(key);
    }

    /**
     * Sets the stack `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf Stack
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the stack cache instance.
     */
    function stackSet(key, value) {
      var data = this.__data__,
          array = data.array;

      if (array) {
        if (array.length < (LARGE_ARRAY_SIZE - 1)) {
          assocSet(array, key, value);
        } else {
          data.array = null;
          data.map = new MapCache(array);
        }
      }
      var map = data.map;
      if (map) {
        map.set(key, value);
      }
      return this;
    }

    // Add methods to `Stack`.
    Stack.prototype.clear = stackClear;
    Stack.prototype['delete'] = stackDelete;
    Stack.prototype.get = stackGet;
    Stack.prototype.has = stackHas;
    Stack.prototype.set = stackSet;

    /*------------------------------------------------------------------------*/

    /**
     * Removes `key` and its value from the associative array.
     *
     * @private
     * @param {Array} array The array to modify.
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function assocDelete(array, key) {
      var index = assocIndexOf(array, key);
      if (index < 0) {
        return false;
      }
      var lastIndex = array.length - 1;
      if (index == lastIndex) {
        array.pop();
      } else {
        splice.call(array, index, 1);
      }
      return true;
    }

    /**
     * Gets the associative array value for `key`.
     *
     * @private
     * @param {Array} array The array to query.
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function assocGet(array, key) {
      var index = assocIndexOf(array, key);
      return index < 0 ? undefined : array[index][1];
    }

    /**
     * Checks if an associative array value for `key` exists.
     *
     * @private
     * @param {Array} array The array to query.
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function assocHas(array, key) {
      return assocIndexOf(array, key) > -1;
    }

    /**
     * Gets the index at which the `key` is found in `array` of key-value pairs.
     *
     * @private
     * @param {Array} array The array to search.
     * @param {*} key The key to search for.
     * @returns {number} Returns the index of the matched value, else `-1`.
     */
    function assocIndexOf(array, key) {
      var length = array.length;
      while (length--) {
        if (eq(array[length][0], key)) {
          return length;
        }
      }
      return -1;
    }

    /**
     * Sets the associative array `key` to `value`.
     *
     * @private
     * @param {Array} array The array to modify.
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     */
    function assocSet(array, key, value) {
      var index = assocIndexOf(array, key);
      if (index < 0) {
        array.push([key, value]);
      } else {
        array[index][1] = value;
      }
    }

    /*------------------------------------------------------------------------*/

    /**
     * Used by `_.defaults` to customize its `_.assignIn` use.
     *
     * @private
     * @param {*} objValue The destination value.
     * @param {*} srcValue The source value.
     * @param {string} key The key of the property to assign.
     * @param {Object} object The parent object of `objValue`.
     * @returns {*} Returns the value to assign.
     */
    function assignInDefaults(objValue, srcValue, key, object) {
      if (objValue === undefined ||
          (eq(objValue, objectProto[key]) && !hasOwnProperty.call(object, key))) {
        return srcValue;
      }
      return objValue;
    }

    /**
     * This function is like `assignValue` except that it doesn't assign
     * `undefined` values.
     *
     * @private
     * @param {Object} object The object to modify.
     * @param {string} key The key of the property to assign.
     * @param {*} value The value to assign.
     */
    function assignMergeValue(object, key, value) {
      if ((value !== undefined && !eq(object[key], value)) ||
          (typeof key == 'number' && value === undefined && !(key in object))) {
        object[key] = value;
      }
    }

    /**
     * Assigns `value` to `key` of `object` if the existing value is not equivalent
     * using [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons.
     *
     * @private
     * @param {Object} object The object to modify.
     * @param {string} key The key of the property to assign.
     * @param {*} value The value to assign.
     */
    function assignValue(object, key, value) {
      var objValue = object[key];
      if (!(hasOwnProperty.call(object, key) && eq(objValue, value)) ||
          (value === undefined && !(key in object))) {
        object[key] = value;
      }
    }

    /**
     * Aggregates elements of `collection` on `accumulator` with keys transformed
     * by `iteratee` and values set by `setter`.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} setter The function to set `accumulator` values.
     * @param {Function} iteratee The iteratee to transform keys.
     * @param {Object} accumulator The initial aggregated object.
     * @returns {Function} Returns `accumulator`.
     */
    function baseAggregator(collection, setter, iteratee, accumulator) {
      baseEach(collection, function(value, key, collection) {
        setter(accumulator, value, iteratee(value), collection);
      });
      return accumulator;
    }

    /**
     * The base implementation of `_.assign` without support for multiple sources
     * or `customizer` functions.
     *
     * @private
     * @param {Object} object The destination object.
     * @param {Object} source The source object.
     * @returns {Object} Returns `object`.
     */
    function baseAssign(object, source) {
      return object && copyObject(source, keys(source), object);
    }

    /**
     * The base implementation of `_.at` without support for individual paths.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {string[]} paths The property paths of elements to pick.
     * @returns {Array} Returns the new array of picked elements.
     */
    function baseAt(object, paths) {
      var index = -1,
          isNil = object == null,
          length = paths.length,
          result = Array(length);

      while (++index < length) {
        result[index] = isNil ? undefined : get(object, paths[index]);
      }
      return result;
    }

    /**
     * The base implementation of `_.clamp` which doesn't coerce arguments to numbers.
     *
     * @private
     * @param {number} number The number to clamp.
     * @param {number} [lower] The lower bound.
     * @param {number} upper The upper bound.
     * @returns {number} Returns the clamped number.
     */
    function baseClamp(number, lower, upper) {
      if (number === number) {
        if (upper !== undefined) {
          number = number <= upper ? number : upper;
        }
        if (lower !== undefined) {
          number = number >= lower ? number : lower;
        }
      }
      return number;
    }

    /**
     * The base implementation of `_.clone` and `_.cloneDeep` which tracks
     * traversed objects.
     *
     * @private
     * @param {*} value The value to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @param {boolean} [isFull] Specify a clone including symbols.
     * @param {Function} [customizer] The function to customize cloning.
     * @param {string} [key] The key of `value`.
     * @param {Object} [object] The parent object of `value`.
     * @param {Object} [stack] Tracks traversed objects and their clone counterparts.
     * @returns {*} Returns the cloned value.
     */
    function baseClone(value, isDeep, isFull, customizer, key, object, stack) {
      var result;
      if (customizer) {
        result = object ? customizer(value, key, object, stack) : customizer(value);
      }
      if (result !== undefined) {
        return result;
      }
      if (!isObject(value)) {
        return value;
      }
      var isArr = isArray(value);
      if (isArr) {
        result = initCloneArray(value);
        if (!isDeep) {
          return copyArray(value, result);
        }
      } else {
        var tag = getTag(value),
            isFunc = tag == funcTag || tag == genTag;

        if (isBuffer(value)) {
          return cloneBuffer(value, isDeep);
        }
        if (tag == objectTag || tag == argsTag || (isFunc && !object)) {
          if (isHostObject(value)) {
            return object ? value : {};
          }
          result = initCloneObject(isFunc ? {} : value);
          if (!isDeep) {
            return copySymbols(value, baseAssign(result, value));
          }
        } else {
          if (!cloneableTags[tag]) {
            return object ? value : {};
          }
          result = initCloneByTag(value, tag, baseClone, isDeep);
        }
      }
      // Check for circular references and return its corresponding clone.
      stack || (stack = new Stack);
      var stacked = stack.get(value);
      if (stacked) {
        return stacked;
      }
      stack.set(value, result);

      if (!isArr) {
        var props = isFull ? getAllKeys(value) : keys(value);
      }
      // Recursively populate clone (susceptible to call stack limits).
      arrayEach(props || value, function(subValue, key) {
        if (props) {
          key = subValue;
          subValue = value[key];
        }
        assignValue(result, key, baseClone(subValue, isDeep, isFull, customizer, key, value, stack));
      });
      return result;
    }

    /**
     * The base implementation of `_.conforms` which doesn't clone `source`.
     *
     * @private
     * @param {Object} source The object of property predicates to conform to.
     * @returns {Function} Returns the new function.
     */
    function baseConforms(source) {
      var props = keys(source),
          length = props.length;

      return function(object) {
        if (object == null) {
          return !length;
        }
        var index = length;
        while (index--) {
          var key = props[index],
              predicate = source[key],
              value = object[key];

          if ((value === undefined &&
              !(key in Object(object))) || !predicate(value)) {
            return false;
          }
        }
        return true;
      };
    }

    /**
     * The base implementation of `_.create` without support for assigning
     * properties to the created object.
     *
     * @private
     * @param {Object} prototype The object to inherit from.
     * @returns {Object} Returns the new object.
     */
    function baseCreate(proto) {
      return isObject(proto) ? objectCreate(proto) : {};
    }

    /**
     * The base implementation of `_.delay` and `_.defer` which accepts an array
     * of `func` arguments.
     *
     * @private
     * @param {Function} func The function to delay.
     * @param {number} wait The number of milliseconds to delay invocation.
     * @param {Object} args The arguments to provide to `func`.
     * @returns {number} Returns the timer id.
     */
    function baseDelay(func, wait, args) {
      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      return setTimeout(function() { func.apply(undefined, args); }, wait);
    }

    /**
     * The base implementation of methods like `_.difference` without support
     * for excluding multiple arrays or iteratee shorthands.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @param {Array} values The values to exclude.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of filtered values.
     */
    function baseDifference(array, values, iteratee, comparator) {
      var index = -1,
          includes = arrayIncludes,
          isCommon = true,
          length = array.length,
          result = [],
          valuesLength = values.length;

      if (!length) {
        return result;
      }
      if (iteratee) {
        values = arrayMap(values, baseUnary(iteratee));
      }
      if (comparator) {
        includes = arrayIncludesWith;
        isCommon = false;
      }
      else if (values.length >= LARGE_ARRAY_SIZE) {
        includes = cacheHas;
        isCommon = false;
        values = new SetCache(values);
      }
      outer:
      while (++index < length) {
        var value = array[index],
            computed = iteratee ? iteratee(value) : value;

        if (isCommon && computed === computed) {
          var valuesIndex = valuesLength;
          while (valuesIndex--) {
            if (values[valuesIndex] === computed) {
              continue outer;
            }
          }
          result.push(value);
        }
        else if (!includes(values, computed, comparator)) {
          result.push(value);
        }
      }
      return result;
    }

    /**
     * The base implementation of `_.forEach` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Array|Object} Returns `collection`.
     */
    var baseEach = createBaseEach(baseForOwn);

    /**
     * The base implementation of `_.forEachRight` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Array|Object} Returns `collection`.
     */
    var baseEachRight = createBaseEach(baseForOwnRight, true);

    /**
     * The base implementation of `_.every` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} predicate The function invoked per iteration.
     * @returns {boolean} Returns `true` if all elements pass the predicate check,
     *  else `false`
     */
    function baseEvery(collection, predicate) {
      var result = true;
      baseEach(collection, function(value, index, collection) {
        result = !!predicate(value, index, collection);
        return result;
      });
      return result;
    }

    /**
     * The base implementation of `_.fill` without an iteratee call guard.
     *
     * @private
     * @param {Array} array The array to fill.
     * @param {*} value The value to fill `array` with.
     * @param {number} [start=0] The start position.
     * @param {number} [end=array.length] The end position.
     * @returns {Array} Returns `array`.
     */
    function baseFill(array, value, start, end) {
      var length = array.length;

      start = toInteger(start);
      if (start < 0) {
        start = -start > length ? 0 : (length + start);
      }
      end = (end === undefined || end > length) ? length : toInteger(end);
      if (end < 0) {
        end += length;
      }
      end = start > end ? 0 : toLength(end);
      while (start < end) {
        array[start++] = value;
      }
      return array;
    }

    /**
     * The base implementation of `_.filter` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} predicate The function invoked per iteration.
     * @returns {Array} Returns the new filtered array.
     */
    function baseFilter(collection, predicate) {
      var result = [];
      baseEach(collection, function(value, index, collection) {
        if (predicate(value, index, collection)) {
          result.push(value);
        }
      });
      return result;
    }

    /**
     * The base implementation of `_.flatten` with support for restricting flattening.
     *
     * @private
     * @param {Array} array The array to flatten.
     * @param {number} depth The maximum recursion depth.
     * @param {boolean} [predicate=isFlattenable] The function invoked per iteration.
     * @param {boolean} [isStrict] Restrict to values that pass `predicate` checks.
     * @param {Array} [result=[]] The initial result value.
     * @returns {Array} Returns the new flattened array.
     */
    function baseFlatten(array, depth, predicate, isStrict, result) {
      var index = -1,
          length = array.length;

      predicate || (predicate = isFlattenable);
      result || (result = []);

      while (++index < length) {
        var value = array[index];
        if (depth > 0 && predicate(value)) {
          if (depth > 1) {
            // Recursively flatten arrays (susceptible to call stack limits).
            baseFlatten(value, depth - 1, predicate, isStrict, result);
          } else {
            arrayPush(result, value);
          }
        } else if (!isStrict) {
          result[result.length] = value;
        }
      }
      return result;
    }

    /**
     * The base implementation of `baseForOwn` which iterates over `object`
     * properties returned by `keysFunc` and invokes `iteratee` for each property.
     * Iteratee functions may exit iteration early by explicitly returning `false`.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @param {Function} keysFunc The function to get the keys of `object`.
     * @returns {Object} Returns `object`.
     */
    var baseFor = createBaseFor();

    /**
     * This function is like `baseFor` except that it iterates over properties
     * in the opposite order.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @param {Function} keysFunc The function to get the keys of `object`.
     * @returns {Object} Returns `object`.
     */
    var baseForRight = createBaseFor(true);

    /**
     * The base implementation of `_.forOwn` without support for iteratee shorthands.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Object} Returns `object`.
     */
    function baseForOwn(object, iteratee) {
      return object && baseFor(object, iteratee, keys);
    }

    /**
     * The base implementation of `_.forOwnRight` without support for iteratee shorthands.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Object} Returns `object`.
     */
    function baseForOwnRight(object, iteratee) {
      return object && baseForRight(object, iteratee, keys);
    }

    /**
     * The base implementation of `_.functions` which creates an array of
     * `object` function property names filtered from `props`.
     *
     * @private
     * @param {Object} object The object to inspect.
     * @param {Array} props The property names to filter.
     * @returns {Array} Returns the new array of filtered property names.
     */
    function baseFunctions(object, props) {
      return arrayFilter(props, function(key) {
        return isFunction(object[key]);
      });
    }

    /**
     * The base implementation of `_.get` without support for default values.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the property to get.
     * @returns {*} Returns the resolved value.
     */
    function baseGet(object, path) {
      path = isKey(path, object) ? [path] : castPath(path);

      var index = 0,
          length = path.length;

      while (object != null && index < length) {
        object = object[path[index++]];
      }
      return (index && index == length) ? object : undefined;
    }

    /**
     * The base implementation of `getAllKeys` and `getAllKeysIn` which uses
     * `keysFunc` and `symbolsFunc` to get the enumerable property names and
     * symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Function} keysFunc The function to get the keys of `object`.
     * @param {Function} symbolsFunc The function to get the symbols of `object`.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function baseGetAllKeys(object, keysFunc, symbolsFunc) {
      var result = keysFunc(object);
      return isArray(object)
        ? result
        : arrayPush(result, symbolsFunc(object));
    }

    /**
     * The base implementation of `_.has` without support for deep paths.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} key The key to check.
     * @returns {boolean} Returns `true` if `key` exists, else `false`.
     */
    function baseHas(object, key) {
      // Avoid a bug in IE 10-11 where objects with a [[Prototype]] of `null`,
      // that are composed entirely of index properties, return `false` for
      // `hasOwnProperty` checks of them.
      return hasOwnProperty.call(object, key) ||
        (typeof object == 'object' && key in object && getPrototype(object) === null);
    }

    /**
     * The base implementation of `_.hasIn` without support for deep paths.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} key The key to check.
     * @returns {boolean} Returns `true` if `key` exists, else `false`.
     */
    function baseHasIn(object, key) {
      return key in Object(object);
    }

    /**
     * The base implementation of `_.inRange` which doesn't coerce arguments to numbers.
     *
     * @private
     * @param {number} number The number to check.
     * @param {number} start The start of the range.
     * @param {number} end The end of the range.
     * @returns {boolean} Returns `true` if `number` is in the range, else `false`.
     */
    function baseInRange(number, start, end) {
      return number >= nativeMin(start, end) && number < nativeMax(start, end);
    }

    /**
     * The base implementation of methods like `_.intersection`, without support
     * for iteratee shorthands, that accepts an array of arrays to inspect.
     *
     * @private
     * @param {Array} arrays The arrays to inspect.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of shared values.
     */
    function baseIntersection(arrays, iteratee, comparator) {
      var includes = comparator ? arrayIncludesWith : arrayIncludes,
          length = arrays[0].length,
          othLength = arrays.length,
          othIndex = othLength,
          caches = Array(othLength),
          maxLength = Infinity,
          result = [];

      while (othIndex--) {
        var array = arrays[othIndex];
        if (othIndex && iteratee) {
          array = arrayMap(array, baseUnary(iteratee));
        }
        maxLength = nativeMin(array.length, maxLength);
        caches[othIndex] = !comparator && (iteratee || (length >= 120 && array.length >= 120))
          ? new SetCache(othIndex && array)
          : undefined;
      }
      array = arrays[0];

      var index = -1,
          seen = caches[0];

      outer:
      while (++index < length && result.length < maxLength) {
        var value = array[index],
            computed = iteratee ? iteratee(value) : value;

        if (!(seen
              ? cacheHas(seen, computed)
              : includes(result, computed, comparator)
            )) {
          othIndex = othLength;
          while (--othIndex) {
            var cache = caches[othIndex];
            if (!(cache
                  ? cacheHas(cache, computed)
                  : includes(arrays[othIndex], computed, comparator))
                ) {
              continue outer;
            }
          }
          if (seen) {
            seen.push(computed);
          }
          result.push(value);
        }
      }
      return result;
    }

    /**
     * The base implementation of `_.invert` and `_.invertBy` which inverts
     * `object` with values transformed by `iteratee` and set by `setter`.
     *
     * @private
     * @param {Object} object The object to iterate over.
     * @param {Function} setter The function to set `accumulator` values.
     * @param {Function} iteratee The iteratee to transform values.
     * @param {Object} accumulator The initial inverted object.
     * @returns {Function} Returns `accumulator`.
     */
    function baseInverter(object, setter, iteratee, accumulator) {
      baseForOwn(object, function(value, key, object) {
        setter(accumulator, iteratee(value), key, object);
      });
      return accumulator;
    }

    /**
     * The base implementation of `_.invoke` without support for individual
     * method arguments.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the method to invoke.
     * @param {Array} args The arguments to invoke the method with.
     * @returns {*} Returns the result of the invoked method.
     */
    function baseInvoke(object, path, args) {
      if (!isKey(path, object)) {
        path = castPath(path);
        object = parent(object, path);
        path = last(path);
      }
      var func = object == null ? object : object[path];
      return func == null ? undefined : apply(func, object, args);
    }

    /**
     * The base implementation of `_.isEqual` which supports partial comparisons
     * and tracks traversed objects.
     *
     * @private
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @param {Function} [customizer] The function to customize comparisons.
     * @param {boolean} [bitmask] The bitmask of comparison flags.
     *  The bitmask may be composed of the following flags:
     *     1 - Unordered comparison
     *     2 - Partial comparison
     * @param {Object} [stack] Tracks traversed `value` and `other` objects.
     * @returns {boolean} Returns `true` if the values are equivalent, else `false`.
     */
    function baseIsEqual(value, other, customizer, bitmask, stack) {
      if (value === other) {
        return true;
      }
      if (value == null || other == null || (!isObject(value) && !isObjectLike(other))) {
        return value !== value && other !== other;
      }
      return baseIsEqualDeep(value, other, baseIsEqual, customizer, bitmask, stack);
    }

    /**
     * A specialized version of `baseIsEqual` for arrays and objects which performs
     * deep comparisons and tracks traversed objects enabling objects with circular
     * references to be compared.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Function} [customizer] The function to customize comparisons.
     * @param {number} [bitmask] The bitmask of comparison flags. See `baseIsEqual`
     *  for more details.
     * @param {Object} [stack] Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function baseIsEqualDeep(object, other, equalFunc, customizer, bitmask, stack) {
      var objIsArr = isArray(object),
          othIsArr = isArray(other),
          objTag = arrayTag,
          othTag = arrayTag;

      if (!objIsArr) {
        objTag = getTag(object);
        objTag = objTag == argsTag ? objectTag : objTag;
      }
      if (!othIsArr) {
        othTag = getTag(other);
        othTag = othTag == argsTag ? objectTag : othTag;
      }
      var objIsObj = objTag == objectTag && !isHostObject(object),
          othIsObj = othTag == objectTag && !isHostObject(other),
          isSameTag = objTag == othTag;

      if (isSameTag && !objIsObj) {
        stack || (stack = new Stack);
        return (objIsArr || isTypedArray(object))
          ? equalArrays(object, other, equalFunc, customizer, bitmask, stack)
          : equalByTag(object, other, objTag, equalFunc, customizer, bitmask, stack);
      }
      if (!(bitmask & PARTIAL_COMPARE_FLAG)) {
        var objIsWrapped = objIsObj && hasOwnProperty.call(object, '__wrapped__'),
            othIsWrapped = othIsObj && hasOwnProperty.call(other, '__wrapped__');

        if (objIsWrapped || othIsWrapped) {
          var objUnwrapped = objIsWrapped ? object.value() : object,
              othUnwrapped = othIsWrapped ? other.value() : other;

          stack || (stack = new Stack);
          return equalFunc(objUnwrapped, othUnwrapped, customizer, bitmask, stack);
        }
      }
      if (!isSameTag) {
        return false;
      }
      stack || (stack = new Stack);
      return equalObjects(object, other, equalFunc, customizer, bitmask, stack);
    }

    /**
     * The base implementation of `_.isMatch` without support for iteratee shorthands.
     *
     * @private
     * @param {Object} object The object to inspect.
     * @param {Object} source The object of property values to match.
     * @param {Array} matchData The property names, values, and compare flags to match.
     * @param {Function} [customizer] The function to customize comparisons.
     * @returns {boolean} Returns `true` if `object` is a match, else `false`.
     */
    function baseIsMatch(object, source, matchData, customizer) {
      var index = matchData.length,
          length = index,
          noCustomizer = !customizer;

      if (object == null) {
        return !length;
      }
      object = Object(object);
      while (index--) {
        var data = matchData[index];
        if ((noCustomizer && data[2])
              ? data[1] !== object[data[0]]
              : !(data[0] in object)
            ) {
          return false;
        }
      }
      while (++index < length) {
        data = matchData[index];
        var key = data[0],
            objValue = object[key],
            srcValue = data[1];

        if (noCustomizer && data[2]) {
          if (objValue === undefined && !(key in object)) {
            return false;
          }
        } else {
          var stack = new Stack;
          if (customizer) {
            var result = customizer(objValue, srcValue, key, object, source, stack);
          }
          if (!(result === undefined
                ? baseIsEqual(srcValue, objValue, customizer, UNORDERED_COMPARE_FLAG | PARTIAL_COMPARE_FLAG, stack)
                : result
              )) {
            return false;
          }
        }
      }
      return true;
    }

    /**
     * The base implementation of `_.iteratee`.
     *
     * @private
     * @param {*} [value=_.identity] The value to convert to an iteratee.
     * @returns {Function} Returns the iteratee.
     */
    function baseIteratee(value) {
      // Don't store the `typeof` result in a variable to avoid a JIT bug in Safari 9.
      // See https://bugs.webkit.org/show_bug.cgi?id=156034 for more details.
      if (typeof value == 'function') {
        return value;
      }
      if (value == null) {
        return identity;
      }
      if (typeof value == 'object') {
        return isArray(value)
          ? baseMatchesProperty(value[0], value[1])
          : baseMatches(value);
      }
      return property(value);
    }

    /**
     * The base implementation of `_.keys` which doesn't skip the constructor
     * property of prototypes or treat sparse arrays as dense.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     */
    function baseKeys(object) {
      return nativeKeys(Object(object));
    }

    /**
     * The base implementation of `_.keysIn` which doesn't skip the constructor
     * property of prototypes or treat sparse arrays as dense.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     */
    function baseKeysIn(object) {
      object = object == null ? object : Object(object);

      var result = [];
      for (var key in object) {
        result.push(key);
      }
      return result;
    }

    // Fallback for IE < 9 with es6-shim.
    if (enumerate && !propertyIsEnumerable.call({ 'valueOf': 1 }, 'valueOf')) {
      baseKeysIn = function(object) {
        return iteratorToArray(enumerate(object));
      };
    }

    /**
     * The base implementation of `_.map` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Array} Returns the new mapped array.
     */
    function baseMap(collection, iteratee) {
      var index = -1,
          result = isArrayLike(collection) ? Array(collection.length) : [];

      baseEach(collection, function(value, key, collection) {
        result[++index] = iteratee(value, key, collection);
      });
      return result;
    }

    /**
     * The base implementation of `_.matches` which doesn't clone `source`.
     *
     * @private
     * @param {Object} source The object of property values to match.
     * @returns {Function} Returns the new function.
     */
    function baseMatches(source) {
      var matchData = getMatchData(source);
      if (matchData.length == 1 && matchData[0][2]) {
        return matchesStrictComparable(matchData[0][0], matchData[0][1]);
      }
      return function(object) {
        return object === source || baseIsMatch(object, source, matchData);
      };
    }

    /**
     * The base implementation of `_.matchesProperty` which doesn't clone `srcValue`.
     *
     * @private
     * @param {string} path The path of the property to get.
     * @param {*} srcValue The value to match.
     * @returns {Function} Returns the new function.
     */
    function baseMatchesProperty(path, srcValue) {
      if (isKey(path) && isStrictComparable(srcValue)) {
        return matchesStrictComparable(path, srcValue);
      }
      return function(object) {
        var objValue = get(object, path);
        return (objValue === undefined && objValue === srcValue)
          ? hasIn(object, path)
          : baseIsEqual(srcValue, objValue, undefined, UNORDERED_COMPARE_FLAG | PARTIAL_COMPARE_FLAG);
      };
    }

    /**
     * The base implementation of `_.merge` without support for multiple sources.
     *
     * @private
     * @param {Object} object The destination object.
     * @param {Object} source The source object.
     * @param {number} srcIndex The index of `source`.
     * @param {Function} [customizer] The function to customize merged values.
     * @param {Object} [stack] Tracks traversed source values and their merged
     *  counterparts.
     */
    function baseMerge(object, source, srcIndex, customizer, stack) {
      if (object === source) {
        return;
      }
      if (!(isArray(source) || isTypedArray(source))) {
        var props = keysIn(source);
      }
      arrayEach(props || source, function(srcValue, key) {
        if (props) {
          key = srcValue;
          srcValue = source[key];
        }
        if (isObject(srcValue)) {
          stack || (stack = new Stack);
          baseMergeDeep(object, source, key, srcIndex, baseMerge, customizer, stack);
        }
        else {
          var newValue = customizer
            ? customizer(object[key], srcValue, (key + ''), object, source, stack)
            : undefined;

          if (newValue === undefined) {
            newValue = srcValue;
          }
          assignMergeValue(object, key, newValue);
        }
      });
    }

    /**
     * A specialized version of `baseMerge` for arrays and objects which performs
     * deep merges and tracks traversed objects enabling objects with circular
     * references to be merged.
     *
     * @private
     * @param {Object} object The destination object.
     * @param {Object} source The source object.
     * @param {string} key The key of the value to merge.
     * @param {number} srcIndex The index of `source`.
     * @param {Function} mergeFunc The function to merge values.
     * @param {Function} [customizer] The function to customize assigned values.
     * @param {Object} [stack] Tracks traversed source values and their merged
     *  counterparts.
     */
    function baseMergeDeep(object, source, key, srcIndex, mergeFunc, customizer, stack) {
      var objValue = object[key],
          srcValue = source[key],
          stacked = stack.get(srcValue);

      if (stacked) {
        assignMergeValue(object, key, stacked);
        return;
      }
      var newValue = customizer
        ? customizer(objValue, srcValue, (key + ''), object, source, stack)
        : undefined;

      var isCommon = newValue === undefined;

      if (isCommon) {
        newValue = srcValue;
        if (isArray(srcValue) || isTypedArray(srcValue)) {
          if (isArray(objValue)) {
            newValue = objValue;
          }
          else if (isArrayLikeObject(objValue)) {
            newValue = copyArray(objValue);
          }
          else {
            isCommon = false;
            newValue = baseClone(srcValue, true);
          }
        }
        else if (isPlainObject(srcValue) || isArguments(srcValue)) {
          if (isArguments(objValue)) {
            newValue = toPlainObject(objValue);
          }
          else if (!isObject(objValue) || (srcIndex && isFunction(objValue))) {
            isCommon = false;
            newValue = baseClone(srcValue, true);
          }
          else {
            newValue = objValue;
          }
        }
        else {
          isCommon = false;
        }
      }
      stack.set(srcValue, newValue);

      if (isCommon) {
        // Recursively merge objects and arrays (susceptible to call stack limits).
        mergeFunc(newValue, srcValue, srcIndex, customizer, stack);
      }
      stack['delete'](srcValue);
      assignMergeValue(object, key, newValue);
    }

    /**
     * The base implementation of `_.nth` which doesn't coerce `n` to an integer.
     *
     * @private
     * @param {Array} array The array to query.
     * @param {number} n The index of the element to return.
     * @returns {*} Returns the nth element of `array`.
     */
    function baseNth(array, n) {
      var length = array.length;
      if (!length) {
        return;
      }
      n += n < 0 ? length : 0;
      return isIndex(n, length) ? array[n] : undefined;
    }

    /**
     * The base implementation of `_.orderBy` without param guards.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function[]|Object[]|string[]} iteratees The iteratees to sort by.
     * @param {string[]} orders The sort orders of `iteratees`.
     * @returns {Array} Returns the new sorted array.
     */
    function baseOrderBy(collection, iteratees, orders) {
      var index = -1;
      iteratees = arrayMap(iteratees.length ? iteratees : [identity], baseUnary(getIteratee()));

      var result = baseMap(collection, function(value, key, collection) {
        var criteria = arrayMap(iteratees, function(iteratee) {
          return iteratee(value);
        });
        return { 'criteria': criteria, 'index': ++index, 'value': value };
      });

      return baseSortBy(result, function(object, other) {
        return compareMultiple(object, other, orders);
      });
    }

    /**
     * The base implementation of `_.pick` without support for individual
     * property identifiers.
     *
     * @private
     * @param {Object} object The source object.
     * @param {string[]} props The property identifiers to pick.
     * @returns {Object} Returns the new object.
     */
    function basePick(object, props) {
      object = Object(object);
      return arrayReduce(props, function(result, key) {
        if (key in object) {
          result[key] = object[key];
        }
        return result;
      }, {});
    }

    /**
     * The base implementation of  `_.pickBy` without support for iteratee shorthands.
     *
     * @private
     * @param {Object} object The source object.
     * @param {Function} predicate The function invoked per property.
     * @returns {Object} Returns the new object.
     */
    function basePickBy(object, predicate) {
      var index = -1,
          props = getAllKeysIn(object),
          length = props.length,
          result = {};

      while (++index < length) {
        var key = props[index],
            value = object[key];

        if (predicate(value, key)) {
          result[key] = value;
        }
      }
      return result;
    }

    /**
     * The base implementation of `_.property` without support for deep paths.
     *
     * @private
     * @param {string} key The key of the property to get.
     * @returns {Function} Returns the new function.
     */
    function baseProperty(key) {
      return function(object) {
        return object == null ? undefined : object[key];
      };
    }

    /**
     * A specialized version of `baseProperty` which supports deep paths.
     *
     * @private
     * @param {Array|string} path The path of the property to get.
     * @returns {Function} Returns the new function.
     */
    function basePropertyDeep(path) {
      return function(object) {
        return baseGet(object, path);
      };
    }

    /**
     * The base implementation of `_.pullAllBy` without support for iteratee
     * shorthands.
     *
     * @private
     * @param {Array} array The array to modify.
     * @param {Array} values The values to remove.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns `array`.
     */
    function basePullAll(array, values, iteratee, comparator) {
      var indexOf = comparator ? baseIndexOfWith : baseIndexOf,
          index = -1,
          length = values.length,
          seen = array;

      if (iteratee) {
        seen = arrayMap(array, baseUnary(iteratee));
      }
      while (++index < length) {
        var fromIndex = 0,
            value = values[index],
            computed = iteratee ? iteratee(value) : value;

        while ((fromIndex = indexOf(seen, computed, fromIndex, comparator)) > -1) {
          if (seen !== array) {
            splice.call(seen, fromIndex, 1);
          }
          splice.call(array, fromIndex, 1);
        }
      }
      return array;
    }

    /**
     * The base implementation of `_.pullAt` without support for individual
     * indexes or capturing the removed elements.
     *
     * @private
     * @param {Array} array The array to modify.
     * @param {number[]} indexes The indexes of elements to remove.
     * @returns {Array} Returns `array`.
     */
    function basePullAt(array, indexes) {
      var length = array ? indexes.length : 0,
          lastIndex = length - 1;

      while (length--) {
        var index = indexes[length];
        if (lastIndex == length || index != previous) {
          var previous = index;
          if (isIndex(index)) {
            splice.call(array, index, 1);
          }
          else if (!isKey(index, array)) {
            var path = castPath(index),
                object = parent(array, path);

            if (object != null) {
              delete object[last(path)];
            }
          }
          else {
            delete array[index];
          }
        }
      }
      return array;
    }

    /**
     * The base implementation of `_.random` without support for returning
     * floating-point numbers.
     *
     * @private
     * @param {number} lower The lower bound.
     * @param {number} upper The upper bound.
     * @returns {number} Returns the random number.
     */
    function baseRandom(lower, upper) {
      return lower + nativeFloor(nativeRandom() * (upper - lower + 1));
    }

    /**
     * The base implementation of `_.range` and `_.rangeRight` which doesn't
     * coerce arguments to numbers.
     *
     * @private
     * @param {number} start The start of the range.
     * @param {number} end The end of the range.
     * @param {number} step The value to increment or decrement by.
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Array} Returns the new array of numbers.
     */
    function baseRange(start, end, step, fromRight) {
      var index = -1,
          length = nativeMax(nativeCeil((end - start) / (step || 1)), 0),
          result = Array(length);

      while (length--) {
        result[fromRight ? length : ++index] = start;
        start += step;
      }
      return result;
    }

    /**
     * The base implementation of `_.repeat` which doesn't coerce arguments.
     *
     * @private
     * @param {string} string The string to repeat.
     * @param {number} n The number of times to repeat the string.
     * @returns {string} Returns the repeated string.
     */
    function baseRepeat(string, n) {
      var result = '';
      if (!string || n < 1 || n > MAX_SAFE_INTEGER) {
        return result;
      }
      // Leverage the exponentiation by squaring algorithm for a faster repeat.
      // See https://en.wikipedia.org/wiki/Exponentiation_by_squaring for more details.
      do {
        if (n % 2) {
          result += string;
        }
        n = nativeFloor(n / 2);
        if (n) {
          string += string;
        }
      } while (n);

      return result;
    }

    /**
     * The base implementation of `_.set`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the property to set.
     * @param {*} value The value to set.
     * @param {Function} [customizer] The function to customize path creation.
     * @returns {Object} Returns `object`.
     */
    function baseSet(object, path, value, customizer) {
      path = isKey(path, object) ? [path] : castPath(path);

      var index = -1,
          length = path.length,
          lastIndex = length - 1,
          nested = object;

      while (nested != null && ++index < length) {
        var key = path[index];
        if (isObject(nested)) {
          var newValue = value;
          if (index != lastIndex) {
            var objValue = nested[key];
            newValue = customizer ? customizer(objValue, key, nested) : undefined;
            if (newValue === undefined) {
              newValue = objValue == null
                ? (isIndex(path[index + 1]) ? [] : {})
                : objValue;
            }
          }
          assignValue(nested, key, newValue);
        }
        nested = nested[key];
      }
      return object;
    }

    /**
     * The base implementation of `setData` without support for hot loop detection.
     *
     * @private
     * @param {Function} func The function to associate metadata with.
     * @param {*} data The metadata.
     * @returns {Function} Returns `func`.
     */
    var baseSetData = !metaMap ? identity : function(func, data) {
      metaMap.set(func, data);
      return func;
    };

    /**
     * The base implementation of `_.slice` without an iteratee call guard.
     *
     * @private
     * @param {Array} array The array to slice.
     * @param {number} [start=0] The start position.
     * @param {number} [end=array.length] The end position.
     * @returns {Array} Returns the slice of `array`.
     */
    function baseSlice(array, start, end) {
      var index = -1,
          length = array.length;

      if (start < 0) {
        start = -start > length ? 0 : (length + start);
      }
      end = end > length ? length : end;
      if (end < 0) {
        end += length;
      }
      length = start > end ? 0 : ((end - start) >>> 0);
      start >>>= 0;

      var result = Array(length);
      while (++index < length) {
        result[index] = array[index + start];
      }
      return result;
    }

    /**
     * The base implementation of `_.some` without support for iteratee shorthands.
     *
     * @private
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} predicate The function invoked per iteration.
     * @returns {boolean} Returns `true` if any element passes the predicate check,
     *  else `false`.
     */
    function baseSome(collection, predicate) {
      var result;

      baseEach(collection, function(value, index, collection) {
        result = predicate(value, index, collection);
        return !result;
      });
      return !!result;
    }

    /**
     * The base implementation of `_.sortedIndex` and `_.sortedLastIndex` which
     * performs a binary search of `array` to determine the index at which `value`
     * should be inserted into `array` in order to maintain its sort order.
     *
     * @private
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @param {boolean} [retHighest] Specify returning the highest qualified index.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     */
    function baseSortedIndex(array, value, retHighest) {
      var low = 0,
          high = array ? array.length : low;

      if (typeof value == 'number' && value === value && high <= HALF_MAX_ARRAY_LENGTH) {
        while (low < high) {
          var mid = (low + high) >>> 1,
              computed = array[mid];

          if ((retHighest ? (computed <= value) : (computed < value)) && computed !== null) {
            low = mid + 1;
          } else {
            high = mid;
          }
        }
        return high;
      }
      return baseSortedIndexBy(array, value, identity, retHighest);
    }

    /**
     * The base implementation of `_.sortedIndexBy` and `_.sortedLastIndexBy`
     * which invokes `iteratee` for `value` and each element of `array` to compute
     * their sort ranking. The iteratee is invoked with one argument; (value).
     *
     * @private
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @param {Function} iteratee The iteratee invoked per element.
     * @param {boolean} [retHighest] Specify returning the highest qualified index.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     */
    function baseSortedIndexBy(array, value, iteratee, retHighest) {
      value = iteratee(value);

      var low = 0,
          high = array ? array.length : 0,
          valIsNaN = value !== value,
          valIsNull = value === null,
          valIsUndef = value === undefined;

      while (low < high) {
        var mid = nativeFloor((low + high) / 2),
            computed = iteratee(array[mid]),
            isDef = computed !== undefined,
            isReflexive = computed === computed;

        if (valIsNaN) {
          var setLow = isReflexive || retHighest;
        } else if (valIsNull) {
          setLow = isReflexive && isDef && (retHighest || computed != null);
        } else if (valIsUndef) {
          setLow = isReflexive && (retHighest || isDef);
        } else if (computed == null) {
          setLow = false;
        } else {
          setLow = retHighest ? (computed <= value) : (computed < value);
        }
        if (setLow) {
          low = mid + 1;
        } else {
          high = mid;
        }
      }
      return nativeMin(high, MAX_ARRAY_INDEX);
    }

    /**
     * The base implementation of `_.sortedUniq`.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @returns {Array} Returns the new duplicate free array.
     */
    function baseSortedUniq(array) {
      return baseSortedUniqBy(array);
    }

    /**
     * The base implementation of `_.sortedUniqBy` without support for iteratee
     * shorthands.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @returns {Array} Returns the new duplicate free array.
     */
    function baseSortedUniqBy(array, iteratee) {
      var index = 0,
          length = array.length,
          value = array[0],
          computed = iteratee ? iteratee(value) : value,
          seen = computed,
          resIndex = 1,
          result = [value];

      while (++index < length) {
        value = array[index],
        computed = iteratee ? iteratee(value) : value;

        if (!eq(computed, seen)) {
          seen = computed;
          result[resIndex++] = value;
        }
      }
      return result;
    }

    /**
     * The base implementation of `_.uniqBy` without support for iteratee shorthands.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new duplicate free array.
     */
    function baseUniq(array, iteratee, comparator) {
      var index = -1,
          includes = arrayIncludes,
          length = array.length,
          isCommon = true,
          result = [],
          seen = result;

      if (comparator) {
        isCommon = false;
        includes = arrayIncludesWith;
      }
      else if (length >= LARGE_ARRAY_SIZE) {
        var set = iteratee ? null : createSet(array);
        if (set) {
          return setToArray(set);
        }
        isCommon = false;
        includes = cacheHas;
        seen = new SetCache;
      }
      else {
        seen = iteratee ? [] : result;
      }
      outer:
      while (++index < length) {
        var value = array[index],
            computed = iteratee ? iteratee(value) : value;

        if (isCommon && computed === computed) {
          var seenIndex = seen.length;
          while (seenIndex--) {
            if (seen[seenIndex] === computed) {
              continue outer;
            }
          }
          if (iteratee) {
            seen.push(computed);
          }
          result.push(value);
        }
        else if (!includes(seen, computed, comparator)) {
          if (seen !== result) {
            seen.push(computed);
          }
          result.push(value);
        }
      }
      return result;
    }

    /**
     * The base implementation of `_.unset`.
     *
     * @private
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to unset.
     * @returns {boolean} Returns `true` if the property is deleted, else `false`.
     */
    function baseUnset(object, path) {
      path = isKey(path, object) ? [path] : castPath(path);
      object = parent(object, path);
      var key = last(path);
      return (object != null && has(object, key)) ? delete object[key] : true;
    }

    /**
     * The base implementation of `_.update`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the property to update.
     * @param {Function} updater The function to produce the updated value.
     * @param {Function} [customizer] The function to customize path creation.
     * @returns {Object} Returns `object`.
     */
    function baseUpdate(object, path, updater, customizer) {
      return baseSet(object, path, updater(baseGet(object, path)), customizer);
    }

    /**
     * The base implementation of methods like `_.dropWhile` and `_.takeWhile`
     * without support for iteratee shorthands.
     *
     * @private
     * @param {Array} array The array to query.
     * @param {Function} predicate The function invoked per iteration.
     * @param {boolean} [isDrop] Specify dropping elements instead of taking them.
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Array} Returns the slice of `array`.
     */
    function baseWhile(array, predicate, isDrop, fromRight) {
      var length = array.length,
          index = fromRight ? length : -1;

      while ((fromRight ? index-- : ++index < length) &&
        predicate(array[index], index, array)) {}

      return isDrop
        ? baseSlice(array, (fromRight ? 0 : index), (fromRight ? index + 1 : length))
        : baseSlice(array, (fromRight ? index + 1 : 0), (fromRight ? length : index));
    }

    /**
     * The base implementation of `wrapperValue` which returns the result of
     * performing a sequence of actions on the unwrapped `value`, where each
     * successive action is supplied the return value of the previous.
     *
     * @private
     * @param {*} value The unwrapped value.
     * @param {Array} actions Actions to perform to resolve the unwrapped value.
     * @returns {*} Returns the resolved value.
     */
    function baseWrapperValue(value, actions) {
      var result = value;
      if (result instanceof LazyWrapper) {
        result = result.value();
      }
      return arrayReduce(actions, function(result, action) {
        return action.func.apply(action.thisArg, arrayPush([result], action.args));
      }, result);
    }

    /**
     * The base implementation of methods like `_.xor`, without support for
     * iteratee shorthands, that accepts an array of arrays to inspect.
     *
     * @private
     * @param {Array} arrays The arrays to inspect.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of values.
     */
    function baseXor(arrays, iteratee, comparator) {
      var index = -1,
          length = arrays.length;

      while (++index < length) {
        var result = result
          ? arrayPush(
              baseDifference(result, arrays[index], iteratee, comparator),
              baseDifference(arrays[index], result, iteratee, comparator)
            )
          : arrays[index];
      }
      return (result && result.length) ? baseUniq(result, iteratee, comparator) : [];
    }

    /**
     * This base implementation of `_.zipObject` which assigns values using `assignFunc`.
     *
     * @private
     * @param {Array} props The property identifiers.
     * @param {Array} values The property values.
     * @param {Function} assignFunc The function to assign values.
     * @returns {Object} Returns the new object.
     */
    function baseZipObject(props, values, assignFunc) {
      var index = -1,
          length = props.length,
          valsLength = values.length,
          result = {};

      while (++index < length) {
        var value = index < valsLength ? values[index] : undefined;
        assignFunc(result, props[index], value);
      }
      return result;
    }

    /**
     * Casts `value` to an empty array if it's not an array like object.
     *
     * @private
     * @param {*} value The value to inspect.
     * @returns {Array|Object} Returns the cast array-like object.
     */
    function castArrayLikeObject(value) {
      return isArrayLikeObject(value) ? value : [];
    }

    /**
     * Casts `value` to `identity` if it's not a function.
     *
     * @private
     * @param {*} value The value to inspect.
     * @returns {Function} Returns cast function.
     */
    function castFunction(value) {
      return typeof value == 'function' ? value : identity;
    }

    /**
     * Casts `value` to a path array if it's not one.
     *
     * @private
     * @param {*} value The value to inspect.
     * @returns {Array} Returns the cast property path array.
     */
    function castPath(value) {
      return isArray(value) ? value : stringToPath(value);
    }

    /**
     * Casts `array` to a slice if it's needed.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @param {number} start The start position.
     * @param {number} [end=array.length] The end position.
     * @returns {Array} Returns the cast slice.
     */
    function castSlice(array, start, end) {
      var length = array.length;
      end = end === undefined ? length : end;
      return (!start && end >= length) ? array : baseSlice(array, start, end);
    }

    /**
     * Creates a clone of  `buffer`.
     *
     * @private
     * @param {Buffer} buffer The buffer to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Buffer} Returns the cloned buffer.
     */
    function cloneBuffer(buffer, isDeep) {
      if (isDeep) {
        return buffer.slice();
      }
      var result = new buffer.constructor(buffer.length);
      buffer.copy(result);
      return result;
    }

    /**
     * Creates a clone of `arrayBuffer`.
     *
     * @private
     * @param {ArrayBuffer} arrayBuffer The array buffer to clone.
     * @returns {ArrayBuffer} Returns the cloned array buffer.
     */
    function cloneArrayBuffer(arrayBuffer) {
      var result = new arrayBuffer.constructor(arrayBuffer.byteLength);
      new Uint8Array(result).set(new Uint8Array(arrayBuffer));
      return result;
    }

    /**
     * Creates a clone of `dataView`.
     *
     * @private
     * @param {Object} dataView The data view to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned data view.
     */
    function cloneDataView(dataView, isDeep) {
      var buffer = isDeep ? cloneArrayBuffer(dataView.buffer) : dataView.buffer;
      return new dataView.constructor(buffer, dataView.byteOffset, dataView.byteLength);
    }

    /**
     * Creates a clone of `map`.
     *
     * @private
     * @param {Object} map The map to clone.
     * @param {Function} cloneFunc The function to clone values.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned map.
     */
    function cloneMap(map, isDeep, cloneFunc) {
      var array = isDeep ? cloneFunc(mapToArray(map), true) : mapToArray(map);
      return arrayReduce(array, addMapEntry, new map.constructor);
    }

    /**
     * Creates a clone of `regexp`.
     *
     * @private
     * @param {Object} regexp The regexp to clone.
     * @returns {Object} Returns the cloned regexp.
     */
    function cloneRegExp(regexp) {
      var result = new regexp.constructor(regexp.source, reFlags.exec(regexp));
      result.lastIndex = regexp.lastIndex;
      return result;
    }

    /**
     * Creates a clone of `set`.
     *
     * @private
     * @param {Object} set The set to clone.
     * @param {Function} cloneFunc The function to clone values.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned set.
     */
    function cloneSet(set, isDeep, cloneFunc) {
      var array = isDeep ? cloneFunc(setToArray(set), true) : setToArray(set);
      return arrayReduce(array, addSetEntry, new set.constructor);
    }

    /**
     * Creates a clone of the `symbol` object.
     *
     * @private
     * @param {Object} symbol The symbol object to clone.
     * @returns {Object} Returns the cloned symbol object.
     */
    function cloneSymbol(symbol) {
      return symbolValueOf ? Object(symbolValueOf.call(symbol)) : {};
    }

    /**
     * Creates a clone of `typedArray`.
     *
     * @private
     * @param {Object} typedArray The typed array to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned typed array.
     */
    function cloneTypedArray(typedArray, isDeep) {
      var buffer = isDeep ? cloneArrayBuffer(typedArray.buffer) : typedArray.buffer;
      return new typedArray.constructor(buffer, typedArray.byteOffset, typedArray.length);
    }

    /**
     * Creates an array that is the composition of partially applied arguments,
     * placeholders, and provided arguments into a single array of arguments.
     *
     * @private
     * @param {Array|Object} args The provided arguments.
     * @param {Array} partials The arguments to prepend to those provided.
     * @param {Array} holders The `partials` placeholder indexes.
     * @params {boolean} [isCurried] Specify composing for a curried function.
     * @returns {Array} Returns the new array of composed arguments.
     */
    function composeArgs(args, partials, holders, isCurried) {
      var argsIndex = -1,
          argsLength = args.length,
          holdersLength = holders.length,
          leftIndex = -1,
          leftLength = partials.length,
          rangeLength = nativeMax(argsLength - holdersLength, 0),
          result = Array(leftLength + rangeLength),
          isUncurried = !isCurried;

      while (++leftIndex < leftLength) {
        result[leftIndex] = partials[leftIndex];
      }
      while (++argsIndex < holdersLength) {
        if (isUncurried || argsIndex < argsLength) {
          result[holders[argsIndex]] = args[argsIndex];
        }
      }
      while (rangeLength--) {
        result[leftIndex++] = args[argsIndex++];
      }
      return result;
    }

    /**
     * This function is like `composeArgs` except that the arguments composition
     * is tailored for `_.partialRight`.
     *
     * @private
     * @param {Array|Object} args The provided arguments.
     * @param {Array} partials The arguments to append to those provided.
     * @param {Array} holders The `partials` placeholder indexes.
     * @params {boolean} [isCurried] Specify composing for a curried function.
     * @returns {Array} Returns the new array of composed arguments.
     */
    function composeArgsRight(args, partials, holders, isCurried) {
      var argsIndex = -1,
          argsLength = args.length,
          holdersIndex = -1,
          holdersLength = holders.length,
          rightIndex = -1,
          rightLength = partials.length,
          rangeLength = nativeMax(argsLength - holdersLength, 0),
          result = Array(rangeLength + rightLength),
          isUncurried = !isCurried;

      while (++argsIndex < rangeLength) {
        result[argsIndex] = args[argsIndex];
      }
      var offset = argsIndex;
      while (++rightIndex < rightLength) {
        result[offset + rightIndex] = partials[rightIndex];
      }
      while (++holdersIndex < holdersLength) {
        if (isUncurried || argsIndex < argsLength) {
          result[offset + holders[holdersIndex]] = args[argsIndex++];
        }
      }
      return result;
    }

    /**
     * Copies the values of `source` to `array`.
     *
     * @private
     * @param {Array} source The array to copy values from.
     * @param {Array} [array=[]] The array to copy values to.
     * @returns {Array} Returns `array`.
     */
    function copyArray(source, array) {
      var index = -1,
          length = source.length;

      array || (array = Array(length));
      while (++index < length) {
        array[index] = source[index];
      }
      return array;
    }

    /**
     * Copies properties of `source` to `object`.
     *
     * @private
     * @param {Object} source The object to copy properties from.
     * @param {Array} props The property identifiers to copy.
     * @param {Object} [object={}] The object to copy properties to.
     * @param {Function} [customizer] The function to customize copied values.
     * @returns {Object} Returns `object`.
     */
    function copyObject(source, props, object, customizer) {
      object || (object = {});

      var index = -1,
          length = props.length;

      while (++index < length) {
        var key = props[index];

        var newValue = customizer
          ? customizer(object[key], source[key], key, object, source)
          : source[key];

        assignValue(object, key, newValue);
      }
      return object;
    }

    /**
     * Copies own symbol properties of `source` to `object`.
     *
     * @private
     * @param {Object} source The object to copy symbols from.
     * @param {Object} [object={}] The object to copy symbols to.
     * @returns {Object} Returns `object`.
     */
    function copySymbols(source, object) {
      return copyObject(source, getSymbols(source), object);
    }

    /**
     * Creates a function like `_.groupBy`.
     *
     * @private
     * @param {Function} setter The function to set accumulator values.
     * @param {Function} [initializer] The accumulator object initializer.
     * @returns {Function} Returns the new aggregator function.
     */
    function createAggregator(setter, initializer) {
      return function(collection, iteratee) {
        var func = isArray(collection) ? arrayAggregator : baseAggregator,
            accumulator = initializer ? initializer() : {};

        return func(collection, setter, getIteratee(iteratee), accumulator);
      };
    }

    /**
     * Creates a function like `_.assign`.
     *
     * @private
     * @param {Function} assigner The function to assign values.
     * @returns {Function} Returns the new assigner function.
     */
    function createAssigner(assigner) {
      return rest(function(object, sources) {
        var index = -1,
            length = sources.length,
            customizer = length > 1 ? sources[length - 1] : undefined,
            guard = length > 2 ? sources[2] : undefined;

        customizer = typeof customizer == 'function'
          ? (length--, customizer)
          : undefined;

        if (guard && isIterateeCall(sources[0], sources[1], guard)) {
          customizer = length < 3 ? undefined : customizer;
          length = 1;
        }
        object = Object(object);
        while (++index < length) {
          var source = sources[index];
          if (source) {
            assigner(object, source, index, customizer);
          }
        }
        return object;
      });
    }

    /**
     * Creates a `baseEach` or `baseEachRight` function.
     *
     * @private
     * @param {Function} eachFunc The function to iterate over a collection.
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Function} Returns the new base function.
     */
    function createBaseEach(eachFunc, fromRight) {
      return function(collection, iteratee) {
        if (collection == null) {
          return collection;
        }
        if (!isArrayLike(collection)) {
          return eachFunc(collection, iteratee);
        }
        var length = collection.length,
            index = fromRight ? length : -1,
            iterable = Object(collection);

        while ((fromRight ? index-- : ++index < length)) {
          if (iteratee(iterable[index], index, iterable) === false) {
            break;
          }
        }
        return collection;
      };
    }

    /**
     * Creates a base function for methods like `_.forIn` and `_.forOwn`.
     *
     * @private
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Function} Returns the new base function.
     */
    function createBaseFor(fromRight) {
      return function(object, iteratee, keysFunc) {
        var index = -1,
            iterable = Object(object),
            props = keysFunc(object),
            length = props.length;

        while (length--) {
          var key = props[fromRight ? length : ++index];
          if (iteratee(iterable[key], key, iterable) === false) {
            break;
          }
        }
        return object;
      };
    }

    /**
     * Creates a function that wraps `func` to invoke it with the optional `this`
     * binding of `thisArg`.
     *
     * @private
     * @param {Function} func The function to wrap.
     * @param {number} bitmask The bitmask of wrapper flags. See `createWrapper`
     *  for more details.
     * @param {*} [thisArg] The `this` binding of `func`.
     * @returns {Function} Returns the new wrapped function.
     */
    function createBaseWrapper(func, bitmask, thisArg) {
      var isBind = bitmask & BIND_FLAG,
          Ctor = createCtorWrapper(func);

      function wrapper() {
        var fn = (this && this !== root && this instanceof wrapper) ? Ctor : func;
        return fn.apply(isBind ? thisArg : this, arguments);
      }
      return wrapper;
    }

    /**
     * Creates a function like `_.lowerFirst`.
     *
     * @private
     * @param {string} methodName The name of the `String` case method to use.
     * @returns {Function} Returns the new function.
     */
    function createCaseFirst(methodName) {
      return function(string) {
        string = toString(string);

        var strSymbols = reHasComplexSymbol.test(string)
          ? stringToArray(string)
          : undefined;

        var chr = strSymbols
          ? strSymbols[0]
          : string.charAt(0);

        var trailing = strSymbols
          ? castSlice(strSymbols, 1).join('')
          : string.slice(1);

        return chr[methodName]() + trailing;
      };
    }

    /**
     * Creates a function like `_.camelCase`.
     *
     * @private
     * @param {Function} callback The function to combine each word.
     * @returns {Function} Returns the new compounder function.
     */
    function createCompounder(callback) {
      return function(string) {
        return arrayReduce(words(deburr(string).replace(reApos, '')), callback, '');
      };
    }

    /**
     * Creates a function that produces an instance of `Ctor` regardless of
     * whether it was invoked as part of a `new` expression or by `call` or `apply`.
     *
     * @private
     * @param {Function} Ctor The constructor to wrap.
     * @returns {Function} Returns the new wrapped function.
     */
    function createCtorWrapper(Ctor) {
      return function() {
        // Use a `switch` statement to work with class constructors. See
        // http://ecma-international.org/ecma-262/6.0/#sec-ecmascript-function-objects-call-thisargument-argumentslist
        // for more details.
        var args = arguments;
        switch (args.length) {
          case 0: return new Ctor;
          case 1: return new Ctor(args[0]);
          case 2: return new Ctor(args[0], args[1]);
          case 3: return new Ctor(args[0], args[1], args[2]);
          case 4: return new Ctor(args[0], args[1], args[2], args[3]);
          case 5: return new Ctor(args[0], args[1], args[2], args[3], args[4]);
          case 6: return new Ctor(args[0], args[1], args[2], args[3], args[4], args[5]);
          case 7: return new Ctor(args[0], args[1], args[2], args[3], args[4], args[5], args[6]);
        }
        var thisBinding = baseCreate(Ctor.prototype),
            result = Ctor.apply(thisBinding, args);

        // Mimic the constructor's `return` behavior.
        // See https://es5.github.io/#x13.2.2 for more details.
        return isObject(result) ? result : thisBinding;
      };
    }

    /**
     * Creates a function that wraps `func` to enable currying.
     *
     * @private
     * @param {Function} func The function to wrap.
     * @param {number} bitmask The bitmask of wrapper flags. See `createWrapper`
     *  for more details.
     * @param {number} arity The arity of `func`.
     * @returns {Function} Returns the new wrapped function.
     */
    function createCurryWrapper(func, bitmask, arity) {
      var Ctor = createCtorWrapper(func);

      function wrapper() {
        var length = arguments.length,
            args = Array(length),
            index = length,
            placeholder = getPlaceholder(wrapper);

        while (index--) {
          args[index] = arguments[index];
        }
        var holders = (length < 3 && args[0] !== placeholder && args[length - 1] !== placeholder)
          ? []
          : replaceHolders(args, placeholder);

        length -= holders.length;
        if (length < arity) {
          return createRecurryWrapper(
            func, bitmask, createHybridWrapper, wrapper.placeholder, undefined,
            args, holders, undefined, undefined, arity - length);
        }
        var fn = (this && this !== root && this instanceof wrapper) ? Ctor : func;
        return apply(fn, this, args);
      }
      return wrapper;
    }

    /**
     * Creates a `_.flow` or `_.flowRight` function.
     *
     * @private
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Function} Returns the new flow function.
     */
    function createFlow(fromRight) {
      return rest(function(funcs) {
        funcs = baseFlatten(funcs, 1);

        var length = funcs.length,
            index = length,
            prereq = LodashWrapper.prototype.thru;

        if (fromRight) {
          funcs.reverse();
        }
        while (index--) {
          var func = funcs[index];
          if (typeof func != 'function') {
            throw new TypeError(FUNC_ERROR_TEXT);
          }
          if (prereq && !wrapper && getFuncName(func) == 'wrapper') {
            var wrapper = new LodashWrapper([], true);
          }
        }
        index = wrapper ? index : length;
        while (++index < length) {
          func = funcs[index];

          var funcName = getFuncName(func),
              data = funcName == 'wrapper' ? getData(func) : undefined;

          if (data && isLaziable(data[0]) &&
                data[1] == (ARY_FLAG | CURRY_FLAG | PARTIAL_FLAG | REARG_FLAG) &&
                !data[4].length && data[9] == 1
              ) {
            wrapper = wrapper[getFuncName(data[0])].apply(wrapper, data[3]);
          } else {
            wrapper = (func.length == 1 && isLaziable(func))
              ? wrapper[funcName]()
              : wrapper.thru(func);
          }
        }
        return function() {
          var args = arguments,
              value = args[0];

          if (wrapper && args.length == 1 &&
              isArray(value) && value.length >= LARGE_ARRAY_SIZE) {
            return wrapper.plant(value).value();
          }
          var index = 0,
              result = length ? funcs[index].apply(this, args) : value;

          while (++index < length) {
            result = funcs[index].call(this, result);
          }
          return result;
        };
      });
    }

    /**
     * Creates a function that wraps `func` to invoke it with optional `this`
     * binding of `thisArg`, partial application, and currying.
     *
     * @private
     * @param {Function|string} func The function or method name to wrap.
     * @param {number} bitmask The bitmask of wrapper flags. See `createWrapper`
     *  for more details.
     * @param {*} [thisArg] The `this` binding of `func`.
     * @param {Array} [partials] The arguments to prepend to those provided to
     *  the new function.
     * @param {Array} [holders] The `partials` placeholder indexes.
     * @param {Array} [partialsRight] The arguments to append to those provided
     *  to the new function.
     * @param {Array} [holdersRight] The `partialsRight` placeholder indexes.
     * @param {Array} [argPos] The argument positions of the new function.
     * @param {number} [ary] The arity cap of `func`.
     * @param {number} [arity] The arity of `func`.
     * @returns {Function} Returns the new wrapped function.
     */
    function createHybridWrapper(func, bitmask, thisArg, partials, holders, partialsRight, holdersRight, argPos, ary, arity) {
      var isAry = bitmask & ARY_FLAG,
          isBind = bitmask & BIND_FLAG,
          isBindKey = bitmask & BIND_KEY_FLAG,
          isCurried = bitmask & (CURRY_FLAG | CURRY_RIGHT_FLAG),
          isFlip = bitmask & FLIP_FLAG,
          Ctor = isBindKey ? undefined : createCtorWrapper(func);

      function wrapper() {
        var length = arguments.length,
            index = length,
            args = Array(length);

        while (index--) {
          args[index] = arguments[index];
        }
        if (isCurried) {
          var placeholder = getPlaceholder(wrapper),
              holdersCount = countHolders(args, placeholder);
        }
        if (partials) {
          args = composeArgs(args, partials, holders, isCurried);
        }
        if (partialsRight) {
          args = composeArgsRight(args, partialsRight, holdersRight, isCurried);
        }
        length -= holdersCount;
        if (isCurried && length < arity) {
          var newHolders = replaceHolders(args, placeholder);
          return createRecurryWrapper(
            func, bitmask, createHybridWrapper, wrapper.placeholder, thisArg,
            args, newHolders, argPos, ary, arity - length
          );
        }
        var thisBinding = isBind ? thisArg : this,
            fn = isBindKey ? thisBinding[func] : func;

        length = args.length;
        if (argPos) {
          args = reorder(args, argPos);
        } else if (isFlip && length > 1) {
          args.reverse();
        }
        if (isAry && ary < length) {
          args.length = ary;
        }
        if (this && this !== root && this instanceof wrapper) {
          fn = Ctor || createCtorWrapper(fn);
        }
        return fn.apply(thisBinding, args);
      }
      return wrapper;
    }

    /**
     * Creates a function like `_.invertBy`.
     *
     * @private
     * @param {Function} setter The function to set accumulator values.
     * @param {Function} toIteratee The function to resolve iteratees.
     * @returns {Function} Returns the new inverter function.
     */
    function createInverter(setter, toIteratee) {
      return function(object, iteratee) {
        return baseInverter(object, setter, toIteratee(iteratee), {});
      };
    }

    /**
     * Creates a function like `_.over`.
     *
     * @private
     * @param {Function} arrayFunc The function to iterate over iteratees.
     * @returns {Function} Returns the new invoker function.
     */
    function createOver(arrayFunc) {
      return rest(function(iteratees) {
        iteratees = (iteratees.length == 1 && isArray(iteratees[0]))
          ? arrayMap(iteratees[0], baseUnary(getIteratee()))
          : arrayMap(baseFlatten(iteratees, 1, isFlattenableIteratee), baseUnary(getIteratee()));

        return rest(function(args) {
          var thisArg = this;
          return arrayFunc(iteratees, function(iteratee) {
            return apply(iteratee, thisArg, args);
          });
        });
      });
    }

    /**
     * Creates the padding for `string` based on `length`. The `chars` string
     * is truncated if the number of characters exceeds `length`.
     *
     * @private
     * @param {number} length The padding length.
     * @param {string} [chars=' '] The string used as padding.
     * @returns {string} Returns the padding for `string`.
     */
    function createPadding(length, chars) {
      chars = chars === undefined ? ' ' : (chars + '');

      var charsLength = chars.length;
      if (charsLength < 2) {
        return charsLength ? baseRepeat(chars, length) : chars;
      }
      var result = baseRepeat(chars, nativeCeil(length / stringSize(chars)));
      return reHasComplexSymbol.test(chars)
        ? castSlice(stringToArray(result), 0, length).join('')
        : result.slice(0, length);
    }

    /**
     * Creates a function that wraps `func` to invoke it with the `this` binding
     * of `thisArg` and `partials` prepended to the arguments it receives.
     *
     * @private
     * @param {Function} func The function to wrap.
     * @param {number} bitmask The bitmask of wrapper flags. See `createWrapper`
     *  for more details.
     * @param {*} thisArg The `this` binding of `func`.
     * @param {Array} partials The arguments to prepend to those provided to
     *  the new function.
     * @returns {Function} Returns the new wrapped function.
     */
    function createPartialWrapper(func, bitmask, thisArg, partials) {
      var isBind = bitmask & BIND_FLAG,
          Ctor = createCtorWrapper(func);

      function wrapper() {
        var argsIndex = -1,
            argsLength = arguments.length,
            leftIndex = -1,
            leftLength = partials.length,
            args = Array(leftLength + argsLength),
            fn = (this && this !== root && this instanceof wrapper) ? Ctor : func;

        while (++leftIndex < leftLength) {
          args[leftIndex] = partials[leftIndex];
        }
        while (argsLength--) {
          args[leftIndex++] = arguments[++argsIndex];
        }
        return apply(fn, isBind ? thisArg : this, args);
      }
      return wrapper;
    }

    /**
     * Creates a `_.range` or `_.rangeRight` function.
     *
     * @private
     * @param {boolean} [fromRight] Specify iterating from right to left.
     * @returns {Function} Returns the new range function.
     */
    function createRange(fromRight) {
      return function(start, end, step) {
        if (step && typeof step != 'number' && isIterateeCall(start, end, step)) {
          end = step = undefined;
        }
        // Ensure the sign of `-0` is preserved.
        start = toNumber(start);
        start = start === start ? start : 0;
        if (end === undefined) {
          end = start;
          start = 0;
        } else {
          end = toNumber(end) || 0;
        }
        step = step === undefined ? (start < end ? 1 : -1) : (toNumber(step) || 0);
        return baseRange(start, end, step, fromRight);
      };
    }

    /**
     * Creates a function that wraps `func` to continue currying.
     *
     * @private
     * @param {Function} func The function to wrap.
     * @param {number} bitmask The bitmask of wrapper flags. See `createWrapper`
     *  for more details.
     * @param {Function} wrapFunc The function to create the `func` wrapper.
     * @param {*} placeholder The placeholder value.
     * @param {*} [thisArg] The `this` binding of `func`.
     * @param {Array} [partials] The arguments to prepend to those provided to
     *  the new function.
     * @param {Array} [holders] The `partials` placeholder indexes.
     * @param {Array} [argPos] The argument positions of the new function.
     * @param {number} [ary] The arity cap of `func`.
     * @param {number} [arity] The arity of `func`.
     * @returns {Function} Returns the new wrapped function.
     */
    function createRecurryWrapper(func, bitmask, wrapFunc, placeholder, thisArg, partials, holders, argPos, ary, arity) {
      var isCurry = bitmask & CURRY_FLAG,
          newHolders = isCurry ? holders : undefined,
          newHoldersRight = isCurry ? undefined : holders,
          newPartials = isCurry ? partials : undefined,
          newPartialsRight = isCurry ? undefined : partials;

      bitmask |= (isCurry ? PARTIAL_FLAG : PARTIAL_RIGHT_FLAG);
      bitmask &= ~(isCurry ? PARTIAL_RIGHT_FLAG : PARTIAL_FLAG);

      if (!(bitmask & CURRY_BOUND_FLAG)) {
        bitmask &= ~(BIND_FLAG | BIND_KEY_FLAG);
      }
      var newData = [
        func, bitmask, thisArg, newPartials, newHolders, newPartialsRight,
        newHoldersRight, argPos, ary, arity
      ];

      var result = wrapFunc.apply(undefined, newData);
      if (isLaziable(func)) {
        setData(result, newData);
      }
      result.placeholder = placeholder;
      return result;
    }

    /**
     * Creates a function like `_.round`.
     *
     * @private
     * @param {string} methodName The name of the `Math` method to use when rounding.
     * @returns {Function} Returns the new round function.
     */
    function createRound(methodName) {
      var func = Math[methodName];
      return function(number, precision) {
        number = toNumber(number);
        precision = toInteger(precision);
        if (precision) {
          // Shift with exponential notation to avoid floating-point issues.
          // See [MDN](https://mdn.io/round#Examples) for more details.
          var pair = (toString(number) + 'e').split('e'),
              value = func(pair[0] + 'e' + (+pair[1] + precision));

          pair = (toString(value) + 'e').split('e');
          return +(pair[0] + 'e' + (+pair[1] - precision));
        }
        return func(number);
      };
    }

    /**
     * Creates a set of `values`.
     *
     * @private
     * @param {Array} values The values to add to the set.
     * @returns {Object} Returns the new set.
     */
    var createSet = !(Set && new Set([1, 2]).size === 2) ? noop : function(values) {
      return new Set(values);
    };

    /**
     * Creates a function that either curries or invokes `func` with optional
     * `this` binding and partially applied arguments.
     *
     * @private
     * @param {Function|string} func The function or method name to wrap.
     * @param {number} bitmask The bitmask of wrapper flags.
     *  The bitmask may be composed of the following flags:
     *     1 - `_.bind`
     *     2 - `_.bindKey`
     *     4 - `_.curry` or `_.curryRight` of a bound function
     *     8 - `_.curry`
     *    16 - `_.curryRight`
     *    32 - `_.partial`
     *    64 - `_.partialRight`
     *   128 - `_.rearg`
     *   256 - `_.ary`
     * @param {*} [thisArg] The `this` binding of `func`.
     * @param {Array} [partials] The arguments to be partially applied.
     * @param {Array} [holders] The `partials` placeholder indexes.
     * @param {Array} [argPos] The argument positions of the new function.
     * @param {number} [ary] The arity cap of `func`.
     * @param {number} [arity] The arity of `func`.
     * @returns {Function} Returns the new wrapped function.
     */
    function createWrapper(func, bitmask, thisArg, partials, holders, argPos, ary, arity) {
      var isBindKey = bitmask & BIND_KEY_FLAG;
      if (!isBindKey && typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      var length = partials ? partials.length : 0;
      if (!length) {
        bitmask &= ~(PARTIAL_FLAG | PARTIAL_RIGHT_FLAG);
        partials = holders = undefined;
      }
      ary = ary === undefined ? ary : nativeMax(toInteger(ary), 0);
      arity = arity === undefined ? arity : toInteger(arity);
      length -= holders ? holders.length : 0;

      if (bitmask & PARTIAL_RIGHT_FLAG) {
        var partialsRight = partials,
            holdersRight = holders;

        partials = holders = undefined;
      }
      var data = isBindKey ? undefined : getData(func);

      var newData = [
        func, bitmask, thisArg, partials, holders, partialsRight, holdersRight,
        argPos, ary, arity
      ];

      if (data) {
        mergeData(newData, data);
      }
      func = newData[0];
      bitmask = newData[1];
      thisArg = newData[2];
      partials = newData[3];
      holders = newData[4];
      arity = newData[9] = newData[9] == null
        ? (isBindKey ? 0 : func.length)
        : nativeMax(newData[9] - length, 0);

      if (!arity && bitmask & (CURRY_FLAG | CURRY_RIGHT_FLAG)) {
        bitmask &= ~(CURRY_FLAG | CURRY_RIGHT_FLAG);
      }
      if (!bitmask || bitmask == BIND_FLAG) {
        var result = createBaseWrapper(func, bitmask, thisArg);
      } else if (bitmask == CURRY_FLAG || bitmask == CURRY_RIGHT_FLAG) {
        result = createCurryWrapper(func, bitmask, arity);
      } else if ((bitmask == PARTIAL_FLAG || bitmask == (BIND_FLAG | PARTIAL_FLAG)) && !holders.length) {
        result = createPartialWrapper(func, bitmask, thisArg, partials);
      } else {
        result = createHybridWrapper.apply(undefined, newData);
      }
      var setter = data ? baseSetData : setData;
      return setter(result, newData);
    }

    /**
     * A specialized version of `baseIsEqualDeep` for arrays with support for
     * partial deep comparisons.
     *
     * @private
     * @param {Array} array The array to compare.
     * @param {Array} other The other array to compare.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Function} customizer The function to customize comparisons.
     * @param {number} bitmask The bitmask of comparison flags. See `baseIsEqual`
     *  for more details.
     * @param {Object} stack Tracks traversed `array` and `other` objects.
     * @returns {boolean} Returns `true` if the arrays are equivalent, else `false`.
     */
    function equalArrays(array, other, equalFunc, customizer, bitmask, stack) {
      var index = -1,
          isPartial = bitmask & PARTIAL_COMPARE_FLAG,
          isUnordered = bitmask & UNORDERED_COMPARE_FLAG,
          arrLength = array.length,
          othLength = other.length;

      if (arrLength != othLength && !(isPartial && othLength > arrLength)) {
        return false;
      }
      // Assume cyclic values are equal.
      var stacked = stack.get(array);
      if (stacked) {
        return stacked == other;
      }
      var result = true;
      stack.set(array, other);

      // Ignore non-index properties.
      while (++index < arrLength) {
        var arrValue = array[index],
            othValue = other[index];

        if (customizer) {
          var compared = isPartial
            ? customizer(othValue, arrValue, index, other, array, stack)
            : customizer(arrValue, othValue, index, array, other, stack);
        }
        if (compared !== undefined) {
          if (compared) {
            continue;
          }
          result = false;
          break;
        }
        // Recursively compare arrays (susceptible to call stack limits).
        if (isUnordered) {
          if (!arraySome(other, function(othValue) {
                return arrValue === othValue ||
                  equalFunc(arrValue, othValue, customizer, bitmask, stack);
              })) {
            result = false;
            break;
          }
        } else if (!(
              arrValue === othValue ||
                equalFunc(arrValue, othValue, customizer, bitmask, stack)
            )) {
          result = false;
          break;
        }
      }
      stack['delete'](array);
      return result;
    }

    /**
     * A specialized version of `baseIsEqualDeep` for comparing objects of
     * the same `toStringTag`.
     *
     * **Note:** This function only supports comparing values with tags of
     * `Boolean`, `Date`, `Error`, `Number`, `RegExp`, or `String`.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {string} tag The `toStringTag` of the objects to compare.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Function} customizer The function to customize comparisons.
     * @param {number} bitmask The bitmask of comparison flags. See `baseIsEqual`
     *  for more details.
     * @param {Object} stack Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function equalByTag(object, other, tag, equalFunc, customizer, bitmask, stack) {
      switch (tag) {
        case dataViewTag:
          if ((object.byteLength != other.byteLength) ||
              (object.byteOffset != other.byteOffset)) {
            return false;
          }
          object = object.buffer;
          other = other.buffer;

        case arrayBufferTag:
          if ((object.byteLength != other.byteLength) ||
              !equalFunc(new Uint8Array(object), new Uint8Array(other))) {
            return false;
          }
          return true;

        case boolTag:
        case dateTag:
          // Coerce dates and booleans to numbers, dates to milliseconds and
          // booleans to `1` or `0` treating invalid dates coerced to `NaN` as
          // not equal.
          return +object == +other;

        case errorTag:
          return object.name == other.name && object.message == other.message;

        case numberTag:
          // Treat `NaN` vs. `NaN` as equal.
          return (object != +object) ? other != +other : object == +other;

        case regexpTag:
        case stringTag:
          // Coerce regexes to strings and treat strings, primitives and objects,
          // as equal. See http://www.ecma-international.org/ecma-262/6.0/#sec-regexp.prototype.tostring
          // for more details.
          return object == (other + '');

        case mapTag:
          var convert = mapToArray;

        case setTag:
          var isPartial = bitmask & PARTIAL_COMPARE_FLAG;
          convert || (convert = setToArray);

          if (object.size != other.size && !isPartial) {
            return false;
          }
          // Assume cyclic values are equal.
          var stacked = stack.get(object);
          if (stacked) {
            return stacked == other;
          }
          bitmask |= UNORDERED_COMPARE_FLAG;
          stack.set(object, other);

          // Recursively compare objects (susceptible to call stack limits).
          return equalArrays(convert(object), convert(other), equalFunc, customizer, bitmask, stack);

        case symbolTag:
          if (symbolValueOf) {
            return symbolValueOf.call(object) == symbolValueOf.call(other);
          }
      }
      return false;
    }

    /**
     * A specialized version of `baseIsEqualDeep` for objects with support for
     * partial deep comparisons.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Function} customizer The function to customize comparisons.
     * @param {number} bitmask The bitmask of comparison flags. See `baseIsEqual`
     *  for more details.
     * @param {Object} stack Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function equalObjects(object, other, equalFunc, customizer, bitmask, stack) {
      var isPartial = bitmask & PARTIAL_COMPARE_FLAG,
          objProps = keys(object),
          objLength = objProps.length,
          othProps = keys(other),
          othLength = othProps.length;

      if (objLength != othLength && !isPartial) {
        return false;
      }
      var index = objLength;
      while (index--) {
        var key = objProps[index];
        if (!(isPartial ? key in other : baseHas(other, key))) {
          return false;
        }
      }
      // Assume cyclic values are equal.
      var stacked = stack.get(object);
      if (stacked) {
        return stacked == other;
      }
      var result = true;
      stack.set(object, other);

      var skipCtor = isPartial;
      while (++index < objLength) {
        key = objProps[index];
        var objValue = object[key],
            othValue = other[key];

        if (customizer) {
          var compared = isPartial
            ? customizer(othValue, objValue, key, other, object, stack)
            : customizer(objValue, othValue, key, object, other, stack);
        }
        // Recursively compare objects (susceptible to call stack limits).
        if (!(compared === undefined
              ? (objValue === othValue || equalFunc(objValue, othValue, customizer, bitmask, stack))
              : compared
            )) {
          result = false;
          break;
        }
        skipCtor || (skipCtor = key == 'constructor');
      }
      if (result && !skipCtor) {
        var objCtor = object.constructor,
            othCtor = other.constructor;

        // Non `Object` object instances with different constructors are not equal.
        if (objCtor != othCtor &&
            ('constructor' in object && 'constructor' in other) &&
            !(typeof objCtor == 'function' && objCtor instanceof objCtor &&
              typeof othCtor == 'function' && othCtor instanceof othCtor)) {
          result = false;
        }
      }
      stack['delete'](object);
      return result;
    }

    /**
     * Creates an array of own enumerable property names and symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function getAllKeys(object) {
      return baseGetAllKeys(object, keys, getSymbols);
    }

    /**
     * Creates an array of own and inherited enumerable property names and
     * symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function getAllKeysIn(object) {
      return baseGetAllKeys(object, keysIn, getSymbolsIn);
    }

    /**
     * Gets metadata for `func`.
     *
     * @private
     * @param {Function} func The function to query.
     * @returns {*} Returns the metadata for `func`.
     */
    var getData = !metaMap ? noop : function(func) {
      return metaMap.get(func);
    };

    /**
     * Gets the name of `func`.
     *
     * @private
     * @param {Function} func The function to query.
     * @returns {string} Returns the function name.
     */
    function getFuncName(func) {
      var result = (func.name + ''),
          array = realNames[result],
          length = hasOwnProperty.call(realNames, result) ? array.length : 0;

      while (length--) {
        var data = array[length],
            otherFunc = data.func;
        if (otherFunc == null || otherFunc == func) {
          return data.name;
        }
      }
      return result;
    }

    /**
     * Gets the appropriate "iteratee" function. If `_.iteratee` is customized,
     * this function returns the custom method, otherwise it returns `baseIteratee`.
     * If arguments are provided, the chosen function is invoked with them and
     * its result is returned.
     *
     * @private
     * @param {*} [value] The value to convert to an iteratee.
     * @param {number} [arity] The arity of the created iteratee.
     * @returns {Function} Returns the chosen function or its result.
     */
    function getIteratee() {
      var result = lodash.iteratee || iteratee;
      result = result === iteratee ? baseIteratee : result;
      return arguments.length ? result(arguments[0], arguments[1]) : result;
    }

    /**
     * Gets the "length" property value of `object`.
     *
     * **Note:** This function is used to avoid a
     * [JIT bug](https://bugs.webkit.org/show_bug.cgi?id=142792) that affects
     * Safari on at least iOS 8.1-8.3 ARM64.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {*} Returns the "length" value.
     */
    var getLength = baseProperty('length');

    /**
     * Gets the property names, values, and compare flags of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the match data of `object`.
     */
    function getMatchData(object) {
      var result = toPairs(object),
          length = result.length;

      while (length--) {
        result[length][2] = isStrictComparable(result[length][1]);
      }
      return result;
    }

    /**
     * Gets the native function at `key` of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {string} key The key of the method to get.
     * @returns {*} Returns the function if it's native, else `undefined`.
     */
    function getNative(object, key) {
      var value = object[key];
      return isNative(value) ? value : undefined;
    }

    /**
     * Gets the argument placeholder value for `func`.
     *
     * @private
     * @param {Function} func The function to inspect.
     * @returns {*} Returns the placeholder value.
     */
    function getPlaceholder(func) {
      var object = hasOwnProperty.call(lodash, 'placeholder') ? lodash : func;
      return object.placeholder;
    }

    /**
     * Gets the `[[Prototype]]` of `value`.
     *
     * @private
     * @param {*} value The value to query.
     * @returns {null|Object} Returns the `[[Prototype]]`.
     */
    function getPrototype(value) {
      return nativeGetPrototype(Object(value));
    }

    /**
     * Creates an array of the own enumerable symbol properties of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of symbols.
     */
    function getSymbols(object) {
      // Coerce `object` to an object to avoid non-object errors in V8.
      // See https://bugs.chromium.org/p/v8/issues/detail?id=3443 for more details.
      return getOwnPropertySymbols(Object(object));
    }

    // Fallback for IE < 11.
    if (!getOwnPropertySymbols) {
      getSymbols = function() {
        return [];
      };
    }

    /**
     * Creates an array of the own and inherited enumerable symbol properties
     * of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of symbols.
     */
    var getSymbolsIn = !getOwnPropertySymbols ? getSymbols : function(object) {
      var result = [];
      while (object) {
        arrayPush(result, getSymbols(object));
        object = getPrototype(object);
      }
      return result;
    };

    /**
     * Gets the `toStringTag` of `value`.
     *
     * @private
     * @param {*} value The value to query.
     * @returns {string} Returns the `toStringTag`.
     */
    function getTag(value) {
      return objectToString.call(value);
    }

    // Fallback for data views, maps, sets, and weak maps in IE 11,
    // for data views in Edge, and promises in Node.js.
    if ((DataView && getTag(new DataView(new ArrayBuffer(1))) != dataViewTag) ||
        (Map && getTag(new Map) != mapTag) ||
        (Promise && getTag(Promise.resolve()) != promiseTag) ||
        (Set && getTag(new Set) != setTag) ||
        (WeakMap && getTag(new WeakMap) != weakMapTag)) {
      getTag = function(value) {
        var result = objectToString.call(value),
            Ctor = result == objectTag ? value.constructor : undefined,
            ctorString = Ctor ? toSource(Ctor) : undefined;

        if (ctorString) {
          switch (ctorString) {
            case dataViewCtorString: return dataViewTag;
            case mapCtorString: return mapTag;
            case promiseCtorString: return promiseTag;
            case setCtorString: return setTag;
            case weakMapCtorString: return weakMapTag;
          }
        }
        return result;
      };
    }

    /**
     * Gets the view, applying any `transforms` to the `start` and `end` positions.
     *
     * @private
     * @param {number} start The start of the view.
     * @param {number} end The end of the view.
     * @param {Array} transforms The transformations to apply to the view.
     * @returns {Object} Returns an object containing the `start` and `end`
     *  positions of the view.
     */
    function getView(start, end, transforms) {
      var index = -1,
          length = transforms.length;

      while (++index < length) {
        var data = transforms[index],
            size = data.size;

        switch (data.type) {
          case 'drop':      start += size; break;
          case 'dropRight': end -= size; break;
          case 'take':      end = nativeMin(end, start + size); break;
          case 'takeRight': start = nativeMax(start, end - size); break;
        }
      }
      return { 'start': start, 'end': end };
    }

    /**
     * Checks if `path` exists on `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array|string} path The path to check.
     * @param {Function} hasFunc The function to check properties.
     * @returns {boolean} Returns `true` if `path` exists, else `false`.
     */
    function hasPath(object, path, hasFunc) {
      path = isKey(path, object) ? [path] : castPath(path);

      var result,
          index = -1,
          length = path.length;

      while (++index < length) {
        var key = path[index];
        if (!(result = object != null && hasFunc(object, key))) {
          break;
        }
        object = object[key];
      }
      if (result) {
        return result;
      }
      var length = object ? object.length : 0;
      return !!length && isLength(length) && isIndex(key, length) &&
        (isArray(object) || isString(object) || isArguments(object));
    }

    /**
     * Initializes an array clone.
     *
     * @private
     * @param {Array} array The array to clone.
     * @returns {Array} Returns the initialized clone.
     */
    function initCloneArray(array) {
      var length = array.length,
          result = array.constructor(length);

      // Add properties assigned by `RegExp#exec`.
      if (length && typeof array[0] == 'string' && hasOwnProperty.call(array, 'index')) {
        result.index = array.index;
        result.input = array.input;
      }
      return result;
    }

    /**
     * Initializes an object clone.
     *
     * @private
     * @param {Object} object The object to clone.
     * @returns {Object} Returns the initialized clone.
     */
    function initCloneObject(object) {
      return (typeof object.constructor == 'function' && !isPrototype(object))
        ? baseCreate(getPrototype(object))
        : {};
    }

    /**
     * Initializes an object clone based on its `toStringTag`.
     *
     * **Note:** This function only supports cloning values with tags of
     * `Boolean`, `Date`, `Error`, `Number`, `RegExp`, or `String`.
     *
     * @private
     * @param {Object} object The object to clone.
     * @param {string} tag The `toStringTag` of the object to clone.
     * @param {Function} cloneFunc The function to clone values.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the initialized clone.
     */
    function initCloneByTag(object, tag, cloneFunc, isDeep) {
      var Ctor = object.constructor;
      switch (tag) {
        case arrayBufferTag:
          return cloneArrayBuffer(object);

        case boolTag:
        case dateTag:
          return new Ctor(+object);

        case dataViewTag:
          return cloneDataView(object, isDeep);

        case float32Tag: case float64Tag:
        case int8Tag: case int16Tag: case int32Tag:
        case uint8Tag: case uint8ClampedTag: case uint16Tag: case uint32Tag:
          return cloneTypedArray(object, isDeep);

        case mapTag:
          return cloneMap(object, isDeep, cloneFunc);

        case numberTag:
        case stringTag:
          return new Ctor(object);

        case regexpTag:
          return cloneRegExp(object);

        case setTag:
          return cloneSet(object, isDeep, cloneFunc);

        case symbolTag:
          return cloneSymbol(object);
      }
    }

    /**
     * Creates an array of index keys for `object` values of arrays,
     * `arguments` objects, and strings, otherwise `null` is returned.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array|null} Returns index keys, else `null`.
     */
    function indexKeys(object) {
      var length = object ? object.length : undefined;
      if (isLength(length) &&
          (isArray(object) || isString(object) || isArguments(object))) {
        return baseTimes(length, String);
      }
      return null;
    }

    /**
     * Checks if `value` is a flattenable `arguments` object or array.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is flattenable, else `false`.
     */
    function isFlattenable(value) {
      return isArrayLikeObject(value) && (isArray(value) || isArguments(value));
    }

    /**
     * Checks if `value` is a flattenable array and not a `_.matchesProperty`
     * iteratee shorthand.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is flattenable, else `false`.
     */
    function isFlattenableIteratee(value) {
      return isArray(value) && !(value.length == 2 && !isFunction(value[0]));
    }

    /**
     * Checks if the given arguments are from an iteratee call.
     *
     * @private
     * @param {*} value The potential iteratee value argument.
     * @param {*} index The potential iteratee index or key argument.
     * @param {*} object The potential iteratee object argument.
     * @returns {boolean} Returns `true` if the arguments are from an iteratee call,
     *  else `false`.
     */
    function isIterateeCall(value, index, object) {
      if (!isObject(object)) {
        return false;
      }
      var type = typeof index;
      if (type == 'number'
            ? (isArrayLike(object) && isIndex(index, object.length))
            : (type == 'string' && index in object)
          ) {
        return eq(object[index], value);
      }
      return false;
    }

    /**
     * Checks if `value` is a property name and not a property path.
     *
     * @private
     * @param {*} value The value to check.
     * @param {Object} [object] The object to query keys on.
     * @returns {boolean} Returns `true` if `value` is a property name, else `false`.
     */
    function isKey(value, object) {
      var type = typeof value;
      if (type == 'number' || type == 'symbol') {
        return true;
      }
      return !isArray(value) &&
        (isSymbol(value) || reIsPlainProp.test(value) || !reIsDeepProp.test(value) ||
          (object != null && value in Object(object)));
    }

    /**
     * Checks if `value` is suitable for use as unique object key.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is suitable, else `false`.
     */
    function isKeyable(value) {
      var type = typeof value;
      return type == 'number' || type == 'boolean' ||
        (type == 'string' && value != '__proto__') || value == null;
    }

    /**
     * Checks if `func` has a lazy counterpart.
     *
     * @private
     * @param {Function} func The function to check.
     * @returns {boolean} Returns `true` if `func` has a lazy counterpart,
     *  else `false`.
     */
    function isLaziable(func) {
      var funcName = getFuncName(func),
          other = lodash[funcName];

      if (typeof other != 'function' || !(funcName in LazyWrapper.prototype)) {
        return false;
      }
      if (func === other) {
        return true;
      }
      var data = getData(other);
      return !!data && func === data[0];
    }

    /**
     * Checks if `value` is likely a prototype object.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a prototype, else `false`.
     */
    function isPrototype(value) {
      var Ctor = value && value.constructor,
          proto = (typeof Ctor == 'function' && Ctor.prototype) || objectProto;

      return value === proto;
    }

    /**
     * Checks if `value` is suitable for strict equality comparisons, i.e. `===`.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` if suitable for strict
     *  equality comparisons, else `false`.
     */
    function isStrictComparable(value) {
      return value === value && !isObject(value);
    }

    /**
     * A specialized version of `matchesProperty` for source values suitable
     * for strict equality comparisons, i.e. `===`.
     *
     * @private
     * @param {string} key The key of the property to get.
     * @param {*} srcValue The value to match.
     * @returns {Function} Returns the new function.
     */
    function matchesStrictComparable(key, srcValue) {
      return function(object) {
        if (object == null) {
          return false;
        }
        return object[key] === srcValue &&
          (srcValue !== undefined || (key in Object(object)));
      };
    }

    /**
     * Merges the function metadata of `source` into `data`.
     *
     * Merging metadata reduces the number of wrappers used to invoke a function.
     * This is possible because methods like `_.bind`, `_.curry`, and `_.partial`
     * may be applied regardless of execution order. Methods like `_.ary` and
     * `_.rearg` modify function arguments, making the order in which they are
     * executed important, preventing the merging of metadata. However, we make
     * an exception for a safe combined case where curried functions have `_.ary`
     * and or `_.rearg` applied.
     *
     * @private
     * @param {Array} data The destination metadata.
     * @param {Array} source The source metadata.
     * @returns {Array} Returns `data`.
     */
    function mergeData(data, source) {
      var bitmask = data[1],
          srcBitmask = source[1],
          newBitmask = bitmask | srcBitmask,
          isCommon = newBitmask < (BIND_FLAG | BIND_KEY_FLAG | ARY_FLAG);

      var isCombo =
        ((srcBitmask == ARY_FLAG) && (bitmask == CURRY_FLAG)) ||
        ((srcBitmask == ARY_FLAG) && (bitmask == REARG_FLAG) && (data[7].length <= source[8])) ||
        ((srcBitmask == (ARY_FLAG | REARG_FLAG)) && (source[7].length <= source[8]) && (bitmask == CURRY_FLAG));

      // Exit early if metadata can't be merged.
      if (!(isCommon || isCombo)) {
        return data;
      }
      // Use source `thisArg` if available.
      if (srcBitmask & BIND_FLAG) {
        data[2] = source[2];
        // Set when currying a bound function.
        newBitmask |= bitmask & BIND_FLAG ? 0 : CURRY_BOUND_FLAG;
      }
      // Compose partial arguments.
      var value = source[3];
      if (value) {
        var partials = data[3];
        data[3] = partials ? composeArgs(partials, value, source[4]) : value;
        data[4] = partials ? replaceHolders(data[3], PLACEHOLDER) : source[4];
      }
      // Compose partial right arguments.
      value = source[5];
      if (value) {
        partials = data[5];
        data[5] = partials ? composeArgsRight(partials, value, source[6]) : value;
        data[6] = partials ? replaceHolders(data[5], PLACEHOLDER) : source[6];
      }
      // Use source `argPos` if available.
      value = source[7];
      if (value) {
        data[7] = value;
      }
      // Use source `ary` if it's smaller.
      if (srcBitmask & ARY_FLAG) {
        data[8] = data[8] == null ? source[8] : nativeMin(data[8], source[8]);
      }
      // Use source `arity` if one is not provided.
      if (data[9] == null) {
        data[9] = source[9];
      }
      // Use source `func` and merge bitmasks.
      data[0] = source[0];
      data[1] = newBitmask;

      return data;
    }

    /**
     * Used by `_.defaultsDeep` to customize its `_.merge` use.
     *
     * @private
     * @param {*} objValue The destination value.
     * @param {*} srcValue The source value.
     * @param {string} key The key of the property to merge.
     * @param {Object} object The parent object of `objValue`.
     * @param {Object} source The parent object of `srcValue`.
     * @param {Object} [stack] Tracks traversed source values and their merged
     *  counterparts.
     * @returns {*} Returns the value to assign.
     */
    function mergeDefaults(objValue, srcValue, key, object, source, stack) {
      if (isObject(objValue) && isObject(srcValue)) {
        baseMerge(objValue, srcValue, undefined, mergeDefaults, stack.set(srcValue, objValue));
      }
      return objValue;
    }

    /**
     * Gets the parent value at `path` of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Array} path The path to get the parent value of.
     * @returns {*} Returns the parent value.
     */
    function parent(object, path) {
      return path.length == 1 ? object : baseGet(object, baseSlice(path, 0, -1));
    }

    /**
     * Reorder `array` according to the specified indexes where the element at
     * the first index is assigned as the first element, the element at
     * the second index is assigned as the second element, and so on.
     *
     * @private
     * @param {Array} array The array to reorder.
     * @param {Array} indexes The arranged array indexes.
     * @returns {Array} Returns `array`.
     */
    function reorder(array, indexes) {
      var arrLength = array.length,
          length = nativeMin(indexes.length, arrLength),
          oldArray = copyArray(array);

      while (length--) {
        var index = indexes[length];
        array[length] = isIndex(index, arrLength) ? oldArray[index] : undefined;
      }
      return array;
    }

    /**
     * Sets metadata for `func`.
     *
     * **Note:** If this function becomes hot, i.e. is invoked a lot in a short
     * period of time, it will trip its breaker and transition to an identity
     * function to avoid garbage collection pauses in V8. See
     * [V8 issue 2070](https://bugs.chromium.org/p/v8/issues/detail?id=2070)
     * for more details.
     *
     * @private
     * @param {Function} func The function to associate metadata with.
     * @param {*} data The metadata.
     * @returns {Function} Returns `func`.
     */
    var setData = (function() {
      var count = 0,
          lastCalled = 0;

      return function(key, value) {
        var stamp = now(),
            remaining = HOT_SPAN - (stamp - lastCalled);

        lastCalled = stamp;
        if (remaining > 0) {
          if (++count >= HOT_COUNT) {
            return key;
          }
        } else {
          count = 0;
        }
        return baseSetData(key, value);
      };
    }());

    /**
     * Converts `string` to a property path array.
     *
     * @private
     * @param {string} string The string to convert.
     * @returns {Array} Returns the property path array.
     */
    var stringToPath = memoize(function(string) {
      var result = [];
      toString(string).replace(rePropName, function(match, number, quote, string) {
        result.push(quote ? string.replace(reEscapeChar, '$1') : (number || match));
      });
      return result;
    });

    /**
     * Converts `value` to a string key if it's not a string or symbol.
     *
     * @private
     * @param {*} value The value to inspect.
     * @returns {string|symbol} Returns the key.
     */
    function toKey(key) {
      return (typeof key == 'string' || isSymbol(key)) ? key : (key + '');
    }

    /**
     * Converts `func` to its source code.
     *
     * @private
     * @param {Function} func The function to process.
     * @returns {string} Returns the source code.
     */
    function toSource(func) {
      if (func != null) {
        try {
          return funcToString.call(func);
        } catch (e) {}
        try {
          return (func + '');
        } catch (e) {}
      }
      return '';
    }

    /**
     * Creates a clone of `wrapper`.
     *
     * @private
     * @param {Object} wrapper The wrapper to clone.
     * @returns {Object} Returns the cloned wrapper.
     */
    function wrapperClone(wrapper) {
      if (wrapper instanceof LazyWrapper) {
        return wrapper.clone();
      }
      var result = new LodashWrapper(wrapper.__wrapped__, wrapper.__chain__);
      result.__actions__ = copyArray(wrapper.__actions__);
      result.__index__  = wrapper.__index__;
      result.__values__ = wrapper.__values__;
      return result;
    }

    /*------------------------------------------------------------------------*/

    /**
     * Creates an array of elements split into groups the length of `size`.
     * If `array` can't be split evenly, the final chunk will be the remaining
     * elements.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to process.
     * @param {number} [size=1] The length of each chunk
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the new array containing chunks.
     * @example
     *
     * _.chunk(['a', 'b', 'c', 'd'], 2);
     * // => [['a', 'b'], ['c', 'd']]
     *
     * _.chunk(['a', 'b', 'c', 'd'], 3);
     * // => [['a', 'b', 'c'], ['d']]
     */
    function chunk(array, size, guard) {
      if ((guard ? isIterateeCall(array, size, guard) : size === undefined)) {
        size = 1;
      } else {
        size = nativeMax(toInteger(size), 0);
      }
      var length = array ? array.length : 0;
      if (!length || size < 1) {
        return [];
      }
      var index = 0,
          resIndex = 0,
          result = Array(nativeCeil(length / size));

      while (index < length) {
        result[resIndex++] = baseSlice(array, index, (index += size));
      }
      return result;
    }

    /**
     * Creates an array with all falsey values removed. The values `false`, `null`,
     * `0`, `""`, `undefined`, and `NaN` are falsey.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to compact.
     * @returns {Array} Returns the new array of filtered values.
     * @example
     *
     * _.compact([0, 1, false, 2, '', 3]);
     * // => [1, 2, 3]
     */
    function compact(array) {
      var index = -1,
          length = array ? array.length : 0,
          resIndex = 0,
          result = [];

      while (++index < length) {
        var value = array[index];
        if (value) {
          result[resIndex++] = value;
        }
      }
      return result;
    }

    /**
     * Creates a new array concatenating `array` with any additional arrays
     * and/or values.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to concatenate.
     * @param {...*} [values] The values to concatenate.
     * @returns {Array} Returns the new concatenated array.
     * @example
     *
     * var array = [1];
     * var other = _.concat(array, 2, [3], [[4]]);
     *
     * console.log(other);
     * // => [1, 2, 3, [4]]
     *
     * console.log(array);
     * // => [1]
     */
    function concat() {
      var length = arguments.length,
          array = castArray(arguments[0]);

      if (length < 2) {
        return length ? copyArray(array) : [];
      }
      var args = Array(length - 1);
      while (length--) {
        args[length - 1] = arguments[length];
      }
      return arrayConcat(array, baseFlatten(args, 1));
    }

    /**
     * Creates an array of unique `array` values not included in the other given
     * arrays using [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons. The order of result values is determined by the
     * order they occur in the first array.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {...Array} [values] The values to exclude.
     * @returns {Array} Returns the new array of filtered values.
     * @example
     *
     * _.difference([3, 2, 1], [4, 2]);
     * // => [3, 1]
     */
    var difference = rest(function(array, values) {
      return isArrayLikeObject(array)
        ? baseDifference(array, baseFlatten(values, 1, isArrayLikeObject, true))
        : [];
    });

    /**
     * This method is like `_.difference` except that it accepts `iteratee` which
     * is invoked for each element of `array` and `values` to generate the criterion
     * by which they're compared. Result values are chosen from the first array.
     * The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {...Array} [values] The values to exclude.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns the new array of filtered values.
     * @example
     *
     * _.differenceBy([3.1, 2.2, 1.3], [4.4, 2.5], Math.floor);
     * // => [3.1, 1.3]
     *
     * // The `_.property` iteratee shorthand.
     * _.differenceBy([{ 'x': 2 }, { 'x': 1 }], [{ 'x': 1 }], 'x');
     * // => [{ 'x': 2 }]
     */
    var differenceBy = rest(function(array, values) {
      var iteratee = last(values);
      if (isArrayLikeObject(iteratee)) {
        iteratee = undefined;
      }
      return isArrayLikeObject(array)
        ? baseDifference(array, baseFlatten(values, 1, isArrayLikeObject, true), getIteratee(iteratee))
        : [];
    });

    /**
     * This method is like `_.difference` except that it accepts `comparator`
     * which is invoked to compare elements of `array` to `values`. Result values
     * are chosen from the first array. The comparator is invoked with two arguments:
     * (arrVal, othVal).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {...Array} [values] The values to exclude.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of filtered values.
     * @example
     *
     * var objects = [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }];
     *
     * _.differenceWith(objects, [{ 'x': 1, 'y': 2 }], _.isEqual);
     * // => [{ 'x': 2, 'y': 1 }]
     */
    var differenceWith = rest(function(array, values) {
      var comparator = last(values);
      if (isArrayLikeObject(comparator)) {
        comparator = undefined;
      }
      return isArrayLikeObject(array)
        ? baseDifference(array, baseFlatten(values, 1, isArrayLikeObject, true), undefined, comparator)
        : [];
    });

    /**
     * Creates a slice of `array` with `n` elements dropped from the beginning.
     *
     * @static
     * @memberOf _
     * @since 0.5.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {number} [n=1] The number of elements to drop.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.drop([1, 2, 3]);
     * // => [2, 3]
     *
     * _.drop([1, 2, 3], 2);
     * // => [3]
     *
     * _.drop([1, 2, 3], 5);
     * // => []
     *
     * _.drop([1, 2, 3], 0);
     * // => [1, 2, 3]
     */
    function drop(array, n, guard) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      n = (guard || n === undefined) ? 1 : toInteger(n);
      return baseSlice(array, n < 0 ? 0 : n, length);
    }

    /**
     * Creates a slice of `array` with `n` elements dropped from the end.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {number} [n=1] The number of elements to drop.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.dropRight([1, 2, 3]);
     * // => [1, 2]
     *
     * _.dropRight([1, 2, 3], 2);
     * // => [1]
     *
     * _.dropRight([1, 2, 3], 5);
     * // => []
     *
     * _.dropRight([1, 2, 3], 0);
     * // => [1, 2, 3]
     */
    function dropRight(array, n, guard) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      n = (guard || n === undefined) ? 1 : toInteger(n);
      n = length - n;
      return baseSlice(array, 0, n < 0 ? 0 : n);
    }

    /**
     * Creates a slice of `array` excluding elements dropped from the end.
     * Elements are dropped until `predicate` returns falsey. The predicate is
     * invoked with three arguments: (value, index, array).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': true },
     *   { 'user': 'fred',    'active': false },
     *   { 'user': 'pebbles', 'active': false }
     * ];
     *
     * _.dropRightWhile(users, function(o) { return !o.active; });
     * // => objects for ['barney']
     *
     * // The `_.matches` iteratee shorthand.
     * _.dropRightWhile(users, { 'user': 'pebbles', 'active': false });
     * // => objects for ['barney', 'fred']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.dropRightWhile(users, ['active', false]);
     * // => objects for ['barney']
     *
     * // The `_.property` iteratee shorthand.
     * _.dropRightWhile(users, 'active');
     * // => objects for ['barney', 'fred', 'pebbles']
     */
    function dropRightWhile(array, predicate) {
      return (array && array.length)
        ? baseWhile(array, getIteratee(predicate, 3), true, true)
        : [];
    }

    /**
     * Creates a slice of `array` excluding elements dropped from the beginning.
     * Elements are dropped until `predicate` returns falsey. The predicate is
     * invoked with three arguments: (value, index, array).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': false },
     *   { 'user': 'fred',    'active': false },
     *   { 'user': 'pebbles', 'active': true }
     * ];
     *
     * _.dropWhile(users, function(o) { return !o.active; });
     * // => objects for ['pebbles']
     *
     * // The `_.matches` iteratee shorthand.
     * _.dropWhile(users, { 'user': 'barney', 'active': false });
     * // => objects for ['fred', 'pebbles']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.dropWhile(users, ['active', false]);
     * // => objects for ['pebbles']
     *
     * // The `_.property` iteratee shorthand.
     * _.dropWhile(users, 'active');
     * // => objects for ['barney', 'fred', 'pebbles']
     */
    function dropWhile(array, predicate) {
      return (array && array.length)
        ? baseWhile(array, getIteratee(predicate, 3), true)
        : [];
    }

    /**
     * Fills elements of `array` with `value` from `start` up to, but not
     * including, `end`.
     *
     * **Note:** This method mutates `array`.
     *
     * @static
     * @memberOf _
     * @since 3.2.0
     * @category Array
     * @param {Array} array The array to fill.
     * @param {*} value The value to fill `array` with.
     * @param {number} [start=0] The start position.
     * @param {number} [end=array.length] The end position.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [1, 2, 3];
     *
     * _.fill(array, 'a');
     * console.log(array);
     * // => ['a', 'a', 'a']
     *
     * _.fill(Array(3), 2);
     * // => [2, 2, 2]
     *
     * _.fill([4, 6, 8, 10], '*', 1, 3);
     * // => [4, '*', '*', 10]
     */
    function fill(array, value, start, end) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      if (start && typeof start != 'number' && isIterateeCall(array, value, start)) {
        start = 0;
        end = length;
      }
      return baseFill(array, value, start, end);
    }

    /**
     * This method is like `_.find` except that it returns the index of the first
     * element `predicate` returns truthy for instead of the element itself.
     *
     * @static
     * @memberOf _
     * @since 1.1.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {number} Returns the index of the found element, else `-1`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': false },
     *   { 'user': 'fred',    'active': false },
     *   { 'user': 'pebbles', 'active': true }
     * ];
     *
     * _.findIndex(users, function(o) { return o.user == 'barney'; });
     * // => 0
     *
     * // The `_.matches` iteratee shorthand.
     * _.findIndex(users, { 'user': 'fred', 'active': false });
     * // => 1
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.findIndex(users, ['active', false]);
     * // => 0
     *
     * // The `_.property` iteratee shorthand.
     * _.findIndex(users, 'active');
     * // => 2
     */
    function findIndex(array, predicate) {
      return (array && array.length)
        ? baseFindIndex(array, getIteratee(predicate, 3))
        : -1;
    }

    /**
     * This method is like `_.findIndex` except that it iterates over elements
     * of `collection` from right to left.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {number} Returns the index of the found element, else `-1`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': true },
     *   { 'user': 'fred',    'active': false },
     *   { 'user': 'pebbles', 'active': false }
     * ];
     *
     * _.findLastIndex(users, function(o) { return o.user == 'pebbles'; });
     * // => 2
     *
     * // The `_.matches` iteratee shorthand.
     * _.findLastIndex(users, { 'user': 'barney', 'active': true });
     * // => 0
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.findLastIndex(users, ['active', false]);
     * // => 2
     *
     * // The `_.property` iteratee shorthand.
     * _.findLastIndex(users, 'active');
     * // => 0
     */
    function findLastIndex(array, predicate) {
      return (array && array.length)
        ? baseFindIndex(array, getIteratee(predicate, 3), true)
        : -1;
    }

    /**
     * Flattens `array` a single level deep.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to flatten.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * _.flatten([1, [2, [3, [4]], 5]]);
     * // => [1, 2, [3, [4]], 5]
     */
    function flatten(array) {
      var length = array ? array.length : 0;
      return length ? baseFlatten(array, 1) : [];
    }

    /**
     * Recursively flattens `array`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to flatten.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * _.flattenDeep([1, [2, [3, [4]], 5]]);
     * // => [1, 2, 3, 4, 5]
     */
    function flattenDeep(array) {
      var length = array ? array.length : 0;
      return length ? baseFlatten(array, INFINITY) : [];
    }

    /**
     * Recursively flatten `array` up to `depth` times.
     *
     * @static
     * @memberOf _
     * @since 4.4.0
     * @category Array
     * @param {Array} array The array to flatten.
     * @param {number} [depth=1] The maximum recursion depth.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * var array = [1, [2, [3, [4]], 5]];
     *
     * _.flattenDepth(array, 1);
     * // => [1, 2, [3, [4]], 5]
     *
     * _.flattenDepth(array, 2);
     * // => [1, 2, 3, [4], 5]
     */
    function flattenDepth(array, depth) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      depth = depth === undefined ? 1 : toInteger(depth);
      return baseFlatten(array, depth);
    }

    /**
     * The inverse of `_.toPairs`; this method returns an object composed
     * from key-value `pairs`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} pairs The key-value pairs.
     * @returns {Object} Returns the new object.
     * @example
     *
     * _.fromPairs([['fred', 30], ['barney', 40]]);
     * // => { 'fred': 30, 'barney': 40 }
     */
    function fromPairs(pairs) {
      var index = -1,
          length = pairs ? pairs.length : 0,
          result = {};

      while (++index < length) {
        var pair = pairs[index];
        result[pair[0]] = pair[1];
      }
      return result;
    }

    /**
     * Gets the first element of `array`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @alias first
     * @category Array
     * @param {Array} array The array to query.
     * @returns {*} Returns the first element of `array`.
     * @example
     *
     * _.head([1, 2, 3]);
     * // => 1
     *
     * _.head([]);
     * // => undefined
     */
    function head(array) {
      return (array && array.length) ? array[0] : undefined;
    }

    /**
     * Gets the index at which the first occurrence of `value` is found in `array`
     * using [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons. If `fromIndex` is negative, it's used as the
     * offset from the end of `array`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {*} value The value to search for.
     * @param {number} [fromIndex=0] The index to search from.
     * @returns {number} Returns the index of the matched value, else `-1`.
     * @example
     *
     * _.indexOf([1, 2, 1, 2], 2);
     * // => 1
     *
     * // Search from the `fromIndex`.
     * _.indexOf([1, 2, 1, 2], 2, 2);
     * // => 3
     */
    function indexOf(array, value, fromIndex) {
      var length = array ? array.length : 0;
      if (!length) {
        return -1;
      }
      fromIndex = toInteger(fromIndex);
      if (fromIndex < 0) {
        fromIndex = nativeMax(length + fromIndex, 0);
      }
      return baseIndexOf(array, value, fromIndex);
    }

    /**
     * Gets all but the last element of `array`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to query.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.initial([1, 2, 3]);
     * // => [1, 2]
     */
    function initial(array) {
      return dropRight(array, 1);
    }

    /**
     * Creates an array of unique values that are included in all given arrays
     * using [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons. The order of result values is determined by the
     * order they occur in the first array.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @returns {Array} Returns the new array of intersecting values.
     * @example
     *
     * _.intersection([2, 1], [4, 2], [1, 2]);
     * // => [2]
     */
    var intersection = rest(function(arrays) {
      var mapped = arrayMap(arrays, castArrayLikeObject);
      return (mapped.length && mapped[0] === arrays[0])
        ? baseIntersection(mapped)
        : [];
    });

    /**
     * This method is like `_.intersection` except that it accepts `iteratee`
     * which is invoked for each element of each `arrays` to generate the criterion
     * by which they're compared. Result values are chosen from the first array.
     * The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns the new array of intersecting values.
     * @example
     *
     * _.intersectionBy([2.1, 1.2], [4.3, 2.4], Math.floor);
     * // => [2.1]
     *
     * // The `_.property` iteratee shorthand.
     * _.intersectionBy([{ 'x': 1 }], [{ 'x': 2 }, { 'x': 1 }], 'x');
     * // => [{ 'x': 1 }]
     */
    var intersectionBy = rest(function(arrays) {
      var iteratee = last(arrays),
          mapped = arrayMap(arrays, castArrayLikeObject);

      if (iteratee === last(mapped)) {
        iteratee = undefined;
      } else {
        mapped.pop();
      }
      return (mapped.length && mapped[0] === arrays[0])
        ? baseIntersection(mapped, getIteratee(iteratee))
        : [];
    });

    /**
     * This method is like `_.intersection` except that it accepts `comparator`
     * which is invoked to compare elements of `arrays`. Result values are chosen
     * from the first array. The comparator is invoked with two arguments:
     * (arrVal, othVal).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of intersecting values.
     * @example
     *
     * var objects = [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }];
     * var others = [{ 'x': 1, 'y': 1 }, { 'x': 1, 'y': 2 }];
     *
     * _.intersectionWith(objects, others, _.isEqual);
     * // => [{ 'x': 1, 'y': 2 }]
     */
    var intersectionWith = rest(function(arrays) {
      var comparator = last(arrays),
          mapped = arrayMap(arrays, castArrayLikeObject);

      if (comparator === last(mapped)) {
        comparator = undefined;
      } else {
        mapped.pop();
      }
      return (mapped.length && mapped[0] === arrays[0])
        ? baseIntersection(mapped, undefined, comparator)
        : [];
    });

    /**
     * Converts all elements in `array` into a string separated by `separator`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to convert.
     * @param {string} [separator=','] The element separator.
     * @returns {string} Returns the joined string.
     * @example
     *
     * _.join(['a', 'b', 'c'], '~');
     * // => 'a~b~c'
     */
    function join(array, separator) {
      return array ? nativeJoin.call(array, separator) : '';
    }

    /**
     * Gets the last element of `array`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to query.
     * @returns {*} Returns the last element of `array`.
     * @example
     *
     * _.last([1, 2, 3]);
     * // => 3
     */
    function last(array) {
      var length = array ? array.length : 0;
      return length ? array[length - 1] : undefined;
    }

    /**
     * This method is like `_.indexOf` except that it iterates over elements of
     * `array` from right to left.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {*} value The value to search for.
     * @param {number} [fromIndex=array.length-1] The index to search from.
     * @returns {number} Returns the index of the matched value, else `-1`.
     * @example
     *
     * _.lastIndexOf([1, 2, 1, 2], 2);
     * // => 3
     *
     * // Search from the `fromIndex`.
     * _.lastIndexOf([1, 2, 1, 2], 2, 2);
     * // => 1
     */
    function lastIndexOf(array, value, fromIndex) {
      var length = array ? array.length : 0;
      if (!length) {
        return -1;
      }
      var index = length;
      if (fromIndex !== undefined) {
        index = toInteger(fromIndex);
        index = (
          index < 0
            ? nativeMax(length + index, 0)
            : nativeMin(index, length - 1)
        ) + 1;
      }
      if (value !== value) {
        return indexOfNaN(array, index, true);
      }
      while (index--) {
        if (array[index] === value) {
          return index;
        }
      }
      return -1;
    }

    /**
     * Gets the nth element of `array`. If `n` is negative, the nth element
     * from the end is returned.
     *
     * @static
     * @memberOf _
     * @since 4.11.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {number} [n=0] The index of the element to return.
     * @returns {*} Returns the nth element of `array`.
     * @example
     *
     * var array = ['a', 'b', 'c', 'd'];
     *
     * _.nth(array, 1);
     * // => 'b'
     *
     * _.nth(array, -2);
     * // => 'c';
     */
    function nth(array, n) {
      return (array && array.length) ? baseNth(array, toInteger(n)) : undefined;
    }

    /**
     * Removes all given values from `array` using
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons.
     *
     * **Note:** Unlike `_.without`, this method mutates `array`. Use `_.remove`
     * to remove elements from an array by predicate.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {...*} [values] The values to remove.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [1, 2, 3, 1, 2, 3];
     *
     * _.pull(array, 2, 3);
     * console.log(array);
     * // => [1, 1]
     */
    var pull = rest(pullAll);

    /**
     * This method is like `_.pull` except that it accepts an array of values to remove.
     *
     * **Note:** Unlike `_.difference`, this method mutates `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {Array} values The values to remove.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [1, 2, 3, 1, 2, 3];
     *
     * _.pullAll(array, [2, 3]);
     * console.log(array);
     * // => [1, 1]
     */
    function pullAll(array, values) {
      return (array && array.length && values && values.length)
        ? basePullAll(array, values)
        : array;
    }

    /**
     * This method is like `_.pullAll` except that it accepts `iteratee` which is
     * invoked for each element of `array` and `values` to generate the criterion
     * by which they're compared. The iteratee is invoked with one argument: (value).
     *
     * **Note:** Unlike `_.differenceBy`, this method mutates `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {Array} values The values to remove.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [{ 'x': 1 }, { 'x': 2 }, { 'x': 3 }, { 'x': 1 }];
     *
     * _.pullAllBy(array, [{ 'x': 1 }, { 'x': 3 }], 'x');
     * console.log(array);
     * // => [{ 'x': 2 }]
     */
    function pullAllBy(array, values, iteratee) {
      return (array && array.length && values && values.length)
        ? basePullAll(array, values, getIteratee(iteratee))
        : array;
    }

    /**
     * This method is like `_.pullAll` except that it accepts `comparator` which
     * is invoked to compare elements of `array` to `values`. The comparator is
     * invoked with two arguments: (arrVal, othVal).
     *
     * **Note:** Unlike `_.differenceWith`, this method mutates `array`.
     *
     * @static
     * @memberOf _
     * @since 4.6.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {Array} values The values to remove.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [{ 'x': 1, 'y': 2 }, { 'x': 3, 'y': 4 }, { 'x': 5, 'y': 6 }];
     *
     * _.pullAllWith(array, [{ 'x': 3, 'y': 4 }], _.isEqual);
     * console.log(array);
     * // => [{ 'x': 1, 'y': 2 }, { 'x': 5, 'y': 6 }]
     */
    function pullAllWith(array, values, comparator) {
      return (array && array.length && values && values.length)
        ? basePullAll(array, values, undefined, comparator)
        : array;
    }

    /**
     * Removes elements from `array` corresponding to `indexes` and returns an
     * array of removed elements.
     *
     * **Note:** Unlike `_.at`, this method mutates `array`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {...(number|number[])} [indexes] The indexes of elements to remove.
     * @returns {Array} Returns the new array of removed elements.
     * @example
     *
     * var array = [5, 10, 15, 20];
     * var evens = _.pullAt(array, 1, 3);
     *
     * console.log(array);
     * // => [5, 15]
     *
     * console.log(evens);
     * // => [10, 20]
     */
    var pullAt = rest(function(array, indexes) {
      indexes = arrayMap(baseFlatten(indexes, 1), String);

      var result = baseAt(array, indexes);
      basePullAt(array, indexes.sort(compareAscending));
      return result;
    });

    /**
     * Removes all elements from `array` that `predicate` returns truthy for
     * and returns an array of the removed elements. The predicate is invoked
     * with three arguments: (value, index, array).
     *
     * **Note:** Unlike `_.filter`, this method mutates `array`. Use `_.pull`
     * to pull elements from an array by value.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new array of removed elements.
     * @example
     *
     * var array = [1, 2, 3, 4];
     * var evens = _.remove(array, function(n) {
     *   return n % 2 == 0;
     * });
     *
     * console.log(array);
     * // => [1, 3]
     *
     * console.log(evens);
     * // => [2, 4]
     */
    function remove(array, predicate) {
      var result = [];
      if (!(array && array.length)) {
        return result;
      }
      var index = -1,
          indexes = [],
          length = array.length;

      predicate = getIteratee(predicate, 3);
      while (++index < length) {
        var value = array[index];
        if (predicate(value, index, array)) {
          result.push(value);
          indexes.push(index);
        }
      }
      basePullAt(array, indexes);
      return result;
    }

    /**
     * Reverses `array` so that the first element becomes the last, the second
     * element becomes the second to last, and so on.
     *
     * **Note:** This method mutates `array` and is based on
     * [`Array#reverse`](https://mdn.io/Array/reverse).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to modify.
     * @returns {Array} Returns `array`.
     * @example
     *
     * var array = [1, 2, 3];
     *
     * _.reverse(array);
     * // => [3, 2, 1]
     *
     * console.log(array);
     * // => [3, 2, 1]
     */
    function reverse(array) {
      return array ? nativeReverse.call(array) : array;
    }

    /**
     * Creates a slice of `array` from `start` up to, but not including, `end`.
     *
     * **Note:** This method is used instead of
     * [`Array#slice`](https://mdn.io/Array/slice) to ensure dense arrays are
     * returned.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to slice.
     * @param {number} [start=0] The start position.
     * @param {number} [end=array.length] The end position.
     * @returns {Array} Returns the slice of `array`.
     */
    function slice(array, start, end) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      if (end && typeof end != 'number' && isIterateeCall(array, start, end)) {
        start = 0;
        end = length;
      }
      else {
        start = start == null ? 0 : toInteger(start);
        end = end === undefined ? length : toInteger(end);
      }
      return baseSlice(array, start, end);
    }

    /**
     * Uses a binary search to determine the lowest index at which `value`
     * should be inserted into `array` in order to maintain its sort order.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     * @example
     *
     * _.sortedIndex([30, 50], 40);
     * // => 1
     *
     * _.sortedIndex([4, 5], 4);
     * // => 0
     */
    function sortedIndex(array, value) {
      return baseSortedIndex(array, value);
    }

    /**
     * This method is like `_.sortedIndex` except that it accepts `iteratee`
     * which is invoked for `value` and each element of `array` to compute their
     * sort ranking. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     * @example
     *
     * var dict = { 'thirty': 30, 'forty': 40, 'fifty': 50 };
     *
     * _.sortedIndexBy(['thirty', 'fifty'], 'forty', _.propertyOf(dict));
     * // => 1
     *
     * // The `_.property` iteratee shorthand.
     * _.sortedIndexBy([{ 'x': 4 }, { 'x': 5 }], { 'x': 4 }, 'x');
     * // => 0
     */
    function sortedIndexBy(array, value, iteratee) {
      return baseSortedIndexBy(array, value, getIteratee(iteratee));
    }

    /**
     * This method is like `_.indexOf` except that it performs a binary
     * search on a sorted `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {*} value The value to search for.
     * @returns {number} Returns the index of the matched value, else `-1`.
     * @example
     *
     * _.sortedIndexOf([1, 1, 2, 2], 2);
     * // => 2
     */
    function sortedIndexOf(array, value) {
      var length = array ? array.length : 0;
      if (length) {
        var index = baseSortedIndex(array, value);
        if (index < length && eq(array[index], value)) {
          return index;
        }
      }
      return -1;
    }

    /**
     * This method is like `_.sortedIndex` except that it returns the highest
     * index at which `value` should be inserted into `array` in order to
     * maintain its sort order.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     * @example
     *
     * _.sortedLastIndex([4, 5], 4);
     * // => 1
     */
    function sortedLastIndex(array, value) {
      return baseSortedIndex(array, value, true);
    }

    /**
     * This method is like `_.sortedLastIndex` except that it accepts `iteratee`
     * which is invoked for `value` and each element of `array` to compute their
     * sort ranking. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The sorted array to inspect.
     * @param {*} value The value to evaluate.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {number} Returns the index at which `value` should be inserted
     *  into `array`.
     * @example
     *
     * // The `_.property` iteratee shorthand.
     * _.sortedLastIndexBy([{ 'x': 4 }, { 'x': 5 }], { 'x': 4 }, 'x');
     * // => 1
     */
    function sortedLastIndexBy(array, value, iteratee) {
      return baseSortedIndexBy(array, value, getIteratee(iteratee), true);
    }

    /**
     * This method is like `_.lastIndexOf` except that it performs a binary
     * search on a sorted `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to search.
     * @param {*} value The value to search for.
     * @returns {number} Returns the index of the matched value, else `-1`.
     * @example
     *
     * _.sortedLastIndexOf([1, 1, 2, 2], 2);
     * // => 3
     */
    function sortedLastIndexOf(array, value) {
      var length = array ? array.length : 0;
      if (length) {
        var index = baseSortedIndex(array, value, true) - 1;
        if (eq(array[index], value)) {
          return index;
        }
      }
      return -1;
    }

    /**
     * This method is like `_.uniq` except that it's designed and optimized
     * for sorted arrays.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @returns {Array} Returns the new duplicate free array.
     * @example
     *
     * _.sortedUniq([1, 1, 2]);
     * // => [1, 2]
     */
    function sortedUniq(array) {
      return (array && array.length)
        ? baseSortedUniq(array)
        : [];
    }

    /**
     * This method is like `_.uniqBy` except that it's designed and optimized
     * for sorted arrays.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {Function} [iteratee] The iteratee invoked per element.
     * @returns {Array} Returns the new duplicate free array.
     * @example
     *
     * _.sortedUniqBy([1.1, 1.2, 2.3, 2.4], Math.floor);
     * // => [1.1, 2.3]
     */
    function sortedUniqBy(array, iteratee) {
      return (array && array.length)
        ? baseSortedUniqBy(array, getIteratee(iteratee))
        : [];
    }

    /**
     * Gets all but the first element of `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.tail([1, 2, 3]);
     * // => [2, 3]
     */
    function tail(array) {
      return drop(array, 1);
    }

    /**
     * Creates a slice of `array` with `n` elements taken from the beginning.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {number} [n=1] The number of elements to take.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.take([1, 2, 3]);
     * // => [1]
     *
     * _.take([1, 2, 3], 2);
     * // => [1, 2]
     *
     * _.take([1, 2, 3], 5);
     * // => [1, 2, 3]
     *
     * _.take([1, 2, 3], 0);
     * // => []
     */
    function take(array, n, guard) {
      if (!(array && array.length)) {
        return [];
      }
      n = (guard || n === undefined) ? 1 : toInteger(n);
      return baseSlice(array, 0, n < 0 ? 0 : n);
    }

    /**
     * Creates a slice of `array` with `n` elements taken from the end.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {number} [n=1] The number of elements to take.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * _.takeRight([1, 2, 3]);
     * // => [3]
     *
     * _.takeRight([1, 2, 3], 2);
     * // => [2, 3]
     *
     * _.takeRight([1, 2, 3], 5);
     * // => [1, 2, 3]
     *
     * _.takeRight([1, 2, 3], 0);
     * // => []
     */
    function takeRight(array, n, guard) {
      var length = array ? array.length : 0;
      if (!length) {
        return [];
      }
      n = (guard || n === undefined) ? 1 : toInteger(n);
      n = length - n;
      return baseSlice(array, n < 0 ? 0 : n, length);
    }

    /**
     * Creates a slice of `array` with elements taken from the end. Elements are
     * taken until `predicate` returns falsey. The predicate is invoked with
     * three arguments: (value, index, array).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': true },
     *   { 'user': 'fred',    'active': false },
     *   { 'user': 'pebbles', 'active': false }
     * ];
     *
     * _.takeRightWhile(users, function(o) { return !o.active; });
     * // => objects for ['fred', 'pebbles']
     *
     * // The `_.matches` iteratee shorthand.
     * _.takeRightWhile(users, { 'user': 'pebbles', 'active': false });
     * // => objects for ['pebbles']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.takeRightWhile(users, ['active', false]);
     * // => objects for ['fred', 'pebbles']
     *
     * // The `_.property` iteratee shorthand.
     * _.takeRightWhile(users, 'active');
     * // => []
     */
    function takeRightWhile(array, predicate) {
      return (array && array.length)
        ? baseWhile(array, getIteratee(predicate, 3), false, true)
        : [];
    }

    /**
     * Creates a slice of `array` with elements taken from the beginning. Elements
     * are taken until `predicate` returns falsey. The predicate is invoked with
     * three arguments: (value, index, array).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Array
     * @param {Array} array The array to query.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the slice of `array`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'active': false },
     *   { 'user': 'fred',    'active': false},
     *   { 'user': 'pebbles', 'active': true }
     * ];
     *
     * _.takeWhile(users, function(o) { return !o.active; });
     * // => objects for ['barney', 'fred']
     *
     * // The `_.matches` iteratee shorthand.
     * _.takeWhile(users, { 'user': 'barney', 'active': false });
     * // => objects for ['barney']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.takeWhile(users, ['active', false]);
     * // => objects for ['barney', 'fred']
     *
     * // The `_.property` iteratee shorthand.
     * _.takeWhile(users, 'active');
     * // => []
     */
    function takeWhile(array, predicate) {
      return (array && array.length)
        ? baseWhile(array, getIteratee(predicate, 3))
        : [];
    }

    /**
     * Creates an array of unique values, in order, from all given arrays using
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @returns {Array} Returns the new array of combined values.
     * @example
     *
     * _.union([2, 1], [4, 2], [1, 2]);
     * // => [2, 1, 4]
     */
    var union = rest(function(arrays) {
      return baseUniq(baseFlatten(arrays, 1, isArrayLikeObject, true));
    });

    /**
     * This method is like `_.union` except that it accepts `iteratee` which is
     * invoked for each element of each `arrays` to generate the criterion by
     * which uniqueness is computed. The iteratee is invoked with one argument:
     * (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns the new array of combined values.
     * @example
     *
     * _.unionBy([2.1, 1.2], [4.3, 2.4], Math.floor);
     * // => [2.1, 1.2, 4.3]
     *
     * // The `_.property` iteratee shorthand.
     * _.unionBy([{ 'x': 1 }], [{ 'x': 2 }, { 'x': 1 }], 'x');
     * // => [{ 'x': 1 }, { 'x': 2 }]
     */
    var unionBy = rest(function(arrays) {
      var iteratee = last(arrays);
      if (isArrayLikeObject(iteratee)) {
        iteratee = undefined;
      }
      return baseUniq(baseFlatten(arrays, 1, isArrayLikeObject, true), getIteratee(iteratee));
    });

    /**
     * This method is like `_.union` except that it accepts `comparator` which
     * is invoked to compare elements of `arrays`. The comparator is invoked
     * with two arguments: (arrVal, othVal).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of combined values.
     * @example
     *
     * var objects = [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }];
     * var others = [{ 'x': 1, 'y': 1 }, { 'x': 1, 'y': 2 }];
     *
     * _.unionWith(objects, others, _.isEqual);
     * // => [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }, { 'x': 1, 'y': 1 }]
     */
    var unionWith = rest(function(arrays) {
      var comparator = last(arrays);
      if (isArrayLikeObject(comparator)) {
        comparator = undefined;
      }
      return baseUniq(baseFlatten(arrays, 1, isArrayLikeObject, true), undefined, comparator);
    });

    /**
     * Creates a duplicate-free version of an array, using
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons, in which only the first occurrence of each
     * element is kept.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @returns {Array} Returns the new duplicate free array.
     * @example
     *
     * _.uniq([2, 1, 2]);
     * // => [2, 1]
     */
    function uniq(array) {
      return (array && array.length)
        ? baseUniq(array)
        : [];
    }

    /**
     * This method is like `_.uniq` except that it accepts `iteratee` which is
     * invoked for each element in `array` to generate the criterion by which
     * uniqueness is computed. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns the new duplicate free array.
     * @example
     *
     * _.uniqBy([2.1, 1.2, 2.3], Math.floor);
     * // => [2.1, 1.2]
     *
     * // The `_.property` iteratee shorthand.
     * _.uniqBy([{ 'x': 1 }, { 'x': 2 }, { 'x': 1 }], 'x');
     * // => [{ 'x': 1 }, { 'x': 2 }]
     */
    function uniqBy(array, iteratee) {
      return (array && array.length)
        ? baseUniq(array, getIteratee(iteratee))
        : [];
    }

    /**
     * This method is like `_.uniq` except that it accepts `comparator` which
     * is invoked to compare elements of `array`. The comparator is invoked with
     * two arguments: (arrVal, othVal).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {Array} array The array to inspect.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new duplicate free array.
     * @example
     *
     * var objects = [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 },  { 'x': 1, 'y': 2 }];
     *
     * _.uniqWith(objects, _.isEqual);
     * // => [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }]
     */
    function uniqWith(array, comparator) {
      return (array && array.length)
        ? baseUniq(array, undefined, comparator)
        : [];
    }

    /**
     * This method is like `_.zip` except that it accepts an array of grouped
     * elements and creates an array regrouping the elements to their pre-zip
     * configuration.
     *
     * @static
     * @memberOf _
     * @since 1.2.0
     * @category Array
     * @param {Array} array The array of grouped elements to process.
     * @returns {Array} Returns the new array of regrouped elements.
     * @example
     *
     * var zipped = _.zip(['fred', 'barney'], [30, 40], [true, false]);
     * // => [['fred', 30, true], ['barney', 40, false]]
     *
     * _.unzip(zipped);
     * // => [['fred', 'barney'], [30, 40], [true, false]]
     */
    function unzip(array) {
      if (!(array && array.length)) {
        return [];
      }
      var length = 0;
      array = arrayFilter(array, function(group) {
        if (isArrayLikeObject(group)) {
          length = nativeMax(group.length, length);
          return true;
        }
      });
      return baseTimes(length, function(index) {
        return arrayMap(array, baseProperty(index));
      });
    }

    /**
     * This method is like `_.unzip` except that it accepts `iteratee` to specify
     * how regrouped values should be combined. The iteratee is invoked with the
     * elements of each group: (...group).
     *
     * @static
     * @memberOf _
     * @since 3.8.0
     * @category Array
     * @param {Array} array The array of grouped elements to process.
     * @param {Function} [iteratee=_.identity] The function to combine
     *  regrouped values.
     * @returns {Array} Returns the new array of regrouped elements.
     * @example
     *
     * var zipped = _.zip([1, 2], [10, 20], [100, 200]);
     * // => [[1, 10, 100], [2, 20, 200]]
     *
     * _.unzipWith(zipped, _.add);
     * // => [3, 30, 300]
     */
    function unzipWith(array, iteratee) {
      if (!(array && array.length)) {
        return [];
      }
      var result = unzip(array);
      if (iteratee == null) {
        return result;
      }
      return arrayMap(result, function(group) {
        return apply(iteratee, undefined, group);
      });
    }

    /**
     * Creates an array excluding all given values using
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * for equality comparisons.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {Array} array The array to filter.
     * @param {...*} [values] The values to exclude.
     * @returns {Array} Returns the new array of filtered values.
     * @example
     *
     * _.without([1, 2, 1, 3], 1, 2);
     * // => [3]
     */
    var without = rest(function(array, values) {
      return isArrayLikeObject(array)
        ? baseDifference(array, values)
        : [];
    });

    /**
     * Creates an array of unique values that is the
     * [symmetric difference](https://en.wikipedia.org/wiki/Symmetric_difference)
     * of the given arrays. The order of result values is determined by the order
     * they occur in the arrays.
     *
     * @static
     * @memberOf _
     * @since 2.4.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @returns {Array} Returns the new array of values.
     * @example
     *
     * _.xor([2, 1], [4, 2]);
     * // => [1, 4]
     */
    var xor = rest(function(arrays) {
      return baseXor(arrayFilter(arrays, isArrayLikeObject));
    });

    /**
     * This method is like `_.xor` except that it accepts `iteratee` which is
     * invoked for each element of each `arrays` to generate the criterion by
     * which by which they're compared. The iteratee is invoked with one argument:
     * (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Array} Returns the new array of values.
     * @example
     *
     * _.xorBy([2.1, 1.2], [4.3, 2.4], Math.floor);
     * // => [1.2, 4.3]
     *
     * // The `_.property` iteratee shorthand.
     * _.xorBy([{ 'x': 1 }], [{ 'x': 2 }, { 'x': 1 }], 'x');
     * // => [{ 'x': 2 }]
     */
    var xorBy = rest(function(arrays) {
      var iteratee = last(arrays);
      if (isArrayLikeObject(iteratee)) {
        iteratee = undefined;
      }
      return baseXor(arrayFilter(arrays, isArrayLikeObject), getIteratee(iteratee));
    });

    /**
     * This method is like `_.xor` except that it accepts `comparator` which is
     * invoked to compare elements of `arrays`. The comparator is invoked with
     * two arguments: (arrVal, othVal).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Array
     * @param {...Array} [arrays] The arrays to inspect.
     * @param {Function} [comparator] The comparator invoked per element.
     * @returns {Array} Returns the new array of values.
     * @example
     *
     * var objects = [{ 'x': 1, 'y': 2 }, { 'x': 2, 'y': 1 }];
     * var others = [{ 'x': 1, 'y': 1 }, { 'x': 1, 'y': 2 }];
     *
     * _.xorWith(objects, others, _.isEqual);
     * // => [{ 'x': 2, 'y': 1 }, { 'x': 1, 'y': 1 }]
     */
    var xorWith = rest(function(arrays) {
      var comparator = last(arrays);
      if (isArrayLikeObject(comparator)) {
        comparator = undefined;
      }
      return baseXor(arrayFilter(arrays, isArrayLikeObject), undefined, comparator);
    });

    /**
     * Creates an array of grouped elements, the first of which contains the
     * first elements of the given arrays, the second of which contains the
     * second elements of the given arrays, and so on.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Array
     * @param {...Array} [arrays] The arrays to process.
     * @returns {Array} Returns the new array of grouped elements.
     * @example
     *
     * _.zip(['fred', 'barney'], [30, 40], [true, false]);
     * // => [['fred', 30, true], ['barney', 40, false]]
     */
    var zip = rest(unzip);

    /**
     * This method is like `_.fromPairs` except that it accepts two arrays,
     * one of property identifiers and one of corresponding values.
     *
     * @static
     * @memberOf _
     * @since 0.4.0
     * @category Array
     * @param {Array} [props=[]] The property identifiers.
     * @param {Array} [values=[]] The property values.
     * @returns {Object} Returns the new object.
     * @example
     *
     * _.zipObject(['a', 'b'], [1, 2]);
     * // => { 'a': 1, 'b': 2 }
     */
    function zipObject(props, values) {
      return baseZipObject(props || [], values || [], assignValue);
    }

    /**
     * This method is like `_.zipObject` except that it supports property paths.
     *
     * @static
     * @memberOf _
     * @since 4.1.0
     * @category Array
     * @param {Array} [props=[]] The property identifiers.
     * @param {Array} [values=[]] The property values.
     * @returns {Object} Returns the new object.
     * @example
     *
     * _.zipObjectDeep(['a.b[0].c', 'a.b[1].d'], [1, 2]);
     * // => { 'a': { 'b': [{ 'c': 1 }, { 'd': 2 }] } }
     */
    function zipObjectDeep(props, values) {
      return baseZipObject(props || [], values || [], baseSet);
    }

    /**
     * This method is like `_.zip` except that it accepts `iteratee` to specify
     * how grouped values should be combined. The iteratee is invoked with the
     * elements of each group: (...group).
     *
     * @static
     * @memberOf _
     * @since 3.8.0
     * @category Array
     * @param {...Array} [arrays] The arrays to process.
     * @param {Function} [iteratee=_.identity] The function to combine grouped values.
     * @returns {Array} Returns the new array of grouped elements.
     * @example
     *
     * _.zipWith([1, 2], [10, 20], [100, 200], function(a, b, c) {
     *   return a + b + c;
     * });
     * // => [111, 222]
     */
    var zipWith = rest(function(arrays) {
      var length = arrays.length,
          iteratee = length > 1 ? arrays[length - 1] : undefined;

      iteratee = typeof iteratee == 'function' ? (arrays.pop(), iteratee) : undefined;
      return unzipWith(arrays, iteratee);
    });

    /*------------------------------------------------------------------------*/

    /**
     * Creates a `lodash` wrapper instance that wraps `value` with explicit method
     * chain sequences enabled. The result of such sequences must be unwrapped
     * with `_#value`.
     *
     * @static
     * @memberOf _
     * @since 1.3.0
     * @category Seq
     * @param {*} value The value to wrap.
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'age': 36 },
     *   { 'user': 'fred',    'age': 40 },
     *   { 'user': 'pebbles', 'age': 1 }
     * ];
     *
     * var youngest = _
     *   .chain(users)
     *   .sortBy('age')
     *   .map(function(o) {
     *     return o.user + ' is ' + o.age;
     *   })
     *   .head()
     *   .value();
     * // => 'pebbles is 1'
     */
    function chain(value) {
      var result = lodash(value);
      result.__chain__ = true;
      return result;
    }

    /**
     * This method invokes `interceptor` and returns `value`. The interceptor
     * is invoked with one argument; (value). The purpose of this method is to
     * "tap into" a method chain sequence in order to modify intermediate results.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Seq
     * @param {*} value The value to provide to `interceptor`.
     * @param {Function} interceptor The function to invoke.
     * @returns {*} Returns `value`.
     * @example
     *
     * _([1, 2, 3])
     *  .tap(function(array) {
     *    // Mutate input array.
     *    array.pop();
     *  })
     *  .reverse()
     *  .value();
     * // => [2, 1]
     */
    function tap(value, interceptor) {
      interceptor(value);
      return value;
    }

    /**
     * This method is like `_.tap` except that it returns the result of `interceptor`.
     * The purpose of this method is to "pass thru" values replacing intermediate
     * results in a method chain sequence.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Seq
     * @param {*} value The value to provide to `interceptor`.
     * @param {Function} interceptor The function to invoke.
     * @returns {*} Returns the result of `interceptor`.
     * @example
     *
     * _('  abc  ')
     *  .chain()
     *  .trim()
     *  .thru(function(value) {
     *    return [value];
     *  })
     *  .value();
     * // => ['abc']
     */
    function thru(value, interceptor) {
      return interceptor(value);
    }

    /**
     * This method is the wrapper version of `_.at`.
     *
     * @name at
     * @memberOf _
     * @since 1.0.0
     * @category Seq
     * @param {...(string|string[])} [paths] The property paths of elements to pick.
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 3 } }, 4] };
     *
     * _(object).at(['a[0].b.c', 'a[1]']).value();
     * // => [3, 4]
     *
     * _(['a', 'b', 'c']).at(0, 2).value();
     * // => ['a', 'c']
     */
    var wrapperAt = rest(function(paths) {
      paths = baseFlatten(paths, 1);
      var length = paths.length,
          start = length ? paths[0] : 0,
          value = this.__wrapped__,
          interceptor = function(object) { return baseAt(object, paths); };

      if (length > 1 || this.__actions__.length ||
          !(value instanceof LazyWrapper) || !isIndex(start)) {
        return this.thru(interceptor);
      }
      value = value.slice(start, +start + (length ? 1 : 0));
      value.__actions__.push({
        'func': thru,
        'args': [interceptor],
        'thisArg': undefined
      });
      return new LodashWrapper(value, this.__chain__).thru(function(array) {
        if (length && !array.length) {
          array.push(undefined);
        }
        return array;
      });
    });

    /**
     * Creates a `lodash` wrapper instance with explicit method chain sequences enabled.
     *
     * @name chain
     * @memberOf _
     * @since 0.1.0
     * @category Seq
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36 },
     *   { 'user': 'fred',   'age': 40 }
     * ];
     *
     * // A sequence without explicit chaining.
     * _(users).head();
     * // => { 'user': 'barney', 'age': 36 }
     *
     * // A sequence with explicit chaining.
     * _(users)
     *   .chain()
     *   .head()
     *   .pick('user')
     *   .value();
     * // => { 'user': 'barney' }
     */
    function wrapperChain() {
      return chain(this);
    }

    /**
     * Executes the chain sequence and returns the wrapped result.
     *
     * @name commit
     * @memberOf _
     * @since 3.2.0
     * @category Seq
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * var array = [1, 2];
     * var wrapped = _(array).push(3);
     *
     * console.log(array);
     * // => [1, 2]
     *
     * wrapped = wrapped.commit();
     * console.log(array);
     * // => [1, 2, 3]
     *
     * wrapped.last();
     * // => 3
     *
     * console.log(array);
     * // => [1, 2, 3]
     */
    function wrapperCommit() {
      return new LodashWrapper(this.value(), this.__chain__);
    }

    /**
     * Gets the next value on a wrapped object following the
     * [iterator protocol](https://mdn.io/iteration_protocols#iterator).
     *
     * @name next
     * @memberOf _
     * @since 4.0.0
     * @category Seq
     * @returns {Object} Returns the next iterator value.
     * @example
     *
     * var wrapped = _([1, 2]);
     *
     * wrapped.next();
     * // => { 'done': false, 'value': 1 }
     *
     * wrapped.next();
     * // => { 'done': false, 'value': 2 }
     *
     * wrapped.next();
     * // => { 'done': true, 'value': undefined }
     */
    function wrapperNext() {
      if (this.__values__ === undefined) {
        this.__values__ = toArray(this.value());
      }
      var done = this.__index__ >= this.__values__.length,
          value = done ? undefined : this.__values__[this.__index__++];

      return { 'done': done, 'value': value };
    }

    /**
     * Enables the wrapper to be iterable.
     *
     * @name Symbol.iterator
     * @memberOf _
     * @since 4.0.0
     * @category Seq
     * @returns {Object} Returns the wrapper object.
     * @example
     *
     * var wrapped = _([1, 2]);
     *
     * wrapped[Symbol.iterator]() === wrapped;
     * // => true
     *
     * Array.from(wrapped);
     * // => [1, 2]
     */
    function wrapperToIterator() {
      return this;
    }

    /**
     * Creates a clone of the chain sequence planting `value` as the wrapped value.
     *
     * @name plant
     * @memberOf _
     * @since 3.2.0
     * @category Seq
     * @param {*} value The value to plant.
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * var wrapped = _([1, 2]).map(square);
     * var other = wrapped.plant([3, 4]);
     *
     * other.value();
     * // => [9, 16]
     *
     * wrapped.value();
     * // => [1, 4]
     */
    function wrapperPlant(value) {
      var result,
          parent = this;

      while (parent instanceof baseLodash) {
        var clone = wrapperClone(parent);
        clone.__index__ = 0;
        clone.__values__ = undefined;
        if (result) {
          previous.__wrapped__ = clone;
        } else {
          result = clone;
        }
        var previous = clone;
        parent = parent.__wrapped__;
      }
      previous.__wrapped__ = value;
      return result;
    }

    /**
     * This method is the wrapper version of `_.reverse`.
     *
     * **Note:** This method mutates the wrapped array.
     *
     * @name reverse
     * @memberOf _
     * @since 0.1.0
     * @category Seq
     * @returns {Object} Returns the new `lodash` wrapper instance.
     * @example
     *
     * var array = [1, 2, 3];
     *
     * _(array).reverse().value()
     * // => [3, 2, 1]
     *
     * console.log(array);
     * // => [3, 2, 1]
     */
    function wrapperReverse() {
      var value = this.__wrapped__;
      if (value instanceof LazyWrapper) {
        var wrapped = value;
        if (this.__actions__.length) {
          wrapped = new LazyWrapper(this);
        }
        wrapped = wrapped.reverse();
        wrapped.__actions__.push({
          'func': thru,
          'args': [reverse],
          'thisArg': undefined
        });
        return new LodashWrapper(wrapped, this.__chain__);
      }
      return this.thru(reverse);
    }

    /**
     * Executes the chain sequence to resolve the unwrapped value.
     *
     * @name value
     * @memberOf _
     * @since 0.1.0
     * @alias toJSON, valueOf
     * @category Seq
     * @returns {*} Returns the resolved unwrapped value.
     * @example
     *
     * _([1, 2, 3]).value();
     * // => [1, 2, 3]
     */
    function wrapperValue() {
      return baseWrapperValue(this.__wrapped__, this.__actions__);
    }

    /*------------------------------------------------------------------------*/

    /**
     * Creates an object composed of keys generated from the results of running
     * each element of `collection` thru `iteratee`. The corresponding value of
     * each key is the number of times the key was returned by `iteratee`. The
     * iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 0.5.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee to transform keys.
     * @returns {Object} Returns the composed aggregate object.
     * @example
     *
     * _.countBy([6.1, 4.2, 6.3], Math.floor);
     * // => { '4': 1, '6': 2 }
     *
     * _.countBy(['one', 'two', 'three'], 'length');
     * // => { '3': 2, '5': 1 }
     */
    var countBy = createAggregator(function(result, value, key) {
      hasOwnProperty.call(result, key) ? ++result[key] : (result[key] = 1);
    });

    /**
     * Checks if `predicate` returns truthy for **all** elements of `collection`.
     * Iteration is stopped once `predicate` returns falsey. The predicate is
     * invoked with three arguments: (value, index|key, collection).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {boolean} Returns `true` if all elements pass the predicate check,
     *  else `false`.
     * @example
     *
     * _.every([true, 1, null, 'yes'], Boolean);
     * // => false
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36, 'active': false },
     *   { 'user': 'fred',   'age': 40, 'active': false }
     * ];
     *
     * // The `_.matches` iteratee shorthand.
     * _.every(users, { 'user': 'barney', 'active': false });
     * // => false
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.every(users, ['active', false]);
     * // => true
     *
     * // The `_.property` iteratee shorthand.
     * _.every(users, 'active');
     * // => false
     */
    function every(collection, predicate, guard) {
      var func = isArray(collection) ? arrayEvery : baseEvery;
      if (guard && isIterateeCall(collection, predicate, guard)) {
        predicate = undefined;
      }
      return func(collection, getIteratee(predicate, 3));
    }

    /**
     * Iterates over elements of `collection`, returning an array of all elements
     * `predicate` returns truthy for. The predicate is invoked with three
     * arguments: (value, index|key, collection).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new filtered array.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36, 'active': true },
     *   { 'user': 'fred',   'age': 40, 'active': false }
     * ];
     *
     * _.filter(users, function(o) { return !o.active; });
     * // => objects for ['fred']
     *
     * // The `_.matches` iteratee shorthand.
     * _.filter(users, { 'age': 36, 'active': true });
     * // => objects for ['barney']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.filter(users, ['active', false]);
     * // => objects for ['fred']
     *
     * // The `_.property` iteratee shorthand.
     * _.filter(users, 'active');
     * // => objects for ['barney']
     */
    function filter(collection, predicate) {
      var func = isArray(collection) ? arrayFilter : baseFilter;
      return func(collection, getIteratee(predicate, 3));
    }

    /**
     * Iterates over elements of `collection`, returning the first element
     * `predicate` returns truthy for. The predicate is invoked with three
     * arguments: (value, index|key, collection).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {*} Returns the matched element, else `undefined`.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'age': 36, 'active': true },
     *   { 'user': 'fred',    'age': 40, 'active': false },
     *   { 'user': 'pebbles', 'age': 1,  'active': true }
     * ];
     *
     * _.find(users, function(o) { return o.age < 40; });
     * // => object for 'barney'
     *
     * // The `_.matches` iteratee shorthand.
     * _.find(users, { 'age': 1, 'active': true });
     * // => object for 'pebbles'
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.find(users, ['active', false]);
     * // => object for 'fred'
     *
     * // The `_.property` iteratee shorthand.
     * _.find(users, 'active');
     * // => object for 'barney'
     */
    function find(collection, predicate) {
      predicate = getIteratee(predicate, 3);
      if (isArray(collection)) {
        var index = baseFindIndex(collection, predicate);
        return index > -1 ? collection[index] : undefined;
      }
      return baseFind(collection, predicate, baseEach);
    }

    /**
     * This method is like `_.find` except that it iterates over elements of
     * `collection` from right to left.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {*} Returns the matched element, else `undefined`.
     * @example
     *
     * _.findLast([1, 2, 3, 4], function(n) {
     *   return n % 2 == 1;
     * });
     * // => 3
     */
    function findLast(collection, predicate) {
      predicate = getIteratee(predicate, 3);
      if (isArray(collection)) {
        var index = baseFindIndex(collection, predicate, true);
        return index > -1 ? collection[index] : undefined;
      }
      return baseFind(collection, predicate, baseEachRight);
    }

    /**
     * Creates a flattened array of values by running each element in `collection`
     * thru `iteratee` and flattening the mapped results. The iteratee is invoked
     * with three arguments: (value, index|key, collection).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * function duplicate(n) {
     *   return [n, n];
     * }
     *
     * _.flatMap([1, 2], duplicate);
     * // => [1, 1, 2, 2]
     */
    function flatMap(collection, iteratee) {
      return baseFlatten(map(collection, iteratee), 1);
    }

    /**
     * This method is like `_.flatMap` except that it recursively flattens the
     * mapped results.
     *
     * @static
     * @memberOf _
     * @since 4.7.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * function duplicate(n) {
     *   return [[[n, n]]];
     * }
     *
     * _.flatMapDeep([1, 2], duplicate);
     * // => [1, 1, 2, 2]
     */
    function flatMapDeep(collection, iteratee) {
      return baseFlatten(map(collection, iteratee), INFINITY);
    }

    /**
     * This method is like `_.flatMap` except that it recursively flattens the
     * mapped results up to `depth` times.
     *
     * @static
     * @memberOf _
     * @since 4.7.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @param {number} [depth=1] The maximum recursion depth.
     * @returns {Array} Returns the new flattened array.
     * @example
     *
     * function duplicate(n) {
     *   return [[[n, n]]];
     * }
     *
     * _.flatMapDepth([1, 2], duplicate, 2);
     * // => [[1, 1], [2, 2]]
     */
    function flatMapDepth(collection, iteratee, depth) {
      depth = depth === undefined ? 1 : toInteger(depth);
      return baseFlatten(map(collection, iteratee), depth);
    }

    /**
     * Iterates over elements of `collection` and invokes `iteratee` for each element.
     * The iteratee is invoked with three arguments: (value, index|key, collection).
     * Iteratee functions may exit iteration early by explicitly returning `false`.
     *
     * **Note:** As with other "Collections" methods, objects with a "length"
     * property are iterated like arrays. To avoid this behavior use `_.forIn`
     * or `_.forOwn` for object iteration.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @alias each
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Array|Object} Returns `collection`.
     * @example
     *
     * _([1, 2]).forEach(function(value) {
     *   console.log(value);
     * });
     * // => Logs `1` then `2`.
     *
     * _.forEach({ 'a': 1, 'b': 2 }, function(value, key) {
     *   console.log(key);
     * });
     * // => Logs 'a' then 'b' (iteration order is not guaranteed).
     */
    function forEach(collection, iteratee) {
      return (typeof iteratee == 'function' && isArray(collection))
        ? arrayEach(collection, iteratee)
        : baseEach(collection, getIteratee(iteratee));
    }

    /**
     * This method is like `_.forEach` except that it iterates over elements of
     * `collection` from right to left.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @alias eachRight
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Array|Object} Returns `collection`.
     * @example
     *
     * _.forEachRight([1, 2], function(value) {
     *   console.log(value);
     * });
     * // => Logs `2` then `1`.
     */
    function forEachRight(collection, iteratee) {
      return (typeof iteratee == 'function' && isArray(collection))
        ? arrayEachRight(collection, iteratee)
        : baseEachRight(collection, getIteratee(iteratee));
    }

    /**
     * Creates an object composed of keys generated from the results of running
     * each element of `collection` thru `iteratee`. The order of grouped values
     * is determined by the order they occur in `collection`. The corresponding
     * value of each key is an array of elements responsible for generating the
     * key. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee to transform keys.
     * @returns {Object} Returns the composed aggregate object.
     * @example
     *
     * _.groupBy([6.1, 4.2, 6.3], Math.floor);
     * // => { '4': [4.2], '6': [6.1, 6.3] }
     *
     * // The `_.property` iteratee shorthand.
     * _.groupBy(['one', 'two', 'three'], 'length');
     * // => { '3': ['one', 'two'], '5': ['three'] }
     */
    var groupBy = createAggregator(function(result, value, key) {
      if (hasOwnProperty.call(result, key)) {
        result[key].push(value);
      } else {
        result[key] = [value];
      }
    });

    /**
     * Checks if `value` is in `collection`. If `collection` is a string, it's
     * checked for a substring of `value`, otherwise
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * is used for equality comparisons. If `fromIndex` is negative, it's used as
     * the offset from the end of `collection`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object|string} collection The collection to search.
     * @param {*} value The value to search for.
     * @param {number} [fromIndex=0] The index to search from.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.reduce`.
     * @returns {boolean} Returns `true` if `value` is found, else `false`.
     * @example
     *
     * _.includes([1, 2, 3], 1);
     * // => true
     *
     * _.includes([1, 2, 3], 1, 2);
     * // => false
     *
     * _.includes({ 'user': 'fred', 'age': 40 }, 'fred');
     * // => true
     *
     * _.includes('pebbles', 'eb');
     * // => true
     */
    function includes(collection, value, fromIndex, guard) {
      collection = isArrayLike(collection) ? collection : values(collection);
      fromIndex = (fromIndex && !guard) ? toInteger(fromIndex) : 0;

      var length = collection.length;
      if (fromIndex < 0) {
        fromIndex = nativeMax(length + fromIndex, 0);
      }
      return isString(collection)
        ? (fromIndex <= length && collection.indexOf(value, fromIndex) > -1)
        : (!!length && baseIndexOf(collection, value, fromIndex) > -1);
    }

    /**
     * Invokes the method at `path` of each element in `collection`, returning
     * an array of the results of each invoked method. Any additional arguments
     * are provided to each invoked method. If `methodName` is a function, it's
     * invoked for and `this` bound to, each element in `collection`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|string} path The path of the method to invoke or
     *  the function invoked per iteration.
     * @param {...*} [args] The arguments to invoke each method with.
     * @returns {Array} Returns the array of results.
     * @example
     *
     * _.invokeMap([[5, 1, 7], [3, 2, 1]], 'sort');
     * // => [[1, 5, 7], [1, 2, 3]]
     *
     * _.invokeMap([123, 456], String.prototype.split, '');
     * // => [['1', '2', '3'], ['4', '5', '6']]
     */
    var invokeMap = rest(function(collection, path, args) {
      var index = -1,
          isFunc = typeof path == 'function',
          isProp = isKey(path),
          result = isArrayLike(collection) ? Array(collection.length) : [];

      baseEach(collection, function(value) {
        var func = isFunc ? path : ((isProp && value != null) ? value[path] : undefined);
        result[++index] = func ? apply(func, value, args) : baseInvoke(value, path, args);
      });
      return result;
    });

    /**
     * Creates an object composed of keys generated from the results of running
     * each element of `collection` thru `iteratee`. The corresponding value of
     * each key is the last element responsible for generating the key. The
     * iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee to transform keys.
     * @returns {Object} Returns the composed aggregate object.
     * @example
     *
     * var array = [
     *   { 'dir': 'left', 'code': 97 },
     *   { 'dir': 'right', 'code': 100 }
     * ];
     *
     * _.keyBy(array, function(o) {
     *   return String.fromCharCode(o.code);
     * });
     * // => { 'a': { 'dir': 'left', 'code': 97 }, 'd': { 'dir': 'right', 'code': 100 } }
     *
     * _.keyBy(array, 'dir');
     * // => { 'left': { 'dir': 'left', 'code': 97 }, 'right': { 'dir': 'right', 'code': 100 } }
     */
    var keyBy = createAggregator(function(result, value, key) {
      result[key] = value;
    });

    /**
     * Creates an array of values by running each element in `collection` thru
     * `iteratee`. The iteratee is invoked with three arguments:
     * (value, index|key, collection).
     *
     * Many lodash methods are guarded to work as iteratees for methods like
     * `_.every`, `_.filter`, `_.map`, `_.mapValues`, `_.reject`, and `_.some`.
     *
     * The guarded methods are:
     * `ary`, `chunk`, `curry`, `curryRight`, `drop`, `dropRight`, `every`,
     * `fill`, `invert`, `parseInt`, `random`, `range`, `rangeRight`, `repeat`,
     * `sampleSize`, `slice`, `some`, `sortBy`, `split`, `take`, `takeRight`,
     * `template`, `trim`, `trimEnd`, `trimStart`, and `words`
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new mapped array.
     * @example
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * _.map([4, 8], square);
     * // => [16, 64]
     *
     * _.map({ 'a': 4, 'b': 8 }, square);
     * // => [16, 64] (iteration order is not guaranteed)
     *
     * var users = [
     *   { 'user': 'barney' },
     *   { 'user': 'fred' }
     * ];
     *
     * // The `_.property` iteratee shorthand.
     * _.map(users, 'user');
     * // => ['barney', 'fred']
     */
    function map(collection, iteratee) {
      var func = isArray(collection) ? arrayMap : baseMap;
      return func(collection, getIteratee(iteratee, 3));
    }

    /**
     * This method is like `_.sortBy` except that it allows specifying the sort
     * orders of the iteratees to sort by. If `orders` is unspecified, all values
     * are sorted in ascending order. Otherwise, specify an order of "desc" for
     * descending or "asc" for ascending sort order of corresponding values.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array[]|Function[]|Object[]|string[]} [iteratees=[_.identity]]
     *  The iteratees to sort by.
     * @param {string[]} [orders] The sort orders of `iteratees`.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.reduce`.
     * @returns {Array} Returns the new sorted array.
     * @example
     *
     * var users = [
     *   { 'user': 'fred',   'age': 48 },
     *   { 'user': 'barney', 'age': 34 },
     *   { 'user': 'fred',   'age': 40 },
     *   { 'user': 'barney', 'age': 36 }
     * ];
     *
     * // Sort by `user` in ascending order and by `age` in descending order.
     * _.orderBy(users, ['user', 'age'], ['asc', 'desc']);
     * // => objects for [['barney', 36], ['barney', 34], ['fred', 48], ['fred', 40]]
     */
    function orderBy(collection, iteratees, orders, guard) {
      if (collection == null) {
        return [];
      }
      if (!isArray(iteratees)) {
        iteratees = iteratees == null ? [] : [iteratees];
      }
      orders = guard ? undefined : orders;
      if (!isArray(orders)) {
        orders = orders == null ? [] : [orders];
      }
      return baseOrderBy(collection, iteratees, orders);
    }

    /**
     * Creates an array of elements split into two groups, the first of which
     * contains elements `predicate` returns truthy for, the second of which
     * contains elements `predicate` returns falsey for. The predicate is
     * invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the array of grouped elements.
     * @example
     *
     * var users = [
     *   { 'user': 'barney',  'age': 36, 'active': false },
     *   { 'user': 'fred',    'age': 40, 'active': true },
     *   { 'user': 'pebbles', 'age': 1,  'active': false }
     * ];
     *
     * _.partition(users, function(o) { return o.active; });
     * // => objects for [['fred'], ['barney', 'pebbles']]
     *
     * // The `_.matches` iteratee shorthand.
     * _.partition(users, { 'age': 1, 'active': false });
     * // => objects for [['pebbles'], ['barney', 'fred']]
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.partition(users, ['active', false]);
     * // => objects for [['barney', 'pebbles'], ['fred']]
     *
     * // The `_.property` iteratee shorthand.
     * _.partition(users, 'active');
     * // => objects for [['fred'], ['barney', 'pebbles']]
     */
    var partition = createAggregator(function(result, value, key) {
      result[key ? 0 : 1].push(value);
    }, function() { return [[], []]; });

    /**
     * Reduces `collection` to a value which is the accumulated result of running
     * each element in `collection` thru `iteratee`, where each successive
     * invocation is supplied the return value of the previous. If `accumulator`
     * is not given, the first element of `collection` is used as the initial
     * value. The iteratee is invoked with four arguments:
     * (accumulator, value, index|key, collection).
     *
     * Many lodash methods are guarded to work as iteratees for methods like
     * `_.reduce`, `_.reduceRight`, and `_.transform`.
     *
     * The guarded methods are:
     * `assign`, `defaults`, `defaultsDeep`, `includes`, `merge`, `orderBy`,
     * and `sortBy`
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @param {*} [accumulator] The initial value.
     * @returns {*} Returns the accumulated value.
     * @example
     *
     * _.reduce([1, 2], function(sum, n) {
     *   return sum + n;
     * }, 0);
     * // => 3
     *
     * _.reduce({ 'a': 1, 'b': 2, 'c': 1 }, function(result, value, key) {
     *   (result[value] || (result[value] = [])).push(key);
     *   return result;
     * }, {});
     * // => { '1': ['a', 'c'], '2': ['b'] } (iteration order is not guaranteed)
     */
    function reduce(collection, iteratee, accumulator) {
      var func = isArray(collection) ? arrayReduce : baseReduce,
          initAccum = arguments.length < 3;

      return func(collection, getIteratee(iteratee, 4), accumulator, initAccum, baseEach);
    }

    /**
     * This method is like `_.reduce` except that it iterates over elements of
     * `collection` from right to left.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @param {*} [accumulator] The initial value.
     * @returns {*} Returns the accumulated value.
     * @example
     *
     * var array = [[0, 1], [2, 3], [4, 5]];
     *
     * _.reduceRight(array, function(flattened, other) {
     *   return flattened.concat(other);
     * }, []);
     * // => [4, 5, 2, 3, 0, 1]
     */
    function reduceRight(collection, iteratee, accumulator) {
      var func = isArray(collection) ? arrayReduceRight : baseReduce,
          initAccum = arguments.length < 3;

      return func(collection, getIteratee(iteratee, 4), accumulator, initAccum, baseEachRight);
    }

    /**
     * The opposite of `_.filter`; this method returns the elements of `collection`
     * that `predicate` does **not** return truthy for.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {Array} Returns the new filtered array.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36, 'active': false },
     *   { 'user': 'fred',   'age': 40, 'active': true }
     * ];
     *
     * _.reject(users, function(o) { return !o.active; });
     * // => objects for ['fred']
     *
     * // The `_.matches` iteratee shorthand.
     * _.reject(users, { 'age': 40, 'active': true });
     * // => objects for ['barney']
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.reject(users, ['active', false]);
     * // => objects for ['fred']
     *
     * // The `_.property` iteratee shorthand.
     * _.reject(users, 'active');
     * // => objects for ['barney']
     */
    function reject(collection, predicate) {
      var func = isArray(collection) ? arrayFilter : baseFilter;
      predicate = getIteratee(predicate, 3);
      return func(collection, function(value, index, collection) {
        return !predicate(value, index, collection);
      });
    }

    /**
     * Gets a random element from `collection`.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to sample.
     * @returns {*} Returns the random element.
     * @example
     *
     * _.sample([1, 2, 3, 4]);
     * // => 2
     */
    function sample(collection) {
      var array = isArrayLike(collection) ? collection : values(collection),
          length = array.length;

      return length > 0 ? array[baseRandom(0, length - 1)] : undefined;
    }

    /**
     * Gets `n` random elements at unique keys from `collection` up to the
     * size of `collection`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Collection
     * @param {Array|Object} collection The collection to sample.
     * @param {number} [n=1] The number of elements to sample.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the random elements.
     * @example
     *
     * _.sampleSize([1, 2, 3], 2);
     * // => [3, 1]
     *
     * _.sampleSize([1, 2, 3], 4);
     * // => [2, 3, 1]
     */
    function sampleSize(collection, n, guard) {
      var index = -1,
          result = toArray(collection),
          length = result.length,
          lastIndex = length - 1;

      if ((guard ? isIterateeCall(collection, n, guard) : n === undefined)) {
        n = 1;
      } else {
        n = baseClamp(toInteger(n), 0, length);
      }
      while (++index < n) {
        var rand = baseRandom(index, lastIndex),
            value = result[rand];

        result[rand] = result[index];
        result[index] = value;
      }
      result.length = n;
      return result;
    }

    /**
     * Creates an array of shuffled values, using a version of the
     * [Fisher-Yates shuffle](https://en.wikipedia.org/wiki/Fisher-Yates_shuffle).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to shuffle.
     * @returns {Array} Returns the new shuffled array.
     * @example
     *
     * _.shuffle([1, 2, 3, 4]);
     * // => [4, 1, 3, 2]
     */
    function shuffle(collection) {
      return sampleSize(collection, MAX_ARRAY_LENGTH);
    }

    /**
     * Gets the size of `collection` by returning its length for array-like
     * values or the number of own enumerable string keyed properties for objects.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to inspect.
     * @returns {number} Returns the collection size.
     * @example
     *
     * _.size([1, 2, 3]);
     * // => 3
     *
     * _.size({ 'a': 1, 'b': 2 });
     * // => 2
     *
     * _.size('pebbles');
     * // => 7
     */
    function size(collection) {
      if (collection == null) {
        return 0;
      }
      if (isArrayLike(collection)) {
        var result = collection.length;
        return (result && isString(collection)) ? stringSize(collection) : result;
      }
      if (isObjectLike(collection)) {
        var tag = getTag(collection);
        if (tag == mapTag || tag == setTag) {
          return collection.size;
        }
      }
      return keys(collection).length;
    }

    /**
     * Checks if `predicate` returns truthy for **any** element of `collection`.
     * Iteration is stopped once `predicate` returns truthy. The predicate is
     * invoked with three arguments: (value, index|key, collection).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {boolean} Returns `true` if any element passes the predicate check,
     *  else `false`.
     * @example
     *
     * _.some([null, 0, 'yes', false], Boolean);
     * // => true
     *
     * var users = [
     *   { 'user': 'barney', 'active': true },
     *   { 'user': 'fred',   'active': false }
     * ];
     *
     * // The `_.matches` iteratee shorthand.
     * _.some(users, { 'user': 'barney', 'active': false });
     * // => false
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.some(users, ['active', false]);
     * // => true
     *
     * // The `_.property` iteratee shorthand.
     * _.some(users, 'active');
     * // => true
     */
    function some(collection, predicate, guard) {
      var func = isArray(collection) ? arraySome : baseSome;
      if (guard && isIterateeCall(collection, predicate, guard)) {
        predicate = undefined;
      }
      return func(collection, getIteratee(predicate, 3));
    }

    /**
     * Creates an array of elements, sorted in ascending order by the results of
     * running each element in a collection thru each iteratee. This method
     * performs a stable sort, that is, it preserves the original sort order of
     * equal elements. The iteratees are invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Collection
     * @param {Array|Object} collection The collection to iterate over.
     * @param {...(Array|Array[]|Function|Function[]|Object|Object[]|string|string[])}
     *  [iteratees=[_.identity]] The iteratees to sort by.
     * @returns {Array} Returns the new sorted array.
     * @example
     *
     * var users = [
     *   { 'user': 'fred',   'age': 48 },
     *   { 'user': 'barney', 'age': 36 },
     *   { 'user': 'fred',   'age': 40 },
     *   { 'user': 'barney', 'age': 34 }
     * ];
     *
     * _.sortBy(users, function(o) { return o.user; });
     * // => objects for [['barney', 36], ['barney', 34], ['fred', 48], ['fred', 40]]
     *
     * _.sortBy(users, ['user', 'age']);
     * // => objects for [['barney', 34], ['barney', 36], ['fred', 40], ['fred', 48]]
     *
     * _.sortBy(users, 'user', function(o) {
     *   return Math.floor(o.age / 10);
     * });
     * // => objects for [['barney', 36], ['barney', 34], ['fred', 48], ['fred', 40]]
     */
    var sortBy = rest(function(collection, iteratees) {
      if (collection == null) {
        return [];
      }
      var length = iteratees.length;
      if (length > 1 && isIterateeCall(collection, iteratees[0], iteratees[1])) {
        iteratees = [];
      } else if (length > 2 && isIterateeCall(iteratees[0], iteratees[1], iteratees[2])) {
        iteratees = [iteratees[0]];
      }
      iteratees = (iteratees.length == 1 && isArray(iteratees[0]))
        ? iteratees[0]
        : baseFlatten(iteratees, 1, isFlattenableIteratee);

      return baseOrderBy(collection, iteratees, []);
    });

    /*------------------------------------------------------------------------*/

    /**
     * Gets the timestamp of the number of milliseconds that have elapsed since
     * the Unix epoch (1 January 1970 00:00:00 UTC).
     *
     * @static
     * @memberOf _
     * @since 2.4.0
     * @type {Function}
     * @category Date
     * @returns {number} Returns the timestamp.
     * @example
     *
     * _.defer(function(stamp) {
     *   console.log(_.now() - stamp);
     * }, _.now());
     * // => Logs the number of milliseconds it took for the deferred function to be invoked.
     */
    var now = Date.now;

    /*------------------------------------------------------------------------*/

    /**
     * The opposite of `_.before`; this method creates a function that invokes
     * `func` once it's called `n` or more times.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {number} n The number of calls before `func` is invoked.
     * @param {Function} func The function to restrict.
     * @returns {Function} Returns the new restricted function.
     * @example
     *
     * var saves = ['profile', 'settings'];
     *
     * var done = _.after(saves.length, function() {
     *   console.log('done saving!');
     * });
     *
     * _.forEach(saves, function(type) {
     *   asyncSave({ 'type': type, 'complete': done });
     * });
     * // => Logs 'done saving!' after the two async saves have completed.
     */
    function after(n, func) {
      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      n = toInteger(n);
      return function() {
        if (--n < 1) {
          return func.apply(this, arguments);
        }
      };
    }

    /**
     * Creates a function that invokes `func`, with up to `n` arguments,
     * ignoring any additional arguments.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Function
     * @param {Function} func The function to cap arguments for.
     * @param {number} [n=func.length] The arity cap.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Function} Returns the new function.
     * @example
     *
     * _.map(['6', '8', '10'], _.ary(parseInt, 1));
     * // => [6, 8, 10]
     */
    function ary(func, n, guard) {
      n = guard ? undefined : n;
      n = (func && n == null) ? func.length : n;
      return createWrapper(func, ARY_FLAG, undefined, undefined, undefined, undefined, n);
    }

    /**
     * Creates a function that invokes `func`, with the `this` binding and arguments
     * of the created function, while it's called less than `n` times. Subsequent
     * calls to the created function return the result of the last `func` invocation.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Function
     * @param {number} n The number of calls at which `func` is no longer invoked.
     * @param {Function} func The function to restrict.
     * @returns {Function} Returns the new restricted function.
     * @example
     *
     * jQuery(element).on('click', _.before(5, addContactToList));
     * // => allows adding up to 4 contacts to the list
     */
    function before(n, func) {
      var result;
      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      n = toInteger(n);
      return function() {
        if (--n > 0) {
          result = func.apply(this, arguments);
        }
        if (n <= 1) {
          func = undefined;
        }
        return result;
      };
    }

    /**
     * Creates a function that invokes `func` with the `this` binding of `thisArg`
     * and `partials` prepended to the arguments it receives.
     *
     * The `_.bind.placeholder` value, which defaults to `_` in monolithic builds,
     * may be used as a placeholder for partially applied arguments.
     *
     * **Note:** Unlike native `Function#bind` this method doesn't set the "length"
     * property of bound functions.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to bind.
     * @param {*} thisArg The `this` binding of `func`.
     * @param {...*} [partials] The arguments to be partially applied.
     * @returns {Function} Returns the new bound function.
     * @example
     *
     * var greet = function(greeting, punctuation) {
     *   return greeting + ' ' + this.user + punctuation;
     * };
     *
     * var object = { 'user': 'fred' };
     *
     * var bound = _.bind(greet, object, 'hi');
     * bound('!');
     * // => 'hi fred!'
     *
     * // Bound with placeholders.
     * var bound = _.bind(greet, object, _, '!');
     * bound('hi');
     * // => 'hi fred!'
     */
    var bind = rest(function(func, thisArg, partials) {
      var bitmask = BIND_FLAG;
      if (partials.length) {
        var holders = replaceHolders(partials, getPlaceholder(bind));
        bitmask |= PARTIAL_FLAG;
      }
      return createWrapper(func, bitmask, thisArg, partials, holders);
    });

    /**
     * Creates a function that invokes the method at `object[key]` with `partials`
     * prepended to the arguments it receives.
     *
     * This method differs from `_.bind` by allowing bound functions to reference
     * methods that may be redefined or don't yet exist. See
     * [Peter Michaux's article](http://peter.michaux.ca/articles/lazy-function-definition-pattern)
     * for more details.
     *
     * The `_.bindKey.placeholder` value, which defaults to `_` in monolithic
     * builds, may be used as a placeholder for partially applied arguments.
     *
     * @static
     * @memberOf _
     * @since 0.10.0
     * @category Function
     * @param {Object} object The object to invoke the method on.
     * @param {string} key The key of the method.
     * @param {...*} [partials] The arguments to be partially applied.
     * @returns {Function} Returns the new bound function.
     * @example
     *
     * var object = {
     *   'user': 'fred',
     *   'greet': function(greeting, punctuation) {
     *     return greeting + ' ' + this.user + punctuation;
     *   }
     * };
     *
     * var bound = _.bindKey(object, 'greet', 'hi');
     * bound('!');
     * // => 'hi fred!'
     *
     * object.greet = function(greeting, punctuation) {
     *   return greeting + 'ya ' + this.user + punctuation;
     * };
     *
     * bound('!');
     * // => 'hiya fred!'
     *
     * // Bound with placeholders.
     * var bound = _.bindKey(object, 'greet', _, '!');
     * bound('hi');
     * // => 'hiya fred!'
     */
    var bindKey = rest(function(object, key, partials) {
      var bitmask = BIND_FLAG | BIND_KEY_FLAG;
      if (partials.length) {
        var holders = replaceHolders(partials, getPlaceholder(bindKey));
        bitmask |= PARTIAL_FLAG;
      }
      return createWrapper(key, bitmask, object, partials, holders);
    });

    /**
     * Creates a function that accepts arguments of `func` and either invokes
     * `func` returning its result, if at least `arity` number of arguments have
     * been provided, or returns a function that accepts the remaining `func`
     * arguments, and so on. The arity of `func` may be specified if `func.length`
     * is not sufficient.
     *
     * The `_.curry.placeholder` value, which defaults to `_` in monolithic builds,
     * may be used as a placeholder for provided arguments.
     *
     * **Note:** This method doesn't set the "length" property of curried functions.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Function
     * @param {Function} func The function to curry.
     * @param {number} [arity=func.length] The arity of `func`.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Function} Returns the new curried function.
     * @example
     *
     * var abc = function(a, b, c) {
     *   return [a, b, c];
     * };
     *
     * var curried = _.curry(abc);
     *
     * curried(1)(2)(3);
     * // => [1, 2, 3]
     *
     * curried(1, 2)(3);
     * // => [1, 2, 3]
     *
     * curried(1, 2, 3);
     * // => [1, 2, 3]
     *
     * // Curried with placeholders.
     * curried(1)(_, 3)(2);
     * // => [1, 2, 3]
     */
    function curry(func, arity, guard) {
      arity = guard ? undefined : arity;
      var result = createWrapper(func, CURRY_FLAG, undefined, undefined, undefined, undefined, undefined, arity);
      result.placeholder = curry.placeholder;
      return result;
    }

    /**
     * This method is like `_.curry` except that arguments are applied to `func`
     * in the manner of `_.partialRight` instead of `_.partial`.
     *
     * The `_.curryRight.placeholder` value, which defaults to `_` in monolithic
     * builds, may be used as a placeholder for provided arguments.
     *
     * **Note:** This method doesn't set the "length" property of curried functions.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Function
     * @param {Function} func The function to curry.
     * @param {number} [arity=func.length] The arity of `func`.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Function} Returns the new curried function.
     * @example
     *
     * var abc = function(a, b, c) {
     *   return [a, b, c];
     * };
     *
     * var curried = _.curryRight(abc);
     *
     * curried(3)(2)(1);
     * // => [1, 2, 3]
     *
     * curried(2, 3)(1);
     * // => [1, 2, 3]
     *
     * curried(1, 2, 3);
     * // => [1, 2, 3]
     *
     * // Curried with placeholders.
     * curried(3)(1, _)(2);
     * // => [1, 2, 3]
     */
    function curryRight(func, arity, guard) {
      arity = guard ? undefined : arity;
      var result = createWrapper(func, CURRY_RIGHT_FLAG, undefined, undefined, undefined, undefined, undefined, arity);
      result.placeholder = curryRight.placeholder;
      return result;
    }

    /**
     * Creates a debounced function that delays invoking `func` until after `wait`
     * milliseconds have elapsed since the last time the debounced function was
     * invoked. The debounced function comes with a `cancel` method to cancel
     * delayed `func` invocations and a `flush` method to immediately invoke them.
     * Provide an options object to indicate whether `func` should be invoked on
     * the leading and/or trailing edge of the `wait` timeout. The `func` is invoked
     * with the last arguments provided to the debounced function. Subsequent calls
     * to the debounced function return the result of the last `func` invocation.
     *
     * **Note:** If `leading` and `trailing` options are `true`, `func` is invoked
     * on the trailing edge of the timeout only if the debounced function is
     * invoked more than once during the `wait` timeout.
     *
     * See [David Corbacho's article](https://css-tricks.com/debouncing-throttling-explained-examples/)
     * for details over the differences between `_.debounce` and `_.throttle`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to debounce.
     * @param {number} [wait=0] The number of milliseconds to delay.
     * @param {Object} [options={}] The options object.
     * @param {boolean} [options.leading=false]
     *  Specify invoking on the leading edge of the timeout.
     * @param {number} [options.maxWait]
     *  The maximum time `func` is allowed to be delayed before it's invoked.
     * @param {boolean} [options.trailing=true]
     *  Specify invoking on the trailing edge of the timeout.
     * @returns {Function} Returns the new debounced function.
     * @example
     *
     * // Avoid costly calculations while the window size is in flux.
     * jQuery(window).on('resize', _.debounce(calculateLayout, 150));
     *
     * // Invoke `sendMail` when clicked, debouncing subsequent calls.
     * jQuery(element).on('click', _.debounce(sendMail, 300, {
     *   'leading': true,
     *   'trailing': false
     * }));
     *
     * // Ensure `batchLog` is invoked once after 1 second of debounced calls.
     * var debounced = _.debounce(batchLog, 250, { 'maxWait': 1000 });
     * var source = new EventSource('/stream');
     * jQuery(source).on('message', debounced);
     *
     * // Cancel the trailing debounced invocation.
     * jQuery(window).on('popstate', debounced.cancel);
     */
    function debounce(func, wait, options) {
      var lastArgs,
          lastThis,
          maxWait,
          result,
          timerId,
          lastCallTime = 0,
          lastInvokeTime = 0,
          leading = false,
          maxing = false,
          trailing = true;

      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      wait = toNumber(wait) || 0;
      if (isObject(options)) {
        leading = !!options.leading;
        maxing = 'maxWait' in options;
        maxWait = maxing ? nativeMax(toNumber(options.maxWait) || 0, wait) : maxWait;
        trailing = 'trailing' in options ? !!options.trailing : trailing;
      }

      function invokeFunc(time) {
        var args = lastArgs,
            thisArg = lastThis;

        lastArgs = lastThis = undefined;
        lastInvokeTime = time;
        result = func.apply(thisArg, args);
        return result;
      }

      function leadingEdge(time) {
        // Reset any `maxWait` timer.
        lastInvokeTime = time;
        // Start the timer for the trailing edge.
        timerId = setTimeout(timerExpired, wait);
        // Invoke the leading edge.
        return leading ? invokeFunc(time) : result;
      }

      function remainingWait(time) {
        var timeSinceLastCall = time - lastCallTime,
            timeSinceLastInvoke = time - lastInvokeTime,
            result = wait - timeSinceLastCall;

        return maxing ? nativeMin(result, maxWait - timeSinceLastInvoke) : result;
      }

      function shouldInvoke(time) {
        var timeSinceLastCall = time - lastCallTime,
            timeSinceLastInvoke = time - lastInvokeTime;

        // Either this is the first call, activity has stopped and we're at the
        // trailing edge, the system time has gone backwards and we're treating
        // it as the trailing edge, or we've hit the `maxWait` limit.
        return (!lastCallTime || (timeSinceLastCall >= wait) ||
          (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait));
      }

      function timerExpired() {
        var time = now();
        if (shouldInvoke(time)) {
          return trailingEdge(time);
        }
        // Restart the timer.
        timerId = setTimeout(timerExpired, remainingWait(time));
      }

      function trailingEdge(time) {
        clearTimeout(timerId);
        timerId = undefined;

        // Only invoke if we have `lastArgs` which means `func` has been
        // debounced at least once.
        if (trailing && lastArgs) {
          return invokeFunc(time);
        }
        lastArgs = lastThis = undefined;
        return result;
      }

      function cancel() {
        if (timerId !== undefined) {
          clearTimeout(timerId);
        }
        lastCallTime = lastInvokeTime = 0;
        lastArgs = lastThis = timerId = undefined;
      }

      function flush() {
        return timerId === undefined ? result : trailingEdge(now());
      }

      function debounced() {
        var time = now(),
            isInvoking = shouldInvoke(time);

        lastArgs = arguments;
        lastThis = this;
        lastCallTime = time;

        if (isInvoking) {
          if (timerId === undefined) {
            return leadingEdge(lastCallTime);
          }
          if (maxing) {
            // Handle invocations in a tight loop.
            clearTimeout(timerId);
            timerId = setTimeout(timerExpired, wait);
            return invokeFunc(lastCallTime);
          }
        }
        if (timerId === undefined) {
          timerId = setTimeout(timerExpired, wait);
        }
        return result;
      }
      debounced.cancel = cancel;
      debounced.flush = flush;
      return debounced;
    }

    /**
     * Defers invoking the `func` until the current call stack has cleared. Any
     * additional arguments are provided to `func` when it's invoked.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to defer.
     * @param {...*} [args] The arguments to invoke `func` with.
     * @returns {number} Returns the timer id.
     * @example
     *
     * _.defer(function(text) {
     *   console.log(text);
     * }, 'deferred');
     * // => Logs 'deferred' after one or more milliseconds.
     */
    var defer = rest(function(func, args) {
      return baseDelay(func, 1, args);
    });

    /**
     * Invokes `func` after `wait` milliseconds. Any additional arguments are
     * provided to `func` when it's invoked.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to delay.
     * @param {number} wait The number of milliseconds to delay invocation.
     * @param {...*} [args] The arguments to invoke `func` with.
     * @returns {number} Returns the timer id.
     * @example
     *
     * _.delay(function(text) {
     *   console.log(text);
     * }, 1000, 'later');
     * // => Logs 'later' after one second.
     */
    var delay = rest(function(func, wait, args) {
      return baseDelay(func, toNumber(wait) || 0, args);
    });

    /**
     * Creates a function that invokes `func` with arguments reversed.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Function
     * @param {Function} func The function to flip arguments for.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var flipped = _.flip(function() {
     *   return _.toArray(arguments);
     * });
     *
     * flipped('a', 'b', 'c', 'd');
     * // => ['d', 'c', 'b', 'a']
     */
    function flip(func) {
      return createWrapper(func, FLIP_FLAG);
    }

    /**
     * Creates a function that memoizes the result of `func`. If `resolver` is
     * provided, it determines the cache key for storing the result based on the
     * arguments provided to the memoized function. By default, the first argument
     * provided to the memoized function is used as the map cache key. The `func`
     * is invoked with the `this` binding of the memoized function.
     *
     * **Note:** The cache is exposed as the `cache` property on the memoized
     * function. Its creation may be customized by replacing the `_.memoize.Cache`
     * constructor with one whose instances implement the
     * [`Map`](http://ecma-international.org/ecma-262/6.0/#sec-properties-of-the-map-prototype-object)
     * method interface of `delete`, `get`, `has`, and `set`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to have its output memoized.
     * @param {Function} [resolver] The function to resolve the cache key.
     * @returns {Function} Returns the new memoizing function.
     * @example
     *
     * var object = { 'a': 1, 'b': 2 };
     * var other = { 'c': 3, 'd': 4 };
     *
     * var values = _.memoize(_.values);
     * values(object);
     * // => [1, 2]
     *
     * values(other);
     * // => [3, 4]
     *
     * object.a = 2;
     * values(object);
     * // => [1, 2]
     *
     * // Modify the result cache.
     * values.cache.set(object, ['a', 'b']);
     * values(object);
     * // => ['a', 'b']
     *
     * // Replace `_.memoize.Cache`.
     * _.memoize.Cache = WeakMap;
     */
    function memoize(func, resolver) {
      if (typeof func != 'function' || (resolver && typeof resolver != 'function')) {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      var memoized = function() {
        var args = arguments,
            key = resolver ? resolver.apply(this, args) : args[0],
            cache = memoized.cache;

        if (cache.has(key)) {
          return cache.get(key);
        }
        var result = func.apply(this, args);
        memoized.cache = cache.set(key, result);
        return result;
      };
      memoized.cache = new (memoize.Cache || MapCache);
      return memoized;
    }

    // Assign cache to `_.memoize`.
    memoize.Cache = MapCache;

    /**
     * Creates a function that negates the result of the predicate `func`. The
     * `func` predicate is invoked with the `this` binding and arguments of the
     * created function.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Function
     * @param {Function} predicate The predicate to negate.
     * @returns {Function} Returns the new function.
     * @example
     *
     * function isEven(n) {
     *   return n % 2 == 0;
     * }
     *
     * _.filter([1, 2, 3, 4, 5, 6], _.negate(isEven));
     * // => [1, 3, 5]
     */
    function negate(predicate) {
      if (typeof predicate != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      return function() {
        return !predicate.apply(this, arguments);
      };
    }

    /**
     * Creates a function that is restricted to invoking `func` once. Repeat calls
     * to the function return the value of the first invocation. The `func` is
     * invoked with the `this` binding and arguments of the created function.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to restrict.
     * @returns {Function} Returns the new restricted function.
     * @example
     *
     * var initialize = _.once(createApplication);
     * initialize();
     * initialize();
     * // `initialize` invokes `createApplication` once
     */
    function once(func) {
      return before(2, func);
    }

    /**
     * Creates a function that invokes `func` with arguments transformed by
     * corresponding `transforms`.
     *
     * @static
     * @since 4.0.0
     * @memberOf _
     * @category Function
     * @param {Function} func The function to wrap.
     * @param {...(Array|Array[]|Function|Function[]|Object|Object[]|string|string[])}
     *  [transforms[_.identity]] The functions to transform.
     * @returns {Function} Returns the new function.
     * @example
     *
     * function doubled(n) {
     *   return n * 2;
     * }
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * var func = _.overArgs(function(x, y) {
     *   return [x, y];
     * }, square, doubled);
     *
     * func(9, 3);
     * // => [81, 6]
     *
     * func(10, 5);
     * // => [100, 10]
     */
    var overArgs = rest(function(func, transforms) {
      transforms = (transforms.length == 1 && isArray(transforms[0]))
        ? arrayMap(transforms[0], baseUnary(getIteratee()))
        : arrayMap(baseFlatten(transforms, 1, isFlattenableIteratee), baseUnary(getIteratee()));

      var funcsLength = transforms.length;
      return rest(function(args) {
        var index = -1,
            length = nativeMin(args.length, funcsLength);

        while (++index < length) {
          args[index] = transforms[index].call(this, args[index]);
        }
        return apply(func, this, args);
      });
    });

    /**
     * Creates a function that invokes `func` with `partials` prepended to the
     * arguments it receives. This method is like `_.bind` except it does **not**
     * alter the `this` binding.
     *
     * The `_.partial.placeholder` value, which defaults to `_` in monolithic
     * builds, may be used as a placeholder for partially applied arguments.
     *
     * **Note:** This method doesn't set the "length" property of partially
     * applied functions.
     *
     * @static
     * @memberOf _
     * @since 0.2.0
     * @category Function
     * @param {Function} func The function to partially apply arguments to.
     * @param {...*} [partials] The arguments to be partially applied.
     * @returns {Function} Returns the new partially applied function.
     * @example
     *
     * var greet = function(greeting, name) {
     *   return greeting + ' ' + name;
     * };
     *
     * var sayHelloTo = _.partial(greet, 'hello');
     * sayHelloTo('fred');
     * // => 'hello fred'
     *
     * // Partially applied with placeholders.
     * var greetFred = _.partial(greet, _, 'fred');
     * greetFred('hi');
     * // => 'hi fred'
     */
    var partial = rest(function(func, partials) {
      var holders = replaceHolders(partials, getPlaceholder(partial));
      return createWrapper(func, PARTIAL_FLAG, undefined, partials, holders);
    });

    /**
     * This method is like `_.partial` except that partially applied arguments
     * are appended to the arguments it receives.
     *
     * The `_.partialRight.placeholder` value, which defaults to `_` in monolithic
     * builds, may be used as a placeholder for partially applied arguments.
     *
     * **Note:** This method doesn't set the "length" property of partially
     * applied functions.
     *
     * @static
     * @memberOf _
     * @since 1.0.0
     * @category Function
     * @param {Function} func The function to partially apply arguments to.
     * @param {...*} [partials] The arguments to be partially applied.
     * @returns {Function} Returns the new partially applied function.
     * @example
     *
     * var greet = function(greeting, name) {
     *   return greeting + ' ' + name;
     * };
     *
     * var greetFred = _.partialRight(greet, 'fred');
     * greetFred('hi');
     * // => 'hi fred'
     *
     * // Partially applied with placeholders.
     * var sayHelloTo = _.partialRight(greet, 'hello', _);
     * sayHelloTo('fred');
     * // => 'hello fred'
     */
    var partialRight = rest(function(func, partials) {
      var holders = replaceHolders(partials, getPlaceholder(partialRight));
      return createWrapper(func, PARTIAL_RIGHT_FLAG, undefined, partials, holders);
    });

    /**
     * Creates a function that invokes `func` with arguments arranged according
     * to the specified `indexes` where the argument value at the first index is
     * provided as the first argument, the argument value at the second index is
     * provided as the second argument, and so on.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Function
     * @param {Function} func The function to rearrange arguments for.
     * @param {...(number|number[])} indexes The arranged argument indexes.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var rearged = _.rearg(function(a, b, c) {
     *   return [a, b, c];
     * }, 2, 0, 1);
     *
     * rearged('b', 'c', 'a')
     * // => ['a', 'b', 'c']
     */
    var rearg = rest(function(func, indexes) {
      return createWrapper(func, REARG_FLAG, undefined, undefined, undefined, baseFlatten(indexes, 1));
    });

    /**
     * Creates a function that invokes `func` with the `this` binding of the
     * created function and arguments from `start` and beyond provided as
     * an array.
     *
     * **Note:** This method is based on the
     * [rest parameter](https://mdn.io/rest_parameters).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Function
     * @param {Function} func The function to apply a rest parameter to.
     * @param {number} [start=func.length-1] The start position of the rest parameter.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var say = _.rest(function(what, names) {
     *   return what + ' ' + _.initial(names).join(', ') +
     *     (_.size(names) > 1 ? ', & ' : '') + _.last(names);
     * });
     *
     * say('hello', 'fred', 'barney', 'pebbles');
     * // => 'hello fred, barney, & pebbles'
     */
    function rest(func, start) {
      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      start = nativeMax(start === undefined ? (func.length - 1) : toInteger(start), 0);
      return function() {
        var args = arguments,
            index = -1,
            length = nativeMax(args.length - start, 0),
            array = Array(length);

        while (++index < length) {
          array[index] = args[start + index];
        }
        switch (start) {
          case 0: return func.call(this, array);
          case 1: return func.call(this, args[0], array);
          case 2: return func.call(this, args[0], args[1], array);
        }
        var otherArgs = Array(start + 1);
        index = -1;
        while (++index < start) {
          otherArgs[index] = args[index];
        }
        otherArgs[start] = array;
        return apply(func, this, otherArgs);
      };
    }

    /**
     * Creates a function that invokes `func` with the `this` binding of the
     * create function and an array of arguments much like
     * [`Function#apply`](http://www.ecma-international.org/ecma-262/6.0/#sec-function.prototype.apply).
     *
     * **Note:** This method is based on the
     * [spread operator](https://mdn.io/spread_operator).
     *
     * @static
     * @memberOf _
     * @since 3.2.0
     * @category Function
     * @param {Function} func The function to spread arguments over.
     * @param {number} [start=0] The start position of the spread.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var say = _.spread(function(who, what) {
     *   return who + ' says ' + what;
     * });
     *
     * say(['fred', 'hello']);
     * // => 'fred says hello'
     *
     * var numbers = Promise.all([
     *   Promise.resolve(40),
     *   Promise.resolve(36)
     * ]);
     *
     * numbers.then(_.spread(function(x, y) {
     *   return x + y;
     * }));
     * // => a Promise of 76
     */
    function spread(func, start) {
      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      start = start === undefined ? 0 : nativeMax(toInteger(start), 0);
      return rest(function(args) {
        var array = args[start],
            otherArgs = castSlice(args, 0, start);

        if (array) {
          arrayPush(otherArgs, array);
        }
        return apply(func, this, otherArgs);
      });
    }

    /**
     * Creates a throttled function that only invokes `func` at most once per
     * every `wait` milliseconds. The throttled function comes with a `cancel`
     * method to cancel delayed `func` invocations and a `flush` method to
     * immediately invoke them. Provide an options object to indicate whether
     * `func` should be invoked on the leading and/or trailing edge of the `wait`
     * timeout. The `func` is invoked with the last arguments provided to the
     * throttled function. Subsequent calls to the throttled function return the
     * result of the last `func` invocation.
     *
     * **Note:** If `leading` and `trailing` options are `true`, `func` is
     * invoked on the trailing edge of the timeout only if the throttled function
     * is invoked more than once during the `wait` timeout.
     *
     * See [David Corbacho's article](https://css-tricks.com/debouncing-throttling-explained-examples/)
     * for details over the differences between `_.throttle` and `_.debounce`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {Function} func The function to throttle.
     * @param {number} [wait=0] The number of milliseconds to throttle invocations to.
     * @param {Object} [options={}] The options object.
     * @param {boolean} [options.leading=true]
     *  Specify invoking on the leading edge of the timeout.
     * @param {boolean} [options.trailing=true]
     *  Specify invoking on the trailing edge of the timeout.
     * @returns {Function} Returns the new throttled function.
     * @example
     *
     * // Avoid excessively updating the position while scrolling.
     * jQuery(window).on('scroll', _.throttle(updatePosition, 100));
     *
     * // Invoke `renewToken` when the click event is fired, but not more than once every 5 minutes.
     * var throttled = _.throttle(renewToken, 300000, { 'trailing': false });
     * jQuery(element).on('click', throttled);
     *
     * // Cancel the trailing throttled invocation.
     * jQuery(window).on('popstate', throttled.cancel);
     */
    function throttle(func, wait, options) {
      var leading = true,
          trailing = true;

      if (typeof func != 'function') {
        throw new TypeError(FUNC_ERROR_TEXT);
      }
      if (isObject(options)) {
        leading = 'leading' in options ? !!options.leading : leading;
        trailing = 'trailing' in options ? !!options.trailing : trailing;
      }
      return debounce(func, wait, {
        'leading': leading,
        'maxWait': wait,
        'trailing': trailing
      });
    }

    /**
     * Creates a function that accepts up to one argument, ignoring any
     * additional arguments.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Function
     * @param {Function} func The function to cap arguments for.
     * @returns {Function} Returns the new function.
     * @example
     *
     * _.map(['6', '8', '10'], _.unary(parseInt));
     * // => [6, 8, 10]
     */
    function unary(func) {
      return ary(func, 1);
    }

    /**
     * Creates a function that provides `value` to the wrapper function as its
     * first argument. Any additional arguments provided to the function are
     * appended to those provided to the wrapper function. The wrapper is invoked
     * with the `this` binding of the created function.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Function
     * @param {*} value The value to wrap.
     * @param {Function} [wrapper=identity] The wrapper function.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var p = _.wrap(_.escape, function(func, text) {
     *   return '<p>' + func(text) + '</p>';
     * });
     *
     * p('fred, barney, & pebbles');
     * // => '<p>fred, barney, &amp; pebbles</p>'
     */
    function wrap(value, wrapper) {
      wrapper = wrapper == null ? identity : wrapper;
      return partial(wrapper, value);
    }

    /*------------------------------------------------------------------------*/

    /**
     * Casts `value` as an array if it's not one.
     *
     * @static
     * @memberOf _
     * @since 4.4.0
     * @category Lang
     * @param {*} value The value to inspect.
     * @returns {Array} Returns the cast array.
     * @example
     *
     * _.castArray(1);
     * // => [1]
     *
     * _.castArray({ 'a': 1 });
     * // => [{ 'a': 1 }]
     *
     * _.castArray('abc');
     * // => ['abc']
     *
     * _.castArray(null);
     * // => [null]
     *
     * _.castArray(undefined);
     * // => [undefined]
     *
     * _.castArray();
     * // => []
     *
     * var array = [1, 2, 3];
     * console.log(_.castArray(array) === array);
     * // => true
     */
    function castArray() {
      if (!arguments.length) {
        return [];
      }
      var value = arguments[0];
      return isArray(value) ? value : [value];
    }

    /**
     * Creates a shallow clone of `value`.
     *
     * **Note:** This method is loosely based on the
     * [structured clone algorithm](https://mdn.io/Structured_clone_algorithm)
     * and supports cloning arrays, array buffers, booleans, date objects, maps,
     * numbers, `Object` objects, regexes, sets, strings, symbols, and typed
     * arrays. The own enumerable properties of `arguments` objects are cloned
     * as plain objects. An empty object is returned for uncloneable values such
     * as error objects, functions, DOM nodes, and WeakMaps.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to clone.
     * @returns {*} Returns the cloned value.
     * @example
     *
     * var objects = [{ 'a': 1 }, { 'b': 2 }];
     *
     * var shallow = _.clone(objects);
     * console.log(shallow[0] === objects[0]);
     * // => true
     */
    function clone(value) {
      return baseClone(value, false, true);
    }

    /**
     * This method is like `_.clone` except that it accepts `customizer` which
     * is invoked to produce the cloned value. If `customizer` returns `undefined`,
     * cloning is handled by the method instead. The `customizer` is invoked with
     * up to four arguments; (value [, index|key, object, stack]).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to clone.
     * @param {Function} [customizer] The function to customize cloning.
     * @returns {*} Returns the cloned value.
     * @example
     *
     * function customizer(value) {
     *   if (_.isElement(value)) {
     *     return value.cloneNode(false);
     *   }
     * }
     *
     * var el = _.cloneWith(document.body, customizer);
     *
     * console.log(el === document.body);
     * // => false
     * console.log(el.nodeName);
     * // => 'BODY'
     * console.log(el.childNodes.length);
     * // => 0
     */
    function cloneWith(value, customizer) {
      return baseClone(value, false, true, customizer);
    }

    /**
     * This method is like `_.clone` except that it recursively clones `value`.
     *
     * @static
     * @memberOf _
     * @since 1.0.0
     * @category Lang
     * @param {*} value The value to recursively clone.
     * @returns {*} Returns the deep cloned value.
     * @example
     *
     * var objects = [{ 'a': 1 }, { 'b': 2 }];
     *
     * var deep = _.cloneDeep(objects);
     * console.log(deep[0] === objects[0]);
     * // => false
     */
    function cloneDeep(value) {
      return baseClone(value, true, true);
    }

    /**
     * This method is like `_.cloneWith` except that it recursively clones `value`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to recursively clone.
     * @param {Function} [customizer] The function to customize cloning.
     * @returns {*} Returns the deep cloned value.
     * @example
     *
     * function customizer(value) {
     *   if (_.isElement(value)) {
     *     return value.cloneNode(true);
     *   }
     * }
     *
     * var el = _.cloneDeepWith(document.body, customizer);
     *
     * console.log(el === document.body);
     * // => false
     * console.log(el.nodeName);
     * // => 'BODY'
     * console.log(el.childNodes.length);
     * // => 20
     */
    function cloneDeepWith(value, customizer) {
      return baseClone(value, true, true, customizer);
    }

    /**
     * Performs a
     * [`SameValueZero`](http://ecma-international.org/ecma-262/6.0/#sec-samevaluezero)
     * comparison between two values to determine if they are equivalent.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if the values are equivalent, else `false`.
     * @example
     *
     * var object = { 'user': 'fred' };
     * var other = { 'user': 'fred' };
     *
     * _.eq(object, object);
     * // => true
     *
     * _.eq(object, other);
     * // => false
     *
     * _.eq('a', 'a');
     * // => true
     *
     * _.eq('a', Object('a'));
     * // => false
     *
     * _.eq(NaN, NaN);
     * // => true
     */
    function eq(value, other) {
      return value === other || (value !== value && other !== other);
    }

    /**
     * Checks if `value` is greater than `other`.
     *
     * @static
     * @memberOf _
     * @since 3.9.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if `value` is greater than `other`,
     *  else `false`.
     * @example
     *
     * _.gt(3, 1);
     * // => true
     *
     * _.gt(3, 3);
     * // => false
     *
     * _.gt(1, 3);
     * // => false
     */
    function gt(value, other) {
      return value > other;
    }

    /**
     * Checks if `value` is greater than or equal to `other`.
     *
     * @static
     * @memberOf _
     * @since 3.9.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if `value` is greater than or equal to
     *  `other`, else `false`.
     * @example
     *
     * _.gte(3, 1);
     * // => true
     *
     * _.gte(3, 3);
     * // => true
     *
     * _.gte(1, 3);
     * // => false
     */
    function gte(value, other) {
      return value >= other;
    }

    /**
     * Checks if `value` is likely an `arguments` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isArguments(function() { return arguments; }());
     * // => true
     *
     * _.isArguments([1, 2, 3]);
     * // => false
     */
    function isArguments(value) {
      // Safari 8.1 incorrectly makes `arguments.callee` enumerable in strict mode.
      return isArrayLikeObject(value) && hasOwnProperty.call(value, 'callee') &&
        (!propertyIsEnumerable.call(value, 'callee') || objectToString.call(value) == argsTag);
    }

    /**
     * Checks if `value` is classified as an `Array` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @type {Function}
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isArray([1, 2, 3]);
     * // => true
     *
     * _.isArray(document.body.children);
     * // => false
     *
     * _.isArray('abc');
     * // => false
     *
     * _.isArray(_.noop);
     * // => false
     */
    var isArray = Array.isArray;

    /**
     * Checks if `value` is classified as an `ArrayBuffer` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isArrayBuffer(new ArrayBuffer(2));
     * // => true
     *
     * _.isArrayBuffer(new Array(2));
     * // => false
     */
    function isArrayBuffer(value) {
      return isObjectLike(value) && objectToString.call(value) == arrayBufferTag;
    }

    /**
     * Checks if `value` is array-like. A value is considered array-like if it's
     * not a function and has a `value.length` that's an integer greater than or
     * equal to `0` and less than or equal to `Number.MAX_SAFE_INTEGER`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is array-like, else `false`.
     * @example
     *
     * _.isArrayLike([1, 2, 3]);
     * // => true
     *
     * _.isArrayLike(document.body.children);
     * // => true
     *
     * _.isArrayLike('abc');
     * // => true
     *
     * _.isArrayLike(_.noop);
     * // => false
     */
    function isArrayLike(value) {
      return value != null && isLength(getLength(value)) && !isFunction(value);
    }

    /**
     * This method is like `_.isArrayLike` except that it also checks if `value`
     * is an object.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an array-like object,
     *  else `false`.
     * @example
     *
     * _.isArrayLikeObject([1, 2, 3]);
     * // => true
     *
     * _.isArrayLikeObject(document.body.children);
     * // => true
     *
     * _.isArrayLikeObject('abc');
     * // => false
     *
     * _.isArrayLikeObject(_.noop);
     * // => false
     */
    function isArrayLikeObject(value) {
      return isObjectLike(value) && isArrayLike(value);
    }

    /**
     * Checks if `value` is classified as a boolean primitive or object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isBoolean(false);
     * // => true
     *
     * _.isBoolean(null);
     * // => false
     */
    function isBoolean(value) {
      return value === true || value === false ||
        (isObjectLike(value) && objectToString.call(value) == boolTag);
    }

    /**
     * Checks if `value` is a buffer.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a buffer, else `false`.
     * @example
     *
     * _.isBuffer(new Buffer(2));
     * // => true
     *
     * _.isBuffer(new Uint8Array(2));
     * // => false
     */
    var isBuffer = !Buffer ? constant(false) : function(value) {
      return value instanceof Buffer;
    };

    /**
     * Checks if `value` is classified as a `Date` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isDate(new Date);
     * // => true
     *
     * _.isDate('Mon April 23 2012');
     * // => false
     */
    function isDate(value) {
      return isObjectLike(value) && objectToString.call(value) == dateTag;
    }

    /**
     * Checks if `value` is likely a DOM element.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a DOM element,
     *  else `false`.
     * @example
     *
     * _.isElement(document.body);
     * // => true
     *
     * _.isElement('<body>');
     * // => false
     */
    function isElement(value) {
      return !!value && value.nodeType === 1 && isObjectLike(value) && !isPlainObject(value);
    }

    /**
     * Checks if `value` is an empty object, collection, map, or set.
     *
     * Objects are considered empty if they have no own enumerable string keyed
     * properties.
     *
     * Array-like values such as `arguments` objects, arrays, buffers, strings, or
     * jQuery-like collections are considered empty if they have a `length` of `0`.
     * Similarly, maps and sets are considered empty if they have a `size` of `0`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is empty, else `false`.
     * @example
     *
     * _.isEmpty(null);
     * // => true
     *
     * _.isEmpty(true);
     * // => true
     *
     * _.isEmpty(1);
     * // => true
     *
     * _.isEmpty([1, 2, 3]);
     * // => false
     *
     * _.isEmpty({ 'a': 1 });
     * // => false
     */
    function isEmpty(value) {
      if (isArrayLike(value) &&
          (isArray(value) || isString(value) || isFunction(value.splice) ||
            isArguments(value) || isBuffer(value))) {
        return !value.length;
      }
      if (isObjectLike(value)) {
        var tag = getTag(value);
        if (tag == mapTag || tag == setTag) {
          return !value.size;
        }
      }
      for (var key in value) {
        if (hasOwnProperty.call(value, key)) {
          return false;
        }
      }
      return !(nonEnumShadows && keys(value).length);
    }

    /**
     * Performs a deep comparison between two values to determine if they are
     * equivalent.
     *
     * **Note:** This method supports comparing arrays, array buffers, booleans,
     * date objects, error objects, maps, numbers, `Object` objects, regexes,
     * sets, strings, symbols, and typed arrays. `Object` objects are compared
     * by their own, not inherited, enumerable properties. Functions and DOM
     * nodes are **not** supported.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if the values are equivalent,
     *  else `false`.
     * @example
     *
     * var object = { 'user': 'fred' };
     * var other = { 'user': 'fred' };
     *
     * _.isEqual(object, other);
     * // => true
     *
     * object === other;
     * // => false
     */
    function isEqual(value, other) {
      return baseIsEqual(value, other);
    }

    /**
     * This method is like `_.isEqual` except that it accepts `customizer` which
     * is invoked to compare values. If `customizer` returns `undefined`, comparisons
     * are handled by the method instead. The `customizer` is invoked with up to
     * six arguments: (objValue, othValue [, index|key, object, other, stack]).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @param {Function} [customizer] The function to customize comparisons.
     * @returns {boolean} Returns `true` if the values are equivalent,
     *  else `false`.
     * @example
     *
     * function isGreeting(value) {
     *   return /^h(?:i|ello)$/.test(value);
     * }
     *
     * function customizer(objValue, othValue) {
     *   if (isGreeting(objValue) && isGreeting(othValue)) {
     *     return true;
     *   }
     * }
     *
     * var array = ['hello', 'goodbye'];
     * var other = ['hi', 'goodbye'];
     *
     * _.isEqualWith(array, other, customizer);
     * // => true
     */
    function isEqualWith(value, other, customizer) {
      customizer = typeof customizer == 'function' ? customizer : undefined;
      var result = customizer ? customizer(value, other) : undefined;
      return result === undefined ? baseIsEqual(value, other, customizer) : !!result;
    }

    /**
     * Checks if `value` is an `Error`, `EvalError`, `RangeError`, `ReferenceError`,
     * `SyntaxError`, `TypeError`, or `URIError` object.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an error object,
     *  else `false`.
     * @example
     *
     * _.isError(new Error);
     * // => true
     *
     * _.isError(Error);
     * // => false
     */
    function isError(value) {
      if (!isObjectLike(value)) {
        return false;
      }
      return (objectToString.call(value) == errorTag) ||
        (typeof value.message == 'string' && typeof value.name == 'string');
    }

    /**
     * Checks if `value` is a finite primitive number.
     *
     * **Note:** This method is based on
     * [`Number.isFinite`](https://mdn.io/Number/isFinite).
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a finite number,
     *  else `false`.
     * @example
     *
     * _.isFinite(3);
     * // => true
     *
     * _.isFinite(Number.MAX_VALUE);
     * // => true
     *
     * _.isFinite(3.14);
     * // => true
     *
     * _.isFinite(Infinity);
     * // => false
     */
    function isFinite(value) {
      return typeof value == 'number' && nativeIsFinite(value);
    }

    /**
     * Checks if `value` is classified as a `Function` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isFunction(_);
     * // => true
     *
     * _.isFunction(/abc/);
     * // => false
     */
    function isFunction(value) {
      // The use of `Object#toString` avoids issues with the `typeof` operator
      // in Safari 8 which returns 'object' for typed array and weak map constructors,
      // and PhantomJS 1.9 which returns 'function' for `NodeList` instances.
      var tag = isObject(value) ? objectToString.call(value) : '';
      return tag == funcTag || tag == genTag;
    }

    /**
     * Checks if `value` is an integer.
     *
     * **Note:** This method is based on
     * [`Number.isInteger`](https://mdn.io/Number/isInteger).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an integer, else `false`.
     * @example
     *
     * _.isInteger(3);
     * // => true
     *
     * _.isInteger(Number.MIN_VALUE);
     * // => false
     *
     * _.isInteger(Infinity);
     * // => false
     *
     * _.isInteger('3');
     * // => false
     */
    function isInteger(value) {
      return typeof value == 'number' && value == toInteger(value);
    }

    /**
     * Checks if `value` is a valid array-like length.
     *
     * **Note:** This function is loosely based on
     * [`ToLength`](http://ecma-international.org/ecma-262/6.0/#sec-tolength).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a valid length,
     *  else `false`.
     * @example
     *
     * _.isLength(3);
     * // => true
     *
     * _.isLength(Number.MIN_VALUE);
     * // => false
     *
     * _.isLength(Infinity);
     * // => false
     *
     * _.isLength('3');
     * // => false
     */
    function isLength(value) {
      return typeof value == 'number' &&
        value > -1 && value % 1 == 0 && value <= MAX_SAFE_INTEGER;
    }

    /**
     * Checks if `value` is the
     * [language type](http://www.ecma-international.org/ecma-262/6.0/#sec-ecmascript-language-types)
     * of `Object`. (e.g. arrays, functions, objects, regexes, `new Number(0)`, and `new String('')`)
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an object, else `false`.
     * @example
     *
     * _.isObject({});
     * // => true
     *
     * _.isObject([1, 2, 3]);
     * // => true
     *
     * _.isObject(_.noop);
     * // => true
     *
     * _.isObject(null);
     * // => false
     */
    function isObject(value) {
      var type = typeof value;
      return !!value && (type == 'object' || type == 'function');
    }

    /**
     * Checks if `value` is object-like. A value is object-like if it's not `null`
     * and has a `typeof` result of "object".
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is object-like, else `false`.
     * @example
     *
     * _.isObjectLike({});
     * // => true
     *
     * _.isObjectLike([1, 2, 3]);
     * // => true
     *
     * _.isObjectLike(_.noop);
     * // => false
     *
     * _.isObjectLike(null);
     * // => false
     */
    function isObjectLike(value) {
      return !!value && typeof value == 'object';
    }

    /**
     * Checks if `value` is classified as a `Map` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isMap(new Map);
     * // => true
     *
     * _.isMap(new WeakMap);
     * // => false
     */
    function isMap(value) {
      return isObjectLike(value) && getTag(value) == mapTag;
    }

    /**
     * Performs a partial deep comparison between `object` and `source` to
     * determine if `object` contains equivalent property values. This method is
     * equivalent to a `_.matches` function when `source` is partially applied.
     *
     * **Note:** This method supports comparing the same values as `_.isEqual`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {Object} object The object to inspect.
     * @param {Object} source The object of property values to match.
     * @returns {boolean} Returns `true` if `object` is a match, else `false`.
     * @example
     *
     * var object = { 'user': 'fred', 'age': 40 };
     *
     * _.isMatch(object, { 'age': 40 });
     * // => true
     *
     * _.isMatch(object, { 'age': 36 });
     * // => false
     */
    function isMatch(object, source) {
      return object === source || baseIsMatch(object, source, getMatchData(source));
    }

    /**
     * This method is like `_.isMatch` except that it accepts `customizer` which
     * is invoked to compare values. If `customizer` returns `undefined`, comparisons
     * are handled by the method instead. The `customizer` is invoked with five
     * arguments: (objValue, srcValue, index|key, object, source).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {Object} object The object to inspect.
     * @param {Object} source The object of property values to match.
     * @param {Function} [customizer] The function to customize comparisons.
     * @returns {boolean} Returns `true` if `object` is a match, else `false`.
     * @example
     *
     * function isGreeting(value) {
     *   return /^h(?:i|ello)$/.test(value);
     * }
     *
     * function customizer(objValue, srcValue) {
     *   if (isGreeting(objValue) && isGreeting(srcValue)) {
     *     return true;
     *   }
     * }
     *
     * var object = { 'greeting': 'hello' };
     * var source = { 'greeting': 'hi' };
     *
     * _.isMatchWith(object, source, customizer);
     * // => true
     */
    function isMatchWith(object, source, customizer) {
      customizer = typeof customizer == 'function' ? customizer : undefined;
      return baseIsMatch(object, source, getMatchData(source), customizer);
    }

    /**
     * Checks if `value` is `NaN`.
     *
     * **Note:** This method is based on
     * [`Number.isNaN`](https://mdn.io/Number/isNaN) and is not the same as
     * global [`isNaN`](https://mdn.io/isNaN) which returns `true` for
     * `undefined` and other non-number values.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is `NaN`, else `false`.
     * @example
     *
     * _.isNaN(NaN);
     * // => true
     *
     * _.isNaN(new Number(NaN));
     * // => true
     *
     * isNaN(undefined);
     * // => true
     *
     * _.isNaN(undefined);
     * // => false
     */
    function isNaN(value) {
      // An `NaN` primitive is the only value that is not equal to itself.
      // Perform the `toStringTag` check first to avoid errors with some
      // ActiveX objects in IE.
      return isNumber(value) && value != +value;
    }

    /**
     * Checks if `value` is a native function.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a native function,
     *  else `false`.
     * @example
     *
     * _.isNative(Array.prototype.push);
     * // => true
     *
     * _.isNative(_);
     * // => false
     */
    function isNative(value) {
      if (!isObject(value)) {
        return false;
      }
      var pattern = (isFunction(value) || isHostObject(value)) ? reIsNative : reIsHostCtor;
      return pattern.test(toSource(value));
    }

    /**
     * Checks if `value` is `null`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is `null`, else `false`.
     * @example
     *
     * _.isNull(null);
     * // => true
     *
     * _.isNull(void 0);
     * // => false
     */
    function isNull(value) {
      return value === null;
    }

    /**
     * Checks if `value` is `null` or `undefined`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is nullish, else `false`.
     * @example
     *
     * _.isNil(null);
     * // => true
     *
     * _.isNil(void 0);
     * // => true
     *
     * _.isNil(NaN);
     * // => false
     */
    function isNil(value) {
      return value == null;
    }

    /**
     * Checks if `value` is classified as a `Number` primitive or object.
     *
     * **Note:** To exclude `Infinity`, `-Infinity`, and `NaN`, which are
     * classified as numbers, use the `_.isFinite` method.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isNumber(3);
     * // => true
     *
     * _.isNumber(Number.MIN_VALUE);
     * // => true
     *
     * _.isNumber(Infinity);
     * // => true
     *
     * _.isNumber('3');
     * // => false
     */
    function isNumber(value) {
      return typeof value == 'number' ||
        (isObjectLike(value) && objectToString.call(value) == numberTag);
    }

    /**
     * Checks if `value` is a plain object, that is, an object created by the
     * `Object` constructor or one with a `[[Prototype]]` of `null`.
     *
     * @static
     * @memberOf _
     * @since 0.8.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a plain object,
     *  else `false`.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     * }
     *
     * _.isPlainObject(new Foo);
     * // => false
     *
     * _.isPlainObject([1, 2, 3]);
     * // => false
     *
     * _.isPlainObject({ 'x': 0, 'y': 0 });
     * // => true
     *
     * _.isPlainObject(Object.create(null));
     * // => true
     */
    function isPlainObject(value) {
      if (!isObjectLike(value) ||
          objectToString.call(value) != objectTag || isHostObject(value)) {
        return false;
      }
      var proto = getPrototype(value);
      if (proto === null) {
        return true;
      }
      var Ctor = hasOwnProperty.call(proto, 'constructor') && proto.constructor;
      return (typeof Ctor == 'function' &&
        Ctor instanceof Ctor && funcToString.call(Ctor) == objectCtorString);
    }

    /**
     * Checks if `value` is classified as a `RegExp` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isRegExp(/abc/);
     * // => true
     *
     * _.isRegExp('/abc/');
     * // => false
     */
    function isRegExp(value) {
      return isObject(value) && objectToString.call(value) == regexpTag;
    }

    /**
     * Checks if `value` is a safe integer. An integer is safe if it's an IEEE-754
     * double precision number which isn't the result of a rounded unsafe integer.
     *
     * **Note:** This method is based on
     * [`Number.isSafeInteger`](https://mdn.io/Number/isSafeInteger).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a safe integer,
     *  else `false`.
     * @example
     *
     * _.isSafeInteger(3);
     * // => true
     *
     * _.isSafeInteger(Number.MIN_VALUE);
     * // => false
     *
     * _.isSafeInteger(Infinity);
     * // => false
     *
     * _.isSafeInteger('3');
     * // => false
     */
    function isSafeInteger(value) {
      return isInteger(value) && value >= -MAX_SAFE_INTEGER && value <= MAX_SAFE_INTEGER;
    }

    /**
     * Checks if `value` is classified as a `Set` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isSet(new Set);
     * // => true
     *
     * _.isSet(new WeakSet);
     * // => false
     */
    function isSet(value) {
      return isObjectLike(value) && getTag(value) == setTag;
    }

    /**
     * Checks if `value` is classified as a `String` primitive or object.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isString('abc');
     * // => true
     *
     * _.isString(1);
     * // => false
     */
    function isString(value) {
      return typeof value == 'string' ||
        (!isArray(value) && isObjectLike(value) && objectToString.call(value) == stringTag);
    }

    /**
     * Checks if `value` is classified as a `Symbol` primitive or object.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isSymbol(Symbol.iterator);
     * // => true
     *
     * _.isSymbol('abc');
     * // => false
     */
    function isSymbol(value) {
      return typeof value == 'symbol' ||
        (isObjectLike(value) && objectToString.call(value) == symbolTag);
    }

    /**
     * Checks if `value` is classified as a typed array.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isTypedArray(new Uint8Array);
     * // => true
     *
     * _.isTypedArray([]);
     * // => false
     */
    function isTypedArray(value) {
      return isObjectLike(value) &&
        isLength(value.length) && !!typedArrayTags[objectToString.call(value)];
    }

    /**
     * Checks if `value` is `undefined`.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is `undefined`, else `false`.
     * @example
     *
     * _.isUndefined(void 0);
     * // => true
     *
     * _.isUndefined(null);
     * // => false
     */
    function isUndefined(value) {
      return value === undefined;
    }

    /**
     * Checks if `value` is classified as a `WeakMap` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isWeakMap(new WeakMap);
     * // => true
     *
     * _.isWeakMap(new Map);
     * // => false
     */
    function isWeakMap(value) {
      return isObjectLike(value) && getTag(value) == weakMapTag;
    }

    /**
     * Checks if `value` is classified as a `WeakSet` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is correctly classified,
     *  else `false`.
     * @example
     *
     * _.isWeakSet(new WeakSet);
     * // => true
     *
     * _.isWeakSet(new Set);
     * // => false
     */
    function isWeakSet(value) {
      return isObjectLike(value) && objectToString.call(value) == weakSetTag;
    }

    /**
     * Checks if `value` is less than `other`.
     *
     * @static
     * @memberOf _
     * @since 3.9.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if `value` is less than `other`,
     *  else `false`.
     * @example
     *
     * _.lt(1, 3);
     * // => true
     *
     * _.lt(3, 3);
     * // => false
     *
     * _.lt(3, 1);
     * // => false
     */
    function lt(value, other) {
      return value < other;
    }

    /**
     * Checks if `value` is less than or equal to `other`.
     *
     * @static
     * @memberOf _
     * @since 3.9.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if `value` is less than or equal to
     *  `other`, else `false`.
     * @example
     *
     * _.lte(1, 3);
     * // => true
     *
     * _.lte(3, 3);
     * // => true
     *
     * _.lte(3, 1);
     * // => false
     */
    function lte(value, other) {
      return value <= other;
    }

    /**
     * Converts `value` to an array.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Lang
     * @param {*} value The value to convert.
     * @returns {Array} Returns the converted array.
     * @example
     *
     * _.toArray({ 'a': 1, 'b': 2 });
     * // => [1, 2]
     *
     * _.toArray('abc');
     * // => ['a', 'b', 'c']
     *
     * _.toArray(1);
     * // => []
     *
     * _.toArray(null);
     * // => []
     */
    function toArray(value) {
      if (!value) {
        return [];
      }
      if (isArrayLike(value)) {
        return isString(value) ? stringToArray(value) : copyArray(value);
      }
      if (iteratorSymbol && value[iteratorSymbol]) {
        return iteratorToArray(value[iteratorSymbol]());
      }
      var tag = getTag(value),
          func = tag == mapTag ? mapToArray : (tag == setTag ? setToArray : values);

      return func(value);
    }

    /**
     * Converts `value` to an integer.
     *
     * **Note:** This function is loosely based on
     * [`ToInteger`](http://www.ecma-international.org/ecma-262/6.0/#sec-tointeger).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to convert.
     * @returns {number} Returns the converted integer.
     * @example
     *
     * _.toInteger(3);
     * // => 3
     *
     * _.toInteger(Number.MIN_VALUE);
     * // => 0
     *
     * _.toInteger(Infinity);
     * // => 1.7976931348623157e+308
     *
     * _.toInteger('3');
     * // => 3
     */
    function toInteger(value) {
      if (!value) {
        return value === 0 ? value : 0;
      }
      value = toNumber(value);
      if (value === INFINITY || value === -INFINITY) {
        var sign = (value < 0 ? -1 : 1);
        return sign * MAX_INTEGER;
      }
      var remainder = value % 1;
      return value === value ? (remainder ? value - remainder : value) : 0;
    }

    /**
     * Converts `value` to an integer suitable for use as the length of an
     * array-like object.
     *
     * **Note:** This method is based on
     * [`ToLength`](http://ecma-international.org/ecma-262/6.0/#sec-tolength).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to convert.
     * @returns {number} Returns the converted integer.
     * @example
     *
     * _.toLength(3);
     * // => 3
     *
     * _.toLength(Number.MIN_VALUE);
     * // => 0
     *
     * _.toLength(Infinity);
     * // => 4294967295
     *
     * _.toLength('3');
     * // => 3
     */
    function toLength(value) {
      return value ? baseClamp(toInteger(value), 0, MAX_ARRAY_LENGTH) : 0;
    }

    /**
     * Converts `value` to a number.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to process.
     * @returns {number} Returns the number.
     * @example
     *
     * _.toNumber(3);
     * // => 3
     *
     * _.toNumber(Number.MIN_VALUE);
     * // => 5e-324
     *
     * _.toNumber(Infinity);
     * // => Infinity
     *
     * _.toNumber('3');
     * // => 3
     */
    function toNumber(value) {
      if (typeof value == 'number') {
        return value;
      }
      if (isSymbol(value)) {
        return NAN;
      }
      if (isObject(value)) {
        var other = isFunction(value.valueOf) ? value.valueOf() : value;
        value = isObject(other) ? (other + '') : other;
      }
      if (typeof value != 'string') {
        return value === 0 ? value : +value;
      }
      value = value.replace(reTrim, '');
      var isBinary = reIsBinary.test(value);
      return (isBinary || reIsOctal.test(value))
        ? freeParseInt(value.slice(2), isBinary ? 2 : 8)
        : (reIsBadHex.test(value) ? NAN : +value);
    }

    /**
     * Converts `value` to a plain object flattening inherited enumerable string
     * keyed properties of `value` to own properties of the plain object.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {*} value The value to convert.
     * @returns {Object} Returns the converted plain object.
     * @example
     *
     * function Foo() {
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.assign({ 'a': 1 }, new Foo);
     * // => { 'a': 1, 'b': 2 }
     *
     * _.assign({ 'a': 1 }, _.toPlainObject(new Foo));
     * // => { 'a': 1, 'b': 2, 'c': 3 }
     */
    function toPlainObject(value) {
      return copyObject(value, keysIn(value));
    }

    /**
     * Converts `value` to a safe integer. A safe integer can be compared and
     * represented correctly.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to convert.
     * @returns {number} Returns the converted integer.
     * @example
     *
     * _.toSafeInteger(3);
     * // => 3
     *
     * _.toSafeInteger(Number.MIN_VALUE);
     * // => 0
     *
     * _.toSafeInteger(Infinity);
     * // => 9007199254740991
     *
     * _.toSafeInteger('3');
     * // => 3
     */
    function toSafeInteger(value) {
      return baseClamp(toInteger(value), -MAX_SAFE_INTEGER, MAX_SAFE_INTEGER);
    }

    /**
     * Converts `value` to a string. An empty string is returned for `null`
     * and `undefined` values. The sign of `-0` is preserved.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to process.
     * @returns {string} Returns the string.
     * @example
     *
     * _.toString(null);
     * // => ''
     *
     * _.toString(-0);
     * // => '-0'
     *
     * _.toString([1, 2, 3]);
     * // => '1,2,3'
     */
    function toString(value) {
      // Exit early for strings to avoid a performance hit in some environments.
      if (typeof value == 'string') {
        return value;
      }
      if (value == null) {
        return '';
      }
      if (isSymbol(value)) {
        return symbolToString ? symbolToString.call(value) : '';
      }
      var result = (value + '');
      return (result == '0' && (1 / value) == -INFINITY) ? '-0' : result;
    }

    /*------------------------------------------------------------------------*/

    /**
     * Assigns own enumerable string keyed properties of source objects to the
     * destination object. Source objects are applied from left to right.
     * Subsequent sources overwrite property assignments of previous sources.
     *
     * **Note:** This method mutates `object` and is loosely based on
     * [`Object.assign`](https://mdn.io/Object/assign).
     *
     * @static
     * @memberOf _
     * @since 0.10.0
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} [sources] The source objects.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.c = 3;
     * }
     *
     * function Bar() {
     *   this.e = 5;
     * }
     *
     * Foo.prototype.d = 4;
     * Bar.prototype.f = 6;
     *
     * _.assign({ 'a': 1 }, new Foo, new Bar);
     * // => { 'a': 1, 'c': 3, 'e': 5 }
     */
    var assign = createAssigner(function(object, source) {
      if (nonEnumShadows || isPrototype(source) || isArrayLike(source)) {
        copyObject(source, keys(source), object);
        return;
      }
      for (var key in source) {
        if (hasOwnProperty.call(source, key)) {
          assignValue(object, key, source[key]);
        }
      }
    });

    /**
     * This method is like `_.assign` except that it iterates over own and
     * inherited source properties.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @alias extend
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} [sources] The source objects.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.b = 2;
     * }
     *
     * function Bar() {
     *   this.d = 4;
     * }
     *
     * Foo.prototype.c = 3;
     * Bar.prototype.e = 5;
     *
     * _.assignIn({ 'a': 1 }, new Foo, new Bar);
     * // => { 'a': 1, 'b': 2, 'c': 3, 'd': 4, 'e': 5 }
     */
    var assignIn = createAssigner(function(object, source) {
      if (nonEnumShadows || isPrototype(source) || isArrayLike(source)) {
        copyObject(source, keysIn(source), object);
        return;
      }
      for (var key in source) {
        assignValue(object, key, source[key]);
      }
    });

    /**
     * This method is like `_.assignIn` except that it accepts `customizer`
     * which is invoked to produce the assigned values. If `customizer` returns
     * `undefined`, assignment is handled by the method instead. The `customizer`
     * is invoked with five arguments: (objValue, srcValue, key, object, source).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @alias extendWith
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} sources The source objects.
     * @param {Function} [customizer] The function to customize assigned values.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function customizer(objValue, srcValue) {
     *   return _.isUndefined(objValue) ? srcValue : objValue;
     * }
     *
     * var defaults = _.partialRight(_.assignInWith, customizer);
     *
     * defaults({ 'a': 1 }, { 'b': 2 }, { 'a': 3 });
     * // => { 'a': 1, 'b': 2 }
     */
    var assignInWith = createAssigner(function(object, source, srcIndex, customizer) {
      copyObject(source, keysIn(source), object, customizer);
    });

    /**
     * This method is like `_.assign` except that it accepts `customizer`
     * which is invoked to produce the assigned values. If `customizer` returns
     * `undefined`, assignment is handled by the method instead. The `customizer`
     * is invoked with five arguments: (objValue, srcValue, key, object, source).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} sources The source objects.
     * @param {Function} [customizer] The function to customize assigned values.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function customizer(objValue, srcValue) {
     *   return _.isUndefined(objValue) ? srcValue : objValue;
     * }
     *
     * var defaults = _.partialRight(_.assignWith, customizer);
     *
     * defaults({ 'a': 1 }, { 'b': 2 }, { 'a': 3 });
     * // => { 'a': 1, 'b': 2 }
     */
    var assignWith = createAssigner(function(object, source, srcIndex, customizer) {
      copyObject(source, keys(source), object, customizer);
    });

    /**
     * Creates an array of values corresponding to `paths` of `object`.
     *
     * @static
     * @memberOf _
     * @since 1.0.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {...(string|string[])} [paths] The property paths of elements to pick.
     * @returns {Array} Returns the new array of picked elements.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 3 } }, 4] };
     *
     * _.at(object, ['a[0].b.c', 'a[1]']);
     * // => [3, 4]
     *
     * _.at(['a', 'b', 'c'], 0, 2);
     * // => ['a', 'c']
     */
    var at = rest(function(object, paths) {
      return baseAt(object, baseFlatten(paths, 1));
    });

    /**
     * Creates an object that inherits from the `prototype` object. If a
     * `properties` object is given, its own enumerable string keyed properties
     * are assigned to the created object.
     *
     * @static
     * @memberOf _
     * @since 2.3.0
     * @category Object
     * @param {Object} prototype The object to inherit from.
     * @param {Object} [properties] The properties to assign to the object.
     * @returns {Object} Returns the new object.
     * @example
     *
     * function Shape() {
     *   this.x = 0;
     *   this.y = 0;
     * }
     *
     * function Circle() {
     *   Shape.call(this);
     * }
     *
     * Circle.prototype = _.create(Shape.prototype, {
     *   'constructor': Circle
     * });
     *
     * var circle = new Circle;
     * circle instanceof Circle;
     * // => true
     *
     * circle instanceof Shape;
     * // => true
     */
    function create(prototype, properties) {
      var result = baseCreate(prototype);
      return properties ? baseAssign(result, properties) : result;
    }

    /**
     * Assigns own and inherited enumerable string keyed properties of source
     * objects to the destination object for all destination properties that
     * resolve to `undefined`. Source objects are applied from left to right.
     * Once a property is set, additional values of the same property are ignored.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} [sources] The source objects.
     * @returns {Object} Returns `object`.
     * @example
     *
     * _.defaults({ 'user': 'barney' }, { 'age': 36 }, { 'user': 'fred' });
     * // => { 'user': 'barney', 'age': 36 }
     */
    var defaults = rest(function(args) {
      args.push(undefined, assignInDefaults);
      return apply(assignInWith, undefined, args);
    });

    /**
     * This method is like `_.defaults` except that it recursively assigns
     * default properties.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 3.10.0
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} [sources] The source objects.
     * @returns {Object} Returns `object`.
     * @example
     *
     * _.defaultsDeep({ 'user': { 'name': 'barney' } }, { 'user': { 'name': 'fred', 'age': 36 } });
     * // => { 'user': { 'name': 'barney', 'age': 36 } }
     *
     */
    var defaultsDeep = rest(function(args) {
      args.push(undefined, mergeDefaults);
      return apply(mergeWith, undefined, args);
    });

    /**
     * This method is like `_.find` except that it returns the key of the first
     * element `predicate` returns truthy for instead of the element itself.
     *
     * @static
     * @memberOf _
     * @since 1.1.0
     * @category Object
     * @param {Object} object The object to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {string|undefined} Returns the key of the matched element,
     *  else `undefined`.
     * @example
     *
     * var users = {
     *   'barney':  { 'age': 36, 'active': true },
     *   'fred':    { 'age': 40, 'active': false },
     *   'pebbles': { 'age': 1,  'active': true }
     * };
     *
     * _.findKey(users, function(o) { return o.age < 40; });
     * // => 'barney' (iteration order is not guaranteed)
     *
     * // The `_.matches` iteratee shorthand.
     * _.findKey(users, { 'age': 1, 'active': true });
     * // => 'pebbles'
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.findKey(users, ['active', false]);
     * // => 'fred'
     *
     * // The `_.property` iteratee shorthand.
     * _.findKey(users, 'active');
     * // => 'barney'
     */
    function findKey(object, predicate) {
      return baseFind(object, getIteratee(predicate, 3), baseForOwn, true);
    }

    /**
     * This method is like `_.findKey` except that it iterates over elements of
     * a collection in the opposite order.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Object
     * @param {Object} object The object to search.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per iteration.
     * @returns {string|undefined} Returns the key of the matched element,
     *  else `undefined`.
     * @example
     *
     * var users = {
     *   'barney':  { 'age': 36, 'active': true },
     *   'fred':    { 'age': 40, 'active': false },
     *   'pebbles': { 'age': 1,  'active': true }
     * };
     *
     * _.findLastKey(users, function(o) { return o.age < 40; });
     * // => returns 'pebbles' assuming `_.findKey` returns 'barney'
     *
     * // The `_.matches` iteratee shorthand.
     * _.findLastKey(users, { 'age': 36, 'active': true });
     * // => 'barney'
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.findLastKey(users, ['active', false]);
     * // => 'fred'
     *
     * // The `_.property` iteratee shorthand.
     * _.findLastKey(users, 'active');
     * // => 'pebbles'
     */
    function findLastKey(object, predicate) {
      return baseFind(object, getIteratee(predicate, 3), baseForOwnRight, true);
    }

    /**
     * Iterates over own and inherited enumerable string keyed properties of an
     * object and invokes `iteratee` for each property. The iteratee is invoked
     * with three arguments: (value, key, object). Iteratee functions may exit
     * iteration early by explicitly returning `false`.
     *
     * @static
     * @memberOf _
     * @since 0.3.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.forIn(new Foo, function(value, key) {
     *   console.log(key);
     * });
     * // => Logs 'a', 'b', then 'c' (iteration order is not guaranteed).
     */
    function forIn(object, iteratee) {
      return object == null
        ? object
        : baseFor(object, getIteratee(iteratee), keysIn);
    }

    /**
     * This method is like `_.forIn` except that it iterates over properties of
     * `object` in the opposite order.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.forInRight(new Foo, function(value, key) {
     *   console.log(key);
     * });
     * // => Logs 'c', 'b', then 'a' assuming `_.forIn` logs 'a', 'b', then 'c'.
     */
    function forInRight(object, iteratee) {
      return object == null
        ? object
        : baseForRight(object, getIteratee(iteratee), keysIn);
    }

    /**
     * Iterates over own enumerable string keyed properties of an object and
     * invokes `iteratee` for each property. The iteratee is invoked with three
     * arguments: (value, key, object). Iteratee functions may exit iteration
     * early by explicitly returning `false`.
     *
     * @static
     * @memberOf _
     * @since 0.3.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.forOwn(new Foo, function(value, key) {
     *   console.log(key);
     * });
     * // => Logs 'a' then 'b' (iteration order is not guaranteed).
     */
    function forOwn(object, iteratee) {
      return object && baseForOwn(object, getIteratee(iteratee));
    }

    /**
     * This method is like `_.forOwn` except that it iterates over properties of
     * `object` in the opposite order.
     *
     * @static
     * @memberOf _
     * @since 2.0.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.forOwnRight(new Foo, function(value, key) {
     *   console.log(key);
     * });
     * // => Logs 'b' then 'a' assuming `_.forOwn` logs 'a' then 'b'.
     */
    function forOwnRight(object, iteratee) {
      return object && baseForOwnRight(object, getIteratee(iteratee));
    }

    /**
     * Creates an array of function property names from own enumerable properties
     * of `object`.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to inspect.
     * @returns {Array} Returns the new array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = _.constant('a');
     *   this.b = _.constant('b');
     * }
     *
     * Foo.prototype.c = _.constant('c');
     *
     * _.functions(new Foo);
     * // => ['a', 'b']
     */
    function functions(object) {
      return object == null ? [] : baseFunctions(object, keys(object));
    }

    /**
     * Creates an array of function property names from own and inherited
     * enumerable properties of `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The object to inspect.
     * @returns {Array} Returns the new array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = _.constant('a');
     *   this.b = _.constant('b');
     * }
     *
     * Foo.prototype.c = _.constant('c');
     *
     * _.functionsIn(new Foo);
     * // => ['a', 'b', 'c']
     */
    function functionsIn(object) {
      return object == null ? [] : baseFunctions(object, keysIn(object));
    }

    /**
     * Gets the value at `path` of `object`. If the resolved value is
     * `undefined`, the `defaultValue` is used in its place.
     *
     * @static
     * @memberOf _
     * @since 3.7.0
     * @category Object
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the property to get.
     * @param {*} [defaultValue] The value returned for `undefined` resolved values.
     * @returns {*} Returns the resolved value.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 3 } }] };
     *
     * _.get(object, 'a[0].b.c');
     * // => 3
     *
     * _.get(object, ['a', '0', 'b', 'c']);
     * // => 3
     *
     * _.get(object, 'a.b.c', 'default');
     * // => 'default'
     */
    function get(object, path, defaultValue) {
      var result = object == null ? undefined : baseGet(object, path);
      return result === undefined ? defaultValue : result;
    }

    /**
     * Checks if `path` is a direct property of `object`.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to query.
     * @param {Array|string} path The path to check.
     * @returns {boolean} Returns `true` if `path` exists, else `false`.
     * @example
     *
     * var object = { 'a': { 'b': 2 } };
     * var other = _.create({ 'a': _.create({ 'b': 2 }) });
     *
     * _.has(object, 'a');
     * // => true
     *
     * _.has(object, 'a.b');
     * // => true
     *
     * _.has(object, ['a', 'b']);
     * // => true
     *
     * _.has(other, 'a');
     * // => false
     */
    function has(object, path) {
      return object != null && hasPath(object, path, baseHas);
    }

    /**
     * Checks if `path` is a direct or inherited property of `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The object to query.
     * @param {Array|string} path The path to check.
     * @returns {boolean} Returns `true` if `path` exists, else `false`.
     * @example
     *
     * var object = _.create({ 'a': _.create({ 'b': 2 }) });
     *
     * _.hasIn(object, 'a');
     * // => true
     *
     * _.hasIn(object, 'a.b');
     * // => true
     *
     * _.hasIn(object, ['a', 'b']);
     * // => true
     *
     * _.hasIn(object, 'b');
     * // => false
     */
    function hasIn(object, path) {
      return object != null && hasPath(object, path, baseHasIn);
    }

    /**
     * Creates an object composed of the inverted keys and values of `object`.
     * If `object` contains duplicate values, subsequent values overwrite
     * property assignments of previous values.
     *
     * @static
     * @memberOf _
     * @since 0.7.0
     * @category Object
     * @param {Object} object The object to invert.
     * @returns {Object} Returns the new inverted object.
     * @example
     *
     * var object = { 'a': 1, 'b': 2, 'c': 1 };
     *
     * _.invert(object);
     * // => { '1': 'c', '2': 'b' }
     */
    var invert = createInverter(function(result, value, key) {
      result[value] = key;
    }, constant(identity));

    /**
     * This method is like `_.invert` except that the inverted object is generated
     * from the results of running each element of `object` thru `iteratee`. The
     * corresponding inverted value of each inverted key is an array of keys
     * responsible for generating the inverted value. The iteratee is invoked
     * with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.1.0
     * @category Object
     * @param {Object} object The object to invert.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {Object} Returns the new inverted object.
     * @example
     *
     * var object = { 'a': 1, 'b': 2, 'c': 1 };
     *
     * _.invertBy(object);
     * // => { '1': ['a', 'c'], '2': ['b'] }
     *
     * _.invertBy(object, function(value) {
     *   return 'group' + value;
     * });
     * // => { 'group1': ['a', 'c'], 'group2': ['b'] }
     */
    var invertBy = createInverter(function(result, value, key) {
      if (hasOwnProperty.call(result, value)) {
        result[value].push(key);
      } else {
        result[value] = [key];
      }
    }, getIteratee);

    /**
     * Invokes the method at `path` of `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the method to invoke.
     * @param {...*} [args] The arguments to invoke the method with.
     * @returns {*} Returns the result of the invoked method.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': [1, 2, 3, 4] } }] };
     *
     * _.invoke(object, 'a[0].b.c.slice', 1, 3);
     * // => [2, 3]
     */
    var invoke = rest(baseInvoke);

    /**
     * Creates an array of the own enumerable property names of `object`.
     *
     * **Note:** Non-object values are coerced to objects. See the
     * [ES spec](http://ecma-international.org/ecma-262/6.0/#sec-object.keys)
     * for more details.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.keys(new Foo);
     * // => ['a', 'b'] (iteration order is not guaranteed)
     *
     * _.keys('hi');
     * // => ['0', '1']
     */
    function keys(object) {
      var isProto = isPrototype(object);
      if (!(isProto || isArrayLike(object))) {
        return baseKeys(object);
      }
      var indexes = indexKeys(object),
          skipIndexes = !!indexes,
          result = indexes || [],
          length = result.length;

      for (var key in object) {
        if (baseHas(object, key) &&
            !(skipIndexes && (key == 'length' || isIndex(key, length))) &&
            !(isProto && key == 'constructor')) {
          result.push(key);
        }
      }
      return result;
    }

    /**
     * Creates an array of the own and inherited enumerable property names of `object`.
     *
     * **Note:** Non-object values are coerced to objects.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.keysIn(new Foo);
     * // => ['a', 'b', 'c'] (iteration order is not guaranteed)
     */
    function keysIn(object) {
      var index = -1,
          isProto = isPrototype(object),
          props = baseKeysIn(object),
          propsLength = props.length,
          indexes = indexKeys(object),
          skipIndexes = !!indexes,
          result = indexes || [],
          length = result.length;

      while (++index < propsLength) {
        var key = props[index];
        if (!(skipIndexes && (key == 'length' || isIndex(key, length))) &&
            !(key == 'constructor' && (isProto || !hasOwnProperty.call(object, key)))) {
          result.push(key);
        }
      }
      return result;
    }

    /**
     * The opposite of `_.mapValues`; this method creates an object with the
     * same values as `object` and keys generated by running each own enumerable
     * string keyed property of `object` thru `iteratee`. The iteratee is invoked
     * with three arguments: (value, key, object).
     *
     * @static
     * @memberOf _
     * @since 3.8.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @returns {Object} Returns the new mapped object.
     * @example
     *
     * _.mapKeys({ 'a': 1, 'b': 2 }, function(value, key) {
     *   return key + value;
     * });
     * // => { 'a1': 1, 'b2': 2 }
     */
    function mapKeys(object, iteratee) {
      var result = {};
      iteratee = getIteratee(iteratee, 3);

      baseForOwn(object, function(value, key, object) {
        result[iteratee(value, key, object)] = value;
      });
      return result;
    }

    /**
     * Creates an object with the same keys as `object` and values generated
     * by running each own enumerable string keyed property of `object` thru
     * `iteratee`. The iteratee is invoked with three arguments:
     * (value, key, object).
     *
     * @static
     * @memberOf _
     * @since 2.4.0
     * @category Object
     * @param {Object} object The object to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The function invoked per iteration.
     * @returns {Object} Returns the new mapped object.
     * @example
     *
     * var users = {
     *   'fred':    { 'user': 'fred',    'age': 40 },
     *   'pebbles': { 'user': 'pebbles', 'age': 1 }
     * };
     *
     * _.mapValues(users, function(o) { return o.age; });
     * // => { 'fred': 40, 'pebbles': 1 } (iteration order is not guaranteed)
     *
     * // The `_.property` iteratee shorthand.
     * _.mapValues(users, 'age');
     * // => { 'fred': 40, 'pebbles': 1 } (iteration order is not guaranteed)
     */
    function mapValues(object, iteratee) {
      var result = {};
      iteratee = getIteratee(iteratee, 3);

      baseForOwn(object, function(value, key, object) {
        result[key] = iteratee(value, key, object);
      });
      return result;
    }

    /**
     * This method is like `_.assign` except that it recursively merges own and
     * inherited enumerable string keyed properties of source objects into the
     * destination object. Source properties that resolve to `undefined` are
     * skipped if a destination value exists. Array and plain object properties
     * are merged recursively.Other objects and value types are overridden by
     * assignment. Source objects are applied from left to right. Subsequent
     * sources overwrite property assignments of previous sources.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 0.5.0
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} [sources] The source objects.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var users = {
     *   'data': [{ 'user': 'barney' }, { 'user': 'fred' }]
     * };
     *
     * var ages = {
     *   'data': [{ 'age': 36 }, { 'age': 40 }]
     * };
     *
     * _.merge(users, ages);
     * // => { 'data': [{ 'user': 'barney', 'age': 36 }, { 'user': 'fred', 'age': 40 }] }
     */
    var merge = createAssigner(function(object, source, srcIndex) {
      baseMerge(object, source, srcIndex);
    });

    /**
     * This method is like `_.merge` except that it accepts `customizer` which
     * is invoked to produce the merged values of the destination and source
     * properties. If `customizer` returns `undefined`, merging is handled by the
     * method instead. The `customizer` is invoked with seven arguments:
     * (objValue, srcValue, key, object, source, stack).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The destination object.
     * @param {...Object} sources The source objects.
     * @param {Function} customizer The function to customize assigned values.
     * @returns {Object} Returns `object`.
     * @example
     *
     * function customizer(objValue, srcValue) {
     *   if (_.isArray(objValue)) {
     *     return objValue.concat(srcValue);
     *   }
     * }
     *
     * var object = {
     *   'fruits': ['apple'],
     *   'vegetables': ['beet']
     * };
     *
     * var other = {
     *   'fruits': ['banana'],
     *   'vegetables': ['carrot']
     * };
     *
     * _.mergeWith(object, other, customizer);
     * // => { 'fruits': ['apple', 'banana'], 'vegetables': ['beet', 'carrot'] }
     */
    var mergeWith = createAssigner(function(object, source, srcIndex, customizer) {
      baseMerge(object, source, srcIndex, customizer);
    });

    /**
     * The opposite of `_.pick`; this method creates an object composed of the
     * own and inherited enumerable string keyed properties of `object` that are
     * not omitted.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The source object.
     * @param {...(string|string[])} [props] The property identifiers to omit.
     * @returns {Object} Returns the new object.
     * @example
     *
     * var object = { 'a': 1, 'b': '2', 'c': 3 };
     *
     * _.omit(object, ['a', 'c']);
     * // => { 'b': '2' }
     */
    var omit = rest(function(object, props) {
      if (object == null) {
        return {};
      }
      props = arrayMap(baseFlatten(props, 1), toKey);
      return basePick(object, baseDifference(getAllKeysIn(object), props));
    });

    /**
     * The opposite of `_.pickBy`; this method creates an object composed of
     * the own and inherited enumerable string keyed properties of `object` that
     * `predicate` doesn't return truthy for. The predicate is invoked with two
     * arguments: (value, key).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The source object.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per property.
     * @returns {Object} Returns the new object.
     * @example
     *
     * var object = { 'a': 1, 'b': '2', 'c': 3 };
     *
     * _.omitBy(object, _.isNumber);
     * // => { 'b': '2' }
     */
    function omitBy(object, predicate) {
      predicate = getIteratee(predicate);
      return basePickBy(object, function(value, key) {
        return !predicate(value, key);
      });
    }

    /**
     * Creates an object composed of the picked `object` properties.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The source object.
     * @param {...(string|string[])} [props] The property identifiers to pick.
     * @returns {Object} Returns the new object.
     * @example
     *
     * var object = { 'a': 1, 'b': '2', 'c': 3 };
     *
     * _.pick(object, ['a', 'c']);
     * // => { 'a': 1, 'c': 3 }
     */
    var pick = rest(function(object, props) {
      return object == null ? {} : basePick(object, baseFlatten(props, 1));
    });

    /**
     * Creates an object composed of the `object` properties `predicate` returns
     * truthy for. The predicate is invoked with two arguments: (value, key).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The source object.
     * @param {Array|Function|Object|string} [predicate=_.identity]
     *  The function invoked per property.
     * @returns {Object} Returns the new object.
     * @example
     *
     * var object = { 'a': 1, 'b': '2', 'c': 3 };
     *
     * _.pickBy(object, _.isNumber);
     * // => { 'a': 1, 'c': 3 }
     */
    function pickBy(object, predicate) {
      return object == null ? {} : basePickBy(object, getIteratee(predicate));
    }

    /**
     * This method is like `_.get` except that if the resolved value is a
     * function it's invoked with the `this` binding of its parent object and
     * its result is returned.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to query.
     * @param {Array|string} path The path of the property to resolve.
     * @param {*} [defaultValue] The value returned for `undefined` resolved values.
     * @returns {*} Returns the resolved value.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c1': 3, 'c2': _.constant(4) } }] };
     *
     * _.result(object, 'a[0].b.c1');
     * // => 3
     *
     * _.result(object, 'a[0].b.c2');
     * // => 4
     *
     * _.result(object, 'a[0].b.c3', 'default');
     * // => 'default'
     *
     * _.result(object, 'a[0].b.c3', _.constant('default'));
     * // => 'default'
     */
    function result(object, path, defaultValue) {
      path = isKey(path, object) ? [path] : castPath(path);

      var index = -1,
          length = path.length;

      // Ensure the loop is entered when path is empty.
      if (!length) {
        object = undefined;
        length = 1;
      }
      while (++index < length) {
        var value = object == null ? undefined : object[path[index]];
        if (value === undefined) {
          index = length;
          value = defaultValue;
        }
        object = isFunction(value) ? value.call(object) : value;
      }
      return object;
    }

    /**
     * Sets the value at `path` of `object`. If a portion of `path` doesn't exist,
     * it's created. Arrays are created for missing index properties while objects
     * are created for all other missing properties. Use `_.setWith` to customize
     * `path` creation.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 3.7.0
     * @category Object
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 3 } }] };
     *
     * _.set(object, 'a[0].b.c', 4);
     * console.log(object.a[0].b.c);
     * // => 4
     *
     * _.set(object, ['x', '0', 'y', 'z'], 5);
     * console.log(object.x[0].y.z);
     * // => 5
     */
    function set(object, path, value) {
      return object == null ? object : baseSet(object, path, value);
    }

    /**
     * This method is like `_.set` except that it accepts `customizer` which is
     * invoked to produce the objects of `path`.  If `customizer` returns `undefined`
     * path creation is handled by the method instead. The `customizer` is invoked
     * with three arguments: (nsValue, key, nsObject).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to set.
     * @param {*} value The value to set.
     * @param {Function} [customizer] The function to customize assigned values.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var object = {};
     *
     * _.setWith(object, '[0][1]', 'a', Object);
     * // => { '0': { '1': 'a' } }
     */
    function setWith(object, path, value, customizer) {
      customizer = typeof customizer == 'function' ? customizer : undefined;
      return object == null ? object : baseSet(object, path, value, customizer);
    }

    /**
     * Creates an array of own enumerable string keyed-value pairs for `object`
     * which can be consumed by `_.fromPairs`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @alias entries
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the new array of key-value pairs.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.toPairs(new Foo);
     * // => [['a', 1], ['b', 2]] (iteration order is not guaranteed)
     */
    function toPairs(object) {
      return baseToPairs(object, keys(object));
    }

    /**
     * Creates an array of own and inherited enumerable string keyed-value pairs
     * for `object` which can be consumed by `_.fromPairs`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @alias entriesIn
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the new array of key-value pairs.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.toPairsIn(new Foo);
     * // => [['a', 1], ['b', 2], ['c', 1]] (iteration order is not guaranteed)
     */
    function toPairsIn(object) {
      return baseToPairs(object, keysIn(object));
    }

    /**
     * An alternative to `_.reduce`; this method transforms `object` to a new
     * `accumulator` object which is the result of running each of its own
     * enumerable string keyed properties thru `iteratee`, with each invocation
     * potentially mutating the `accumulator` object. The iteratee is invoked
     * with four arguments: (accumulator, value, key, object). Iteratee functions
     * may exit iteration early by explicitly returning `false`.
     *
     * @static
     * @memberOf _
     * @since 1.3.0
     * @category Object
     * @param {Array|Object} object The object to iterate over.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @param {*} [accumulator] The custom accumulator value.
     * @returns {*} Returns the accumulated value.
     * @example
     *
     * _.transform([2, 3, 4], function(result, n) {
     *   result.push(n *= n);
     *   return n % 2 == 0;
     * }, []);
     * // => [4, 9]
     *
     * _.transform({ 'a': 1, 'b': 2, 'c': 1 }, function(result, value, key) {
     *   (result[value] || (result[value] = [])).push(key);
     * }, {});
     * // => { '1': ['a', 'c'], '2': ['b'] }
     */
    function transform(object, iteratee, accumulator) {
      var isArr = isArray(object) || isTypedArray(object);
      iteratee = getIteratee(iteratee, 4);

      if (accumulator == null) {
        if (isArr || isObject(object)) {
          var Ctor = object.constructor;
          if (isArr) {
            accumulator = isArray(object) ? new Ctor : [];
          } else {
            accumulator = isFunction(Ctor) ? baseCreate(getPrototype(object)) : {};
          }
        } else {
          accumulator = {};
        }
      }
      (isArr ? arrayEach : baseForOwn)(object, function(value, index, object) {
        return iteratee(accumulator, value, index, object);
      });
      return accumulator;
    }

    /**
     * Removes the property at `path` of `object`.
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Object
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to unset.
     * @returns {boolean} Returns `true` if the property is deleted, else `false`.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 7 } }] };
     * _.unset(object, 'a[0].b.c');
     * // => true
     *
     * console.log(object);
     * // => { 'a': [{ 'b': {} }] };
     *
     * _.unset(object, ['a', '0', 'b', 'c']);
     * // => true
     *
     * console.log(object);
     * // => { 'a': [{ 'b': {} }] };
     */
    function unset(object, path) {
      return object == null ? true : baseUnset(object, path);
    }

    /**
     * This method is like `_.set` except that accepts `updater` to produce the
     * value to set. Use `_.updateWith` to customize `path` creation. The `updater`
     * is invoked with one argument: (value).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.6.0
     * @category Object
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to set.
     * @param {Function} updater The function to produce the updated value.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var object = { 'a': [{ 'b': { 'c': 3 } }] };
     *
     * _.update(object, 'a[0].b.c', function(n) { return n * n; });
     * console.log(object.a[0].b.c);
     * // => 9
     *
     * _.update(object, 'x[0].y.z', function(n) { return n ? n + 1 : 0; });
     * console.log(object.x[0].y.z);
     * // => 0
     */
    function update(object, path, updater) {
      return object == null ? object : baseUpdate(object, path, castFunction(updater));
    }

    /**
     * This method is like `_.update` except that it accepts `customizer` which is
     * invoked to produce the objects of `path`.  If `customizer` returns `undefined`
     * path creation is handled by the method instead. The `customizer` is invoked
     * with three arguments: (nsValue, key, nsObject).
     *
     * **Note:** This method mutates `object`.
     *
     * @static
     * @memberOf _
     * @since 4.6.0
     * @category Object
     * @param {Object} object The object to modify.
     * @param {Array|string} path The path of the property to set.
     * @param {Function} updater The function to produce the updated value.
     * @param {Function} [customizer] The function to customize assigned values.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var object = {};
     *
     * _.updateWith(object, '[0][1]', _.constant('a'), Object);
     * // => { '0': { '1': 'a' } }
     */
    function updateWith(object, path, updater, customizer) {
      customizer = typeof customizer == 'function' ? customizer : undefined;
      return object == null ? object : baseUpdate(object, path, castFunction(updater), customizer);
    }

    /**
     * Creates an array of the own enumerable string keyed property values of `object`.
     *
     * **Note:** Non-object values are coerced to objects.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property values.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.values(new Foo);
     * // => [1, 2] (iteration order is not guaranteed)
     *
     * _.values('hi');
     * // => ['h', 'i']
     */
    function values(object) {
      return object ? baseValues(object, keys(object)) : [];
    }

    /**
     * Creates an array of the own and inherited enumerable string keyed property
     * values of `object`.
     *
     * **Note:** Non-object values are coerced to objects.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property values.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.valuesIn(new Foo);
     * // => [1, 2, 3] (iteration order is not guaranteed)
     */
    function valuesIn(object) {
      return object == null ? [] : baseValues(object, keysIn(object));
    }

    /*------------------------------------------------------------------------*/

    /**
     * Clamps `number` within the inclusive `lower` and `upper` bounds.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Number
     * @param {number} number The number to clamp.
     * @param {number} [lower] The lower bound.
     * @param {number} upper The upper bound.
     * @returns {number} Returns the clamped number.
     * @example
     *
     * _.clamp(-10, -5, 5);
     * // => -5
     *
     * _.clamp(10, -5, 5);
     * // => 5
     */
    function clamp(number, lower, upper) {
      if (upper === undefined) {
        upper = lower;
        lower = undefined;
      }
      if (upper !== undefined) {
        upper = toNumber(upper);
        upper = upper === upper ? upper : 0;
      }
      if (lower !== undefined) {
        lower = toNumber(lower);
        lower = lower === lower ? lower : 0;
      }
      return baseClamp(toNumber(number), lower, upper);
    }

    /**
     * Checks if `n` is between `start` and up to but not including, `end`. If
     * `end` is not specified, it's set to `start` with `start` then set to `0`.
     * If `start` is greater than `end` the params are swapped to support
     * negative ranges.
     *
     * @static
     * @memberOf _
     * @since 3.3.0
     * @category Number
     * @param {number} number The number to check.
     * @param {number} [start=0] The start of the range.
     * @param {number} end The end of the range.
     * @returns {boolean} Returns `true` if `number` is in the range, else `false`.
     * @example
     *
     * _.inRange(3, 2, 4);
     * // => true
     *
     * _.inRange(4, 8);
     * // => true
     *
     * _.inRange(4, 2);
     * // => false
     *
     * _.inRange(2, 2);
     * // => false
     *
     * _.inRange(1.2, 2);
     * // => true
     *
     * _.inRange(5.2, 4);
     * // => false
     *
     * _.inRange(-3, -2, -6);
     * // => true
     */
    function inRange(number, start, end) {
      start = toNumber(start) || 0;
      if (end === undefined) {
        end = start;
        start = 0;
      } else {
        end = toNumber(end) || 0;
      }
      number = toNumber(number);
      return baseInRange(number, start, end);
    }

    /**
     * Produces a random number between the inclusive `lower` and `upper` bounds.
     * If only one argument is provided a number between `0` and the given number
     * is returned. If `floating` is `true`, or either `lower` or `upper` are
     * floats, a floating-point number is returned instead of an integer.
     *
     * **Note:** JavaScript follows the IEEE-754 standard for resolving
     * floating-point values which can produce unexpected results.
     *
     * @static
     * @memberOf _
     * @since 0.7.0
     * @category Number
     * @param {number} [lower=0] The lower bound.
     * @param {number} [upper=1] The upper bound.
     * @param {boolean} [floating] Specify returning a floating-point number.
     * @returns {number} Returns the random number.
     * @example
     *
     * _.random(0, 5);
     * // => an integer between 0 and 5
     *
     * _.random(5);
     * // => also an integer between 0 and 5
     *
     * _.random(5, true);
     * // => a floating-point number between 0 and 5
     *
     * _.random(1.2, 5.2);
     * // => a floating-point number between 1.2 and 5.2
     */
    function random(lower, upper, floating) {
      if (floating && typeof floating != 'boolean' && isIterateeCall(lower, upper, floating)) {
        upper = floating = undefined;
      }
      if (floating === undefined) {
        if (typeof upper == 'boolean') {
          floating = upper;
          upper = undefined;
        }
        else if (typeof lower == 'boolean') {
          floating = lower;
          lower = undefined;
        }
      }
      if (lower === undefined && upper === undefined) {
        lower = 0;
        upper = 1;
      }
      else {
        lower = toNumber(lower) || 0;
        if (upper === undefined) {
          upper = lower;
          lower = 0;
        } else {
          upper = toNumber(upper) || 0;
        }
      }
      if (lower > upper) {
        var temp = lower;
        lower = upper;
        upper = temp;
      }
      if (floating || lower % 1 || upper % 1) {
        var rand = nativeRandom();
        return nativeMin(lower + (rand * (upper - lower + freeParseFloat('1e-' + ((rand + '').length - 1)))), upper);
      }
      return baseRandom(lower, upper);
    }

    /*------------------------------------------------------------------------*/

    /**
     * Converts `string` to [camel case](https://en.wikipedia.org/wiki/CamelCase).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the camel cased string.
     * @example
     *
     * _.camelCase('Foo Bar');
     * // => 'fooBar'
     *
     * _.camelCase('--foo-bar--');
     * // => 'fooBar'
     *
     * _.camelCase('__FOO_BAR__');
     * // => 'fooBar'
     */
    var camelCase = createCompounder(function(result, word, index) {
      word = word.toLowerCase();
      return result + (index ? capitalize(word) : word);
    });

    /**
     * Converts the first character of `string` to upper case and the remaining
     * to lower case.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to capitalize.
     * @returns {string} Returns the capitalized string.
     * @example
     *
     * _.capitalize('FRED');
     * // => 'Fred'
     */
    function capitalize(string) {
      return upperFirst(toString(string).toLowerCase());
    }

    /**
     * Deburrs `string` by converting
     * [latin-1 supplementary letters](https://en.wikipedia.org/wiki/Latin-1_Supplement_(Unicode_block)#Character_table)
     * to basic latin letters and removing
     * [combining diacritical marks](https://en.wikipedia.org/wiki/Combining_Diacritical_Marks).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to deburr.
     * @returns {string} Returns the deburred string.
     * @example
     *
     * _.deburr('dj vu');
     * // => 'deja vu'
     */
    function deburr(string) {
      string = toString(string);
      return string && string.replace(reLatin1, deburrLetter).replace(reComboMark, '');
    }

    /**
     * Checks if `string` ends with the given target string.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to search.
     * @param {string} [target] The string to search for.
     * @param {number} [position=string.length] The position to search from.
     * @returns {boolean} Returns `true` if `string` ends with `target`,
     *  else `false`.
     * @example
     *
     * _.endsWith('abc', 'c');
     * // => true
     *
     * _.endsWith('abc', 'b');
     * // => false
     *
     * _.endsWith('abc', 'b', 2);
     * // => true
     */
    function endsWith(string, target, position) {
      string = toString(string);
      target = typeof target == 'string' ? target : (target + '');

      var length = string.length;
      position = position === undefined
        ? length
        : baseClamp(toInteger(position), 0, length);

      position -= target.length;
      return position >= 0 && string.indexOf(target, position) == position;
    }

    /**
     * Converts the characters "&", "<", ">", '"', "'", and "\`" in `string` to
     * their corresponding HTML entities.
     *
     * **Note:** No other characters are escaped. To escape additional
     * characters use a third-party library like [_he_](https://mths.be/he).
     *
     * Though the ">" character is escaped for symmetry, characters like
     * ">" and "/" don't need escaping in HTML and have no special meaning
     * unless they're part of a tag or unquoted attribute value. See
     * [Mathias Bynens's article](https://mathiasbynens.be/notes/ambiguous-ampersands)
     * (under "semi-related fun fact") for more details.
     *
     * Backticks are escaped because in IE < 9, they can break out of
     * attribute values or HTML comments. See [#59](https://html5sec.org/#59),
     * [#102](https://html5sec.org/#102), [#108](https://html5sec.org/#108), and
     * [#133](https://html5sec.org/#133) of the
     * [HTML5 Security Cheatsheet](https://html5sec.org/) for more details.
     *
     * When working with HTML you should always
     * [quote attribute values](http://wonko.com/post/html-escaping) to reduce
     * XSS vectors.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category String
     * @param {string} [string=''] The string to escape.
     * @returns {string} Returns the escaped string.
     * @example
     *
     * _.escape('fred, barney, & pebbles');
     * // => 'fred, barney, &amp; pebbles'
     */
    function escape(string) {
      string = toString(string);
      return (string && reHasUnescapedHtml.test(string))
        ? string.replace(reUnescapedHtml, escapeHtmlChar)
        : string;
    }

    /**
     * Escapes the `RegExp` special characters "^", "$", "\", ".", "*", "+",
     * "?", "(", ")", "[", "]", "{", "}", and "|" in `string`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to escape.
     * @returns {string} Returns the escaped string.
     * @example
     *
     * _.escapeRegExp('[lodash](https://lodash.com/)');
     * // => '\[lodash\]\(https://lodash\.com/\)'
     */
    function escapeRegExp(string) {
      string = toString(string);
      return (string && reHasRegExpChar.test(string))
        ? string.replace(reRegExpChar, '\\$&')
        : string;
    }

    /**
     * Converts `string` to
     * [kebab case](https://en.wikipedia.org/wiki/Letter_case#Special_case_styles).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the kebab cased string.
     * @example
     *
     * _.kebabCase('Foo Bar');
     * // => 'foo-bar'
     *
     * _.kebabCase('fooBar');
     * // => 'foo-bar'
     *
     * _.kebabCase('__FOO_BAR__');
     * // => 'foo-bar'
     */
    var kebabCase = createCompounder(function(result, word, index) {
      return result + (index ? '-' : '') + word.toLowerCase();
    });

    /**
     * Converts `string`, as space separated words, to lower case.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the lower cased string.
     * @example
     *
     * _.lowerCase('--Foo-Bar--');
     * // => 'foo bar'
     *
     * _.lowerCase('fooBar');
     * // => 'foo bar'
     *
     * _.lowerCase('__FOO_BAR__');
     * // => 'foo bar'
     */
    var lowerCase = createCompounder(function(result, word, index) {
      return result + (index ? ' ' : '') + word.toLowerCase();
    });

    /**
     * Converts the first character of `string` to lower case.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the converted string.
     * @example
     *
     * _.lowerFirst('Fred');
     * // => 'fred'
     *
     * _.lowerFirst('FRED');
     * // => 'fRED'
     */
    var lowerFirst = createCaseFirst('toLowerCase');

    /**
     * Pads `string` on the left and right sides if it's shorter than `length`.
     * Padding characters are truncated if they can't be evenly divided by `length`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to pad.
     * @param {number} [length=0] The padding length.
     * @param {string} [chars=' '] The string used as padding.
     * @returns {string} Returns the padded string.
     * @example
     *
     * _.pad('abc', 8);
     * // => '  abc   '
     *
     * _.pad('abc', 8, '_-');
     * // => '_-abc_-_'
     *
     * _.pad('abc', 3);
     * // => 'abc'
     */
    function pad(string, length, chars) {
      string = toString(string);
      length = toInteger(length);

      var strLength = length ? stringSize(string) : 0;
      if (!length || strLength >= length) {
        return string;
      }
      var mid = (length - strLength) / 2;
      return (
        createPadding(nativeFloor(mid), chars) +
        string +
        createPadding(nativeCeil(mid), chars)
      );
    }

    /**
     * Pads `string` on the right side if it's shorter than `length`. Padding
     * characters are truncated if they exceed `length`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to pad.
     * @param {number} [length=0] The padding length.
     * @param {string} [chars=' '] The string used as padding.
     * @returns {string} Returns the padded string.
     * @example
     *
     * _.padEnd('abc', 6);
     * // => 'abc   '
     *
     * _.padEnd('abc', 6, '_-');
     * // => 'abc_-_'
     *
     * _.padEnd('abc', 3);
     * // => 'abc'
     */
    function padEnd(string, length, chars) {
      string = toString(string);
      length = toInteger(length);

      var strLength = length ? stringSize(string) : 0;
      return (length && strLength < length)
        ? (string + createPadding(length - strLength, chars))
        : string;
    }

    /**
     * Pads `string` on the left side if it's shorter than `length`. Padding
     * characters are truncated if they exceed `length`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to pad.
     * @param {number} [length=0] The padding length.
     * @param {string} [chars=' '] The string used as padding.
     * @returns {string} Returns the padded string.
     * @example
     *
     * _.padStart('abc', 6);
     * // => '   abc'
     *
     * _.padStart('abc', 6, '_-');
     * // => '_-_abc'
     *
     * _.padStart('abc', 3);
     * // => 'abc'
     */
    function padStart(string, length, chars) {
      string = toString(string);
      length = toInteger(length);

      var strLength = length ? stringSize(string) : 0;
      return (length && strLength < length)
        ? (createPadding(length - strLength, chars) + string)
        : string;
    }

    /**
     * Converts `string` to an integer of the specified radix. If `radix` is
     * `undefined` or `0`, a `radix` of `10` is used unless `value` is a
     * hexadecimal, in which case a `radix` of `16` is used.
     *
     * **Note:** This method aligns with the
     * [ES5 implementation](https://es5.github.io/#x15.1.2.2) of `parseInt`.
     *
     * @static
     * @memberOf _
     * @since 1.1.0
     * @category String
     * @param {string} string The string to convert.
     * @param {number} [radix=10] The radix to interpret `value` by.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {number} Returns the converted integer.
     * @example
     *
     * _.parseInt('08');
     * // => 8
     *
     * _.map(['6', '08', '10'], _.parseInt);
     * // => [6, 8, 10]
     */
    function parseInt(string, radix, guard) {
      // Chrome fails to trim leading <BOM> whitespace characters.
      // See https://bugs.chromium.org/p/v8/issues/detail?id=3109 for more details.
      if (guard || radix == null) {
        radix = 0;
      } else if (radix) {
        radix = +radix;
      }
      string = toString(string).replace(reTrim, '');
      return nativeParseInt(string, radix || (reHasHexPrefix.test(string) ? 16 : 10));
    }

    /**
     * Repeats the given string `n` times.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to repeat.
     * @param {number} [n=1] The number of times to repeat the string.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {string} Returns the repeated string.
     * @example
     *
     * _.repeat('*', 3);
     * // => '***'
     *
     * _.repeat('abc', 2);
     * // => 'abcabc'
     *
     * _.repeat('abc', 0);
     * // => ''
     */
    function repeat(string, n, guard) {
      if ((guard ? isIterateeCall(string, n, guard) : n === undefined)) {
        n = 1;
      } else {
        n = toInteger(n);
      }
      return baseRepeat(toString(string), n);
    }

    /**
     * Replaces matches for `pattern` in `string` with `replacement`.
     *
     * **Note:** This method is based on
     * [`String#replace`](https://mdn.io/String/replace).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to modify.
     * @param {RegExp|string} pattern The pattern to replace.
     * @param {Function|string} replacement The match replacement.
     * @returns {string} Returns the modified string.
     * @example
     *
     * _.replace('Hi Fred', 'Fred', 'Barney');
     * // => 'Hi Barney'
     */
    function replace() {
      var args = arguments,
          string = toString(args[0]);

      return args.length < 3 ? string : nativeReplace.call(string, args[1], args[2]);
    }

    /**
     * Converts `string` to
     * [snake case](https://en.wikipedia.org/wiki/Snake_case).
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the snake cased string.
     * @example
     *
     * _.snakeCase('Foo Bar');
     * // => 'foo_bar'
     *
     * _.snakeCase('fooBar');
     * // => 'foo_bar'
     *
     * _.snakeCase('--FOO-BAR--');
     * // => 'foo_bar'
     */
    var snakeCase = createCompounder(function(result, word, index) {
      return result + (index ? '_' : '') + word.toLowerCase();
    });

    /**
     * Splits `string` by `separator`.
     *
     * **Note:** This method is based on
     * [`String#split`](https://mdn.io/String/split).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to split.
     * @param {RegExp|string} separator The separator pattern to split by.
     * @param {number} [limit] The length to truncate results to.
     * @returns {Array} Returns the new array of string segments.
     * @example
     *
     * _.split('a-b-c', '-', 2);
     * // => ['a', 'b']
     */
    function split(string, separator, limit) {
      if (limit && typeof limit != 'number' && isIterateeCall(string, separator, limit)) {
        separator = limit = undefined;
      }
      limit = limit === undefined ? MAX_ARRAY_LENGTH : limit >>> 0;
      if (!limit) {
        return [];
      }
      string = toString(string);
      if (string && (
            typeof separator == 'string' ||
            (separator != null && !isRegExp(separator))
          )) {
        separator += '';
        if (separator == '' && reHasComplexSymbol.test(string)) {
          return castSlice(stringToArray(string), 0, limit);
        }
      }
      return nativeSplit.call(string, separator, limit);
    }

    /**
     * Converts `string` to
     * [start case](https://en.wikipedia.org/wiki/Letter_case#Stylistic_or_specialised_usage).
     *
     * @static
     * @memberOf _
     * @since 3.1.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the start cased string.
     * @example
     *
     * _.startCase('--foo-bar--');
     * // => 'Foo Bar'
     *
     * _.startCase('fooBar');
     * // => 'Foo Bar'
     *
     * _.startCase('__FOO_BAR__');
     * // => 'FOO BAR'
     */
    var startCase = createCompounder(function(result, word, index) {
      return result + (index ? ' ' : '') + upperFirst(word);
    });

    /**
     * Checks if `string` starts with the given target string.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to search.
     * @param {string} [target] The string to search for.
     * @param {number} [position=0] The position to search from.
     * @returns {boolean} Returns `true` if `string` starts with `target`,
     *  else `false`.
     * @example
     *
     * _.startsWith('abc', 'a');
     * // => true
     *
     * _.startsWith('abc', 'b');
     * // => false
     *
     * _.startsWith('abc', 'b', 1);
     * // => true
     */
    function startsWith(string, target, position) {
      string = toString(string);
      position = baseClamp(toInteger(position), 0, string.length);
      return string.lastIndexOf(target, position) == position;
    }

    /**
     * Creates a compiled template function that can interpolate data properties
     * in "interpolate" delimiters, HTML-escape interpolated data properties in
     * "escape" delimiters, and execute JavaScript in "evaluate" delimiters. Data
     * properties may be accessed as free variables in the template. If a setting
     * object is given, it takes precedence over `_.templateSettings` values.
     *
     * **Note:** In the development build `_.template` utilizes
     * [sourceURLs](http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/#toc-sourceurl)
     * for easier debugging.
     *
     * For more information on precompiling templates see
     * [lodash's custom builds documentation](https://lodash.com/custom-builds).
     *
     * For more information on Chrome extension sandboxes see
     * [Chrome's extensions documentation](https://developer.chrome.com/extensions/sandboxingEval).
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category String
     * @param {string} [string=''] The template string.
     * @param {Object} [options={}] The options object.
     * @param {RegExp} [options.escape=_.templateSettings.escape]
     *  The HTML "escape" delimiter.
     * @param {RegExp} [options.evaluate=_.templateSettings.evaluate]
     *  The "evaluate" delimiter.
     * @param {Object} [options.imports=_.templateSettings.imports]
     *  An object to import into the template as free variables.
     * @param {RegExp} [options.interpolate=_.templateSettings.interpolate]
     *  The "interpolate" delimiter.
     * @param {string} [options.sourceURL='lodash.templateSources[n]']
     *  The sourceURL of the compiled template.
     * @param {string} [options.variable='obj']
     *  The data object variable name.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Function} Returns the compiled template function.
     * @example
     *
     * // Use the "interpolate" delimiter to create a compiled template.
     * var compiled = _.template('hello <%= user %>!');
     * compiled({ 'user': 'fred' });
     * // => 'hello fred!'
     *
     * // Use the HTML "escape" delimiter to escape data property values.
     * var compiled = _.template('<b><%- value %></b>');
     * compiled({ 'value': '<script>' });
     * // => '<b>&lt;script&gt;</b>'
     *
     * // Use the "evaluate" delimiter to execute JavaScript and generate HTML.
     * var compiled = _.template('<% _.forEach(users, function(user) { %><li><%- user %></li><% }); %>');
     * compiled({ 'users': ['fred', 'barney'] });
     * // => '<li>fred</li><li>barney</li>'
     *
     * // Use the internal `print` function in "evaluate" delimiters.
     * var compiled = _.template('<% print("hello " + user); %>!');
     * compiled({ 'user': 'barney' });
     * // => 'hello barney!'
     *
     * // Use the ES delimiter as an alternative to the default "interpolate" delimiter.
     * var compiled = _.template('hello ${ user }!');
     * compiled({ 'user': 'pebbles' });
     * // => 'hello pebbles!'
     *
     * // Use custom template delimiters.
     * _.templateSettings.interpolate = /{{([\s\S]+?)}}/g;
     * var compiled = _.template('hello {{ user }}!');
     * compiled({ 'user': 'mustache' });
     * // => 'hello mustache!'
     *
     * // Use backslashes to treat delimiters as plain text.
     * var compiled = _.template('<%= "\\<%- value %\\>" %>');
     * compiled({ 'value': 'ignored' });
     * // => '<%- value %>'
     *
     * // Use the `imports` option to import `jQuery` as `jq`.
     * var text = '<% jq.each(users, function(user) { %><li><%- user %></li><% }); %>';
     * var compiled = _.template(text, { 'imports': { 'jq': jQuery } });
     * compiled({ 'users': ['fred', 'barney'] });
     * // => '<li>fred</li><li>barney</li>'
     *
     * // Use the `sourceURL` option to specify a custom sourceURL for the template.
     * var compiled = _.template('hello <%= user %>!', { 'sourceURL': '/basic/greeting.jst' });
     * compiled(data);
     * // => Find the source of "greeting.jst" under the Sources tab or Resources panel of the web inspector.
     *
     * // Use the `variable` option to ensure a with-statement isn't used in the compiled template.
     * var compiled = _.template('hi <%= data.user %>!', { 'variable': 'data' });
     * compiled.source;
     * // => function(data) {
     * //   var __t, __p = '';
     * //   __p += 'hi ' + ((__t = ( data.user )) == null ? '' : __t) + '!';
     * //   return __p;
     * // }
     *
     * // Use the `source` property to inline compiled templates for meaningful
     * // line numbers in error messages and stack traces.
     * fs.writeFileSync(path.join(cwd, 'jst.js'), '\
     *   var JST = {\
     *     "main": ' + _.template(mainText).source + '\
     *   };\
     * ');
     */
    function template(string, options, guard) {
      // Based on John Resig's `tmpl` implementation
      // (http://ejohn.org/blog/javascript-micro-templating/)
      // and Laura Doktorova's doT.js (https://github.com/olado/doT).
      var settings = lodash.templateSettings;

      if (guard && isIterateeCall(string, options, guard)) {
        options = undefined;
      }
      string = toString(string);
      options = assignInWith({}, options, settings, assignInDefaults);

      var imports = assignInWith({}, options.imports, settings.imports, assignInDefaults),
          importsKeys = keys(imports),
          importsValues = baseValues(imports, importsKeys);

      var isEscaping,
          isEvaluating,
          index = 0,
          interpolate = options.interpolate || reNoMatch,
          source = "__p += '";

      // Compile the regexp to match each delimiter.
      var reDelimiters = RegExp(
        (options.escape || reNoMatch).source + '|' +
        interpolate.source + '|' +
        (interpolate === reInterpolate ? reEsTemplate : reNoMatch).source + '|' +
        (options.evaluate || reNoMatch).source + '|$'
      , 'g');

      // Use a sourceURL for easier debugging.
      var sourceURL = '//# sourceURL=' +
        ('sourceURL' in options
          ? options.sourceURL
          : ('lodash.templateSources[' + (++templateCounter) + ']')
        ) + '\n';

      string.replace(reDelimiters, function(match, escapeValue, interpolateValue, esTemplateValue, evaluateValue, offset) {
        interpolateValue || (interpolateValue = esTemplateValue);

        // Escape characters that can't be included in string literals.
        source += string.slice(index, offset).replace(reUnescapedString, escapeStringChar);

        // Replace delimiters with snippets.
        if (escapeValue) {
          isEscaping = true;
          source += "' +\n__e(" + escapeValue + ") +\n'";
        }
        if (evaluateValue) {
          isEvaluating = true;
          source += "';\n" + evaluateValue + ";\n__p += '";
        }
        if (interpolateValue) {
          source += "' +\n((__t = (" + interpolateValue + ")) == null ? '' : __t) +\n'";
        }
        index = offset + match.length;

        // The JS engine embedded in Adobe products needs `match` returned in
        // order to produce the correct `offset` value.
        return match;
      });

      source += "';\n";

      // If `variable` is not specified wrap a with-statement around the generated
      // code to add the data object to the top of the scope chain.
      var variable = options.variable;
      if (!variable) {
        source = 'with (obj) {\n' + source + '\n}\n';
      }
      // Cleanup code by stripping empty strings.
      source = (isEvaluating ? source.replace(reEmptyStringLeading, '') : source)
        .replace(reEmptyStringMiddle, '$1')
        .replace(reEmptyStringTrailing, '$1;');

      // Frame code as the function body.
      source = 'function(' + (variable || 'obj') + ') {\n' +
        (variable
          ? ''
          : 'obj || (obj = {});\n'
        ) +
        "var __t, __p = ''" +
        (isEscaping
           ? ', __e = _.escape'
           : ''
        ) +
        (isEvaluating
          ? ', __j = Array.prototype.join;\n' +
            "function print() { __p += __j.call(arguments, '') }\n"
          : ';\n'
        ) +
        source +
        'return __p\n}';

      var result = attempt(function() {
        return Function(importsKeys, sourceURL + 'return ' + source)
          .apply(undefined, importsValues);
      });

      // Provide the compiled function's source by its `toString` method or
      // the `source` property as a convenience for inlining compiled templates.
      result.source = source;
      if (isError(result)) {
        throw result;
      }
      return result;
    }

    /**
     * Converts `string`, as a whole, to lower case just like
     * [String#toLowerCase](https://mdn.io/toLowerCase).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the lower cased string.
     * @example
     *
     * _.toLower('--Foo-Bar--');
     * // => '--foo-bar--'
     *
     * _.toLower('fooBar');
     * // => 'foobar'
     *
     * _.toLower('__FOO_BAR__');
     * // => '__foo_bar__'
     */
    function toLower(value) {
      return toString(value).toLowerCase();
    }

    /**
     * Converts `string`, as a whole, to upper case just like
     * [String#toUpperCase](https://mdn.io/toUpperCase).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the upper cased string.
     * @example
     *
     * _.toUpper('--foo-bar--');
     * // => '--FOO-BAR--'
     *
     * _.toUpper('fooBar');
     * // => 'FOOBAR'
     *
     * _.toUpper('__foo_bar__');
     * // => '__FOO_BAR__'
     */
    function toUpper(value) {
      return toString(value).toUpperCase();
    }

    /**
     * Removes leading and trailing whitespace or specified characters from `string`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to trim.
     * @param {string} [chars=whitespace] The characters to trim.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {string} Returns the trimmed string.
     * @example
     *
     * _.trim('  abc  ');
     * // => 'abc'
     *
     * _.trim('-_-abc-_-', '_-');
     * // => 'abc'
     *
     * _.map(['  foo  ', '  bar  '], _.trim);
     * // => ['foo', 'bar']
     */
    function trim(string, chars, guard) {
      string = toString(string);
      if (!string) {
        return string;
      }
      if (guard || chars === undefined) {
        return string.replace(reTrim, '');
      }
      if (!(chars += '')) {
        return string;
      }
      var strSymbols = stringToArray(string),
          chrSymbols = stringToArray(chars),
          start = charsStartIndex(strSymbols, chrSymbols),
          end = charsEndIndex(strSymbols, chrSymbols) + 1;

      return castSlice(strSymbols, start, end).join('');
    }

    /**
     * Removes trailing whitespace or specified characters from `string`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to trim.
     * @param {string} [chars=whitespace] The characters to trim.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {string} Returns the trimmed string.
     * @example
     *
     * _.trimEnd('  abc  ');
     * // => '  abc'
     *
     * _.trimEnd('-_-abc-_-', '_-');
     * // => '-_-abc'
     */
    function trimEnd(string, chars, guard) {
      string = toString(string);
      if (!string) {
        return string;
      }
      if (guard || chars === undefined) {
        return string.replace(reTrimEnd, '');
      }
      if (!(chars += '')) {
        return string;
      }
      var strSymbols = stringToArray(string),
          end = charsEndIndex(strSymbols, stringToArray(chars)) + 1;

      return castSlice(strSymbols, 0, end).join('');
    }

    /**
     * Removes leading whitespace or specified characters from `string`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to trim.
     * @param {string} [chars=whitespace] The characters to trim.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {string} Returns the trimmed string.
     * @example
     *
     * _.trimStart('  abc  ');
     * // => 'abc  '
     *
     * _.trimStart('-_-abc-_-', '_-');
     * // => 'abc-_-'
     */
    function trimStart(string, chars, guard) {
      string = toString(string);
      if (!string) {
        return string;
      }
      if (guard || chars === undefined) {
        return string.replace(reTrimStart, '');
      }
      if (!(chars += '')) {
        return string;
      }
      var strSymbols = stringToArray(string),
          start = charsStartIndex(strSymbols, stringToArray(chars));

      return castSlice(strSymbols, start).join('');
    }

    /**
     * Truncates `string` if it's longer than the given maximum string length.
     * The last characters of the truncated string are replaced with the omission
     * string which defaults to "...".
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to truncate.
     * @param {Object} [options={}] The options object.
     * @param {number} [options.length=30] The maximum string length.
     * @param {string} [options.omission='...'] The string to indicate text is omitted.
     * @param {RegExp|string} [options.separator] The separator pattern to truncate to.
     * @returns {string} Returns the truncated string.
     * @example
     *
     * _.truncate('hi-diddly-ho there, neighborino');
     * // => 'hi-diddly-ho there, neighbo...'
     *
     * _.truncate('hi-diddly-ho there, neighborino', {
     *   'length': 24,
     *   'separator': ' '
     * });
     * // => 'hi-diddly-ho there,...'
     *
     * _.truncate('hi-diddly-ho there, neighborino', {
     *   'length': 24,
     *   'separator': /,? +/
     * });
     * // => 'hi-diddly-ho there...'
     *
     * _.truncate('hi-diddly-ho there, neighborino', {
     *   'omission': ' [...]'
     * });
     * // => 'hi-diddly-ho there, neig [...]'
     */
    function truncate(string, options) {
      var length = DEFAULT_TRUNC_LENGTH,
          omission = DEFAULT_TRUNC_OMISSION;

      if (isObject(options)) {
        var separator = 'separator' in options ? options.separator : separator;
        length = 'length' in options ? toInteger(options.length) : length;
        omission = 'omission' in options ? toString(options.omission) : omission;
      }
      string = toString(string);

      var strLength = string.length;
      if (reHasComplexSymbol.test(string)) {
        var strSymbols = stringToArray(string);
        strLength = strSymbols.length;
      }
      if (length >= strLength) {
        return string;
      }
      var end = length - stringSize(omission);
      if (end < 1) {
        return omission;
      }
      var result = strSymbols
        ? castSlice(strSymbols, 0, end).join('')
        : string.slice(0, end);

      if (separator === undefined) {
        return result + omission;
      }
      if (strSymbols) {
        end += (result.length - end);
      }
      if (isRegExp(separator)) {
        if (string.slice(end).search(separator)) {
          var match,
              substring = result;

          if (!separator.global) {
            separator = RegExp(separator.source, toString(reFlags.exec(separator)) + 'g');
          }
          separator.lastIndex = 0;
          while ((match = separator.exec(substring))) {
            var newEnd = match.index;
          }
          result = result.slice(0, newEnd === undefined ? end : newEnd);
        }
      } else if (string.indexOf(separator, end) != end) {
        var index = result.lastIndexOf(separator);
        if (index > -1) {
          result = result.slice(0, index);
        }
      }
      return result + omission;
    }

    /**
     * The inverse of `_.escape`; this method converts the HTML entities
     * `&amp;`, `&lt;`, `&gt;`, `&quot;`, `&#39;`, and `&#96;` in `string` to
     * their corresponding characters.
     *
     * **Note:** No other HTML entities are unescaped. To unescape additional
     * HTML entities use a third-party library like [_he_](https://mths.be/he).
     *
     * @static
     * @memberOf _
     * @since 0.6.0
     * @category String
     * @param {string} [string=''] The string to unescape.
     * @returns {string} Returns the unescaped string.
     * @example
     *
     * _.unescape('fred, barney, &amp; pebbles');
     * // => 'fred, barney, & pebbles'
     */
    function unescape(string) {
      string = toString(string);
      return (string && reHasEscapedHtml.test(string))
        ? string.replace(reEscapedHtml, unescapeHtmlChar)
        : string;
    }

    /**
     * Converts `string`, as space separated words, to upper case.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the upper cased string.
     * @example
     *
     * _.upperCase('--foo-bar');
     * // => 'FOO BAR'
     *
     * _.upperCase('fooBar');
     * // => 'FOO BAR'
     *
     * _.upperCase('__foo_bar__');
     * // => 'FOO BAR'
     */
    var upperCase = createCompounder(function(result, word, index) {
      return result + (index ? ' ' : '') + word.toUpperCase();
    });

    /**
     * Converts the first character of `string` to upper case.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category String
     * @param {string} [string=''] The string to convert.
     * @returns {string} Returns the converted string.
     * @example
     *
     * _.upperFirst('fred');
     * // => 'Fred'
     *
     * _.upperFirst('FRED');
     * // => 'FRED'
     */
    var upperFirst = createCaseFirst('toUpperCase');

    /**
     * Splits `string` into an array of its words.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category String
     * @param {string} [string=''] The string to inspect.
     * @param {RegExp|string} [pattern] The pattern to match words.
     * @param- {Object} [guard] Enables use as an iteratee for methods like `_.map`.
     * @returns {Array} Returns the words of `string`.
     * @example
     *
     * _.words('fred, barney, & pebbles');
     * // => ['fred', 'barney', 'pebbles']
     *
     * _.words('fred, barney, & pebbles', /[^, ]+/g);
     * // => ['fred', 'barney', '&', 'pebbles']
     */
    function words(string, pattern, guard) {
      string = toString(string);
      pattern = guard ? undefined : pattern;

      if (pattern === undefined) {
        pattern = reHasComplexWord.test(string) ? reComplexWord : reBasicWord;
      }
      return string.match(pattern) || [];
    }

    /*------------------------------------------------------------------------*/

    /**
     * Attempts to invoke `func`, returning either the result or the caught error
     * object. Any additional arguments are provided to `func` when it's invoked.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Util
     * @param {Function} func The function to attempt.
     * @param {...*} [args] The arguments to invoke `func` with.
     * @returns {*} Returns the `func` result or error object.
     * @example
     *
     * // Avoid throwing errors for invalid selectors.
     * var elements = _.attempt(function(selector) {
     *   return document.querySelectorAll(selector);
     * }, '>_>');
     *
     * if (_.isError(elements)) {
     *   elements = [];
     * }
     */
    var attempt = rest(function(func, args) {
      try {
        return apply(func, undefined, args);
      } catch (e) {
        return isError(e) ? e : new Error(e);
      }
    });

    /**
     * Binds methods of an object to the object itself, overwriting the existing
     * method.
     *
     * **Note:** This method doesn't set the "length" property of bound functions.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {Object} object The object to bind and assign the bound methods to.
     * @param {...(string|string[])} methodNames The object method names to bind.
     * @returns {Object} Returns `object`.
     * @example
     *
     * var view = {
     *   'label': 'docs',
     *   'onClick': function() {
     *     console.log('clicked ' + this.label);
     *   }
     * };
     *
     * _.bindAll(view, 'onClick');
     * jQuery(element).on('click', view.onClick);
     * // => Logs 'clicked docs' when clicked.
     */
    var bindAll = rest(function(object, methodNames) {
      arrayEach(baseFlatten(methodNames, 1), function(key) {
        object[key] = bind(object[key], object);
      });
      return object;
    });

    /**
     * Creates a function that iterates over `pairs` and invokes the corresponding
     * function of the first predicate to return truthy. The predicate-function
     * pairs are invoked with the `this` binding and arguments of the created
     * function.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {Array} pairs The predicate-function pairs.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var func = _.cond([
     *   [_.matches({ 'a': 1 }),           _.constant('matches A')],
     *   [_.conforms({ 'b': _.isNumber }), _.constant('matches B')],
     *   [_.constant(true),                _.constant('no match')]
     * ]);
     *
     * func({ 'a': 1, 'b': 2 });
     * // => 'matches A'
     *
     * func({ 'a': 0, 'b': 1 });
     * // => 'matches B'
     *
     * func({ 'a': '1', 'b': '2' });
     * // => 'no match'
     */
    function cond(pairs) {
      var length = pairs ? pairs.length : 0,
          toIteratee = getIteratee();

      pairs = !length ? [] : arrayMap(pairs, function(pair) {
        if (typeof pair[1] != 'function') {
          throw new TypeError(FUNC_ERROR_TEXT);
        }
        return [toIteratee(pair[0]), pair[1]];
      });

      return rest(function(args) {
        var index = -1;
        while (++index < length) {
          var pair = pairs[index];
          if (apply(pair[0], this, args)) {
            return apply(pair[1], this, args);
          }
        }
      });
    }

    /**
     * Creates a function that invokes the predicate properties of `source` with
     * the corresponding property values of a given object, returning `true` if
     * all predicates return truthy, else `false`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {Object} source The object of property predicates to conform to.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36 },
     *   { 'user': 'fred',   'age': 40 }
     * ];
     *
     * _.filter(users, _.conforms({ 'age': _.partial(_.gt, _, 38) }));
     * // => [{ 'user': 'fred', 'age': 40 }]
     */
    function conforms(source) {
      return baseConforms(baseClone(source, true));
    }

    /**
     * Creates a function that returns `value`.
     *
     * @static
     * @memberOf _
     * @since 2.4.0
     * @category Util
     * @param {*} value The value to return from the new function.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var object = { 'user': 'fred' };
     * var getter = _.constant(object);
     *
     * getter() === object;
     * // => true
     */
    function constant(value) {
      return function() {
        return value;
      };
    }

    /**
     * Creates a function that returns the result of invoking the given functions
     * with the `this` binding of the created function, where each successive
     * invocation is supplied the return value of the previous.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Util
     * @param {...(Function|Function[])} [funcs] Functions to invoke.
     * @returns {Function} Returns the new function.
     * @example
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * var addSquare = _.flow(_.add, square);
     * addSquare(1, 2);
     * // => 9
     */
    var flow = createFlow();

    /**
     * This method is like `_.flow` except that it creates a function that
     * invokes the given functions from right to left.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {...(Function|Function[])} [funcs] Functions to invoke.
     * @returns {Function} Returns the new function.
     * @example
     *
     * function square(n) {
     *   return n * n;
     * }
     *
     * var addSquare = _.flowRight(square, _.add);
     * addSquare(1, 2);
     * // => 9
     */
    var flowRight = createFlow(true);

    /**
     * This method returns the first argument given to it.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {*} value Any value.
     * @returns {*} Returns `value`.
     * @example
     *
     * var object = { 'user': 'fred' };
     *
     * _.identity(object) === object;
     * // => true
     */
    function identity(value) {
      return value;
    }

    /**
     * Creates a function that invokes `func` with the arguments of the created
     * function. If `func` is a property name, the created function returns the
     * property value for a given element. If `func` is an array or object, the
     * created function returns `true` for elements that contain the equivalent
     * source properties, otherwise it returns `false`.
     *
     * @static
     * @since 4.0.0
     * @memberOf _
     * @category Util
     * @param {*} [func=_.identity] The value to convert to a callback.
     * @returns {Function} Returns the callback.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36, 'active': true },
     *   { 'user': 'fred',   'age': 40, 'active': false }
     * ];
     *
     * // The `_.matches` iteratee shorthand.
     * _.filter(users, _.iteratee({ 'user': 'barney', 'active': true }));
     * // => [{ 'user': 'barney', 'age': 36, 'active': true }]
     *
     * // The `_.matchesProperty` iteratee shorthand.
     * _.filter(users, _.iteratee(['user', 'fred']));
     * // => [{ 'user': 'fred', 'age': 40 }]
     *
     * // The `_.property` iteratee shorthand.
     * _.map(users, _.iteratee('user'));
     * // => ['barney', 'fred']
     *
     * // Create custom iteratee shorthands.
     * _.iteratee = _.wrap(_.iteratee, function(iteratee, func) {
     *   return !_.isRegExp(func) ? iteratee(func) : function(string) {
     *     return func.test(string);
     *   };
     * });
     *
     * _.filter(['abc', 'def'], /ef/);
     * // => ['def']
     */
    function iteratee(func) {
      return baseIteratee(typeof func == 'function' ? func : baseClone(func, true));
    }

    /**
     * Creates a function that performs a partial deep comparison between a given
     * object and `source`, returning `true` if the given object has equivalent
     * property values, else `false`. The created function is equivalent to
     * `_.isMatch` with a `source` partially applied.
     *
     * **Note:** This method supports comparing the same values as `_.isEqual`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Util
     * @param {Object} source The object of property values to match.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var users = [
     *   { 'user': 'barney', 'age': 36, 'active': true },
     *   { 'user': 'fred',   'age': 40, 'active': false }
     * ];
     *
     * _.filter(users, _.matches({ 'age': 40, 'active': false }));
     * // => [{ 'user': 'fred', 'age': 40, 'active': false }]
     */
    function matches(source) {
      return baseMatches(baseClone(source, true));
    }

    /**
     * Creates a function that performs a partial deep comparison between the
     * value at `path` of a given object to `srcValue`, returning `true` if the
     * object value is equivalent, else `false`.
     *
     * **Note:** This method supports comparing the same values as `_.isEqual`.
     *
     * @static
     * @memberOf _
     * @since 3.2.0
     * @category Util
     * @param {Array|string} path The path of the property to get.
     * @param {*} srcValue The value to match.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var users = [
     *   { 'user': 'barney' },
     *   { 'user': 'fred' }
     * ];
     *
     * _.find(users, _.matchesProperty('user', 'fred'));
     * // => { 'user': 'fred' }
     */
    function matchesProperty(path, srcValue) {
      return baseMatchesProperty(path, baseClone(srcValue, true));
    }

    /**
     * Creates a function that invokes the method at `path` of a given object.
     * Any additional arguments are provided to the invoked method.
     *
     * @static
     * @memberOf _
     * @since 3.7.0
     * @category Util
     * @param {Array|string} path The path of the method to invoke.
     * @param {...*} [args] The arguments to invoke the method with.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var objects = [
     *   { 'a': { 'b': _.constant(2) } },
     *   { 'a': { 'b': _.constant(1) } }
     * ];
     *
     * _.map(objects, _.method('a.b'));
     * // => [2, 1]
     *
     * _.map(objects, _.method(['a', 'b']));
     * // => [2, 1]
     */
    var method = rest(function(path, args) {
      return function(object) {
        return baseInvoke(object, path, args);
      };
    });

    /**
     * The opposite of `_.method`; this method creates a function that invokes
     * the method at a given path of `object`. Any additional arguments are
     * provided to the invoked method.
     *
     * @static
     * @memberOf _
     * @since 3.7.0
     * @category Util
     * @param {Object} object The object to query.
     * @param {...*} [args] The arguments to invoke the method with.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var array = _.times(3, _.constant),
     *     object = { 'a': array, 'b': array, 'c': array };
     *
     * _.map(['a[2]', 'c[0]'], _.methodOf(object));
     * // => [2, 0]
     *
     * _.map([['a', '2'], ['c', '0']], _.methodOf(object));
     * // => [2, 0]
     */
    var methodOf = rest(function(object, args) {
      return function(path) {
        return baseInvoke(object, path, args);
      };
    });

    /**
     * Adds all own enumerable string keyed function properties of a source
     * object to the destination object. If `object` is a function, then methods
     * are added to its prototype as well.
     *
     * **Note:** Use `_.runInContext` to create a pristine `lodash` function to
     * avoid conflicts caused by modifying the original.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {Function|Object} [object=lodash] The destination object.
     * @param {Object} source The object of functions to add.
     * @param {Object} [options={}] The options object.
     * @param {boolean} [options.chain=true] Specify whether mixins are chainable.
     * @returns {Function|Object} Returns `object`.
     * @example
     *
     * function vowels(string) {
     *   return _.filter(string, function(v) {
     *     return /[aeiou]/i.test(v);
     *   });
     * }
     *
     * _.mixin({ 'vowels': vowels });
     * _.vowels('fred');
     * // => ['e']
     *
     * _('fred').vowels().value();
     * // => ['e']
     *
     * _.mixin({ 'vowels': vowels }, { 'chain': false });
     * _('fred').vowels();
     * // => ['e']
     */
    function mixin(object, source, options) {
      var props = keys(source),
          methodNames = baseFunctions(source, props);

      if (options == null &&
          !(isObject(source) && (methodNames.length || !props.length))) {
        options = source;
        source = object;
        object = this;
        methodNames = baseFunctions(source, keys(source));
      }
      var chain = !(isObject(options) && 'chain' in options) || !!options.chain,
          isFunc = isFunction(object);

      arrayEach(methodNames, function(methodName) {
        var func = source[methodName];
        object[methodName] = func;
        if (isFunc) {
          object.prototype[methodName] = function() {
            var chainAll = this.__chain__;
            if (chain || chainAll) {
              var result = object(this.__wrapped__),
                  actions = result.__actions__ = copyArray(this.__actions__);

              actions.push({ 'func': func, 'args': arguments, 'thisArg': object });
              result.__chain__ = chainAll;
              return result;
            }
            return func.apply(object, arrayPush([this.value()], arguments));
          };
        }
      });

      return object;
    }

    /**
     * Reverts the `_` variable to its previous value and returns a reference to
     * the `lodash` function.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @returns {Function} Returns the `lodash` function.
     * @example
     *
     * var lodash = _.noConflict();
     */
    function noConflict() {
      if (root._ === this) {
        root._ = oldDash;
      }
      return this;
    }

    /**
     * A no-operation function that returns `undefined` regardless of the
     * arguments it receives.
     *
     * @static
     * @memberOf _
     * @since 2.3.0
     * @category Util
     * @example
     *
     * var object = { 'user': 'fred' };
     *
     * _.noop(object) === undefined;
     * // => true
     */
    function noop() {
      // No operation performed.
    }

    /**
     * Creates a function that returns its nth argument. If `n` is negative,
     * the nth argument from the end is returned.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {number} [n=0] The index of the argument to return.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var func = _.nthArg(1);
     * func('a', 'b', 'c', 'd');
     * // => 'b'
     *
     * var func = _.nthArg(-2);
     * func('a', 'b', 'c', 'd');
     * // => 'c'
     */
    function nthArg(n) {
      n = toInteger(n);
      return rest(function(args) {
        return baseNth(args, n);
      });
    }

    /**
     * Creates a function that invokes `iteratees` with the arguments it receives
     * and returns their results.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {...(Array|Array[]|Function|Function[]|Object|Object[]|string|string[])}
     *  [iteratees=[_.identity]] The iteratees to invoke.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var func = _.over(Math.max, Math.min);
     *
     * func(1, 2, 3, 4);
     * // => [4, 1]
     */
    var over = createOver(arrayMap);

    /**
     * Creates a function that checks if **all** of the `predicates` return
     * truthy when invoked with the arguments it receives.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {...(Array|Array[]|Function|Function[]|Object|Object[]|string|string[])}
     *  [predicates=[_.identity]] The predicates to check.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var func = _.overEvery(Boolean, isFinite);
     *
     * func('1');
     * // => true
     *
     * func(null);
     * // => false
     *
     * func(NaN);
     * // => false
     */
    var overEvery = createOver(arrayEvery);

    /**
     * Creates a function that checks if **any** of the `predicates` return
     * truthy when invoked with the arguments it receives.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {...(Array|Array[]|Function|Function[]|Object|Object[]|string|string[])}
     *  [predicates=[_.identity]] The predicates to check.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var func = _.overSome(Boolean, isFinite);
     *
     * func('1');
     * // => true
     *
     * func(null);
     * // => true
     *
     * func(NaN);
     * // => false
     */
    var overSome = createOver(arraySome);

    /**
     * Creates a function that returns the value at `path` of a given object.
     *
     * @static
     * @memberOf _
     * @since 2.4.0
     * @category Util
     * @param {Array|string} path The path of the property to get.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var objects = [
     *   { 'a': { 'b': 2 } },
     *   { 'a': { 'b': 1 } }
     * ];
     *
     * _.map(objects, _.property('a.b'));
     * // => [2, 1]
     *
     * _.map(_.sortBy(objects, _.property(['a', 'b'])), 'a.b');
     * // => [1, 2]
     */
    function property(path) {
      return isKey(path) ? baseProperty(path) : basePropertyDeep(path);
    }

    /**
     * The opposite of `_.property`; this method creates a function that returns
     * the value at a given path of `object`.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Util
     * @param {Object} object The object to query.
     * @returns {Function} Returns the new function.
     * @example
     *
     * var array = [0, 1, 2],
     *     object = { 'a': array, 'b': array, 'c': array };
     *
     * _.map(['a[2]', 'c[0]'], _.propertyOf(object));
     * // => [2, 0]
     *
     * _.map([['a', '2'], ['c', '0']], _.propertyOf(object));
     * // => [2, 0]
     */
    function propertyOf(object) {
      return function(path) {
        return object == null ? undefined : baseGet(object, path);
      };
    }

    /**
     * Creates an array of numbers (positive and/or negative) progressing from
     * `start` up to, but not including, `end`. A step of `-1` is used if a negative
     * `start` is specified without an `end` or `step`. If `end` is not specified,
     * it's set to `start` with `start` then set to `0`.
     *
     * **Note:** JavaScript follows the IEEE-754 standard for resolving
     * floating-point values which can produce unexpected results.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {number} [start=0] The start of the range.
     * @param {number} end The end of the range.
     * @param {number} [step=1] The value to increment or decrement by.
     * @returns {Array} Returns the new array of numbers.
     * @example
     *
     * _.range(4);
     * // => [0, 1, 2, 3]
     *
     * _.range(-4);
     * // => [0, -1, -2, -3]
     *
     * _.range(1, 5);
     * // => [1, 2, 3, 4]
     *
     * _.range(0, 20, 5);
     * // => [0, 5, 10, 15]
     *
     * _.range(0, -4, -1);
     * // => [0, -1, -2, -3]
     *
     * _.range(1, 4, 0);
     * // => [1, 1, 1]
     *
     * _.range(0);
     * // => []
     */
    var range = createRange();

    /**
     * This method is like `_.range` except that it populates values in
     * descending order.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {number} [start=0] The start of the range.
     * @param {number} end The end of the range.
     * @param {number} [step=1] The value to increment or decrement by.
     * @returns {Array} Returns the new array of numbers.
     * @example
     *
     * _.rangeRight(4);
     * // => [3, 2, 1, 0]
     *
     * _.rangeRight(-4);
     * // => [-3, -2, -1, 0]
     *
     * _.rangeRight(1, 5);
     * // => [4, 3, 2, 1]
     *
     * _.rangeRight(0, 20, 5);
     * // => [15, 10, 5, 0]
     *
     * _.rangeRight(0, -4, -1);
     * // => [-3, -2, -1, 0]
     *
     * _.rangeRight(1, 4, 0);
     * // => [1, 1, 1]
     *
     * _.rangeRight(0);
     * // => []
     */
    var rangeRight = createRange(true);

    /**
     * Invokes the iteratee `n` times, returning an array of the results of
     * each invocation. The iteratee is invoked with one argument; (index).
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {number} n The number of times to invoke `iteratee`.
     * @param {Function} [iteratee=_.identity] The function invoked per iteration.
     * @returns {Array} Returns the array of results.
     * @example
     *
     * _.times(3, String);
     * // => ['0', '1', '2']
     *
     *  _.times(4, _.constant(true));
     * // => [true, true, true, true]
     */
    function times(n, iteratee) {
      n = toInteger(n);
      if (n < 1 || n > MAX_SAFE_INTEGER) {
        return [];
      }
      var index = MAX_ARRAY_LENGTH,
          length = nativeMin(n, MAX_ARRAY_LENGTH);

      iteratee = getIteratee(iteratee);
      n -= MAX_ARRAY_LENGTH;

      var result = baseTimes(length, iteratee);
      while (++index < n) {
        iteratee(index);
      }
      return result;
    }

    /**
     * Converts `value` to a property path array.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Util
     * @param {*} value The value to convert.
     * @returns {Array} Returns the new property path array.
     * @example
     *
     * _.toPath('a.b.c');
     * // => ['a', 'b', 'c']
     *
     * _.toPath('a[0].b.c');
     * // => ['a', '0', 'b', 'c']
     *
     * var path = ['a', 'b', 'c'],
     *     newPath = _.toPath(path);
     *
     * console.log(newPath);
     * // => ['a', 'b', 'c']
     *
     * console.log(path === newPath);
     * // => false
     */
    function toPath(value) {
      if (isArray(value)) {
        return arrayMap(value, toKey);
      }
      return isSymbol(value) ? [value] : copyArray(stringToPath(value));
    }

    /**
     * Generates a unique ID. If `prefix` is given, the ID is appended to it.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Util
     * @param {string} [prefix=''] The value to prefix the ID with.
     * @returns {string} Returns the unique ID.
     * @example
     *
     * _.uniqueId('contact_');
     * // => 'contact_104'
     *
     * _.uniqueId();
     * // => '105'
     */
    function uniqueId(prefix) {
      var id = ++idCounter;
      return toString(prefix) + id;
    }

    /*------------------------------------------------------------------------*/

    /**
     * Adds two numbers.
     *
     * @static
     * @memberOf _
     * @since 3.4.0
     * @category Math
     * @param {number} augend The first number in an addition.
     * @param {number} addend The second number in an addition.
     * @returns {number} Returns the total.
     * @example
     *
     * _.add(6, 4);
     * // => 10
     */
    var add = createMathOperation(function(augend, addend) {
      return augend + addend;
    });

    /**
     * Computes `number` rounded up to `precision`.
     *
     * @static
     * @memberOf _
     * @since 3.10.0
     * @category Math
     * @param {number} number The number to round up.
     * @param {number} [precision=0] The precision to round up to.
     * @returns {number} Returns the rounded up number.
     * @example
     *
     * _.ceil(4.006);
     * // => 5
     *
     * _.ceil(6.004, 2);
     * // => 6.01
     *
     * _.ceil(6040, -2);
     * // => 6100
     */
    var ceil = createRound('ceil');

    /**
     * Divide two numbers.
     *
     * @static
     * @memberOf _
     * @since 4.7.0
     * @category Math
     * @param {number} dividend The first number in a division.
     * @param {number} divisor The second number in a division.
     * @returns {number} Returns the quotient.
     * @example
     *
     * _.divide(6, 4);
     * // => 1.5
     */
    var divide = createMathOperation(function(dividend, divisor) {
      return dividend / divisor;
    });

    /**
     * Computes `number` rounded down to `precision`.
     *
     * @static
     * @memberOf _
     * @since 3.10.0
     * @category Math
     * @param {number} number The number to round down.
     * @param {number} [precision=0] The precision to round down to.
     * @returns {number} Returns the rounded down number.
     * @example
     *
     * _.floor(4.006);
     * // => 4
     *
     * _.floor(0.046, 2);
     * // => 0.04
     *
     * _.floor(4060, -2);
     * // => 4000
     */
    var floor = createRound('floor');

    /**
     * Computes the maximum value of `array`. If `array` is empty or falsey,
     * `undefined` is returned.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Math
     * @param {Array} array The array to iterate over.
     * @returns {*} Returns the maximum value.
     * @example
     *
     * _.max([4, 2, 8, 6]);
     * // => 8
     *
     * _.max([]);
     * // => undefined
     */
    function max(array) {
      return (array && array.length)
        ? baseExtremum(array, identity, gt)
        : undefined;
    }

    /**
     * This method is like `_.max` except that it accepts `iteratee` which is
     * invoked for each element in `array` to generate the criterion by which
     * the value is ranked. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {*} Returns the maximum value.
     * @example
     *
     * var objects = [{ 'n': 1 }, { 'n': 2 }];
     *
     * _.maxBy(objects, function(o) { return o.n; });
     * // => { 'n': 2 }
     *
     * // The `_.property` iteratee shorthand.
     * _.maxBy(objects, 'n');
     * // => { 'n': 2 }
     */
    function maxBy(array, iteratee) {
      return (array && array.length)
        ? baseExtremum(array, getIteratee(iteratee), gt)
        : undefined;
    }

    /**
     * Computes the mean of the values in `array`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @returns {number} Returns the mean.
     * @example
     *
     * _.mean([4, 2, 8, 6]);
     * // => 5
     */
    function mean(array) {
      return baseMean(array, identity);
    }

    /**
     * This method is like `_.mean` except that it accepts `iteratee` which is
     * invoked for each element in `array` to generate the value to be averaged.
     * The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.7.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {number} Returns the mean.
     * @example
     *
     * var objects = [{ 'n': 4 }, { 'n': 2 }, { 'n': 8 }, { 'n': 6 }];
     *
     * _.meanBy(objects, function(o) { return o.n; });
     * // => 5
     *
     * // The `_.property` iteratee shorthand.
     * _.meanBy(objects, 'n');
     * // => 5
     */
    function meanBy(array, iteratee) {
      return baseMean(array, getIteratee(iteratee));
    }

    /**
     * Computes the minimum value of `array`. If `array` is empty or falsey,
     * `undefined` is returned.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Math
     * @param {Array} array The array to iterate over.
     * @returns {*} Returns the minimum value.
     * @example
     *
     * _.min([4, 2, 8, 6]);
     * // => 2
     *
     * _.min([]);
     * // => undefined
     */
    function min(array) {
      return (array && array.length)
        ? baseExtremum(array, identity, lt)
        : undefined;
    }

    /**
     * This method is like `_.min` except that it accepts `iteratee` which is
     * invoked for each element in `array` to generate the criterion by which
     * the value is ranked. The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {*} Returns the minimum value.
     * @example
     *
     * var objects = [{ 'n': 1 }, { 'n': 2 }];
     *
     * _.minBy(objects, function(o) { return o.n; });
     * // => { 'n': 1 }
     *
     * // The `_.property` iteratee shorthand.
     * _.minBy(objects, 'n');
     * // => { 'n': 1 }
     */
    function minBy(array, iteratee) {
      return (array && array.length)
        ? baseExtremum(array, getIteratee(iteratee), lt)
        : undefined;
    }

    /**
     * Multiply two numbers.
     *
     * @static
     * @memberOf _
     * @since 4.7.0
     * @category Math
     * @param {number} multiplier The first number in a multiplication.
     * @param {number} multiplicand The second number in a multiplication.
     * @returns {number} Returns the product.
     * @example
     *
     * _.multiply(6, 4);
     * // => 24
     */
    var multiply = createMathOperation(function(multiplier, multiplicand) {
      return multiplier * multiplicand;
    });

    /**
     * Computes `number` rounded to `precision`.
     *
     * @static
     * @memberOf _
     * @since 3.10.0
     * @category Math
     * @param {number} number The number to round.
     * @param {number} [precision=0] The precision to round to.
     * @returns {number} Returns the rounded number.
     * @example
     *
     * _.round(4.006);
     * // => 4
     *
     * _.round(4.006, 2);
     * // => 4.01
     *
     * _.round(4060, -2);
     * // => 4100
     */
    var round = createRound('round');

    /**
     * Subtract two numbers.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Math
     * @param {number} minuend The first number in a subtraction.
     * @param {number} subtrahend The second number in a subtraction.
     * @returns {number} Returns the difference.
     * @example
     *
     * _.subtract(6, 4);
     * // => 2
     */
    var subtract = createMathOperation(function(minuend, subtrahend) {
      return minuend - subtrahend;
    });

    /**
     * Computes the sum of the values in `array`.
     *
     * @static
     * @memberOf _
     * @since 3.4.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @returns {number} Returns the sum.
     * @example
     *
     * _.sum([4, 2, 8, 6]);
     * // => 20
     */
    function sum(array) {
      return (array && array.length)
        ? baseSum(array, identity)
        : 0;
    }

    /**
     * This method is like `_.sum` except that it accepts `iteratee` which is
     * invoked for each element in `array` to generate the value to be summed.
     * The iteratee is invoked with one argument: (value).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Math
     * @param {Array} array The array to iterate over.
     * @param {Array|Function|Object|string} [iteratee=_.identity]
     *  The iteratee invoked per element.
     * @returns {number} Returns the sum.
     * @example
     *
     * var objects = [{ 'n': 4 }, { 'n': 2 }, { 'n': 8 }, { 'n': 6 }];
     *
     * _.sumBy(objects, function(o) { return o.n; });
     * // => 20
     *
     * // The `_.property` iteratee shorthand.
     * _.sumBy(objects, 'n');
     * // => 20
     */
    function sumBy(array, iteratee) {
      return (array && array.length)
        ? baseSum(array, getIteratee(iteratee))
        : 0;
    }

    /*------------------------------------------------------------------------*/

    // Add methods that return wrapped values in chain sequences.
    lodash.after = after;
    lodash.ary = ary;
    lodash.assign = assign;
    lodash.assignIn = assignIn;
    lodash.assignInWith = assignInWith;
    lodash.assignWith = assignWith;
    lodash.at = at;
    lodash.before = before;
    lodash.bind = bind;
    lodash.bindAll = bindAll;
    lodash.bindKey = bindKey;
    lodash.castArray = castArray;
    lodash.chain = chain;
    lodash.chunk = chunk;
    lodash.compact = compact;
    lodash.concat = concat;
    lodash.cond = cond;
    lodash.conforms = conforms;
    lodash.constant = constant;
    lodash.countBy = countBy;
    lodash.create = create;
    lodash.curry = curry;
    lodash.curryRight = curryRight;
    lodash.debounce = debounce;
    lodash.defaults = defaults;
    lodash.defaultsDeep = defaultsDeep;
    lodash.defer = defer;
    lodash.delay = delay;
    lodash.difference = difference;
    lodash.differenceBy = differenceBy;
    lodash.differenceWith = differenceWith;
    lodash.drop = drop;
    lodash.dropRight = dropRight;
    lodash.dropRightWhile = dropRightWhile;
    lodash.dropWhile = dropWhile;
    lodash.fill = fill;
    lodash.filter = filter;
    lodash.flatMap = flatMap;
    lodash.flatMapDeep = flatMapDeep;
    lodash.flatMapDepth = flatMapDepth;
    lodash.flatten = flatten;
    lodash.flattenDeep = flattenDeep;
    lodash.flattenDepth = flattenDepth;
    lodash.flip = flip;
    lodash.flow = flow;
    lodash.flowRight = flowRight;
    lodash.fromPairs = fromPairs;
    lodash.functions = functions;
    lodash.functionsIn = functionsIn;
    lodash.groupBy = groupBy;
    lodash.initial = initial;
    lodash.intersection = intersection;
    lodash.intersectionBy = intersectionBy;
    lodash.intersectionWith = intersectionWith;
    lodash.invert = invert;
    lodash.invertBy = invertBy;
    lodash.invokeMap = invokeMap;
    lodash.iteratee = iteratee;
    lodash.keyBy = keyBy;
    lodash.keys = keys;
    lodash.keysIn = keysIn;
    lodash.map = map;
    lodash.mapKeys = mapKeys;
    lodash.mapValues = mapValues;
    lodash.matches = matches;
    lodash.matchesProperty = matchesProperty;
    lodash.memoize = memoize;
    lodash.merge = merge;
    lodash.mergeWith = mergeWith;
    lodash.method = method;
    lodash.methodOf = methodOf;
    lodash.mixin = mixin;
    lodash.negate = negate;
    lodash.nthArg = nthArg;
    lodash.omit = omit;
    lodash.omitBy = omitBy;
    lodash.once = once;
    lodash.orderBy = orderBy;
    lodash.over = over;
    lodash.overArgs = overArgs;
    lodash.overEvery = overEvery;
    lodash.overSome = overSome;
    lodash.partial = partial;
    lodash.partialRight = partialRight;
    lodash.partition = partition;
    lodash.pick = pick;
    lodash.pickBy = pickBy;
    lodash.property = property;
    lodash.propertyOf = propertyOf;
    lodash.pull = pull;
    lodash.pullAll = pullAll;
    lodash.pullAllBy = pullAllBy;
    lodash.pullAllWith = pullAllWith;
    lodash.pullAt = pullAt;
    lodash.range = range;
    lodash.rangeRight = rangeRight;
    lodash.rearg = rearg;
    lodash.reject = reject;
    lodash.remove = remove;
    lodash.rest = rest;
    lodash.reverse = reverse;
    lodash.sampleSize = sampleSize;
    lodash.set = set;
    lodash.setWith = setWith;
    lodash.shuffle = shuffle;
    lodash.slice = slice;
    lodash.sortBy = sortBy;
    lodash.sortedUniq = sortedUniq;
    lodash.sortedUniqBy = sortedUniqBy;
    lodash.split = split;
    lodash.spread = spread;
    lodash.tail = tail;
    lodash.take = take;
    lodash.takeRight = takeRight;
    lodash.takeRightWhile = takeRightWhile;
    lodash.takeWhile = takeWhile;
    lodash.tap = tap;
    lodash.throttle = throttle;
    lodash.thru = thru;
    lodash.toArray = toArray;
    lodash.toPairs = toPairs;
    lodash.toPairsIn = toPairsIn;
    lodash.toPath = toPath;
    lodash.toPlainObject = toPlainObject;
    lodash.transform = transform;
    lodash.unary = unary;
    lodash.union = union;
    lodash.unionBy = unionBy;
    lodash.unionWith = unionWith;
    lodash.uniq = uniq;
    lodash.uniqBy = uniqBy;
    lodash.uniqWith = uniqWith;
    lodash.unset = unset;
    lodash.unzip = unzip;
    lodash.unzipWith = unzipWith;
    lodash.update = update;
    lodash.updateWith = updateWith;
    lodash.values = values;
    lodash.valuesIn = valuesIn;
    lodash.without = without;
    lodash.words = words;
    lodash.wrap = wrap;
    lodash.xor = xor;
    lodash.xorBy = xorBy;
    lodash.xorWith = xorWith;
    lodash.zip = zip;
    lodash.zipObject = zipObject;
    lodash.zipObjectDeep = zipObjectDeep;
    lodash.zipWith = zipWith;

    // Add aliases.
    lodash.entries = toPairs;
    lodash.entriesIn = toPairsIn;
    lodash.extend = assignIn;
    lodash.extendWith = assignInWith;

    // Add methods to `lodash.prototype`.
    mixin(lodash, lodash);

    /*------------------------------------------------------------------------*/

    // Add methods that return unwrapped values in chain sequences.
    lodash.add = add;
    lodash.attempt = attempt;
    lodash.camelCase = camelCase;
    lodash.capitalize = capitalize;
    lodash.ceil = ceil;
    lodash.clamp = clamp;
    lodash.clone = clone;
    lodash.cloneDeep = cloneDeep;
    lodash.cloneDeepWith = cloneDeepWith;
    lodash.cloneWith = cloneWith;
    lodash.deburr = deburr;
    lodash.divide = divide;
    lodash.endsWith = endsWith;
    lodash.eq = eq;
    lodash.escape = escape;
    lodash.escapeRegExp = escapeRegExp;
    lodash.every = every;
    lodash.find = find;
    lodash.findIndex = findIndex;
    lodash.findKey = findKey;
    lodash.findLast = findLast;
    lodash.findLastIndex = findLastIndex;
    lodash.findLastKey = findLastKey;
    lodash.floor = floor;
    lodash.forEach = forEach;
    lodash.forEachRight = forEachRight;
    lodash.forIn = forIn;
    lodash.forInRight = forInRight;
    lodash.forOwn = forOwn;
    lodash.forOwnRight = forOwnRight;
    lodash.get = get;
    lodash.gt = gt;
    lodash.gte = gte;
    lodash.has = has;
    lodash.hasIn = hasIn;
    lodash.head = head;
    lodash.identity = identity;
    lodash.includes = includes;
    lodash.indexOf = indexOf;
    lodash.inRange = inRange;
    lodash.invoke = invoke;
    lodash.isArguments = isArguments;
    lodash.isArray = isArray;
    lodash.isArrayBuffer = isArrayBuffer;
    lodash.isArrayLike = isArrayLike;
    lodash.isArrayLikeObject = isArrayLikeObject;
    lodash.isBoolean = isBoolean;
    lodash.isBuffer = isBuffer;
    lodash.isDate = isDate;
    lodash.isElement = isElement;
    lodash.isEmpty = isEmpty;
    lodash.isEqual = isEqual;
    lodash.isEqualWith = isEqualWith;
    lodash.isError = isError;
    lodash.isFinite = isFinite;
    lodash.isFunction = isFunction;
    lodash.isInteger = isInteger;
    lodash.isLength = isLength;
    lodash.isMap = isMap;
    lodash.isMatch = isMatch;
    lodash.isMatchWith = isMatchWith;
    lodash.isNaN = isNaN;
    lodash.isNative = isNative;
    lodash.isNil = isNil;
    lodash.isNull = isNull;
    lodash.isNumber = isNumber;
    lodash.isObject = isObject;
    lodash.isObjectLike = isObjectLike;
    lodash.isPlainObject = isPlainObject;
    lodash.isRegExp = isRegExp;
    lodash.isSafeInteger = isSafeInteger;
    lodash.isSet = isSet;
    lodash.isString = isString;
    lodash.isSymbol = isSymbol;
    lodash.isTypedArray = isTypedArray;
    lodash.isUndefined = isUndefined;
    lodash.isWeakMap = isWeakMap;
    lodash.isWeakSet = isWeakSet;
    lodash.join = join;
    lodash.kebabCase = kebabCase;
    lodash.last = last;
    lodash.lastIndexOf = lastIndexOf;
    lodash.lowerCase = lowerCase;
    lodash.lowerFirst = lowerFirst;
    lodash.lt = lt;
    lodash.lte = lte;
    lodash.max = max;
    lodash.maxBy = maxBy;
    lodash.mean = mean;
    lodash.meanBy = meanBy;
    lodash.min = min;
    lodash.minBy = minBy;
    lodash.multiply = multiply;
    lodash.nth = nth;
    lodash.noConflict = noConflict;
    lodash.noop = noop;
    lodash.now = now;
    lodash.pad = pad;
    lodash.padEnd = padEnd;
    lodash.padStart = padStart;
    lodash.parseInt = parseInt;
    lodash.random = random;
    lodash.reduce = reduce;
    lodash.reduceRight = reduceRight;
    lodash.repeat = repeat;
    lodash.replace = replace;
    lodash.result = result;
    lodash.round = round;
    lodash.runInContext = runInContext;
    lodash.sample = sample;
    lodash.size = size;
    lodash.snakeCase = snakeCase;
    lodash.some = some;
    lodash.sortedIndex = sortedIndex;
    lodash.sortedIndexBy = sortedIndexBy;
    lodash.sortedIndexOf = sortedIndexOf;
    lodash.sortedLastIndex = sortedLastIndex;
    lodash.sortedLastIndexBy = sortedLastIndexBy;
    lodash.sortedLastIndexOf = sortedLastIndexOf;
    lodash.startCase = startCase;
    lodash.startsWith = startsWith;
    lodash.subtract = subtract;
    lodash.sum = sum;
    lodash.sumBy = sumBy;
    lodash.template = template;
    lodash.times = times;
    lodash.toInteger = toInteger;
    lodash.toLength = toLength;
    lodash.toLower = toLower;
    lodash.toNumber = toNumber;
    lodash.toSafeInteger = toSafeInteger;
    lodash.toString = toString;
    lodash.toUpper = toUpper;
    lodash.trim = trim;
    lodash.trimEnd = trimEnd;
    lodash.trimStart = trimStart;
    lodash.truncate = truncate;
    lodash.unescape = unescape;
    lodash.uniqueId = uniqueId;
    lodash.upperCase = upperCase;
    lodash.upperFirst = upperFirst;

    // Add aliases.
    lodash.each = forEach;
    lodash.eachRight = forEachRight;
    lodash.first = head;

    mixin(lodash, (function() {
      var source = {};
      baseForOwn(lodash, function(func, methodName) {
        if (!hasOwnProperty.call(lodash.prototype, methodName)) {
          source[methodName] = func;
        }
      });
      return source;
    }()), { 'chain': false });

    /*------------------------------------------------------------------------*/

    /**
     * The semantic version number.
     *
     * @static
     * @memberOf _
     * @type {string}
     */
    lodash.VERSION = VERSION;

    // Assign default placeholders.
    arrayEach(['bind', 'bindKey', 'curry', 'curryRight', 'partial', 'partialRight'], function(methodName) {
      lodash[methodName].placeholder = lodash;
    });

    // Add `LazyWrapper` methods for `_.drop` and `_.take` variants.
    arrayEach(['drop', 'take'], function(methodName, index) {
      LazyWrapper.prototype[methodName] = function(n) {
        var filtered = this.__filtered__;
        if (filtered && !index) {
          return new LazyWrapper(this);
        }
        n = n === undefined ? 1 : nativeMax(toInteger(n), 0);

        var result = this.clone();
        if (filtered) {
          result.__takeCount__ = nativeMin(n, result.__takeCount__);
        } else {
          result.__views__.push({
            'size': nativeMin(n, MAX_ARRAY_LENGTH),
            'type': methodName + (result.__dir__ < 0 ? 'Right' : '')
          });
        }
        return result;
      };

      LazyWrapper.prototype[methodName + 'Right'] = function(n) {
        return this.reverse()[methodName](n).reverse();
      };
    });

    // Add `LazyWrapper` methods that accept an `iteratee` value.
    arrayEach(['filter', 'map', 'takeWhile'], function(methodName, index) {
      var type = index + 1,
          isFilter = type == LAZY_FILTER_FLAG || type == LAZY_WHILE_FLAG;

      LazyWrapper.prototype[methodName] = function(iteratee) {
        var result = this.clone();
        result.__iteratees__.push({
          'iteratee': getIteratee(iteratee, 3),
          'type': type
        });
        result.__filtered__ = result.__filtered__ || isFilter;
        return result;
      };
    });

    // Add `LazyWrapper` methods for `_.head` and `_.last`.
    arrayEach(['head', 'last'], function(methodName, index) {
      var takeName = 'take' + (index ? 'Right' : '');

      LazyWrapper.prototype[methodName] = function() {
        return this[takeName](1).value()[0];
      };
    });

    // Add `LazyWrapper` methods for `_.initial` and `_.tail`.
    arrayEach(['initial', 'tail'], function(methodName, index) {
      var dropName = 'drop' + (index ? '' : 'Right');

      LazyWrapper.prototype[methodName] = function() {
        return this.__filtered__ ? new LazyWrapper(this) : this[dropName](1);
      };
    });

    LazyWrapper.prototype.compact = function() {
      return this.filter(identity);
    };

    LazyWrapper.prototype.find = function(predicate) {
      return this.filter(predicate).head();
    };

    LazyWrapper.prototype.findLast = function(predicate) {
      return this.reverse().find(predicate);
    };

    LazyWrapper.prototype.invokeMap = rest(function(path, args) {
      if (typeof path == 'function') {
        return new LazyWrapper(this);
      }
      return this.map(function(value) {
        return baseInvoke(value, path, args);
      });
    });

    LazyWrapper.prototype.reject = function(predicate) {
      predicate = getIteratee(predicate, 3);
      return this.filter(function(value) {
        return !predicate(value);
      });
    };

    LazyWrapper.prototype.slice = function(start, end) {
      start = toInteger(start);

      var result = this;
      if (result.__filtered__ && (start > 0 || end < 0)) {
        return new LazyWrapper(result);
      }
      if (start < 0) {
        result = result.takeRight(-start);
      } else if (start) {
        result = result.drop(start);
      }
      if (end !== undefined) {
        end = toInteger(end);
        result = end < 0 ? result.dropRight(-end) : result.take(end - start);
      }
      return result;
    };

    LazyWrapper.prototype.takeRightWhile = function(predicate) {
      return this.reverse().takeWhile(predicate).reverse();
    };

    LazyWrapper.prototype.toArray = function() {
      return this.take(MAX_ARRAY_LENGTH);
    };

    // Add `LazyWrapper` methods to `lodash.prototype`.
    baseForOwn(LazyWrapper.prototype, function(func, methodName) {
      var checkIteratee = /^(?:filter|find|map|reject)|While$/.test(methodName),
          isTaker = /^(?:head|last)$/.test(methodName),
          lodashFunc = lodash[isTaker ? ('take' + (methodName == 'last' ? 'Right' : '')) : methodName],
          retUnwrapped = isTaker || /^find/.test(methodName);

      if (!lodashFunc) {
        return;
      }
      lodash.prototype[methodName] = function() {
        var value = this.__wrapped__,
            args = isTaker ? [1] : arguments,
            isLazy = value instanceof LazyWrapper,
            iteratee = args[0],
            useLazy = isLazy || isArray(value);

        var interceptor = function(value) {
          var result = lodashFunc.apply(lodash, arrayPush([value], args));
          return (isTaker && chainAll) ? result[0] : result;
        };

        if (useLazy && checkIteratee && typeof iteratee == 'function' && iteratee.length != 1) {
          // Avoid lazy use if the iteratee has a "length" value other than `1`.
          isLazy = useLazy = false;
        }
        var chainAll = this.__chain__,
            isHybrid = !!this.__actions__.length,
            isUnwrapped = retUnwrapped && !chainAll,
            onlyLazy = isLazy && !isHybrid;

        if (!retUnwrapped && useLazy) {
          value = onlyLazy ? value : new LazyWrapper(this);
          var result = func.apply(value, args);
          result.__actions__.push({ 'func': thru, 'args': [interceptor], 'thisArg': undefined });
          return new LodashWrapper(result, chainAll);
        }
        if (isUnwrapped && onlyLazy) {
          return func.apply(this, args);
        }
        result = this.thru(interceptor);
        return isUnwrapped ? (isTaker ? result.value()[0] : result.value()) : result;
      };
    });

    // Add `Array` methods to `lodash.prototype`.
    arrayEach(['pop', 'push', 'shift', 'sort', 'splice', 'unshift'], function(methodName) {
      var func = arrayProto[methodName],
          chainName = /^(?:push|sort|unshift)$/.test(methodName) ? 'tap' : 'thru',
          retUnwrapped = /^(?:pop|shift)$/.test(methodName);

      lodash.prototype[methodName] = function() {
        var args = arguments;
        if (retUnwrapped && !this.__chain__) {
          var value = this.value();
          return func.apply(isArray(value) ? value : [], args);
        }
        return this[chainName](function(value) {
          return func.apply(isArray(value) ? value : [], args);
        });
      };
    });

    // Map minified method names to their real names.
    baseForOwn(LazyWrapper.prototype, function(func, methodName) {
      var lodashFunc = lodash[methodName];
      if (lodashFunc) {
        var key = (lodashFunc.name + ''),
            names = realNames[key] || (realNames[key] = []);

        names.push({ 'name': methodName, 'func': lodashFunc });
      }
    });

    realNames[createHybridWrapper(undefined, BIND_KEY_FLAG).name] = [{
      'name': 'wrapper',
      'func': undefined
    }];

    // Add methods to `LazyWrapper`.
    LazyWrapper.prototype.clone = lazyClone;
    LazyWrapper.prototype.reverse = lazyReverse;
    LazyWrapper.prototype.value = lazyValue;

    // Add chain sequence methods to the `lodash` wrapper.
    lodash.prototype.at = wrapperAt;
    lodash.prototype.chain = wrapperChain;
    lodash.prototype.commit = wrapperCommit;
    lodash.prototype.next = wrapperNext;
    lodash.prototype.plant = wrapperPlant;
    lodash.prototype.reverse = wrapperReverse;
    lodash.prototype.toJSON = lodash.prototype.valueOf = lodash.prototype.value = wrapperValue;

    if (iteratorSymbol) {
      lodash.prototype[iteratorSymbol] = wrapperToIterator;
    }
    return lodash;
  }

  /*--------------------------------------------------------------------------*/

  // Export lodash.
  var _ = runInContext();

  // Expose lodash on the free variable `window` or `self` when available. This
  // prevents errors in cases where lodash is loaded by a script tag in the presence
  // of an AMD loader. See http://requirejs.org/docs/errors.html#mismatch for more details.
  (freeWindow || freeSelf || {})._ = _;

  // Some AMD build optimizers like r.js check for condition patterns like the following:
  if (typeof define == 'function' && typeof define.amd == 'object' && define.amd) {
    // Define as an anonymous module so, through path mapping, it can be
    // referenced as the "underscore" module.
    define(function() {
      return _;
    });
  }
  // Check for `exports` after `define` in case a build optimizer adds an `exports` object.
  else if (freeExports && freeModule) {
    // Export for Node.js.
    if (moduleExports) {
      (freeModule.exports = _)._ = _;
    }
    // Export for CommonJS support.
    freeExports._ = _;
  }
  else {
    // Export to the global object.
    root._ = _;
  }
}.call(this));
/*! jQuery v2.1.1 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k={},l=a.document,m="2.1.1",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return n.each(this,a,b)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=n.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return!n.isArray(a)&&a-parseFloat(a)>=0},isPlainObject:function(a){return"object"!==n.type(a)||a.nodeType||n.isWindow(a)?!1:a.constructor&&!j.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=n.trim(a),a&&(1===a.indexOf("use strict")?(b=l.createElement("script"),b.text=a,l.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:g.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(c=a[b],b=a,a=c),n.isFunction(a)?(e=d.call(arguments,2),f=function(){return a.apply(b||this,e.concat(d.call(arguments)))},f.guid=a.guid=a.guid||n.guid++,f):void 0},now:Date.now,support:k}),n.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+-new Date,v=a.document,w=0,x=0,y=gb(),z=gb(),A=gb(),B=function(a,b){return a===b&&(l=!0),0},C="undefined",D=1<<31,E={}.hasOwnProperty,F=[],G=F.pop,H=F.push,I=F.push,J=F.slice,K=F.indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},L="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",N="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",O=N.replace("w","w#"),P="\\["+M+"*("+N+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+O+"))|)"+M+"*\\]",Q=":("+N+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+P+")*)|.*)\\)|)",R=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),S=new RegExp("^"+M+"*,"+M+"*"),T=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp("="+M+"*([^\\]'\"]*?)"+M+"*\\]","g"),V=new RegExp(Q),W=new RegExp("^"+O+"$"),X={ID:new RegExp("^#("+N+")"),CLASS:new RegExp("^\\.("+N+")"),TAG:new RegExp("^("+N.replace("w","w*")+")"),ATTR:new RegExp("^"+P),PSEUDO:new RegExp("^"+Q),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+L+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/^(?:input|select|textarea|button)$/i,Z=/^h\d$/i,$=/^[^{]+\{\s*\[native \w/,_=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ab=/[+~]/,bb=/'|\\/g,cb=new RegExp("\\\\([\\da-f]{1,6}"+M+"?|("+M+")|.)","ig"),db=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)};try{I.apply(F=J.call(v.childNodes),v.childNodes),F[v.childNodes.length].nodeType}catch(eb){I={apply:F.length?function(a,b){H.apply(a,J.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fb(a,b,d,e){var f,h,j,k,l,o,r,s,w,x;if((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,d=d||[],!a||"string"!=typeof a)return d;if(1!==(k=b.nodeType)&&9!==k)return[];if(p&&!e){if(f=_.exec(a))if(j=f[1]){if(9===k){if(h=b.getElementById(j),!h||!h.parentNode)return d;if(h.id===j)return d.push(h),d}else if(b.ownerDocument&&(h=b.ownerDocument.getElementById(j))&&t(b,h)&&h.id===j)return d.push(h),d}else{if(f[2])return I.apply(d,b.getElementsByTagName(a)),d;if((j=f[3])&&c.getElementsByClassName&&b.getElementsByClassName)return I.apply(d,b.getElementsByClassName(j)),d}if(c.qsa&&(!q||!q.test(a))){if(s=r=u,w=b,x=9===k&&a,1===k&&"object"!==b.nodeName.toLowerCase()){o=g(a),(r=b.getAttribute("id"))?s=r.replace(bb,"\\$&"):b.setAttribute("id",s),s="[id='"+s+"'] ",l=o.length;while(l--)o[l]=s+qb(o[l]);w=ab.test(a)&&ob(b.parentNode)||b,x=o.join(",")}if(x)try{return I.apply(d,w.querySelectorAll(x)),d}catch(y){}finally{r||b.removeAttribute("id")}}}return i(a.replace(R,"$1"),b,d,e)}function gb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function hb(a){return a[u]=!0,a}function ib(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function jb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function kb(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||D)-(~a.sourceIndex||D);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function lb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function mb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function nb(a){return hb(function(b){return b=+b,hb(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function ob(a){return a&&typeof a.getElementsByTagName!==C&&a}c=fb.support={},f=fb.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fb.setDocument=function(a){var b,e=a?a.ownerDocument||a:v,g=e.defaultView;return e!==n&&9===e.nodeType&&e.documentElement?(n=e,o=e.documentElement,p=!f(e),g&&g!==g.top&&(g.addEventListener?g.addEventListener("unload",function(){m()},!1):g.attachEvent&&g.attachEvent("onunload",function(){m()})),c.attributes=ib(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ib(function(a){return a.appendChild(e.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=$.test(e.getElementsByClassName)&&ib(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length}),c.getById=ib(function(a){return o.appendChild(a).id=u,!e.getElementsByName||!e.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if(typeof b.getElementById!==C&&p){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(cb,db);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(cb,db);return function(a){var c=typeof a.getAttributeNode!==C&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return typeof b.getElementsByTagName!==C?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return typeof b.getElementsByClassName!==C&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=$.test(e.querySelectorAll))&&(ib(function(a){a.innerHTML="<select msallowclip=''><option selected=''></option></select>",a.querySelectorAll("[msallowclip^='']").length&&q.push("[*^$]="+M+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+M+"*(?:value|"+L+")"),a.querySelectorAll(":checked").length||q.push(":checked")}),ib(function(a){var b=e.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+M+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=$.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ib(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",Q)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=$.test(o.compareDocumentPosition),t=b||$.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===e||a.ownerDocument===v&&t(v,a)?-1:b===e||b.ownerDocument===v&&t(v,b)?1:k?K.call(k,a)-K.call(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,f=a.parentNode,g=b.parentNode,h=[a],i=[b];if(!f||!g)return a===e?-1:b===e?1:f?-1:g?1:k?K.call(k,a)-K.call(k,b):0;if(f===g)return kb(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)i.unshift(c);while(h[d]===i[d])d++;return d?kb(h[d],i[d]):h[d]===v?-1:i[d]===v?1:0},e):n},fb.matches=function(a,b){return fb(a,null,null,b)},fb.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(U,"='$1']"),!(!c.matchesSelector||!p||r&&r.test(b)||q&&q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fb(b,n,null,[a]).length>0},fb.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fb.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&E.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fb.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fb.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fb.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fb.selectors={cacheLength:50,createPseudo:hb,match:X,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(cb,db),a[3]=(a[3]||a[4]||a[5]||"").replace(cb,db),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fb.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fb.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return X.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&V.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(cb,db).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+M+")"+a+"("+M+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||typeof a.getAttribute!==C&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fb.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){k=q[u]||(q[u]={}),j=k[a]||[],n=j[0]===w&&j[1],m=j[0]===w&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[w,n,m];break}}else if(s&&(j=(b[u]||(b[u]={}))[a])&&j[0]===w)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(s&&((l[u]||(l[u]={}))[a]=[w,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fb.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?hb(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=K.call(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:hb(function(a){var b=[],c=[],d=h(a.replace(R,"$1"));return d[u]?hb(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),!c.pop()}}),has:hb(function(a){return function(b){return fb(a,b).length>0}}),contains:hb(function(a){return function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:hb(function(a){return W.test(a||"")||fb.error("unsupported lang: "+a),a=a.replace(cb,db).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Z.test(a.nodeName)},input:function(a){return Y.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:nb(function(){return[0]}),last:nb(function(a,b){return[b-1]}),eq:nb(function(a,b,c){return[0>c?c+b:c]}),even:nb(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:nb(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:nb(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:nb(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=lb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=mb(b);function pb(){}pb.prototype=d.filters=d.pseudos,d.setFilters=new pb,g=fb.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=S.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=T.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(R," ")}),h=h.slice(c.length));for(g in d.filter)!(e=X[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fb.error(a):z(a,i).slice(0)};function qb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function rb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[u]||(b[u]={}),(h=i[d])&&h[0]===w&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function sb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function tb(a,b,c){for(var d=0,e=b.length;e>d;d++)fb(a,b[d],c);return c}function ub(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function vb(a,b,c,d,e,f){return d&&!d[u]&&(d=vb(d)),e&&!e[u]&&(e=vb(e,f)),hb(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||tb(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ub(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ub(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?K.call(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ub(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):I.apply(g,r)})}function wb(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=rb(function(a){return a===b},h,!0),l=rb(function(a){return K.call(b,a)>-1},h,!0),m=[function(a,c,d){return!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d))}];f>i;i++)if(c=d.relative[a[i].type])m=[rb(sb(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return vb(i>1&&sb(m),i>1&&qb(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(R,"$1"),c,e>i&&wb(a.slice(i,e)),f>e&&wb(a=a.slice(e)),f>e&&qb(a))}m.push(c)}return sb(m)}function xb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,m,o,p=0,q="0",r=f&&[],s=[],t=j,u=f||e&&d.find.TAG("*",k),v=w+=null==t?1:Math.random()||.1,x=u.length;for(k&&(j=g!==n&&g);q!==x&&null!=(l=u[q]);q++){if(e&&l){m=0;while(o=a[m++])if(o(l,g,h)){i.push(l);break}k&&(w=v)}c&&((l=!o&&l)&&p--,f&&r.push(l))}if(p+=q,c&&q!==p){m=0;while(o=b[m++])o(r,s,g,h);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=G.call(i));s=ub(s)}I.apply(i,s),k&&!f&&s.length>0&&p+b.length>1&&fb.uniqueSort(i)}return k&&(w=v,j=t),r};return c?hb(f):f}return h=fb.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wb(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xb(e,d)),f.selector=a}return f},i=fb.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(cb,db),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=X.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(cb,db),ab.test(j[0].type)&&ob(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qb(j),!a)return I.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,ab.test(a)&&ob(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ib(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ib(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||jb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ib(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||jb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ib(function(a){return null==a.getAttribute("disabled")})||jb(L,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fb}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=n.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return g.call(b,a)>=0!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;c>b;b++)if(n.contains(e[b],this))return!0}));for(b=0;c>b;b++)n.find(a,e[b],d);return d=this.pushStack(c>1?n.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?n(a):a||[],!1).length}});var y,z=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,A=n.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:l,!0)),v.test(c[1])&&n.isPlainObject(b))for(c in b)n.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}return d=l.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=l,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};A.prototype=n.fn,y=n(l);var B=/^(?:parents|prev(?:Until|All))/,C={children:!0,contents:!0,next:!0,prev:!0};n.extend({dir:function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),n.fn.extend({has:function(a){var b=n(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(n.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.unique(f):f)},index:function(a){return a?"string"==typeof a?g.call(n(a),this[0]):g.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.unique(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function D(a,b){while((a=a[b])&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return n.dir(a,"parentNode")},parentsUntil:function(a,b,c){return n.dir(a,"parentNode",c)},next:function(a){return D(a,"nextSibling")},prev:function(a){return D(a,"previousSibling")},nextAll:function(a){return n.dir(a,"nextSibling")},prevAll:function(a){return n.dir(a,"previousSibling")},nextUntil:function(a,b,c){return n.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return n.dir(a,"previousSibling",c)},siblings:function(a){return n.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return n.sibling(a.firstChild)},contents:function(a){return a.contentDocument||n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(C[a]||n.unique(e),B.test(a)&&e.reverse()),this.pushStack(e)}});var E=/\S+/g,F={};function G(a){var b=F[a]={};return n.each(a.match(E)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?F[a]||G(a):n.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(b=a.memory&&l,c=!0,g=e||0,e=0,f=h.length,d=!0;h&&f>g;g++)if(h[g].apply(l[0],l[1])===!1&&a.stopOnFalse){b=!1;break}d=!1,h&&(i?i.length&&j(i.shift()):b?h=[]:k.disable())},k={add:function(){if(h){var c=h.length;!function g(b){n.each(b,function(b,c){var d=n.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&g(c)})}(arguments),d?f=h.length:b&&(e=c,j(b))}return this},remove:function(){return h&&n.each(arguments,function(a,b){var c;while((c=n.inArray(b,h,c))>-1)h.splice(c,1),d&&(f>=c&&f--,g>=c&&g--)}),this},has:function(a){return a?n.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],f=0,this},disable:function(){return h=i=b=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,b||k.disable(),this},locked:function(){return!i},fireWith:function(a,b){return!h||c&&!i||(b=b||[],b=[a,b.slice?b.slice():b],d?i.push(b):j(b)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!c}};return k},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&n.isFunction(a.promise)?e:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var H;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(H.resolveWith(l,[n]),n.fn.triggerHandler&&(n(l).triggerHandler("ready"),n(l).off("ready"))))}});function I(){l.removeEventListener("DOMContentLoaded",I,!1),a.removeEventListener("load",I,!1),n.ready()}n.ready.promise=function(b){return H||(H=n.Deferred(),"complete"===l.readyState?setTimeout(n.ready):(l.addEventListener("DOMContentLoaded",I,!1),a.addEventListener("load",I,!1))),H.promise(b)},n.ready.promise();var J=n.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)n.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f};n.acceptData=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function K(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=n.expando+Math.random()}K.uid=1,K.accepts=n.acceptData,K.prototype={key:function(a){if(!K.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=K.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(d){b[this.expando]=c,n.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,e=this.key(a),f=this.cache[e];if("string"==typeof b)f[b]=c;else if(n.isEmptyObject(f))n.extend(this.cache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[this.key(a)];return void 0===b?c:c[b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,n.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=this.key(a),g=this.cache[f];if(void 0===b)this.cache[f]={};else{n.isArray(b)?d=b.concat(b.map(n.camelCase)):(e=n.camelCase(b),b in g?d=[b,e]:(d=e,d=d in g?[d]:d.match(E)||[])),c=d.length;while(c--)delete g[d[c]]}},hasData:function(a){return!n.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){a[this.expando]&&delete this.cache[a[this.expando]]}};var L=new K,M=new K,N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(O,"-$1").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}M.set(a,b,c)}else c=void 0;return c}n.extend({hasData:function(a){return M.hasData(a)||L.hasData(a)},data:function(a,b,c){return M.access(a,b,c)},removeData:function(a,b){M.remove(a,b)
},_data:function(a,b,c){return L.access(a,b,c)},_removeData:function(a,b){L.remove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=M.get(f),1===f.nodeType&&!L.get(f,"hasDataAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d])));L.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){M.set(this,a)}):J(this,function(b){var c,d=n.camelCase(a);if(f&&void 0===b){if(c=M.get(f,a),void 0!==c)return c;if(c=M.get(f,d),void 0!==c)return c;if(c=P(f,d,void 0),void 0!==c)return c}else this.each(function(){var c=M.get(this,d);M.set(this,d,b),-1!==a.indexOf("-")&&void 0!==c&&M.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){M.remove(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=L.get(a,b),c&&(!d||n.isArray(c)?d=L.access(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return L.get(a,c)||L.access(a,c,{empty:n.Callbacks("once memory").add(function(){L.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=L.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=["Top","Right","Bottom","Left"],S=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)},T=/^(?:checkbox|radio)$/i;!function(){var a=l.createDocumentFragment(),b=a.appendChild(l.createElement("div")),c=l.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),k.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",k.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var U="undefined";k.focusinBubbles="onfocusin"in a;var V=/^key/,W=/^(?:mouse|pointer|contextmenu)|click/,X=/^(?:focusinfocus|focusoutblur)$/,Y=/^([^.]*)(?:\.(.+)|)$/;function Z(){return!0}function $(){return!1}function _(){try{return l.activeElement}catch(a){}}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=L.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=n.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return typeof n!==U&&n.event.triggered!==b.type?n.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(E)||[""],j=b.length;while(j--)h=Y.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o&&(l=n.event.special[o]||{},o=(e?l.delegateType:l.bindType)||o,l=n.event.special[o]||{},k=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[o])||(m=i[o]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(o,g,!1)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),n.event.global[o]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=L.hasData(a)&&L.get(a);if(r&&(i=r.events)){b=(b||"").match(E)||[""],j=b.length;while(j--)if(h=Y.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=i[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete i[o])}else for(o in i)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(i)&&(delete r.handle,L.remove(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,m,o,p=[d||l],q=j.call(b,"type")?b.type:b,r=j.call(b,"namespace")?b.namespace.split("."):[];if(g=h=d=d||l,3!==d.nodeType&&8!==d.nodeType&&!X.test(q+n.event.triggered)&&(q.indexOf(".")>=0&&(r=q.split("."),q=r.shift(),r.sort()),k=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=r.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:n.makeArray(c,[b]),o=n.event.special[q]||{},e||!o.trigger||o.trigger.apply(d,c)!==!1)){if(!e&&!o.noBubble&&!n.isWindow(d)){for(i=o.delegateType||q,X.test(i+q)||(g=g.parentNode);g;g=g.parentNode)p.push(g),h=g;h===(d.ownerDocument||l)&&p.push(h.defaultView||h.parentWindow||a)}f=0;while((g=p[f++])&&!b.isPropagationStopped())b.type=f>1?i:o.bindType||q,m=(L.get(g,"events")||{})[b.type]&&L.get(g,"handle"),m&&m.apply(g,c),m=k&&g[k],m&&m.apply&&n.acceptData(g)&&(b.result=m.apply(g,c),b.result===!1&&b.preventDefault());return b.type=q,e||b.isDefaultPrevented()||o._default&&o._default.apply(p.pop(),c)!==!1||!n.acceptData(d)||k&&n.isFunction(d[q])&&!n.isWindow(d)&&(h=d[k],h&&(d[k]=null),n.event.triggered=q,d[q](),n.event.triggered=void 0,h&&(d[k]=h)),b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(L.get(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(g.namespace))&&(a.handleObj=g,a.data=g.data,e=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(a.result=e)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0||"click"!==a.type){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>=0:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||l,d=c.documentElement,e=c.body,a.pageX=b.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),a.pageY=b.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},fix:function(a){if(a[n.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=W.test(e)?this.mouseHooks:V.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new n.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=l),3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,f):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==_()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===_()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&n.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=n.extend(new n.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?n.event.trigger(e,null,b):n.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?Z:$):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={isDefaultPrevented:$,isPropagationStopped:$,isImmediatePropagationStopped:$,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=Z,a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=Z,a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=Z,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),k.focusinBubbles||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a),!0)};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=L.access(d,b);e||d.addEventListener(a,c,!0),L.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=L.access(d,b)-1;e?L.access(d,b,e):(d.removeEventListener(a,c,!0),L.remove(d,b))}}}),n.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(g in a)this.on(g,b,c,a[g],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=$;else if(!d)return this;return 1===e&&(f=d,d=function(a){return n().off(a),f.apply(this,arguments)},d.guid=f.guid||(f.guid=n.guid++)),this.each(function(){n.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=$),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});var ab=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bb=/<([\w:]+)/,cb=/<|&#?\w+;/,db=/<(?:script|style|link)/i,eb=/checked\s*(?:[^=]|=\s*.checked.)/i,fb=/^$|\/(?:java|ecma)script/i,gb=/^true\/(.*)/,hb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ib={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ib.optgroup=ib.option,ib.tbody=ib.tfoot=ib.colgroup=ib.caption=ib.thead,ib.th=ib.td;function jb(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function kb(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function lb(a){var b=gb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function mb(a,b){for(var c=0,d=a.length;d>c;c++)L.set(a[c],"globalEval",!b||L.get(b[c],"globalEval"))}function nb(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(L.hasData(a)&&(f=L.access(a),g=L.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)n.event.add(b,e,j[e][c])}M.hasData(a)&&(h=M.access(a),i=n.extend({},h),M.set(b,i))}}function ob(a,b){var c=a.getElementsByTagName?a.getElementsByTagName(b||"*"):a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&n.nodeName(a,b)?n.merge([a],c):c}function pb(a,b){var c=b.nodeName.toLowerCase();"input"===c&&T.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}n.extend({clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=n.contains(a.ownerDocument,a);if(!(k.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(g=ob(h),f=ob(a),d=0,e=f.length;e>d;d++)pb(f[d],g[d]);if(b)if(c)for(f=f||ob(a),g=g||ob(h),d=0,e=f.length;e>d;d++)nb(f[d],g[d]);else nb(a,h);return g=ob(h,"script"),g.length>0&&mb(g,!i&&ob(a,"script")),h},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k=b.createDocumentFragment(),l=[],m=0,o=a.length;o>m;m++)if(e=a[m],e||0===e)if("object"===n.type(e))n.merge(l,e.nodeType?[e]:e);else if(cb.test(e)){f=f||k.appendChild(b.createElement("div")),g=(bb.exec(e)||["",""])[1].toLowerCase(),h=ib[g]||ib._default,f.innerHTML=h[1]+e.replace(ab,"<$1></$2>")+h[2],j=h[0];while(j--)f=f.lastChild;n.merge(l,f.childNodes),f=k.firstChild,f.textContent=""}else l.push(b.createTextNode(e));k.textContent="",m=0;while(e=l[m++])if((!d||-1===n.inArray(e,d))&&(i=n.contains(e.ownerDocument,e),f=ob(k.appendChild(e),"script"),i&&mb(f),c)){j=0;while(e=f[j++])fb.test(e.type||"")&&c.push(e)}return k},cleanData:function(a){for(var b,c,d,e,f=n.event.special,g=0;void 0!==(c=a[g]);g++){if(n.acceptData(c)&&(e=c[L.expando],e&&(b=L.cache[e]))){if(b.events)for(d in b.events)f[d]?n.event.remove(c,d):n.removeEvent(c,d,b.handle);L.cache[e]&&delete L.cache[e]}delete M.cache[c[M.expando]]}}}),n.fn.extend({text:function(a){return J(this,function(a){return void 0===a?n.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?n.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||n.cleanData(ob(c)),c.parentNode&&(b&&n.contains(c.ownerDocument,c)&&mb(ob(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(n.cleanData(ob(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return J(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!db.test(a)&&!ib[(bb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(ab,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(ob(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,n.cleanData(ob(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,l=this.length,m=this,o=l-1,p=a[0],q=n.isFunction(p);if(q||l>1&&"string"==typeof p&&!k.checkClone&&eb.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(l&&(c=n.buildFragment(a,this[0].ownerDocument,!1,this),d=c.firstChild,1===c.childNodes.length&&(c=d),d)){for(f=n.map(ob(c,"script"),kb),g=f.length;l>j;j++)h=c,j!==o&&(h=n.clone(h,!0,!0),g&&n.merge(f,ob(h,"script"))),b.call(this[j],h,j);if(g)for(i=f[f.length-1].ownerDocument,n.map(f,lb),j=0;g>j;j++)h=f[j],fb.test(h.type||"")&&!L.access(h,"globalEval")&&n.contains(i,h)&&(h.src?n._evalUrl&&n._evalUrl(h.src):n.globalEval(h.textContent.replace(hb,"")))}return this}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=[],e=n(a),g=e.length-1,h=0;g>=h;h++)c=h===g?this:this.clone(!0),n(e[h])[b](c),f.apply(d,c.get());return this.pushStack(d)}});var qb,rb={};function sb(b,c){var d,e=n(c.createElement(b)).appendTo(c.body),f=a.getDefaultComputedStyle&&(d=a.getDefaultComputedStyle(e[0]))?d.display:n.css(e[0],"display");return e.detach(),f}function tb(a){var b=l,c=rb[a];return c||(c=sb(a,b),"none"!==c&&c||(qb=(qb||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=qb[0].contentDocument,b.write(),b.close(),c=sb(a,b),qb.detach()),rb[a]=c),c}var ub=/^margin/,vb=new RegExp("^("+Q+")(?!px)[a-z%]+$","i"),wb=function(a){return a.ownerDocument.defaultView.getComputedStyle(a,null)};function xb(a,b,c){var d,e,f,g,h=a.style;return c=c||wb(a),c&&(g=c.getPropertyValue(b)||c[b]),c&&(""!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),vb.test(g)&&ub.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+"":g}function yb(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d=l.documentElement,e=l.createElement("div"),f=l.createElement("div");if(f.style){f.style.backgroundClip="content-box",f.cloneNode(!0).style.backgroundClip="",k.clearCloneStyle="content-box"===f.style.backgroundClip,e.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",e.appendChild(f);function g(){f.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",f.innerHTML="",d.appendChild(e);var g=a.getComputedStyle(f,null);b="1%"!==g.top,c="4px"===g.width,d.removeChild(e)}a.getComputedStyle&&n.extend(k,{pixelPosition:function(){return g(),b},boxSizingReliable:function(){return null==c&&g(),c},reliableMarginRight:function(){var b,c=f.appendChild(l.createElement("div"));return c.style.cssText=f.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",f.style.width="1px",d.appendChild(e),b=!parseFloat(a.getComputedStyle(c,null).marginRight),d.removeChild(e),b}})}}(),n.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var zb=/^(none|table(?!-c[ea]).+)/,Ab=new RegExp("^("+Q+")(.*)$","i"),Bb=new RegExp("^([+-])=("+Q+")","i"),Cb={position:"absolute",visibility:"hidden",display:"block"},Db={letterSpacing:"0",fontWeight:"400"},Eb=["Webkit","O","Moz","ms"];function Fb(a,b){if(b in a)return b;var c=b[0].toUpperCase()+b.slice(1),d=b,e=Eb.length;while(e--)if(b=Eb[e]+c,b in a)return b;return d}function Gb(a,b,c){var d=Ab.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Hb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+R[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+R[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+R[f]+"Width",!0,e))):(g+=n.css(a,"padding"+R[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+R[f]+"Width",!0,e)));return g}function Ib(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=wb(a),g="border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=xb(a,b,f),(0>e||null==e)&&(e=a.style[b]),vb.test(e))return e;d=g&&(k.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Hb(a,b,c||(g?"border":"content"),d,f)+"px"}function Jb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=L.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&S(d)&&(f[g]=L.access(d,"olddisplay",tb(d.nodeName)))):(e=S(d),"none"===c&&e||L.set(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=xb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;return b=n.cssProps[h]||(n.cssProps[h]=Fb(i,h)),g=n.cssHooks[b]||n.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=Bb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(n.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||n.cssNumber[h]||(c+="px"),k.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Fb(a.style,h)),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=xb(a,b,d)),"normal"===e&&b in Db&&(e=Db[b]),""===c||c?(f=parseFloat(e),c===!0||n.isNumeric(f)?f||0:e):e}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?zb.test(n.css(a,"display"))&&0===a.offsetWidth?n.swap(a,Cb,function(){return Ib(a,b,d)}):Ib(a,b,d):void 0},set:function(a,c,d){var e=d&&wb(a);return Gb(a,c,d?Hb(a,b,d,"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),n.cssHooks.marginRight=yb(k.reliableMarginRight,function(a,b){return b?n.swap(a,{display:"inline-block"},xb,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+R[d]+b]=f[d]||f[d-2]||f[0];return e}},ub.test(a)||(n.cssHooks[a+b].set=Gb)}),n.fn.extend({css:function(a,b){return J(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=wb(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return Jb(this,!0)},hide:function(){return Jb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){S(this)?n(this).show():n(this).hide()})}});function Kb(a,b,c,d,e){return new Kb.prototype.init(a,b,c,d,e)}n.Tween=Kb,Kb.prototype={constructor:Kb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=Kb.propHooks[this.prop];return a&&a.get?a.get(this):Kb.propHooks._default.get(this)},run:function(a){var b,c=Kb.propHooks[this.prop];return this.pos=b=this.options.duration?n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Kb.propHooks._default.set(this),this}},Kb.prototype.init.prototype=Kb.prototype,Kb.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[n.cssProps[a.prop]]||n.cssHooks[a.prop])?n.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},Kb.propHooks.scrollTop=Kb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},n.fx=Kb.prototype.init,n.fx.step={};var Lb,Mb,Nb=/^(?:toggle|show|hide)$/,Ob=new RegExp("^(?:([+-])=|)("+Q+")([a-z%]*)$","i"),Pb=/queueHooks$/,Qb=[Vb],Rb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=Ob.exec(b),f=e&&e[3]||(n.cssNumber[a]?"":"px"),g=(n.cssNumber[a]||"px"!==f&&+d)&&Ob.exec(n.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,n.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function Sb(){return setTimeout(function(){Lb=void 0}),Lb=n.now()}function Tb(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=R[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ub(a,b,c){for(var d,e=(Rb[b]||[]).concat(Rb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Vb(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},o=a.style,p=a.nodeType&&S(a),q=L.get(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=n.css(a,"display"),k="none"===j?L.get(a,"olddisplay")||tb(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(o.display="inline-block")),c.overflow&&(o.overflow="hidden",l.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Nb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(p?"hide":"show")){if("show"!==e||!q||void 0===q[d])continue;p=!0}m[d]=q&&q[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(m))"inline"===("none"===j?tb(a.nodeName):j)&&(o.display=j);else{q?"hidden"in q&&(p=q.hidden):q=L.access(a,"fxshow",{}),f&&(q.hidden=!p),p?n(a).show():l.done(function(){n(a).hide()}),l.done(function(){var b;L.remove(a,"fxshow");for(b in m)n.style(a,b,m[b])});for(d in m)g=Ub(p?q[d]:0,d,l),d in q||(q[d]=g.start,p&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function Wb(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function Xb(a,b,c){var d,e,f=0,g=Qb.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Lb||Sb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:Lb||Sb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(Wb(k,j.opts.specialEasing);g>f;f++)if(d=Qb[f].call(j,a,k,j.opts))return d;return n.map(k,Ub,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(Xb,{tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],Rb[c]=Rb[c]||[],Rb[c].unshift(b)},prefilter:function(a,b){b?Qb.unshift(a):Qb.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(S).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=Xb(this,n.extend({},a),f);(e||L.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=L.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Pb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=L.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Tb(b,!0),a,d,e)}}),n.each({slideDown:Tb("show"),slideUp:Tb("hide"),slideToggle:Tb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=0,c=n.timers;for(Lb=n.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||n.fx.stop(),Lb=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Mb||(Mb=setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){clearInterval(Mb),Mb=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(a,b){return a=n.fx?n.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a=l.createElement("input"),b=l.createElement("select"),c=b.appendChild(l.createElement("option"));a.type="checkbox",k.checkOn=""!==a.value,k.optSelected=c.selected,b.disabled=!0,k.optDisabled=!c.disabled,a=l.createElement("input"),a.value="t",a.type="radio",k.radioValue="t"===a.value}();var Yb,Zb,$b=n.expr.attrHandle;n.fn.extend({attr:function(a,b){return J(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===U?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),d=n.attrHooks[b]||(n.expr.match.bool.test(b)?Zb:Yb)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=n.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void n.removeAttr(a,b))
},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(E);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!k.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),Zb={set:function(a,b,c){return b===!1?n.removeAttr(a,c):a.setAttribute(c,c),c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=$b[b]||n.find.attr;$b[b]=function(a,b,d){var e,f;return d||(f=$b[b],$b[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,$b[b]=f),e}});var _b=/^(?:input|select|textarea|button)$/i;n.fn.extend({prop:function(a,b){return J(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||a]})}}),n.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!n.isXMLDoc(a),f&&(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||_b.test(a.nodeName)||a.href?a.tabIndex:-1}}}}),k.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this});var ac=/[\t\r\n\f]/g;n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h="string"==typeof a&&a,i=0,j=this.length;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=n.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0===arguments.length||"string"==typeof a&&a,i=0,j=this.length;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?n.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(n.isFunction(a)?function(c){n(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=n(this),f=a.match(E)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===U||"boolean"===c)&&(this.className&&L.set(this,"__className__",this.className),this.className=this.className||a===!1?"":L.get(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(ac," ").indexOf(b)>=0)return!0;return!1}});var bc=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(bc,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a))}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(k.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=n.inArray(d.value,f)>=0)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>=0:void 0}},k.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var cc=n.now(),dc=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&n.error("Invalid XML: "+a),b};var ec,fc,gc=/#.*$/,hc=/([?&])_=[^&]*/,ic=/^(.*?):[ \t]*([^\r\n]*)$/gm,jc=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,kc=/^(?:GET|HEAD)$/,lc=/^\/\//,mc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,nc={},oc={},pc="*/".concat("*");try{fc=location.href}catch(qc){fc=l.createElement("a"),fc.href="",fc=fc.href}ec=mc.exec(fc.toLowerCase())||[];function rc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(E)||[];if(n.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function sc(a,b,c,d){var e={},f=a===oc;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function tc(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&n.extend(!0,a,d),a}function uc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function vc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:fc,type:"GET",isLocal:jc.test(ec[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":pc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?tc(tc(a,n.ajaxSettings),b):tc(n.ajaxSettings,a)},ajaxPrefilter:rc(nc),ajaxTransport:rc(oc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=n.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?n(l):n.event,o=n.Deferred(),p=n.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!f){f={};while(b=ic.exec(e))f[b[1].toLowerCase()]=b[2]}b=f[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?e:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return c&&c.abort(b),x(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||fc)+"").replace(gc,"").replace(lc,ec[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=n.trim(k.dataType||"*").toLowerCase().match(E)||[""],null==k.crossDomain&&(h=mc.exec(k.url.toLowerCase()),k.crossDomain=!(!h||h[1]===ec[1]&&h[2]===ec[2]&&(h[3]||("http:"===h[1]?"80":"443"))===(ec[3]||("http:"===ec[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=n.param(k.data,k.traditional)),sc(nc,k,b,v),2===t)return v;i=k.global,i&&0===n.active++&&n.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!kc.test(k.type),d=k.url,k.hasContent||(k.data&&(d=k.url+=(dc.test(d)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=hc.test(d)?d.replace(hc,"$1_="+cc++):d+(dc.test(d)?"&":"?")+"_="+cc++)),k.ifModified&&(n.lastModified[d]&&v.setRequestHeader("If-Modified-Since",n.lastModified[d]),n.etag[d]&&v.setRequestHeader("If-None-Match",n.etag[d])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+pc+"; q=0.01":""):k.accepts["*"]);for(j in k.headers)v.setRequestHeader(j,k.headers[j]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(j in{success:1,error:1,complete:1})v[j](k[j]);if(c=sc(oc,k,b,v)){v.readyState=1,i&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,c.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,f,h){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),c=void 0,e=h||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,f&&(u=uc(k,v,f)),u=vc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(n.lastModified[d]=w),w=v.getResponseHeader("etag"),w&&(n.etag[d]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?o.resolveWith(l,[r,x,v]):o.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,i&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),i&&(m.trigger("ajaxComplete",[v,k]),--n.active||n.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){var b;return n.isFunction(a)?this.each(function(b){n(this).wrapAll(a.call(this,b))}):(this[0]&&(b=n(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return this.each(n.isFunction(a)?function(b){n(this).wrapInner(a.call(this,b))}:function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var wc=/%20/g,xc=/\[\]$/,yc=/\r?\n/g,zc=/^(?:submit|button|image|reset|file)$/i,Ac=/^(?:input|select|textarea|keygen)/i;function Bc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||xc.test(a)?d(a,e):Bc(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Bc(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Bc(c,a[c],b,e);return d.join("&").replace(wc,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Ac.test(this.nodeName)&&!zc.test(a)&&(this.checked||!T.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(yc,"\r\n")}}):{name:b.name,value:c.replace(yc,"\r\n")}}).get()}}),n.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var Cc=0,Dc={},Ec={0:200,1223:204},Fc=n.ajaxSettings.xhr();a.ActiveXObject&&n(a).on("unload",function(){for(var a in Dc)Dc[a]()}),k.cors=!!Fc&&"withCredentials"in Fc,k.ajax=Fc=!!Fc,n.ajaxTransport(function(a){var b;return k.cors||Fc&&!a.crossDomain?{send:function(c,d){var e,f=a.xhr(),g=++Cc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)f.setRequestHeader(e,c[e]);b=function(a){return function(){b&&(delete Dc[g],b=f.onload=f.onerror=null,"abort"===a?f.abort():"error"===a?d(f.status,f.statusText):d(Ec[f.status]||f.status,f.statusText,"string"==typeof f.responseText?{text:f.responseText}:void 0,f.getAllResponseHeaders()))}},f.onload=b(),f.onerror=b("error"),b=Dc[g]=b("abort");try{f.send(a.hasContent&&a.data||null)}catch(h){if(b)throw h}},abort:function(){b&&b()}}:void 0}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=n("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&e("error"===a.type?404:200,a.type)}),l.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Gc=[],Hc=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Gc.pop()||n.expando+"_"+cc++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Hc.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Hc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Hc,"$1"+e):b.jsonp!==!1&&(b.url+=(dc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Gc.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||l;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=n.buildFragment([a],b,e),e&&e.length&&n(e).remove(),n.merge([],d.childNodes))};var Ic=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&Ic)return Ic.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=n.trim(a.slice(h)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e,dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,f||[a.responseText,b,a])}),this},n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};var Jc=a.document.documentElement;function Kc(a){return n.isWindow(a)?a:9===a.nodeType&&a.defaultView}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,n.contains(b,d)?(typeof d.getBoundingClientRect!==U&&(e=d.getBoundingClientRect()),c=Kc(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===n.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(d=a.offset()),d.top+=n.css(a[0],"borderTopWidth",!0),d.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-n.css(c,"marginTop",!0),left:b.left-d.left-n.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||Jc;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Jc})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(b,c){var d="pageYOffset"===c;n.fn[b]=function(e){return J(this,function(b,e,f){var g=Kc(b);return void 0===f?g?g[c]:b[e]:void(g?g.scrollTo(d?a.pageXOffset:f,d?f:a.pageYOffset):b[e]=f)},b,e,arguments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=yb(k.pixelPosition,function(a,c){return c?(c=xb(a,b),vb.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return J(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var Lc=a.jQuery,Mc=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Mc),b&&a.jQuery===n&&(a.jQuery=Lc),n},typeof b===U&&(a.jQuery=a.$=n),n});
/* mousetrap v1.4.6 craig.is/killing/mice */
(function(J,r,f){function s(a,b,d){a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent("on"+b,d)}function A(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);a.shiftKey||(b=b.toLowerCase());return b}return h[a.which]?h[a.which]:B[a.which]?B[a.which]:String.fromCharCode(a.which).toLowerCase()}function t(a){a=a||{};var b=!1,d;for(d in n)a[d]?b=!0:n[d]=0;b||(u=!1)}function C(a,b,d,c,e,v){var g,k,f=[],h=d.type;if(!l[a])return[];"keyup"==h&&w(a)&&(b=[a]);for(g=0;g<l[a].length;++g)if(k=
l[a][g],!(!c&&k.seq&&n[k.seq]!=k.level||h!=k.action||("keypress"!=h||d.metaKey||d.ctrlKey)&&b.sort().join(",")!==k.modifiers.sort().join(","))){var m=c&&k.seq==c&&k.level==v;(!c&&k.combo==e||m)&&l[a].splice(g,1);f.push(k)}return f}function K(a){var b=[];a.shiftKey&&b.push("shift");a.altKey&&b.push("alt");a.ctrlKey&&b.push("ctrl");a.metaKey&&b.push("meta");return b}function x(a,b,d,c){m.stopCallback(b,b.target||b.srcElement,d,c)||!1!==a(b,d)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?
b.stopPropagation():b.cancelBubble=!0)}function y(a){"number"!==typeof a.which&&(a.which=a.keyCode);var b=A(a);b&&("keyup"==a.type&&z===b?z=!1:m.handleKey(b,K(a),a))}function w(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function L(a,b,d,c){function e(b){return function(){u=b;++n[a];clearTimeout(D);D=setTimeout(t,1E3)}}function v(b){x(d,b,a);"keyup"!==c&&(z=A(b));setTimeout(t,10)}for(var g=n[a]=0;g<b.length;++g){var f=g+1===b.length?v:e(c||E(b[g+1]).action);F(b[g],f,c,a,g)}}function E(a,b){var d,
c,e,f=[];d="+"===a?["+"]:a.split("+");for(e=0;e<d.length;++e)c=d[e],G[c]&&(c=G[c]),b&&"keypress"!=b&&H[c]&&(c=H[c],f.push("shift")),w(c)&&f.push(c);d=c;e=b;if(!e){if(!p){p={};for(var g in h)95<g&&112>g||h.hasOwnProperty(g)&&(p[h[g]]=g)}e=p[d]?"keydown":"keypress"}"keypress"==e&&f.length&&(e="keydown");return{key:c,modifiers:f,action:e}}function F(a,b,d,c,e){q[a+":"+d]=b;a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?L(a,f,b,d):(d=E(a,d),l[d.key]=l[d.key]||[],C(d.key,d.modifiers,{type:d.action},
c,a,e),l[d.key][c?"unshift":"push"]({callback:b,modifiers:d.modifiers,action:d.action,seq:c,level:e,combo:a}))}var h={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},B={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},H={"~":"`","!":"1",
"@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},G={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},p,l={},q={},n={},D,z=!1,I=!1,u=!1;for(f=1;20>f;++f)h[111+f]="f"+f;for(f=0;9>=f;++f)h[f+96]=f;s(r,"keypress",y);s(r,"keydown",y);s(r,"keyup",y);var m={bind:function(a,b,d){a=a instanceof Array?a:[a];for(var c=0;c<a.length;++c)F(a[c],b,d);return this},
unbind:function(a,b){return m.bind(a,function(){},b)},trigger:function(a,b){if(q[a+":"+b])q[a+":"+b]({},a);return this},reset:function(){l={};q={};return this},stopCallback:function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:function(a,b,d){var c=C(a,b,d),e;b={};var f=0,g=!1;for(e=0;e<c.length;++e)c[e].seq&&(f=Math.max(f,c[e].level));for(e=0;e<c.length;++e)c[e].seq?c[e].level==f&&(g=!0,
b[c[e].seq]=1,x(c[e].callback,d,c[e].combo,c[e].seq)):g||x(c[e].callback,d,c[e].combo);c="keypress"==d.type&&I;d.type!=u||w(a)||c||t(b);I=g&&"keydown"==d.type}};J.Mousetrap=m;"function"===typeof define&&define.amd&&define(m)})(window,document);
/*!
 * jScrollPane - v2.0.19 - 2013-11-16
 * http://jscrollpane.kelvinluck.com/
 *
 * Copyright (c) 2013 Kelvin Luck
 * Dual licensed under the MIT or GPL licenses.
 */
!function(a,b,c){a.fn.jScrollPane=function(d){function e(d,e){function f(b){var e,h,j,l,m,n,q=!1,r=!1;if(P=b,Q===c)m=d.scrollTop(),n=d.scrollLeft(),d.css({overflow:"hidden",padding:0}),R=d.innerWidth()+tb,S=d.innerHeight(),d.width(R),Q=a('<div class="jspPane" />').css("padding",sb).append(d.children()),T=a('<div class="jspContainer" />').css({width:R+"px",height:S+"px"}).append(Q).appendTo(d);else{if(d.css("width",""),q=P.stickToBottom&&C(),r=P.stickToRight&&D(),l=d.innerWidth()+tb!=R||d.outerHeight()!=S,l&&(R=d.innerWidth()+tb,S=d.innerHeight(),T.css({width:R+"px",height:S+"px"})),!l&&ub==U&&Q.outerHeight()==V)return d.width(R),void 0;ub=U,Q.css("width",""),d.width(R),T.find(">.jspVerticalBar,>.jspHorizontalBar").remove().end()}Q.css("overflow","auto"),U=b.contentWidth?b.contentWidth:Q[0].scrollWidth,V=Q[0].scrollHeight,Q.css("overflow",""),W=U/R,X=V/S,Y=X>1,Z=W>1,Z||Y?(d.addClass("jspScrollable"),e=P.maintainPosition&&(ab||db),e&&(h=A(),j=B()),g(),i(),k(),e&&(y(r?U-R:h,!1),x(q?V-S:j,!1)),H(),E(),N(),P.enableKeyboardNavigation&&J(),P.clickOnTrack&&o(),L(),P.hijackInternalLinks&&M()):(d.removeClass("jspScrollable"),Q.css({top:0,left:0,width:T.width()-tb}),F(),I(),K(),p()),P.autoReinitialise&&!rb?rb=setInterval(function(){f(P)},P.autoReinitialiseDelay):!P.autoReinitialise&&rb&&clearInterval(rb),m&&d.scrollTop(0)&&x(m,!1),n&&d.scrollLeft(0)&&y(n,!1),d.trigger("jsp-initialised",[Z||Y])}function g(){Y&&(T.append(a('<div class="jspVerticalBar" />').append(a('<div class="jspCap jspCapTop" />'),a('<div class="jspTrack" />').append(a('<div class="jspDrag" />').append(a('<div class="jspDragTop" />'),a('<div class="jspDragBottom" />'))),a('<div class="jspCap jspCapBottom" />'))),eb=T.find(">.jspVerticalBar"),fb=eb.find(">.jspTrack"),$=fb.find(">.jspDrag"),P.showArrows&&(jb=a('<a class="jspArrow jspArrowUp" />').bind("mousedown.jsp",m(0,-1)).bind("click.jsp",G),kb=a('<a class="jspArrow jspArrowDown" />').bind("mousedown.jsp",m(0,1)).bind("click.jsp",G),P.arrowScrollOnHover&&(jb.bind("mouseover.jsp",m(0,-1,jb)),kb.bind("mouseover.jsp",m(0,1,kb))),l(fb,P.verticalArrowPositions,jb,kb)),hb=S,T.find(">.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow").each(function(){hb-=a(this).outerHeight()}),$.hover(function(){$.addClass("jspHover")},function(){$.removeClass("jspHover")}).bind("mousedown.jsp",function(b){a("html").bind("dragstart.jsp selectstart.jsp",G),$.addClass("jspActive");var c=b.pageY-$.position().top;return a("html").bind("mousemove.jsp",function(a){r(a.pageY-c,!1)}).bind("mouseup.jsp mouseleave.jsp",q),!1}),h())}function h(){fb.height(hb+"px"),ab=0,gb=P.verticalGutter+fb.outerWidth(),Q.width(R-gb-tb);try{0===eb.position().left&&Q.css("margin-left",gb+"px")}catch(a){}}function i(){Z&&(T.append(a('<div class="jspHorizontalBar" />').append(a('<div class="jspCap jspCapLeft" />'),a('<div class="jspTrack" />').append(a('<div class="jspDrag" />').append(a('<div class="jspDragLeft" />'),a('<div class="jspDragRight" />'))),a('<div class="jspCap jspCapRight" />'))),lb=T.find(">.jspHorizontalBar"),mb=lb.find(">.jspTrack"),bb=mb.find(">.jspDrag"),P.showArrows&&(pb=a('<a class="jspArrow jspArrowLeft" />').bind("mousedown.jsp",m(-1,0)).bind("click.jsp",G),qb=a('<a class="jspArrow jspArrowRight" />').bind("mousedown.jsp",m(1,0)).bind("click.jsp",G),P.arrowScrollOnHover&&(pb.bind("mouseover.jsp",m(-1,0,pb)),qb.bind("mouseover.jsp",m(1,0,qb))),l(mb,P.horizontalArrowPositions,pb,qb)),bb.hover(function(){bb.addClass("jspHover")},function(){bb.removeClass("jspHover")}).bind("mousedown.jsp",function(b){a("html").bind("dragstart.jsp selectstart.jsp",G),bb.addClass("jspActive");var c=b.pageX-bb.position().left;return a("html").bind("mousemove.jsp",function(a){t(a.pageX-c,!1)}).bind("mouseup.jsp mouseleave.jsp",q),!1}),nb=T.innerWidth(),j())}function j(){T.find(">.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow").each(function(){nb-=a(this).outerWidth()}),mb.width(nb+"px"),db=0}function k(){if(Z&&Y){var b=mb.outerHeight(),c=fb.outerWidth();hb-=b,a(lb).find(">.jspCap:visible,>.jspArrow").each(function(){nb+=a(this).outerWidth()}),nb-=c,S-=c,R-=b,mb.parent().append(a('<div class="jspCorner" />').css("width",b+"px")),h(),j()}Z&&Q.width(T.outerWidth()-tb+"px"),V=Q.outerHeight(),X=V/S,Z&&(ob=Math.ceil(1/W*nb),ob>P.horizontalDragMaxWidth?ob=P.horizontalDragMaxWidth:ob<P.horizontalDragMinWidth&&(ob=P.horizontalDragMinWidth),bb.width(ob+"px"),cb=nb-ob,u(db)),Y&&(ib=Math.ceil(1/X*hb),ib>P.verticalDragMaxHeight?ib=P.verticalDragMaxHeight:ib<P.verticalDragMinHeight&&(ib=P.verticalDragMinHeight),$.height(ib+"px"),_=hb-ib,s(ab))}function l(a,b,c,d){var e,f="before",g="after";"os"==b&&(b=/Mac/.test(navigator.platform)?"after":"split"),b==f?g=b:b==g&&(f=b,e=c,c=d,d=e),a[f](c)[g](d)}function m(a,b,c){return function(){return n(a,b,this,c),this.blur(),!1}}function n(b,c,d,e){d=a(d).addClass("jspActive");var f,g,h=!0,i=function(){0!==b&&vb.scrollByX(b*P.arrowButtonSpeed),0!==c&&vb.scrollByY(c*P.arrowButtonSpeed),g=setTimeout(i,h?P.initialDelay:P.arrowRepeatFreq),h=!1};i(),f=e?"mouseout.jsp":"mouseup.jsp",e=e||a("html"),e.bind(f,function(){d.removeClass("jspActive"),g&&clearTimeout(g),g=null,e.unbind(f)})}function o(){p(),Y&&fb.bind("mousedown.jsp",function(b){if(b.originalTarget===c||b.originalTarget==b.currentTarget){var d,e=a(this),f=e.offset(),g=b.pageY-f.top-ab,h=!0,i=function(){var a=e.offset(),c=b.pageY-a.top-ib/2,f=S*P.scrollPagePercent,k=_*f/(V-S);if(0>g)ab-k>c?vb.scrollByY(-f):r(c);else{if(!(g>0))return j(),void 0;c>ab+k?vb.scrollByY(f):r(c)}d=setTimeout(i,h?P.initialDelay:P.trackClickRepeatFreq),h=!1},j=function(){d&&clearTimeout(d),d=null,a(document).unbind("mouseup.jsp",j)};return i(),a(document).bind("mouseup.jsp",j),!1}}),Z&&mb.bind("mousedown.jsp",function(b){if(b.originalTarget===c||b.originalTarget==b.currentTarget){var d,e=a(this),f=e.offset(),g=b.pageX-f.left-db,h=!0,i=function(){var a=e.offset(),c=b.pageX-a.left-ob/2,f=R*P.scrollPagePercent,k=cb*f/(U-R);if(0>g)db-k>c?vb.scrollByX(-f):t(c);else{if(!(g>0))return j(),void 0;c>db+k?vb.scrollByX(f):t(c)}d=setTimeout(i,h?P.initialDelay:P.trackClickRepeatFreq),h=!1},j=function(){d&&clearTimeout(d),d=null,a(document).unbind("mouseup.jsp",j)};return i(),a(document).bind("mouseup.jsp",j),!1}})}function p(){mb&&mb.unbind("mousedown.jsp"),fb&&fb.unbind("mousedown.jsp")}function q(){a("html").unbind("dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp"),$&&$.removeClass("jspActive"),bb&&bb.removeClass("jspActive")}function r(a,b){Y&&(0>a?a=0:a>_&&(a=_),b===c&&(b=P.animateScroll),b?vb.animate($,"top",a,s):($.css("top",a),s(a)))}function s(a){a===c&&(a=$.position().top),T.scrollTop(0),ab=a;var b=0===ab,e=ab==_,f=a/_,g=-f*(V-S);(wb!=b||yb!=e)&&(wb=b,yb=e,d.trigger("jsp-arrow-change",[wb,yb,xb,zb])),v(b,e),Q.css("top",g),d.trigger("jsp-scroll-y",[-g,b,e]).trigger("scroll")}function t(a,b){Z&&(0>a?a=0:a>cb&&(a=cb),b===c&&(b=P.animateScroll),b?vb.animate(bb,"left",a,u):(bb.css("left",a),u(a)))}function u(a){a===c&&(a=bb.position().left),T.scrollTop(0),db=a;var b=0===db,e=db==cb,f=a/cb,g=-f*(U-R);(xb!=b||zb!=e)&&(xb=b,zb=e,d.trigger("jsp-arrow-change",[wb,yb,xb,zb])),w(b,e),Q.css("left",g),d.trigger("jsp-scroll-x",[-g,b,e]).trigger("scroll")}function v(a,b){P.showArrows&&(jb[a?"addClass":"removeClass"]("jspDisabled"),kb[b?"addClass":"removeClass"]("jspDisabled"))}function w(a,b){P.showArrows&&(pb[a?"addClass":"removeClass"]("jspDisabled"),qb[b?"addClass":"removeClass"]("jspDisabled"))}function x(a,b){var c=a/(V-S);r(c*_,b)}function y(a,b){var c=a/(U-R);t(c*cb,b)}function z(b,c,d){var e,f,g,h,i,j,k,l,m,n=0,o=0;try{e=a(b)}catch(p){return}for(f=e.outerHeight(),g=e.outerWidth(),T.scrollTop(0),T.scrollLeft(0);!e.is(".jspPane");)if(n+=e.position().top,o+=e.position().left,e=e.offsetParent(),/^body|html$/i.test(e[0].nodeName))return;h=B(),j=h+S,h>n||c?l=n-P.horizontalGutter:n+f>j&&(l=n-S+f+P.horizontalGutter),isNaN(l)||x(l,d),i=A(),k=i+R,i>o||c?m=o-P.horizontalGutter:o+g>k&&(m=o-R+g+P.horizontalGutter),isNaN(m)||y(m,d)}function A(){return-Q.position().left}function B(){return-Q.position().top}function C(){var a=V-S;return a>20&&a-B()<10}function D(){var a=U-R;return a>20&&a-A()<10}function E(){T.unbind(Bb).bind(Bb,function(a,b,c,d){var e=db,f=ab,g=a.deltaFactor||P.mouseWheelSpeed;return vb.scrollBy(c*g,-d*g,!1),e==db&&f==ab})}function F(){T.unbind(Bb)}function G(){return!1}function H(){Q.find(":input,a").unbind("focus.jsp").bind("focus.jsp",function(a){z(a.target,!1)})}function I(){Q.find(":input,a").unbind("focus.jsp")}function J(){function b(){var a=db,b=ab;switch(c){case 40:vb.scrollByY(P.keyboardSpeed,!1);break;case 38:vb.scrollByY(-P.keyboardSpeed,!1);break;case 34:case 32:vb.scrollByY(S*P.scrollPagePercent,!1);break;case 33:vb.scrollByY(-S*P.scrollPagePercent,!1);break;case 39:vb.scrollByX(P.keyboardSpeed,!1);break;case 37:vb.scrollByX(-P.keyboardSpeed,!1)}return e=a!=db||b!=ab}var c,e,f=[];Z&&f.push(lb[0]),Y&&f.push(eb[0]),Q.focus(function(){d.focus()}),d.attr("tabindex",0).unbind("keydown.jsp keypress.jsp").bind("keydown.jsp",function(d){if(d.target===this||f.length&&a(d.target).closest(f).length){var g=db,h=ab;switch(d.keyCode){case 40:case 38:case 34:case 32:case 33:case 39:case 37:c=d.keyCode,b();break;case 35:x(V-S),c=null;break;case 36:x(0),c=null}return e=d.keyCode==c&&g!=db||h!=ab,!e}}).bind("keypress.jsp",function(a){return a.keyCode==c&&b(),!e}),P.hideFocus?(d.css("outline","none"),"hideFocus"in T[0]&&d.attr("hideFocus",!0)):(d.css("outline",""),"hideFocus"in T[0]&&d.attr("hideFocus",!1))}function K(){d.attr("tabindex","-1").removeAttr("tabindex").unbind("keydown.jsp keypress.jsp")}function L(){if(location.hash&&location.hash.length>1){var b,c,d=escape(location.hash.substr(1));try{b=a("#"+d+', a[name="'+d+'"]')}catch(e){return}b.length&&Q.find(d)&&(0===T.scrollTop()?c=setInterval(function(){T.scrollTop()>0&&(z(b,!0),a(document).scrollTop(T.position().top),clearInterval(c))},50):(z(b,!0),a(document).scrollTop(T.position().top)))}}function M(){a(document.body).data("jspHijack")||(a(document.body).data("jspHijack",!0),a(document.body).delegate("a[href*=#]","click",function(c){var d,e,f,g,h,i,j=this.href.substr(0,this.href.indexOf("#")),k=location.href;if(-1!==location.href.indexOf("#")&&(k=location.href.substr(0,location.href.indexOf("#"))),j===k){d=escape(this.href.substr(this.href.indexOf("#")+1));try{e=a("#"+d+', a[name="'+d+'"]')}catch(l){return}e.length&&(f=e.closest(".jspScrollable"),g=f.data("jsp"),g.scrollToElement(e,!0),f[0].scrollIntoView&&(h=a(b).scrollTop(),i=e.offset().top,(h>i||i>h+a(b).height())&&f[0].scrollIntoView()),c.preventDefault())}}))}function N(){var a,b,c,d,e,f=!1;T.unbind("touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick").bind("touchstart.jsp",function(g){var h=g.originalEvent.touches[0];a=A(),b=B(),c=h.pageX,d=h.pageY,e=!1,f=!0}).bind("touchmove.jsp",function(g){if(f){var h=g.originalEvent.touches[0],i=db,j=ab;return vb.scrollTo(a+c-h.pageX,b+d-h.pageY),e=e||Math.abs(c-h.pageX)>5||Math.abs(d-h.pageY)>5,i==db&&j==ab}}).bind("touchend.jsp",function(){f=!1}).bind("click.jsp-touchclick",function(){return e?(e=!1,!1):void 0})}function O(){var a=B(),b=A();d.removeClass("jspScrollable").unbind(".jsp"),d.replaceWith(Ab.append(Q.children())),Ab.scrollTop(a),Ab.scrollLeft(b),rb&&clearInterval(rb)}var P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb,ob,pb,qb,rb,sb,tb,ub,vb=this,wb=!0,xb=!0,yb=!1,zb=!1,Ab=d.clone(!1,!1).empty(),Bb=a.fn.mwheelIntent?"mwheelIntent.jsp":"mousewheel.jsp";"border-box"===d.css("box-sizing")?(sb=0,tb=0):(sb=d.css("paddingTop")+" "+d.css("paddingRight")+" "+d.css("paddingBottom")+" "+d.css("paddingLeft"),tb=(parseInt(d.css("paddingLeft"),10)||0)+(parseInt(d.css("paddingRight"),10)||0)),a.extend(vb,{reinitialise:function(b){b=a.extend({},P,b),f(b)},scrollToElement:function(a,b,c){z(a,b,c)},scrollTo:function(a,b,c){y(a,c),x(b,c)},scrollToX:function(a,b){y(a,b)},scrollToY:function(a,b){x(a,b)},scrollToPercentX:function(a,b){y(a*(U-R),b)},scrollToPercentY:function(a,b){x(a*(V-S),b)},scrollBy:function(a,b,c){vb.scrollByX(a,c),vb.scrollByY(b,c)},scrollByX:function(a,b){var c=A()+Math[0>a?"floor":"ceil"](a),d=c/(U-R);t(d*cb,b)},scrollByY:function(a,b){var c=B()+Math[0>a?"floor":"ceil"](a),d=c/(V-S);r(d*_,b)},positionDragX:function(a,b){t(a,b)},positionDragY:function(a,b){r(a,b)},animate:function(a,b,c,d){var e={};e[b]=c,a.animate(e,{duration:P.animateDuration,easing:P.animateEase,queue:!1,step:d})},getContentPositionX:function(){return A()},getContentPositionY:function(){return B()},getContentWidth:function(){return U},getContentHeight:function(){return V},getPercentScrolledX:function(){return A()/(U-R)},getPercentScrolledY:function(){return B()/(V-S)},getIsScrollableH:function(){return Z},getIsScrollableV:function(){return Y},getContentPane:function(){return Q},scrollToBottom:function(a){r(_,a)},hijackInternalLinks:a.noop,destroy:function(){O()}}),f(e)}return d=a.extend({},a.fn.jScrollPane.defaults,d),a.each(["arrowButtonSpeed","trackClickSpeed","keyboardSpeed"],function(){d[this]=d[this]||d.speed}),this.each(function(){var b=a(this),c=b.data("jsp");c?c.reinitialise(d):(a("script",b).filter('[type="text/javascript"],:not([type])').remove(),c=new e(b,d),b.data("jsp",c))})},a.fn.jScrollPane.defaults={showArrows:!1,maintainPosition:!0,stickToBottom:!1,stickToRight:!1,clickOnTrack:!0,autoReinitialise:!1,autoReinitialiseDelay:500,verticalDragMinHeight:0,verticalDragMaxHeight:99999,horizontalDragMinWidth:0,horizontalDragMaxWidth:99999,contentWidth:c,animateScroll:!1,animateDuration:300,animateEase:"linear",hijackInternalLinks:!1,verticalGutter:4,horizontalGutter:4,mouseWheelSpeed:3,arrowButtonSpeed:0,arrowRepeatFreq:50,arrowScrollOnHover:!1,trackClickSpeed:0,trackClickRepeatFreq:70,verticalArrowPositions:"split",horizontalArrowPositions:"split",enableKeyboardNavigation:!0,hideFocus:!1,keyboardSpeed:0,initialDelay:300,speed:30,scrollPagePercent:.8}}(jQuery,this);

	/*!
 * jQuery Mousewheel 3.1.12
 *
 * Copyright 2014 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */

(function (factory) {
    if ( typeof define === 'function' && define.amd ) {
        // AMD. Register as an anonymous module.
        define(['jquery'], factory);
    } else if (typeof exports === 'object') {
        // Node/CommonJS style for Browserify
        module.exports = factory;
    } else {
        // Browser globals
        factory(jQuery);
    }
}(function ($) {

    var toFix  = ['wheel', 'mousewheel', 'DOMMouseScroll', 'MozMousePixelScroll'],
        toBind = ( 'onwheel' in document || document.documentMode >= 9 ) ?
                    ['wheel'] : ['mousewheel', 'DomMouseScroll', 'MozMousePixelScroll'],
        slice  = Array.prototype.slice,
        nullLowestDeltaTimeout, lowestDelta;

    if ( $.event.fixHooks ) {
        for ( var i = toFix.length; i; ) {
            $.event.fixHooks[ toFix[--i] ] = $.event.mouseHooks;
        }
    }

    var special = $.event.special.mousewheel = {
        version: '3.1.12',

        setup: function() {
            if ( this.addEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.addEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = handler;
            }
            // Store the line height and page height for this particular element
            $.data(this, 'mousewheel-line-height', special.getLineHeight(this));
            $.data(this, 'mousewheel-page-height', special.getPageHeight(this));
        },

        teardown: function() {
            if ( this.removeEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.removeEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = null;
            }
            // Clean up the data we added to the element
            $.removeData(this, 'mousewheel-line-height');
            $.removeData(this, 'mousewheel-page-height');
        },

        getLineHeight: function(elem) {
            var $elem = $(elem),
                $parent = $elem['offsetParent' in $.fn ? 'offsetParent' : 'parent']();
            if (!$parent.length) {
                $parent = $('body');
            }
            return parseInt($parent.css('fontSize'), 10) || parseInt($elem.css('fontSize'), 10) || 16;
        },

        getPageHeight: function(elem) {
            return $(elem).height();
        },

        settings: {
            adjustOldDeltas: true, // see shouldAdjustOldDeltas() below
            normalizeOffset: true  // calls getBoundingClientRect for each event
        }
    };

    $.fn.extend({
        mousewheel: function(fn) {
            return fn ? this.bind('mousewheel', fn) : this.trigger('mousewheel');
        },

        unmousewheel: function(fn) {
            return this.unbind('mousewheel', fn);
        }
    });


    function handler(event) {
        var orgEvent   = event || window.event,
            args       = slice.call(arguments, 1),
            delta      = 0,
            deltaX     = 0,
            deltaY     = 0,
            absDelta   = 0,
            offsetX    = 0,
            offsetY    = 0;
        event = $.event.fix(orgEvent);
        event.type = 'mousewheel';

        // Old school scrollwheel delta
        if ( 'detail'      in orgEvent ) { deltaY = orgEvent.detail * -1;      }
        if ( 'wheelDelta'  in orgEvent ) { deltaY = orgEvent.wheelDelta;       }
        if ( 'wheelDeltaY' in orgEvent ) { deltaY = orgEvent.wheelDeltaY;      }
        if ( 'wheelDeltaX' in orgEvent ) { deltaX = orgEvent.wheelDeltaX * -1; }

        // Firefox < 17 horizontal scrolling related to DOMMouseScroll event
        if ( 'axis' in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS ) {
            deltaX = deltaY * -1;
            deltaY = 0;
        }

        // Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
        delta = deltaY === 0 ? deltaX : deltaY;

        // New school wheel delta (wheel event)
        if ( 'deltaY' in orgEvent ) {
            deltaY = orgEvent.deltaY * -1;
            delta  = deltaY;
        }
        if ( 'deltaX' in orgEvent ) {
            deltaX = orgEvent.deltaX;
            if ( deltaY === 0 ) { delta  = deltaX * -1; }
        }

        // No change actually happened, no reason to go any further
        if ( deltaY === 0 && deltaX === 0 ) { return; }

        // Need to convert lines and pages to pixels if we aren't already in pixels
        // There are three delta modes:
        //   * deltaMode 0 is by pixels, nothing to do
        //   * deltaMode 1 is by lines
        //   * deltaMode 2 is by pages
        if ( orgEvent.deltaMode === 1 ) {
            var lineHeight = $.data(this, 'mousewheel-line-height');
            delta  *= lineHeight;
            deltaY *= lineHeight;
            deltaX *= lineHeight;
        } else if ( orgEvent.deltaMode === 2 ) {
            var pageHeight = $.data(this, 'mousewheel-page-height');
            delta  *= pageHeight;
            deltaY *= pageHeight;
            deltaX *= pageHeight;
        }

        // Store lowest absolute delta to normalize the delta values
        absDelta = Math.max( Math.abs(deltaY), Math.abs(deltaX) );

        if ( !lowestDelta || absDelta < lowestDelta ) {
            lowestDelta = absDelta;

            // Adjust older deltas if necessary
            if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
                lowestDelta /= 40;
            }
        }

        // Adjust older deltas if necessary
        if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
            // Divide all the things by 40!
            delta  /= 40;
            deltaX /= 40;
            deltaY /= 40;
        }

        // Get a whole, normalized value for the deltas
        delta  = Math[ delta  >= 1 ? 'floor' : 'ceil' ](delta  / lowestDelta);
        deltaX = Math[ deltaX >= 1 ? 'floor' : 'ceil' ](deltaX / lowestDelta);
        deltaY = Math[ deltaY >= 1 ? 'floor' : 'ceil' ](deltaY / lowestDelta);

        // Normalise offsetX and offsetY properties
        if ( special.settings.normalizeOffset && this.getBoundingClientRect ) {
            var boundingRect = this.getBoundingClientRect();
            offsetX = event.clientX - boundingRect.left;
            offsetY = event.clientY - boundingRect.top;
        }

        // Add information to the event object
        event.deltaX = deltaX;
        event.deltaY = deltaY;
        event.deltaFactor = lowestDelta;
        event.offsetX = offsetX;
        event.offsetY = offsetY;
        // Go ahead and set deltaMode to 0 since we converted to pixels
        // Although this is a little odd since we overwrite the deltaX/Y
        // properties with normalized deltas.
        event.deltaMode = 0;

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        // Clearout lowestDelta after sometime to better
        // handle multiple device types that give different
        // a different lowestDelta
        // Ex: trackpad = 3 and mouse wheel = 120
        if (nullLowestDeltaTimeout) { clearTimeout(nullLowestDeltaTimeout); }
        nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

    function nullLowestDelta() {
        lowestDelta = null;
    }

    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        // If this is an older event and the delta is divisable by 120,
        // then we are assuming that the browser is treating this as an
        // older mouse wheel event and that we should divide the deltas
        // by 40 to try and get a more usable deltaFactor.
        // Side note, this actually impacts the reported scroll distance
        // in older browsers and can cause scrolling to be slower than native.
        // Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
        return special.settings.adjustOldDeltas && orgEvent.type === 'mousewheel' && absDelta % 120 === 0;
    }

}));
/*
 * jQuery UI Widget 1.10.3+amd
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */

(function (factory) {
    if (typeof define === "function" && define.amd) {
        // Register as an anonymous AMD module:
        define(["jquery"], factory);
    } else {
        // Browser globals:
        factory(jQuery);
    }
}(function( $, undefined ) {

var uuid = 0,
	slice = Array.prototype.slice,
	_cleanData = $.cleanData;
$.cleanData = function( elems ) {
	for ( var i = 0, elem; (elem = elems[i]) != null; i++ ) {
		try {
			$( elem ).triggerHandler( "remove" );
		// http://bugs.jquery.com/ticket/8235
		} catch( e ) {}
	}
	_cleanData( elems );
};

$.widget = function( name, base, prototype ) {
	var fullName, existingConstructor, constructor, basePrototype,
		// proxiedPrototype allows the provided prototype to remain unmodified
		// so that it can be used as a mixin for multiple widgets (#8876)
		proxiedPrototype = {},
		namespace = name.split( "." )[ 0 ];

	name = name.split( "." )[ 1 ];
	fullName = namespace + "-" + name;

	if ( !prototype ) {
		prototype = base;
		base = $.Widget;
	}

	// create selector for plugin
	$.expr[ ":" ][ fullName.toLowerCase() ] = function( elem ) {
		return !!$.data( elem, fullName );
	};

	$[ namespace ] = $[ namespace ] || {};
	existingConstructor = $[ namespace ][ name ];
	constructor = $[ namespace ][ name ] = function( options, element ) {
		// allow instantiation without "new" keyword
		if ( !this._createWidget ) {
			return new constructor( options, element );
		}

		// allow instantiation without initializing for simple inheritance
		// must use "new" keyword (the code above always passes args)
		if ( arguments.length ) {
			this._createWidget( options, element );
		}
	};
	// extend with the existing constructor to carry over any static properties
	$.extend( constructor, existingConstructor, {
		version: prototype.version,
		// copy the object used to create the prototype in case we need to
		// redefine the widget later
		_proto: $.extend( {}, prototype ),
		// track widgets that inherit from this widget in case this widget is
		// redefined after a widget inherits from it
		_childConstructors: []
	});

	basePrototype = new base();
	// we need to make the options hash a property directly on the new instance
	// otherwise we'll modify the options hash on the prototype that we're
	// inheriting from
	basePrototype.options = $.widget.extend( {}, basePrototype.options );
	$.each( prototype, function( prop, value ) {
		if ( !$.isFunction( value ) ) {
			proxiedPrototype[ prop ] = value;
			return;
		}
		proxiedPrototype[ prop ] = (function() {
			var _super = function() {
					return base.prototype[ prop ].apply( this, arguments );
				},
				_superApply = function( args ) {
					return base.prototype[ prop ].apply( this, args );
				};
			return function() {
				var __super = this._super,
					__superApply = this._superApply,
					returnValue;

				this._super = _super;
				this._superApply = _superApply;

				returnValue = value.apply( this, arguments );

				this._super = __super;
				this._superApply = __superApply;

				return returnValue;
			};
		})();
	});
	constructor.prototype = $.widget.extend( basePrototype, {
		// TODO: remove support for widgetEventPrefix
		// always use the name + a colon as the prefix, e.g., draggable:start
		// don't prefix for widgets that aren't DOM-based
		widgetEventPrefix: existingConstructor ? basePrototype.widgetEventPrefix : name
	}, proxiedPrototype, {
		constructor: constructor,
		namespace: namespace,
		widgetName: name,
		widgetFullName: fullName
	});

	// If this widget is being redefined then we need to find all widgets that
	// are inheriting from it and redefine all of them so that they inherit from
	// the new version of this widget. We're essentially trying to replace one
	// level in the prototype chain.
	if ( existingConstructor ) {
		$.each( existingConstructor._childConstructors, function( i, child ) {
			var childPrototype = child.prototype;

			// redefine the child widget using the same prototype that was
			// originally used, but inherit from the new version of the base
			$.widget( childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto );
		});
		// remove the list of existing child constructors from the old constructor
		// so the old child constructors can be garbage collected
		delete existingConstructor._childConstructors;
	} else {
		base._childConstructors.push( constructor );
	}

	$.widget.bridge( name, constructor );
};

$.widget.extend = function( target ) {
	var input = slice.call( arguments, 1 ),
		inputIndex = 0,
		inputLength = input.length,
		key,
		value;
	for ( ; inputIndex < inputLength; inputIndex++ ) {
		for ( key in input[ inputIndex ] ) {
			value = input[ inputIndex ][ key ];
			if ( input[ inputIndex ].hasOwnProperty( key ) && value !== undefined ) {
				// Clone objects
				if ( $.isPlainObject( value ) ) {
					target[ key ] = $.isPlainObject( target[ key ] ) ?
						$.widget.extend( {}, target[ key ], value ) :
						// Don't extend strings, arrays, etc. with objects
						$.widget.extend( {}, value );
				// Copy everything else by reference
				} else {
					target[ key ] = value;
				}
			}
		}
	}
	return target;
};

$.widget.bridge = function( name, object ) {
	var fullName = object.prototype.widgetFullName || name;
	$.fn[ name ] = function( options ) {
		var isMethodCall = typeof options === "string",
			args = slice.call( arguments, 1 ),
			returnValue = this;

		// allow multiple hashes to be passed on init
		options = !isMethodCall && args.length ?
			$.widget.extend.apply( null, [ options ].concat(args) ) :
			options;

		if ( isMethodCall ) {
			this.each(function() {
				var methodValue,
					instance = $.data( this, fullName );
				if ( !instance ) {
					return $.error( "cannot call methods on " + name + " prior to initialization; " +
						"attempted to call method '" + options + "'" );
				}
				if ( !$.isFunction( instance[options] ) || options.charAt( 0 ) === "_" ) {
					return $.error( "no such method '" + options + "' for " + name + " widget instance" );
				}
				methodValue = instance[ options ].apply( instance, args );
				if ( methodValue !== instance && methodValue !== undefined ) {
					returnValue = methodValue && methodValue.jquery ?
						returnValue.pushStack( methodValue.get() ) :
						methodValue;
					return false;
				}
			});
		} else {
			this.each(function() {
				var instance = $.data( this, fullName );
				if ( instance ) {
					instance.option( options || {} )._init();
				} else {
					$.data( this, fullName, new object( options, this ) );
				}
			});
		}

		return returnValue;
	};
};

$.Widget = function( /* options, element */ ) {};
$.Widget._childConstructors = [];

$.Widget.prototype = {
	widgetName: "widget",
	widgetEventPrefix: "",
	defaultElement: "<div>",
	options: {
		disabled: false,

		// callbacks
		create: null
	},
	_createWidget: function( options, element ) {
		element = $( element || this.defaultElement || this )[ 0 ];
		this.element = $( element );
		this.uuid = uuid++;
		this.eventNamespace = "." + this.widgetName + this.uuid;
		this.options = $.widget.extend( {},
			this.options,
			this._getCreateOptions(),
			options );

		this.bindings = $();
		this.hoverable = $();
		this.focusable = $();

		if ( element !== this ) {
			$.data( element, this.widgetFullName, this );
			this._on( true, this.element, {
				remove: function( event ) {
					if ( event.target === element ) {
						this.destroy();
					}
				}
			});
			this.document = $( element.style ?
				// element within the document
				element.ownerDocument :
				// element is window or document
				element.document || element );
			this.window = $( this.document[0].defaultView || this.document[0].parentWindow );
		}

		this._create();
		this._trigger( "create", null, this._getCreateEventData() );
		this._init();
	},
	_getCreateOptions: $.noop,
	_getCreateEventData: $.noop,
	_create: $.noop,
	_init: $.noop,

	destroy: function() {
		this._destroy();
		// we can probably remove the unbind calls in 2.0
		// all event bindings should go through this._on()
		this.element
			.unbind( this.eventNamespace )
			// 1.9 BC for #7810
			// TODO remove dual storage
			.removeData( this.widgetName )
			.removeData( this.widgetFullName )
			// support: jquery <1.6.3
			// http://bugs.jquery.com/ticket/9413
			.removeData( $.camelCase( this.widgetFullName ) );
		this.widget()
			.unbind( this.eventNamespace )
			.removeAttr( "aria-disabled" )
			.removeClass(
				this.widgetFullName + "-disabled " +
				"ui-state-disabled" );

		// clean up events and states
		this.bindings.unbind( this.eventNamespace );
		this.hoverable.removeClass( "ui-state-hover" );
		this.focusable.removeClass( "ui-state-focus" );
	},
	_destroy: $.noop,

	widget: function() {
		return this.element;
	},

	option: function( key, value ) {
		var options = key,
			parts,
			curOption,
			i;

		if ( arguments.length === 0 ) {
			// don't return a reference to the internal hash
			return $.widget.extend( {}, this.options );
		}

		if ( typeof key === "string" ) {
			// handle nested keys, e.g., "foo.bar" => { foo: { bar: ___ } }
			options = {};
			parts = key.split( "." );
			key = parts.shift();
			if ( parts.length ) {
				curOption = options[ key ] = $.widget.extend( {}, this.options[ key ] );
				for ( i = 0; i < parts.length - 1; i++ ) {
					curOption[ parts[ i ] ] = curOption[ parts[ i ] ] || {};
					curOption = curOption[ parts[ i ] ];
				}
				key = parts.pop();
				if ( value === undefined ) {
					return curOption[ key ] === undefined ? null : curOption[ key ];
				}
				curOption[ key ] = value;
			} else {
				if ( value === undefined ) {
					return this.options[ key ] === undefined ? null : this.options[ key ];
				}
				options[ key ] = value;
			}
		}

		this._setOptions( options );

		return this;
	},
	_setOptions: function( options ) {
		var key;

		for ( key in options ) {
			this._setOption( key, options[ key ] );
		}

		return this;
	},
	_setOption: function( key, value ) {
		this.options[ key ] = value;

		if ( key === "disabled" ) {
			this.widget()
				.toggleClass( this.widgetFullName + "-disabled ui-state-disabled", !!value )
				.attr( "aria-disabled", value );
			this.hoverable.removeClass( "ui-state-hover" );
			this.focusable.removeClass( "ui-state-focus" );
		}

		return this;
	},

	enable: function() {
		return this._setOption( "disabled", false );
	},
	disable: function() {
		return this._setOption( "disabled", true );
	},

	_on: function( suppressDisabledCheck, element, handlers ) {
		var delegateElement,
			instance = this;

		// no suppressDisabledCheck flag, shuffle arguments
		if ( typeof suppressDisabledCheck !== "boolean" ) {
			handlers = element;
			element = suppressDisabledCheck;
			suppressDisabledCheck = false;
		}

		// no element argument, shuffle and use this.element
		if ( !handlers ) {
			handlers = element;
			element = this.element;
			delegateElement = this.widget();
		} else {
			// accept selectors, DOM elements
			element = delegateElement = $( element );
			this.bindings = this.bindings.add( element );
		}

		$.each( handlers, function( event, handler ) {
			function handlerProxy() {
				// allow widgets to customize the disabled handling
				// - disabled as an array instead of boolean
				// - disabled class as method for disabling individual parts
				if ( !suppressDisabledCheck &&
						( instance.options.disabled === true ||
							$( this ).hasClass( "ui-state-disabled" ) ) ) {
					return;
				}
				return ( typeof handler === "string" ? instance[ handler ] : handler )
					.apply( instance, arguments );
			}

			// copy the guid so direct unbinding works
			if ( typeof handler !== "string" ) {
				handlerProxy.guid = handler.guid =
					handler.guid || handlerProxy.guid || $.guid++;
			}

			var match = event.match( /^(\w+)\s*(.*)$/ ),
				eventName = match[1] + instance.eventNamespace,
				selector = match[2];
			if ( selector ) {
				delegateElement.delegate( selector, eventName, handlerProxy );
			} else {
				element.bind( eventName, handlerProxy );
			}
		});
	},

	_off: function( element, eventName ) {
		eventName = (eventName || "").split( " " ).join( this.eventNamespace + " " ) + this.eventNamespace;
		element.unbind( eventName ).undelegate( eventName );
	},

	_delay: function( handler, delay ) {
		function handlerProxy() {
			return ( typeof handler === "string" ? instance[ handler ] : handler )
				.apply( instance, arguments );
		}
		var instance = this;
		return setTimeout( handlerProxy, delay || 0 );
	},

	_hoverable: function( element ) {
		this.hoverable = this.hoverable.add( element );
		this._on( element, {
			mouseenter: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-hover" );
			},
			mouseleave: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-hover" );
			}
		});
	},

	_focusable: function( element ) {
		this.focusable = this.focusable.add( element );
		this._on( element, {
			focusin: function( event ) {
				$( event.currentTarget ).addClass( "ui-state-focus" );
			},
			focusout: function( event ) {
				$( event.currentTarget ).removeClass( "ui-state-focus" );
			}
		});
	},

	_trigger: function( type, event, data ) {
		var prop, orig,
			callback = this.options[ type ];

		data = data || {};
		event = $.Event( event );
		event.type = ( type === this.widgetEventPrefix ?
			type :
			this.widgetEventPrefix + type ).toLowerCase();
		// the original event may come from any element
		// so we need to reset the target on the new event
		event.target = this.element[ 0 ];

		// copy original event properties over to the new event
		orig = event.originalEvent;
		if ( orig ) {
			for ( prop in orig ) {
				if ( !( prop in event ) ) {
					event[ prop ] = orig[ prop ];
				}
			}
		}

		this.element.trigger( event, data );
		return !( $.isFunction( callback ) &&
			callback.apply( this.element[0], [ event ].concat( data ) ) === false ||
			event.isDefaultPrevented() );
	}
};

$.each( { show: "fadeIn", hide: "fadeOut" }, function( method, defaultEffect ) {
	$.Widget.prototype[ "_" + method ] = function( element, options, callback ) {
		if ( typeof options === "string" ) {
			options = { effect: options };
		}
		var hasOptions,
			effectName = !options ?
				method :
				options === true || typeof options === "number" ?
					defaultEffect :
					options.effect || defaultEffect;
		options = options || {};
		if ( typeof options === "number" ) {
			options = { duration: options };
		}
		hasOptions = !$.isEmptyObject( options );
		options.complete = callback;
		if ( options.delay ) {
			element.delay( options.delay );
		}
		if ( hasOptions && $.effects && $.effects.effect[ effectName ] ) {
			element[ method ]( options );
		} else if ( effectName !== method && element[ effectName ] ) {
			element[ effectName ]( options.duration, options.easing, callback );
		} else {
			element.queue(function( next ) {
				$( this )[ method ]();
				if ( callback ) {
					callback.call( element[ 0 ] );
				}
				next();
			});
		}
	};
});


}));


/*
 * jQuery Iframe Transport Plugin 1.7
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/*jslint unparam: true, nomen: true */
/*global define, window, document */

(function (factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        // Register as an anonymous AMD module:
        define(['jquery'], factory);
    } else {
        // Browser globals:
        factory(window.jQuery);
    }
}(function ($) {
    'use strict';

    // Helper variable to create unique names for the transport iframes:
    var counter = 0;

    // The iframe transport accepts three additional options:
    // options.fileInput: a jQuery collection of file input fields
    // options.paramName: the parameter name for the file form data,
    //  overrides the name property of the file input field(s),
    //  can be a string or an array of strings.
    // options.formData: an array of objects with name and value properties,
    //  equivalent to the return data of .serializeArray(), e.g.:
    //  [{name: 'a', value: 1}, {name: 'b', value: 2}]
    $.ajaxTransport('iframe', function (options) {
        if (options.async) {
            var form,
                iframe,
                addParamChar;
            return {
                send: function (_, completeCallback) {
                    form = $('<form style="display:none;"></form>');
                    form.attr('accept-charset', options.formAcceptCharset);
                    addParamChar = /\?/.test(options.url) ? '&' : '?';
                    // XDomainRequest only supports GET and POST:
                    if (options.type === 'DELETE') {
                        options.url = options.url + addParamChar + '_method=DELETE';
                        options.type = 'POST';
                    } else if (options.type === 'PUT') {
                        options.url = options.url + addParamChar + '_method=PUT';
                        options.type = 'POST';
                    } else if (options.type === 'PATCH') {
                        options.url = options.url + addParamChar + '_method=PATCH';
                        options.type = 'POST';
                    }
                    // javascript:false as initial iframe src
                    // prevents warning popups on HTTPS in IE6.
                    // IE versions below IE8 cannot set the name property of
                    // elements that have already been added to the DOM,
                    // so we set the name along with the iframe HTML markup:
                    counter += 1;
                    iframe = $(
                        '<iframe src="javascript:false;" name="iframe-transport-' +
                            counter + '"></iframe>'
                    ).bind('load', function () {
                        var fileInputClones,
                            paramNames = $.isArray(options.paramName) ?
                                    options.paramName : [options.paramName];
                        iframe
                            .unbind('load')
                            .bind('load', function () {
                                var response;
                                // Wrap in a try/catch block to catch exceptions thrown
                                // when trying to access cross-domain iframe contents:
                                try {
                                    response = iframe.contents();
                                    // Google Chrome and Firefox do not throw an
                                    // exception when calling iframe.contents() on
                                    // cross-domain requests, so we unify the response:
                                    if (!response.length || !response[0].firstChild) {
                                        throw new Error();
                                    }
                                } catch (e) {
                                    response = undefined;
                                }
                                // The complete callback returns the
                                // iframe content document as response object:
                                completeCallback(
                                    200,
                                    'success',
                                    {'iframe': response}
                                );
                                // Fix for IE endless progress bar activity bug
                                // (happens on form submits to iframe targets):
                                $('<iframe src="javascript:false;"></iframe>')
                                    .appendTo(form);
                                window.setTimeout(function () {
                                    // Removing the form in a setTimeout call
                                    // allows Chrome's developer tools to display
                                    // the response result
                                    form.remove();
                                }, 0);
                            });
                        form
                            .prop('target', iframe.prop('name'))
                            .prop('action', options.url)
                            .prop('method', options.type);
                        if (options.formData) {
                            $.each(options.formData, function (index, field) {
                                $('<input type="hidden"/>')
                                    .prop('name', field.name)
                                    .val(field.value)
                                    .appendTo(form);
                            });
                        }
                        if (options.fileInput && options.fileInput.length &&
                                options.type === 'POST') {
                            fileInputClones = options.fileInput.clone();
                            // Insert a clone for each file input field:
                            options.fileInput.after(function (index) {
                                return fileInputClones[index];
                            });
                            if (options.paramName) {
                                options.fileInput.each(function (index) {
                                    $(this).prop(
                                        'name',
                                        paramNames[index] || options.paramName
                                    );
                                });
                            }
                            // Appending the file input fields to the hidden form
                            // removes them from their original location:
                            form
                                .append(options.fileInput)
                                .prop('enctype', 'multipart/form-data')
                                // enctype must be set as encoding for IE:
                                .prop('encoding', 'multipart/form-data');
                        }
                        form.submit();
                        // Insert the file input fields at their original location
                        // by replacing the clones with the originals:
                        if (fileInputClones && fileInputClones.length) {
                            options.fileInput.each(function (index, input) {
                                var clone = $(fileInputClones[index]);
                                $(input).prop('name', clone.prop('name'));
                                clone.replaceWith(input);
                            });
                        }
                    });
                    form.append(iframe).appendTo(document.body);
                },
                abort: function () {
                    if (iframe) {
                        // javascript:false as iframe src aborts the request
                        // and prevents warning popups on HTTPS in IE6.
                        // concat is used to avoid the "Script URL" JSLint error:
                        iframe
                            .unbind('load')
                            .prop('src', 'javascript'.concat(':false;'));
                    }
                    if (form) {
                        form.remove();
                    }
                }
            };
        }
    });

    // The iframe transport returns the iframe content document as response.
    // The following adds converters from iframe to text, json, html, xml
    // and script.
    // Please note that the Content-Type for JSON responses has to be text/plain
    // or text/html, if the browser doesn't include application/json in the
    // Accept header, else IE will show a download dialog.
    // The Content-Type for XML responses on the other hand has to be always
    // application/xml or text/xml, so IE properly parses the XML response.
    // See also
    // https://github.com/blueimp/jQuery-File-Upload/wiki/Setup#content-type-negotiation
    $.ajaxSetup({
        converters: {
            'iframe text': function (iframe) {
                return iframe && $(iframe[0].body).text();
            },
            'iframe json': function (iframe) {
                return iframe && $.parseJSON($(iframe[0].body).text());
            },
            'iframe html': function (iframe) {
                return iframe && $(iframe[0].body).html();
            },
            'iframe xml': function (iframe) {
                var xmlDoc = iframe && iframe[0];
                return xmlDoc && $.isXMLDoc(xmlDoc) ? xmlDoc :
                        $.parseXML((xmlDoc.XMLDocument && xmlDoc.XMLDocument.xml) ||
                            $(xmlDoc.body).html());
            },
            'iframe script': function (iframe) {
                return iframe && $.globalEval($(iframe[0].body).text());
            }
        }
    });

}));



/*
 * jQuery File Upload Plugin 5.31.6
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

/*jslint nomen: true, unparam: true, regexp: true */
/*global define, window, document, location, File, Blob, FormData */

(function (factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        // Register as an anonymous AMD module:
        define([
            'jquery',
            'jquery.ui.widget'
        ], factory);
    } else {
        // Browser globals:
        factory(window.jQuery);
    }
}(function ($) {
    'use strict';

    // The FileReader API is not actually used, but works as feature detection,
    // as e.g. Safari supports XHR file uploads via the FormData API,
    // but not non-multipart XHR file uploads:
    $.support.xhrFileUpload = !!(window.XMLHttpRequestUpload && window.FileReader);
    $.support.xhrFormDataFileUpload = !!window.FormData;

    // Detect support for Blob slicing (required for chunked uploads):
    $.support.blobSlice = window.Blob && (Blob.prototype.slice ||
        Blob.prototype.webkitSlice || Blob.prototype.mozSlice);

    // The fileupload widget listens for change events on file input fields defined
    // via fileInput setting and paste or drop events of the given dropZone.
    // In addition to the default jQuery Widget methods, the fileupload widget
    // exposes the "add" and "send" methods, to add or directly send files using
    // the fileupload API.
    // By default, files added via file input selection, paste, drag & drop or
    // "add" method are uploaded immediately, but it is possible to override
    // the "add" callback option to queue file uploads.
    $.widget('blueimp.fileupload', {

        options: {
            // The drop target element(s), by the default the complete document.
            // Set to null to disable drag & drop support:
            dropZone: $(document),
            // The paste target element(s), by the default the complete document.
            // Set to null to disable paste support:
            pasteZone: $(document),
            // The file input field(s), that are listened to for change events.
            // If undefined, it is set to the file input fields inside
            // of the widget element on plugin initialization.
            // Set to null to disable the change listener.
            fileInput: undefined,
            // By default, the file input field is replaced with a clone after
            // each input field change event. This is required for iframe transport
            // queues and allows change events to be fired for the same file
            // selection, but can be disabled by setting the following option to false:
            replaceFileInput: true,
            // The parameter name for the file form data (the request argument name).
            // If undefined or empty, the name property of the file input field is
            // used, or "files[]" if the file input name property is also empty,
            // can be a string or an array of strings:
            paramName: undefined,
            // By default, each file of a selection is uploaded using an individual
            // request for XHR type uploads. Set to false to upload file
            // selections in one request each:
            singleFileUploads: true,
            // To limit the number of files uploaded with one XHR request,
            // set the following option to an integer greater than 0:
            limitMultiFileUploads: undefined,
            // Set the following option to true to issue all file upload requests
            // in a sequential order:
            sequentialUploads: false,
            // To limit the number of concurrent uploads,
            // set the following option to an integer greater than 0:
            limitConcurrentUploads: undefined,
            // Set the following option to true to force iframe transport uploads:
            forceIframeTransport: false,
            // Set the following option to the location of a redirect url on the
            // origin server, for cross-domain iframe transport uploads:
            redirect: undefined,
            // The parameter name for the redirect url, sent as part of the form
            // data and set to 'redirect' if this option is empty:
            redirectParamName: undefined,
            // Set the following option to the location of a postMessage window,
            // to enable postMessage transport uploads:
            postMessage: undefined,
            // By default, XHR file uploads are sent as multipart/form-data.
            // The iframe transport is always using multipart/form-data.
            // Set to false to enable non-multipart XHR uploads:
            multipart: true,
            // To upload large files in smaller chunks, set the following option
            // to a preferred maximum chunk size. If set to 0, null or undefined,
            // or the browser does not support the required Blob API, files will
            // be uploaded as a whole.
            maxChunkSize: undefined,
            // When a non-multipart upload or a chunked multipart upload has been
            // aborted, this option can be used to resume the upload by setting
            // it to the size of the already uploaded bytes. This option is most
            // useful when modifying the options object inside of the "add" or
            // "send" callbacks, as the options are cloned for each file upload.
            uploadedBytes: undefined,
            // By default, failed (abort or error) file uploads are removed from the
            // global progress calculation. Set the following option to false to
            // prevent recalculating the global progress data:
            recalculateProgress: true,
            // Interval in milliseconds to calculate and trigger progress events:
            progressInterval: 100,
            // Interval in milliseconds to calculate progress bitrate:
            bitrateInterval: 500,
            // By default, uploads are started automatically when adding files:
            autoUpload: true,

            // Error and info messages:
            messages: {
                uploadedBytes: 'Uploaded bytes exceed file size'
            },

            // Translation function, gets the message key to be translated
            // and an object with context specific data as arguments:
            i18n: function (message, context) {
                message = this.messages[message] || message.toString();
                if (context) {
                    $.each(context, function (key, value) {
                        message = message.replace('{' + key + '}', value);
                    });
                }
                return message;
            },

            // Additional form data to be sent along with the file uploads can be set
            // using this option, which accepts an array of objects with name and
            // value properties, a function returning such an array, a FormData
            // object (for XHR file uploads), or a simple object.
            // The form of the first fileInput is given as parameter to the function:
            formData: function (form) {
                return form.serializeArray();
            },

            // The add callback is invoked as soon as files are added to the fileupload
            // widget (via file input selection, drag & drop, paste or add API call).
            // If the singleFileUploads option is enabled, this callback will be
            // called once for each file in the selection for XHR file uploads, else
            // once for each file selection.
            //
            // The upload starts when the submit method is invoked on the data parameter.
            // The data object contains a files property holding the added files
            // and allows you to override plugin options as well as define ajax settings.
            //
            // Listeners for this callback can also be bound the following way:
            // .bind('fileuploadadd', func);
            //
            // data.submit() returns a Promise object and allows to attach additional
            // handlers using jQuery's Deferred callbacks:
            // data.submit().done(func).fail(func).always(func);
            add: function (e, data) {
                if (data.autoUpload || (data.autoUpload !== false &&
                        $(this).fileupload('option', 'autoUpload'))) {
                    data.process().done(function () {
                        data.submit();
                    });
                }
            },

            // Other callbacks:

            // Callback for the submit event of each file upload:
            // submit: function (e, data) {}, // .bind('fileuploadsubmit', func);

            // Callback for the start of each file upload request:
            // send: function (e, data) {}, // .bind('fileuploadsend', func);

            // Callback for successful uploads:
            // done: function (e, data) {}, // .bind('fileuploaddone', func);

            // Callback for failed (abort or error) uploads:
            // fail: function (e, data) {}, // .bind('fileuploadfail', func);

            // Callback for completed (success, abort or error) requests:
            // always: function (e, data) {}, // .bind('fileuploadalways', func);

            // Callback for upload progress events:
            // progress: function (e, data) {}, // .bind('fileuploadprogress', func);

            // Callback for global upload progress events:
            // progressall: function (e, data) {}, // .bind('fileuploadprogressall', func);

            // Callback for uploads start, equivalent to the global ajaxStart event:
            // start: function (e) {}, // .bind('fileuploadstart', func);

            // Callback for uploads stop, equivalent to the global ajaxStop event:
            // stop: function (e) {}, // .bind('fileuploadstop', func);

            // Callback for change events of the fileInput(s):
            // change: function (e, data) {}, // .bind('fileuploadchange', func);

            // Callback for paste events to the pasteZone(s):
            // paste: function (e, data) {}, // .bind('fileuploadpaste', func);

            // Callback for drop events of the dropZone(s):
            // drop: function (e, data) {}, // .bind('fileuploaddrop', func);

            // Callback for dragover events of the dropZone(s):
            // dragover: function (e) {}, // .bind('fileuploaddragover', func);

            // Callback for the start of each chunk upload request:
            // chunksend: function (e, data) {}, // .bind('fileuploadchunksend', func);

            // Callback for successful chunk uploads:
            // chunkdone: function (e, data) {}, // .bind('fileuploadchunkdone', func);

            // Callback for failed (abort or error) chunk uploads:
            // chunkfail: function (e, data) {}, // .bind('fileuploadchunkfail', func);

            // Callback for completed (success, abort or error) chunk upload requests:
            // chunkalways: function (e, data) {}, // .bind('fileuploadchunkalways', func);

            // The plugin options are used as settings object for the ajax calls.
            // The following are jQuery ajax settings required for the file uploads:
            processData: false,
            contentType: false,
            cache: false
        },

        // A list of options that require reinitializing event listeners and/or
        // special initialization code:
        _specialOptions: [
            'fileInput',
            'dropZone',
            'pasteZone',
            'multipart',
            'forceIframeTransport'
        ],

        _blobSlice: $.support.blobSlice && function () {
            var slice = this.slice || this.webkitSlice || this.mozSlice;
            return slice.apply(this, arguments);
        },

        _BitrateTimer: function () {
            this.timestamp = ((Date.now) ? Date.now() : (new Date()).getTime());
            this.loaded = 0;
            this.bitrate = 0;
            this.getBitrate = function (now, loaded, interval) {
                var timeDiff = now - this.timestamp;
                if (!this.bitrate || !interval || timeDiff > interval) {
                    this.bitrate = (loaded - this.loaded) * (1000 / timeDiff) * 8;
                    this.loaded = loaded;
                    this.timestamp = now;
                }
                return this.bitrate;
            };
        },

        _isXHRUpload: function (options) {
            return !options.forceIframeTransport &&
                ((!options.multipart && $.support.xhrFileUpload) ||
                $.support.xhrFormDataFileUpload);
        },

        _getFormData: function (options) {
            var formData;
            if (typeof options.formData === 'function') {
                return options.formData(options.form);
            }
            if ($.isArray(options.formData)) {
                return options.formData;
            }
            if ($.type(options.formData) === 'object') {
                formData = [];
                $.each(options.formData, function (name, value) {
                    formData.push({name: name, value: value});
                });
                return formData;
            }
            return [];
        },

        _getTotal: function (files) {
            var total = 0;
            $.each(files, function (index, file) {
                total += file.size || 1;
            });
            return total;
        },

        _initProgressObject: function (obj) {
            var progress = {
                loaded: 0,
                total: 0,
                bitrate: 0
            };
            if (obj._progress) {
                $.extend(obj._progress, progress);
            } else {
                obj._progress = progress;
            }
        },

        _initResponseObject: function (obj) {
            var prop;
            if (obj._response) {
                for (prop in obj._response) {
                    if (obj._response.hasOwnProperty(prop)) {
                        delete obj._response[prop];
                    }
                }
            } else {
                obj._response = {};
            }
        },

        _onProgress: function (e, data) {
            if (e.lengthComputable) {
                var now = ((Date.now) ? Date.now() : (new Date()).getTime()),
                    loaded;
                if (data._time && data.progressInterval &&
                        (now - data._time < data.progressInterval) &&
                        e.loaded !== e.total) {
                    return;
                }
                data._time = now;
                loaded = Math.floor(
                    e.loaded / e.total * (data.chunkSize || data._progress.total)
                ) + (data.uploadedBytes || 0);
                // Add the difference from the previously loaded state
                // to the global loaded counter:
                this._progress.loaded += (loaded - data._progress.loaded);
                this._progress.bitrate = this._bitrateTimer.getBitrate(
                    now,
                    this._progress.loaded,
                    data.bitrateInterval
                );
                data._progress.loaded = data.loaded = loaded;
                data._progress.bitrate = data.bitrate = data._bitrateTimer.getBitrate(
                    now,
                    loaded,
                    data.bitrateInterval
                );
                // Trigger a custom progress event with a total data property set
                // to the file size(s) of the current upload and a loaded data
                // property calculated accordingly:
                this._trigger('progress', e, data);
                // Trigger a global progress event for all current file uploads,
                // including ajax calls queued for sequential file uploads:
                this._trigger('progressall', e, this._progress);
            }
        },

        _initProgressListener: function (options) {
            var that = this,
                xhr = options.xhr ? options.xhr() : $.ajaxSettings.xhr();
            // Accesss to the native XHR object is required to add event listeners
            // for the upload progress event:
            if (xhr.upload) {
                $(xhr.upload).bind('progress', function (e) {
                    var oe = e.originalEvent;
                    // Make sure the progress event properties get copied over:
                    e.lengthComputable = oe.lengthComputable;
                    e.loaded = oe.loaded;
                    e.total = oe.total;
                    that._onProgress(e, options);
                });
                options.xhr = function () {
                    return xhr;
                };
            }
        },

        _isInstanceOf: function (type, obj) {
            // Cross-frame instanceof check
            return Object.prototype.toString.call(obj) === '[object ' + type + ']';
        },

        _initXHRData: function (options) {
            var that = this,
                formData,
                file = options.files[0],
                // Ignore non-multipart setting if not supported:
                multipart = options.multipart || !$.support.xhrFileUpload,
                paramName = options.paramName[0];
            options.headers = options.headers || {};
            if (options.contentRange) {
                options.headers['Content-Range'] = options.contentRange;
            }
            if (!multipart || options.blob || !this._isInstanceOf('File', file)) {
                options.headers['Content-Disposition'] = 'attachment; filename="' +
                    encodeURI(file.name) + '"';
            }
            if (!multipart) {
                options.contentType = file.type;
                options.data = options.blob || file;
            } else if ($.support.xhrFormDataFileUpload) {
                if (options.postMessage) {
                    // window.postMessage does not allow sending FormData
                    // objects, so we just add the File/Blob objects to
                    // the formData array and let the postMessage window
                    // create the FormData object out of this array:
                    formData = this._getFormData(options);
                    if (options.blob) {
                        formData.push({
                            name: paramName,
                            value: options.blob
                        });
                    } else {
                        $.each(options.files, function (index, file) {
                            formData.push({
                                name: options.paramName[index] || paramName,
                                value: file
                            });
                        });
                    }
                } else {
                    if (that._isInstanceOf('FormData', options.formData)) {
                        formData = options.formData;
                    } else {
                        formData = new FormData();
                        $.each(this._getFormData(options), function (index, field) {
                            formData.append(field.name, field.value);
                        });
                    }
                    if (options.blob) {
                        formData.append(paramName, options.blob, file.name);
                    } else {
                        $.each(options.files, function (index, file) {
                            // This check allows the tests to run with
                            // dummy objects:
                            if (that._isInstanceOf('File', file) ||
                                    that._isInstanceOf('Blob', file)) {
                                formData.append(
                                    options.paramName[index] || paramName,
                                    file,
                                    file.name
                                );
                            }
                        });
                    }
                }
                options.data = formData;
            }
            // Blob reference is not needed anymore, free memory:
            options.blob = null;
        },

        _initIframeSettings: function (options) {
            var targetHost = $('<a></a>').prop('href', options.url).prop('host');
            // Setting the dataType to iframe enables the iframe transport:
            options.dataType = 'iframe ' + (options.dataType || '');
            // The iframe transport accepts a serialized array as form data:
            options.formData = this._getFormData(options);
            // Add redirect url to form data on cross-domain uploads:
            if (options.redirect && targetHost && targetHost !== location.host) {
                options.formData.push({
                    name: options.redirectParamName || 'redirect',
                    value: options.redirect
                });
            }
        },

        _initDataSettings: function (options) {
            if (this._isXHRUpload(options)) {
                if (!this._chunkedUpload(options, true)) {
                    if (!options.data) {
                        this._initXHRData(options);
                    }
                    this._initProgressListener(options);
                }
                if (options.postMessage) {
                    // Setting the dataType to postmessage enables the
                    // postMessage transport:
                    options.dataType = 'postmessage ' + (options.dataType || '');
                }
            } else {
                this._initIframeSettings(options);
            }
        },

        _getParamName: function (options) {
            var fileInput = $(options.fileInput),
                paramName = options.paramName;
            if (!paramName) {
                paramName = [];
                fileInput.each(function () {
                    var input = $(this),
                        name = input.prop('name') || 'files[]',
                        i = (input.prop('files') || [1]).length;
                    while (i) {
                        paramName.push(name);
                        i -= 1;
                    }
                });
                if (!paramName.length) {
                    paramName = [fileInput.prop('name') || 'files[]'];
                }
            } else if (!$.isArray(paramName)) {
                paramName = [paramName];
            }
            return paramName;
        },

        _initFormSettings: function (options) {
            // Retrieve missing options from the input field and the
            // associated form, if available:
            if (!options.form || !options.form.length) {
                options.form = $(options.fileInput.prop('form'));
                // If the given file input doesn't have an associated form,
                // use the default widget file input's form:
                if (!options.form.length) {
                    options.form = $(this.options.fileInput.prop('form'));
                }
            }
            options.paramName = this._getParamName(options);
            if (!options.url) {
                options.url = options.form.prop('action') || location.href;
            }
            // The HTTP request method must be "POST" or "PUT":
            options.type = (options.type || options.form.prop('method') || '')
                .toUpperCase();
            if (options.type !== 'POST' && options.type !== 'PUT' &&
                    options.type !== 'PATCH') {
                options.type = 'POST';
            }
            if (!options.formAcceptCharset) {
                options.formAcceptCharset = options.form.attr('accept-charset');
            }
        },

        _getAJAXSettings: function (data) {
            var options = $.extend({}, this.options, data);
            this._initFormSettings(options);
            this._initDataSettings(options);
            return options;
        },

        // jQuery 1.6 doesn't provide .state(),
        // while jQuery 1.8+ removed .isRejected() and .isResolved():
        _getDeferredState: function (deferred) {
            if (deferred.state) {
                return deferred.state();
            }
            if (deferred.isResolved()) {
                return 'resolved';
            }
            if (deferred.isRejected()) {
                return 'rejected';
            }
            return 'pending';
        },

        // Maps jqXHR callbacks to the equivalent
        // methods of the given Promise object:
        _enhancePromise: function (promise) {
            promise.success = promise.done;
            promise.error = promise.fail;
            promise.complete = promise.always;
            return promise;
        },

        // Creates and returns a Promise object enhanced with
        // the jqXHR methods abort, success, error and complete:
        _getXHRPromise: function (resolveOrReject, context, args) {
            var dfd = $.Deferred(),
                promise = dfd.promise();
            context = context || this.options.context || promise;
            if (resolveOrReject === true) {
                dfd.resolveWith(context, args);
            } else if (resolveOrReject === false) {
                dfd.rejectWith(context, args);
            }
            promise.abort = dfd.promise;
            return this._enhancePromise(promise);
        },

        // Adds convenience methods to the data callback argument:
        _addConvenienceMethods: function (e, data) {
            var that = this,
                getPromise = function (data) {
                    return $.Deferred().resolveWith(that, [data]).promise();
                };
            data.process = function (resolveFunc, rejectFunc) {
                if (resolveFunc || rejectFunc) {
                    data._processQueue = this._processQueue =
                        (this._processQueue || getPromise(this))
                            .pipe(resolveFunc, rejectFunc);
                }
                return this._processQueue || getPromise(this);
            };
            data.submit = function () {
                if (this.state() !== 'pending') {
                    data.jqXHR = this.jqXHR =
                        (that._trigger('submit', e, this) !== false) &&
                        that._onSend(e, this);
                }
                return this.jqXHR || that._getXHRPromise();
            };
            data.abort = function () {
                if (this.jqXHR) {
                    return this.jqXHR.abort();
                }
                return that._getXHRPromise();
            };
            data.state = function () {
                if (this.jqXHR) {
                    return that._getDeferredState(this.jqXHR);
                }
                if (this._processQueue) {
                    return that._getDeferredState(this._processQueue);
                }
            };
            data.progress = function () {
                return this._progress;
            };
            data.response = function () {
                return this._response;
            };
        },

        // Parses the Range header from the server response
        // and returns the uploaded bytes:
        _getUploadedBytes: function (jqXHR) {
            var range = jqXHR.getResponseHeader('Range'),
                parts = range && range.split('-'),
                upperBytesPos = parts && parts.length > 1 &&
                    parseInt(parts[1], 10);
            return upperBytesPos && upperBytesPos + 1;
        },

        // Uploads a file in multiple, sequential requests
        // by splitting the file up in multiple blob chunks.
        // If the second parameter is true, only tests if the file
        // should be uploaded in chunks, but does not invoke any
        // upload requests:
        _chunkedUpload: function (options, testOnly) {
            options.uploadedBytes = options.uploadedBytes || 0;
            var that = this,
                file = options.files[0],
                fs = file.size,
                ub = options.uploadedBytes,
                mcs = options.maxChunkSize || fs,
                slice = this._blobSlice,
                dfd = $.Deferred(),
                promise = dfd.promise(),
                jqXHR,
                upload;
            if (!(this._isXHRUpload(options) && slice && (ub || mcs < fs)) ||
                    options.data) {
                return false;
            }
            if (testOnly) {
                return true;
            }
            if (ub >= fs) {
                file.error = options.i18n('uploadedBytes');
                return this._getXHRPromise(
                    false,
                    options.context,
                    [null, 'error', file.error]
                );
            }
            // The chunk upload method:
            upload = function () {
                // Clone the options object for each chunk upload:
                var o = $.extend({}, options),
                    currentLoaded = o._progress.loaded;
                o.blob = slice.call(
                    file,
                    ub,
                    ub + mcs,
                    file.type
                );
                // Store the current chunk size, as the blob itself
                // will be dereferenced after data processing:
                o.chunkSize = o.blob.size;
                // Expose the chunk bytes position range:
                o.contentRange = 'bytes ' + ub + '-' +
                    (ub + o.chunkSize - 1) + '/' + fs;
                // Process the upload data (the blob and potential form data):
                that._initXHRData(o);
                // Add progress listeners for this chunk upload:
                that._initProgressListener(o);
                jqXHR = ((that._trigger('chunksend', null, o) !== false && $.ajax(o)) ||
                        that._getXHRPromise(false, o.context))
                    .done(function (result, textStatus, jqXHR) {
                        ub = that._getUploadedBytes(jqXHR) ||
                            (ub + o.chunkSize);
                        // Create a progress event if no final progress event
                        // with loaded equaling total has been triggered
                        // for this chunk:
                        if (currentLoaded + o.chunkSize - o._progress.loaded) {
                            that._onProgress($.Event('progress', {
                                lengthComputable: true,
                                loaded: ub - o.uploadedBytes,
                                total: ub - o.uploadedBytes
                            }), o);
                        }
                        options.uploadedBytes = o.uploadedBytes = ub;
                        o.result = result;
                        o.textStatus = textStatus;
                        o.jqXHR = jqXHR;
                        that._trigger('chunkdone', null, o);
                        that._trigger('chunkalways', null, o);
                        if (ub < fs) {
                            // File upload not yet complete,
                            // continue with the next chunk:
                            upload();
                        } else {
                            dfd.resolveWith(
                                o.context,
                                [result, textStatus, jqXHR]
                            );
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        o.jqXHR = jqXHR;
                        o.textStatus = textStatus;
                        o.errorThrown = errorThrown;
                        that._trigger('chunkfail', null, o);
                        that._trigger('chunkalways', null, o);
                        dfd.rejectWith(
                            o.context,
                            [jqXHR, textStatus, errorThrown]
                        );
                    });
            };
            this._enhancePromise(promise);
            promise.abort = function () {
                return jqXHR.abort();
            };
            upload();
            return promise;
        },

        _beforeSend: function (e, data) {
            if (this._active === 0) {
                // the start callback is triggered when an upload starts
                // and no other uploads are currently running,
                // equivalent to the global ajaxStart event:
                this._trigger('start');
                // Set timer for global bitrate progress calculation:
                this._bitrateTimer = new this._BitrateTimer();
                // Reset the global progress values:
                this._progress.loaded = this._progress.total = 0;
                this._progress.bitrate = 0;
            }
            // Make sure the container objects for the .response() and
            // .progress() methods on the data object are available
            // and reset to their initial state:
            this._initResponseObject(data);
            this._initProgressObject(data);
            data._progress.loaded = data.loaded = data.uploadedBytes || 0;
            data._progress.total = data.total = this._getTotal(data.files) || 1;
            data._progress.bitrate = data.bitrate = 0;
            this._active += 1;
            // Initialize the global progress values:
            this._progress.loaded += data.loaded;
            this._progress.total += data.total;
        },

        _onDone: function (result, textStatus, jqXHR, options) {
            var total = options._progress.total,
                response = options._response;
            if (options._progress.loaded < total) {
                // Create a progress event if no final progress event
                // with loaded equaling total has been triggered:
                this._onProgress($.Event('progress', {
                    lengthComputable: true,
                    loaded: total,
                    total: total
                }), options);
            }
            response.result = options.result = result;
            response.textStatus = options.textStatus = textStatus;
            response.jqXHR = options.jqXHR = jqXHR;
            this._trigger('done', null, options);
        },

        _onFail: function (jqXHR, textStatus, errorThrown, options) {
            var response = options._response;
            if (options.recalculateProgress) {
                // Remove the failed (error or abort) file upload from
                // the global progress calculation:
                this._progress.loaded -= options._progress.loaded;
                this._progress.total -= options._progress.total;
            }
            response.jqXHR = options.jqXHR = jqXHR;
            response.textStatus = options.textStatus = textStatus;
            response.errorThrown = options.errorThrown = errorThrown;
            this._trigger('fail', null, options);
        },

        _onAlways: function (jqXHRorResult, textStatus, jqXHRorError, options) {
            // jqXHRorResult, textStatus and jqXHRorError are added to the
            // options object via done and fail callbacks
            this._trigger('always', null, options);
        },

        _onSend: function (e, data) {
            if (!data.submit) {
                this._addConvenienceMethods(e, data);
            }
            var that = this,
                jqXHR,
                aborted,
                slot,
                pipe,
                options = that._getAJAXSettings(data),
                send = function () {
                    that._sending += 1;
                    // Set timer for bitrate progress calculation:
                    options._bitrateTimer = new that._BitrateTimer();
                    jqXHR = jqXHR || (
                        ((aborted || that._trigger('send', e, options) === false) &&
                        that._getXHRPromise(false, options.context, aborted)) ||
                        that._chunkedUpload(options) || $.ajax(options)
                    ).done(function (result, textStatus, jqXHR) {
                        that._onDone(result, textStatus, jqXHR, options);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        that._onFail(jqXHR, textStatus, errorThrown, options);
                    }).always(function (jqXHRorResult, textStatus, jqXHRorError) {
                        that._onAlways(
                            jqXHRorResult,
                            textStatus,
                            jqXHRorError,
                            options
                        );
                        that._sending -= 1;
                        that._active -= 1;
                        if (options.limitConcurrentUploads &&
                                options.limitConcurrentUploads > that._sending) {
                            // Start the next queued upload,
                            // that has not been aborted:
                            var nextSlot = that._slots.shift();
                            while (nextSlot) {
                                if (that._getDeferredState(nextSlot) === 'pending') {
                                    nextSlot.resolve();
                                    break;
                                }
                                nextSlot = that._slots.shift();
                            }
                        }
                        if (that._active === 0) {
                            // The stop callback is triggered when all uploads have
                            // been completed, equivalent to the global ajaxStop event:
                            that._trigger('stop');
                        }
                    });
                    return jqXHR;
                };
            this._beforeSend(e, options);
            if (this.options.sequentialUploads ||
                    (this.options.limitConcurrentUploads &&
                    this.options.limitConcurrentUploads <= this._sending)) {
                if (this.options.limitConcurrentUploads > 1) {
                    slot = $.Deferred();
                    this._slots.push(slot);
                    pipe = slot.pipe(send);
                } else {
                    this._sequence = this._sequence.pipe(send, send);
                    pipe = this._sequence;
                }
                // Return the piped Promise object, enhanced with an abort method,
                // which is delegated to the jqXHR object of the current upload,
                // and jqXHR callbacks mapped to the equivalent Promise methods:
                pipe.abort = function () {
                    aborted = [undefined, 'abort', 'abort'];
                    if (!jqXHR) {
                        if (slot) {
                            slot.rejectWith(options.context, aborted);
                        }
                        return send();
                    }
                    return jqXHR.abort();
                };
                return this._enhancePromise(pipe);
            }
            return send();
        },

        _onAdd: function (e, data) {
            var that = this,
                result = true,
                options = $.extend({}, this.options, data),
                limit = options.limitMultiFileUploads,
                paramName = this._getParamName(options),
                paramNameSet,
                paramNameSlice,
                fileSet,
                i;
            if (!(options.singleFileUploads || limit) ||
                    !this._isXHRUpload(options)) {
                fileSet = [data.files];
                paramNameSet = [paramName];
            } else if (!options.singleFileUploads && limit) {
                fileSet = [];
                paramNameSet = [];
                for (i = 0; i < data.files.length; i += limit) {
                    fileSet.push(data.files.slice(i, i + limit));
                    paramNameSlice = paramName.slice(i, i + limit);
                    if (!paramNameSlice.length) {
                        paramNameSlice = paramName;
                    }
                    paramNameSet.push(paramNameSlice);
                }
            } else {
                paramNameSet = paramName;
            }
            data.originalFiles = data.files;
            $.each(fileSet || data.files, function (index, element) {
                var newData = $.extend({}, data);
                newData.files = fileSet ? element : [element];
                newData.paramName = paramNameSet[index];
                that._initResponseObject(newData);
                that._initProgressObject(newData);
                that._addConvenienceMethods(e, newData);
                result = that._trigger('add', e, newData);
                return result;
            });
            return result;
        },

        _replaceFileInput: function (input) {
            var inputClone = input.clone(true);
            $('<form></form>').append(inputClone)[0].reset();
            // Detaching allows to insert the fileInput on another form
            // without loosing the file input value:
            input.after(inputClone).detach();
            // Avoid memory leaks with the detached file input:
            $.cleanData(input.unbind('remove'));
            // Replace the original file input element in the fileInput
            // elements set with the clone, which has been copied including
            // event handlers:
            this.options.fileInput = this.options.fileInput.map(function (i, el) {
                if (el === input[0]) {
                    return inputClone[0];
                }
                return el;
            });
            // If the widget has been initialized on the file input itself,
            // override this.element with the file input clone:
            if (input[0] === this.element[0]) {
                this.element = inputClone;
            }
        },

        _handleFileTreeEntry: function (entry, path) {
            var that = this,
                dfd = $.Deferred(),
                errorHandler = function (e) {
                    if (e && !e.entry) {
                        e.entry = entry;
                    }
                    // Since $.when returns immediately if one
                    // Deferred is rejected, we use resolve instead.
                    // This allows valid files and invalid items
                    // to be returned together in one set:
                    dfd.resolve([e]);
                },
                dirReader;
            path = path || '';
            if (entry.isFile) {
                if (entry._file) {
                    // Workaround for Chrome bug #149735
                    entry._file.relativePath = path;
                    dfd.resolve(entry._file);
                } else {
                    entry.file(function (file) {
                        file.relativePath = path;
                        dfd.resolve(file);
                    }, errorHandler);
                }
            } else if (entry.isDirectory) {
                dirReader = entry.createReader();
                dirReader.readEntries(function (entries) {
                    that._handleFileTreeEntries(
                        entries,
                        path + entry.name + '/'
                    ).done(function (files) {
                        dfd.resolve(files);
                    }).fail(errorHandler);
                }, errorHandler);
            } else {
                // Return an empy list for file system items
                // other than files or directories:
                dfd.resolve([]);
            }
            return dfd.promise();
        },

        _handleFileTreeEntries: function (entries, path) {
            var that = this;
            return $.when.apply(
                $,
                $.map(entries, function (entry) {
                    return that._handleFileTreeEntry(entry, path);
                })
            ).pipe(function () {
                return Array.prototype.concat.apply(
                    [],
                    arguments
                );
            });
        },

        _getDroppedFiles: function (dataTransfer) {
            dataTransfer = dataTransfer || {};
            var items = dataTransfer.items;
            if (items && items.length && (items[0].webkitGetAsEntry ||
                    items[0].getAsEntry)) {
                return this._handleFileTreeEntries(
                    $.map(items, function (item) {
                        var entry;
                        if (item.webkitGetAsEntry) {
                            entry = item.webkitGetAsEntry();
                            if (entry) {
                                // Workaround for Chrome bug #149735:
                                entry._file = item.getAsFile();
                            }
                            return entry;
                        }
                        return item.getAsEntry();
                    })
                );
            }
            return $.Deferred().resolve(
                $.makeArray(dataTransfer.files)
            ).promise();
        },

        _getSingleFileInputFiles: function (fileInput) {
            fileInput = $(fileInput);
            var entries = fileInput.prop('webkitEntries') ||
                    fileInput.prop('entries'),
                files,
                value;
            if (entries && entries.length) {
                return this._handleFileTreeEntries(entries);
            }
            files = $.makeArray(fileInput.prop('files'));
            if (!files.length) {
                value = fileInput.prop('value');
                if (!value) {
                    return $.Deferred().resolve([]).promise();
                }
                // If the files property is not available, the browser does not
                // support the File API and we add a pseudo File object with
                // the input value as name with path information removed:
                files = [{name: value.replace(/^.*\\/, '')}];
            } else if (files[0].name === undefined && files[0].fileName) {
                // File normalization for Safari 4 and Firefox 3:
                $.each(files, function (index, file) {
                    file.name = file.fileName;
                    file.size = file.fileSize;
                });
            }
            return $.Deferred().resolve(files).promise();
        },

        _getFileInputFiles: function (fileInput) {
            if (!(fileInput instanceof $) || fileInput.length === 1) {
                return this._getSingleFileInputFiles(fileInput);
            }
            return $.when.apply(
                $,
                $.map(fileInput, this._getSingleFileInputFiles)
            ).pipe(function () {
                return Array.prototype.concat.apply(
                    [],
                    arguments
                );
            });
        },

        _onChange: function (e) {
            var that = this,
                data = {
                    fileInput: $(e.target),
                    form: $(e.target.form)
                };
            this._getFileInputFiles(data.fileInput).always(function (files) {
                data.files = files;
                if (that.options.replaceFileInput) {
                    that._replaceFileInput(data.fileInput);
                }
                if (that._trigger('change', e, data) !== false) {
                    that._onAdd(e, data);
                }
            });
        },

        _onPaste: function (e) {
            var items = e.originalEvent && e.originalEvent.clipboardData &&
                    e.originalEvent.clipboardData.items,
                data = {files: []};
            if (items && items.length) {
                $.each(items, function (index, item) {
                    var file = item.getAsFile && item.getAsFile();
                    if (file) {
                        data.files.push(file);
                    }
                });
                if (this._trigger('paste', e, data) === false ||
                        this._onAdd(e, data) === false) {
                    return false;
                }
            }
        },

        _onDrop: function (e) {
            e.dataTransfer = e.originalEvent && e.originalEvent.dataTransfer;
            var that = this,
                dataTransfer = e.dataTransfer,
                data = {};
            if (dataTransfer && dataTransfer.files && dataTransfer.files.length) {
                e.preventDefault();
                this._getDroppedFiles(dataTransfer).always(function (files) {
                    data.files = files;
                    if (that._trigger('drop', e, data) !== false) {
                        that._onAdd(e, data);
                    }
                });
            }
        },

        _onDragOver: function (e) {
            e.dataTransfer = e.originalEvent && e.originalEvent.dataTransfer;
            var dataTransfer = e.dataTransfer;
            if (dataTransfer) {
                if (this._trigger('dragover', e) === false) {
                    return false;
                }
                if ($.inArray('Files', dataTransfer.types) !== -1) {
                    dataTransfer.dropEffect = 'copy';
                    e.preventDefault();
                }
            }
        },

        _initEventHandlers: function () {
            if (this._isXHRUpload(this.options)) {
                this._on(this.options.dropZone, {
                    dragover: this._onDragOver,
                    drop: this._onDrop
                });
                this._on(this.options.pasteZone, {
                    paste: this._onPaste
                });
            }
            this._on(this.options.fileInput, {
                change: this._onChange
            });
        },

        _destroyEventHandlers: function () {
            this._off(this.options.dropZone, 'dragover drop');
            this._off(this.options.pasteZone, 'paste');
            this._off(this.options.fileInput, 'change');
        },

        _setOption: function (key, value) {
            var reinit = $.inArray(key, this._specialOptions) !== -1;
            if (reinit) {
                this._destroyEventHandlers();
            }
            this._super(key, value);
            if (reinit) {
                this._initSpecialOptions();
                this._initEventHandlers();
            }
        },

        _initSpecialOptions: function () {
            var options = this.options;
            if (options.fileInput === undefined) {
                options.fileInput = this.element.is('input[type="file"]') ?
                        this.element : this.element.find('input[type="file"]');
            } else if (!(options.fileInput instanceof $)) {
                options.fileInput = $(options.fileInput);
            }
            if (!(options.dropZone instanceof $)) {
                options.dropZone = $(options.dropZone);
            }
            if (!(options.pasteZone instanceof $)) {
                options.pasteZone = $(options.pasteZone);
            }
        },

        _getRegExp: function (str) {
            var parts = str.split('/'),
                modifiers = parts.pop();
            parts.shift();
            return new RegExp(parts.join('/'), modifiers);
        },

        _isRegExpOption: function (key, value) {
            return key !== 'url' && $.type(value) === 'string' &&
                /^\/.*\/[igm]{0,3}$/.test(value);
        },

        _initDataAttributes: function () {
            var that = this,
                options = this.options;
            // Initialize options set via HTML5 data-attributes:
            $.each(
                $(this.element[0].cloneNode(false)).data(),
                function (key, value) {
                    if (that._isRegExpOption(key, value)) {
                        value = that._getRegExp(value);
                    }
                    options[key] = value;
                }
            );
        },

        _create: function () {
            this._initDataAttributes();
            this._initSpecialOptions();
            this._slots = [];
            this._sequence = this._getXHRPromise(true);
            this._sending = this._active = 0;
            this._initProgressObject(this);
            this._initEventHandlers();
        },

        // This method is exposed to the widget API and allows to query
        // the number of active uploads:
        active: function () {
            return this._active;
        },

        // This method is exposed to the widget API and allows to query
        // the widget upload progress.
        // It returns an object with loaded, total and bitrate properties
        // for the running uploads:
        progress: function () {
            return this._progress;
        },

        // This method is exposed to the widget API and allows adding files
        // using the fileupload API. The data parameter accepts an object which
        // must have a files property and can contain additional options:
        // .fileupload('add', {files: filesList});
        add: function (data) {
            var that = this;
            if (!data || this.options.disabled) {
                return;
            }
            if (data.fileInput && !data.files) {
                this._getFileInputFiles(data.fileInput).always(function (files) {
                    data.files = files;
                    that._onAdd(null, data);
                });
            } else {
                data.files = $.makeArray(data.files);
                this._onAdd(null, data);
            }
        },

        // This method is exposed to the widget API and allows sending files
        // using the fileupload API. The data parameter accepts an object which
        // must have a files or fileInput property and can contain additional options:
        // .fileupload('send', {files: filesList});
        // The method returns a Promise object for the file upload call.
        send: function (data) {
            if (data && !this.options.disabled) {
                if (data.fileInput && !data.files) {
                    var that = this,
                        dfd = $.Deferred(),
                        promise = dfd.promise(),
                        jqXHR,
                        aborted;
                    promise.abort = function () {
                        aborted = true;
                        if (jqXHR) {
                            return jqXHR.abort();
                        }
                        dfd.reject(null, 'abort', 'abort');
                        return promise;
                    };
                    this._getFileInputFiles(data.fileInput).always(
                        function (files) {
                            if (aborted) {
                                return;
                            }
                            data.files = files;
                            jqXHR = that._onSend(null, data).then(
                                function (result, textStatus, jqXHR) {
                                    dfd.resolve(result, textStatus, jqXHR);
                                },
                                function (jqXHR, textStatus, errorThrown) {
                                    dfd.reject(jqXHR, textStatus, errorThrown);
                                }
                            );
                        }
                    );
                    return this._enhancePromise(promise);
                }
                data.files = $.makeArray(data.files);
                if (data.files.length) {
                    return this._onSend(null, data);
                }
            }
            return this._getXHRPromise(false, data && data.context);
        }

    });

}));


/*
 * Cloudinary's jQuery library - v1.0.19
 * Copyright Cloudinary
 * see https://github.com/cloudinary/cloudinary_js
 */

(function (factory) {
  'use strict';
  if (typeof define === 'function' && define.amd) {
    // Register as an anonymous AMD module:
    define([
      'jquery',
      'jquery.ui.widget',
      'jquery.iframe-transport',
      'jquery.fileupload'
    ], factory);
  } else {
    // Browser globals:
    var $ = window.jQuery;
    factory($);
    $(function() {
      if($.fn.cloudinary_fileupload !== undefined) {
        $("input.cloudinary-fileupload[type=file]").cloudinary_fileupload();
      }
    });
  }
}(function ($) {
  'use strict';
  var CF_SHARED_CDN = "d3jpl91pxevbkh.cloudfront.net";
  var OLD_AKAMAI_SHARED_CDN = "cloudinary-a.akamaihd.net";
  var AKAMAI_SHARED_CDN = "res.cloudinary.com";
  var SHARED_CDN = AKAMAI_SHARED_CDN;
  
  function utf8_encode (argString) {
    // http://kevin.vanzonneveld.net
    // +   original by: Webtoolkit.info (http://www.webtoolkit.info/)
    // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: sowberry
    // +    tweaked by: Jack
    // +   bugfixed by: Onno Marsman
    // +   improved by: Yves Sucaet
    // +   bugfixed by: Onno Marsman
    // +   bugfixed by: Ulrich
    // +   bugfixed by: Rafal Kukawski
    // +   improved by: kirilloid
    // *     example 1: utf8_encode('Kevin van Zonneveld');
    // *     returns 1: 'Kevin van Zonneveld'

    if (argString === null || typeof argString === "undefined") {
      return "";
    }

    var string = (argString + ''); // .replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    var utftext = '',
        start, end, stringl = 0;

    start = end = 0;
    stringl = string.length;
    for (var n = 0; n < stringl; n++) {
      var c1 = string.charCodeAt(n);
      var enc = null;

      if (c1 < 128) {
        end++;
      } else if (c1 > 127 && c1 < 2048) {
        enc = String.fromCharCode((c1 >> 6) | 192, (c1 & 63) | 128);
      } else {
        enc = String.fromCharCode((c1 >> 12) | 224, ((c1 >> 6) & 63) | 128, (c1 & 63) | 128);
      }
      if (enc !== null) {
        if (end > start) {
          utftext += string.slice(start, end);
        }
        utftext += enc;
        start = end = n + 1;
      }
    }

    if (end > start) {
      utftext += string.slice(start, stringl);
    }

    return utftext;
  }
  
  function crc32 (str) {
    // http://kevin.vanzonneveld.net
    // +   original by: Webtoolkit.info (http://www.webtoolkit.info/)
    // +   improved by: T0bsn
    // +   improved by: http://stackoverflow.com/questions/2647935/javascript-crc32-function-and-php-crc32-not-matching
    // -    depends on: utf8_encode
    // *     example 1: crc32('Kevin van Zonneveld');
    // *     returns 1: 1249991249
    str = utf8_encode(str);
    var table = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";

    var crc = 0;
    var x = 0;
    var y = 0;

    crc = crc ^ (-1);
    for (var i = 0, iTop = str.length; i < iTop; i++) {
      y = (crc ^ str.charCodeAt(i)) & 0xFF;
      x = "0x" + table.substr(y * 9, 8);
      crc = (crc >>> 8) ^ x;
    }

    crc = crc ^ (-1);
    //convert to unsigned 32-bit int if needed
    if (crc < 0) {crc += 4294967296;}
    return crc;
  }

  function option_consume(options, option_name, default_value) {
    var result = options[option_name];
    delete options[option_name];
    return typeof(result) == 'undefined' ? default_value : result;
  }

  function build_array(arg) {
    if (!arg) {
      return [];
    } else if ($.isArray(arg)) {
      return arg;
    } else { 
      return [arg];
    }
  }

  function present(value) {
    return typeof value != 'undefined' && ("" + value).length > 0;
  }

  function process_base_transformations(options) {
    var transformations = build_array(options.transformation);
    var all_named = true;
    for (var i = 0; i < transformations.length; i++) {
      all_named = all_named && typeof(transformations[i]) == 'string';
    }
    if (all_named) {
      return [];
    }
    delete options.transformation;
    var base_transformations = []; 
    for (var i = 0; i < transformations.length; i++) {
      var transformation = transformations[i];
      if (typeof(transformation) == 'string') {
        base_transformations.push("t_" + transformation);
      } else {
        base_transformations.push(generate_transformation_string($.extend({}, transformation)));
      }
    }
    return base_transformations;
  }

  function process_size(options) {
    var size = option_consume(options, 'size');
    if (size) {
      var split_size = size.split("x");
      options.width = split_size[0];
      options.height = split_size[1];
    }    
  }

  function process_html_dimensions(options) {
    var width = options.width, height = options.height;
    var has_layer = options.overlay || options.underlay;     
    var crop = options.crop;
    var use_as_html_dimensions = !has_layer && !options.angle && crop != "fit" && crop != "limit" && crop != "lfill";
    if (use_as_html_dimensions) {
      if (width && !options.html_width && width !== "auto" && parseFloat(width) >= 1) options.html_width = width;
      if (height && !options.html_height && parseFloat(height) >= 1) options.html_height = height;
    }
    if (!crop && !has_layer) {
      delete options.width;
      delete options.height;
    }    
  }

  var TRANSFORMATION_PARAM_NAME_MAPPING = {
    angle: 'a',
    background: 'b',
    border: 'bo',
    color: 'co',
    color_space: 'cs',
    crop: 'c',
    default_image: 'd',
    delay: 'dl',
    density: 'dn',
    dpr: 'dpr',
    effect: 'e',
    fetch_format: 'f',
    flags: 'fl',
    gravity: 'g',
    height: 'h',
    opacity: 'o',
    overlay: 'l',
    page: 'pg',
    prefix: 'p',
    quality: 'q',
    radius: 'r',
    transformation: 't',
    underlay: 'u',
    width: 'w',
    x: 'x',
    y: 'y'
  };

  var TRANSFORMATION_PARAM_VALUE_MAPPING = {
    angle: function(angle){ return build_array(angle).join("."); },
    background: function(background) { return background.replace(/^#/, 'rgb:');},
    border: function(border) {
      if ($.isPlainObject(border)) { 
        var border_width = "" + (border.width || 2);
        var border_color = (border.color || "black").replace(/^#/, 'rgb:');
        border = border_width + "px_solid_" + border_color;
      }
      return border;        
    },
    color: function(color) { return color.replace(/^#/, 'rgb:');},
    dpr: function(dpr) {
      dpr = dpr.toString();
      if (dpr === "auto") {
        return "1.0";
      } else if (dpr.match(/^\d+$/)) {
        return dpr + ".0";
      } else {
        return dpr;
      }
    },
    effect: function(effect) { return build_array(effect).join(":");},
    flags: function(flags) { return build_array(flags).join(".")},
    transformation: function(transformation) { return build_array(transformation).join(".")}
  };

  function generate_transformation_string(options) {
    var base_transformations = process_base_transformations(options);
    process_size(options);
    process_html_dimensions(options);
    
    var params = [];
    for (var param in TRANSFORMATION_PARAM_NAME_MAPPING) {
      var value = option_consume(options, param);
      if (!present(value)) continue;
      if (TRANSFORMATION_PARAM_VALUE_MAPPING[param]) {        
        value = TRANSFORMATION_PARAM_VALUE_MAPPING[param](value);
      }
      if (!present(value)) continue;
      params.push(TRANSFORMATION_PARAM_NAME_MAPPING[param] + "_" + value);
    }
    params.sort();

    var raw_transformation = option_consume(options, 'raw_transformation');
    if (present(raw_transformation)) params.push(raw_transformation);
    var transformation = params.join(",");
    if (present(transformation)) base_transformations.push(transformation);
    return base_transformations.join("/");
  }

  function absolutize(url) {
    if (!url.match(/^https?:\//)) {
      var prefix = document.location.protocol + "//" + document.location.host;
      if (url[0] == '?') {
        prefix += document.location.pathname;
      } else if (url[0] != '/') {
        prefix += document.location.pathname.replace(/\/[^\/]*$/, '/');
      }        
      url = prefix + url;
    }
    return url;
  }

  function cloudinary_url(public_id, options) { 
    options = options || {};
    var type = option_consume(options, 'type', 'upload');
    if (type == 'fetch') {
      options.fetch_format = options.fetch_format || option_consume(options, 'format');
    }
    var transformation = generate_transformation_string(options);
    var resource_type = option_consume(options, 'resource_type', "image");
    var version = option_consume(options, 'version');
    var format = option_consume(options, 'format');
    var cloud_name = option_consume(options, 'cloud_name', $.cloudinary.config().cloud_name);
    if (!cloud_name) throw "Unknown cloud_name";
    var private_cdn = option_consume(options, 'private_cdn', $.cloudinary.config().private_cdn);    
    var secure_distribution = option_consume(options, 'secure_distribution', $.cloudinary.config().secure_distribution);    
    var cname = option_consume(options, 'cname', $.cloudinary.config().cname);
    var cdn_subdomain = option_consume(options, 'cdn_subdomain', $.cloudinary.config().cdn_subdomain);
    var shorten = option_consume(options, 'shorten', $.cloudinary.config().shorten);
    var secure = option_consume(options, 'secure', window.location.protocol == 'https:');
    var protocol = option_consume(options, 'protocol', $.cloudinary.config().protocol);
    var trust_public_id = option_consume(options, 'trust_public_id'); 

    if (type == 'fetch') {
      public_id = absolutize(public_id); 
    }
    
    if (public_id.match(/^https?:/)) {
      if (type == "upload" || type == "asset") return public_id;
      public_id = encodeURIComponent(public_id).replace(/%3A/g, ":").replace(/%2F/g, "/"); 
    } else {
      // Make sure public_id is URI encoded.
      public_id = encodeURIComponent(decodeURIComponent(public_id)).replace(/%3A/g, ":").replace(/%2F/g, "/");      
      if (format) {
        if (!trust_public_id) public_id = public_id.replace(/\.(jpg|png|gif|webp)$/, '');
        public_id = public_id + "." + format;
      }
    }

    var prefix = secure ? 'https://' : (window.location.protocol === 'file:' ? "file://" : 'http://');
    prefix = protocol ? protocol + '//' : prefix;
    if (cloud_name.match(/^\//) && !secure) {
      prefix = "/res" + cloud_name;
    } else {
      var shared_domain = !private_cdn;
      if (secure) {        
        if (!secure_distribution || secure_distribution == OLD_AKAMAI_SHARED_CDN) {
          secure_distribution = private_cdn ? cloud_name + "-res.cloudinary.com" : SHARED_CDN;
        }
        shared_domain = shared_domain || secure_distribution == SHARED_CDN;
        prefix += secure_distribution;
      } else {
        var subdomain = cdn_subdomain ? "a" + ((crc32(public_id) % 5) + 1) + "." : "";
        var host = cname || (private_cdn ? cloud_name + "-res.cloudinary.com" : "res.cloudinary.com" );
        prefix += subdomain + host;
      }
      if (shared_domain) prefix += "/" + cloud_name;
    }
    if (shorten && resource_type == "image" && type == "upload") {
      resource_type = "iu";
      type = undefined;
    }
    if (public_id.search("/") >= 0 && !public_id.match(/^v[0-9]+/) && !public_id.match(/^https?:\//) && !present(version)) {
      version = 1;
    }

    var url = [prefix, resource_type, type, transformation, version ? "v" + version : "",
               public_id].join("/").replace(/([^:])\/+/g, '$1/');
    return url;
  }

  function default_stoppoints(width) {
    return 10 * Math.ceil(width / 10);
  }

  function prepare_html_url(public_id, options) {
    if ($.cloudinary.config('dpr') && !options.dpr) {
      options.dpr = $.cloudinary.config('dpr');
    }
    var url = cloudinary_url(public_id, options);
    var width = option_consume(options, 'html_width');
    var height = option_consume(options, 'html_height');
    if (width) options.width = width;
    if (height) options.height = height;    
    return url;
  }

  function get_config(name, options, default_value) {
    var value = options[name] || $.cloudinary.config(name);
    if (typeof(value) == 'undefined') value = default_value;
    return value;
  }

  var cloudinary_config = null;
  var responsive_config = null;
  var responsive_resize_initialized = false;
  var device_pixel_ratio_cache = {};

  $.cloudinary = {
    CF_SHARED_CDN: CF_SHARED_CDN,  
    OLD_AKAMAI_SHARED_CDN: OLD_AKAMAI_SHARED_CDN,
    AKAMAI_SHARED_CDN: AKAMAI_SHARED_CDN,
    SHARED_CDN: SHARED_CDN,    
    config: function(new_config, new_value) {
      if (!cloudinary_config) {
        cloudinary_config = {};
        $('meta[name^="cloudinary_"]').each(function() {
          cloudinary_config[$(this).attr('name').replace("cloudinary_", '')] = $(this).attr('content');
        });
      }
      if (typeof(new_value) != 'undefined') {
        cloudinary_config[new_config] = new_value;
      } else if (typeof(new_config) == 'string') {
        return cloudinary_config[new_config];
      } else if (new_config) {
        cloudinary_config = new_config;
      }
      return cloudinary_config;
    },
    url: function(public_id, options) {
      options = $.extend({}, options);
      return cloudinary_url(public_id, options);    
    },    
    url_internal: cloudinary_url,
    transformation_string: function(options) {
      options = $.extend({}, options);
      return generate_transformation_string(options);
    },
    image: function(public_id, options) {
      options = $.extend({}, options);
      var url = prepare_html_url(public_id, options);
      var img = $('<img/>').data('src-cache', url).attr(options).cloudinary_update(options);
      return img;
    },
    facebook_profile_image: function(public_id, options) {
      return $.cloudinary.image(public_id, $.extend({type: 'facebook'}, options));
    },
    twitter_profile_image: function(public_id, options) {
      return $.cloudinary.image(public_id, $.extend({type: 'twitter'}, options));
    },
    twitter_name_profile_image: function(public_id, options) {
      return $.cloudinary.image(public_id, $.extend({type: 'twitter_name'}, options));
    },
    gravatar_image: function(public_id, options) {
      return $.cloudinary.image(public_id, $.extend({type: 'gravatar'}, options));
    },
    fetch_image: function(public_id, options) {
      return $.cloudinary.image(public_id, $.extend({type: 'fetch'}, options));
    },
    sprite_css: function(public_id, options) {
      options = $.extend({type: 'sprite'}, options);
      if (!public_id.match(/.css$/)) options.format = 'css';
      return $.cloudinary.url(public_id, options);
    },
    /** 
     * Turn on hidpi (dpr_auto) and responsive (w_auto) processing according to the current container size and the device pixel ratio.
     * Use the following classes:
     * - cld-hidpi - only set dpr_auto
     * - cld-responsive - update both dpr_auto and w_auto
     * @param: options
     * - responsive_resize - should responsive images be updated on resize (default: true).
     * - responsive_debounce - if set, how many milliseconds after resize is done before the image is replaces (default: 100). Set to 0 to disable.
     * - responsive_use_stoppoints: 
     *   - true - always use stoppoints for width
     *   - "resize" - use exact width on first render and stoppoints on resize (default)
     *   - false - always use exact width
     * Stoppoints - to prevent creating a transformation for every pixel, stop-points can be configured. The smallest stop-point that is larger than
     *    the wanted width will be used. The default stoppoints are all the multiples of 10. See calc_stoppoint for ways to override this.
     */
    responsive: function(options) {
      responsive_config = $.extend(responsive_config || {}, options);
      $('img.cld-responsive, img.cld-hidpi').cloudinary_update(responsive_config);
      var responsive_resize = get_config('responsive_resize', responsive_config, true);
      if (responsive_resize && !responsive_resize_initialized) {
        responsive_config.resizing = responsive_resize_initialized = true;
        var timeout = null;
        $(window).on('resize', function() {
          var debounce = get_config('responsive_debounce', responsive_config, 100);
          function reset() {
            if (timeout) {
              clearTimeout(timeout); 
              timeout = null;
            }
          }
          function run() {
            $('img.cld-responsive').cloudinary_update(responsive_config);  
          }
          function wait() {
            reset();
            setTimeout(function() { reset(); run(); }, debounce);
          }
          if (debounce) {
            wait();
          } else {
            run();
          }
        });
      }
    },    
    /**
     * Compute the stoppoint for the given element and width.
     * By default the stoppoint will be the smallest multiple of 10 larger than the width.
     * These can be overridden by either setting the data-stoppoints attribute of an image or using $.cloudinary.config('stoppoints', stoppoints).
     * The value can be either:
     * - an ordered list of the wanted stoppoints
     * - a comma separated ordered list of stoppoints
     * - a function that returns the stoppoint given the wanted width.
     */
    calc_stoppoint: function (element, width) {
      var stoppoints = $(element).data('stoppoints') || $.cloudinary.config().stoppoints || default_stoppoints;
      if (typeof(stoppoints) === 'function') {
        return stoppoints(width);
      }
      if (typeof(stoppoints) === 'string') {
        stoppoints = $.map(stoppoints.split(","), function(val){ return parseInt(val); });
      }
      var i = stoppoints.length - 2;
      while (i >= 0 && stoppoints[i] >= width) {
        i--;
      }
      return stoppoints[i+1];
    },
    device_pixel_ratio: function() {    
      var dpr = window.devicePixelRatio || 1;
      var dpr_string = device_pixel_ratio_cache[dpr];      
      if (!dpr_string) {
        dpr_string = dpr.toString();
        if (dpr_string.match(/^\d+$/)) dpr_string += ".0";
        device_pixel_ratio_cache[dpr] = dpr_string;
      }
      return dpr_string;
    }
  };

  $.fn.cloudinary = function(options) {
    this.filter('img').each(function() {
      var img_options = $.extend({width: $(this).attr('width'), height: $(this).attr('height'),
                                  src: $(this).attr('src')}, $(this).data(), options);
      var public_id = option_consume(img_options, 'source', option_consume(img_options, 'src')); 
      var url = prepare_html_url(public_id, img_options);
      $(this).data('src-cache', url).attr({width: img_options.width, height: img_options.height});
    }).cloudinary_update(options);
    return this;
  };

  /** 
   * Update hidpi (dpr_auto) and responsive (w_auto) fields according to the current container size and the device pixel ratio.
   * Only images marked with the cld-responsive class have w_auto updated.
   * options: 
   * - responsive_use_stoppoints: 
   *   - true - always use stoppoints for width
   *   - "resize" - use exact width on first render and stoppoints on resize (default)
   *   - false - always use exact width
   * - responsive:
   *   - true - enable responsive on this element. Can be done by adding cld-responsive.
   *            Note that $.cloudinary.responsive() should be called once on the page. 
   */
  $.fn.cloudinary_update = function(options) {
    options = options || {};
    var responsive_use_stoppoints = get_config('responsive_use_stoppoints', options, "resize");
    var exact = responsive_use_stoppoints === false || (responsive_use_stoppoints == "resize" && !options.resizing);

    this.filter('img').each(function() {
      if (options.responsive) {
        $(this).addClass('cld-responsive');
      }
      var attrs = {};
      var src = $(this).data('src-cache') || $(this).data('src');

      if (!src) return;
      var responsive = $(this).hasClass('cld-responsive') && src.match(/\bw_auto\b/);
      if (responsive) {
        var container = $(this).parent()[0];
        var containerWidth = container ? container.clientWidth : 0;
        if (containerWidth == 0) {
          // container doesn't know the size yet. Usually because the image is hidden or outside the DOM.
          return; 
        }
        
        var requestedWidth = exact ? containerWidth : $.cloudinary.calc_stoppoint(this, containerWidth);          
        var currentWidth = $(this).data('width') || 0; 
        if (requestedWidth > currentWidth) {
          // requested width is larger, fetch new image
          $(this).data('width', requestedWidth);
        } else {
          // requested width is not larger - keep previous
          requestedWidth = currentWidth;
        }
        src = src.replace(/\bw_auto\b/g, "w_" + requestedWidth);
        attrs.width = null;
        attrs.height = null;
      }
      // Update dpr according to the device's devicePixelRatio
      attrs.src = src.replace(/\bdpr_(1\.0|auto)\b/g, "dpr_" + $.cloudinary.device_pixel_ratio());
      $(this).attr(attrs);
    });
    return this;
  };


  var webp = null;
  $.fn.webpify = function(options, webp_options) {
    var that = this;
    options = options || {};
    webp_options = webp_options || options;
    if (!webp) { 
      webp = $.Deferred();
      var webp_canary = new Image();
      webp_canary.onerror = webp.reject;
      webp_canary.onload = webp.resolve;
      webp_canary.src = 'data:image/webp;base64,UklGRi4AAABXRUJQVlA4TCEAAAAvAUAAEB8wAiMwAgSSNtse/cXjxyCCmrYNWPwmHRH9jwMA';
    }
    $(function() {
      webp.done(function() {
        $(that).cloudinary($.extend({}, webp_options, {format: 'webp'}));
      }).fail(function() {
        $(that).cloudinary(options);
      });
    });
    return this;
  };
  $.fn.fetchify = function(options) {
    return this.cloudinary($.extend(options, {'type': 'fetch'}));
  };
  if (!$.fn.fileupload) {
    return;
  }
  $.cloudinary.delete_by_token = function(delete_token, options) {
    options = options || {};
    var url = options.url;
    if (!url) {
      var cloud_name = options.cloud_name || $.cloudinary.config().cloud_name;
      url = "https://api.cloudinary.com/v1_1/" + cloud_name + "/delete_by_token";
    }
    var dataType = $.support.xhrFileUpload ? "json" : "iframe json";
    return $.ajax({
      url: url,
      method: "POST",
      data: {token: delete_token},
      headers: {"X-Requested-With": "XMLHttpRequest"},
      dataType: dataType
    });
  };

  $.fn.cloudinary_fileupload = function(options) {
    var initializing = !this.data('blueimpFileupload');
    if (initializing) {
      options = $.extend({
        maxFileSize: 20000000,
        dataType: 'json',
        headers: {"X-Requested-With": "XMLHttpRequest"}
      }, options);
    }
    this.fileupload(options);
    
    if (initializing) {
      this.bind("fileuploaddone", function(e, data) {
        if (data.result.error) return;      
        data.result.path = ["v", data.result.version, "/", data.result.public_id, 
                            data.result.format ? "." + data.result.format : ""].join("");
    
        if (data.cloudinaryField && data.form.length > 0) {
          var upload_info = [data.result.resource_type, data.result.type, data.result.path].join("/") + "#" + data.result.signature;  
          var multiple = $(e.target).prop("multiple");
          var add_field = function() {
            $('<input></input>').attr({type: "hidden", name: data.cloudinaryField}).val(upload_info).appendTo(data.form);
          };
          
          if (multiple) {
            add_field();
          } else {          
            var field = $(data.form).find('input[name="' + data.cloudinaryField + '"]');
            if (field.length > 0) {
              field.val(upload_info);
            } else {
              add_field();
            }
          }
        }
        $(e.target).trigger('cloudinarydone', data);
      });
      
      this.bind("fileuploadstart", function(e){
        $(e.target).trigger('cloudinarystart');
      });
      this.bind("fileuploadstop", function(e){
        $(e.target).trigger('cloudinarystop');
      });
      this.bind("fileuploadprogress", function(e,data){
        $(e.target).trigger('cloudinaryprogress',data);
      });
      this.bind("fileuploadprogressall", function(e,data){
        $(e.target).trigger('cloudinaryprogressall',data);
      });
      this.bind("fileuploadfail", function(e,data){
        $(e.target).trigger('cloudinaryfail',data);
      });
      this.bind("fileuploadalways", function(e,data){
        $(e.target).trigger('cloudinaryalways',data);
      });

      if (!this.fileupload('option').url) {
        var cloud_name = options.cloud_name || $.cloudinary.config().cloud_name;
        var upload_url = "https://api.cloudinary.com/v1_1/" + cloud_name + "/upload";
        this.fileupload('option', 'url', upload_url);
      }
    }
    return this;
  };
  
  $.fn.cloudinary_upload_url = function(remote_url) {
    this.fileupload('option', 'formData').file = remote_url; 
    this.fileupload('add', { files: [ remote_url ] }); 
    delete(this.fileupload('option', 'formData').file);    
  };
    
  $.fn.unsigned_cloudinary_upload = function(upload_preset, upload_params, options) {
    options = options || {};
    upload_params = $.extend({}, upload_params) || {};

    if (upload_params.cloud_name) {
      options.cloud_name = upload_params.cloud_name;
      delete upload_params.cloud_name;
    }

    // Serialize upload_params
    for (var key in upload_params) {
      var value = upload_params[key];
      if ($.isPlainObject(value)) {
        upload_params[key] = $.map(value, function(v, k){return k + "=" + v;}).join("|");      
      } else if ($.isArray(value)) {
        if (value.length > 0 && $.isArray(value[0])) {
          upload_params[key] = $.map(value, function(array_value){return array_value.join(",");}).join("|");                
        } else {
          upload_params[key] = value.join(",");  
        }
      }
    }
    if (!upload_params.callback) {
      upload_params.callback = "/cloudinary_cors.html";
    }
    upload_params.upload_preset = upload_preset;

    options.formData = upload_params;

    if (options.cloudinary_field) {
      options.cloudinaryField = options.cloudinary_field;
      delete options.cloudinary_field;
    }
        
    var html_options = options.html || {};
    html_options["class"] = "cloudinary_fileupload " + (html_options["class"] || "");
    if (options.multiple) html_options.multiple = true;
    this.attr(html_options).cloudinary_fileupload(options);
    return this;
  };
  
  $.cloudinary.unsigned_upload_tag = function(upload_preset, upload_params, options) {
    return $('<input/>').attr({type: "file", name: "file"}).unsigned_cloudinary_upload(upload_preset, upload_params, options);
  };
}));
/*!
 * typeahead.js 0.11.1
 * https://github.com/twitter/typeahead.js
 * Copyright 2013-2015 Twitter, Inc. and other contributors; Licensed MIT
 */

(function(root, factory) {
    if (typeof define === "function" && define.amd) {
        define("bloodhound", [ "jquery" ], function(a0) {
            return root["Bloodhound"] = factory(a0);
        });
    } else if (typeof exports === "object") {
        module.exports = factory(require("jquery"));
    } else {
        root["Bloodhound"] = factory(jQuery);
    }
})(this, function($) {
    var _ = function() {
        "use strict";
        return {
            isMsie: function() {
                return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
            },
            isBlankString: function(str) {
                return !str || /^\s*$/.test(str);
            },
            escapeRegExChars: function(str) {
                return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
            },
            isString: function(obj) {
                return typeof obj === "string";
            },
            isNumber: function(obj) {
                return typeof obj === "number";
            },
            isArray: $.isArray,
            isFunction: $.isFunction,
            isObject: $.isPlainObject,
            isUndefined: function(obj) {
                return typeof obj === "undefined";
            },
            isElement: function(obj) {
                return !!(obj && obj.nodeType === 1);
            },
            isJQuery: function(obj) {
                return obj instanceof $;
            },
            toStr: function toStr(s) {
                return _.isUndefined(s) || s === null ? "" : s + "";
            },
            bind: $.proxy,
            each: function(collection, cb) {
                $.each(collection, reverseArgs);
                function reverseArgs(index, value) {
                    return cb(value, index);
                }
            },
            map: $.map,
            filter: $.grep,
            every: function(obj, test) {
                var result = true;
                if (!obj) {
                    return result;
                }
                $.each(obj, function(key, val) {
                    if (!(result = test.call(null, val, key, obj))) {
                        return false;
                    }
                });
                return !!result;
            },
            some: function(obj, test) {
                var result = false;
                if (!obj) {
                    return result;
                }
                $.each(obj, function(key, val) {
                    if (result = test.call(null, val, key, obj)) {
                        return false;
                    }
                });
                return !!result;
            },
            mixin: $.extend,
            identity: function(x) {
                return x;
            },
            clone: function(obj) {
                return $.extend(true, {}, obj);
            },
            getIdGenerator: function() {
                var counter = 0;
                return function() {
                    return counter++;
                };
            },
            templatify: function templatify(obj) {
                return $.isFunction(obj) ? obj : template;
                function template() {
                    return String(obj);
                }
            },
            defer: function(fn) {
                setTimeout(fn, 0);
            },
            debounce: function(func, wait, immediate) {
                var timeout, result;
                return function() {
                    var context = this, args = arguments, later, callNow;
                    later = function() {
                        timeout = null;
                        if (!immediate) {
                            result = func.apply(context, args);
                        }
                    };
                    callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) {
                        result = func.apply(context, args);
                    }
                    return result;
                };
            },
            throttle: function(func, wait) {
                var context, args, timeout, result, previous, later;
                previous = 0;
                later = function() {
                    previous = new Date();
                    timeout = null;
                    result = func.apply(context, args);
                };
                return function() {
                    var now = new Date(), remaining = wait - (now - previous);
                    context = this;
                    args = arguments;
                    if (remaining <= 0) {
                        clearTimeout(timeout);
                        timeout = null;
                        previous = now;
                        result = func.apply(context, args);
                    } else if (!timeout) {
                        timeout = setTimeout(later, remaining);
                    }
                    return result;
                };
            },
            stringify: function(val) {
                return _.isString(val) ? val : JSON.stringify(val);
            },
            noop: function() {}
        };
    }();
    var VERSION = "0.11.1";
    var tokenizers = function() {
        "use strict";
        return {
            nonword: nonword,
            whitespace: whitespace,
            obj: {
                nonword: getObjTokenizer(nonword),
                whitespace: getObjTokenizer(whitespace)
            }
        };
        function whitespace(str) {
            str = _.toStr(str);
            return str ? str.split(/\s+/) : [];
        }
        function nonword(str) {
            str = _.toStr(str);
            return str ? str.split(/\W+/) : [];
        }
        function getObjTokenizer(tokenizer) {
            return function setKey(keys) {
                keys = _.isArray(keys) ? keys : [].slice.call(arguments, 0);
                return function tokenize(o) {
                    var tokens = [];
                    _.each(keys, function(k) {
                        tokens = tokens.concat(tokenizer(_.toStr(o[k])));
                    });
                    return tokens;
                };
            };
        }
    }();
    var LruCache = function() {
        "use strict";
        function LruCache(maxSize) {
            this.maxSize = _.isNumber(maxSize) ? maxSize : 100;
            this.reset();
            if (this.maxSize <= 0) {
                this.set = this.get = $.noop;
            }
        }
        _.mixin(LruCache.prototype, {
            set: function set(key, val) {
                var tailItem = this.list.tail, node;
                if (this.size >= this.maxSize) {
                    this.list.remove(tailItem);
                    delete this.hash[tailItem.key];
                    this.size--;
                }
                if (node = this.hash[key]) {
                    node.val = val;
                    this.list.moveToFront(node);
                } else {
                    node = new Node(key, val);
                    this.list.add(node);
                    this.hash[key] = node;
                    this.size++;
                }
            },
            get: function get(key) {
                var node = this.hash[key];
                if (node) {
                    this.list.moveToFront(node);
                    return node.val;
                }
            },
            reset: function reset() {
                this.size = 0;
                this.hash = {};
                this.list = new List();
            }
        });
        function List() {
            this.head = this.tail = null;
        }
        _.mixin(List.prototype, {
            add: function add(node) {
                if (this.head) {
                    node.next = this.head;
                    this.head.prev = node;
                }
                this.head = node;
                this.tail = this.tail || node;
            },
            remove: function remove(node) {
                node.prev ? node.prev.next = node.next : this.head = node.next;
                node.next ? node.next.prev = node.prev : this.tail = node.prev;
            },
            moveToFront: function(node) {
                this.remove(node);
                this.add(node);
            }
        });
        function Node(key, val) {
            this.key = key;
            this.val = val;
            this.prev = this.next = null;
        }
        return LruCache;
    }();
    var PersistentStorage = function() {
        "use strict";
        var LOCAL_STORAGE;
        try {
            LOCAL_STORAGE = window.localStorage;
            LOCAL_STORAGE.setItem("~~~", "!");
            LOCAL_STORAGE.removeItem("~~~");
        } catch (err) {
            LOCAL_STORAGE = null;
        }
        function PersistentStorage(namespace, override) {
            this.prefix = [ "__", namespace, "__" ].join("");
            this.ttlKey = "__ttl__";
            this.keyMatcher = new RegExp("^" + _.escapeRegExChars(this.prefix));
            this.ls = override || LOCAL_STORAGE;
            !this.ls && this._noop();
        }
        _.mixin(PersistentStorage.prototype, {
            _prefix: function(key) {
                return this.prefix + key;
            },
            _ttlKey: function(key) {
                return this._prefix(key) + this.ttlKey;
            },
            _noop: function() {
                this.get = this.set = this.remove = this.clear = this.isExpired = _.noop;
            },
            _safeSet: function(key, val) {
                try {
                    this.ls.setItem(key, val);
                } catch (err) {
                    if (err.name === "QuotaExceededError") {
                        this.clear();
                        this._noop();
                    }
                }
            },
            get: function(key) {
                if (this.isExpired(key)) {
                    this.remove(key);
                }
                return decode(this.ls.getItem(this._prefix(key)));
            },
            set: function(key, val, ttl) {
                if (_.isNumber(ttl)) {
                    this._safeSet(this._ttlKey(key), encode(now() + ttl));
                } else {
                    this.ls.removeItem(this._ttlKey(key));
                }
                return this._safeSet(this._prefix(key), encode(val));
            },
            remove: function(key) {
                this.ls.removeItem(this._ttlKey(key));
                this.ls.removeItem(this._prefix(key));
                return this;
            },
            clear: function() {
                var i, keys = gatherMatchingKeys(this.keyMatcher);
                for (i = keys.length; i--; ) {
                    this.remove(keys[i]);
                }
                return this;
            },
            isExpired: function(key) {
                var ttl = decode(this.ls.getItem(this._ttlKey(key)));
                return _.isNumber(ttl) && now() > ttl ? true : false;
            }
        });
        return PersistentStorage;
        function now() {
            return new Date().getTime();
        }
        function encode(val) {
            return JSON.stringify(_.isUndefined(val) ? null : val);
        }
        function decode(val) {
            return $.parseJSON(val);
        }
        function gatherMatchingKeys(keyMatcher) {
            var i, key, keys = [], len = LOCAL_STORAGE.length;
            for (i = 0; i < len; i++) {
                if ((key = LOCAL_STORAGE.key(i)).match(keyMatcher)) {
                    keys.push(key.replace(keyMatcher, ""));
                }
            }
            return keys;
        }
    }();
    var Transport = function() {
        "use strict";
        var pendingRequestsCount = 0, pendingRequests = {}, maxPendingRequests = 6, sharedCache = new LruCache(10);
        function Transport(o) {
            o = o || {};
            this.cancelled = false;
            this.lastReq = null;
            this._send = o.transport;
            this._get = o.limiter ? o.limiter(this._get) : this._get;
            this._cache = o.cache === false ? new LruCache(0) : sharedCache;
        }
        Transport.setMaxPendingRequests = function setMaxPendingRequests(num) {
            maxPendingRequests = num;
        };
        Transport.resetCache = function resetCache() {
            sharedCache.reset();
        };
        _.mixin(Transport.prototype, {
            _fingerprint: function fingerprint(o) {
                o = o || {};
                return o.url + o.type + $.param(o.data || {});
            },
            _get: function(o, cb) {
                var that = this, fingerprint, jqXhr;
                fingerprint = this._fingerprint(o);
                if (this.cancelled || fingerprint !== this.lastReq) {
                    return;
                }
                if (jqXhr = pendingRequests[fingerprint]) {
                    jqXhr.done(done).fail(fail);
                } else if (pendingRequestsCount < maxPendingRequests) {
                    pendingRequestsCount++;
                    pendingRequests[fingerprint] = this._send(o).done(done).fail(fail).always(always);
                } else {
                    this.onDeckRequestArgs = [].slice.call(arguments, 0);
                }
                function done(resp) {
                    cb(null, resp);
                    that._cache.set(fingerprint, resp);
                }
                function fail() {
                    cb(true);
                }
                function always() {
                    pendingRequestsCount--;
                    delete pendingRequests[fingerprint];
                    if (that.onDeckRequestArgs) {
                        that._get.apply(that, that.onDeckRequestArgs);
                        that.onDeckRequestArgs = null;
                    }
                }
            },
            get: function(o, cb) {
                var resp, fingerprint;
                cb = cb || $.noop;
                o = _.isString(o) ? {
                    url: o
                } : o || {};
                fingerprint = this._fingerprint(o);
                this.cancelled = false;
                this.lastReq = fingerprint;
                if (resp = this._cache.get(fingerprint)) {
                    cb(null, resp);
                } else {
                    this._get(o, cb);
                }
            },
            cancel: function() {
                this.cancelled = true;
            }
        });
        return Transport;
    }();
    var SearchIndex = window.SearchIndex = function() {
        "use strict";
        var CHILDREN = "c", IDS = "i";
        function SearchIndex(o) {
            o = o || {};
            if (!o.datumTokenizer || !o.queryTokenizer) {
                $.error("datumTokenizer and queryTokenizer are both required");
            }
            this.identify = o.identify || _.stringify;
            this.datumTokenizer = o.datumTokenizer;
            this.queryTokenizer = o.queryTokenizer;
            this.reset();
        }
        _.mixin(SearchIndex.prototype, {
            bootstrap: function bootstrap(o) {
                this.datums = o.datums;
                this.trie = o.trie;
            },
            add: function(data) {
                var that = this;
                data = _.isArray(data) ? data : [ data ];
                _.each(data, function(datum) {
                    var id, tokens;
                    that.datums[id = that.identify(datum)] = datum;
                    tokens = normalizeTokens(that.datumTokenizer(datum));
                    _.each(tokens, function(token) {
                        var node, chars, ch;
                        node = that.trie;
                        chars = token.split("");
                        while (ch = chars.shift()) {
                            node = node[CHILDREN][ch] || (node[CHILDREN][ch] = newNode());
                            node[IDS].push(id);
                        }
                    });
                });
            },
            get: function get(ids) {
                var that = this;
                return _.map(ids, function(id) {
                    return that.datums[id];
                });
            },
            search: function search(query) {
                var that = this, tokens, matches;
                tokens = normalizeTokens(this.queryTokenizer(query));
                _.each(tokens, function(token) {
                    var node, chars, ch, ids;
                    if (matches && matches.length === 0) {
                        return false;
                    }
                    node = that.trie;
                    chars = token.split("");
                    while (node && (ch = chars.shift())) {
                        node = node[CHILDREN][ch];
                    }
                    if (node && chars.length === 0) {
                        ids = node[IDS].slice(0);
                        matches = matches ? getIntersection(matches, ids) : ids;
                    } else {
                        matches = [];
                        return false;
                    }
                });
                return matches ? _.map(unique(matches), function(id) {
                    return that.datums[id];
                }) : [];
            },
            all: function all() {
                var values = [];
                for (var key in this.datums) {
                    values.push(this.datums[key]);
                }
                return values;
            },
            reset: function reset() {
                this.datums = {};
                this.trie = newNode();
            },
            serialize: function serialize() {
                return {
                    datums: this.datums,
                    trie: this.trie
                };
            }
        });
        return SearchIndex;
        function normalizeTokens(tokens) {
            tokens = _.filter(tokens, function(token) {
                return !!token;
            });
            tokens = _.map(tokens, function(token) {
                return token.toLowerCase();
            });
            return tokens;
        }
        function newNode() {
            var node = {};
            node[IDS] = [];
            node[CHILDREN] = {};
            return node;
        }
        function unique(array) {
            var seen = {}, uniques = [];
            for (var i = 0, len = array.length; i < len; i++) {
                if (!seen[array[i]]) {
                    seen[array[i]] = true;
                    uniques.push(array[i]);
                }
            }
            return uniques;
        }
        function getIntersection(arrayA, arrayB) {
            var ai = 0, bi = 0, intersection = [];
            arrayA = arrayA.sort();
            arrayB = arrayB.sort();
            var lenArrayA = arrayA.length, lenArrayB = arrayB.length;
            while (ai < lenArrayA && bi < lenArrayB) {
                if (arrayA[ai] < arrayB[bi]) {
                    ai++;
                } else if (arrayA[ai] > arrayB[bi]) {
                    bi++;
                } else {
                    intersection.push(arrayA[ai]);
                    ai++;
                    bi++;
                }
            }
            return intersection;
        }
    }();
    var Prefetch = function() {
        "use strict";
        var keys;
        keys = {
            data: "data",
            protocol: "protocol",
            thumbprint: "thumbprint"
        };
        function Prefetch(o) {
            this.url = o.url;
            this.ttl = o.ttl;
            this.cache = o.cache;
            this.prepare = o.prepare;
            this.transform = o.transform;
            this.transport = o.transport;
            this.thumbprint = o.thumbprint;
            this.storage = new PersistentStorage(o.cacheKey);
        }
        _.mixin(Prefetch.prototype, {
            _settings: function settings() {
                return {
                    url: this.url,
                    type: "GET",
                    dataType: "json"
                };
            },
            store: function store(data) {
                if (!this.cache) {
                    return;
                }
                this.storage.set(keys.data, data, this.ttl);
                this.storage.set(keys.protocol, location.protocol, this.ttl);
                this.storage.set(keys.thumbprint, this.thumbprint, this.ttl);
            },
            fromCache: function fromCache() {
                var stored = {}, isExpired;
                if (!this.cache) {
                    return null;
                }
                stored.data = this.storage.get(keys.data);
                stored.protocol = this.storage.get(keys.protocol);
                stored.thumbprint = this.storage.get(keys.thumbprint);
                isExpired = stored.thumbprint !== this.thumbprint || stored.protocol !== location.protocol;
                return stored.data && !isExpired ? stored.data : null;
            },
            fromNetwork: function(cb) {
                var that = this, settings;
                if (!cb) {
                    return;
                }
                settings = this.prepare(this._settings());
                this.transport(settings).fail(onError).done(onResponse);
                function onError() {
                    cb(true);
                }
                function onResponse(resp) {
                    cb(null, that.transform(resp));
                }
            },
            clear: function clear() {
                this.storage.clear();
                return this;
            }
        });
        return Prefetch;
    }();
    var Remote = function() {
        "use strict";
        function Remote(o) {
            this.url = o.url;
            this.prepare = o.prepare;
            this.transform = o.transform;
            this.transport = new Transport({
                cache: o.cache,
                limiter: o.limiter,
                transport: o.transport
            });
        }
        _.mixin(Remote.prototype, {
            _settings: function settings() {
                return {
                    url: this.url,
                    type: "GET",
                    dataType: "json"
                };
            },
            get: function get(query, cb) {
                var that = this, settings;
                if (!cb) {
                    return;
                }
                query = query || "";
                settings = this.prepare(query, this._settings());
                return this.transport.get(settings, onResponse);
                function onResponse(err, resp) {
                    err ? cb([]) : cb(that.transform(resp));
                }
            },
            cancelLastRequest: function cancelLastRequest() {
                this.transport.cancel();
            }
        });
        return Remote;
    }();
    var oParser = function() {
        "use strict";
        return function parse(o) {
            var defaults, sorter;
            defaults = {
                initialize: true,
                identify: _.stringify,
                datumTokenizer: null,
                queryTokenizer: null,
                sufficient: 5,
                sorter: null,
                local: [],
                prefetch: null,
                remote: null
            };
            o = _.mixin(defaults, o || {});
            !o.datumTokenizer && $.error("datumTokenizer is required");
            !o.queryTokenizer && $.error("queryTokenizer is required");
            sorter = o.sorter;
            o.sorter = sorter ? function(x) {
                return x.sort(sorter);
            } : _.identity;
            o.local = _.isFunction(o.local) ? o.local() : o.local;
            o.prefetch = parsePrefetch(o.prefetch);
            o.remote = parseRemote(o.remote);
            return o;
        };
        function parsePrefetch(o) {
            var defaults;
            if (!o) {
                return null;
            }
            defaults = {
                url: null,
                ttl: 24 * 60 * 60 * 1e3,
                cache: true,
                cacheKey: null,
                thumbprint: "",
                prepare: _.identity,
                transform: _.identity,
                transport: null
            };
            o = _.isString(o) ? {
                url: o
            } : o;
            o = _.mixin(defaults, o);
            !o.url && $.error("prefetch requires url to be set");
            o.transform = o.filter || o.transform;
            o.cacheKey = o.cacheKey || o.url;
            o.thumbprint = VERSION + o.thumbprint;
            o.transport = o.transport ? callbackToDeferred(o.transport) : $.ajax;
            return o;
        }
        function parseRemote(o) {
            var defaults;
            if (!o) {
                return;
            }
            defaults = {
                url: null,
                cache: true,
                prepare: null,
                replace: null,
                wildcard: null,
                limiter: null,
                rateLimitBy: "debounce",
                rateLimitWait: 300,
                transform: _.identity,
                transport: null
            };
            o = _.isString(o) ? {
                url: o
            } : o;
            o = _.mixin(defaults, o);
            !o.url && $.error("remote requires url to be set");
            o.transform = o.filter || o.transform;
            o.prepare = toRemotePrepare(o);
            o.limiter = toLimiter(o);
            o.transport = o.transport ? callbackToDeferred(o.transport) : $.ajax;
            delete o.replace;
            delete o.wildcard;
            delete o.rateLimitBy;
            delete o.rateLimitWait;
            return o;
        }
        function toRemotePrepare(o) {
            var prepare, replace, wildcard;
            prepare = o.prepare;
            replace = o.replace;
            wildcard = o.wildcard;
            if (prepare) {
                return prepare;
            }
            if (replace) {
                prepare = prepareByReplace;
            } else if (o.wildcard) {
                prepare = prepareByWildcard;
            } else {
                prepare = idenityPrepare;
            }
            return prepare;
            function prepareByReplace(query, settings) {
                settings.url = replace(settings.url, query);
                return settings;
            }
            function prepareByWildcard(query, settings) {
                settings.url = settings.url.replace(wildcard, encodeURIComponent(query));
                return settings;
            }
            function idenityPrepare(query, settings) {
                return settings;
            }
        }
        function toLimiter(o) {
            var limiter, method, wait;
            limiter = o.limiter;
            method = o.rateLimitBy;
            wait = o.rateLimitWait;
            if (!limiter) {
                limiter = /^throttle$/i.test(method) ? throttle(wait) : debounce(wait);
            }
            return limiter;
            function debounce(wait) {
                return function debounce(fn) {
                    return _.debounce(fn, wait);
                };
            }
            function throttle(wait) {
                return function throttle(fn) {
                    return _.throttle(fn, wait);
                };
            }
        }
        function callbackToDeferred(fn) {
            return function wrapper(o) {
                var deferred = $.Deferred();
                fn(o, onSuccess, onError);
                return deferred;
                function onSuccess(resp) {
                    _.defer(function() {
                        deferred.resolve(resp);
                    });
                }
                function onError(err) {
                    _.defer(function() {
                        deferred.reject(err);
                    });
                }
            };
        }
    }();
    var Bloodhound = function() {
        "use strict";
        var old;
        old = window && window.Bloodhound;
        function Bloodhound(o) {
            o = oParser(o);
            this.sorter = o.sorter;
            this.identify = o.identify;
            this.sufficient = o.sufficient;
            this.local = o.local;
            this.remote = o.remote ? new Remote(o.remote) : null;
            this.prefetch = o.prefetch ? new Prefetch(o.prefetch) : null;
            this.index = new SearchIndex({
                identify: this.identify,
                datumTokenizer: o.datumTokenizer,
                queryTokenizer: o.queryTokenizer
            });
            o.initialize !== false && this.initialize();
        }
        Bloodhound.noConflict = function noConflict() {
            window && (window.Bloodhound = old);
            return Bloodhound;
        };
        Bloodhound.tokenizers = tokenizers;
        _.mixin(Bloodhound.prototype, {
            __ttAdapter: function ttAdapter() {
                var that = this;
                return this.remote ? withAsync : withoutAsync;
                function withAsync(query, sync, async) {
                    return that.search(query, sync, async);
                }
                function withoutAsync(query, sync) {
                    return that.search(query, sync);
                }
            },
            _loadPrefetch: function loadPrefetch() {
                var that = this, deferred, serialized;
                deferred = $.Deferred();
                if (!this.prefetch) {
                    deferred.resolve();
                } else if (serialized = this.prefetch.fromCache()) {
                    this.index.bootstrap(serialized);
                    deferred.resolve();
                } else {
                    this.prefetch.fromNetwork(done);
                }
                return deferred.promise();
                function done(err, data) {
                    if (err) {
                        return deferred.reject();
                    }
                    that.add(data);
                    that.prefetch.store(that.index.serialize());
                    deferred.resolve();
                }
            },
            _initialize: function initialize() {
                var that = this, deferred;
                this.clear();
                (this.initPromise = this._loadPrefetch()).done(addLocalToIndex);
                return this.initPromise;
                function addLocalToIndex() {
                    that.add(that.local);
                }
            },
            initialize: function initialize(force) {
                return !this.initPromise || force ? this._initialize() : this.initPromise;
            },
            add: function add(data) {
                this.index.add(data);
                return this;
            },
            get: function get(ids) {
                ids = _.isArray(ids) ? ids : [].slice.call(arguments);
                return this.index.get(ids);
            },
            search: function search(query, sync, async) {
                var that = this, local;
                local = this.sorter(this.index.search(query));
                sync(this.remote ? local.slice() : local);
                if (this.remote && local.length < this.sufficient) {
                    this.remote.get(query, processRemote);
                } else if (this.remote) {
                    this.remote.cancelLastRequest();
                }
                return this;
                function processRemote(remote) {
                    var nonDuplicates = [];
                    _.each(remote, function(r) {
                        !_.some(local, function(l) {
                            return that.identify(r) === that.identify(l);
                        }) && nonDuplicates.push(r);
                    });
                    async && async(nonDuplicates);
                }
            },
            all: function all() {
                return this.index.all();
            },
            clear: function clear() {
                this.index.reset();
                return this;
            },
            clearPrefetchCache: function clearPrefetchCache() {
                this.prefetch && this.prefetch.clear();
                return this;
            },
            clearRemoteCache: function clearRemoteCache() {
                Transport.resetCache();
                return this;
            },
            ttAdapter: function ttAdapter() {
                return this.__ttAdapter();
            }
        });
        return Bloodhound;
    }();
    return Bloodhound;
});

(function(root, factory) {
    if (typeof define === "function" && define.amd) {
        define("typeahead.js", [ "jquery" ], function(a0) {
            return factory(a0);
        });
    } else if (typeof exports === "object") {
        module.exports = factory(require("jquery"));
    } else {
        factory(jQuery);
    }
})(this, function($) {
    var _ = function() {
        "use strict";
        return {
            isMsie: function() {
                return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
            },
            isBlankString: function(str) {
                return !str || /^\s*$/.test(str);
            },
            escapeRegExChars: function(str) {
                return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
            },
            isString: function(obj) {
                return typeof obj === "string";
            },
            isNumber: function(obj) {
                return typeof obj === "number";
            },
            isArray: $.isArray,
            isFunction: $.isFunction,
            isObject: $.isPlainObject,
            isUndefined: function(obj) {
                return typeof obj === "undefined";
            },
            isElement: function(obj) {
                return !!(obj && obj.nodeType === 1);
            },
            isJQuery: function(obj) {
                return obj instanceof $;
            },
            toStr: function toStr(s) {
                return _.isUndefined(s) || s === null ? "" : s + "";
            },
            bind: $.proxy,
            each: function(collection, cb) {
                $.each(collection, reverseArgs);
                function reverseArgs(index, value) {
                    return cb(value, index);
                }
            },
            map: $.map,
            filter: $.grep,
            every: function(obj, test) {
                var result = true;
                if (!obj) {
                    return result;
                }
                $.each(obj, function(key, val) {
                    if (!(result = test.call(null, val, key, obj))) {
                        return false;
                    }
                });
                return !!result;
            },
            some: function(obj, test) {
                var result = false;
                if (!obj) {
                    return result;
                }
                $.each(obj, function(key, val) {
                    if (result = test.call(null, val, key, obj)) {
                        return false;
                    }
                });
                return !!result;
            },
            mixin: $.extend,
            identity: function(x) {
                return x;
            },
            clone: function(obj) {
                return $.extend(true, {}, obj);
            },
            getIdGenerator: function() {
                var counter = 0;
                return function() {
                    return counter++;
                };
            },
            templatify: function templatify(obj) {
                return $.isFunction(obj) ? obj : template;
                function template() {
                    return String(obj);
                }
            },
            defer: function(fn) {
                setTimeout(fn, 0);
            },
            debounce: function(func, wait, immediate) {
                var timeout, result;
                return function() {
                    var context = this, args = arguments, later, callNow;
                    later = function() {
                        timeout = null;
                        if (!immediate) {
                            result = func.apply(context, args);
                        }
                    };
                    callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) {
                        result = func.apply(context, args);
                    }
                    return result;
                };
            },
            throttle: function(func, wait) {
                var context, args, timeout, result, previous, later;
                previous = 0;
                later = function() {
                    previous = new Date();
                    timeout = null;
                    result = func.apply(context, args);
                };
                return function() {
                    var now = new Date(), remaining = wait - (now - previous);
                    context = this;
                    args = arguments;
                    if (remaining <= 0) {
                        clearTimeout(timeout);
                        timeout = null;
                        previous = now;
                        result = func.apply(context, args);
                    } else if (!timeout) {
                        timeout = setTimeout(later, remaining);
                    }
                    return result;
                };
            },
            stringify: function(val) {
                return _.isString(val) ? val : JSON.stringify(val);
            },
            noop: function() {}
        };
    }();
    var WWW = function() {
        "use strict";
        var defaultClassNames = {
            wrapper: "twitter-typeahead",
            input: "tt-input",
            hint: "tt-hint",
            menu: "tt-menu",
            dataset: "tt-dataset",
            suggestion: "tt-suggestion",
            selectable: "tt-selectable",
            empty: "tt-empty",
            open: "tt-open",
            cursor: "tt-cursor",
            highlight: "tt-highlight"
        };
        return build;
        function build(o) {
            var www, classes;
            classes = _.mixin({}, defaultClassNames, o);
            www = {
                css: buildCss(),
                classes: classes,
                html: buildHtml(classes),
                selectors: buildSelectors(classes)
            };
            return {
                css: www.css,
                html: www.html,
                classes: www.classes,
                selectors: www.selectors,
                mixin: function(o) {
                    _.mixin(o, www);
                }
            };
        }
        function buildHtml(c) {
            return {
                wrapper: '<span class="' + c.wrapper + '"></span>',
                menu: '<div class="' + c.menu + '"></div>'
            };
        }
        function buildSelectors(classes) {
            var selectors = {};
            _.each(classes, function(v, k) {
                selectors[k] = "." + v;
            });
            return selectors;
        }
        function buildCss() {
            var css = {
                wrapper: {
                    position: "relative",
                    display: "inline-block"
                },
                hint: {
                    position: "absolute",
                    top: "0",
                    left: "0",
                    borderColor: "transparent",
                    boxShadow: "none",
                    opacity: "1"
                },
                input: {
                    position: "relative",
                    verticalAlign: "top",
                    backgroundColor: "transparent"
                },
                inputWithNoHint: {
                    position: "relative",
                    verticalAlign: "top"
                },
                menu: {
                    position: "absolute",
                    top: "100%",
                    left: "0",
                    zIndex: "100",
                    display: "none"
                },
                ltr: {
                    left: "0",
                    right: "auto"
                },
                rtl: {
                    left: "auto",
                    right: " 0"
                }
            };
            if (_.isMsie()) {
                _.mixin(css.input, {
                    backgroundImage: "url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"
                });
            }
            return css;
        }
    }();
    var EventBus = function() {
        "use strict";
        var namespace, deprecationMap;
        namespace = "typeahead:";
        deprecationMap = {
            render: "rendered",
            cursorchange: "cursorchanged",
            select: "selected",
            autocomplete: "autocompleted"
        };
        function EventBus(o) {
            if (!o || !o.el) {
                $.error("EventBus initialized without el");
            }
            this.$el = $(o.el);
        }
        _.mixin(EventBus.prototype, {
            _trigger: function(type, args) {
                var $e;
                $e = $.Event(namespace + type);
                (args = args || []).unshift($e);
                this.$el.trigger.apply(this.$el, args);
                return $e;
            },
            before: function(type) {
                var args, $e;
                args = [].slice.call(arguments, 1);
                $e = this._trigger("before" + type, args);
                return $e.isDefaultPrevented();
            },
            trigger: function(type) {
                var deprecatedType;
                this._trigger(type, [].slice.call(arguments, 1));
                if (deprecatedType = deprecationMap[type]) {
                    this._trigger(deprecatedType, [].slice.call(arguments, 1));
                }
            }
        });
        return EventBus;
    }();
    var EventEmitter = function() {
        "use strict";
        var splitter = /\s+/, nextTick = getNextTick();
        return {
            onSync: onSync,
            onAsync: onAsync,
            off: off,
            trigger: trigger
        };
        function on(method, types, cb, context) {
            var type;
            if (!cb) {
                return this;
            }
            types = types.split(splitter);
            cb = context ? bindContext(cb, context) : cb;
            this._callbacks = this._callbacks || {};
            while (type = types.shift()) {
                this._callbacks[type] = this._callbacks[type] || {
                    sync: [],
                    async: []
                };
                this._callbacks[type][method].push(cb);
            }
            return this;
        }
        function onAsync(types, cb, context) {
            return on.call(this, "async", types, cb, context);
        }
        function onSync(types, cb, context) {
            return on.call(this, "sync", types, cb, context);
        }
        function off(types) {
            var type;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            while (type = types.shift()) {
                delete this._callbacks[type];
            }
            return this;
        }
        function trigger(types) {
            var type, callbacks, args, syncFlush, asyncFlush;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            args = [].slice.call(arguments, 1);
            while ((type = types.shift()) && (callbacks = this._callbacks[type])) {
                syncFlush = getFlush(callbacks.sync, this, [ type ].concat(args));
                asyncFlush = getFlush(callbacks.async, this, [ type ].concat(args));
                syncFlush() && nextTick(asyncFlush);
            }
            return this;
        }
        function getFlush(callbacks, context, args) {
            return flush;
            function flush() {
                var cancelled;
                for (var i = 0, len = callbacks.length; !cancelled && i < len; i += 1) {
                    cancelled = callbacks[i].apply(context, args) === false;
                }
                return !cancelled;
            }
        }
        function getNextTick() {
            var nextTickFn;
            if (window.setImmediate) {
                nextTickFn = function nextTickSetImmediate(fn) {
                    setImmediate(function() {
                        fn();
                    });
                };
            } else {
                nextTickFn = function nextTickSetTimeout(fn) {
                    setTimeout(function() {
                        fn();
                    }, 0);
                };
            }
            return nextTickFn;
        }
        function bindContext(fn, context) {
            return fn.bind ? fn.bind(context) : function() {
                fn.apply(context, [].slice.call(arguments, 0));
            };
        }
    }();
    var highlight = function(doc) {
        "use strict";
        var defaults = {
            node: null,
            pattern: null,
            tagName: "strong",
            className: null,
            wordsOnly: false,
            caseSensitive: false
        };
        return function hightlight(o) {
            var regex;
            o = _.mixin({}, defaults, o);
            if (!o.node || !o.pattern) {
                return;
            }
            o.pattern = _.isArray(o.pattern) ? o.pattern : [ o.pattern ];
            regex = getRegex(o.pattern, o.caseSensitive, o.wordsOnly);
            traverse(o.node, hightlightTextNode);
            function hightlightTextNode(textNode) {
                var match, patternNode, wrapperNode;
                if (match = regex.exec(textNode.data)) {
                    wrapperNode = doc.createElement(o.tagName);
                    o.className && (wrapperNode.className = o.className);
                    patternNode = textNode.splitText(match.index);
                    patternNode.splitText(match[0].length);
                    wrapperNode.appendChild(patternNode.cloneNode(true));
                    textNode.parentNode.replaceChild(wrapperNode, patternNode);
                }
                return !!match;
            }
            function traverse(el, hightlightTextNode) {
                var childNode, TEXT_NODE_TYPE = 3;
                for (var i = 0; i < el.childNodes.length; i++) {
                    childNode = el.childNodes[i];
                    if (childNode.nodeType === TEXT_NODE_TYPE) {
                        i += hightlightTextNode(childNode) ? 1 : 0;
                    } else {
                        traverse(childNode, hightlightTextNode);
                    }
                }
            }
        };
        function getRegex(patterns, caseSensitive, wordsOnly) {
            var escapedPatterns = [], regexStr;
            for (var i = 0, len = patterns.length; i < len; i++) {
                escapedPatterns.push(_.escapeRegExChars(patterns[i]));
            }
            regexStr = wordsOnly ? "\\b(" + escapedPatterns.join("|") + ")\\b" : "(" + escapedPatterns.join("|") + ")";
            return caseSensitive ? new RegExp(regexStr) : new RegExp(regexStr, "i");
        }
    }(window.document);
    var Input = function() {
        "use strict";
        var specialKeyCodeMap;
        specialKeyCodeMap = {
            9: "tab",
            27: "esc",
            37: "left",
            39: "right",
            13: "enter",
            38: "up",
            40: "down"
        };
        function Input(o, www) {
            o = o || {};
            if (!o.input) {
                $.error("input is missing");
            }
            www.mixin(this);
            this.$hint = $(o.hint);
            this.$input = $(o.input);
            this.query = this.$input.val();
            this.queryWhenFocused = this.hasFocus() ? this.query : null;
            this.$overflowHelper = buildOverflowHelper(this.$input);
            this._checkLanguageDirection();
            if (this.$hint.length === 0) {
                this.setHint = this.getHint = this.clearHint = this.clearHintIfInvalid = _.noop;
            }
        }
        Input.normalizeQuery = function(str) {
            return _.toStr(str).replace(/^\s*/g, "").replace(/\s{2,}/g, " ");
        };
        _.mixin(Input.prototype, EventEmitter, {
            _onBlur: function onBlur() {
                this.resetInputValue();
                this.trigger("blurred");
            },
            _onFocus: function onFocus() {
                this.queryWhenFocused = this.query;
                this.trigger("focused");
            },
            _onKeydown: function onKeydown($e) {
                var keyName = specialKeyCodeMap[$e.which || $e.keyCode];
                this._managePreventDefault(keyName, $e);
                if (keyName && this._shouldTrigger(keyName, $e)) {
                    this.trigger(keyName + "Keyed", $e);
                }
            },
            _onInput: function onInput() {
                this._setQuery(this.getInputValue());
                this.clearHintIfInvalid();
                this._checkLanguageDirection();
            },
            _managePreventDefault: function managePreventDefault(keyName, $e) {
                var preventDefault;
                switch (keyName) {
                  case "up":
                  case "down":
                    preventDefault = !withModifier($e);
                    break;

                  default:
                    preventDefault = false;
                }
                preventDefault && $e.preventDefault();
            },
            _shouldTrigger: function shouldTrigger(keyName, $e) {
                var trigger;
                switch (keyName) {
                  case "tab":
                    trigger = !withModifier($e);
                    break;

                  default:
                    trigger = true;
                }
                return trigger;
            },
            _checkLanguageDirection: function checkLanguageDirection() {
                var dir = (this.$input.css("direction") || "ltr").toLowerCase();
                if (this.dir !== dir) {
                    this.dir = dir;
                    this.$hint.attr("dir", dir);
                    this.trigger("langDirChanged", dir);
                }
            },
            _setQuery: function setQuery(val, silent) {
                var areEquivalent, hasDifferentWhitespace;
                areEquivalent = areQueriesEquivalent(val, this.query);
                hasDifferentWhitespace = areEquivalent ? this.query.length !== val.length : false;
                this.query = val;
                if (!silent && !areEquivalent) {
                    this.trigger("queryChanged", this.query);
                } else if (!silent && hasDifferentWhitespace) {
                    this.trigger("whitespaceChanged", this.query);
                }
            },
            bind: function() {
                var that = this, onBlur, onFocus, onKeydown, onInput;
                onBlur = _.bind(this._onBlur, this);
                onFocus = _.bind(this._onFocus, this);
                onKeydown = _.bind(this._onKeydown, this);
                onInput = _.bind(this._onInput, this);
                this.$input.on("blur.tt", onBlur).on("focus.tt", onFocus).on("keydown.tt", onKeydown);
                if (!_.isMsie() || _.isMsie() > 9) {
                    this.$input.on("input.tt", onInput);
                } else {
                    this.$input.on("keydown.tt keypress.tt cut.tt paste.tt", function($e) {
                        if (specialKeyCodeMap[$e.which || $e.keyCode]) {
                            return;
                        }
                        _.defer(_.bind(that._onInput, that, $e));
                    });
                }
                return this;
            },
            focus: function focus() {
                this.$input.focus();
            },
            blur: function blur() {
                this.$input.blur();
            },
            getLangDir: function getLangDir() {
                return this.dir;
            },
            getQuery: function getQuery() {
                return this.query || "";
            },
            setQuery: function setQuery(val, silent) {
                this.setInputValue(val);
                this._setQuery(val, silent);
            },
            hasQueryChangedSinceLastFocus: function hasQueryChangedSinceLastFocus() {
                return this.query !== this.queryWhenFocused;
            },
            getInputValue: function getInputValue() {
                return this.$input.val();
            },
            setInputValue: function setInputValue(value) {
                this.$input.val(value);
                this.clearHintIfInvalid();
                this._checkLanguageDirection();
            },
            resetInputValue: function resetInputValue() {
                this.setInputValue(this.query);
            },
            getHint: function getHint() {
                return this.$hint.val();
            },
            setHint: function setHint(value) {
                this.$hint.val(value);
            },
            clearHint: function clearHint() {
                this.setHint("");
            },
            clearHintIfInvalid: function clearHintIfInvalid() {
                var val, hint, valIsPrefixOfHint, isValid;
                val = this.getInputValue();
                hint = this.getHint();
                valIsPrefixOfHint = val !== hint && hint.indexOf(val) === 0;
                isValid = val !== "" && valIsPrefixOfHint && !this.hasOverflow();
                !isValid && this.clearHint();
            },
            hasFocus: function hasFocus() {
                return this.$input.is(":focus");
            },
            hasOverflow: function hasOverflow() {
                var constraint = this.$input.width() - 2;
                this.$overflowHelper.text(this.getInputValue());
                return this.$overflowHelper.width() >= constraint;
            },
            isCursorAtEnd: function() {
                var valueLength, selectionStart, range;
                valueLength = this.$input.val().length;
                selectionStart = this.$input[0].selectionStart;
                if (_.isNumber(selectionStart)) {
                    return selectionStart === valueLength;
                } else if (document.selection) {
                    range = document.selection.createRange();
                    range.moveStart("character", -valueLength);
                    return valueLength === range.text.length;
                }
                return true;
            },
            destroy: function destroy() {
                this.$hint.off(".tt");
                this.$input.off(".tt");
                this.$overflowHelper.remove();
                this.$hint = this.$input = this.$overflowHelper = $("<div>");
            }
        });
        return Input;
        function buildOverflowHelper($input) {
            return $('<pre aria-hidden="true"></pre>').css({
                position: "absolute",
                visibility: "hidden",
                whiteSpace: "pre",
                fontFamily: $input.css("font-family"),
                fontSize: $input.css("font-size"),
                fontStyle: $input.css("font-style"),
                fontVariant: $input.css("font-variant"),
                fontWeight: $input.css("font-weight"),
                wordSpacing: $input.css("word-spacing"),
                letterSpacing: $input.css("letter-spacing"),
                textIndent: $input.css("text-indent"),
                textRendering: $input.css("text-rendering"),
                textTransform: $input.css("text-transform")
            }).insertAfter($input);
        }
        function areQueriesEquivalent(a, b) {
            return Input.normalizeQuery(a) === Input.normalizeQuery(b);
        }
        function withModifier($e) {
            return $e.altKey || $e.ctrlKey || $e.metaKey || $e.shiftKey;
        }
    }();
    var Dataset = function() {
        "use strict";
        var keys, nameGenerator;
        keys = {
            val: "tt-selectable-display",
            obj: "tt-selectable-object"
        };
        nameGenerator = _.getIdGenerator();
        function Dataset(o, www) {
            o = o || {};
            o.templates = o.templates || {};
            o.templates.notFound = o.templates.notFound || o.templates.empty;
            if (!o.source) {
                $.error("missing source");
            }
            if (!o.node) {
                $.error("missing node");
            }
            if (o.name && !isValidName(o.name)) {
                $.error("invalid dataset name: " + o.name);
            }
            www.mixin(this);
            this.highlight = !!o.highlight;
            this.name = o.name || nameGenerator();
            this.limit = o.limit || 5;
            this.displayFn = getDisplayFn(o.display || o.displayKey);
            this.templates = getTemplates(o.templates, this.displayFn);
            this.source = o.source.__ttAdapter ? o.source.__ttAdapter() : o.source;
            this.async = _.isUndefined(o.async) ? this.source.length > 2 : !!o.async;
            this._resetLastSuggestion();
            this.$el = $(o.node).addClass(this.classes.dataset).addClass(this.classes.dataset + "-" + this.name);
        }
        Dataset.extractData = function extractData(el) {
            var $el = $(el);
            if ($el.data(keys.obj)) {
                return {
                    val: $el.data(keys.val) || "",
                    obj: $el.data(keys.obj) || null
                };
            }
            return null;
        };
        _.mixin(Dataset.prototype, EventEmitter, {
            _overwrite: function overwrite(query, suggestions) {
                suggestions = suggestions || [];
                if (suggestions.length) {
                    this._renderSuggestions(query, suggestions);
                } else if (this.async && this.templates.pending) {
                    this._renderPending(query);
                } else if (!this.async && this.templates.notFound) {
                    this._renderNotFound(query);
                } else {
                    this._empty();
                }
                this.trigger("rendered", this.name, suggestions, false);
            },
            _append: function append(query, suggestions) {
                suggestions = suggestions || [];
                if (suggestions.length && this.$lastSuggestion.length) {
                    this._appendSuggestions(query, suggestions);
                } else if (suggestions.length) {
                    this._renderSuggestions(query, suggestions);
                } else if (!this.$lastSuggestion.length && this.templates.notFound) {
                    this._renderNotFound(query);
                }
                this.trigger("rendered", this.name, suggestions, true);
            },
            _renderSuggestions: function renderSuggestions(query, suggestions) {
                var $fragment;
                $fragment = this._getSuggestionsFragment(query, suggestions);
                this.$lastSuggestion = $fragment.children().last();
                this.$el.html($fragment).prepend(this._getHeader(query, suggestions)).append(this._getFooter(query, suggestions));
            },
            _appendSuggestions: function appendSuggestions(query, suggestions) {
                var $fragment, $lastSuggestion;
                $fragment = this._getSuggestionsFragment(query, suggestions);
                $lastSuggestion = $fragment.children().last();
                this.$lastSuggestion.after($fragment);
                this.$lastSuggestion = $lastSuggestion;
            },
            _renderPending: function renderPending(query) {
                var template = this.templates.pending;
                this._resetLastSuggestion();
                template && this.$el.html(template({
                    query: query,
                    dataset: this.name
                }));
            },
            _renderNotFound: function renderNotFound(query) {
                var template = this.templates.notFound;
                this._resetLastSuggestion();
                template && this.$el.html(template({
                    query: query,
                    dataset: this.name
                }));
            },
            _empty: function empty() {
                this.$el.empty();
                this._resetLastSuggestion();
            },
            _getSuggestionsFragment: function getSuggestionsFragment(query, suggestions) {
                var that = this, fragment;
                fragment = document.createDocumentFragment();
                _.each(suggestions, function getSuggestionNode(suggestion) {
                    var $el, context;
                    context = that._injectQuery(query, suggestion);
                    $el = $(that.templates.suggestion(context)).data(keys.obj, suggestion).data(keys.val, that.displayFn(suggestion)).addClass(that.classes.suggestion + " " + that.classes.selectable);
                    $el.each(function(i,itm){
                        fragment.appendChild(itm)
                    });
                   // fragment.appendChild($el[0]);
                });
                this.highlight && highlight({
                    className: this.classes.highlight,
                    node: fragment,
                    pattern: query
                });
                return $(fragment);
            },
            _getFooter: function getFooter(query, suggestions) {
                return this.templates.footer ? this.templates.footer({
                    query: query,
                    suggestions: suggestions,
                    dataset: this.name
                }) : null;
            },
            _getHeader: function getHeader(query, suggestions) {
                return this.templates.header ? this.templates.header({
                    query: query,
                    suggestions: suggestions,
                    dataset: this.name
                }) : null;
            },
            _resetLastSuggestion: function resetLastSuggestion() {
                this.$lastSuggestion = $();
            },
            _injectQuery: function injectQuery(query, obj) {
                return _.isObject(obj) ? _.mixin({
                    _query: query
                }, obj) : obj;
            },
            update: function update(query) {
                var that = this, canceled = false, syncCalled = false, rendered = 0;
                this.cancel();
                this.cancel = function cancel() {
                    canceled = true;
                    that.cancel = $.noop;
                    that.async && that.trigger("asyncCanceled", query);
                };
                this.source(query, sync, async);
                !syncCalled && sync([]);
                function sync(suggestions) {
                    if (syncCalled) {
                        return;
                    }
                    syncCalled = true;
                    suggestions = (suggestions || []).slice(0, that.limit);
                    rendered = suggestions.length;
                    that._overwrite(query, suggestions);
                    if (rendered < that.limit && that.async) {
                        that.trigger("asyncRequested", query);
                    }
                }
                function async(suggestions) {
                    suggestions = suggestions || [];
                    if (!canceled && rendered < that.limit) {
                        that.cancel = $.noop;
                        rendered += suggestions.length;
                        that._append(query, suggestions.slice(0, that.limit - rendered));
                        that.async && that.trigger("asyncReceived", query);
                    }
                }
            },
            cancel: $.noop,
            clear: function clear() {
                this._empty();
                this.cancel();
                this.trigger("cleared");
            },
            isEmpty: function isEmpty() {
                return this.$el.is(":empty");
            },
            destroy: function destroy() {
                this.$el = $("<div>");
            }
        });
        return Dataset;
        function getDisplayFn(display) {
            display = display || _.stringify;
            return _.isFunction(display) ? display : displayFn;
            function displayFn(obj) {
                return obj[display];
            }
        }
        function getTemplates(templates, displayFn) {
            return {
                notFound: templates.notFound && _.templatify(templates.notFound),
                pending: templates.pending && _.templatify(templates.pending),
                header: templates.header && _.templatify(templates.header),
                footer: templates.footer && _.templatify(templates.footer),
                suggestion: templates.suggestion || suggestionTemplate
            };
            function suggestionTemplate(context) {
                return $("<div>").text(displayFn(context));
            }
        }
        function isValidName(str) {
            return /^[_a-zA-Z0-9-]+$/.test(str);
        }
    }();
    var Menu = function() {
        "use strict";
        function Menu(o, www) {
            var that = this;
            o = o || {};
            if (!o.node) {
                $.error("node is required");
            }
            www.mixin(this);
            this.$node = $(o.node);
            this.query = null;
            this.datasets = _.map(o.datasets, initializeDataset);
            function initializeDataset(oDataset) {
                var node = that.$node.find(oDataset.node).first();
                oDataset.node = node.length ? node : $("<div>").appendTo(that.$node);
                return new Dataset(oDataset, www);
            }
        }
        _.mixin(Menu.prototype, EventEmitter, {
            _onSelectableClick: function onSelectableClick($e) {
                this.trigger("selectableClicked", $($e.currentTarget));
            },
            _onRendered: function onRendered(type, dataset, suggestions, async) {
                this.$node.toggleClass(this.classes.empty, this._allDatasetsEmpty());
                this.trigger("datasetRendered", dataset, suggestions, async);
            },
            _onCleared: function onCleared() {
                this.$node.toggleClass(this.classes.empty, this._allDatasetsEmpty());
                this.trigger("datasetCleared");
            },
            _propagate: function propagate() {
                this.trigger.apply(this, arguments);
            },
            _allDatasetsEmpty: function allDatasetsEmpty() {
                return _.every(this.datasets, isDatasetEmpty);
                function isDatasetEmpty(dataset) {
                    return dataset.isEmpty();
                }
            },
            _getSelectables: function getSelectables() {
                return this.$node.find(this.selectors.selectable);
            },
            _removeCursor: function _removeCursor() {
                var $selectable = this.getActiveSelectable();
                $selectable && $selectable.removeClass(this.classes.cursor);
            },
            _ensureVisible: function ensureVisible($el) {
                var elTop, elBottom, nodeScrollTop, nodeHeight;
                elTop = $el.position().top;
                elBottom = elTop + $el.outerHeight(true);
                nodeScrollTop = this.$node.scrollTop();
                nodeHeight = this.$node.height() + parseInt(this.$node.css("paddingTop"), 10) + parseInt(this.$node.css("paddingBottom"), 10);
                if (elTop < 0) {
                    this.$node.scrollTop(nodeScrollTop + elTop);
                } else if (nodeHeight < elBottom) {
                    this.$node.scrollTop(nodeScrollTop + (elBottom - nodeHeight));
                }
            },
            bind: function() {
                var that = this, onSelectableClick;
                onSelectableClick = _.bind(this._onSelectableClick, this);
                this.$node.on("click.tt", this.selectors.selectable, onSelectableClick);
                _.each(this.datasets, function(dataset) {
                    dataset.onSync("asyncRequested", that._propagate, that).onSync("asyncCanceled", that._propagate, that).onSync("asyncReceived", that._propagate, that).onSync("rendered", that._onRendered, that).onSync("cleared", that._onCleared, that);
                });
                return this;
            },
            isOpen: function isOpen() {
                return this.$node.hasClass(this.classes.open);
            },
            open: function open() {
                this.$node.addClass(this.classes.open);
            },
            close: function close() {
                this.$node.removeClass(this.classes.open);
                this._removeCursor();
            },
            setLanguageDirection: function setLanguageDirection(dir) {
                this.$node.attr("dir", dir);
            },
            selectableRelativeToCursor: function selectableRelativeToCursor(delta) {
                var $selectables, $oldCursor, oldIndex, newIndex;
                $oldCursor = this.getActiveSelectable();
                $selectables = this._getSelectables();
                oldIndex = $oldCursor ? $selectables.index($oldCursor) : -1;
                newIndex = oldIndex + delta;
                newIndex = (newIndex + 1) % ($selectables.length + 1) - 1;
                newIndex = newIndex < -1 ? $selectables.length - 1 : newIndex;
                return newIndex === -1 ? null : $selectables.eq(newIndex);
            },
            setCursor: function setCursor($selectable) {
                this._removeCursor();
                if ($selectable = $selectable && $selectable.first()) {
                    $selectable.addClass(this.classes.cursor);
                    this._ensureVisible($selectable);
                }
            },
            getSelectableData: function getSelectableData($el) {
                return $el && $el.length ? Dataset.extractData($el) : null;
            },
            getActiveSelectable: function getActiveSelectable() {
                var $selectable = this._getSelectables().filter(this.selectors.cursor).first();
                return $selectable.length ? $selectable : null;
            },
            getTopSelectable: function getTopSelectable() {
                var $selectable = this._getSelectables().first();
                return $selectable.length ? $selectable : null;
            },
            update: function update(query) {
                var isValidUpdate = query !== this.query;
                if (isValidUpdate) {
                    this.query = query;
                    _.each(this.datasets, updateDataset);
                }
                return isValidUpdate;
                function updateDataset(dataset) {
                    dataset.update(query);
                }
            },
            empty: function empty() {
                _.each(this.datasets, clearDataset);
                this.query = null;
                this.$node.addClass(this.classes.empty);
                function clearDataset(dataset) {
                    dataset.clear();
                }
            },
            destroy: function destroy() {
                this.$node.off(".tt");
                this.$node = $("<div>");
                _.each(this.datasets, destroyDataset);
                function destroyDataset(dataset) {
                    dataset.destroy();
                }
            }
        });
        return Menu;
    }();
    var DefaultMenu = function() {
        "use strict";
        var s = Menu.prototype;
        function DefaultMenu() {
            Menu.apply(this, [].slice.call(arguments, 0));
        }
        _.mixin(DefaultMenu.prototype, Menu.prototype, {
            open: function open() {
                !this._allDatasetsEmpty() && this._show();
                return s.open.apply(this, [].slice.call(arguments, 0));
            },
            close: function close() {
                this._hide();
                return s.close.apply(this, [].slice.call(arguments, 0));
            },
            _onRendered: function onRendered() {
                if (this._allDatasetsEmpty()) {
                    this._hide();
                } else {
                    this.isOpen() && this._show();
                }
                return s._onRendered.apply(this, [].slice.call(arguments, 0));
            },
            _onCleared: function onCleared() {
                if (this._allDatasetsEmpty()) {
                    this._hide();
                } else {
                    this.isOpen() && this._show();
                }
                return s._onCleared.apply(this, [].slice.call(arguments, 0));
            },
            setLanguageDirection: function setLanguageDirection(dir) {
                this.$node.css(dir === "ltr" ? this.css.ltr : this.css.rtl);
                return s.setLanguageDirection.apply(this, [].slice.call(arguments, 0));
            },
            _hide: function hide() {
                this.$node.hide();
            },
            _show: function show() {
                this.$node.css("display", "block");
            }
        });
        return DefaultMenu;
    }();
    var Typeahead = function() {
        "use strict";
        function Typeahead(o, www) {
            var onFocused, onBlurred, onEnterKeyed, onTabKeyed, onEscKeyed, onUpKeyed, onDownKeyed, onLeftKeyed, onRightKeyed, onQueryChanged, onWhitespaceChanged;
            o = o || {};
            if (!o.input) {
                $.error("missing input");
            }
            if (!o.menu) {
                $.error("missing menu");
            }
            if (!o.eventBus) {
                $.error("missing event bus");
            }
            www.mixin(this);
            this.eventBus = o.eventBus;
            this.minLength = _.isNumber(o.minLength) ? o.minLength : 1;
            this.input = o.input;
            this.menu = o.menu;
            this.enabled = true;
            this.active = false;
            this.input.hasFocus() && this.activate();
            this.dir = this.input.getLangDir();
            this._hacks();
            this.menu.bind().onSync("selectableClicked", this._onSelectableClicked, this).onSync("asyncRequested", this._onAsyncRequested, this).onSync("asyncCanceled", this._onAsyncCanceled, this).onSync("asyncReceived", this._onAsyncReceived, this).onSync("datasetRendered", this._onDatasetRendered, this).onSync("datasetCleared", this._onDatasetCleared, this);
            onFocused = c(this, "activate", "open", "_onFocused");
            onBlurred = c(this, "deactivate", "_onBlurred");
            onEnterKeyed = c(this, "isActive", "isOpen", "_onEnterKeyed");
            onTabKeyed = c(this, "isActive", "isOpen", "_onTabKeyed");
            onEscKeyed = c(this, "isActive", "_onEscKeyed");
            onUpKeyed = c(this, "isActive", "open", "_onUpKeyed");
            onDownKeyed = c(this, "isActive", "open", "_onDownKeyed");
            onLeftKeyed = c(this, "isActive", "isOpen", "_onLeftKeyed");
            onRightKeyed = c(this, "isActive", "isOpen", "_onRightKeyed");
            onQueryChanged = c(this, "_openIfActive", "_onQueryChanged");
            onWhitespaceChanged = c(this, "_openIfActive", "_onWhitespaceChanged");
            this.input.bind().onSync("focused", onFocused, this).onSync("blurred", onBlurred, this).onSync("enterKeyed", onEnterKeyed, this).onSync("tabKeyed", onTabKeyed, this).onSync("escKeyed", onEscKeyed, this).onSync("upKeyed", onUpKeyed, this).onSync("downKeyed", onDownKeyed, this).onSync("leftKeyed", onLeftKeyed, this).onSync("rightKeyed", onRightKeyed, this).onSync("queryChanged", onQueryChanged, this).onSync("whitespaceChanged", onWhitespaceChanged, this).onSync("langDirChanged", this._onLangDirChanged, this);
        }
        _.mixin(Typeahead.prototype, {
            _hacks: function hacks() {
                var $input, $menu;
                $input = this.input.$input || $("<div>");
                $menu = this.menu.$node || $("<div>");
                $input.on("blur.tt", function($e) {
                    var active, isActive, hasActive;
                    active = document.activeElement;
                    isActive = $menu.is(active);
                    hasActive = $menu.has(active).length > 0;
                    if (_.isMsie() && (isActive || hasActive)) {
                        $e.preventDefault();
                        $e.stopImmediatePropagation();
                        _.defer(function() {
                            $input.focus();
                        });
                    }
                });
                $menu.on("mousedown.tt", function($e) {
                    $e.preventDefault();
                });
            },
            _onSelectableClicked: function onSelectableClicked(type, $el) {
                this.select($el);
            },
            _onDatasetCleared: function onDatasetCleared() {
                this._updateHint();
            },
            _onDatasetRendered: function onDatasetRendered(type, dataset, suggestions, async) {
                this._updateHint();
                this.eventBus.trigger("render", suggestions, async, dataset);
            },
            _onAsyncRequested: function onAsyncRequested(type, dataset, query) {
                this.eventBus.trigger("asyncrequest", query, dataset);
            },
            _onAsyncCanceled: function onAsyncCanceled(type, dataset, query) {
                this.eventBus.trigger("asynccancel", query, dataset);
            },
            _onAsyncReceived: function onAsyncReceived(type, dataset, query) {
                this.eventBus.trigger("asyncreceive", query, dataset);
            },
            _onFocused: function onFocused() {
                this._minLengthMet() && this.menu.update(this.input.getQuery());
            },
            _onBlurred: function onBlurred() {
                if (this.input.hasQueryChangedSinceLastFocus()) {
                    this.eventBus.trigger("change", this.input.getQuery());
                }
            },
            _onEnterKeyed: function onEnterKeyed(type, $e) {
                var $selectable;
                if ($selectable = this.menu.getActiveSelectable()) {
                    this.select($selectable) && $e.preventDefault();
                }
            },
            _onTabKeyed: function onTabKeyed(type, $e) {
                var $selectable;
                if ($selectable = this.menu.getActiveSelectable()) {
                    this.select($selectable) && $e.preventDefault();
                } else if ($selectable = this.menu.getTopSelectable()) {
                    this.autocomplete($selectable) && $e.preventDefault();
                }
            },
            _onEscKeyed: function onEscKeyed() {
                this.close();
            },
            _onUpKeyed: function onUpKeyed() {
                this.moveCursor(-1);
            },
            _onDownKeyed: function onDownKeyed() {
                this.moveCursor(+1);
            },
            _onLeftKeyed: function onLeftKeyed() {
                if (this.dir === "rtl" && this.input.isCursorAtEnd()) {
                    this.autocomplete(this.menu.getTopSelectable());
                }
            },
            _onRightKeyed: function onRightKeyed() {
                if (this.dir === "ltr" && this.input.isCursorAtEnd()) {
                    this.autocomplete(this.menu.getTopSelectable());
                }
            },
            _onQueryChanged: function onQueryChanged(e, query) {
                this._minLengthMet(query) ? this.menu.update(query) : this.menu.empty();
            },
            _onWhitespaceChanged: function onWhitespaceChanged() {
                this._updateHint();
            },
            _onLangDirChanged: function onLangDirChanged(e, dir) {
                if (this.dir !== dir) {
                    this.dir = dir;
                    this.menu.setLanguageDirection(dir);
                }
            },
            _openIfActive: function openIfActive() {
                this.isActive() && this.open();
            },
            _minLengthMet: function minLengthMet(query) {
                query = _.isString(query) ? query : this.input.getQuery() || "";
                return query.length >= this.minLength;
            },
            _updateHint: function updateHint() {
                var $selectable, data, val, query, escapedQuery, frontMatchRegEx, match;
                $selectable = this.menu.getTopSelectable();
                data = this.menu.getSelectableData($selectable);
                val = this.input.getInputValue();
                if (data && !_.isBlankString(val) && !this.input.hasOverflow()) {
                    query = Input.normalizeQuery(val);
                    escapedQuery = _.escapeRegExChars(query);
                    frontMatchRegEx = new RegExp("^(?:" + escapedQuery + ")(.+$)", "i");
                    match = frontMatchRegEx.exec(data.val);
                    match && this.input.setHint(val + match[1]);
                } else {
                    this.input.clearHint();
                }
            },
            isEnabled: function isEnabled() {
                return this.enabled;
            },
            enable: function enable() {
                this.enabled = true;
            },
            disable: function disable() {
                this.enabled = false;
            },
            isActive: function isActive() {
                return this.active;
            },
            activate: function activate() {
                if (this.isActive()) {
                    return true;
                } else if (!this.isEnabled() || this.eventBus.before("active")) {
                    return false;
                } else {
                    this.active = true;
                    this.eventBus.trigger("active");
                    return true;
                }
            },
            deactivate: function deactivate() {
                if (!this.isActive()) {
                    return true;
                } else if (this.eventBus.before("idle")) {
                    return false;
                } else {
                    this.active = false;
                    this.close();
                    this.eventBus.trigger("idle");
                    return true;
                }
            },
            isOpen: function isOpen() {
                return this.menu.isOpen();
            },
            open: function open() {
                if (!this.isOpen() && !this.eventBus.before("open")) {
                    this.menu.open();
                    this._updateHint();
                    this.eventBus.trigger("open");
                }
                return this.isOpen();
            },
            close: function close() {
                if (this.isOpen() && !this.eventBus.before("close")) {
                    this.menu.close();
                    this.input.clearHint();
                    this.input.resetInputValue();
                    this.eventBus.trigger("close");
                }
                return !this.isOpen();
            },
            setVal: function setVal(val) {
                this.input.setQuery(_.toStr(val));
            },
            getVal: function getVal() {
                return this.input.getQuery();
            },
            select: function select($selectable) {
                var data = this.menu.getSelectableData($selectable);
                if (data && !this.eventBus.before("select", data.obj)) {
                    this.input.setQuery(data.val, true);
                    this.eventBus.trigger("select", data.obj);
                    this.close();
                    return true;
                }
                return false;
            },
            autocomplete: function autocomplete($selectable) {
                var query, data, isValid;
                query = this.input.getQuery();
                data = this.menu.getSelectableData($selectable);
                isValid = data && query !== data.val;
                if (isValid && !this.eventBus.before("autocomplete", data.obj)) {
                    this.input.setQuery(data.val);
                    this.eventBus.trigger("autocomplete", data.obj);
                    return true;
                }
                return false;
            },
            moveCursor: function moveCursor(delta) {
                var query, $candidate, data, payload, cancelMove;
                query = this.input.getQuery();
                $candidate = this.menu.selectableRelativeToCursor(delta);
                data = this.menu.getSelectableData($candidate);
                payload = data ? data.obj : null;
                cancelMove = this._minLengthMet() && this.menu.update(query);
                if (!cancelMove && !this.eventBus.before("cursorchange", payload)) {
                    this.menu.setCursor($candidate);
                    if (data) {
                        this.input.setInputValue(data.val);
                    } else {
                        this.input.resetInputValue();
                        this._updateHint();
                    }
                    this.eventBus.trigger("cursorchange", payload);
                    return true;
                }
                return false;
            },
            destroy: function destroy() {
                this.input.destroy();
                this.menu.destroy();
            }
        });
        return Typeahead;
        function c(ctx) {
            var methods = [].slice.call(arguments, 1);
            return function() {
                var args = [].slice.call(arguments);
                _.each(methods, function(method) {
                    return ctx[method].apply(ctx, args);
                });
            };
        }
    }();
    (function() {
        "use strict";
        var old, keys, methods;
        old = $.fn.typeahead;
        keys = {
            www: "tt-www",
            attrs: "tt-attrs",
            typeahead: "tt-typeahead"
        };
        methods = {
            initialize: function initialize(o, datasets) {
                var www;
                datasets = _.isArray(datasets) ? datasets : [].slice.call(arguments, 1);
                o = o || {};
                www = WWW(o.classNames);
                return this.each(attach);
                function attach() {
                    var $input, $wrapper, $hint, $menu, defaultHint, defaultMenu, eventBus, input, menu, typeahead, MenuConstructor;
                    _.each(datasets, function(d) {
                        d.highlight = !!o.highlight;
                    });
                    $input = $(this);
                    $wrapper = $(www.html.wrapper);
                    $hint = $elOrNull(o.hint);
                    $menu = $elOrNull(o.menu);
                    defaultHint = o.hint !== false && !$hint;
                    defaultMenu = o.menu !== false && !$menu;
                    defaultHint && ($hint = buildHintFromInput($input, www));
                    defaultMenu && ($menu = $(www.html.menu).css(www.css.menu));
                    $hint && $hint.val("");
                    $input = prepInput($input, www);
                    if (defaultHint || defaultMenu) {
                        $wrapper.css(www.css.wrapper);
                        $input.css(defaultHint ? www.css.input : www.css.inputWithNoHint);
                        $input.wrap($wrapper).parent().prepend(defaultHint ? $hint : null).append(defaultMenu ? $menu : null);
                    }
                    MenuConstructor = defaultMenu ? DefaultMenu : Menu;
                    eventBus = new EventBus({
                        el: $input
                    });
                    input = new Input({
                        hint: $hint,
                        input: $input
                    }, www);
                    menu = new MenuConstructor({
                        node: $menu,
                        datasets: datasets
                    }, www);
                    typeahead = new Typeahead({
                        input: input,
                        menu: menu,
                        eventBus: eventBus,
                        minLength: o.minLength
                    }, www);
                    $input.data(keys.www, www);
                    $input.data(keys.typeahead, typeahead);
                }
            },
            isEnabled: function isEnabled() {
                var enabled;
                ttEach(this.first(), function(t) {
                    enabled = t.isEnabled();
                });
                return enabled;
            },
            enable: function enable() {
                ttEach(this, function(t) {
                    t.enable();
                });
                return this;
            },
            disable: function disable() {
                ttEach(this, function(t) {
                    t.disable();
                });
                return this;
            },
            isActive: function isActive() {
                var active;
                ttEach(this.first(), function(t) {
                    active = t.isActive();
                });
                return active;
            },
            activate: function activate() {
                ttEach(this, function(t) {
                    t.activate();
                });
                return this;
            },
            deactivate: function deactivate() {
                ttEach(this, function(t) {
                    t.deactivate();
                });
                return this;
            },
            isOpen: function isOpen() {
                var open;
                ttEach(this.first(), function(t) {
                    open = t.isOpen();
                });
                return open;
            },
            open: function open() {
                ttEach(this, function(t) {
                    t.open();
                });
                return this;
            },
            close: function close() {
                ttEach(this, function(t) {
                    t.close();
                });
                return this;
            },
            select: function select(el) {
                var success = false, $el = $(el);
                ttEach(this.first(), function(t) {
                    success = t.select($el);
                });
                return success;
            },
            autocomplete: function autocomplete(el) {
                var success = false, $el = $(el);
                ttEach(this.first(), function(t) {
                    success = t.autocomplete($el);
                });
                return success;
            },
            moveCursor: function moveCursoe(delta) {
                var success = false;
                ttEach(this.first(), function(t) {
                    success = t.moveCursor(delta);
                });
                return success;
            },
            val: function val(newVal) {
                var query;
                if (!arguments.length) {
                    ttEach(this.first(), function(t) {
                        query = t.getVal();
                    });
                    return query;
                } else {
                    ttEach(this, function(t) {
                        t.setVal(newVal);
                    });
                    return this;
                }
            },
            destroy: function destroy() {
                ttEach(this, function(typeahead, $input) {
                    revert($input);
                    typeahead.destroy();
                });
                return this;
            }
        };
        $.fn.typeahead = function(method) {
            if (methods[method]) {
                return methods[method].apply(this, [].slice.call(arguments, 1));
            } else {
                return methods.initialize.apply(this, arguments);
            }
        };
        $.fn.typeahead.noConflict = function noConflict() {
            $.fn.typeahead = old;
            return this;
        };
        function ttEach($els, fn) {
            $els.each(function() {
                var $input = $(this), typeahead;
                (typeahead = $input.data(keys.typeahead)) && fn(typeahead, $input);
            });
        }
        function buildHintFromInput($input, www) {
            return $input.clone().addClass(www.classes.hint).removeData().css(www.css.hint).css(getBackgroundStyles($input)).prop("readonly", true).removeAttr("id name placeholder required").attr({
                autocomplete: "off",
                spellcheck: "false",
                tabindex: -1
            });
        }
        function prepInput($input, www) {
            $input.data(keys.attrs, {
                dir: $input.attr("dir"),
                autocomplete: $input.attr("autocomplete"),
                spellcheck: $input.attr("spellcheck"),
                style: $input.attr("style")
            });
            $input.addClass(www.classes.input).attr({
                autocomplete: "off",
                spellcheck: false
            });
            try {
                !$input.attr("dir") && $input.attr("dir", "auto");
            } catch (e) {}
            return $input;
        }
        function getBackgroundStyles($el) {
            return {
                backgroundAttachment: $el.css("background-attachment"),
                backgroundClip: $el.css("background-clip"),
                backgroundColor: $el.css("background-color"),
                backgroundImage: $el.css("background-image"),
                backgroundOrigin: $el.css("background-origin"),
                backgroundPosition: $el.css("background-position"),
                backgroundRepeat: $el.css("background-repeat"),
                backgroundSize: $el.css("background-size")
            };
        }
        function revert($input) {
            var www, $wrapper;
            www = $input.data(keys.www);
            $wrapper = $input.parent().filter(www.selectors.wrapper);
            _.each($input.data(keys.attrs), function(val, key) {
                _.isUndefined(val) ? $input.removeAttr(key) : $input.attr(key, val);
            });
            $input.removeData(keys.typeahead).removeData(keys.www).removeData(keys.attr).removeClass(www.classes.input);
            if ($wrapper.length) {
                $input.detach().insertAfter($wrapper);
                $wrapper.remove();
            }
        }
        function $elOrNull(obj) {
            var isValid, $el;
            isValid = _.isJQuery(obj) || _.isElement(obj);
            $el = isValid ? $(obj).first() : [];
            return $el.length ? $el : null;
        }
    })();
});
/*!
 * imagesLoaded PACKAGED v4.1.0
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */

/**
 * EvEmitter v1.0.1
 * Lil' event emitter
 * MIT License
 */

/* jshint unused: true, undef: true, strict: true */

( function( global, factory ) {
  // universal module definition
  /* jshint strict: false */ /* globals define, module */
  if ( typeof define == 'function' && define.amd ) {
    // AMD - RequireJS
    define( 'ev-emitter/ev-emitter',factory );
  } else if ( typeof module == 'object' && module.exports ) {
    // CommonJS - Browserify, Webpack
    module.exports = factory();
  } else {
    // Browser globals
    global.EvEmitter = factory();
  }

}( this, function() {



function EvEmitter() {}

var proto = EvEmitter.prototype;

proto.on = function( eventName, listener ) {
  if ( !eventName || !listener ) {
    return;
  }
  // set events hash
  var events = this._events = this._events || {};
  // set listeners array
  var listeners = events[ eventName ] = events[ eventName ] || [];
  // only add once
  if ( listeners.indexOf( listener ) == -1 ) {
    listeners.push( listener );
  }

  return this;
};

proto.once = function( eventName, listener ) {
  if ( !eventName || !listener ) {
    return;
  }
  // add event
  this.on( eventName, listener );
  // set once flag
  // set onceEvents hash
  var onceEvents = this._onceEvents = this._onceEvents || {};
  // set onceListeners array
  var onceListeners = onceEvents[ eventName ] = onceEvents[ eventName ] || [];
  // set flag
  onceListeners[ listener ] = true;

  return this;
};

proto.off = function( eventName, listener ) {
  var listeners = this._events && this._events[ eventName ];
  if ( !listeners || !listeners.length ) {
    return;
  }
  var index = listeners.indexOf( listener );
  if ( index != -1 ) {
    listeners.splice( index, 1 );
  }

  return this;
};

proto.emitEvent = function( eventName, args ) {
  var listeners = this._events && this._events[ eventName ];
  if ( !listeners || !listeners.length ) {
    return;
  }
  var i = 0;
  var listener = listeners[i];
  args = args || [];
  // once stuff
  var onceListeners = this._onceEvents && this._onceEvents[ eventName ];

  while ( listener ) {
    var isOnce = onceListeners && onceListeners[ listener ];
    if ( isOnce ) {
      // remove listener
      // remove before trigger to prevent recursion
      this.off( eventName, listener );
      // unset once flag
      delete onceListeners[ listener ];
    }
    // trigger listener
    listener.apply( this, args );
    // get next listener
    i += isOnce ? 0 : 1;
    listener = listeners[i];
  }

  return this;
};

return EvEmitter;

}));

/*!
 * imagesLoaded v4.1.0
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */

( function( window, factory ) { 'use strict';
  // universal module definition

  /*global define: false, module: false, require: false */

  if ( typeof define == 'function' && define.amd ) {
    // AMD
    define( [
      'ev-emitter/ev-emitter'
    ], function( EvEmitter ) {
      return factory( window, EvEmitter );
    });
  } else if ( typeof module == 'object' && module.exports ) {
    // CommonJS
    module.exports = factory(
      window,
      require('ev-emitter')
    );
  } else {
    // browser global
    window.imagesLoaded = factory(
      window,
      window.EvEmitter
    );
  }

})( window,

// --------------------------  factory -------------------------- //

function factory( window, EvEmitter ) {



var $ = window.jQuery;
var console = window.console;

// -------------------------- helpers -------------------------- //

// extend objects
function extend( a, b ) {
  for ( var prop in b ) {
    a[ prop ] = b[ prop ];
  }
  return a;
}

// turn element or nodeList into an array
function makeArray( obj ) {
  var ary = [];
  if ( Array.isArray( obj ) ) {
    // use object if already an array
    ary = obj;
  } else if ( typeof obj.length == 'number' ) {
    // convert nodeList to array
    for ( var i=0; i < obj.length; i++ ) {
      ary.push( obj[i] );
    }
  } else {
    // array of single index
    ary.push( obj );
  }
  return ary;
}

// -------------------------- imagesLoaded -------------------------- //

/**
 * @param {Array, Element, NodeList, String} elem
 * @param {Object or Function} options - if function, use as callback
 * @param {Function} onAlways - callback function
 */
function ImagesLoaded( elem, options, onAlways ) {
  // coerce ImagesLoaded() without new, to be new ImagesLoaded()
  if ( !( this instanceof ImagesLoaded ) ) {
    return new ImagesLoaded( elem, options, onAlways );
  }
  // use elem as selector string
  if ( typeof elem == 'string' ) {
    elem = document.querySelectorAll( elem );
  }

  this.elements = makeArray( elem );
  this.options = extend( {}, this.options );

  if ( typeof options == 'function' ) {
    onAlways = options;
  } else {
    extend( this.options, options );
  }

  if ( onAlways ) {
    this.on( 'always', onAlways );
  }

  this.getImages();

  if ( $ ) {
    // add jQuery Deferred object
    this.jqDeferred = new $.Deferred();
  }

  // HACK check async to allow time to bind listeners
  setTimeout( function() {
    this.check();
  }.bind( this ));
}

ImagesLoaded.prototype = Object.create( EvEmitter.prototype );

ImagesLoaded.prototype.options = {};

ImagesLoaded.prototype.getImages = function() {
  this.images = [];

  // filter & find items if we have an item selector
  this.elements.forEach( this.addElementImages, this );
};

/**
 * @param {Node} element
 */
ImagesLoaded.prototype.addElementImages = function( elem ) {
  // filter siblings
  if ( elem.nodeName == 'IMG' ) {
    this.addImage( elem );
  }
  // get background image on element
  if ( this.options.background === true ) {
    this.addElementBackgroundImages( elem );
  }

  // find children
  // no non-element nodes, #143
  var nodeType = elem.nodeType;
  if ( !nodeType || !elementNodeTypes[ nodeType ] ) {
    return;
  }
  var childImgs = elem.querySelectorAll('img');
  // concat childElems to filterFound array
  for ( var i=0; i < childImgs.length; i++ ) {
    var img = childImgs[i];
    this.addImage( img );
  }

  // get child background images
  if ( typeof this.options.background == 'string' ) {
    var children = elem.querySelectorAll( this.options.background );
    for ( i=0; i < children.length; i++ ) {
      var child = children[i];
      this.addElementBackgroundImages( child );
    }
  }
};

var elementNodeTypes = {
  1: true,
  9: true,
  11: true
};

ImagesLoaded.prototype.addElementBackgroundImages = function( elem ) {
  var style = getComputedStyle( elem );
  if ( !style ) {
    // Firefox returns null if in a hidden iframe https://bugzil.la/548397
    return;
  }
  // get url inside url("...")
  var reURL = /url\((['"])?(.*?)\1\)/gi;
  var matches = reURL.exec( style.backgroundImage );
  while ( matches !== null ) {
    var url = matches && matches[2];
    if ( url ) {
      this.addBackground( url, elem );
    }
    matches = reURL.exec( style.backgroundImage );
  }
};

/**
 * @param {Image} img
 */
ImagesLoaded.prototype.addImage = function( img ) {
  var loadingImage = new LoadingImage( img );
  this.images.push( loadingImage );
};

ImagesLoaded.prototype.addBackground = function( url, elem ) {
  var background = new Background( url, elem );
  this.images.push( background );
};

ImagesLoaded.prototype.check = function() {
  var _this = this;
  this.progressedCount = 0;
  this.hasAnyBroken = false;
  // complete if no images
  if ( !this.images.length ) {
    this.complete();
    return;
  }

  function onProgress( image, elem, message ) {
    // HACK - Chrome triggers event before object properties have changed. #83
    setTimeout( function() {
      _this.progress( image, elem, message );
    });
  }

  this.images.forEach( function( loadingImage ) {
    loadingImage.once( 'progress', onProgress );
    loadingImage.check();
  });
};

ImagesLoaded.prototype.progress = function( image, elem, message ) {
  this.progressedCount++;
  this.hasAnyBroken = this.hasAnyBroken || !image.isLoaded;
  // progress event
  this.emitEvent( 'progress', [ this, image, elem ] );
  if ( this.jqDeferred && this.jqDeferred.notify ) {
    this.jqDeferred.notify( this, image );
  }
  // check if completed
  if ( this.progressedCount == this.images.length ) {
    this.complete();
  }

  if ( this.options.debug && console ) {
    console.log( 'progress: ' + message, image, elem );
  }
};

ImagesLoaded.prototype.complete = function() {
  var eventName = this.hasAnyBroken ? 'fail' : 'done';
  this.isComplete = true;
  this.emitEvent( eventName, [ this ] );
  this.emitEvent( 'always', [ this ] );
  if ( this.jqDeferred ) {
    var jqMethod = this.hasAnyBroken ? 'reject' : 'resolve';
    this.jqDeferred[ jqMethod ]( this );
  }
};

// --------------------------  -------------------------- //

function LoadingImage( img ) {
  this.img = img;
}

LoadingImage.prototype = Object.create( EvEmitter.prototype );

LoadingImage.prototype.check = function() {
  // If complete is true and browser supports natural sizes,
  // try to check for image status manually.
  var isComplete = this.getIsImageComplete();
  if ( isComplete ) {
    // report based on naturalWidth
    this.confirm( this.img.naturalWidth !== 0, 'naturalWidth' );
    return;
  }

  // If none of the checks above matched, simulate loading on detached element.
  this.proxyImage = new Image();
  this.proxyImage.addEventListener( 'load', this );
  this.proxyImage.addEventListener( 'error', this );
  // bind to image as well for Firefox. #191
  this.img.addEventListener( 'load', this );
  this.img.addEventListener( 'error', this );
  this.proxyImage.src = this.img.src;
};

LoadingImage.prototype.getIsImageComplete = function() {
  return this.img.complete && this.img.naturalWidth !== undefined;
};

LoadingImage.prototype.confirm = function( isLoaded, message ) {
  this.isLoaded = isLoaded;
  this.emitEvent( 'progress', [ this, this.img, message ] );
};

// ----- events ----- //

// trigger specified handler for event type
LoadingImage.prototype.handleEvent = function( event ) {
  var method = 'on' + event.type;
  if ( this[ method ] ) {
    this[ method ]( event );
  }
};

LoadingImage.prototype.onload = function() {
  this.confirm( true, 'onload' );
  this.unbindEvents();
};

LoadingImage.prototype.onerror = function() {
  this.confirm( false, 'onerror' );
  this.unbindEvents();
};

LoadingImage.prototype.unbindEvents = function() {
  this.proxyImage.removeEventListener( 'load', this );
  this.proxyImage.removeEventListener( 'error', this );
  this.img.removeEventListener( 'load', this );
  this.img.removeEventListener( 'error', this );
};

// -------------------------- Background -------------------------- //

function Background( url, element ) {
  this.url = url;
  this.element = element;
  this.img = new Image();
}

// inherit LoadingImage prototype
Background.prototype = Object.create( LoadingImage.prototype );

Background.prototype.check = function() {
  this.img.addEventListener( 'load', this );
  this.img.addEventListener( 'error', this );
  this.img.src = this.url;
  // check if image is already complete
  var isComplete = this.getIsImageComplete();
  if ( isComplete ) {
    this.confirm( this.img.naturalWidth !== 0, 'naturalWidth' );
    this.unbindEvents();
  }
};

Background.prototype.unbindEvents = function() {
  this.img.removeEventListener( 'load', this );
  this.img.removeEventListener( 'error', this );
};

Background.prototype.confirm = function( isLoaded, message ) {
  this.isLoaded = isLoaded;
  this.emitEvent( 'progress', [ this, this.element, message ] );
};

// -------------------------- jQuery -------------------------- //

ImagesLoaded.makeJQueryPlugin = function( jQuery ) {
  jQuery = jQuery || window.jQuery;
  if ( !jQuery ) {
    return;
  }
  // set local variable
  $ = jQuery;
  // $().imagesLoaded()
  $.fn.imagesLoaded = function( options, callback ) {
    var instance = new ImagesLoaded( this, options, callback );
    return instance.jqDeferred.promise( $(this) );
  };
};
// try making plugin
ImagesLoaded.makeJQueryPlugin();

// --------------------------  -------------------------- //

return ImagesLoaded;

});

/*! VelocityJS.org (1.2.3). (C) 2014 Julian Shapiro. MIT @license: en.wikipedia.org/wiki/MIT_License */

/*************************
   Velocity jQuery Shim
*************************/

/*! VelocityJS.org jQuery Shim (1.0.1). (C) 2014 The jQuery Foundation. MIT @license: en.wikipedia.org/wiki/MIT_License. */

/* This file contains the jQuery functions that Velocity relies on, thereby removing Velocity's dependency on a full copy of jQuery, and allowing it to work in any environment. */
/* These shimmed functions are only used if jQuery isn't present. If both this shim and jQuery are loaded, Velocity defaults to jQuery proper. */
/* Browser support: Using this shim instead of jQuery proper removes support for IE8. */

;(function (window) {
    /***************
         Setup
    ***************/

    /* If jQuery is already loaded, there's no point in loading this shim. */
    if (window.jQuery) {
        return;
    }

    /* jQuery base. */
    var $ = function (selector, context) {
        return new $.fn.init(selector, context);
    };

    /********************
       Private Methods
    ********************/

    /* jQuery */
    $.isWindow = function (obj) {
        /* jshint eqeqeq: false */
        return obj != null && obj == obj.window;
    };

    /* jQuery */
    $.type = function (obj) {
        if (obj == null) {
            return obj + "";
        }

        return typeof obj === "object" || typeof obj === "function" ?
            class2type[toString.call(obj)] || "object" :
            typeof obj;
    };

    /* jQuery */
    $.isArray = Array.isArray || function (obj) {
        return $.type(obj) === "array";
    };

    /* jQuery */
    function isArraylike (obj) {
        var length = obj.length,
            type = $.type(obj);

        if (type === "function" || $.isWindow(obj)) {
            return false;
        }

        if (obj.nodeType === 1 && length) {
            return true;
        }

        return type === "array" || length === 0 || typeof length === "number" && length > 0 && (length - 1) in obj;
    }

    /***************
       $ Methods
    ***************/

    /* jQuery: Support removed for IE<9. */
    $.isPlainObject = function (obj) {
        var key;

        if (!obj || $.type(obj) !== "object" || obj.nodeType || $.isWindow(obj)) {
            return false;
        }

        try {
            if (obj.constructor &&
                !hasOwn.call(obj, "constructor") &&
                !hasOwn.call(obj.constructor.prototype, "isPrototypeOf")) {
                return false;
            }
        } catch (e) {
            return false;
        }

        for (key in obj) {}

        return key === undefined || hasOwn.call(obj, key);
    };

    /* jQuery */
    $.each = function(obj, callback, args) {
        var value,
            i = 0,
            length = obj.length,
            isArray = isArraylike(obj);

        if (args) {
            if (isArray) {
                for (; i < length; i++) {
                    value = callback.apply(obj[i], args);

                    if (value === false) {
                        break;
                    }
                }
            } else {
                for (i in obj) {
                    value = callback.apply(obj[i], args);

                    if (value === false) {
                        break;
                    }
                }
            }

        } else {
            if (isArray) {
                for (; i < length; i++) {
                    value = callback.call(obj[i], i, obj[i]);

                    if (value === false) {
                        break;
                    }
                }
            } else {
                for (i in obj) {
                    value = callback.call(obj[i], i, obj[i]);

                    if (value === false) {
                        break;
                    }
                }
            }
        }

        return obj;
    };

    /* Custom */
    $.data = function (node, key, value) {
        /* $.getData() */
        if (value === undefined) {
            var id = node[$.expando],
                store = id && cache[id];

            if (key === undefined) {
                return store;
            } else if (store) {
                if (key in store) {
                    return store[key];
                }
            }
        /* $.setData() */
        } else if (key !== undefined) {
            var id = node[$.expando] || (node[$.expando] = ++$.uuid);

            cache[id] = cache[id] || {};
            cache[id][key] = value;

            return value;
        }
    };

    /* Custom */
    $.removeData = function (node, keys) {
        var id = node[$.expando],
            store = id && cache[id];

        if (store) {
            $.each(keys, function(_, key) {
                delete store[key];
            });
        }
    };

    /* jQuery */
    $.extend = function () {
        var src, copyIsArray, copy, name, options, clone,
            target = arguments[0] || {},
            i = 1,
            length = arguments.length,
            deep = false;

        if (typeof target === "boolean") {
            deep = target;

            target = arguments[i] || {};
            i++;
        }

        if (typeof target !== "object" && $.type(target) !== "function") {
            target = {};
        }

        if (i === length) {
            target = this;
            i--;
        }

        for (; i < length; i++) {
            if ((options = arguments[i]) != null) {
                for (name in options) {
                    src = target[name];
                    copy = options[name];

                    if (target === copy) {
                        continue;
                    }

                    if (deep && copy && ($.isPlainObject(copy) || (copyIsArray = $.isArray(copy)))) {
                        if (copyIsArray) {
                            copyIsArray = false;
                            clone = src && $.isArray(src) ? src : [];

                        } else {
                            clone = src && $.isPlainObject(src) ? src : {};
                        }

                        target[name] = $.extend(deep, clone, copy);

                    } else if (copy !== undefined) {
                        target[name] = copy;
                    }
                }
            }
        }

        return target;
    };

    /* jQuery 1.4.3 */
    $.queue = function (elem, type, data) {
        function $makeArray (arr, results) {
            var ret = results || [];

            if (arr != null) {
                if (isArraylike(Object(arr))) {
                    /* $.merge */
                    (function(first, second) {
                        var len = +second.length,
                            j = 0,
                            i = first.length;

                        while (j < len) {
                            first[i++] = second[j++];
                        }

                        if (len !== len) {
                            while (second[j] !== undefined) {
                                first[i++] = second[j++];
                            }
                        }

                        first.length = i;

                        return first;
                    })(ret, typeof arr === "string" ? [arr] : arr);
                } else {
                    [].push.call(ret, arr);
                }
            }

            return ret;
        }

        if (!elem) {
            return;
        }

        type = (type || "fx") + "queue";

        var q = $.data(elem, type);

        if (!data) {
            return q || [];
        }

        if (!q || $.isArray(data)) {
            q = $.data(elem, type, $makeArray(data));
        } else {
            q.push(data);
        }

        return q;
    };

    /* jQuery 1.4.3 */
    $.dequeue = function (elems, type) {
        /* Custom: Embed element iteration. */
        $.each(elems.nodeType ? [ elems ] : elems, function(i, elem) {
            type = type || "fx";

            var queue = $.queue(elem, type),
                fn = queue.shift();

            if (fn === "inprogress") {
                fn = queue.shift();
            }

            if (fn) {
                if (type === "fx") {
                    queue.unshift("inprogress");
                }

                fn.call(elem, function() {
                    $.dequeue(elem, type);
                });
            }
        });
    };

    /******************
       $.fn Methods
    ******************/

    /* jQuery */
    $.fn = $.prototype = {
        init: function (selector) {
            /* Just return the element wrapped inside an array; don't proceed with the actual jQuery node wrapping process. */
            if (selector.nodeType) {
                this[0] = selector;

                return this;
            } else {
                throw new Error("Not a DOM node.");
            }
        },

        offset: function () {
            /* jQuery altered code: Dropped disconnected DOM node checking. */
            var box = this[0].getBoundingClientRect ? this[0].getBoundingClientRect() : { top: 0, left: 0 };

            return {
                top: box.top + (window.pageYOffset || document.scrollTop  || 0)  - (document.clientTop  || 0),
                left: box.left + (window.pageXOffset || document.scrollLeft  || 0) - (document.clientLeft || 0)
            };
        },

        position: function () {
            /* jQuery */
            function offsetParent() {
                var offsetParent = this.offsetParent || document;

                while (offsetParent && (!offsetParent.nodeType.toLowerCase === "html" && offsetParent.style.position === "static")) {
                    offsetParent = offsetParent.offsetParent;
                }

                return offsetParent || document;
            }

            /* Zepto */
            var elem = this[0],
                offsetParent = offsetParent.apply(elem),
                offset = this.offset(),
                parentOffset = /^(?:body|html)$/i.test(offsetParent.nodeName) ? { top: 0, left: 0 } : $(offsetParent).offset()

            offset.top -= parseFloat(elem.style.marginTop) || 0;
            offset.left -= parseFloat(elem.style.marginLeft) || 0;

            if (offsetParent.style) {
                parentOffset.top += parseFloat(offsetParent.style.borderTopWidth) || 0
                parentOffset.left += parseFloat(offsetParent.style.borderLeftWidth) || 0
            }

            return {
                top: offset.top - parentOffset.top,
                left: offset.left - parentOffset.left
            };
        }
    };

    /**********************
       Private Variables
    **********************/

    /* For $.data() */
    var cache = {};
    $.expando = "velocity" + (new Date().getTime());
    $.uuid = 0;

    /* For $.queue() */
    var class2type = {},
        hasOwn = class2type.hasOwnProperty,
        toString = class2type.toString;

    var types = "Boolean Number String Function Array Date RegExp Object Error".split(" ");
    for (var i = 0; i < types.length; i++) {
        class2type["[object " + types[i] + "]"] = types[i].toLowerCase();
    }

    /* Makes $(node) possible, without having to call init. */
    $.fn.init.prototype = $.fn;

    /* Globalize Velocity onto the window, and assign its Utilities property. */
    window.Velocity = { Utilities: $ };
})(window);

/******************
    Velocity.js
******************/

;(function (factory) {
    /* CommonJS module. */
    if (typeof module === "object" && typeof module.exports === "object") {
        module.exports = factory();
    /* AMD module. */
    } else if (typeof define === "function" && define.amd) {
        define(factory);
    /* Browser globals. */
    } else {
        factory();
    }
}(function() {
return function (global, window, document, undefined) {

    /***************
        Summary
    ***************/

    /*
    - CSS: CSS stack that works independently from the rest of Velocity.
    - animate(): Core animation method that iterates over the targeted elements and queues the incoming call onto each element individually.
      - Pre-Queueing: Prepare the element for animation by instantiating its data cache and processing the call's options.
      - Queueing: The logic that runs once the call has reached its point of execution in the element's $.queue() stack.
                  Most logic is placed here to avoid risking it becoming stale (if the element's properties have changed).
      - Pushing: Consolidation of the tween data followed by its push onto the global in-progress calls container.
    - tick(): The single requestAnimationFrame loop responsible for tweening all in-progress calls.
    - completeCall(): Handles the cleanup process for each Velocity call.
    */

    /*********************
       Helper Functions
    *********************/

    /* IE detection. Gist: https://gist.github.com/julianshapiro/9098609 */
    var IE = (function() {
        if (document.documentMode) {
            return document.documentMode;
        } else {
            for (var i = 7; i > 4; i--) {
                var div = document.createElement("div");

                div.innerHTML = "<!--[if IE " + i + "]><span></span><![endif]-->";

                if (div.getElementsByTagName("span").length) {
                    div = null;

                    return i;
                }
            }
        }

        return undefined;
    })();

    /* rAF shim. Gist: https://gist.github.com/julianshapiro/9497513 */
    var rAFShim = (function() {
        var timeLast = 0;

        return window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function(callback) {
            var timeCurrent = (new Date()).getTime(),
                timeDelta;

            /* Dynamically set delay on a per-tick basis to match 60fps. */
            /* Technique by Erik Moller. MIT license: https://gist.github.com/paulirish/1579671 */
            timeDelta = Math.max(0, 16 - (timeCurrent - timeLast));
            timeLast = timeCurrent + timeDelta;

            return setTimeout(function() { callback(timeCurrent + timeDelta); }, timeDelta);
        };
    })();

    /* Array compacting. Copyright Lo-Dash. MIT License: https://github.com/lodash/lodash/blob/master/LICENSE.txt */
    function compactSparseArray (array) {
        var index = -1,
            length = array ? array.length : 0,
            result = [];

        while (++index < length) {
            var value = array[index];

            if (value) {
                result.push(value);
            }
        }

        return result;
    }

    function sanitizeElements (elements) {
        /* Unwrap jQuery/Zepto objects. */
        if (Type.isWrapped(elements)) {
            elements = [].slice.call(elements);
        /* Wrap a single element in an array so that $.each() can iterate with the element instead of its node's children. */
        } else if (Type.isNode(elements)) {
            elements = [ elements ];
        }

        return elements;
    }

    var Type = {
        isString: function (variable) {
            return (typeof variable === "string");
        },
        isArray: Array.isArray || function (variable) {
            return Object.prototype.toString.call(variable) === "[object Array]";
        },
        isFunction: function (variable) {
            return Object.prototype.toString.call(variable) === "[object Function]";
        },
        isNode: function (variable) {
            return variable && variable.nodeType;
        },
        /* Copyright Martin Bohm. MIT License: https://gist.github.com/Tomalak/818a78a226a0738eaade */
        isNodeList: function (variable) {
            return typeof variable === "object" &&
                /^\[object (HTMLCollection|NodeList|Object)\]$/.test(Object.prototype.toString.call(variable)) &&
                variable.length !== undefined &&
                (variable.length === 0 || (typeof variable[0] === "object" && variable[0].nodeType > 0));
        },
        /* Determine if variable is a wrapped jQuery or Zepto element. */
        isWrapped: function (variable) {
            return variable && (variable.jquery || (window.Zepto && window.Zepto.zepto.isZ(variable)));
        },
        isSVG: function (variable) {
            return window.SVGElement && (variable instanceof window.SVGElement);
        },
        isEmptyObject: function (variable) {
            for (var name in variable) {
                return false;
            }

            return true;
        }
    };

    /*****************
       Dependencies
    *****************/

    var $,
        isJQuery = false;

    if (global.fn && global.fn.jquery) {
        $ = global;
        isJQuery = true;
    } else {
        $ = window.Velocity.Utilities;
    }

    if (IE <= 8 && !isJQuery) {
        throw new Error("Velocity: IE8 and below require jQuery to be loaded before Velocity.");
    } else if (IE <= 7) {
        /* Revert to jQuery's $.animate(), and lose Velocity's extra features. */
        jQuery.fn.velocity = jQuery.fn.animate;

        /* Now that $.fn.velocity is aliased, abort this Velocity declaration. */
        return;
    }

    /*****************
        Constants
    *****************/

    var DURATION_DEFAULT = 400,
        EASING_DEFAULT = "swing";

    /*************
        State
    *************/

    var Velocity = {
        /* Container for page-wide Velocity state data. */
        State: {
            /* Detect mobile devices to determine if mobileHA should be turned on. */
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            /* The mobileHA option's behavior changes on older Android devices (Gingerbread, versions 2.3.3-2.3.7). */
            isAndroid: /Android/i.test(navigator.userAgent),
            isGingerbread: /Android 2\.3\.[3-7]/i.test(navigator.userAgent),
            isChrome: window.chrome,
            isFirefox: /Firefox/i.test(navigator.userAgent),
            /* Create a cached element for re-use when checking for CSS property prefixes. */
            prefixElement: document.createElement("div"),
            /* Cache every prefix match to avoid repeating lookups. */
            prefixMatches: {},
            /* Cache the anchor used for animating window scrolling. */
            scrollAnchor: null,
            /* Cache the browser-specific property names associated with the scroll anchor. */
            scrollPropertyLeft: null,
            scrollPropertyTop: null,
            /* Keep track of whether our RAF tick is running. */
            isTicking: false,
            /* Container for every in-progress call to Velocity. */
            calls: []
        },
        /* Velocity's custom CSS stack. Made global for unit testing. */
        CSS: { /* Defined below. */ },
        /* A shim of the jQuery utility functions used by Velocity -- provided by Velocity's optional jQuery shim. */
        Utilities: $,
        /* Container for the user's custom animation redirects that are referenced by name in place of the properties map argument. */
        Redirects: { /* Manually registered by the user. */ },
        Easings: { /* Defined below. */ },
        /* Attempt to use ES6 Promises by default. Users can override this with a third-party promises library. */
        Promise: window.Promise,
        /* Velocity option defaults, which can be overriden by the user. */
        defaults: {
            queue: "",
            duration: DURATION_DEFAULT,
            easing: EASING_DEFAULT,
            begin: undefined,
            complete: undefined,
            progress: undefined,
            display: undefined,
            visibility: undefined,
            loop: false,
            delay: false,
            mobileHA: true,
            /* Advanced: Set to false to prevent property values from being cached between consecutive Velocity-initiated chain calls. */
            _cacheValues: true
        },
        /* A design goal of Velocity is to cache data wherever possible in order to avoid DOM requerying. Accordingly, each element has a data cache. */
        init: function (element) {
            $.data(element, "velocity", {
                /* Store whether this is an SVG element, since its properties are retrieved and updated differently than standard HTML elements. */
                isSVG: Type.isSVG(element),
                /* Keep track of whether the element is currently being animated by Velocity.
                   This is used to ensure that property values are not transferred between non-consecutive (stale) calls. */
                isAnimating: false,
                /* A reference to the element's live computedStyle object. Learn more here: https://developer.mozilla.org/en/docs/Web/API/window.getComputedStyle */
                computedStyle: null,
                /* Tween data is cached for each animation on the element so that data can be passed across calls --
                   in particular, end values are used as subsequent start values in consecutive Velocity calls. */
                tweensContainer: null,
                /* The full root property values of each CSS hook being animated on this element are cached so that:
                   1) Concurrently-animating hooks sharing the same root can have their root values' merged into one while tweening.
                   2) Post-hook-injection root values can be transferred over to consecutively chained Velocity calls as starting root values. */
                rootPropertyValueCache: {},
                /* A cache for transform updates, which must be manually flushed via CSS.flushTransformCache(). */
                transformCache: {}
            });
        },
        /* A parallel to jQuery's $.css(), used for getting/setting Velocity's hooked CSS properties. */
        hook: null, /* Defined below. */
        /* Velocity-wide animation time remapping for testing purposes. */
        mock: false,
        version: { major: 1, minor: 2, patch: 2 },
        /* Set to 1 or 2 (most verbose) to output debug info to console. */
        debug: false
    };

    /* Retrieve the appropriate scroll anchor and property name for the browser: https://developer.mozilla.org/en-US/docs/Web/API/Window.scrollY */
    if (window.pageYOffset !== undefined) {
        Velocity.State.scrollAnchor = window;
        Velocity.State.scrollPropertyLeft = "pageXOffset";
        Velocity.State.scrollPropertyTop = "pageYOffset";
    } else {
        Velocity.State.scrollAnchor = document.documentElement || document.body.parentNode || document.body;
        Velocity.State.scrollPropertyLeft = "scrollLeft";
        Velocity.State.scrollPropertyTop = "scrollTop";
    }

    /* Shorthand alias for jQuery's $.data() utility. */
    function Data (element) {
        /* Hardcode a reference to the plugin name. */
        var response = $.data(element, "velocity");

        /* jQuery <=1.4.2 returns null instead of undefined when no match is found. We normalize this behavior. */
        return response === null ? undefined : response;
    };

    /**************
        Easing
    **************/

    /* Step easing generator. */
    function generateStep (steps) {
        return function (p) {
            return Math.round(p * steps) * (1 / steps);
        };
    }

    /* Bezier curve function generator. Copyright Gaetan Renaudeau. MIT License: http://en.wikipedia.org/wiki/MIT_License */
    function generateBezier (mX1, mY1, mX2, mY2) {
        var NEWTON_ITERATIONS = 4,
            NEWTON_MIN_SLOPE = 0.001,
            SUBDIVISION_PRECISION = 0.0000001,
            SUBDIVISION_MAX_ITERATIONS = 10,
            kSplineTableSize = 11,
            kSampleStepSize = 1.0 / (kSplineTableSize - 1.0),
            float32ArraySupported = "Float32Array" in window;

        /* Must contain four arguments. */
        if (arguments.length !== 4) {
            return false;
        }

        /* Arguments must be numbers. */
        for (var i = 0; i < 4; ++i) {
            if (typeof arguments[i] !== "number" || isNaN(arguments[i]) || !isFinite(arguments[i])) {
                return false;
            }
        }

        /* X values must be in the [0, 1] range. */
        mX1 = Math.min(mX1, 1);
        mX2 = Math.min(mX2, 1);
        mX1 = Math.max(mX1, 0);
        mX2 = Math.max(mX2, 0);

        var mSampleValues = float32ArraySupported ? new Float32Array(kSplineTableSize) : new Array(kSplineTableSize);

        function A (aA1, aA2) { return 1.0 - 3.0 * aA2 + 3.0 * aA1; }
        function B (aA1, aA2) { return 3.0 * aA2 - 6.0 * aA1; }
        function C (aA1)      { return 3.0 * aA1; }

        function calcBezier (aT, aA1, aA2) {
            return ((A(aA1, aA2)*aT + B(aA1, aA2))*aT + C(aA1))*aT;
        }

        function getSlope (aT, aA1, aA2) {
            return 3.0 * A(aA1, aA2)*aT*aT + 2.0 * B(aA1, aA2) * aT + C(aA1);
        }

        function newtonRaphsonIterate (aX, aGuessT) {
            for (var i = 0; i < NEWTON_ITERATIONS; ++i) {
                var currentSlope = getSlope(aGuessT, mX1, mX2);

                if (currentSlope === 0.0) return aGuessT;

                var currentX = calcBezier(aGuessT, mX1, mX2) - aX;
                aGuessT -= currentX / currentSlope;
            }

            return aGuessT;
        }

        function calcSampleValues () {
            for (var i = 0; i < kSplineTableSize; ++i) {
                mSampleValues[i] = calcBezier(i * kSampleStepSize, mX1, mX2);
            }
        }

        function binarySubdivide (aX, aA, aB) {
            var currentX, currentT, i = 0;

            do {
                currentT = aA + (aB - aA) / 2.0;
                currentX = calcBezier(currentT, mX1, mX2) - aX;
                if (currentX > 0.0) {
                  aB = currentT;
                } else {
                  aA = currentT;
                }
            } while (Math.abs(currentX) > SUBDIVISION_PRECISION && ++i < SUBDIVISION_MAX_ITERATIONS);

            return currentT;
        }

        function getTForX (aX) {
            var intervalStart = 0.0,
                currentSample = 1,
                lastSample = kSplineTableSize - 1;

            for (; currentSample != lastSample && mSampleValues[currentSample] <= aX; ++currentSample) {
                intervalStart += kSampleStepSize;
            }

            --currentSample;

            var dist = (aX - mSampleValues[currentSample]) / (mSampleValues[currentSample+1] - mSampleValues[currentSample]),
                guessForT = intervalStart + dist * kSampleStepSize,
                initialSlope = getSlope(guessForT, mX1, mX2);

            if (initialSlope >= NEWTON_MIN_SLOPE) {
                return newtonRaphsonIterate(aX, guessForT);
            } else if (initialSlope == 0.0) {
                return guessForT;
            } else {
                return binarySubdivide(aX, intervalStart, intervalStart + kSampleStepSize);
            }
        }

        var _precomputed = false;

        function precompute() {
            _precomputed = true;
            if (mX1 != mY1 || mX2 != mY2) calcSampleValues();
        }

        var f = function (aX) {
            if (!_precomputed) precompute();
            if (mX1 === mY1 && mX2 === mY2) return aX;
            if (aX === 0) return 0;
            if (aX === 1) return 1;

            return calcBezier(getTForX(aX), mY1, mY2);
        };

        f.getControlPoints = function() { return [{ x: mX1, y: mY1 }, { x: mX2, y: mY2 }]; };

        var str = "generateBezier(" + [mX1, mY1, mX2, mY2] + ")";
        f.toString = function () { return str; };

        return f;
    }

    /* Runge-Kutta spring physics function generator. Adapted from Framer.js, copyright Koen Bok. MIT License: http://en.wikipedia.org/wiki/MIT_License */
    /* Given a tension, friction, and duration, a simulation at 60FPS will first run without a defined duration in order to calculate the full path. A second pass
       then adjusts the time delta -- using the relation between actual time and duration -- to calculate the path for the duration-constrained animation. */
    var generateSpringRK4 = (function () {
        function springAccelerationForState (state) {
            return (-state.tension * state.x) - (state.friction * state.v);
        }

        function springEvaluateStateWithDerivative (initialState, dt, derivative) {
            var state = {
                x: initialState.x + derivative.dx * dt,
                v: initialState.v + derivative.dv * dt,
                tension: initialState.tension,
                friction: initialState.friction
            };

            return { dx: state.v, dv: springAccelerationForState(state) };
        }

        function springIntegrateState (state, dt) {
            var a = {
                    dx: state.v,
                    dv: springAccelerationForState(state)
                },
                b = springEvaluateStateWithDerivative(state, dt * 0.5, a),
                c = springEvaluateStateWithDerivative(state, dt * 0.5, b),
                d = springEvaluateStateWithDerivative(state, dt, c),
                dxdt = 1.0 / 6.0 * (a.dx + 2.0 * (b.dx + c.dx) + d.dx),
                dvdt = 1.0 / 6.0 * (a.dv + 2.0 * (b.dv + c.dv) + d.dv);

            state.x = state.x + dxdt * dt;
            state.v = state.v + dvdt * dt;

            return state;
        }

        return function springRK4Factory (tension, friction, duration) {

            var initState = {
                    x: -1,
                    v: 0,
                    tension: null,
                    friction: null
                },
                path = [0],
                time_lapsed = 0,
                tolerance = 1 / 10000,
                DT = 16 / 1000,
                have_duration, dt, last_state;

            tension = parseFloat(tension) || 500;
            friction = parseFloat(friction) || 20;
            duration = duration || null;

            initState.tension = tension;
            initState.friction = friction;

            have_duration = duration !== null;

            /* Calculate the actual time it takes for this animation to complete with the provided conditions. */
            if (have_duration) {
                /* Run the simulation without a duration. */
                time_lapsed = springRK4Factory(tension, friction);
                /* Compute the adjusted time delta. */
                dt = time_lapsed / duration * DT;
            } else {
                dt = DT;
            }

            while (true) {
                /* Next/step function .*/
                last_state = springIntegrateState(last_state || initState, dt);
                /* Store the position. */
                path.push(1 + last_state.x);
                time_lapsed += 16;
                /* If the change threshold is reached, break. */
                if (!(Math.abs(last_state.x) > tolerance && Math.abs(last_state.v) > tolerance)) {
                    break;
                }
            }

            /* If duration is not defined, return the actual time required for completing this animation. Otherwise, return a closure that holds the
               computed path and returns a snapshot of the position according to a given percentComplete. */
            return !have_duration ? time_lapsed : function(percentComplete) { return path[ (percentComplete * (path.length - 1)) | 0 ]; };
        };
    }());

    /* jQuery easings. */
    Velocity.Easings = {
        linear: function(p) { return p; },
        swing: function(p) { return 0.5 - Math.cos( p * Math.PI ) / 2 },
        /* Bonus "spring" easing, which is a less exaggerated version of easeInOutElastic. */
        spring: function(p) { return 1 - (Math.cos(p * 4.5 * Math.PI) * Math.exp(-p * 6)); }
    };

    /* CSS3 and Robert Penner easings. */
    $.each(
        [
            [ "ease", [ 0.25, 0.1, 0.25, 1.0 ] ],
            [ "ease-in", [ 0.42, 0.0, 1.00, 1.0 ] ],
            [ "ease-out", [ 0.00, 0.0, 0.58, 1.0 ] ],
            [ "ease-in-out", [ 0.42, 0.0, 0.58, 1.0 ] ],
            [ "easeInSine", [ 0.47, 0, 0.745, 0.715 ] ],
            [ "easeOutSine", [ 0.39, 0.575, 0.565, 1 ] ],
            [ "easeInOutSine", [ 0.445, 0.05, 0.55, 0.95 ] ],
            [ "easeInQuad", [ 0.55, 0.085, 0.68, 0.53 ] ],
            [ "easeOutQuad", [ 0.25, 0.46, 0.45, 0.94 ] ],
            [ "easeInOutQuad", [ 0.455, 0.03, 0.515, 0.955 ] ],
            [ "easeInCubic", [ 0.55, 0.055, 0.675, 0.19 ] ],
            [ "easeOutCubic", [ 0.215, 0.61, 0.355, 1 ] ],
            [ "easeInOutCubic", [ 0.645, 0.045, 0.355, 1 ] ],
            [ "easeInQuart", [ 0.895, 0.03, 0.685, 0.22 ] ],
            [ "easeOutQuart", [ 0.165, 0.84, 0.44, 1 ] ],
            [ "easeInOutQuart", [ 0.77, 0, 0.175, 1 ] ],
            [ "easeInQuint", [ 0.755, 0.05, 0.855, 0.06 ] ],
            [ "easeOutQuint", [ 0.23, 1, 0.32, 1 ] ],
            [ "easeInOutQuint", [ 0.86, 0, 0.07, 1 ] ],
            [ "easeInExpo", [ 0.95, 0.05, 0.795, 0.035 ] ],
            [ "easeOutExpo", [ 0.19, 1, 0.22, 1 ] ],
            [ "easeInOutExpo", [ 1, 0, 0, 1 ] ],
            [ "easeInCirc", [ 0.6, 0.04, 0.98, 0.335 ] ],
            [ "easeOutCirc", [ 0.075, 0.82, 0.165, 1 ] ],
            [ "easeInOutCirc", [ 0.785, 0.135, 0.15, 0.86 ] ]
        ], function(i, easingArray) {
            Velocity.Easings[easingArray[0]] = generateBezier.apply(null, easingArray[1]);
        });

    /* Determine the appropriate easing type given an easing input. */
    function getEasing(value, duration) {
        var easing = value;

        /* The easing option can either be a string that references a pre-registered easing,
           or it can be a two-/four-item array of integers to be converted into a bezier/spring function. */
        if (Type.isString(value)) {
            /* Ensure that the easing has been assigned to jQuery's Velocity.Easings object. */
            if (!Velocity.Easings[value]) {
                easing = false;
            }
        } else if (Type.isArray(value) && value.length === 1) {
            easing = generateStep.apply(null, value);
        } else if (Type.isArray(value) && value.length === 2) {
            /* springRK4 must be passed the animation's duration. */
            /* Note: If the springRK4 array contains non-numbers, generateSpringRK4() returns an easing
               function generated with default tension and friction values. */
            easing = generateSpringRK4.apply(null, value.concat([ duration ]));
        } else if (Type.isArray(value) && value.length === 4) {
            /* Note: If the bezier array contains non-numbers, generateBezier() returns false. */
            easing = generateBezier.apply(null, value);
        } else {
            easing = false;
        }

        /* Revert to the Velocity-wide default easing type, or fall back to "swing" (which is also jQuery's default)
           if the Velocity-wide default has been incorrectly modified. */
        if (easing === false) {
            if (Velocity.Easings[Velocity.defaults.easing]) {
                easing = Velocity.defaults.easing;
            } else {
                easing = EASING_DEFAULT;
            }
        }

        return easing;
    }

    /*****************
        CSS Stack
    *****************/

    /* The CSS object is a highly condensed and performant CSS stack that fully replaces jQuery's.
       It handles the validation, getting, and setting of both standard CSS properties and CSS property hooks. */
    /* Note: A "CSS" shorthand is aliased so that our code is easier to read. */
    var CSS = Velocity.CSS = {

        /*************
            RegEx
        *************/

        RegEx: {
            isHex: /^#([A-f\d]{3}){1,2}$/i,
            /* Unwrap a property value's surrounding text, e.g. "rgba(4, 3, 2, 1)" ==> "4, 3, 2, 1" and "rect(4px 3px 2px 1px)" ==> "4px 3px 2px 1px". */
            valueUnwrap: /^[A-z]+\((.*)\)$/i,
            wrappedValueAlreadyExtracted: /[0-9.]+ [0-9.]+ [0-9.]+( [0-9.]+)?/,
            /* Split a multi-value property into an array of subvalues, e.g. "rgba(4, 3, 2, 1) 4px 3px 2px 1px" ==> [ "rgba(4, 3, 2, 1)", "4px", "3px", "2px", "1px" ]. */
            valueSplit: /([A-z]+\(.+\))|(([A-z0-9#-.]+?)(?=\s|$))/ig
        },

        /************
            Lists
        ************/

        Lists: {
            colors: [ "fill", "stroke", "stopColor", "color", "backgroundColor", "borderColor", "borderTopColor", "borderRightColor", "borderBottomColor", "borderLeftColor", "outlineColor" ],
            transformsBase: [ "translateX", "translateY", "scale", "scaleX", "scaleY", "skewX", "skewY", "rotateZ" ],
            transforms3D: [ "transformPerspective", "translateZ", "scaleZ", "rotateX", "rotateY" ]
        },

        /************
            Hooks
        ************/

        /* Hooks allow a subproperty (e.g. "boxShadowBlur") of a compound-value CSS property
           (e.g. "boxShadow: X Y Blur Spread Color") to be animated as if it were a discrete property. */
        /* Note: Beyond enabling fine-grained property animation, hooking is necessary since Velocity only
           tweens properties with single numeric values; unlike CSS transitions, Velocity does not interpolate compound-values. */
        Hooks: {
            /********************
                Registration
            ********************/

            /* Templates are a concise way of indicating which subproperties must be individually registered for each compound-value CSS property. */
            /* Each template consists of the compound-value's base name, its constituent subproperty names, and those subproperties' default values. */
            templates: {
                "textShadow": [ "Color X Y Blur", "black 0px 0px 0px" ],
                "boxShadow": [ "Color X Y Blur Spread", "black 0px 0px 0px 0px" ],
                "clip": [ "Top Right Bottom Left", "0px 0px 0px 0px" ],
                "backgroundPosition": [ "X Y", "0% 0%" ],
                "transformOrigin": [ "X Y Z", "50% 50% 0px" ],
                "perspectiveOrigin": [ "X Y", "50% 50%" ]
            },

            /* A "registered" hook is one that has been converted from its template form into a live,
               tweenable property. It contains data to associate it with its root property. */
            registered: {
                /* Note: A registered hook looks like this ==> textShadowBlur: [ "textShadow", 3 ],
                   which consists of the subproperty's name, the associated root property's name,
                   and the subproperty's position in the root's value. */
            },
            /* Convert the templates into individual hooks then append them to the registered object above. */
            register: function () {
                /* Color hooks registration: Colors are defaulted to white -- as opposed to black -- since colors that are
                   currently set to "transparent" default to their respective template below when color-animated,
                   and white is typically a closer match to transparent than black is. An exception is made for text ("color"),
                   which is almost always set closer to black than white. */
                for (var i = 0; i < CSS.Lists.colors.length; i++) {
                    var rgbComponents = (CSS.Lists.colors[i] === "color") ? "0 0 0 1" : "255 255 255 1";
                    CSS.Hooks.templates[CSS.Lists.colors[i]] = [ "Red Green Blue Alpha", rgbComponents ];
                }

                var rootProperty,
                    hookTemplate,
                    hookNames;

                /* In IE, color values inside compound-value properties are positioned at the end the value instead of at the beginning.
                   Thus, we re-arrange the templates accordingly. */
                if (IE) {
                    for (rootProperty in CSS.Hooks.templates) {
                        hookTemplate = CSS.Hooks.templates[rootProperty];
                        hookNames = hookTemplate[0].split(" ");

                        var defaultValues = hookTemplate[1].match(CSS.RegEx.valueSplit);

                        if (hookNames[0] === "Color") {
                            /* Reposition both the hook's name and its default value to the end of their respective strings. */
                            hookNames.push(hookNames.shift());
                            defaultValues.push(defaultValues.shift());

                            /* Replace the existing template for the hook's root property. */
                            CSS.Hooks.templates[rootProperty] = [ hookNames.join(" "), defaultValues.join(" ") ];
                        }
                    }
                }

                /* Hook registration. */
                for (rootProperty in CSS.Hooks.templates) {
                    hookTemplate = CSS.Hooks.templates[rootProperty];
                    hookNames = hookTemplate[0].split(" ");

                    for (var i in hookNames) {
                        var fullHookName = rootProperty + hookNames[i],
                            hookPosition = i;

                        /* For each hook, register its full name (e.g. textShadowBlur) with its root property (e.g. textShadow)
                           and the hook's position in its template's default value string. */
                        CSS.Hooks.registered[fullHookName] = [ rootProperty, hookPosition ];
                    }
                }
            },

            /*****************************
               Injection and Extraction
            *****************************/

            /* Look up the root property associated with the hook (e.g. return "textShadow" for "textShadowBlur"). */
            /* Since a hook cannot be set directly (the browser won't recognize it), style updating for hooks is routed through the hook's root property. */
            getRoot: function (property) {
                var hookData = CSS.Hooks.registered[property];

                if (hookData) {
                    return hookData[0];
                } else {
                    /* If there was no hook match, return the property name untouched. */
                    return property;
                }
            },
            /* Convert any rootPropertyValue, null or otherwise, into a space-delimited list of hook values so that
               the targeted hook can be injected or extracted at its standard position. */
            cleanRootPropertyValue: function(rootProperty, rootPropertyValue) {
                /* If the rootPropertyValue is wrapped with "rgb()", "clip()", etc., remove the wrapping to normalize the value before manipulation. */
                if (CSS.RegEx.valueUnwrap.test(rootPropertyValue)) {
                    rootPropertyValue = rootPropertyValue.match(CSS.RegEx.valueUnwrap)[1];
                }

                /* If rootPropertyValue is a CSS null-value (from which there's inherently no hook value to extract),
                   default to the root's default value as defined in CSS.Hooks.templates. */
                /* Note: CSS null-values include "none", "auto", and "transparent". They must be converted into their
                   zero-values (e.g. textShadow: "none" ==> textShadow: "0px 0px 0px black") for hook manipulation to proceed. */
                if (CSS.Values.isCSSNullValue(rootPropertyValue)) {
                    rootPropertyValue = CSS.Hooks.templates[rootProperty][1];
                }

                return rootPropertyValue;
            },
            /* Extracted the hook's value from its root property's value. This is used to get the starting value of an animating hook. */
            extractValue: function (fullHookName, rootPropertyValue) {
                var hookData = CSS.Hooks.registered[fullHookName];

                if (hookData) {
                    var hookRoot = hookData[0],
                        hookPosition = hookData[1];

                    rootPropertyValue = CSS.Hooks.cleanRootPropertyValue(hookRoot, rootPropertyValue);

                    /* Split rootPropertyValue into its constituent hook values then grab the desired hook at its standard position. */
                    return rootPropertyValue.toString().match(CSS.RegEx.valueSplit)[hookPosition];
                } else {
                    /* If the provided fullHookName isn't a registered hook, return the rootPropertyValue that was passed in. */
                    return rootPropertyValue;
                }
            },
            /* Inject the hook's value into its root property's value. This is used to piece back together the root property
               once Velocity has updated one of its individually hooked values through tweening. */
            injectValue: function (fullHookName, hookValue, rootPropertyValue) {
                var hookData = CSS.Hooks.registered[fullHookName];

                if (hookData) {
                    var hookRoot = hookData[0],
                        hookPosition = hookData[1],
                        rootPropertyValueParts,
                        rootPropertyValueUpdated;

                    rootPropertyValue = CSS.Hooks.cleanRootPropertyValue(hookRoot, rootPropertyValue);

                    /* Split rootPropertyValue into its individual hook values, replace the targeted value with hookValue,
                       then reconstruct the rootPropertyValue string. */
                    rootPropertyValueParts = rootPropertyValue.toString().match(CSS.RegEx.valueSplit);
                    rootPropertyValueParts[hookPosition] = hookValue;
                    rootPropertyValueUpdated = rootPropertyValueParts.join(" ");

                    return rootPropertyValueUpdated;
                } else {
                    /* If the provided fullHookName isn't a registered hook, return the rootPropertyValue that was passed in. */
                    return rootPropertyValue;
                }
            }
        },

        /*******************
           Normalizations
        *******************/

        /* Normalizations standardize CSS property manipulation by pollyfilling browser-specific implementations (e.g. opacity)
           and reformatting special properties (e.g. clip, rgba) to look like standard ones. */
        Normalizations: {
            /* Normalizations are passed a normalization target (either the property's name, its extracted value, or its injected value),
               the targeted element (which may need to be queried), and the targeted property value. */
            registered: {
                clip: function (type, element, propertyValue) {
                    switch (type) {
                        case "name":
                            return "clip";
                        /* Clip needs to be unwrapped and stripped of its commas during extraction. */
                        case "extract":
                            var extracted;

                            /* If Velocity also extracted this value, skip extraction. */
                            if (CSS.RegEx.wrappedValueAlreadyExtracted.test(propertyValue)) {
                                extracted = propertyValue;
                            } else {
                                /* Remove the "rect()" wrapper. */
                                extracted = propertyValue.toString().match(CSS.RegEx.valueUnwrap);

                                /* Strip off commas. */
                                extracted = extracted ? extracted[1].replace(/,(\s+)?/g, " ") : propertyValue;
                            }

                            return extracted;
                        /* Clip needs to be re-wrapped during injection. */
                        case "inject":
                            return "rect(" + propertyValue + ")";
                    }
                },

                blur: function(type, element, propertyValue) {
                    switch (type) {
                        case "name":
                            return Velocity.State.isFirefox ? "filter" : "-webkit-filter";
                        case "extract":
                            var extracted = parseFloat(propertyValue);

                            /* If extracted is NaN, meaning the value isn't already extracted. */
                            if (!(extracted || extracted === 0)) {
                                var blurComponent = propertyValue.toString().match(/blur\(([0-9]+[A-z]+)\)/i);

                                /* If the filter string had a blur component, return just the blur value and unit type. */
                                if (blurComponent) {
                                    extracted = blurComponent[1];
                                /* If the component doesn't exist, default blur to 0. */
                                } else {
                                    extracted = 0;
                                }
                            }

                            return extracted;
                        /* Blur needs to be re-wrapped during injection. */
                        case "inject":
                            /* For the blur effect to be fully de-applied, it needs to be set to "none" instead of 0. */
                            if (!parseFloat(propertyValue)) {
                                return "none";
                            } else {
                                return "blur(" + propertyValue + ")";
                            }
                    }
                },

                /* <=IE8 do not support the standard opacity property. They use filter:alpha(opacity=INT) instead. */
                opacity: function (type, element, propertyValue) {
                    if (IE <= 8) {
                        switch (type) {
                            case "name":
                                return "filter";
                            case "extract":
                                /* <=IE8 return a "filter" value of "alpha(opacity=\d{1,3})".
                                   Extract the value and convert it to a decimal value to match the standard CSS opacity property's formatting. */
                                var extracted = propertyValue.toString().match(/alpha\(opacity=(.*)\)/i);

                                if (extracted) {
                                    /* Convert to decimal value. */
                                    propertyValue = extracted[1] / 100;
                                } else {
                                    /* When extracting opacity, default to 1 since a null value means opacity hasn't been set. */
                                    propertyValue = 1;
                                }

                                return propertyValue;
                            case "inject":
                                /* Opacified elements are required to have their zoom property set to a non-zero value. */
                                element.style.zoom = 1;

                                /* Setting the filter property on elements with certain font property combinations can result in a
                                   highly unappealing ultra-bolding effect. There's no way to remedy this throughout a tween, but dropping the
                                   value altogether (when opacity hits 1) at leasts ensures that the glitch is gone post-tweening. */
                                if (parseFloat(propertyValue) >= 1) {
                                    return "";
                                } else {
                                  /* As per the filter property's spec, convert the decimal value to a whole number and wrap the value. */
                                  return "alpha(opacity=" + parseInt(parseFloat(propertyValue) * 100, 10) + ")";
                                }
                        }
                    /* With all other browsers, normalization is not required; return the same values that were passed in. */
                    } else {
                        switch (type) {
                            case "name":
                                return "opacity";
                            case "extract":
                                return propertyValue;
                            case "inject":
                                return propertyValue;
                        }
                    }
                }
            },

            /*****************************
                Batched Registrations
            *****************************/

            /* Note: Batched normalizations extend the CSS.Normalizations.registered object. */
            register: function () {

                /*****************
                    Transforms
                *****************/

                /* Transforms are the subproperties contained by the CSS "transform" property. Transforms must undergo normalization
                   so that they can be referenced in a properties map by their individual names. */
                /* Note: When transforms are "set", they are actually assigned to a per-element transformCache. When all transform
                   setting is complete complete, CSS.flushTransformCache() must be manually called to flush the values to the DOM.
                   Transform setting is batched in this way to improve performance: the transform style only needs to be updated
                   once when multiple transform subproperties are being animated simultaneously. */
                /* Note: IE9 and Android Gingerbread have support for 2D -- but not 3D -- transforms. Since animating unsupported
                   transform properties results in the browser ignoring the *entire* transform string, we prevent these 3D values
                   from being normalized for these browsers so that tweening skips these properties altogether
                   (since it will ignore them as being unsupported by the browser.) */
                if (!(IE <= 9) && !Velocity.State.isGingerbread) {
                    /* Note: Since the standalone CSS "perspective" property and the CSS transform "perspective" subproperty
                    share the same name, the latter is given a unique token within Velocity: "transformPerspective". */
                    CSS.Lists.transformsBase = CSS.Lists.transformsBase.concat(CSS.Lists.transforms3D);
                }

                for (var i = 0; i < CSS.Lists.transformsBase.length; i++) {
                    /* Wrap the dynamically generated normalization function in a new scope so that transformName's value is
                    paired with its respective function. (Otherwise, all functions would take the final for loop's transformName.) */
                    (function() {
                        var transformName = CSS.Lists.transformsBase[i];

                        CSS.Normalizations.registered[transformName] = function (type, element, propertyValue) {
                            switch (type) {
                                /* The normalized property name is the parent "transform" property -- the property that is actually set in CSS. */
                                case "name":
                                    return "transform";
                                /* Transform values are cached onto a per-element transformCache object. */
                                case "extract":
                                    /* If this transform has yet to be assigned a value, return its null value. */
                                    if (Data(element) === undefined || Data(element).transformCache[transformName] === undefined) {
                                        /* Scale CSS.Lists.transformsBase default to 1 whereas all other transform properties default to 0. */
                                        return /^scale/i.test(transformName) ? 1 : 0;
                                    /* When transform values are set, they are wrapped in parentheses as per the CSS spec.
                                       Thus, when extracting their values (for tween calculations), we strip off the parentheses. */
                                    } else {
                                        return Data(element).transformCache[transformName].replace(/[()]/g, "");
                                    }
                                case "inject":
                                    var invalid = false;

                                    /* If an individual transform property contains an unsupported unit type, the browser ignores the *entire* transform property.
                                       Thus, protect users from themselves by skipping setting for transform values supplied with invalid unit types. */
                                    /* Switch on the base transform type; ignore the axis by removing the last letter from the transform's name. */
                                    switch (transformName.substr(0, transformName.length - 1)) {
                                        /* Whitelist unit types for each transform. */
                                        case "translate":
                                            invalid = !/(%|px|em|rem|vw|vh|\d)$/i.test(propertyValue);
                                            break;
                                        /* Since an axis-free "scale" property is supported as well, a little hack is used here to detect it by chopping off its last letter. */
                                        case "scal":
                                        case "scale":
                                            /* Chrome on Android has a bug in which scaled elements blur if their initial scale
                                               value is below 1 (which can happen with forcefeeding). Thus, we detect a yet-unset scale property
                                               and ensure that its first value is always 1. More info: http://stackoverflow.com/questions/10417890/css3-animations-with-transform-causes-blurred-elements-on-webkit/10417962#10417962 */
                                            if (Velocity.State.isAndroid && Data(element).transformCache[transformName] === undefined && propertyValue < 1) {
                                                propertyValue = 1;
                                            }

                                            invalid = !/(\d)$/i.test(propertyValue);
                                            break;
                                        case "skew":
                                            invalid = !/(deg|\d)$/i.test(propertyValue);
                                            break;
                                        case "rotate":
                                            invalid = !/(deg|\d)$/i.test(propertyValue);
                                            break;
                                    }

                                    if (!invalid) {
                                        /* As per the CSS spec, wrap the value in parentheses. */
                                        Data(element).transformCache[transformName] = "(" + propertyValue + ")";
                                    }

                                    /* Although the value is set on the transformCache object, return the newly-updated value for the calling code to process as normal. */
                                    return Data(element).transformCache[transformName];
                            }
                        };
                    })();
                }

                /*************
                    Colors
                *************/

                /* Since Velocity only animates a single numeric value per property, color animation is achieved by hooking the individual RGBA components of CSS color properties.
                   Accordingly, color values must be normalized (e.g. "#ff0000", "red", and "rgb(255, 0, 0)" ==> "255 0 0 1") so that their components can be injected/extracted by CSS.Hooks logic. */
                for (var i = 0; i < CSS.Lists.colors.length; i++) {
                    /* Wrap the dynamically generated normalization function in a new scope so that colorName's value is paired with its respective function.
                       (Otherwise, all functions would take the final for loop's colorName.) */
                    (function () {
                        var colorName = CSS.Lists.colors[i];

                        /* Note: In IE<=8, which support rgb but not rgba, color properties are reverted to rgb by stripping off the alpha component. */
                        CSS.Normalizations.registered[colorName] = function(type, element, propertyValue) {
                            switch (type) {
                                case "name":
                                    return colorName;
                                /* Convert all color values into the rgb format. (Old IE can return hex values and color names instead of rgb/rgba.) */
                                case "extract":
                                    var extracted;

                                    /* If the color is already in its hookable form (e.g. "255 255 255 1") due to having been previously extracted, skip extraction. */
                                    if (CSS.RegEx.wrappedValueAlreadyExtracted.test(propertyValue)) {
                                        extracted = propertyValue;
                                    } else {
                                        var converted,
                                            colorNames = {
                                                black: "rgb(0, 0, 0)",
                                                blue: "rgb(0, 0, 255)",
                                                gray: "rgb(128, 128, 128)",
                                                green: "rgb(0, 128, 0)",
                                                red: "rgb(255, 0, 0)",
                                                white: "rgb(255, 255, 255)"
                                            };

                                        /* Convert color names to rgb. */
                                        if (/^[A-z]+$/i.test(propertyValue)) {
                                            if (colorNames[propertyValue] !== undefined) {
                                                converted = colorNames[propertyValue]
                                            } else {
                                                /* If an unmatched color name is provided, default to black. */
                                                converted = colorNames.black;
                                            }
                                        /* Convert hex values to rgb. */
                                        } else if (CSS.RegEx.isHex.test(propertyValue)) {
                                            converted = "rgb(" + CSS.Values.hexToRgb(propertyValue).join(" ") + ")";
                                        /* If the provided color doesn't match any of the accepted color formats, default to black. */
                                        } else if (!(/^rgba?\(/i.test(propertyValue))) {
                                            converted = colorNames.black;
                                        }

                                        /* Remove the surrounding "rgb/rgba()" string then replace commas with spaces and strip
                                           repeated spaces (in case the value included spaces to begin with). */
                                        extracted = (converted || propertyValue).toString().match(CSS.RegEx.valueUnwrap)[1].replace(/,(\s+)?/g, " ");
                                    }

                                    /* So long as this isn't <=IE8, add a fourth (alpha) component if it's missing and default it to 1 (visible). */
                                    if (!(IE <= 8) && extracted.split(" ").length === 3) {
                                        extracted += " 1";
                                    }

                                    return extracted;
                                case "inject":
                                    /* If this is IE<=8 and an alpha component exists, strip it off. */
                                    if (IE <= 8) {
                                        if (propertyValue.split(" ").length === 4) {
                                            propertyValue = propertyValue.split(/\s+/).slice(0, 3).join(" ");
                                        }
                                    /* Otherwise, add a fourth (alpha) component if it's missing and default it to 1 (visible). */
                                    } else if (propertyValue.split(" ").length === 3) {
                                        propertyValue += " 1";
                                    }

                                    /* Re-insert the browser-appropriate wrapper("rgb/rgba()"), insert commas, and strip off decimal units
                                       on all values but the fourth (R, G, and B only accept whole numbers). */
                                    return (IE <= 8 ? "rgb" : "rgba") + "(" + propertyValue.replace(/\s+/g, ",").replace(/\.(\d)+(?=,)/g, "") + ")";
                            }
                        };
                    })();
                }
            }
        },

        /************************
           CSS Property Names
        ************************/

        Names: {
            /* Camelcase a property name into its JavaScript notation (e.g. "background-color" ==> "backgroundColor").
               Camelcasing is used to normalize property names between and across calls. */
            camelCase: function (property) {
                return property.replace(/-(\w)/g, function (match, subMatch) {
                    return subMatch.toUpperCase();
                });
            },

            /* For SVG elements, some properties (namely, dimensional ones) are GET/SET via the element's HTML attributes (instead of via CSS styles). */
            SVGAttribute: function (property) {
                var SVGAttributes = "width|height|x|y|cx|cy|r|rx|ry|x1|x2|y1|y2";

                /* Certain browsers require an SVG transform to be applied as an attribute. (Otherwise, application via CSS is preferable due to 3D support.) */
                if (IE || (Velocity.State.isAndroid && !Velocity.State.isChrome)) {
                    SVGAttributes += "|transform";
                }

                return new RegExp("^(" + SVGAttributes + ")$", "i").test(property);
            },

            /* Determine whether a property should be set with a vendor prefix. */
            /* If a prefixed version of the property exists, return it. Otherwise, return the original property name.
               If the property is not at all supported by the browser, return a false flag. */
            prefixCheck: function (property) {
                /* If this property has already been checked, return the cached value. */
                if (Velocity.State.prefixMatches[property]) {
                    return [ Velocity.State.prefixMatches[property], true ];
                } else {
                    var vendors = [ "", "Webkit", "Moz", "ms", "O" ];

                    for (var i = 0, vendorsLength = vendors.length; i < vendorsLength; i++) {
                        var propertyPrefixed;

                        if (i === 0) {
                            propertyPrefixed = property;
                        } else {
                            /* Capitalize the first letter of the property to conform to JavaScript vendor prefix notation (e.g. webkitFilter). */
                            propertyPrefixed = vendors[i] + property.replace(/^\w/, function(match) { return match.toUpperCase(); });
                        }

                        /* Check if the browser supports this property as prefixed. */
                        if (Type.isString(Velocity.State.prefixElement.style[propertyPrefixed])) {
                            /* Cache the match. */
                            Velocity.State.prefixMatches[property] = propertyPrefixed;

                            return [ propertyPrefixed, true ];
                        }
                    }

                    /* If the browser doesn't support this property in any form, include a false flag so that the caller can decide how to proceed. */
                    return [ property, false ];
                }
            }
        },

        /************************
           CSS Property Values
        ************************/

        Values: {
            /* Hex to RGB conversion. Copyright Tim Down: http://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb */
            hexToRgb: function (hex) {
                var shortformRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i,
                    longformRegex = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,
                    rgbParts;

                hex = hex.replace(shortformRegex, function (m, r, g, b) {
                    return r + r + g + g + b + b;
                });

                rgbParts = longformRegex.exec(hex);

                return rgbParts ? [ parseInt(rgbParts[1], 16), parseInt(rgbParts[2], 16), parseInt(rgbParts[3], 16) ] : [ 0, 0, 0 ];
            },

            isCSSNullValue: function (value) {
                /* The browser defaults CSS values that have not been set to either 0 or one of several possible null-value strings.
                   Thus, we check for both falsiness and these special strings. */
                /* Null-value checking is performed to default the special strings to 0 (for the sake of tweening) or their hook
                   templates as defined as CSS.Hooks (for the sake of hook injection/extraction). */
                /* Note: Chrome returns "rgba(0, 0, 0, 0)" for an undefined color whereas IE returns "transparent". */
                return (value == 0 || /^(none|auto|transparent|(rgba\(0, ?0, ?0, ?0\)))$/i.test(value));
            },

            /* Retrieve a property's default unit type. Used for assigning a unit type when one is not supplied by the user. */
            getUnitType: function (property) {
                if (/^(rotate|skew)/i.test(property)) {
                    return "deg";
                } else if (/(^(scale|scaleX|scaleY|scaleZ|alpha|flexGrow|flexHeight|zIndex|fontWeight)$)|((opacity|red|green|blue|alpha)$)/i.test(property)) {
                    /* The above properties are unitless. */
                    return "";
                } else {
                    /* Default to px for all other properties. */
                    return "px";
                }
            },

            /* HTML elements default to an associated display type when they're not set to display:none. */
            /* Note: This function is used for correctly setting the non-"none" display value in certain Velocity redirects, such as fadeIn/Out. */
            getDisplayType: function (element) {
                var tagName = element && element.tagName.toString().toLowerCase();

                if (/^(b|big|i|small|tt|abbr|acronym|cite|code|dfn|em|kbd|strong|samp|var|a|bdo|br|img|map|object|q|script|span|sub|sup|button|input|label|select|textarea)$/i.test(tagName)) {
                    return "inline";
                } else if (/^(li)$/i.test(tagName)) {
                    return "list-item";
                } else if (/^(tr)$/i.test(tagName)) {
                    return "table-row";
                } else if (/^(table)$/i.test(tagName)) {
                    return "table";
                } else if (/^(tbody)$/i.test(tagName)) {
                    return "table-row-group";
                /* Default to "block" when no match is found. */
                } else {
                    return "block";
                }
            },

            /* The class add/remove functions are used to temporarily apply a "velocity-animating" class to elements while they're animating. */
            addClass: function (element, className) {
                if (element.classList) {
                    element.classList.add(className);
                } else {
                    element.className += (element.className.length ? " " : "") + className;
                }
            },

            removeClass: function (element, className) {
                if (element.classList) {
                    element.classList.remove(className);
                } else {
                    element.className = element.className.toString().replace(new RegExp("(^|\\s)" + className.split(" ").join("|") + "(\\s|$)", "gi"), " ");
                }
            }
        },

        /****************************
           Style Getting & Setting
        ****************************/

        /* The singular getPropertyValue, which routes the logic for all normalizations, hooks, and standard CSS properties. */
        getPropertyValue: function (element, property, rootPropertyValue, forceStyleLookup) {
            /* Get an element's computed property value. */
            /* Note: Retrieving the value of a CSS property cannot simply be performed by checking an element's
               style attribute (which only reflects user-defined values). Instead, the browser must be queried for a property's
               *computed* value. You can read more about getComputedStyle here: https://developer.mozilla.org/en/docs/Web/API/window.getComputedStyle */
            function computePropertyValue (element, property) {
                /* When box-sizing isn't set to border-box, height and width style values are incorrectly computed when an
                   element's scrollbars are visible (which expands the element's dimensions). Thus, we defer to the more accurate
                   offsetHeight/Width property, which includes the total dimensions for interior, border, padding, and scrollbar.
                   We subtract border and padding to get the sum of interior + scrollbar. */
                var computedValue = 0;

                /* IE<=8 doesn't support window.getComputedStyle, thus we defer to jQuery, which has an extensive array
                   of hacks to accurately retrieve IE8 property values. Re-implementing that logic here is not worth bloating the
                   codebase for a dying browser. The performance repercussions of using jQuery here are minimal since
                   Velocity is optimized to rarely (and sometimes never) query the DOM. Further, the $.css() codepath isn't that slow. */
                if (IE <= 8) {
                    computedValue = $.css(element, property); /* GET */
                /* All other browsers support getComputedStyle. The returned live object reference is cached onto its
                   associated element so that it does not need to be refetched upon every GET. */
                } else {
                    /* Browsers do not return height and width values for elements that are set to display:"none". Thus, we temporarily
                       toggle display to the element type's default value. */
                    var toggleDisplay = false;

                    if (/^(width|height)$/.test(property) && CSS.getPropertyValue(element, "display") === 0) {
                        toggleDisplay = true;
                        CSS.setPropertyValue(element, "display", CSS.Values.getDisplayType(element));
                    }

                    function revertDisplay () {
                        if (toggleDisplay) {
                            CSS.setPropertyValue(element, "display", "none");
                        }
                    }

                    if (!forceStyleLookup) {
                        if (property === "height" && CSS.getPropertyValue(element, "boxSizing").toString().toLowerCase() !== "border-box") {
                            var contentBoxHeight = element.offsetHeight - (parseFloat(CSS.getPropertyValue(element, "borderTopWidth")) || 0) - (parseFloat(CSS.getPropertyValue(element, "borderBottomWidth")) || 0) - (parseFloat(CSS.getPropertyValue(element, "paddingTop")) || 0) - (parseFloat(CSS.getPropertyValue(element, "paddingBottom")) || 0);
                            revertDisplay();

                            return contentBoxHeight;
                        } else if (property === "width" && CSS.getPropertyValue(element, "boxSizing").toString().toLowerCase() !== "border-box") {
                            var contentBoxWidth = element.offsetWidth - (parseFloat(CSS.getPropertyValue(element, "borderLeftWidth")) || 0) - (parseFloat(CSS.getPropertyValue(element, "borderRightWidth")) || 0) - (parseFloat(CSS.getPropertyValue(element, "paddingLeft")) || 0) - (parseFloat(CSS.getPropertyValue(element, "paddingRight")) || 0);
                            revertDisplay();

                            return contentBoxWidth;
                        }
                    }

                    var computedStyle;

                    /* For elements that Velocity hasn't been called on directly (e.g. when Velocity queries the DOM on behalf
                       of a parent of an element its animating), perform a direct getComputedStyle lookup since the object isn't cached. */
                    if (Data(element) === undefined) {
                        computedStyle = window.getComputedStyle(element, null); /* GET */
                    /* If the computedStyle object has yet to be cached, do so now. */
                    } else if (!Data(element).computedStyle) {
                        computedStyle = Data(element).computedStyle = window.getComputedStyle(element, null); /* GET */
                    /* If computedStyle is cached, use it. */
                    } else {
                        computedStyle = Data(element).computedStyle;
                    }

                    /* IE and Firefox do not return a value for the generic borderColor -- they only return individual values for each border side's color.
                       Also, in all browsers, when border colors aren't all the same, a compound value is returned that Velocity isn't setup to parse.
                       So, as a polyfill for querying individual border side colors, we just return the top border's color and animate all borders from that value. */
                    if (property === "borderColor") {
                        property = "borderTopColor";
                    }

                    /* IE9 has a bug in which the "filter" property must be accessed from computedStyle using the getPropertyValue method
                       instead of a direct property lookup. The getPropertyValue method is slower than a direct lookup, which is why we avoid it by default. */
                    if (IE === 9 && property === "filter") {
                        computedValue = computedStyle.getPropertyValue(property); /* GET */
                    } else {
                        computedValue = computedStyle[property];
                    }

                    /* Fall back to the property's style value (if defined) when computedValue returns nothing,
                       which can happen when the element hasn't been painted. */
                    if (computedValue === "" || computedValue === null) {
                        computedValue = element.style[property];
                    }

                    revertDisplay();
                }

                /* For top, right, bottom, and left (TRBL) values that are set to "auto" on elements of "fixed" or "absolute" position,
                   defer to jQuery for converting "auto" to a numeric value. (For elements with a "static" or "relative" position, "auto" has the same
                   effect as being set to 0, so no conversion is necessary.) */
                /* An example of why numeric conversion is necessary: When an element with "position:absolute" has an untouched "left"
                   property, which reverts to "auto", left's value is 0 relative to its parent element, but is often non-zero relative
                   to its *containing* (not parent) element, which is the nearest "position:relative" ancestor or the viewport (and always the viewport in the case of "position:fixed"). */
                if (computedValue === "auto" && /^(top|right|bottom|left)$/i.test(property)) {
                    var position = computePropertyValue(element, "position"); /* GET */

                    /* For absolute positioning, jQuery's $.position() only returns values for top and left;
                       right and bottom will have their "auto" value reverted to 0. */
                    /* Note: A jQuery object must be created here since jQuery doesn't have a low-level alias for $.position().
                       Not a big deal since we're currently in a GET batch anyway. */
                    if (position === "fixed" || (position === "absolute" && /top|left/i.test(property))) {
                        /* Note: jQuery strips the pixel unit from its returned values; we re-add it here to conform with computePropertyValue's behavior. */
                        computedValue = $(element).position()[property] + "px"; /* GET */
                    }
                }

                return computedValue;
            }

            var propertyValue;

            /* If this is a hooked property (e.g. "clipLeft" instead of the root property of "clip"),
               extract the hook's value from a normalized rootPropertyValue using CSS.Hooks.extractValue(). */
            if (CSS.Hooks.registered[property]) {
                var hook = property,
                    hookRoot = CSS.Hooks.getRoot(hook);

                /* If a cached rootPropertyValue wasn't passed in (which Velocity always attempts to do in order to avoid requerying the DOM),
                   query the DOM for the root property's value. */
                if (rootPropertyValue === undefined) {
                    /* Since the browser is now being directly queried, use the official post-prefixing property name for this lookup. */
                    rootPropertyValue = CSS.getPropertyValue(element, CSS.Names.prefixCheck(hookRoot)[0]); /* GET */
                }

                /* If this root has a normalization registered, peform the associated normalization extraction. */
                if (CSS.Normalizations.registered[hookRoot]) {
                    rootPropertyValue = CSS.Normalizations.registered[hookRoot]("extract", element, rootPropertyValue);
                }

                /* Extract the hook's value. */
                propertyValue = CSS.Hooks.extractValue(hook, rootPropertyValue);

            /* If this is a normalized property (e.g. "opacity" becomes "filter" in <=IE8) or "translateX" becomes "transform"),
               normalize the property's name and value, and handle the special case of transforms. */
            /* Note: Normalizing a property is mutually exclusive from hooking a property since hook-extracted values are strictly
               numerical and therefore do not require normalization extraction. */
            } else if (CSS.Normalizations.registered[property]) {
                var normalizedPropertyName,
                    normalizedPropertyValue;

                normalizedPropertyName = CSS.Normalizations.registered[property]("name", element);

                /* Transform values are calculated via normalization extraction (see below), which checks against the element's transformCache.
                   At no point do transform GETs ever actually query the DOM; initial stylesheet values are never processed.
                   This is because parsing 3D transform matrices is not always accurate and would bloat our codebase;
                   thus, normalization extraction defaults initial transform values to their zero-values (e.g. 1 for scaleX and 0 for translateX). */
                if (normalizedPropertyName !== "transform") {
                    normalizedPropertyValue = computePropertyValue(element, CSS.Names.prefixCheck(normalizedPropertyName)[0]); /* GET */

                    /* If the value is a CSS null-value and this property has a hook template, use that zero-value template so that hooks can be extracted from it. */
                    if (CSS.Values.isCSSNullValue(normalizedPropertyValue) && CSS.Hooks.templates[property]) {
                        normalizedPropertyValue = CSS.Hooks.templates[property][1];
                    }
                }

                propertyValue = CSS.Normalizations.registered[property]("extract", element, normalizedPropertyValue);
            }

            /* If a (numeric) value wasn't produced via hook extraction or normalization, query the DOM. */
            if (!/^[\d-]/.test(propertyValue)) {
                /* For SVG elements, dimensional properties (which SVGAttribute() detects) are tweened via
                   their HTML attribute values instead of their CSS style values. */
                if (Data(element) && Data(element).isSVG && CSS.Names.SVGAttribute(property)) {
                    /* Since the height/width attribute values must be set manually, they don't reflect computed values.
                       Thus, we use use getBBox() to ensure we always get values for elements with undefined height/width attributes. */
                    if (/^(height|width)$/i.test(property)) {
                        /* Firefox throws an error if .getBBox() is called on an SVG that isn't attached to the DOM. */
                        try {
                            propertyValue = element.getBBox()[property];
                        } catch (error) {
                            propertyValue = 0;
                        }
                    /* Otherwise, access the attribute value directly. */
                    } else {
                        propertyValue = element.getAttribute(property);
                    }
                } else {
                    propertyValue = computePropertyValue(element, CSS.Names.prefixCheck(property)[0]); /* GET */
                }
            }

            /* Since property lookups are for animation purposes (which entails computing the numeric delta between start and end values),
               convert CSS null-values to an integer of value 0. */
            if (CSS.Values.isCSSNullValue(propertyValue)) {
                propertyValue = 0;
            }

            if (Velocity.debug >= 2) console.log("Get " + property + ": " + propertyValue);

            return propertyValue;
        },

        /* The singular setPropertyValue, which routes the logic for all normalizations, hooks, and standard CSS properties. */
        setPropertyValue: function(element, property, propertyValue, rootPropertyValue, scrollData) {
            var propertyName = property;

            /* In order to be subjected to call options and element queueing, scroll animation is routed through Velocity as if it were a standard CSS property. */
            if (property === "scroll") {
                /* If a container option is present, scroll the container instead of the browser window. */
                if (scrollData.container) {
                    scrollData.container["scroll" + scrollData.direction] = propertyValue;
                /* Otherwise, Velocity defaults to scrolling the browser window. */
                } else {
                    if (scrollData.direction === "Left") {
                        window.scrollTo(propertyValue, scrollData.alternateValue);
                    } else {
                        window.scrollTo(scrollData.alternateValue, propertyValue);
                    }
                }
            } else {
                /* Transforms (translateX, rotateZ, etc.) are applied to a per-element transformCache object, which is manually flushed via flushTransformCache().
                   Thus, for now, we merely cache transforms being SET. */
                if (CSS.Normalizations.registered[property] && CSS.Normalizations.registered[property]("name", element) === "transform") {
                    /* Perform a normalization injection. */
                    /* Note: The normalization logic handles the transformCache updating. */
                    CSS.Normalizations.registered[property]("inject", element, propertyValue);

                    propertyName = "transform";
                    propertyValue = Data(element).transformCache[property];
                } else {
                    /* Inject hooks. */
                    if (CSS.Hooks.registered[property]) {
                        var hookName = property,
                            hookRoot = CSS.Hooks.getRoot(property);

                        /* If a cached rootPropertyValue was not provided, query the DOM for the hookRoot's current value. */
                        rootPropertyValue = rootPropertyValue || CSS.getPropertyValue(element, hookRoot); /* GET */

                        propertyValue = CSS.Hooks.injectValue(hookName, propertyValue, rootPropertyValue);
                        property = hookRoot;
                    }

                    /* Normalize names and values. */
                    if (CSS.Normalizations.registered[property]) {
                        propertyValue = CSS.Normalizations.registered[property]("inject", element, propertyValue);
                        property = CSS.Normalizations.registered[property]("name", element);
                    }

                    /* Assign the appropriate vendor prefix before performing an official style update. */
                    propertyName = CSS.Names.prefixCheck(property)[0];

                    /* A try/catch is used for IE<=8, which throws an error when "invalid" CSS values are set, e.g. a negative width.
                       Try/catch is avoided for other browsers since it incurs a performance overhead. */
                    if (IE <= 8) {
                        try {
                            element.style[propertyName] = propertyValue;
                        } catch (error) { if (Velocity.debug) console.log("Browser does not support [" + propertyValue + "] for [" + propertyName + "]"); }
                    /* SVG elements have their dimensional properties (width, height, x, y, cx, etc.) applied directly as attributes instead of as styles. */
                    /* Note: IE8 does not support SVG elements, so it's okay that we skip it for SVG animation. */
                    } else if (Data(element) && Data(element).isSVG && CSS.Names.SVGAttribute(property)) {
                        /* Note: For SVG attributes, vendor-prefixed property names are never used. */
                        /* Note: Not all CSS properties can be animated via attributes, but the browser won't throw an error for unsupported properties. */
                        element.setAttribute(property, propertyValue);
                    } else {
                        element.style[propertyName] = propertyValue;
                    }

                    if (Velocity.debug >= 2) console.log("Set " + property + " (" + propertyName + "): " + propertyValue);
                }
            }

            /* Return the normalized property name and value in case the caller wants to know how these values were modified before being applied to the DOM. */
            return [ propertyName, propertyValue ];
        },

        /* To increase performance by batching transform updates into a single SET, transforms are not directly applied to an element until flushTransformCache() is called. */
        /* Note: Velocity applies transform properties in the same order that they are chronogically introduced to the element's CSS styles. */
        flushTransformCache: function(element) {
            var transformString = "";

            /* Certain browsers require that SVG transforms be applied as an attribute. However, the SVG transform attribute takes a modified version of CSS's transform string
               (units are dropped and, except for skewX/Y, subproperties are merged into their master property -- e.g. scaleX and scaleY are merged into scale(X Y). */
            if ((IE || (Velocity.State.isAndroid && !Velocity.State.isChrome)) && Data(element).isSVG) {
                /* Since transform values are stored in their parentheses-wrapped form, we use a helper function to strip out their numeric values.
                   Further, SVG transform properties only take unitless (representing pixels) values, so it's okay that parseFloat() strips the unit suffixed to the float value. */
                function getTransformFloat (transformProperty) {
                    return parseFloat(CSS.getPropertyValue(element, transformProperty));
                }

                /* Create an object to organize all the transforms that we'll apply to the SVG element. To keep the logic simple,
                   we process *all* transform properties -- even those that may not be explicitly applied (since they default to their zero-values anyway). */
                var SVGTransforms = {
                    translate: [ getTransformFloat("translateX"), getTransformFloat("translateY") ],
                    skewX: [ getTransformFloat("skewX") ], skewY: [ getTransformFloat("skewY") ],
                    /* If the scale property is set (non-1), use that value for the scaleX and scaleY values
                       (this behavior mimics the result of animating all these properties at once on HTML elements). */
                    scale: getTransformFloat("scale") !== 1 ? [ getTransformFloat("scale"), getTransformFloat("scale") ] : [ getTransformFloat("scaleX"), getTransformFloat("scaleY") ],
                    /* Note: SVG's rotate transform takes three values: rotation degrees followed by the X and Y values
                       defining the rotation's origin point. We ignore the origin values (default them to 0). */
                    rotate: [ getTransformFloat("rotateZ"), 0, 0 ]
                };

                /* Iterate through the transform properties in the user-defined property map order.
                   (This mimics the behavior of non-SVG transform animation.) */
                $.each(Data(element).transformCache, function(transformName) {
                    /* Except for with skewX/Y, revert the axis-specific transform subproperties to their axis-free master
                       properties so that they match up with SVG's accepted transform properties. */
                    if (/^translate/i.test(transformName)) {
                        transformName = "translate";
                    } else if (/^scale/i.test(transformName)) {
                        transformName = "scale";
                    } else if (/^rotate/i.test(transformName)) {
                        transformName = "rotate";
                    }

                    /* Check that we haven't yet deleted the property from the SVGTransforms container. */
                    if (SVGTransforms[transformName]) {
                        /* Append the transform property in the SVG-supported transform format. As per the spec, surround the space-delimited values in parentheses. */
                        transformString += transformName + "(" + SVGTransforms[transformName].join(" ") + ")" + " ";

                        /* After processing an SVG transform property, delete it from the SVGTransforms container so we don't
                           re-insert the same master property if we encounter another one of its axis-specific properties. */
                        delete SVGTransforms[transformName];
                    }
                });
            } else {
                var transformValue,
                    perspective;

                /* Transform properties are stored as members of the transformCache object. Concatenate all the members into a string. */
                $.each(Data(element).transformCache, function(transformName) {
                    transformValue = Data(element).transformCache[transformName];

                    /* Transform's perspective subproperty must be set first in order to take effect. Store it temporarily. */
                    if (transformName === "transformPerspective") {
                        perspective = transformValue;
                        return true;
                    }

                    /* IE9 only supports one rotation type, rotateZ, which it refers to as "rotate". */
                    if (IE === 9 && transformName === "rotateZ") {
                        transformName = "rotate";
                    }

                    transformString += transformName + transformValue + " ";
                });

                /* If present, set the perspective subproperty first. */
                if (perspective) {
                    transformString = "perspective" + perspective + " " + transformString;
                }
            }

            CSS.setPropertyValue(element, "transform", transformString);
        }
    };

    /* Register hooks and normalizations. */
    CSS.Hooks.register();
    CSS.Normalizations.register();

    /* Allow hook setting in the same fashion as jQuery's $.css(). */
    Velocity.hook = function (elements, arg2, arg3) {
        var value = undefined;

        elements = sanitizeElements(elements);

        $.each(elements, function(i, element) {
            /* Initialize Velocity's per-element data cache if this element hasn't previously been animated. */
            if (Data(element) === undefined) {
                Velocity.init(element);
            }

            /* Get property value. If an element set was passed in, only return the value for the first element. */
            if (arg3 === undefined) {
                if (value === undefined) {
                    value = Velocity.CSS.getPropertyValue(element, arg2);
                }
            /* Set property value. */
            } else {
                /* sPV returns an array of the normalized propertyName/propertyValue pair used to update the DOM. */
                var adjustedSet = Velocity.CSS.setPropertyValue(element, arg2, arg3);

                /* Transform properties don't automatically set. They have to be flushed to the DOM. */
                if (adjustedSet[0] === "transform") {
                    Velocity.CSS.flushTransformCache(element);
                }

                value = adjustedSet;
            }
        });

        return value;
    };

    /*****************
        Animation
    *****************/

    var animate = function() {

        /******************
            Call Chain
        ******************/

        /* Logic for determining what to return to the call stack when exiting out of Velocity. */
        function getChain () {
            /* If we are using the utility function, attempt to return this call's promise. If no promise library was detected,
               default to null instead of returning the targeted elements so that utility function's return value is standardized. */
            if (isUtility) {
                return promiseData.promise || null;
            /* Otherwise, if we're using $.fn, return the jQuery-/Zepto-wrapped element set. */
            } else {
                return elementsWrapped;
            }
        }

        /*************************
           Arguments Assignment
        *************************/

        /* To allow for expressive CoffeeScript code, Velocity supports an alternative syntax in which "elements" (or "e"), "properties" (or "p"), and "options" (or "o")
           objects are defined on a container object that's passed in as Velocity's sole argument. */
        /* Note: Some browsers automatically populate arguments with a "properties" object. We detect it by checking for its default "names" property. */
        var syntacticSugar = (arguments[0] && (arguments[0].p || (($.isPlainObject(arguments[0].properties) && !arguments[0].properties.names) || Type.isString(arguments[0].properties)))),
            /* Whether Velocity was called via the utility function (as opposed to on a jQuery/Zepto object). */
            isUtility,
            /* When Velocity is called via the utility function ($.Velocity()/Velocity()), elements are explicitly
               passed in as the first parameter. Thus, argument positioning varies. We normalize them here. */
            elementsWrapped,
            argumentIndex;

        var elements,
            propertiesMap,
            options;

        /* Detect jQuery/Zepto elements being animated via the $.fn method. */
        if (Type.isWrapped(this)) {
            isUtility = false;

            argumentIndex = 0;
            elements = this;
            elementsWrapped = this;
        /* Otherwise, raw elements are being animated via the utility function. */
        } else {
            isUtility = true;

            argumentIndex = 1;
            elements = syntacticSugar ? (arguments[0].elements || arguments[0].e) : arguments[0];
        }

        elements = sanitizeElements(elements);

        if (!elements) {
            return;
        }

        if (syntacticSugar) {
            propertiesMap = arguments[0].properties || arguments[0].p;
            options = arguments[0].options || arguments[0].o;
        } else {
            propertiesMap = arguments[argumentIndex];
            options = arguments[argumentIndex + 1];
        }

        /* The length of the element set (in the form of a nodeList or an array of elements) is defaulted to 1 in case a
           single raw DOM element is passed in (which doesn't contain a length property). */
        var elementsLength = elements.length,
            elementsIndex = 0;

        /***************************
            Argument Overloading
        ***************************/

        /* Support is included for jQuery's argument overloading: $.animate(propertyMap [, duration] [, easing] [, complete]).
           Overloading is detected by checking for the absence of an object being passed into options. */
        /* Note: The stop and finish actions do not accept animation options, and are therefore excluded from this check. */
        if (!/^(stop|finish|finishAll)$/i.test(propertiesMap) && !$.isPlainObject(options)) {
            /* The utility function shifts all arguments one position to the right, so we adjust for that offset. */
            var startingArgumentPosition = argumentIndex + 1;

            options = {};

            /* Iterate through all options arguments */
            for (var i = startingArgumentPosition; i < arguments.length; i++) {
                /* Treat a number as a duration. Parse it out. */
                /* Note: The following RegEx will return true if passed an array with a number as its first item.
                   Thus, arrays are skipped from this check. */
                if (!Type.isArray(arguments[i]) && (/^(fast|normal|slow)$/i.test(arguments[i]) || /^\d/.test(arguments[i]))) {
                    options.duration = arguments[i];
                /* Treat strings and arrays as easings. */
                } else if (Type.isString(arguments[i]) || Type.isArray(arguments[i])) {
                    options.easing = arguments[i];
                /* Treat a function as a complete callback. */
                } else if (Type.isFunction(arguments[i])) {
                    options.complete = arguments[i];
                }
            }
        }

        /***************
            Promises
        ***************/

        var promiseData = {
                promise: null,
                resolver: null,
                rejecter: null
            };

        /* If this call was made via the utility function (which is the default method of invocation when jQuery/Zepto are not being used), and if
           promise support was detected, create a promise object for this call and store references to its resolver and rejecter methods. The resolve
           method is used when a call completes naturally or is prematurely stopped by the user. In both cases, completeCall() handles the associated
           call cleanup and promise resolving logic. The reject method is used when an invalid set of arguments is passed into a Velocity call. */
        /* Note: Velocity employs a call-based queueing architecture, which means that stopping an animating element actually stops the full call that
           triggered it -- not that one element exclusively. Similarly, there is one promise per call, and all elements targeted by a Velocity call are
           grouped together for the purposes of resolving and rejecting a promise. */
        if (isUtility && Velocity.Promise) {
            promiseData.promise = new Velocity.Promise(function (resolve, reject) {
                promiseData.resolver = resolve;
                promiseData.rejecter = reject;
            });
        }

        /*********************
           Action Detection
        *********************/

        /* Velocity's behavior is categorized into "actions": Elements can either be specially scrolled into view,
           or they can be started, stopped, or reversed. If a literal or referenced properties map is passed in as Velocity's
           first argument, the associated action is "start". Alternatively, "scroll", "reverse", or "stop" can be passed in instead of a properties map. */
        var action;

        switch (propertiesMap) {
            case "scroll":
                action = "scroll";
                break;

            case "reverse":
                action = "reverse";
                break;

            case "finish":
            case "finishAll":
            case "stop":
                /*******************
                    Action: Stop
                *******************/

                /* Clear the currently-active delay on each targeted element. */
                $.each(elements, function(i, element) {
                    if (Data(element) && Data(element).delayTimer) {
                        /* Stop the timer from triggering its cached next() function. */
                        clearTimeout(Data(element).delayTimer.setTimeout);

                        /* Manually call the next() function so that the subsequent queue items can progress. */
                        if (Data(element).delayTimer.next) {
                            Data(element).delayTimer.next();
                        }

                        delete Data(element).delayTimer;
                    }

                    /* If we want to finish everything in the queue, we have to iterate through it
                       and call each function. This will make them active calls below, which will
                       cause them to be applied via the duration setting. */
                    if (propertiesMap === "finishAll" && (options === true || Type.isString(options))) {
                        /* Iterate through the items in the element's queue. */
                        $.each($.queue(element, Type.isString(options) ? options : ""), function(_, item) {
                            /* The queue array can contain an "inprogress" string, which we skip. */
                            if (Type.isFunction(item)) {
                                item();
                            }
                        });

                        /* Clearing the $.queue() array is achieved by resetting it to []. */
                        $.queue(element, Type.isString(options) ? options : "", []);
                    }
                });

                var callsToStop = [];

                /* When the stop action is triggered, the elements' currently active call is immediately stopped. The active call might have
                   been applied to multiple elements, in which case all of the call's elements will be stopped. When an element
                   is stopped, the next item in its animation queue is immediately triggered. */
                /* An additional argument may be passed in to clear an element's remaining queued calls. Either true (which defaults to the "fx" queue)
                   or a custom queue string can be passed in. */
                /* Note: The stop command runs prior to Velocity's Queueing phase since its behavior is intended to take effect *immediately*,
                   regardless of the element's current queue state. */

                /* Iterate through every active call. */
                $.each(Velocity.State.calls, function(i, activeCall) {
                    /* Inactive calls are set to false by the logic inside completeCall(). Skip them. */
                    if (activeCall) {
                        /* Iterate through the active call's targeted elements. */
                        $.each(activeCall[1], function(k, activeElement) {
                            /* If true was passed in as a secondary argument, clear absolutely all calls on this element. Otherwise, only
                               clear calls associated with the relevant queue. */
                            /* Call stopping logic works as follows:
                               - options === true --> stop current default queue calls (and queue:false calls), including remaining queued ones.
                               - options === undefined --> stop current queue:"" call and all queue:false calls.
                               - options === false --> stop only queue:false calls.
                               - options === "custom" --> stop current queue:"custom" call, including remaining queued ones (there is no functionality to only clear the currently-running queue:"custom" call). */
                            var queueName = (options === undefined) ? "" : options;

                            if (queueName !== true && (activeCall[2].queue !== queueName) && !(options === undefined && activeCall[2].queue === false)) {
                                return true;
                            }

                            /* Iterate through the calls targeted by the stop command. */
                            $.each(elements, function(l, element) {
                                /* Check that this call was applied to the target element. */
                                if (element === activeElement) {
                                    /* Optionally clear the remaining queued calls. If we're doing "finishAll" this won't find anything,
                                       due to the queue-clearing above. */
                                    if (options === true || Type.isString(options)) {
                                        /* Iterate through the items in the element's queue. */
                                        $.each($.queue(element, Type.isString(options) ? options : ""), function(_, item) {
                                            /* The queue array can contain an "inprogress" string, which we skip. */
                                            if (Type.isFunction(item)) {
                                                /* Pass the item's callback a flag indicating that we want to abort from the queue call.
                                                   (Specifically, the queue will resolve the call's associated promise then abort.)  */
                                                item(null, true);
                                            }
                                        });

                                        /* Clearing the $.queue() array is achieved by resetting it to []. */
                                        $.queue(element, Type.isString(options) ? options : "", []);
                                    }

                                    if (propertiesMap === "stop") {
                                        /* Since "reverse" uses cached start values (the previous call's endValues), these values must be
                                           changed to reflect the final value that the elements were actually tweened to. */
                                        /* Note: If only queue:false animations are currently running on an element, it won't have a tweensContainer
                                           object. Also, queue:false animations can't be reversed. */
                                        if (Data(element) && Data(element).tweensContainer && queueName !== false) {
                                            $.each(Data(element).tweensContainer, function(m, activeTween) {
                                                activeTween.endValue = activeTween.currentValue;
                                            });
                                        }

                                        callsToStop.push(i);
                                    } else if (propertiesMap === "finish" || propertiesMap === "finishAll") {
                                        /* To get active tweens to finish immediately, we forcefully shorten their durations to 1ms so that
                                        they finish upon the next rAf tick then proceed with normal call completion logic. */
                                        activeCall[2].duration = 1;
                                    }
                                }
                            });
                        });
                    }
                });

                /* Prematurely call completeCall() on each matched active call. Pass an additional flag for "stop" to indicate
                   that the complete callback and display:none setting should be skipped since we're completing prematurely. */
                if (propertiesMap === "stop") {
                    $.each(callsToStop, function(i, j) {
                        completeCall(j, true);
                    });

                    if (promiseData.promise) {
                        /* Immediately resolve the promise associated with this stop call since stop runs synchronously. */
                        promiseData.resolver(elements);
                    }
                }

                /* Since we're stopping, and not proceeding with queueing, exit out of Velocity. */
                return getChain();

            default:
                /* Treat a non-empty plain object as a literal properties map. */
                if ($.isPlainObject(propertiesMap) && !Type.isEmptyObject(propertiesMap)) {
                    action = "start";

                /****************
                    Redirects
                ****************/

                /* Check if a string matches a registered redirect (see Redirects above). */
                } else if (Type.isString(propertiesMap) && Velocity.Redirects[propertiesMap]) {
                    var opts = $.extend({}, options),
                        durationOriginal = opts.duration,
                        delayOriginal = opts.delay || 0;

                    /* If the backwards option was passed in, reverse the element set so that elements animate from the last to the first. */
                    if (opts.backwards === true) {
                        elements = $.extend(true, [], elements).reverse();
                    }

                    /* Individually trigger the redirect for each element in the set to prevent users from having to handle iteration logic in their redirect. */
                    $.each(elements, function(elementIndex, element) {
                        /* If the stagger option was passed in, successively delay each element by the stagger value (in ms). Retain the original delay value. */
                        if (parseFloat(opts.stagger)) {
                            opts.delay = delayOriginal + (parseFloat(opts.stagger) * elementIndex);
                        } else if (Type.isFunction(opts.stagger)) {
                            opts.delay = delayOriginal + opts.stagger.call(element, elementIndex, elementsLength);
                        }

                        /* If the drag option was passed in, successively increase/decrease (depending on the presense of opts.backwards)
                           the duration of each element's animation, using floors to prevent producing very short durations. */
                        if (opts.drag) {
                            /* Default the duration of UI pack effects (callouts and transitions) to 1000ms instead of the usual default duration of 400ms. */
                            opts.duration = parseFloat(durationOriginal) || (/^(callout|transition)/.test(propertiesMap) ? 1000 : DURATION_DEFAULT);

                            /* For each element, take the greater duration of: A) animation completion percentage relative to the original duration,
                               B) 75% of the original duration, or C) a 200ms fallback (in case duration is already set to a low value).
                               The end result is a baseline of 75% of the redirect's duration that increases/decreases as the end of the element set is approached. */
                            opts.duration = Math.max(opts.duration * (opts.backwards ? 1 - elementIndex/elementsLength : (elementIndex + 1) / elementsLength), opts.duration * 0.75, 200);
                        }

                        /* Pass in the call's opts object so that the redirect can optionally extend it. It defaults to an empty object instead of null to
                           reduce the opts checking logic required inside the redirect. */
                        Velocity.Redirects[propertiesMap].call(element, element, opts || {}, elementIndex, elementsLength, elements, promiseData.promise ? promiseData : undefined);
                    });

                    /* Since the animation logic resides within the redirect's own code, abort the remainder of this call.
                       (The performance overhead up to this point is virtually non-existant.) */
                    /* Note: The jQuery call chain is kept intact by returning the complete element set. */
                    return getChain();
                } else {
                    var abortError = "Velocity: First argument (" + propertiesMap + ") was not a property map, a known action, or a registered redirect. Aborting.";

                    if (promiseData.promise) {
                        promiseData.rejecter(new Error(abortError));
                    } else {
                        console.log(abortError);
                    }

                    return getChain();
                }
        }

        /**************************
            Call-Wide Variables
        **************************/

        /* A container for CSS unit conversion ratios (e.g. %, rem, and em ==> px) that is used to cache ratios across all elements
           being animated in a single Velocity call. Calculating unit ratios necessitates DOM querying and updating, and is therefore
           avoided (via caching) wherever possible. This container is call-wide instead of page-wide to avoid the risk of using stale
           conversion metrics across Velocity animations that are not immediately consecutively chained. */
        var callUnitConversionData = {
                lastParent: null,
                lastPosition: null,
                lastFontSize: null,
                lastPercentToPxWidth: null,
                lastPercentToPxHeight: null,
                lastEmToPx: null,
                remToPx: null,
                vwToPx: null,
                vhToPx: null
            };

        /* A container for all the ensuing tween data and metadata associated with this call. This container gets pushed to the page-wide
           Velocity.State.calls array that is processed during animation ticking. */
        var call = [];

        /************************
           Element Processing
        ************************/

        /* Element processing consists of three parts -- data processing that cannot go stale and data processing that *can* go stale (i.e. third-party style modifications):
           1) Pre-Queueing: Element-wide variables, including the element's data storage, are instantiated. Call options are prepared. If triggered, the Stop action is executed.
           2) Queueing: The logic that runs once this call has reached its point of execution in the element's $.queue() stack. Most logic is placed here to avoid risking it becoming stale.
           3) Pushing: Consolidation of the tween data followed by its push onto the global in-progress calls container.
        */

        function processElement () {

            /*************************
               Part I: Pre-Queueing
            *************************/

            /***************************
               Element-Wide Variables
            ***************************/

            var element = this,
                /* The runtime opts object is the extension of the current call's options and Velocity's page-wide option defaults. */
                opts = $.extend({}, Velocity.defaults, options),
                /* A container for the processed data associated with each property in the propertyMap.
                   (Each property in the map produces its own "tween".) */
                tweensContainer = {},
                elementUnitConversionData;

            /******************
               Element Init
            ******************/

            if (Data(element) === undefined) {
                Velocity.init(element);
            }

            /******************
               Option: Delay
            ******************/

            /* Since queue:false doesn't respect the item's existing queue, we avoid injecting its delay here (it's set later on). */
            /* Note: Velocity rolls its own delay function since jQuery doesn't have a utility alias for $.fn.delay()
               (and thus requires jQuery element creation, which we avoid since its overhead includes DOM querying). */
            if (parseFloat(opts.delay) && opts.queue !== false) {
                $.queue(element, opts.queue, function(next) {
                    /* This is a flag used to indicate to the upcoming completeCall() function that this queue entry was initiated by Velocity. See completeCall() for further details. */
                    Velocity.velocityQueueEntryFlag = true;

                    /* The ensuing queue item (which is assigned to the "next" argument that $.queue() automatically passes in) will be triggered after a setTimeout delay.
                       The setTimeout is stored so that it can be subjected to clearTimeout() if this animation is prematurely stopped via Velocity's "stop" command. */
                    Data(element).delayTimer = {
                        setTimeout: setTimeout(next, parseFloat(opts.delay)),
                        next: next
                    };
                });
            }

            /*********************
               Option: Duration
            *********************/

            /* Support for jQuery's named durations. */
            switch (opts.duration.toString().toLowerCase()) {
                case "fast":
                    opts.duration = 200;
                    break;

                case "normal":
                    opts.duration = DURATION_DEFAULT;
                    break;

                case "slow":
                    opts.duration = 600;
                    break;

                default:
                    /* Remove the potential "ms" suffix and default to 1 if the user is attempting to set a duration of 0 (in order to produce an immediate style change). */
                    opts.duration = parseFloat(opts.duration) || 1;
            }

            /************************
               Global Option: Mock
            ************************/

            if (Velocity.mock !== false) {
                /* In mock mode, all animations are forced to 1ms so that they occur immediately upon the next rAF tick.
                   Alternatively, a multiplier can be passed in to time remap all delays and durations. */
                if (Velocity.mock === true) {
                    opts.duration = opts.delay = 1;
                } else {
                    opts.duration *= parseFloat(Velocity.mock) || 1;
                    opts.delay *= parseFloat(Velocity.mock) || 1;
                }
            }

            /*******************
               Option: Easing
            *******************/

            opts.easing = getEasing(opts.easing, opts.duration);

            /**********************
               Option: Callbacks
            **********************/

            /* Callbacks must functions. Otherwise, default to null. */
            if (opts.begin && !Type.isFunction(opts.begin)) {
                opts.begin = null;
            }

            if (opts.progress && !Type.isFunction(opts.progress)) {
                opts.progress = null;
            }

            if (opts.complete && !Type.isFunction(opts.complete)) {
                opts.complete = null;
            }

            /*********************************
               Option: Display & Visibility
            *********************************/

            /* Refer to Velocity's documentation (VelocityJS.org/#displayAndVisibility) for a description of the display and visibility options' behavior. */
            /* Note: We strictly check for undefined instead of falsiness because display accepts an empty string value. */
            if (opts.display !== undefined && opts.display !== null) {
                opts.display = opts.display.toString().toLowerCase();

                /* Users can pass in a special "auto" value to instruct Velocity to set the element to its default display value. */
                if (opts.display === "auto") {
                    opts.display = Velocity.CSS.Values.getDisplayType(element);
                }
            }

            if (opts.visibility !== undefined && opts.visibility !== null) {
                opts.visibility = opts.visibility.toString().toLowerCase();
            }

            /**********************
               Option: mobileHA
            **********************/

            /* When set to true, and if this is a mobile device, mobileHA automatically enables hardware acceleration (via a null transform hack)
               on animating elements. HA is removed from the element at the completion of its animation. */
            /* Note: Android Gingerbread doesn't support HA. If a null transform hack (mobileHA) is in fact set, it will prevent other tranform subproperties from taking effect. */
            /* Note: You can read more about the use of mobileHA in Velocity's documentation: VelocityJS.org/#mobileHA. */
            opts.mobileHA = (opts.mobileHA && Velocity.State.isMobile && !Velocity.State.isGingerbread);

            /***********************
               Part II: Queueing
            ***********************/

            /* When a set of elements is targeted by a Velocity call, the set is broken up and each element has the current Velocity call individually queued onto it.
               In this way, each element's existing queue is respected; some elements may already be animating and accordingly should not have this current Velocity call triggered immediately. */
            /* In each queue, tween data is processed for each animating property then pushed onto the call-wide calls array. When the last element in the set has had its tweens processed,
               the call array is pushed to Velocity.State.calls for live processing by the requestAnimationFrame tick. */
            function buildQueue (next) {

                /*******************
                   Option: Begin
                *******************/

                /* The begin callback is fired once per call -- not once per elemenet -- and is passed the full raw DOM element set as both its context and its first argument. */
                if (opts.begin && elementsIndex === 0) {
                    /* We throw callbacks in a setTimeout so that thrown errors don't halt the execution of Velocity itself. */
                    try {
                        opts.begin.call(elements, elements);
                    } catch (error) {
                        setTimeout(function() { throw error; }, 1);
                    }
                }

                /*****************************************
                   Tween Data Construction (for Scroll)
                *****************************************/

                /* Note: In order to be subjected to chaining and animation options, scroll's tweening is routed through Velocity as if it were a standard CSS property animation. */
                if (action === "scroll") {
                    /* The scroll action uniquely takes an optional "offset" option -- specified in pixels -- that offsets the targeted scroll position. */
                    var scrollDirection = (/^x$/i.test(opts.axis) ? "Left" : "Top"),
                        scrollOffset = parseFloat(opts.offset) || 0,
                        scrollPositionCurrent,
                        scrollPositionCurrentAlternate,
                        scrollPositionEnd;

                    /* Scroll also uniquely takes an optional "container" option, which indicates the parent element that should be scrolled --
                       as opposed to the browser window itself. This is useful for scrolling toward an element that's inside an overflowing parent element. */
                    if (opts.container) {
                        /* Ensure that either a jQuery object or a raw DOM element was passed in. */
                        if (Type.isWrapped(opts.container) || Type.isNode(opts.container)) {
                            /* Extract the raw DOM element from the jQuery wrapper. */
                            opts.container = opts.container[0] || opts.container;
                            /* Note: Unlike other properties in Velocity, the browser's scroll position is never cached since it so frequently changes
                               (due to the user's natural interaction with the page). */
                            scrollPositionCurrent = opts.container["scroll" + scrollDirection]; /* GET */

                            /* $.position() values are relative to the container's currently viewable area (without taking into account the container's true dimensions
                               -- say, for example, if the container was not overflowing). Thus, the scroll end value is the sum of the child element's position *and*
                               the scroll container's current scroll position. */
                            scrollPositionEnd = (scrollPositionCurrent + $(element).position()[scrollDirection.toLowerCase()]) + scrollOffset; /* GET */
                        /* If a value other than a jQuery object or a raw DOM element was passed in, default to null so that this option is ignored. */
                        } else {
                            opts.container = null;
                        }
                    } else {
                        /* If the window itself is being scrolled -- not a containing element -- perform a live scroll position lookup using
                           the appropriate cached property names (which differ based on browser type). */
                        scrollPositionCurrent = Velocity.State.scrollAnchor[Velocity.State["scrollProperty" + scrollDirection]]; /* GET */
                        /* When scrolling the browser window, cache the alternate axis's current value since window.scrollTo() doesn't let us change only one value at a time. */
                        scrollPositionCurrentAlternate = Velocity.State.scrollAnchor[Velocity.State["scrollProperty" + (scrollDirection === "Left" ? "Top" : "Left")]]; /* GET */

                        /* Unlike $.position(), $.offset() values are relative to the browser window's true dimensions -- not merely its currently viewable area --
                           and therefore end values do not need to be compounded onto current values. */
                        scrollPositionEnd = $(element).offset()[scrollDirection.toLowerCase()] + scrollOffset; /* GET */
                    }

                    /* Since there's only one format that scroll's associated tweensContainer can take, we create it manually. */
                    tweensContainer = {
                        scroll: {
                            rootPropertyValue: false,
                            startValue: scrollPositionCurrent,
                            currentValue: scrollPositionCurrent,
                            endValue: scrollPositionEnd,
                            unitType: "",
                            easing: opts.easing,
                            scrollData: {
                                container: opts.container,
                                direction: scrollDirection,
                                alternateValue: scrollPositionCurrentAlternate
                            }
                        },
                        element: element
                    };

                    if (Velocity.debug) console.log("tweensContainer (scroll): ", tweensContainer.scroll, element);

                /******************************************
                   Tween Data Construction (for Reverse)
                ******************************************/

                /* Reverse acts like a "start" action in that a property map is animated toward. The only difference is
                   that the property map used for reverse is the inverse of the map used in the previous call. Thus, we manipulate
                   the previous call to construct our new map: use the previous map's end values as our new map's start values. Copy over all other data. */
                /* Note: Reverse can be directly called via the "reverse" parameter, or it can be indirectly triggered via the loop option. (Loops are composed of multiple reverses.) */
                /* Note: Reverse calls do not need to be consecutively chained onto a currently-animating element in order to operate on cached values;
                   there is no harm to reverse being called on a potentially stale data cache since reverse's behavior is simply defined
                   as reverting to the element's values as they were prior to the previous *Velocity* call. */
                } else if (action === "reverse") {
                    /* Abort if there is no prior animation data to reverse to. */
                    if (!Data(element).tweensContainer) {
                        /* Dequeue the element so that this queue entry releases itself immediately, allowing subsequent queue entries to run. */
                        $.dequeue(element, opts.queue);

                        return;
                    } else {
                        /*********************
                           Options Parsing
                        *********************/

                        /* If the element was hidden via the display option in the previous call,
                           revert display to "auto" prior to reversal so that the element is visible again. */
                        if (Data(element).opts.display === "none") {
                            Data(element).opts.display = "auto";
                        }

                        if (Data(element).opts.visibility === "hidden") {
                            Data(element).opts.visibility = "visible";
                        }

                        /* If the loop option was set in the previous call, disable it so that "reverse" calls aren't recursively generated.
                           Further, remove the previous call's callback options; typically, users do not want these to be refired. */
                        Data(element).opts.loop = false;
                        Data(element).opts.begin = null;
                        Data(element).opts.complete = null;

                        /* Since we're extending an opts object that has already been extended with the defaults options object,
                           we remove non-explicitly-defined properties that are auto-assigned values. */
                        if (!options.easing) {
                            delete opts.easing;
                        }

                        if (!options.duration) {
                            delete opts.duration;
                        }

                        /* The opts object used for reversal is an extension of the options object optionally passed into this
                           reverse call plus the options used in the previous Velocity call. */
                        opts = $.extend({}, Data(element).opts, opts);

                        /*************************************
                           Tweens Container Reconstruction
                        *************************************/

                        /* Create a deepy copy (indicated via the true flag) of the previous call's tweensContainer. */
                        var lastTweensContainer = $.extend(true, {}, Data(element).tweensContainer);

                        /* Manipulate the previous tweensContainer by replacing its end values and currentValues with its start values. */
                        for (var lastTween in lastTweensContainer) {
                            /* In addition to tween data, tweensContainers contain an element property that we ignore here. */
                            if (lastTween !== "element") {
                                var lastStartValue = lastTweensContainer[lastTween].startValue;

                                lastTweensContainer[lastTween].startValue = lastTweensContainer[lastTween].currentValue = lastTweensContainer[lastTween].endValue;
                                lastTweensContainer[lastTween].endValue = lastStartValue;

                                /* Easing is the only option that embeds into the individual tween data (since it can be defined on a per-property basis).
                                   Accordingly, every property's easing value must be updated when an options object is passed in with a reverse call.
                                   The side effect of this extensibility is that all per-property easing values are forcefully reset to the new value. */
                                if (!Type.isEmptyObject(options)) {
                                    lastTweensContainer[lastTween].easing = opts.easing;
                                }

                                if (Velocity.debug) console.log("reverse tweensContainer (" + lastTween + "): " + JSON.stringify(lastTweensContainer[lastTween]), element);
                            }
                        }

                        tweensContainer = lastTweensContainer;
                    }

                /*****************************************
                   Tween Data Construction (for Start)
                *****************************************/

                } else if (action === "start") {

                    /*************************
                        Value Transferring
                    *************************/

                    /* If this queue entry follows a previous Velocity-initiated queue entry *and* if this entry was created
                       while the element was in the process of being animated by Velocity, then this current call is safe to use
                       the end values from the prior call as its start values. Velocity attempts to perform this value transfer
                       process whenever possible in order to avoid requerying the DOM. */
                    /* If values aren't transferred from a prior call and start values were not forcefed by the user (more on this below),
                       then the DOM is queried for the element's current values as a last resort. */
                    /* Note: Conversely, animation reversal (and looping) *always* perform inter-call value transfers; they never requery the DOM. */
                    var lastTweensContainer;

                    /* The per-element isAnimating flag is used to indicate whether it's safe (i.e. the data isn't stale)
                       to transfer over end values to use as start values. If it's set to true and there is a previous
                       Velocity call to pull values from, do so. */
                    if (Data(element).tweensContainer && Data(element).isAnimating === true) {
                        lastTweensContainer = Data(element).tweensContainer;
                    }

                    /***************************
                       Tween Data Calculation
                    ***************************/

                    /* This function parses property data and defaults endValue, easing, and startValue as appropriate. */
                    /* Property map values can either take the form of 1) a single value representing the end value,
                       or 2) an array in the form of [ endValue, [, easing] [, startValue] ].
                       The optional third parameter is a forcefed startValue to be used instead of querying the DOM for
                       the element's current value. Read Velocity's docmentation to learn more about forcefeeding: VelocityJS.org/#forcefeeding */
                    function parsePropertyValue (valueData, skipResolvingEasing) {
                        var endValue = undefined,
                            easing = undefined,
                            startValue = undefined;

                        /* Handle the array format, which can be structured as one of three potential overloads:
                           A) [ endValue, easing, startValue ], B) [ endValue, easing ], or C) [ endValue, startValue ] */
                        if (Type.isArray(valueData)) {
                            /* endValue is always the first item in the array. Don't bother validating endValue's value now
                               since the ensuing property cycling logic does that. */
                            endValue = valueData[0];

                            /* Two-item array format: If the second item is a number, function, or hex string, treat it as a
                               start value since easings can only be non-hex strings or arrays. */
                            if ((!Type.isArray(valueData[1]) && /^[\d-]/.test(valueData[1])) || Type.isFunction(valueData[1]) || CSS.RegEx.isHex.test(valueData[1])) {
                                startValue = valueData[1];
                            /* Two or three-item array: If the second item is a non-hex string or an array, treat it as an easing. */
                            } else if ((Type.isString(valueData[1]) && !CSS.RegEx.isHex.test(valueData[1])) || Type.isArray(valueData[1])) {
                                easing = skipResolvingEasing ? valueData[1] : getEasing(valueData[1], opts.duration);

                                /* Don't bother validating startValue's value now since the ensuing property cycling logic inherently does that. */
                                if (valueData[2] !== undefined) {
                                    startValue = valueData[2];
                                }
                            }
                        /* Handle the single-value format. */
                        } else {
                            endValue = valueData;
                        }

                        /* Default to the call's easing if a per-property easing type was not defined. */
                        if (!skipResolvingEasing) {
                            easing = easing || opts.easing;
                        }

                        /* If functions were passed in as values, pass the function the current element as its context,
                           plus the element's index and the element set's size as arguments. Then, assign the returned value. */
                        if (Type.isFunction(endValue)) {
                            endValue = endValue.call(element, elementsIndex, elementsLength);
                        }

                        if (Type.isFunction(startValue)) {
                            startValue = startValue.call(element, elementsIndex, elementsLength);
                        }

                        /* Allow startValue to be left as undefined to indicate to the ensuing code that its value was not forcefed. */
                        return [ endValue || 0, easing, startValue ];
                    }

                    /* Cycle through each property in the map, looking for shorthand color properties (e.g. "color" as opposed to "colorRed"). Inject the corresponding
                       colorRed, colorGreen, and colorBlue RGB component tweens into the propertiesMap (which Velocity understands) and remove the shorthand property. */
                    $.each(propertiesMap, function(property, value) {
                        /* Find shorthand color properties that have been passed a hex string. */
                        if (RegExp("^" + CSS.Lists.colors.join("$|^") + "$").test(property)) {
                            /* Parse the value data for each shorthand. */
                            var valueData = parsePropertyValue(value, true),
                                endValue = valueData[0],
                                easing = valueData[1],
                                startValue = valueData[2];

                            if (CSS.RegEx.isHex.test(endValue)) {
                                /* Convert the hex strings into their RGB component arrays. */
                                var colorComponents = [ "Red", "Green", "Blue" ],
                                    endValueRGB = CSS.Values.hexToRgb(endValue),
                                    startValueRGB = startValue ? CSS.Values.hexToRgb(startValue) : undefined;

                                /* Inject the RGB component tweens into propertiesMap. */
                                for (var i = 0; i < colorComponents.length; i++) {
                                    var dataArray = [ endValueRGB[i] ];

                                    if (easing) {
                                        dataArray.push(easing);
                                    }

                                    if (startValueRGB !== undefined) {
                                        dataArray.push(startValueRGB[i]);
                                    }

                                    propertiesMap[property + colorComponents[i]] = dataArray;
                                }

                                /* Remove the intermediary shorthand property entry now that we've processed it. */
                                delete propertiesMap[property];
                            }
                        }
                    });

                    /* Create a tween out of each property, and append its associated data to tweensContainer. */
                    for (var property in propertiesMap) {

                        /**************************
                           Start Value Sourcing
                        **************************/

                        /* Parse out endValue, easing, and startValue from the property's data. */
                        var valueData = parsePropertyValue(propertiesMap[property]),
                            endValue = valueData[0],
                            easing = valueData[1],
                            startValue = valueData[2];

                        /* Now that the original property name's format has been used for the parsePropertyValue() lookup above,
                           we force the property to its camelCase styling to normalize it for manipulation. */
                        property = CSS.Names.camelCase(property);

                        /* In case this property is a hook, there are circumstances where we will intend to work on the hook's root property and not the hooked subproperty. */
                        var rootProperty = CSS.Hooks.getRoot(property),
                            rootPropertyValue = false;

                        /* Other than for the dummy tween property, properties that are not supported by the browser (and do not have an associated normalization) will
                           inherently produce no style changes when set, so they are skipped in order to decrease animation tick overhead.
                           Property support is determined via prefixCheck(), which returns a false flag when no supported is detected. */
                        /* Note: Since SVG elements have some of their properties directly applied as HTML attributes,
                           there is no way to check for their explicit browser support, and so we skip skip this check for them. */
                        if (!Data(element).isSVG && rootProperty !== "tween" && CSS.Names.prefixCheck(rootProperty)[1] === false && CSS.Normalizations.registered[rootProperty] === undefined) {
                            if (Velocity.debug) console.log("Skipping [" + rootProperty + "] due to a lack of browser support.");

                            continue;
                        }

                        /* If the display option is being set to a non-"none" (e.g. "block") and opacity (filter on IE<=8) is being
                           animated to an endValue of non-zero, the user's intention is to fade in from invisible, thus we forcefeed opacity
                           a startValue of 0 if its startValue hasn't already been sourced by value transferring or prior forcefeeding. */
                        if (((opts.display !== undefined && opts.display !== null && opts.display !== "none") || (opts.visibility !== undefined && opts.visibility !== "hidden")) && /opacity|filter/.test(property) && !startValue && endValue !== 0) {
                            startValue = 0;
                        }

                        /* If values have been transferred from the previous Velocity call, extract the endValue and rootPropertyValue
                           for all of the current call's properties that were *also* animated in the previous call. */
                        /* Note: Value transferring can optionally be disabled by the user via the _cacheValues option. */
                        if (opts._cacheValues && lastTweensContainer && lastTweensContainer[property]) {
                            if (startValue === undefined) {
                                startValue = lastTweensContainer[property].endValue + lastTweensContainer[property].unitType;
                            }

                            /* The previous call's rootPropertyValue is extracted from the element's data cache since that's the
                               instance of rootPropertyValue that gets freshly updated by the tweening process, whereas the rootPropertyValue
                               attached to the incoming lastTweensContainer is equal to the root property's value prior to any tweening. */
                            rootPropertyValue = Data(element).rootPropertyValueCache[rootProperty];
                        /* If values were not transferred from a previous Velocity call, query the DOM as needed. */
                        } else {
                            /* Handle hooked properties. */
                            if (CSS.Hooks.registered[property]) {
                               if (startValue === undefined) {
                                    rootPropertyValue = CSS.getPropertyValue(element, rootProperty); /* GET */
                                    /* Note: The following getPropertyValue() call does not actually trigger a DOM query;
                                       getPropertyValue() will extract the hook from rootPropertyValue. */
                                    startValue = CSS.getPropertyValue(element, property, rootPropertyValue);
                                /* If startValue is already defined via forcefeeding, do not query the DOM for the root property's value;
                                   just grab rootProperty's zero-value template from CSS.Hooks. This overwrites the element's actual
                                   root property value (if one is set), but this is acceptable since the primary reason users forcefeed is
                                   to avoid DOM queries, and thus we likewise avoid querying the DOM for the root property's value. */
                                } else {
                                    /* Grab this hook's zero-value template, e.g. "0px 0px 0px black". */
                                    rootPropertyValue = CSS.Hooks.templates[rootProperty][1];
                                }
                            /* Handle non-hooked properties that haven't already been defined via forcefeeding. */
                            } else if (startValue === undefined) {
                                startValue = CSS.getPropertyValue(element, property); /* GET */
                            }
                        }

                        /**************************
                           Value Data Extraction
                        **************************/

                        var separatedValue,
                            endValueUnitType,
                            startValueUnitType,
                            operator = false;

                        /* Separates a property value into its numeric value and its unit type. */
                        function separateValue (property, value) {
                            var unitType,
                                numericValue;

                            numericValue = (value || "0")
                                .toString()
                                .toLowerCase()
                                /* Match the unit type at the end of the value. */
                                .replace(/[%A-z]+$/, function(match) {
                                    /* Grab the unit type. */
                                    unitType = match;

                                    /* Strip the unit type off of value. */
                                    return "";
                                });

                            /* If no unit type was supplied, assign one that is appropriate for this property (e.g. "deg" for rotateZ or "px" for width). */
                            if (!unitType) {
                                unitType = CSS.Values.getUnitType(property);
                            }

                            return [ numericValue, unitType ];
                        }

                        /* Separate startValue. */
                        separatedValue = separateValue(property, startValue);
                        startValue = separatedValue[0];
                        startValueUnitType = separatedValue[1];

                        /* Separate endValue, and extract a value operator (e.g. "+=", "-=") if one exists. */
                        separatedValue = separateValue(property, endValue);
                        endValue = separatedValue[0].replace(/^([+-\/*])=/, function(match, subMatch) {
                            operator = subMatch;

                            /* Strip the operator off of the value. */
                            return "";
                        });
                        endValueUnitType = separatedValue[1];

                        /* Parse float values from endValue and startValue. Default to 0 if NaN is returned. */
                        startValue = parseFloat(startValue) || 0;
                        endValue = parseFloat(endValue) || 0;

                        /***************************************
                           Property-Specific Value Conversion
                        ***************************************/

                        /* Custom support for properties that don't actually accept the % unit type, but where pollyfilling is trivial and relatively foolproof. */
                        if (endValueUnitType === "%") {
                            /* A %-value fontSize/lineHeight is relative to the parent's fontSize (as opposed to the parent's dimensions),
                               which is identical to the em unit's behavior, so we piggyback off of that. */
                            if (/^(fontSize|lineHeight)$/.test(property)) {
                                /* Convert % into an em decimal value. */
                                endValue = endValue / 100;
                                endValueUnitType = "em";
                            /* For scaleX and scaleY, convert the value into its decimal format and strip off the unit type. */
                            } else if (/^scale/.test(property)) {
                                endValue = endValue / 100;
                                endValueUnitType = "";
                            /* For RGB components, take the defined percentage of 255 and strip off the unit type. */
                            } else if (/(Red|Green|Blue)$/i.test(property)) {
                                endValue = (endValue / 100) * 255;
                                endValueUnitType = "";
                            }
                        }

                        /***************************
                           Unit Ratio Calculation
                        ***************************/

                        /* When queried, the browser returns (most) CSS property values in pixels. Therefore, if an endValue with a unit type of
                           %, em, or rem is animated toward, startValue must be converted from pixels into the same unit type as endValue in order
                           for value manipulation logic (increment/decrement) to proceed. Further, if the startValue was forcefed or transferred
                           from a previous call, startValue may also not be in pixels. Unit conversion logic therefore consists of two steps:
                           1) Calculating the ratio of %/em/rem/vh/vw relative to pixels
                           2) Converting startValue into the same unit of measurement as endValue based on these ratios. */
                        /* Unit conversion ratios are calculated by inserting a sibling node next to the target node, copying over its position property,
                           setting values with the target unit type then comparing the returned pixel value. */
                        /* Note: Even if only one of these unit types is being animated, all unit ratios are calculated at once since the overhead
                           of batching the SETs and GETs together upfront outweights the potential overhead
                           of layout thrashing caused by re-querying for uncalculated ratios for subsequently-processed properties. */
                        /* Todo: Shift this logic into the calls' first tick instance so that it's synced with RAF. */
                        function calculateUnitRatios () {

                            /************************
                                Same Ratio Checks
                            ************************/

                            /* The properties below are used to determine whether the element differs sufficiently from this call's
                               previously iterated element to also differ in its unit conversion ratios. If the properties match up with those
                               of the prior element, the prior element's conversion ratios are used. Like most optimizations in Velocity,
                               this is done to minimize DOM querying. */
                            var sameRatioIndicators = {
                                    myParent: element.parentNode || document.body, /* GET */
                                    position: CSS.getPropertyValue(element, "position"), /* GET */
                                    fontSize: CSS.getPropertyValue(element, "fontSize") /* GET */
                                },
                                /* Determine if the same % ratio can be used. % is based on the element's position value and its parent's width and height dimensions. */
                                samePercentRatio = ((sameRatioIndicators.position === callUnitConversionData.lastPosition) && (sameRatioIndicators.myParent === callUnitConversionData.lastParent)),
                                /* Determine if the same em ratio can be used. em is relative to the element's fontSize. */
                                sameEmRatio = (sameRatioIndicators.fontSize === callUnitConversionData.lastFontSize);

                            /* Store these ratio indicators call-wide for the next element to compare against. */
                            callUnitConversionData.lastParent = sameRatioIndicators.myParent;
                            callUnitConversionData.lastPosition = sameRatioIndicators.position;
                            callUnitConversionData.lastFontSize = sameRatioIndicators.fontSize;

                            /***************************
                               Element-Specific Units
                            ***************************/

                            /* Note: IE8 rounds to the nearest pixel when returning CSS values, thus we perform conversions using a measurement
                               of 100 (instead of 1) to give our ratios a precision of at least 2 decimal values. */
                            var measurement = 100,
                                unitRatios = {};

                            if (!sameEmRatio || !samePercentRatio) {
                                var dummy = Data(element).isSVG ? document.createElementNS("http://www.w3.org/2000/svg", "rect") : document.createElement("div");

                                Velocity.init(dummy);
                                sameRatioIndicators.myParent.appendChild(dummy);

                                /* To accurately and consistently calculate conversion ratios, the element's cascaded overflow and box-sizing are stripped.
                                   Similarly, since width/height can be artificially constrained by their min-/max- equivalents, these are controlled for as well. */
                                /* Note: Overflow must be also be controlled for per-axis since the overflow property overwrites its per-axis values. */
                                $.each([ "overflow", "overflowX", "overflowY" ], function(i, property) {
                                    Velocity.CSS.setPropertyValue(dummy, property, "hidden");
                                });
                                Velocity.CSS.setPropertyValue(dummy, "position", sameRatioIndicators.position);
                                Velocity.CSS.setPropertyValue(dummy, "fontSize", sameRatioIndicators.fontSize);
                                Velocity.CSS.setPropertyValue(dummy, "boxSizing", "content-box");

                                /* width and height act as our proxy properties for measuring the horizontal and vertical % ratios. */
                                $.each([ "minWidth", "maxWidth", "width", "minHeight", "maxHeight", "height" ], function(i, property) {
                                    Velocity.CSS.setPropertyValue(dummy, property, measurement + "%");
                                });
                                /* paddingLeft arbitrarily acts as our proxy property for the em ratio. */
                                Velocity.CSS.setPropertyValue(dummy, "paddingLeft", measurement + "em");

                                /* Divide the returned value by the measurement to get the ratio between 1% and 1px. Default to 1 since working with 0 can produce Infinite. */
                                unitRatios.percentToPxWidth = callUnitConversionData.lastPercentToPxWidth = (parseFloat(CSS.getPropertyValue(dummy, "width", null, true)) || 1) / measurement; /* GET */
                                unitRatios.percentToPxHeight = callUnitConversionData.lastPercentToPxHeight = (parseFloat(CSS.getPropertyValue(dummy, "height", null, true)) || 1) / measurement; /* GET */
                                unitRatios.emToPx = callUnitConversionData.lastEmToPx = (parseFloat(CSS.getPropertyValue(dummy, "paddingLeft")) || 1) / measurement; /* GET */

                                sameRatioIndicators.myParent.removeChild(dummy);
                            } else {
                                unitRatios.emToPx = callUnitConversionData.lastEmToPx;
                                unitRatios.percentToPxWidth = callUnitConversionData.lastPercentToPxWidth;
                                unitRatios.percentToPxHeight = callUnitConversionData.lastPercentToPxHeight;
                            }

                            /***************************
                               Element-Agnostic Units
                            ***************************/

                            /* Whereas % and em ratios are determined on a per-element basis, the rem unit only needs to be checked
                               once per call since it's exclusively dependant upon document.body's fontSize. If this is the first time
                               that calculateUnitRatios() is being run during this call, remToPx will still be set to its default value of null,
                               so we calculate it now. */
                            if (callUnitConversionData.remToPx === null) {
                                /* Default to browsers' default fontSize of 16px in the case of 0. */
                                callUnitConversionData.remToPx = parseFloat(CSS.getPropertyValue(document.body, "fontSize")) || 16; /* GET */
                            }

                            /* Similarly, viewport units are %-relative to the window's inner dimensions. */
                            if (callUnitConversionData.vwToPx === null) {
                                callUnitConversionData.vwToPx = parseFloat(window.innerWidth) / 100; /* GET */
                                callUnitConversionData.vhToPx = parseFloat(window.innerHeight) / 100; /* GET */
                            }

                            unitRatios.remToPx = callUnitConversionData.remToPx;
                            unitRatios.vwToPx = callUnitConversionData.vwToPx;
                            unitRatios.vhToPx = callUnitConversionData.vhToPx;

                            if (Velocity.debug >= 1) console.log("Unit ratios: " + JSON.stringify(unitRatios), element);

                            return unitRatios;
                        }

                        /********************
                           Unit Conversion
                        ********************/

                        /* The * and / operators, which are not passed in with an associated unit, inherently use startValue's unit. Skip value and unit conversion. */
                        if (/[\/*]/.test(operator)) {
                            endValueUnitType = startValueUnitType;
                        /* If startValue and endValue differ in unit type, convert startValue into the same unit type as endValue so that if endValueUnitType
                           is a relative unit (%, em, rem), the values set during tweening will continue to be accurately relative even if the metrics they depend
                           on are dynamically changing during the course of the animation. Conversely, if we always normalized into px and used px for setting values, the px ratio
                           would become stale if the original unit being animated toward was relative and the underlying metrics change during the animation. */
                        /* Since 0 is 0 in any unit type, no conversion is necessary when startValue is 0 -- we just start at 0 with endValueUnitType. */
                        } else if ((startValueUnitType !== endValueUnitType) && startValue !== 0) {
                            /* Unit conversion is also skipped when endValue is 0, but *startValueUnitType* must be used for tween values to remain accurate. */
                            /* Note: Skipping unit conversion here means that if endValueUnitType was originally a relative unit, the animation won't relatively
                               match the underlying metrics if they change, but this is acceptable since we're animating toward invisibility instead of toward visibility,
                               which remains past the point of the animation's completion. */
                            if (endValue === 0) {
                                endValueUnitType = startValueUnitType;
                            } else {
                                /* By this point, we cannot avoid unit conversion (it's undesirable since it causes layout thrashing).
                                   If we haven't already, we trigger calculateUnitRatios(), which runs once per element per call. */
                                elementUnitConversionData = elementUnitConversionData || calculateUnitRatios();

                                /* The following RegEx matches CSS properties that have their % values measured relative to the x-axis. */
                                /* Note: W3C spec mandates that all of margin and padding's properties (even top and bottom) are %-relative to the *width* of the parent element. */
                                var axis = (/margin|padding|left|right|width|text|word|letter/i.test(property) || /X$/.test(property) || property === "x") ? "x" : "y";

                                /* In order to avoid generating n^2 bespoke conversion functions, unit conversion is a two-step process:
                                   1) Convert startValue into pixels. 2) Convert this new pixel value into endValue's unit type. */
                                switch (startValueUnitType) {
                                    case "%":
                                        /* Note: translateX and translateY are the only properties that are %-relative to an element's own dimensions -- not its parent's dimensions.
                                           Velocity does not include a special conversion process to account for this behavior. Therefore, animating translateX/Y from a % value
                                           to a non-% value will produce an incorrect start value. Fortunately, this sort of cross-unit conversion is rarely done by users in practice. */
                                        startValue *= (axis === "x" ? elementUnitConversionData.percentToPxWidth : elementUnitConversionData.percentToPxHeight);
                                        break;

                                    case "px":
                                        /* px acts as our midpoint in the unit conversion process; do nothing. */
                                        break;

                                    default:
                                        startValue *= elementUnitConversionData[startValueUnitType + "ToPx"];
                                }

                                /* Invert the px ratios to convert into to the target unit. */
                                switch (endValueUnitType) {
                                    case "%":
                                        startValue *= 1 / (axis === "x" ? elementUnitConversionData.percentToPxWidth : elementUnitConversionData.percentToPxHeight);
                                        break;

                                    case "px":
                                        /* startValue is already in px, do nothing; we're done. */
                                        break;

                                    default:
                                        startValue *= 1 / elementUnitConversionData[endValueUnitType + "ToPx"];
                                }
                            }
                        }

                        /*********************
                           Relative Values
                        *********************/

                        /* Operator logic must be performed last since it requires unit-normalized start and end values. */
                        /* Note: Relative *percent values* do not behave how most people think; while one would expect "+=50%"
                           to increase the property 1.5x its current value, it in fact increases the percent units in absolute terms:
                           50 points is added on top of the current % value. */
                        switch (operator) {
                            case "+":
                                endValue = startValue + endValue;
                                break;

                            case "-":
                                endValue = startValue - endValue;
                                break;

                            case "*":
                                endValue = startValue * endValue;
                                break;

                            case "/":
                                endValue = startValue / endValue;
                                break;
                        }

                        /**************************
                           tweensContainer Push
                        **************************/

                        /* Construct the per-property tween object, and push it to the element's tweensContainer. */
                        tweensContainer[property] = {
                            rootPropertyValue: rootPropertyValue,
                            startValue: startValue,
                            currentValue: startValue,
                            endValue: endValue,
                            unitType: endValueUnitType,
                            easing: easing
                        };

                        if (Velocity.debug) console.log("tweensContainer (" + property + "): " + JSON.stringify(tweensContainer[property]), element);
                    }

                    /* Along with its property data, store a reference to the element itself onto tweensContainer. */
                    tweensContainer.element = element;
                }

                /*****************
                    Call Push
                *****************/

                /* Note: tweensContainer can be empty if all of the properties in this call's property map were skipped due to not
                   being supported by the browser. The element property is used for checking that the tweensContainer has been appended to. */
                if (tweensContainer.element) {
                    /* Apply the "velocity-animating" indicator class. */
                    CSS.Values.addClass(element, "velocity-animating");

                    /* The call array houses the tweensContainers for each element being animated in the current call. */
                    call.push(tweensContainer);

                    /* Store the tweensContainer and options if we're working on the default effects queue, so that they can be used by the reverse command. */
                    if (opts.queue === "") {
                        Data(element).tweensContainer = tweensContainer;
                        Data(element).opts = opts;
                    }

                    /* Switch on the element's animating flag. */
                    Data(element).isAnimating = true;

                    /* Once the final element in this call's element set has been processed, push the call array onto
                       Velocity.State.calls for the animation tick to immediately begin processing. */
                    if (elementsIndex === elementsLength - 1) {
                        /* Add the current call plus its associated metadata (the element set and the call's options) onto the global call container.
                           Anything on this call container is subjected to tick() processing. */
                        Velocity.State.calls.push([ call, elements, opts, null, promiseData.resolver ]);

                        /* If the animation tick isn't running, start it. (Velocity shuts it off when there are no active calls to process.) */
                        if (Velocity.State.isTicking === false) {
                            Velocity.State.isTicking = true;

                            /* Start the tick loop. */
                            tick();
                        }
                    } else {
                        elementsIndex++;
                    }
                }
            }

            /* When the queue option is set to false, the call skips the element's queue and fires immediately. */
            if (opts.queue === false) {
                /* Since this buildQueue call doesn't respect the element's existing queue (which is where a delay option would have been appended),
                   we manually inject the delay property here with an explicit setTimeout. */
                if (opts.delay) {
                    setTimeout(buildQueue, opts.delay);
                } else {
                    buildQueue();
                }
            /* Otherwise, the call undergoes element queueing as normal. */
            /* Note: To interoperate with jQuery, Velocity uses jQuery's own $.queue() stack for queuing logic. */
            } else {
                $.queue(element, opts.queue, function(next, clearQueue) {
                    /* If the clearQueue flag was passed in by the stop command, resolve this call's promise. (Promises can only be resolved once,
                       so it's fine if this is repeatedly triggered for each element in the associated call.) */
                    if (clearQueue === true) {
                        if (promiseData.promise) {
                            promiseData.resolver(elements);
                        }

                        /* Do not continue with animation queueing. */
                        return true;
                    }

                    /* This flag indicates to the upcoming completeCall() function that this queue entry was initiated by Velocity.
                       See completeCall() for further details. */
                    Velocity.velocityQueueEntryFlag = true;

                    buildQueue(next);
                });
            }

            /*********************
                Auto-Dequeuing
            *********************/

            /* As per jQuery's $.queue() behavior, to fire the first non-custom-queue entry on an element, the element
               must be dequeued if its queue stack consists *solely* of the current call. (This can be determined by checking
               for the "inprogress" item that jQuery prepends to active queue stack arrays.) Regardless, whenever the element's
               queue is further appended with additional items -- including $.delay()'s or even $.animate() calls, the queue's
               first entry is automatically fired. This behavior contrasts that of custom queues, which never auto-fire. */
            /* Note: When an element set is being subjected to a non-parallel Velocity call, the animation will not begin until
               each one of the elements in the set has reached the end of its individually pre-existing queue chain. */
            /* Note: Unfortunately, most people don't fully grasp jQuery's powerful, yet quirky, $.queue() function.
               Lean more here: http://stackoverflow.com/questions/1058158/can-somebody-explain-jquery-queue-to-me */
            if ((opts.queue === "" || opts.queue === "fx") && $.queue(element)[0] !== "inprogress") {
                $.dequeue(element);
            }
        }

        /**************************
           Element Set Iteration
        **************************/

        /* If the "nodeType" property exists on the elements variable, we're animating a single element.
           Place it in an array so that $.each() can iterate over it. */
        $.each(elements, function(i, element) {
            /* Ensure each element in a set has a nodeType (is a real element) to avoid throwing errors. */
            if (Type.isNode(element)) {
                processElement.call(element);
            }
        });

        /******************
           Option: Loop
        ******************/

        /* The loop option accepts an integer indicating how many times the element should loop between the values in the
           current call's properties map and the element's property values prior to this call. */
        /* Note: The loop option's logic is performed here -- after element processing -- because the current call needs
           to undergo its queue insertion prior to the loop option generating its series of constituent "reverse" calls,
           which chain after the current call. Two reverse calls (two "alternations") constitute one loop. */
        var opts = $.extend({}, Velocity.defaults, options),
            reverseCallsCount;

        opts.loop = parseInt(opts.loop);
        reverseCallsCount = (opts.loop * 2) - 1;

        if (opts.loop) {
            /* Double the loop count to convert it into its appropriate number of "reverse" calls.
               Subtract 1 from the resulting value since the current call is included in the total alternation count. */
            for (var x = 0; x < reverseCallsCount; x++) {
                /* Since the logic for the reverse action occurs inside Queueing and therefore this call's options object
                   isn't parsed until then as well, the current call's delay option must be explicitly passed into the reverse
                   call so that the delay logic that occurs inside *Pre-Queueing* can process it. */
                var reverseOptions = {
                    delay: opts.delay,
                    progress: opts.progress
                };

                /* If a complete callback was passed into this call, transfer it to the loop redirect's final "reverse" call
                   so that it's triggered when the entire redirect is complete (and not when the very first animation is complete). */
                if (x === reverseCallsCount - 1) {
                    reverseOptions.display = opts.display;
                    reverseOptions.visibility = opts.visibility;
                    reverseOptions.complete = opts.complete;
                }

                animate(elements, "reverse", reverseOptions);
            }
        }

        /***************
            Chaining
        ***************/

        /* Return the elements back to the call chain, with wrapped elements taking precedence in case Velocity was called via the $.fn. extension. */
        return getChain();
    };

    /* Turn Velocity into the animation function, extended with the pre-existing Velocity object. */
    Velocity = $.extend(animate, Velocity);
    /* For legacy support, also expose the literal animate method. */
    Velocity.animate = animate;

    /**************
        Timing
    **************/

    /* Ticker function. */
    var ticker = window.requestAnimationFrame || rAFShim;

    /* Inactive browser tabs pause rAF, which results in all active animations immediately sprinting to their completion states when the tab refocuses.
       To get around this, we dynamically switch rAF to setTimeout (which the browser *doesn't* pause) when the tab loses focus. We skip this for mobile
       devices to avoid wasting battery power on inactive tabs. */
    /* Note: Tab focus detection doesn't work on older versions of IE, but that's okay since they don't support rAF to begin with. */
    if (!Velocity.State.isMobile && document.hidden !== undefined) {
        document.addEventListener("visibilitychange", function() {
            /* Reassign the rAF function (which the global tick() function uses) based on the tab's focus state. */
            if (document.hidden) {
                ticker = function(callback) {
                    /* The tick function needs a truthy first argument in order to pass its internal timestamp check. */
                    return setTimeout(function() { callback(true) }, 16);
                };

                /* The rAF loop has been paused by the browser, so we manually restart the tick. */
                tick();
            } else {
                ticker = window.requestAnimationFrame || rAFShim;
            }
        });
    }

    /************
        Tick
    ************/

    /* Note: All calls to Velocity are pushed to the Velocity.State.calls array, which is fully iterated through upon each tick. */
    function tick (timestamp) {
        /* An empty timestamp argument indicates that this is the first tick occurence since ticking was turned on.
           We leverage this metadata to fully ignore the first tick pass since RAF's initial pass is fired whenever
           the browser's next tick sync time occurs, which results in the first elements subjected to Velocity
           calls being animated out of sync with any elements animated immediately thereafter. In short, we ignore
           the first RAF tick pass so that elements being immediately consecutively animated -- instead of simultaneously animated
           by the same Velocity call -- are properly batched into the same initial RAF tick and consequently remain in sync thereafter. */
        if (timestamp) {
            /* We ignore RAF's high resolution timestamp since it can be significantly offset when the browser is
               under high stress; we opt for choppiness over allowing the browser to drop huge chunks of frames. */
            var timeCurrent = (new Date).getTime();

            /********************
               Call Iteration
            ********************/

            var callsLength = Velocity.State.calls.length;

            /* To speed up iterating over this array, it is compacted (falsey items -- calls that have completed -- are removed)
               when its length has ballooned to a point that can impact tick performance. This only becomes necessary when animation
               has been continuous with many elements over a long period of time; whenever all active calls are completed, completeCall() clears Velocity.State.calls. */
            if (callsLength > 10000) {
                Velocity.State.calls = compactSparseArray(Velocity.State.calls);
            }

            /* Iterate through each active call. */
            for (var i = 0; i < callsLength; i++) {
                /* When a Velocity call is completed, its Velocity.State.calls entry is set to false. Continue on to the next call. */
                if (!Velocity.State.calls[i]) {
                    continue;
                }

                /************************
                   Call-Wide Variables
                ************************/

                var callContainer = Velocity.State.calls[i],
                    call = callContainer[0],
                    opts = callContainer[2],
                    timeStart = callContainer[3],
                    firstTick = !!timeStart,
                    tweenDummyValue = null;

                /* If timeStart is undefined, then this is the first time that this call has been processed by tick().
                   We assign timeStart now so that its value is as close to the real animation start time as possible.
                   (Conversely, had timeStart been defined when this call was added to Velocity.State.calls, the delay
                   between that time and now would cause the first few frames of the tween to be skipped since
                   percentComplete is calculated relative to timeStart.) */
                /* Further, subtract 16ms (the approximate resolution of RAF) from the current time value so that the
                   first tick iteration isn't wasted by animating at 0% tween completion, which would produce the
                   same style value as the element's current value. */
                if (!timeStart) {
                    timeStart = Velocity.State.calls[i][3] = timeCurrent - 16;
                }

                /* The tween's completion percentage is relative to the tween's start time, not the tween's start value
                   (which would result in unpredictable tween durations since JavaScript's timers are not particularly accurate).
                   Accordingly, we ensure that percentComplete does not exceed 1. */
                var percentComplete = Math.min((timeCurrent - timeStart) / opts.duration, 1);

                /**********************
                   Element Iteration
                **********************/

                /* For every call, iterate through each of the elements in its set. */
                for (var j = 0, callLength = call.length; j < callLength; j++) {
                    var tweensContainer = call[j],
                        element = tweensContainer.element;

                    /* Check to see if this element has been deleted midway through the animation by checking for the
                       continued existence of its data cache. If it's gone, skip animating this element. */
                    if (!Data(element)) {
                        continue;
                    }

                    var transformPropertyExists = false;

                    /**********************************
                       Display & Visibility Toggling
                    **********************************/

                    /* If the display option is set to non-"none", set it upfront so that the element can become visible before tweening begins.
                       (Otherwise, display's "none" value is set in completeCall() once the animation has completed.) */
                    if (opts.display !== undefined && opts.display !== null && opts.display !== "none") {
                        if (opts.display === "flex") {
                            var flexValues = [ "-webkit-box", "-moz-box", "-ms-flexbox", "-webkit-flex" ];

                            $.each(flexValues, function(i, flexValue) {
                                CSS.setPropertyValue(element, "display", flexValue);
                            });
                        }

                        CSS.setPropertyValue(element, "display", opts.display);
                    }

                    /* Same goes with the visibility option, but its "none" equivalent is "hidden". */
                    if (opts.visibility !== undefined && opts.visibility !== "hidden") {
                        CSS.setPropertyValue(element, "visibility", opts.visibility);
                    }

                    /************************
                       Property Iteration
                    ************************/

                    /* For every element, iterate through each property. */
                    for (var property in tweensContainer) {
                        /* Note: In addition to property tween data, tweensContainer contains a reference to its associated element. */
                        if (property !== "element") {
                            var tween = tweensContainer[property],
                                currentValue,
                                /* Easing can either be a pre-genereated function or a string that references a pre-registered easing
                                   on the Velocity.Easings object. In either case, return the appropriate easing *function*. */
                                easing = Type.isString(tween.easing) ? Velocity.Easings[tween.easing] : tween.easing;

                            /******************************
                               Current Value Calculation
                            ******************************/

                            /* If this is the last tick pass (if we've reached 100% completion for this tween),
                               ensure that currentValue is explicitly set to its target endValue so that it's not subjected to any rounding. */
                            if (percentComplete === 1) {
                                currentValue = tween.endValue;
                            /* Otherwise, calculate currentValue based on the current delta from startValue. */
                            } else {
                                var tweenDelta = tween.endValue - tween.startValue;
                                currentValue = tween.startValue + (tweenDelta * easing(percentComplete, opts, tweenDelta));

                                /* If no value change is occurring, don't proceed with DOM updating. */
                                if (!firstTick && (currentValue === tween.currentValue)) {
                                    continue;
                                }
                            }

                            tween.currentValue = currentValue;

                            /* If we're tweening a fake 'tween' property in order to log transition values, update the one-per-call variable so that
                               it can be passed into the progress callback. */
                            if (property === "tween") {
                                tweenDummyValue = currentValue;
                            } else {
                                /******************
                                   Hooks: Part I
                                ******************/

                                /* For hooked properties, the newly-updated rootPropertyValueCache is cached onto the element so that it can be used
                                   for subsequent hooks in this call that are associated with the same root property. If we didn't cache the updated
                                   rootPropertyValue, each subsequent update to the root property in this tick pass would reset the previous hook's
                                   updates to rootPropertyValue prior to injection. A nice performance byproduct of rootPropertyValue caching is that
                                   subsequently chained animations using the same hookRoot but a different hook can use this cached rootPropertyValue. */
                                if (CSS.Hooks.registered[property]) {
                                    var hookRoot = CSS.Hooks.getRoot(property),
                                        rootPropertyValueCache = Data(element).rootPropertyValueCache[hookRoot];

                                    if (rootPropertyValueCache) {
                                        tween.rootPropertyValue = rootPropertyValueCache;
                                    }
                                }

                                /*****************
                                    DOM Update
                                *****************/

                                /* setPropertyValue() returns an array of the property name and property value post any normalization that may have been performed. */
                                /* Note: To solve an IE<=8 positioning bug, the unit type is dropped when setting a property value of 0. */
                                var adjustedSetData = CSS.setPropertyValue(element, /* SET */
                                                                           property,
                                                                           tween.currentValue + (parseFloat(currentValue) === 0 ? "" : tween.unitType),
                                                                           tween.rootPropertyValue,
                                                                           tween.scrollData);

                                /*******************
                                   Hooks: Part II
                                *******************/

                                /* Now that we have the hook's updated rootPropertyValue (the post-processed value provided by adjustedSetData), cache it onto the element. */
                                if (CSS.Hooks.registered[property]) {
                                    /* Since adjustedSetData contains normalized data ready for DOM updating, the rootPropertyValue needs to be re-extracted from its normalized form. ?? */
                                    if (CSS.Normalizations.registered[hookRoot]) {
                                        Data(element).rootPropertyValueCache[hookRoot] = CSS.Normalizations.registered[hookRoot]("extract", null, adjustedSetData[1]);
                                    } else {
                                        Data(element).rootPropertyValueCache[hookRoot] = adjustedSetData[1];
                                    }
                                }

                                /***************
                                   Transforms
                                ***************/

                                /* Flag whether a transform property is being animated so that flushTransformCache() can be triggered once this tick pass is complete. */
                                if (adjustedSetData[0] === "transform") {
                                    transformPropertyExists = true;
                                }

                            }
                        }
                    }

                    /****************
                        mobileHA
                    ****************/

                    /* If mobileHA is enabled, set the translate3d transform to null to force hardware acceleration.
                       It's safe to override this property since Velocity doesn't actually support its animation (hooks are used in its place). */
                    if (opts.mobileHA) {
                        /* Don't set the null transform hack if we've already done so. */
                        if (Data(element).transformCache.translate3d === undefined) {
                            /* All entries on the transformCache object are later concatenated into a single transform string via flushTransformCache(). */
                            Data(element).transformCache.translate3d = "(0px, 0px, 0px)";

                            transformPropertyExists = true;
                        }
                    }

                    if (transformPropertyExists) {
                        CSS.flushTransformCache(element);
                    }
                }

                /* The non-"none" display value is only applied to an element once -- when its associated call is first ticked through.
                   Accordingly, it's set to false so that it isn't re-processed by this call in the next tick. */
                if (opts.display !== undefined && opts.display !== "none") {
                    Velocity.State.calls[i][2].display = false;
                }
                if (opts.visibility !== undefined && opts.visibility !== "hidden") {
                    Velocity.State.calls[i][2].visibility = false;
                }

                /* Pass the elements and the timing data (percentComplete, msRemaining, timeStart, tweenDummyValue) into the progress callback. */
                if (opts.progress) {
                    opts.progress.call(callContainer[1],
                                       callContainer[1],
                                       percentComplete,
                                       Math.max(0, (timeStart + opts.duration) - timeCurrent),
                                       timeStart,
                                       tweenDummyValue);
                }

                /* If this call has finished tweening, pass its index to completeCall() to handle call cleanup. */
                if (percentComplete === 1) {
                    completeCall(i);
                }
            }
        }

        /* Note: completeCall() sets the isTicking flag to false when the last call on Velocity.State.calls has completed. */
        if (Velocity.State.isTicking) {
            ticker(tick);
        }
    }

    /**********************
        Call Completion
    **********************/

    /* Note: Unlike tick(), which processes all active calls at once, call completion is handled on a per-call basis. */
    function completeCall (callIndex, isStopped) {
        /* Ensure the call exists. */
        if (!Velocity.State.calls[callIndex]) {
            return false;
        }

        /* Pull the metadata from the call. */
        var call = Velocity.State.calls[callIndex][0],
            elements = Velocity.State.calls[callIndex][1],
            opts = Velocity.State.calls[callIndex][2],
            resolver = Velocity.State.calls[callIndex][4];

        var remainingCallsExist = false;

        /*************************
           Element Finalization
        *************************/

        for (var i = 0, callLength = call.length; i < callLength; i++) {
            var element = call[i].element;

            /* If the user set display to "none" (intending to hide the element), set it now that the animation has completed. */
            /* Note: display:none isn't set when calls are manually stopped (via Velocity("stop"). */
            /* Note: Display gets ignored with "reverse" calls and infinite loops, since this behavior would be undesirable. */
            if (!isStopped && !opts.loop) {
                if (opts.display === "none") {
                    CSS.setPropertyValue(element, "display", opts.display);
                }

                if (opts.visibility === "hidden") {
                    CSS.setPropertyValue(element, "visibility", opts.visibility);
                }
            }

            /* If the element's queue is empty (if only the "inprogress" item is left at position 0) or if its queue is about to run
               a non-Velocity-initiated entry, turn off the isAnimating flag. A non-Velocity-initiatied queue entry's logic might alter
               an element's CSS values and thereby cause Velocity's cached value data to go stale. To detect if a queue entry was initiated by Velocity,
               we check for the existence of our special Velocity.queueEntryFlag declaration, which minifiers won't rename since the flag
               is assigned to jQuery's global $ object and thus exists out of Velocity's own scope. */
            if (opts.loop !== true && ($.queue(element)[1] === undefined || !/\.velocityQueueEntryFlag/i.test($.queue(element)[1]))) {
                /* The element may have been deleted. Ensure that its data cache still exists before acting on it. */
                if (Data(element)) {
                    Data(element).isAnimating = false;
                    /* Clear the element's rootPropertyValueCache, which will become stale. */
                    Data(element).rootPropertyValueCache = {};

                    var transformHAPropertyExists = false;
                    /* If any 3D transform subproperty is at its default value (regardless of unit type), remove it. */
                    $.each(CSS.Lists.transforms3D, function(i, transformName) {
                        var defaultValue = /^scale/.test(transformName) ? 1 : 0,
                            currentValue = Data(element).transformCache[transformName];

                        if (Data(element).transformCache[transformName] !== undefined && new RegExp("^\\(" + defaultValue + "[^.]").test(currentValue)) {
                            transformHAPropertyExists = true;

                            delete Data(element).transformCache[transformName];
                        }
                    });

                    /* Mobile devices have hardware acceleration removed at the end of the animation in order to avoid hogging the GPU's memory. */
                    if (opts.mobileHA) {
                        transformHAPropertyExists = true;
                        delete Data(element).transformCache.translate3d;
                    }

                    /* Flush the subproperty removals to the DOM. */
                    if (transformHAPropertyExists) {
                        CSS.flushTransformCache(element);
                    }

                    /* Remove the "velocity-animating" indicator class. */
                    CSS.Values.removeClass(element, "velocity-animating");
                }
            }

            /*********************
               Option: Complete
            *********************/

            /* Complete is fired once per call (not once per element) and is passed the full raw DOM element set as both its context and its first argument. */
            /* Note: Callbacks aren't fired when calls are manually stopped (via Velocity("stop"). */
            if (!isStopped && opts.complete && !opts.loop && (i === callLength - 1)) {
                /* We throw callbacks in a setTimeout so that thrown errors don't halt the execution of Velocity itself. */
                try {
                    opts.complete.call(elements, elements);
                } catch (error) {
                    setTimeout(function() { throw error; }, 1);
                }
            }

            /**********************
               Promise Resolving
            **********************/

            /* Note: Infinite loops don't return promises. */
            if (resolver && opts.loop !== true) {
                resolver(elements);
            }

            /****************************
               Option: Loop (Infinite)
            ****************************/

            if (Data(element) && opts.loop === true && !isStopped) {
                /* If a rotateX/Y/Z property is being animated to 360 deg with loop:true, swap tween start/end values to enable
                   continuous iterative rotation looping. (Otherise, the element would just rotate back and forth.) */
                $.each(Data(element).tweensContainer, function(propertyName, tweenContainer) {
                    if (/^rotate/.test(propertyName) && parseFloat(tweenContainer.endValue) === 360) {
                        tweenContainer.endValue = 0;
                        tweenContainer.startValue = 360;
                    }

                    if (/^backgroundPosition/.test(propertyName) && parseFloat(tweenContainer.endValue) === 100 && tweenContainer.unitType === "%") {
                        tweenContainer.endValue = 0;
                        tweenContainer.startValue = 100;
                    }
                });

                Velocity(element, "reverse", { loop: true, delay: opts.delay });
            }

            /***************
               Dequeueing
            ***************/

            /* Fire the next call in the queue so long as this call's queue wasn't set to false (to trigger a parallel animation),
               which would have already caused the next call to fire. Note: Even if the end of the animation queue has been reached,
               $.dequeue() must still be called in order to completely clear jQuery's animation queue. */
            if (opts.queue !== false) {
                $.dequeue(element, opts.queue);
            }
        }

        /************************
           Calls Array Cleanup
        ************************/

        /* Since this call is complete, set it to false so that the rAF tick skips it. This array is later compacted via compactSparseArray().
          (For performance reasons, the call is set to false instead of being deleted from the array: http://www.html5rocks.com/en/tutorials/speed/v8/) */
        Velocity.State.calls[callIndex] = false;

        /* Iterate through the calls array to determine if this was the final in-progress animation.
           If so, set a flag to end ticking and clear the calls array. */
        for (var j = 0, callsLength = Velocity.State.calls.length; j < callsLength; j++) {
            if (Velocity.State.calls[j] !== false) {
                remainingCallsExist = true;

                break;
            }
        }

        if (remainingCallsExist === false) {
            /* tick() will detect this flag upon its next iteration and subsequently turn itself off. */
            Velocity.State.isTicking = false;

            /* Clear the calls array so that its length is reset. */
            delete Velocity.State.calls;
            Velocity.State.calls = [];
        }
    }

    /******************
        Frameworks
    ******************/

    /* Both jQuery and Zepto allow their $.fn object to be extended to allow wrapped elements to be subjected to plugin calls.
       If either framework is loaded, register a "velocity" extension pointing to Velocity's core animate() method.  Velocity
       also registers itself onto a global container (window.jQuery || window.Zepto || window) so that certain features are
       accessible beyond just a per-element scope. This master object contains an .animate() method, which is later assigned to $.fn
       (if jQuery or Zepto are present). Accordingly, Velocity can both act on wrapped DOM elements and stand alone for targeting raw DOM elements. */
    global.Velocity = Velocity;

    if (global !== window) {
        /* Assign the element function to Velocity's core animate() method. */
        global.fn.velocity = animate;
        /* Assign the object function's defaults to Velocity's global defaults object. */
        global.fn.velocity.defaults = Velocity.defaults;
    }

    /***********************
       Packaged Redirects
    ***********************/

    /* slideUp, slideDown */
    $.each([ "Down", "Up" ], function(i, direction) {
        Velocity.Redirects["slide" + direction] = function (element, options, elementsIndex, elementsSize, elements, promiseData) {
            var opts = $.extend({}, options),
                begin = opts.begin,
                complete = opts.complete,
                computedValues = { height: "", marginTop: "", marginBottom: "", paddingTop: "", paddingBottom: "" },
                inlineValues = {};

            if (opts.display === undefined) {
                /* Show the element before slideDown begins and hide the element after slideUp completes. */
                /* Note: Inline elements cannot have dimensions animated, so they're reverted to inline-block. */
                opts.display = (direction === "Down" ? (Velocity.CSS.Values.getDisplayType(element) === "inline" ? "inline-block" : "block") : "none");
            }

            opts.begin = function() {
                /* If the user passed in a begin callback, fire it now. */
                begin && begin.call(elements, elements);

                /* Cache the elements' original vertical dimensional property values so that we can animate back to them. */
                for (var property in computedValues) {
                    inlineValues[property] = element.style[property];

                    /* For slideDown, use forcefeeding to animate all vertical properties from 0. For slideUp,
                       use forcefeeding to start from computed values and animate down to 0. */
                    var propertyValue = Velocity.CSS.getPropertyValue(element, property);
                    computedValues[property] = (direction === "Down") ? [ propertyValue, 0 ] : [ 0, propertyValue ];
                }

                /* Force vertical overflow content to clip so that sliding works as expected. */
                inlineValues.overflow = element.style.overflow;
                element.style.overflow = "hidden";
            }

            opts.complete = function() {
                /* Reset element to its pre-slide inline values once its slide animation is complete. */
                for (var property in inlineValues) {
                    element.style[property] = inlineValues[property];
                }

                /* If the user passed in a complete callback, fire it now. */
                complete && complete.call(elements, elements);
                promiseData && promiseData.resolver(elements);
            };

            Velocity(element, computedValues, opts);
        };
    });

    /* fadeIn, fadeOut */
    $.each([ "In", "Out" ], function(i, direction) {
        Velocity.Redirects["fade" + direction] = function (element, options, elementsIndex, elementsSize, elements, promiseData) {
            var opts = $.extend({}, options),
                propertiesMap = { opacity: (direction === "In") ? 1 : 0 },
                originalComplete = opts.complete;

            /* Since redirects are triggered individually for each element in the animated set, avoid repeatedly triggering
               callbacks by firing them only when the final element has been reached. */
            if (elementsIndex !== elementsSize - 1) {
                opts.complete = opts.begin = null;
            } else {
                opts.complete = function() {
                    if (originalComplete) {
                        originalComplete.call(elements, elements);
                    }

                    promiseData && promiseData.resolver(elements);
                }
            }

            /* If a display was passed in, use it. Otherwise, default to "none" for fadeOut or the element-specific default for fadeIn. */
            /* Note: We allow users to pass in "null" to skip display setting altogether. */
            if (opts.display === undefined) {
                opts.display = (direction === "In" ? "auto" : "none");
            }

            Velocity(this, propertiesMap, opts);
        };
    });

    return Velocity;
}((window.jQuery || window.Zepto || window), window, document);
}));

/******************
   Known Issues
******************/

/* The CSS spec mandates that the translateX/Y/Z transforms are %-relative to the element itself -- not its parent.
Velocity, however, doesn't make this distinction. Thus, converting to or from the % unit with these subproperties
will produce an inaccurate conversion value. The same issue exists with the cx/cy attributes of SVG circles and ellipses. */
/**********************
   Velocity UI Pack
**********************/

/* VelocityJS.org UI Pack (5.0.4). (C) 2014 Julian Shapiro. MIT @license: en.wikipedia.org/wiki/MIT_License. Portions copyright Daniel Eden, Christian Pucci. */
window.t = [0.4,0.3,0.15];
;(function (factory) {
    /* CommonJS module. */
    if (typeof require === "function" && typeof exports === "object" ) {
        module.exports = factory();
    /* AMD module. */
    } else if (typeof define === "function" && define.amd) {
        define([ "velocity" ], factory);
    /* Browser globals. */
    } else {
        factory();
    }
}(function() {
return function (global, window, document, undefined) {

    /*************
        Checks
    *************/

    if (!global.Velocity || !global.Velocity.Utilities) {
        window.console && console.log("Velocity UI Pack: Velocity must be loaded first. Aborting.");
        return;
    } else {
        var Velocity = global.Velocity,
            $ = Velocity.Utilities;
    }

    var velocityVersion = Velocity.version,
        requiredVersion = { major: 1, minor: 1, patch: 0 };

    function greaterSemver (primary, secondary) {
        var versionInts = [];

        if (!primary || !secondary) { return false; }

        $.each([ primary, secondary ], function(i, versionObject) {
            var versionIntsComponents = [];

            $.each(versionObject, function(component, value) {
                while (value.toString().length < 5) {
                    value = "0" + value;
                }
                versionIntsComponents.push(value);
            });

            versionInts.push(versionIntsComponents.join(""))
        });

        return (parseFloat(versionInts[0]) > parseFloat(versionInts[1]));
    }

    if (greaterSemver(requiredVersion, velocityVersion)){
        var abortError = "Velocity UI Pack: You need to update Velocity (jquery.velocity.js) to a newer version. Visit http://github.com/julianshapiro/velocity.";
        alert(abortError);
        throw new Error(abortError);
    }

    /************************
       Effect Registration
    ************************/

    /* Note: RegisterUI is a legacy name. */
    Velocity.RegisterEffect = Velocity.RegisterUI = function (effectName, properties) {
        /* Animate the expansion/contraction of the elements' parent's height for In/Out effects. */
        function animateParentHeight (elements, direction, totalDuration, stagger) {
            var totalHeightDelta = 0,
                parentNode;

            /* Sum the total height (including padding and margin) of all targeted elements. */
            $.each(elements.nodeType ? [ elements ] : elements, function(i, element) {
                if (stagger) {
                    /* Increase the totalDuration by the successive delay amounts produced by the stagger option. */
                    totalDuration += i * stagger;
                }

                parentNode = element.parentNode;

                $.each([ "height", "paddingTop", "paddingBottom", "marginTop", "marginBottom"], function(i, property) {
                    totalHeightDelta += parseFloat(Velocity.CSS.getPropertyValue(element, property));
                });
            });

            /* Animate the parent element's height adjustment (with a varying duration multiplier for aesthetic benefits). */
            Velocity.animate(
                parentNode,
                { height: (direction === "In" ? "+" : "-") + "=" + totalHeightDelta },
                { queue: false, easing: "ease-in-out", duration: totalDuration * (direction === "In" ? 0.6 : 1) }
            );
        }

        /* Register a custom redirect for each effect. */
        Velocity.Redirects[effectName] = function (element, redirectOptions, elementsIndex, elementsSize, elements, promiseData) {
            var finalElement = (elementsIndex === elementsSize - 1);

            if (typeof properties.defaultDuration === "function") {
                properties.defaultDuration = properties.defaultDuration.call(elements, elements);
            } else {
                properties.defaultDuration = parseFloat(properties.defaultDuration);
            }

            /* Iterate through each effect's call array. */
            for (var callIndex = 0; callIndex < properties.calls.length; callIndex++) {
                var call = properties.calls[callIndex],
                    propertyMap = call[0],
                    redirectDuration = (redirectOptions.duration || properties.defaultDuration || 1000),
                    durationPercentage = call[1],
                    callOptions = call[2] || {},
                    opts = {};

                /* Assign the whitelisted per-call options. */
                opts.duration = redirectDuration * (durationPercentage || 1);
                opts.queue = redirectOptions.queue || "";
                opts.easing = callOptions.easing || "ease";
                opts.delay = parseFloat(callOptions.delay) || 0;
                opts._cacheValues = callOptions._cacheValues || true;

                /* Special processing for the first effect call. */
                if (callIndex === 0) {
                    /* If a delay was passed into the redirect, combine it with the first call's delay. */
                    opts.delay += (parseFloat(redirectOptions.delay) || 0);

                    if (elementsIndex === 0) {
                        opts.begin = function() {
                            /* Only trigger a begin callback on the first effect call with the first element in the set. */
                            redirectOptions.begin && redirectOptions.begin.call(elements, elements);

                            var direction = effectName.match(/(In|Out)$/);

                            /* Make "in" transitioning elements invisible immediately so that there's no FOUC between now
                               and the first RAF tick. */
                            if ((direction && direction[0] === "In") && propertyMap.opacity !== undefined) {
                                $.each(elements.nodeType ? [ elements ] : elements, function(i, element) {
                                    Velocity.CSS.setPropertyValue(element, "opacity", 0);
                                });
                            }

                            /* Only trigger animateParentHeight() if we're using an In/Out  */
                            if (redirectOptions.animateParentHeight && direction) {
                                animateParentHeight(elements, direction[0], redirectDuration + opts.delay, redirectOptions.stagger);
                            }
                        }
                    }

                    /* If the user isn't overriding the display option, default to "auto" for "In"-suffixed transitions. */
                    if (redirectOptions.display !== null) {
                        if (redirectOptions.display !== undefined && redirectOptions.display !== "none") {
                            opts.display = redirectOptions.display;
                        } else if (/In$/.test(effectName)) {
                            /* Inline elements cannot be subjected to transforms, so we switch them to inline-block. */
                            var defaultDisplay = Velocity.CSS.Values.getDisplayType(element);
                            opts.display = (defaultDisplay === "inline") ? "inline-block" : defaultDisplay;
                        }
                    }

                    if (redirectOptions.visibility && redirectOptions.visibility !== "hidden") {
                        opts.visibility = redirectOptions.visibility;
                    }
                }

                /* Special processing for the last effect call. */
                if (callIndex === properties.calls.length - 1) {
                    /* Append promise resolving onto the user's redirect callback. */
                    function injectFinalCallbacks () {
                        if ((redirectOptions.display === undefined || redirectOptions.display === "none") && /Out$/.test(effectName)) {
                            $.each(elements.nodeType ? [ elements ] : elements, function(i, element) {
                                Velocity.CSS.setPropertyValue(element, "display", "none");
                            });
                        }

                        redirectOptions.complete && redirectOptions.complete.call(elements, elements);

                        if (promiseData) {
                            promiseData.resolver(elements || element);
                        }
                    }

                    opts.complete = function() {
                        if (properties.reset) {
                            for (var resetProperty in properties.reset) {
                                var resetValue = properties.reset[resetProperty];

                                /* Format each non-array value in the reset property map to [ value, value ] so that changes apply
                                   immediately and DOM querying is avoided (via forcefeeding). */
                                /* Note: Don't forcefeed hooks, otherwise their hook roots will be defaulted to their null values. */
                                if (Velocity.CSS.Hooks.registered[resetProperty] === undefined && (typeof resetValue === "string" || typeof resetValue === "number")) {
                                    properties.reset[resetProperty] = [ properties.reset[resetProperty], properties.reset[resetProperty] ];
                                }
                            }

                            /* So that the reset values are applied instantly upon the next rAF tick, use a zero duration and parallel queueing. */
                            var resetOptions = { duration: 0, queue: false };

                            /* Since the reset option uses up the complete callback, we trigger the user's complete callback at the end of ours. */
                            if (finalElement) {
                                resetOptions.complete = injectFinalCallbacks;
                            }

                            Velocity.animate(element, properties.reset, resetOptions);
                        /* Only trigger the user's complete callback on the last effect call with the last element in the set. */
                        } else if (finalElement) {
                            injectFinalCallbacks();
                        }
                    };

                    if (redirectOptions.visibility === "hidden") {
                        opts.visibility = redirectOptions.visibility;
                    }
                }

                Velocity.animate(element, propertyMap, opts);
            }
        };

        /* Return the Velocity object so that RegisterUI calls can be chained. */
        return Velocity;
    };

    /*********************
       Packaged Effects
    *********************/

    /* Externalize the packagedEffects data so that they can optionally be modified and re-registered. */
    /* Support: <=IE8: Callouts will have no effect, and transitions will simply fade in/out. IE9/Android 2.3: Most effects are fully supported, the rest fade in/out. All other browsers: full support. */
    Velocity.RegisterEffect.packagedEffects =
        {
            /* Animate.css */
            "callout.bounce": {
                defaultDuration: 550,
                calls: [
                    [ { translateY: -30 }, 0.25 ],
                    [ { translateY: 0 }, 0.125 ],
                    [ { translateY: -15 }, 0.125 ],
                    [ { translateY: 0 }, 0.25 ]
                ]
            },
            /* Animate.css */
            "callout.shake": {
                defaultDuration: 800,
                calls: [
                    [ { translateX: -11 }, 0.125 ],
                    [ { translateX: 11 }, 0.125 ],
                    [ { translateX: -11 }, 0.125 ],
                    [ { translateX: 11 }, 0.125 ],
                    [ { translateX: -11 }, 0.125 ],
                    [ { translateX: 11 }, 0.125 ],
                    [ { translateX: -11 }, 0.125 ],
                    [ { translateX: 0 }, 0.125 ]
                ]
            },
            /* Animate.css */
            "callout.flash": {
                defaultDuration: 1100,
                calls: [
                    [ { opacity: [ 0, "easeInOutQuad", 1 ] }, 0.25 ],
                    [ { opacity: [ 1, "easeInOutQuad" ] }, 0.25 ],
                    [ { opacity: [ 0, "easeInOutQuad" ] }, 0.25 ],
                    [ { opacity: [ 1, "easeInOutQuad" ] }, 0.25 ]
                ]
            },
            /* Animate.css */
            "callout.pulse": {
                defaultDuration: 825,
                calls: [
                    [ { scaleX: 1.1, scaleY: 1.1 }, 0.50, { easing: "easeInExpo" } ],
                    [ { scaleX: 1, scaleY: 1 }, 0.50 ]
                ]
            },
            /* Animate.css */
            "callout.swing": {
                defaultDuration: 950,
                calls: [
                    [ { rotateZ: 15 }, 0.20 ],
                    [ { rotateZ: -10 }, 0.20 ],
                    [ { rotateZ: 5 }, 0.20 ],
                    [ { rotateZ: -5 }, 0.20 ],
                    [ { rotateZ: 0 }, 0.20 ]
                ]
            },
            /* Animate.css */
            "callout.tada": {
                defaultDuration: 1000,
                calls: [
                    [ { scaleX: 0.9, scaleY: 0.9, rotateZ: -3 }, 0.10 ],
                    [ { scaleX: 1.1, scaleY: 1.1, rotateZ: 3 }, 0.10 ],
                    [ { scaleX: 1.1, scaleY: 1.1, rotateZ: -3 }, 0.10 ],
                    [ "reverse", 0.125 ],
                    [ "reverse", 0.125 ],
                    [ "reverse", 0.125 ],
                    [ "reverse", 0.125 ],
                    [ "reverse", 0.125 ],
                    [ { scaleX: 1, scaleY: 1, rotateZ: 0 }, 0.20 ]
                ]
            },
            "fadeIn": {
                defaultDuration: 500,
                calls: [
                    [ { opacity: [ 1, 0 ] } ]
                ]
            },
            "fadeOut": {
                defaultDuration: 500,
                calls: [
                    [ { opacity: [ 0, 1 ] } ]
                ]
            },
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipXIn": {
                defaultDuration: 700,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 800, 800 ], rotateY: [ 0, -55 ] } ]
                ],
                reset: { transformPerspective: 0 }
            },
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipXOut": {
                defaultDuration: 700,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 800, 800 ], rotateY: 55 } ]
                ],
                reset: { transformPerspective: 0, rotateY: 0 }
            },
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipYIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 800, 800 ], rotateX: [ 0, -45 ] } ]
                ],
                reset: { transformPerspective: 0 }
            },
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipYOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 800, 800 ], rotateX: 25 } ]
                ],
                reset: { transformPerspective: 0, rotateX: 0 }
            },
            /* Animate.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipBounceXIn": {
                defaultDuration: 900,
                calls: [
                    [ { opacity: [ 0.725, 0 ], transformPerspective: [ 400, 400 ], rotateY: [ -10, 90 ] }, 0.50 ],
                    [ { opacity: 0.80, rotateY: 10 }, 0.25 ],
                    [ { opacity: 1, rotateY: 0 }, 0.25 ]
                ],
                reset: { transformPerspective: 0 }
            },
            /* Animate.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipBounceXOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0.9, 1 ], transformPerspective: [ 400, 400 ], rotateY: -10 }, 0.50 ],
                    [ { opacity: 0, rotateY: 90 }, 0.50 ]
                ],
                reset: { transformPerspective: 0, rotateY: 0 }
            },
            /* Animate.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipBounceYIn": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 0.725, 0 ], transformPerspective: [ 400, 400 ], rotateX: [ -10, 90 ] }, 0.50 ],
                    [ { opacity: 0.80, rotateX: 10 }, 0.25 ],
                    [ { opacity: 1, rotateX: 0 }, 0.25 ]
                ],
                reset: { transformPerspective: 0 }
            },
            /* Animate.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "flipBounceYOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0.9, 1 ], transformPerspective: [ 400, 400 ], rotateX: -15 }, 0.50 ],
                    [ { opacity: 0, rotateX: 90 }, 0.50 ]
                ],
                reset: { transformPerspective: 0, rotateX: 0 }
            },
            /* Magic.css */
            "swoopIn": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 1, 0 ], transformOriginX: [ "100%", "50%" ], transformOriginY: [ "100%", "100%" ], scaleX: [ 1, 0 ], scaleY: [ 1, 0 ], translateX: [ 0, -700 ], translateZ: 0 } ]
                ],
                reset: { transformOriginX: "50%", transformOriginY: "50%" }
            },
            /* Magic.css */
            "swoopOut": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 0, 1 ], transformOriginX: [ "50%", "100%" ], transformOriginY: [ "100%", "100%" ], scaleX: 0, scaleY: 0, translateX: -700, translateZ: 0 } ]
                ],
                reset: { transformOriginX: "50%", transformOriginY: "50%", scaleX: 1, scaleY: 1, translateX: 0 }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3. (Fades and scales only.) */
            "whirlIn": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 1, 0 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: [ 1, 0 ], scaleY: [ 1, 0 ], rotateY: [ 0, 160 ] }, 1, { easing: "easeInOutSine" } ]
                ]
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3. (Fades and scales only.) */
            "whirlOut": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 0, "easeInOutQuint", 1 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: 0, scaleY: 0, rotateY: 160 }, 1, { easing: "swing" } ]
                ],
                reset: { scaleX: 1, scaleY: 1, rotateY: 0 }
            },
            "shrinkIn": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 1, 0 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: [ 1, 1.5 ], scaleY: [ 1, 1.5 ], translateZ: 0 } ]
                ]
            },
            "shrinkOut": {
                defaultDuration: 600,
                calls: [
                    [ { opacity: [ 0, 1 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: 1.3, scaleY: 1.3, translateZ: 0 } ]
                ],
                reset: { scaleX: 1, scaleY: 1 }
            },
            "expandIn": {
                defaultDuration: 700,
                calls: [
                    [ { opacity: [ 1, 0 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: [ 1, 0.625 ], scaleY: [ 1, 0.625 ], translateZ: 0 } ]
                ]
            },
            "expandOut": {
                defaultDuration: 700,
                calls: [
                    [ { opacity: [ 0, 1 ], transformOriginX: [ "50%", "50%" ], transformOriginY: [ "50%", "50%" ], scaleX: 0.5, scaleY: 0.5, translateZ: 0 } ]
                ],
                reset: { scaleX: 1, scaleY: 1 }
            },
            /* Animate.css */
            "bounceIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], scaleX: [ 1.05, 0.3 ], scaleY: [ 1.05, 0.3 ] }, 0.40 ],
                    [ { scaleX: 0.9, scaleY: 0.9, translateZ: 0 }, 0.20 ],
                    [ { scaleX: 1, scaleY: 1 }, 0.50 ]
                ]
            },
            "bounceInQuick": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], scaleX: [ 1.07, 0.3 ], scaleY: [ 1.07, 0.3 ] }, window.t[0]|| 0.40  ],
                    [ { scaleX: 0.99, scaleY: 0.99, translateZ: 0 }, window.t[1] || 0.30 ],
                    [ { scaleX: 1, scaleY: 1 }, window.t[2] || 0.15 ]
                ]
            },
            /* Animate.css */
            "bounceOut": {
                defaultDuration: 800,
                calls: [
                    // [ { scaleX: 0.95, scaleY: 0.95 }, 0.35 ],
                    [ { scaleX: 1.12, scaleY: 1.12, translateZ: 0 }, 0.5 ],
                    [ { opacity: [ 0, 1 ], scaleX: 0.8, scaleY: 0.8 }, 0.5 ]
                ],
                reset: { scaleX: 1, scaleY: 1 }
            },
            "shradeIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], scaleX: [ 1, 0.94 ], scaleY: [ 1, 0.94 ] }  ]
                ]
            },
            "shradeOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0, 1 ], scaleX: [ 0.94, 1 ], scaleY: [ 0.94, 1 ] }  ]
                ],
                reset: { scaleX: 1, scaleY: 1 }
            },
            "slideInRight": {
              defaultDuration: 1000,
                calls: [
                    [ { opacity: [ 1, 1 ], translateX: [ 0, 100 ], translateZ: 0 } ]
                ] 
            },
            /* Animate.css */
            "bounceUpIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ -30, 1000 ] }, 0.60, { easing: "easeOutCirc" } ],
                    [ { translateY: 10 }, 0.20 ],
                    [ { translateY: 0 }, 0.20 ]
                ]
            },
            /* Animate.css */
            "bounceUpOut": {
                defaultDuration: 1000,
                calls: [
                    [ { translateY: 20 }, 0.20 ],
                    [ { opacity: [ 0, "easeInCirc", 1 ], translateY: -1000 }, 0.80 ]
                ],
                reset: { translateY: 0 }
            },
            /* Animate.css */
            "bounceDownIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ 30, -1000 ] }, 0.60, { easing: "easeOutCirc" } ],
                    [ { translateY: -10 }, 0.20 ],
                    [ { translateY: 0 }, 0.20 ]
                ]
            },
            /* Animate.css */
            "bounceDownOut": {
                defaultDuration: 1000,
                calls: [
                    [ { translateY: -20 }, 0.20 ],
                    [ { opacity: [ 0, "easeInCirc", 1 ], translateY: 1000 }, 0.80 ]
                ],
                reset: { translateY: 0 }
            },
            /* Animate.css */
            "bounceLeftIn": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ 30, -1250 ] }, 0.60, { easing: "easeOutCirc" } ],
                    [ { translateX: -10 }, 0.20 ],
                    [ { translateX: 0 }, 0.20 ]
                ]
            },
            /* Animate.css */
            "bounceLeftOut": {
                defaultDuration: 750,
                calls: [
                    [ { translateX: 30 }, 0.20 ],
                    [ { opacity: [ 0, "easeInCirc", 1 ], translateX: -1250 }, 0.80 ]
                ],
                reset: { translateX: 0 }
            },
            /* Animate.css */
            "bounceRightIn": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ -30, 1250 ] }, 0.60, { easing: "easeOutCirc" } ],
                    [ { translateX: 10 }, 0.20 ],
                    [ { translateX: 0 }, 0.20 ]
                ]
            },
            /* Animate.css */
            "bounceRightOut": {
                defaultDuration: 750,
                calls: [
                    [ { translateX: -30 }, 0.20 ],
                    [ { opacity: [ 0, "easeInCirc", 1 ], translateX: 1250 }, 0.80 ]
                ],
                reset: { translateX: 0 }
            },
            "slideUpIn": {
                defaultDuration: 900,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ 0, 20 ], translateZ: 0 } ]
                ]
            },
            "slideUpOut": {
                defaultDuration: 900,
                calls: [
                    [ { opacity: [ 0, 1 ], translateY: -20, translateZ: 0 } ]
                ],
                reset: { translateY: 0 }
            },
            "slideDownIn": {
                defaultDuration: 900,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ 0, -20 ], translateZ: 0 } ]
                ]
            },
            "slideDownOut": {
                defaultDuration: 900,
                calls: [
                    [ { opacity: [ 0, 1 ], translateY: 20, translateZ: 0 } ]
                ],
                reset: { translateY: 0 }
            },
            "slideLeftIn": {
                defaultDuration: 1000,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ 0, -20 ], translateZ: 0 } ]
                ]
            },
            "slideLeftOut": {
                defaultDuration: 1050,
                calls: [
                    [ { opacity: [ 0, 1 ], translateX: -20, translateZ: 0 } ]
                ],
                reset: { translateX: 0 }
            },
            "slideRightIn": {
                defaultDuration: 1000,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ 0, 20 ], translateZ: 0 } ]
                ]
            },
            "slideRightOut": {
                defaultDuration: 1050,
                calls: [
                    [ { opacity: [ 0, 1 ], translateX: 20, translateZ: 0 } ]
                ],
                reset: { translateX: 0 }
            },
            "slideUpBigIn": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ 0, 75 ], translateZ: 0 } ]
                ]
            },
            "slideUpBigOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0, 1 ], translateY: -75, translateZ: 0 } ]
                ],
                reset: { translateY: 0 }
            },
            "slideDownBigIn": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 1, 0 ], translateY: [ 0, -75 ], translateZ: 0 } ]
                ]
            },
            "slideDownBigOut": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 0, 1 ], translateY: 75, translateZ: 0 } ]
                ],
                reset: { translateY: 0 }
            },
            "slideLeftBigIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ 0, -75 ], translateZ: 0 } ]
                ]
            },
            "slideLeftBigOut": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 0, 1 ], translateX: -75, translateZ: 0 } ]
                ],
                reset: { translateX: 0 }
            },
            "slideRightBigIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], translateX: [ 0, 75 ], translateZ: 0 } ]
                ]
            },
            "slideRightBigOut": {
                defaultDuration: 750,
                calls: [
                    [ { opacity: [ 0, 1 ], translateX: 75, translateZ: 0 } ]
                ],
                reset: { translateX: 0 }
            },
            /* Magic.css */
            "perspectiveUpIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 800, 800 ], transformOriginX: [ 0, 0 ], transformOriginY: [ "100%", "100%" ], rotateX: [ 0, -180 ] } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%" }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveUpOut": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 800, 800 ], transformOriginX: [ 0, 0 ], transformOriginY: [ "100%", "100%" ], rotateX: -180 } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%", rotateX: 0 }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveDownIn": {
                defaultDuration: 800,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 800, 800 ], transformOriginX: [ 0, 0 ], transformOriginY: [ 0, 0 ], rotateX: [ 0, 180 ] } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%" }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveDownOut": {
                defaultDuration: 850,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 800, 800 ], transformOriginX: [ 0, 0 ], transformOriginY: [ 0, 0 ], rotateX: 180 } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%", rotateX: 0 }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveLeftIn": {
                defaultDuration: 950,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 2000, 2000 ], transformOriginX: [ 0, 0 ], transformOriginY: [ 0, 0 ], rotateY: [ 0, -180 ] } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%" }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveLeftOut": {
                defaultDuration: 950,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 2000, 2000 ], transformOriginX: [ 0, 0 ], transformOriginY: [ 0, 0 ], rotateY: -180 } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%", rotateY: 0 }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveRightIn": {
                defaultDuration: 950,
                calls: [
                    [ { opacity: [ 1, 0 ], transformPerspective: [ 2000, 2000 ], transformOriginX: [ "100%", "100%" ], transformOriginY: [ 0, 0 ], rotateY: [ 0, 180 ] } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%" }
            },
            /* Magic.css */
            /* Support: Loses rotation in IE9/Android 2.3 (fades only). */
            "perspectiveRightOut": {
                defaultDuration: 950,
                calls: [
                    [ { opacity: [ 0, 1 ], transformPerspective: [ 2000, 2000 ], transformOriginX: [ "100%", "100%" ], transformOriginY: [ 0, 0 ], rotateY: 180 } ]
                ],
                reset: { transformPerspective: 0, transformOriginX: "50%", transformOriginY: "50%", rotateY: 0 }
            }
        };

    /* Register the packaged effects. */
    for (var effectName in Velocity.RegisterEffect.packagedEffects) {
        Velocity.RegisterEffect(effectName, Velocity.RegisterEffect.packagedEffects[effectName]);
    }

    /*********************
       Sequence Running
    **********************/

    /* Note: Sequence calls must use Velocity's single-object arguments syntax. */
    Velocity.RunSequence = function (originalSequence) {
        var sequence = $.extend(true, [], originalSequence);

        if (sequence.length > 1) {
            $.each(sequence.reverse(), function(i, currentCall) {
                var nextCall = sequence[i + 1];

                if (nextCall) {
                    /* Parallel sequence calls (indicated via sequenceQueue:false) are triggered
                       in the previous call's begin callback. Otherwise, chained calls are normally triggered
                       in the previous call's complete callback. */
                    var currentCallOptions = currentCall.o || currentCall.options,
                        nextCallOptions = nextCall.o || nextCall.options;

                    var timing = (currentCallOptions && currentCallOptions.sequenceQueue === false) ? "begin" : "complete",
                        callbackOriginal = nextCallOptions && nextCallOptions[timing],
                        options = {};

                    options[timing] = function() {
                        var nextCallElements = nextCall.e || nextCall.elements;
                        var elements = nextCallElements.nodeType ? [ nextCallElements ] : nextCallElements;

                        callbackOriginal && callbackOriginal.call(elements, elements);
                        Velocity(currentCall);
                    }

                    if (nextCall.o) {
                        nextCall.o = $.extend({}, nextCallOptions, options);
                    } else {
                        nextCall.options = $.extend({}, nextCallOptions, options);
                    }
                }
            });

            sequence.reverse();
        }

        Velocity(sequence[0]);
    };
}((window.jQuery || window.Zepto || window), window, document);
}));
//! moment.js
//! version : 2.10.2
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return Ac.apply(null,arguments)}function b(a){Ac=a}function c(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}function e(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function f(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function g(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function h(a,b){for(var c in b)g(b,c)&&(a[c]=b[c]);return g(b,"toString")&&(a.toString=b.toString),g(b,"valueOf")&&(a.valueOf=b.valueOf),a}function i(a,b,c,d){return ya(a,b,c,d,!0).utc()}function j(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length&&void 0===a._pf.bigHour)),a._isValid}function k(a){var b=i(0/0);return null!=a?h(b._pf,a):b._pf.userInvalidated=!0,b}function l(a,b){var c,d,e;if("undefined"!=typeof b._isAMomentObject&&(a._isAMomentObject=b._isAMomentObject),"undefined"!=typeof b._i&&(a._i=b._i),"undefined"!=typeof b._f&&(a._f=b._f),"undefined"!=typeof b._l&&(a._l=b._l),"undefined"!=typeof b._strict&&(a._strict=b._strict),"undefined"!=typeof b._tzm&&(a._tzm=b._tzm),"undefined"!=typeof b._isUTC&&(a._isUTC=b._isUTC),"undefined"!=typeof b._offset&&(a._offset=b._offset),"undefined"!=typeof b._pf&&(a._pf=b._pf),"undefined"!=typeof b._locale&&(a._locale=b._locale),Cc.length>0)for(c in Cc)d=Cc[c],e=b[d],"undefined"!=typeof e&&(a[d]=e);return a}function m(b){l(this,b),this._d=new Date(+b._d),Dc===!1&&(Dc=!0,a.updateOffset(this),Dc=!1)}function n(a){return a instanceof m||null!=a&&g(a,"_isAMomentObject")}function o(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function p(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&o(a[d])!==o(b[d]))&&g++;return g+f}function q(){}function r(a){return a?a.toLowerCase().replace("_","-"):a}function s(a){for(var b,c,d,e,f=0;f<a.length;){for(e=r(a[f]).split("-"),b=e.length,c=r(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=t(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&p(e,c,!0)>=b-1)break;b--}f++}return null}function t(a){var b=null;if(!Ec[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=Bc._abbr,require("./locale/"+a),u(b)}catch(c){}return Ec[a]}function u(a,b){var c;return a&&(c="undefined"==typeof b?w(a):v(a,b),c&&(Bc=c)),Bc._abbr}function v(a,b){return null!==b?(b.abbr=a,Ec[a]||(Ec[a]=new q),Ec[a].set(b),u(a),Ec[a]):(delete Ec[a],null)}function w(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return Bc;if(!d(a)){if(b=t(a))return b;a=[a]}return s(a)}function x(a,b){var c=a.toLowerCase();Fc[c]=Fc[c+"s"]=Fc[b]=a}function y(a){return"string"==typeof a?Fc[a]||Fc[a.toLowerCase()]:void 0}function z(a){var b,c,d={};for(c in a)g(a,c)&&(b=y(c),b&&(d[b]=a[c]));return d}function A(b,c){return function(d){return null!=d?(C(this,b,d),a.updateOffset(this,c),this):B(this,b)}}function B(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function C(a,b,c){return a._d["set"+(a._isUTC?"UTC":"")+b](c)}function D(a,b){var c;if("object"==typeof a)for(c in a)this.set(c,a[c]);else if(a=y(a),"function"==typeof this[a])return this[a](b);return this}function E(a,b,c){for(var d=""+Math.abs(a),e=a>=0;d.length<b;)d="0"+d;return(e?c?"+":"":"-")+d}function F(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Jc[a]=e),b&&(Jc[b[0]]=function(){return E(e.apply(this,arguments),b[1],b[2])}),c&&(Jc[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function G(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function H(a){var b,c,d=a.match(Gc);for(b=0,c=d.length;c>b;b++)d[b]=Jc[d[b]]?Jc[d[b]]:G(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function I(a,b){return a.isValid()?(b=J(b,a.localeData()),Ic[b]||(Ic[b]=H(b)),Ic[b](a)):a.localeData().invalidDate()}function J(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Hc.lastIndex=0;d>=0&&Hc.test(a);)a=a.replace(Hc,c),Hc.lastIndex=0,d-=1;return a}function K(a,b,c){Yc[a]="function"==typeof b?b:function(a){return a&&c?c:b}}function L(a,b){return g(Yc,a)?Yc[a](b._strict,b._locale):new RegExp(M(a))}function M(a){return a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function N(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),"number"==typeof b&&(d=function(a,c){c[b]=o(a)}),c=0;c<a.length;c++)Zc[a[c]]=d}function O(a,b){N(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function P(a,b,c){null!=b&&g(Zc,a)&&Zc[a](b,c._a,c,a)}function Q(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function R(a){return this._months[a.month()]}function S(a){return this._monthsShort[a.month()]}function T(a,b,c){var d,e,f;for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;12>d;d++){if(e=i([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}function U(a,b){var c;return"string"==typeof b&&(b=a.localeData().monthsParse(b),"number"!=typeof b)?a:(c=Math.min(a.date(),Q(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function V(b){return null!=b?(U(this,b),a.updateOffset(this,!0),this):B(this,"Month")}function W(){return Q(this.year(),this.month())}function X(a){var b,c=a._a;return c&&-2===a._pf.overflow&&(b=c[_c]<0||c[_c]>11?_c:c[ad]<1||c[ad]>Q(c[$c],c[_c])?ad:c[bd]<0||c[bd]>24||24===c[bd]&&(0!==c[cd]||0!==c[dd]||0!==c[ed])?bd:c[cd]<0||c[cd]>59?cd:c[dd]<0||c[dd]>59?dd:c[ed]<0||c[ed]>999?ed:-1,a._pf._overflowDayOfYear&&($c>b||b>ad)&&(b=ad),a._pf.overflow=b),a}function Y(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function Z(a,b){var c=!0;return h(function(){return c&&(Y(a),c=!1),b.apply(this,arguments)},b)}function $(a,b){hd[a]||(Y(b),hd[a]=!0)}function _(a){var b,c,d=a._i,e=id.exec(d);if(e){for(a._pf.iso=!0,b=0,c=jd.length;c>b;b++)if(jd[b][1].exec(d)){a._f=jd[b][0]+(e[6]||" ");break}for(b=0,c=kd.length;c>b;b++)if(kd[b][1].exec(d)){a._f+=kd[b][0];break}d.match(Vc)&&(a._f+="Z"),sa(a)}else a._isValid=!1}function aa(b){var c=ld.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(_(b),void(b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b))))}function ba(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function ca(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function da(a){return ea(a)?366:365}function ea(a){return a%4===0&&a%100!==0||a%400===0}function fa(){return ea(this.year())}function ga(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=za(a).add(f,"d"),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function ha(a){return ga(a,this._week.dow,this._week.doy).week}function ia(){return this._week.dow}function ja(){return this._week.doy}function ka(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function la(a){var b=ga(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}function ma(a,b,c,d,e){var f,g,h=ca(a,0,1).getUTCDay();return h=0===h?7:h,c=null!=c?c:e,f=e-h+(h>d?7:0)-(e>h?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:da(a-1)+g}}function na(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function oa(a,b,c){return null!=a?a:null!=b?b:c}function pa(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function qa(a){var b,c,d,e,f=[];if(!a._d){for(d=pa(a),a._w&&null==a._a[ad]&&null==a._a[_c]&&ra(a),a._dayOfYear&&(e=oa(a._a[$c],d[$c]),a._dayOfYear>da(e)&&(a._pf._overflowDayOfYear=!0),c=ca(e,0,a._dayOfYear),a._a[_c]=c.getUTCMonth(),a._a[ad]=c.getUTCDate()),b=0;3>b&&null==a._a[b];++b)a._a[b]=f[b]=d[b];for(;7>b;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];24===a._a[bd]&&0===a._a[cd]&&0===a._a[dd]&&0===a._a[ed]&&(a._nextDay=!0,a._a[bd]=0),a._d=(a._useUTC?ca:ba).apply(null,f),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[bd]=24)}}function ra(a){var b,c,d,e,f,g,h;b=a._w,null!=b.GG||null!=b.W||null!=b.E?(f=1,g=4,c=oa(b.GG,a._a[$c],ga(za(),1,4).year),d=oa(b.W,1),e=oa(b.E,1)):(f=a._locale._week.dow,g=a._locale._week.doy,c=oa(b.gg,a._a[$c],ga(za(),f,g).year),d=oa(b.w,1),null!=b.d?(e=b.d,f>e&&++d):e=null!=b.e?b.e+f:f),h=ma(c,d,e,g,f),a._a[$c]=h.year,a._dayOfYear=h.dayOfYear}function sa(b){if(b._f===a.ISO_8601)return void _(b);b._a=[],b._pf.empty=!0;var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=J(b._f,b._locale).match(Gc)||[],c=0;c<e.length;c++)f=e[c],d=(h.match(L(f,b))||[])[0],d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&b._pf.unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),Jc[f]?(d?b._pf.empty=!1:b._pf.unusedTokens.push(f),P(f,d,b)):b._strict&&!d&&b._pf.unusedTokens.push(f);b._pf.charsLeftOver=i-j,h.length>0&&b._pf.unusedInput.push(h),b._pf.bigHour===!0&&b._a[bd]<=12&&(b._pf.bigHour=void 0),b._a[bd]=ta(b._locale,b._a[bd],b._meridiem),qa(b),X(b)}function ta(a,b,c){var d;return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&12>b&&(b+=12),d||12!==b||(b=0),b):b}function ua(a){var b,d,e,f,g;if(0===a._f.length)return a._pf.invalidFormat=!0,void(a._d=new Date(0/0));for(f=0;f<a._f.length;f++)g=0,b=l({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._pf=c(),b._f=a._f[f],sa(b),j(b)&&(g+=b._pf.charsLeftOver,g+=10*b._pf.unusedTokens.length,b._pf.score=g,(null==e||e>g)&&(e=g,d=b));h(a,d||b)}function va(a){if(!a._d){var b=z(a._i);a._a=[b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],qa(a)}}function wa(a){var b,c=a._i,e=a._f;return a._locale=a._locale||w(a._l),null===c||void 0===e&&""===c?k({nullInput:!0}):("string"==typeof c&&(a._i=c=a._locale.preparse(c)),n(c)?new m(X(c)):(d(e)?ua(a):e?sa(a):xa(a),b=new m(X(a)),b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b))}function xa(b){var c=b._i;void 0===c?b._d=new Date:e(c)?b._d=new Date(+c):"string"==typeof c?aa(b):d(c)?(b._a=f(c.slice(0),function(a){return parseInt(a,10)}),qa(b)):"object"==typeof c?va(b):"number"==typeof c?b._d=new Date(c):a.createFromInputFallback(b)}function ya(a,b,d,e,f){var g={};return"boolean"==typeof d&&(e=d,d=void 0),g._isAMomentObject=!0,g._useUTC=g._isUTC=f,g._l=d,g._i=a,g._f=b,g._strict=e,g._pf=c(),wa(g)}function za(a,b,c,d){return ya(a,b,c,d,!1)}function Aa(a,b){var c,e;if(1===b.length&&d(b[0])&&(b=b[0]),!b.length)return za();for(c=b[0],e=1;e<b.length;++e)b[e][a](c)&&(c=b[e]);return c}function Ba(){var a=[].slice.call(arguments,0);return Aa("isBefore",a)}function Ca(){var a=[].slice.call(arguments,0);return Aa("isAfter",a)}function Da(a){var b=z(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._locale=w(),this._bubble()}function Ea(a){return a instanceof Da}function Fa(a,b){F(a,0,0,function(){var a=this.utcOffset(),c="+";return 0>a&&(a=-a,c="-"),c+E(~~(a/60),2)+b+E(~~a%60,2)})}function Ga(a){var b=(a||"").match(Vc)||[],c=b[b.length-1]||[],d=(c+"").match(qd)||["-",0,0],e=+(60*d[1])+o(d[2]);return"+"===d[0]?e:-e}function Ha(b,c){var d,f;return c._isUTC?(d=c.clone(),f=(n(b)||e(b)?+b:+za(b))-+d,d._d.setTime(+d._d+f),a.updateOffset(d,!1),d):za(b).local();return c._isUTC?za(b).zone(c._offset||0):za(b).local()}function Ia(a){return 15*-Math.round(a._d.getTimezoneOffset()/15)}function Ja(b,c){var d,e=this._offset||0;return null!=b?("string"==typeof b&&(b=Ga(b)),Math.abs(b)<16&&(b=60*b),!this._isUTC&&c&&(d=Ia(this)),this._offset=b,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==b&&(!c||this._changeInProgress?Za(this,Ua(b-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this):this._isUTC?e:Ia(this)}function Ka(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function La(a){return this.utcOffset(0,a)}function Ma(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Ia(this),"m")),this}function Na(){return this._tzm?this.utcOffset(this._tzm):"string"==typeof this._i&&this.utcOffset(Ga(this._i)),this}function Oa(a){return a=a?za(a).utcOffset():0,(this.utcOffset()-a)%60===0}function Pa(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Qa(){if(this._a){var a=this._isUTC?i(this._a):za(this._a);return this.isValid()&&p(this._a,a.toArray())>0}return!1}function Ra(){return!this._isUTC}function Sa(){return this._isUTC}function Ta(){return this._isUTC&&0===this._offset}function Ua(a,b){var c,d,e,f=a,h=null;return Ea(a)?f={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(f={},b?f[b]=a:f.milliseconds=a):(h=rd.exec(a))?(c="-"===h[1]?-1:1,f={y:0,d:o(h[ad])*c,h:o(h[bd])*c,m:o(h[cd])*c,s:o(h[dd])*c,ms:o(h[ed])*c}):(h=sd.exec(a))?(c="-"===h[1]?-1:1,f={y:Va(h[2],c),M:Va(h[3],c),d:Va(h[4],c),h:Va(h[5],c),m:Va(h[6],c),s:Va(h[7],c),w:Va(h[8],c)}):null==f?f={}:"object"==typeof f&&("from"in f||"to"in f)&&(e=Xa(za(f.from),za(f.to)),f={},f.ms=e.milliseconds,f.M=e.months),d=new Da(f),Ea(a)&&g(a,"_locale")&&(d._locale=a._locale),d}function Va(a,b){var c=a&&parseFloat(a.replace(",","."));return(isNaN(c)?0:c)*b}function Wa(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Xa(a,b){var c;return b=Ha(b,a),a.isBefore(b)?c=Wa(a,b):(c=Wa(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function Ya(a,b){return function(c,d){var e,f;return null===d||isNaN(+d)||($(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period)."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Ua(c,d),Za(this,e,a),this}}function Za(b,c,d,e){var f=c._milliseconds,g=c._days,h=c._months;e=null==e?!0:e,f&&b._d.setTime(+b._d+f*d),g&&C(b,"Date",B(b,"Date")+g*d),h&&U(b,B(b,"Month")+h*d),e&&a.updateOffset(b,g||h)}function $a(a){var b=a||za(),c=Ha(b,this).startOf("day"),d=this.diff(c,"days",!0),e=-6>d?"sameElse":-1>d?"lastWeek":0>d?"lastDay":1>d?"sameDay":2>d?"nextDay":7>d?"nextWeek":"sameElse";return this.format(this.localeData().calendar(e,this,za(b)))}function _a(){return new m(this)}function ab(a,b){var c;return b=y("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+this>+a):(c=n(a)?+a:+za(a),c<+this.clone().startOf(b))}function bb(a,b){var c;return b=y("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+a>+this):(c=n(a)?+a:+za(a),+this.clone().endOf(b)<c)}function cb(a,b,c){return this.isAfter(a,c)&&this.isBefore(b,c)}function db(a,b){var c;return b=y(b||"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+this===+a):(c=+za(a),+this.clone().startOf(b)<=c&&c<=+this.clone().endOf(b))}function eb(a){return 0>a?Math.ceil(a):Math.floor(a)}function fb(a,b,c){var d,e,f=Ha(a,this),g=6e4*(f.utcOffset()-this.utcOffset());return b=y(b),"year"===b||"month"===b||"quarter"===b?(e=gb(this,f),"quarter"===b?e/=3:"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:eb(e)}function gb(a,b){var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),f=a.clone().add(e,"months");return 0>b-f?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)}function hb(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ib(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?"function"==typeof Date.prototype.toISOString?this.toDate().toISOString():I(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):I(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}function jb(b){var c=I(this,b||a.defaultFormat);return this.localeData().postformat(c)}function kb(a,b){return Ua({to:this,from:a}).locale(this.locale()).humanize(!b)}function lb(a){return this.from(za(),a)}function mb(a){var b;return void 0===a?this._locale._abbr:(b=w(a),null!=b&&(this._locale=b),this)}function nb(){return this._locale}function ob(a){switch(a=y(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function pb(a){return a=y(a),void 0===a||"millisecond"===a?this:this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms")}function qb(){return+this._d-6e4*(this._offset||0)}function rb(){return Math.floor(+this/1e3)}function sb(){return this._offset?new Date(+this):this._d}function tb(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function ub(){return j(this)}function vb(){return h({},this._pf)}function wb(){return this._pf.overflow}function xb(a,b){F(0,[a,a.length],0,b)}function yb(a,b,c){return ga(za([a,11,31+b-c]),b,c).week}function zb(a){var b=ga(this,this.localeData()._week.dow,this.localeData()._week.doy).year;return null==a?b:this.add(a-b,"y")}function Ab(a){var b=ga(this,1,4).year;return null==a?b:this.add(a-b,"y")}function Bb(){return yb(this.year(),1,4)}function Cb(){var a=this.localeData()._week;return yb(this.year(),a.dow,a.doy)}function Db(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}function Eb(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function Fb(a){return this._weekdays[a.day()]}function Gb(a){return this._weekdaysShort[a.day()]}function Hb(a){return this._weekdaysMin[a.day()]}function Ib(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=za([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b}function Jb(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Eb(a,this.localeData()),this.add(a-b,"d")):b}function Kb(a){var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Lb(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)}function Mb(a,b){F(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}function Nb(a,b){return b._meridiemParse}function Ob(a){return"p"===(a+"").toLowerCase().charAt(0)}function Pb(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Qb(a){F(0,[a,3],0,"millisecond")}function Rb(){return this._isUTC?"UTC":""}function Sb(){return this._isUTC?"Coordinated Universal Time":""}function Tb(a){return za(1e3*a)}function Ub(){return za.apply(null,arguments).parseZone()}function Vb(a,b,c){var d=this._calendar[a];return"function"==typeof d?d.call(b,c):d}function Wb(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b}function Xb(){return this._invalidDate}function Yb(a){return this._ordinal.replace("%d",a)}function Zb(a){return a}function $b(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)}function _b(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)}function ac(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b;this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function bc(a,b,c,d){var e=w(),f=i().set(d,b);return e[c](f,a)}function cc(a,b,c,d,e){if("number"==typeof a&&(b=a,a=void 0),a=a||"",null!=b)return bc(a,b,c,e);var f,g=[];for(f=0;d>f;f++)g[f]=bc(a,f,c,e);return g}function dc(a,b){return cc(a,b,"months",12,"month")}function ec(a,b){return cc(a,b,"monthsShort",12,"month")}function fc(a,b){return cc(a,b,"weekdays",7,"day")}function gc(a,b){return cc(a,b,"weekdaysShort",7,"day")}function hc(a,b){return cc(a,b,"weekdaysMin",7,"day")}function ic(){var a=this._data;return this._milliseconds=Od(this._milliseconds),this._days=Od(this._days),this._months=Od(this._months),a.milliseconds=Od(a.milliseconds),a.seconds=Od(a.seconds),a.minutes=Od(a.minutes),a.hours=Od(a.hours),a.months=Od(a.months),a.years=Od(a.years),this}function jc(a,b,c,d){var e=Ua(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}function kc(a,b){return jc(this,a,b,1)}function lc(a,b){return jc(this,a,b,-1)}function mc(){var a,b,c,d=this._milliseconds,e=this._days,f=this._months,g=this._data,h=0;return g.milliseconds=d%1e3,a=eb(d/1e3),g.seconds=a%60,b=eb(a/60),g.minutes=b%60,c=eb(b/60),g.hours=c%24,e+=eb(c/24),h=eb(nc(e)),e-=eb(oc(h)),f+=eb(e/30),e%=30,h+=eb(f/12),f%=12,g.days=e,g.months=f,g.years=h,this}function nc(a){return 400*a/146097}function oc(a){return 146097*a/400}function pc(a){var b,c,d=this._milliseconds;if(a=y(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+12*nc(b),"month"===a?c:c/12;switch(b=this._days+Math.round(oc(this._months/12)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 24*b*60+d/6e4;case"second":return 24*b*60*60+d/1e3;case"millisecond":return Math.floor(24*b*60*60*1e3)+d;default:throw new Error("Unknown unit "+a)}}function qc(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*o(this._months/12)}function rc(a){return function(){return this.as(a)}}function sc(a){return a=y(a),this[a+"s"]()}function tc(a){return function(){return this._data[a]}}function uc(){return eb(this.days()/7)}function vc(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function wc(a,b,c){var d=Ua(a).abs(),e=ce(d.as("s")),f=ce(d.as("m")),g=ce(d.as("h")),h=ce(d.as("d")),i=ce(d.as("M")),j=ce(d.as("y")),k=e<de.s&&["s",e]||1===f&&["m"]||f<de.m&&["mm",f]||1===g&&["h"]||g<de.h&&["hh",g]||1===h&&["d"]||h<de.d&&["dd",h]||1===i&&["M"]||i<de.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,vc.apply(null,k)}function xc(a,b){return void 0===de[a]?!1:void 0===b?de[a]:(de[a]=b,!0)}function yc(a){var b=this.localeData(),c=wc(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function zc(){var a=ee(this.years()),b=ee(this.months()),c=ee(this.days()),d=ee(this.hours()),e=ee(this.minutes()),f=ee(this.seconds()+this.milliseconds()/1e3),g=this.asSeconds();return g?(0>g?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}var Ac,Bc,Cc=a.momentProperties=[],Dc=!1,Ec={},Fc={},Gc=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|x|X|zz?|ZZ?|.)/g,Hc=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Ic={},Jc={},Kc=/\d/,Lc=/\d\d/,Mc=/\d{3}/,Nc=/\d{4}/,Oc=/[+-]?\d{6}/,Pc=/\d\d?/,Qc=/\d{1,3}/,Rc=/\d{1,4}/,Sc=/[+-]?\d{1,6}/,Tc=/\d+/,Uc=/[+-]?\d+/,Vc=/Z|[+-]\d\d:?\d\d/gi,Wc=/[+-]?\d+(\.\d{1,3})?/,Xc=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Yc={},Zc={},$c=0,_c=1,ad=2,bd=3,cd=4,dd=5,ed=6;F("M",["MM",2],"Mo",function(){return this.month()+1}),F("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),F("MMMM",0,0,function(a){return this.localeData().months(this,a)}),x("month","M"),K("M",Pc),K("MM",Pc,Lc),K("MMM",Xc),K("MMMM",Xc),N(["M","MM"],function(a,b){b[_c]=o(a)-1}),N(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);null!=e?b[_c]=e:c._pf.invalidMonth=a});var fd="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),gd="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),hd={};a.suppressDeprecationWarnings=!1;var id=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,jd=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],kd=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],ld=/^\/?Date\((\-?\d+)/i;a.createFromInputFallback=Z("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),F(0,["YY",2],0,function(){return this.year()%100}),F(0,["YYYY",4],0,"year"),F(0,["YYYYY",5],0,"year"),F(0,["YYYYYY",6,!0],0,"year"),x("year","y"),K("Y",Uc),K("YY",Pc,Lc),K("YYYY",Rc,Nc),K("YYYYY",Sc,Oc),K("YYYYYY",Sc,Oc),N(["YYYY","YYYYY","YYYYYY"],$c),N("YY",function(b,c){c[$c]=a.parseTwoDigitYear(b)}),a.parseTwoDigitYear=function(a){return o(a)+(o(a)>68?1900:2e3)};var md=A("FullYear",!1);F("w",["ww",2],"wo","week"),F("W",["WW",2],"Wo","isoWeek"),x("week","w"),x("isoWeek","W"),K("w",Pc),K("ww",Pc,Lc),K("W",Pc),K("WW",Pc,Lc),O(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=o(a)});var nd={dow:0,doy:6};F("DDD",["DDDD",3],"DDDo","dayOfYear"),x("dayOfYear","DDD"),K("DDD",Qc),K("DDDD",Mc),N(["DDD","DDDD"],function(a,b,c){c._dayOfYear=o(a)}),a.ISO_8601=function(){};var od=Z("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(){var a=za.apply(null,arguments);return this>a?this:a}),pd=Z("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(){var a=za.apply(null,arguments);return a>this?this:a});Fa("Z",":"),Fa("ZZ",""),K("Z",Vc),K("ZZ",Vc),N(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ga(a)});var qd=/([\+\-]|\d\d)/gi;a.updateOffset=function(){};var rd=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,sd=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;Ua.fn=Da.prototype;var td=Ya(1,"add"),ud=Ya(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";var vd=Z("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});F(0,["gg",2],0,function(){return this.weekYear()%100}),F(0,["GG",2],0,function(){return this.isoWeekYear()%100}),xb("gggg","weekYear"),xb("ggggg","weekYear"),xb("GGGG","isoWeekYear"),xb("GGGGG","isoWeekYear"),x("weekYear","gg"),x("isoWeekYear","GG"),K("G",Uc),K("g",Uc),K("GG",Pc,Lc),K("gg",Pc,Lc),K("GGGG",Rc,Nc),K("gggg",Rc,Nc),K("GGGGG",Sc,Oc),K("ggggg",Sc,Oc),O(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=o(a)}),O(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),F("Q",0,0,"quarter"),x("quarter","Q"),K("Q",Kc),N("Q",function(a,b){b[_c]=3*(o(a)-1)}),F("D",["DD",2],"Do","date"),x("date","D"),K("D",Pc),K("DD",Pc,Lc),K("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),N(["D","DD"],ad),N("Do",function(a,b){b[ad]=o(a.match(Pc)[0],10)});var wd=A("Date",!0);F("d",0,"do","day"),F("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),F("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),F("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),F("e",0,0,"weekday"),F("E",0,0,"isoWeekday"),x("day","d"),x("weekday","e"),x("isoWeekday","E"),K("d",Pc),K("e",Pc),K("E",Pc),K("dd",Xc),K("ddd",Xc),K("dddd",Xc),O(["dd","ddd","dddd"],function(a,b,c){var d=c._locale.weekdaysParse(a);null!=d?b.d=d:c._pf.invalidWeekday=a}),O(["d","e","E"],function(a,b,c,d){b[d]=o(a)});var xd="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),yd="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),zd="Su_Mo_Tu_We_Th_Fr_Sa".split("_");F("H",["HH",2],0,"hour"),F("h",["hh",2],0,function(){return this.hours()%12||12}),Mb("a",!0),Mb("A",!1),x("hour","h"),K("a",Nb),K("A",Nb),K("H",Pc),K("h",Pc),K("HH",Pc,Lc),K("hh",Pc,Lc),N(["H","HH"],bd),N(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),N(["h","hh"],function(a,b,c){b[bd]=o(a),c._pf.bigHour=!0});var Ad=/[ap]\.?m?\.?/i,Bd=A("Hours",!0);F("m",["mm",2],0,"minute"),x("minute","m"),K("m",Pc),K("mm",Pc,Lc),N(["m","mm"],cd);var Cd=A("Minutes",!1);F("s",["ss",2],0,"second"),x("second","s"),K("s",Pc),K("ss",Pc,Lc),N(["s","ss"],dd);var Dd=A("Seconds",!1);F("S",0,0,function(){return~~(this.millisecond()/100)}),F(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),Qb("SSS"),Qb("SSSS"),x("millisecond","ms"),K("S",Qc,Kc),K("SS",Qc,Lc),K("SSS",Qc,Mc),K("SSSS",Tc),N(["S","SS","SSS","SSSS"],function(a,b){b[ed]=o(1e3*("0."+a))});var Ed=A("Milliseconds",!1);F("z",0,0,"zoneAbbr"),F("zz",0,0,"zoneName");var Fd=m.prototype;Fd.add=td,Fd.calendar=$a,Fd.clone=_a,Fd.diff=fb,Fd.endOf=pb,Fd.format=jb,Fd.from=kb,Fd.fromNow=lb,Fd.get=D,Fd.invalidAt=wb,Fd.isAfter=ab,Fd.isBefore=bb,Fd.isBetween=cb,Fd.isSame=db,Fd.isValid=ub,Fd.lang=vd,Fd.locale=mb,Fd.localeData=nb,Fd.max=pd,Fd.min=od,Fd.parsingFlags=vb,Fd.set=D,Fd.startOf=ob,Fd.subtract=ud,Fd.toArray=tb,Fd.toDate=sb,Fd.toISOString=ib,Fd.toJSON=ib,Fd.toString=hb,Fd.unix=rb,Fd.valueOf=qb,Fd.year=md,Fd.isLeapYear=fa,Fd.weekYear=zb,Fd.isoWeekYear=Ab,Fd.quarter=Fd.quarters=Db,Fd.month=V,Fd.daysInMonth=W,Fd.week=Fd.weeks=ka,Fd.isoWeek=Fd.isoWeeks=la,Fd.weeksInYear=Cb,Fd.isoWeeksInYear=Bb,Fd.date=wd,Fd.day=Fd.days=Jb,Fd.weekday=Kb,Fd.isoWeekday=Lb,Fd.dayOfYear=na,Fd.hour=Fd.hours=Bd,Fd.minute=Fd.minutes=Cd,Fd.second=Fd.seconds=Dd,Fd.millisecond=Fd.milliseconds=Ed,Fd.utcOffset=Ja,Fd.utc=La,Fd.local=Ma,Fd.parseZone=Na,Fd.hasAlignedHourOffset=Oa,Fd.isDST=Pa,Fd.isDSTShifted=Qa,Fd.isLocal=Ra,Fd.isUtcOffset=Sa,Fd.isUtc=Ta,Fd.isUTC=Ta,Fd.zoneAbbr=Rb,Fd.zoneName=Sb,Fd.dates=Z("dates accessor is deprecated. Use date instead.",wd),Fd.months=Z("months accessor is deprecated. Use month instead",V),Fd.years=Z("years accessor is deprecated. Use year instead",md),Fd.zone=Z("moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779",Ka);var Gd=Fd,Hd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},Id={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY LT",LLLL:"dddd, MMMM D, YYYY LT"},Jd="Invalid date",Kd="%d",Ld=/\d{1,2}/,Md={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Nd=q.prototype;Nd._calendar=Hd,Nd.calendar=Vb,Nd._longDateFormat=Id,Nd.longDateFormat=Wb,Nd._invalidDate=Jd,Nd.invalidDate=Xb,Nd._ordinal=Kd,Nd.ordinal=Yb,Nd._ordinalParse=Ld,
Nd.preparse=Zb,Nd.postformat=Zb,Nd._relativeTime=Md,Nd.relativeTime=$b,Nd.pastFuture=_b,Nd.set=ac,Nd.months=R,Nd._months=fd,Nd.monthsShort=S,Nd._monthsShort=gd,Nd.monthsParse=T,Nd.week=ha,Nd._week=nd,Nd.firstDayOfYear=ja,Nd.firstDayOfWeek=ia,Nd.weekdays=Fb,Nd._weekdays=xd,Nd.weekdaysMin=Hb,Nd._weekdaysMin=zd,Nd.weekdaysShort=Gb,Nd._weekdaysShort=yd,Nd.weekdaysParse=Ib,Nd.isPM=Ob,Nd._meridiemParse=Ad,Nd.meridiem=Pb,u("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===o(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),a.lang=Z("moment.lang is deprecated. Use moment.locale instead.",u),a.langData=Z("moment.langData is deprecated. Use moment.localeData instead.",w);var Od=Math.abs,Pd=rc("ms"),Qd=rc("s"),Rd=rc("m"),Sd=rc("h"),Td=rc("d"),Ud=rc("w"),Vd=rc("M"),Wd=rc("y"),Xd=tc("milliseconds"),Yd=tc("seconds"),Zd=tc("minutes"),$d=tc("hours"),_d=tc("days"),ae=tc("months"),be=tc("years"),ce=Math.round,de={s:45,m:45,h:22,d:26,M:11},ee=Math.abs,fe=Da.prototype;fe.abs=ic,fe.add=kc,fe.subtract=lc,fe.as=pc,fe.asMilliseconds=Pd,fe.asSeconds=Qd,fe.asMinutes=Rd,fe.asHours=Sd,fe.asDays=Td,fe.asWeeks=Ud,fe.asMonths=Vd,fe.asYears=Wd,fe.valueOf=qc,fe._bubble=mc,fe.get=sc,fe.milliseconds=Xd,fe.seconds=Yd,fe.minutes=Zd,fe.hours=$d,fe.days=_d,fe.weeks=uc,fe.months=ae,fe.years=be,fe.humanize=yc,fe.toISOString=zc,fe.toString=zc,fe.toJSON=zc,fe.locale=mb,fe.localeData=nb,fe.toIsoString=Z("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",zc),fe.lang=vd,F("X",0,0,"unix"),F("x",0,0,"valueOf"),K("x",Uc),K("X",Wc),N("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),N("x",function(a,b,c){c._d=new Date(o(a))}),a.version="2.10.2",b(za),a.fn=Gd,a.min=Ba,a.max=Ca,a.utc=i,a.unix=Tb,a.months=dc,a.isDate=e,a.locale=u,a.invalid=k,a.duration=Ua,a.isMoment=n,a.weekdays=fc,a.parseZone=Ub,a.localeData=w,a.isDuration=Ea,a.monthsShort=ec,a.weekdaysMin=hc,a.defineLocale=v,a.weekdaysShort=gc,a.normalizeUnits=y,a.relativeTimeThreshold=xc;var ge=a;return ge});
/*!
 * Pikaday
 *
 * Copyright  2014 David Bushell | BSD & MIT license | https://github.com/dbushell/Pikaday
 */

(function (root, factory)
{
    'use strict';

    var moment;
    if (typeof exports === 'object') {
        // CommonJS module
        // Load moment.js as an optional dependency
        try { moment = require('moment'); } catch (e) {}
        module.exports = factory(moment);
    } else if (typeof define === 'function' && define.amd) {
        // AMD. Register as an anonymous module.
        define(function (req)
        {
            // Load moment.js as an optional dependency
            var id = 'moment';
            try { moment = req(id); } catch (e) {}
            return factory(moment);
        });
    } else {
        root.Pikaday = factory(root.moment);
    }
}(this, function (moment)
{
    'use strict';

    /**
     * feature detection and helper functions
     */
    var hasMoment = typeof moment === 'function',

    hasEventListeners = !!window.addEventListener,

    document = window.document,

    sto = window.setTimeout,

    addEvent = function(el, e, callback, capture)
    {
        return;
        if (hasEventListeners) {
            el.addEventListener(e, callback, !!capture);
        } else {
            el.attachEvent('on' + e, callback);
        }
    },

    removeEvent = function(el, e, callback, capture)
    {
        if (hasEventListeners) {
            el.removeEventListener(e, callback, !!capture);
        } else {
            el.detachEvent('on' + e, callback);
        }
    },

    fireEvent = function(el, eventName, data)
    {
        var ev;

        if (document.createEvent) {
            ev = document.createEvent('HTMLEvents');
            ev.initEvent(eventName, true, false);
            ev = extend(ev, data);
            el.dispatchEvent(ev);
        } else if (document.createEventObject) {
            ev = document.createEventObject();
            ev = extend(ev, data);
            el.fireEvent('on' + eventName, ev);
        }
    },

    trim = function(str)
    {
        return str.trim ? str.trim() : str.replace(/^\s+|\s+$/g,'');
    },

    hasClass = function(el, cn)
    {
        return (' ' + el.className + ' ').indexOf(' ' + cn + ' ') !== -1;
    },

    addClass = function(el, cn)
    {
        if (!hasClass(el, cn)) {
            el.className = (el.className === '') ? cn : el.className + ' ' + cn;
        }
    },

    removeClass = function(el, cn)
    {
        el.className = trim((' ' + el.className + ' ').replace(' ' + cn + ' ', ' '));
    },

    isArray = function(obj)
    {
        return (/Array/).test(Object.prototype.toString.call(obj));
    },

    isDate = function(obj)
    {
        return (/Date/).test(Object.prototype.toString.call(obj)) && !isNaN(obj.getTime());
    },

    isWeekend = function(date)
    {
        var day = date.getDay();
        return day === 0 || day === 6;
    },

    isLeapYear = function(year)
    {
        // solution by Matti Virkkunen: http://stackoverflow.com/a/4881951
        return year % 4 === 0 && year % 100 !== 0 || year % 400 === 0;
    },

    getDaysInMonth = function(year, month)
    {
        return [31, isLeapYear(year) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month];
    },

    setToStartOfDay = function(date)
    {
        if (isDate(date)) date.setHours(0,0,0,0);
    },

    compareDates = function(a,b)
    {
        // weak date comparison (use setToStartOfDay(date) to ensure correct result)
        return a.getTime() === b.getTime();
    },

    extend = function(to, from, overwrite)
    {
        var prop, hasProp;
        for (prop in from) {
            hasProp = to[prop] !== undefined;
            if (hasProp && typeof from[prop] === 'object' && from[prop] !== null && from[prop].nodeName === undefined) {
                if (isDate(from[prop])) {
                    if (overwrite) {
                        to[prop] = new Date(from[prop].getTime());
                    }
                }
                else if (isArray(from[prop])) {
                    if (overwrite) {
                        to[prop] = from[prop].slice(0);
                    }
                } else {
                    to[prop] = extend({}, from[prop], overwrite);
                }
            } else if (overwrite || !hasProp) {
                to[prop] = from[prop];
            }
        }
        return to;
    },

    adjustCalendar = function(calendar) {
        if (calendar.month < 0) {
            calendar.year -= Math.ceil(Math.abs(calendar.month)/12);
            calendar.month += 12;
        }
        if (calendar.month > 11) {
            calendar.year += Math.floor(Math.abs(calendar.month)/12);
            calendar.month -= 12;
        }
        return calendar;
    },

    /**
     * defaults and localisation
     */
    defaults = {

        // bind the picker to a form field
        field: null,

        // automatically show/hide the picker on `field` focus (default `true` if `field` is set)
        bound: undefined,

        // position of the datepicker, relative to the field (default to bottom & left)
        // ('bottom' & 'left' keywords are not used, 'top' & 'right' are modifier on the bottom/left position)
        position: 'bottom left',

        // automatically fit in the viewport even if it means repositioning from the position option
        reposition: true,

        // the default output format for `.toString()` and `field` value
        format: 'YYYY/MM/DD',

        // the initial date to view when first opened
        defaultDate: null,

        // make the `defaultDate` the initial selected value
        setDefaultDate: false,

        // first day of week (0: Sunday, 1: Monday etc)
        firstDay: 0,

        // the minimum/earliest date that can be selected
        minDate: null,
        // the maximum/latest date that can be selected
        maxDate: null,

        // number of years either side, or array of upper/lower range
        yearRange: 10,

        // show week numbers at head of row
        showWeekNumber: false,

        // used internally (don't config outside)
        minYear: 0,
        maxYear: 9999,
        minMonth: undefined,
        maxMonth: undefined,

        startRange: null,
        endRange: null,

        isRTL: false,

        // Additional text to append to the year in the calendar title
        yearSuffix: '',

        // Render the month after year in the calendar title
        showMonthAfterYear: false,

        // how many months are visible
        numberOfMonths: 1,

        // when numberOfMonths is used, this will help you to choose where the main calendar will be (default `left`, can be set to `right`)
        // only used for the first display or when a selected date is not visible
        mainCalendar: 'left',

        // Specify a DOM element to render the calendar in
        container: undefined,

        // internationalization
        i18n: {
            previousMonth : 'Mois Prcdent',
            nextMonth     : 'Mois Suivant',
            months        : ['Janvier','Fvrier','Mars','Avril','Mai','Juin','Juillet','Aout','Septembre','Octobre','Novembre','Dcembre'],
            weekdays      : ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'],
            weekdaysShort : ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']
        },

        // Theme Classname
        theme: null,

        // callback function
        onSelect: null,
        onOpen: null,
        onClose: null,
        onDraw: null
    },


    /**
     * templating functions to abstract HTML rendering
     */
    renderDayName = function(opts, day, abbr)
    {
        day += opts.firstDay;
        while (day >= 7) {
            day -= 7;
        }
        return abbr ? opts.i18n.weekdaysShort[day] : opts.i18n.weekdays[day];
    },

    renderDay = function(opts)
    {
        if (opts.isEmpty) {
            return '<td class="is-empty"></td>';
        }
        var arr = [];
        if (opts.isDisabled) {
            arr.push('is-disabled');
        }
        if (opts.isToday) {
            arr.push('is-today');
        }
        if (opts.isSelected) {
            arr.push('is-selected');
        }
        if (opts.isInRange) {
            arr.push('is-inrange');
        }
        if (opts.isStartRange) {
            arr.push('is-startrange');
        }
        if (opts.isEndRange) {
            arr.push('is-endrange');
        }
        return '<td data-day="' + opts.day + '" class="' + arr.join(' ') + '">' +
                 '<button class="pika-button pika-day" type="button" ' +
                    'data-pika-year="' + opts.year + '" data-pika-month="' + opts.month + '" data-pika-day="' + opts.day + '">' +
                        opts.day +
                 '</button>' +
               '</td>';
    },

    renderWeek = function (d, m, y) {
        // Lifted from http://javascript.about.com/library/blweekyear.htm, lightly modified.
        var onejan = new Date(y, 0, 1),
            weekNum = Math.ceil((((new Date(y, m, d) - onejan) / 86400000) + onejan.getDay()+1)/7);
        return '<td class="pika-week">' + weekNum + '</td>';
    },

    renderRow = function(days, isRTL)
    {
        return '<tr>' + (isRTL ? days.reverse() : days).join('') + '</tr>';
    },

    renderBody = function(rows)
    {
        return '<tbody>' + rows.join('') + '</tbody>';
    },

    renderHead = function(opts)
    {
        var i, arr = [];
        if (opts.showWeekNumber) {
            arr.push('<th></th>');
        }
        for (i = 0; i < 7; i++) {
            arr.push('<th scope="col"><abbr title="' + renderDayName(opts, i) + '">' + renderDayName(opts, i, true) + '</abbr></th>');
        }
        return '<thead>' + (opts.isRTL ? arr.reverse() : arr).join('') + '</thead>';
    },

    renderTitle = function(instance, c, year, month, refYear)
    {
        var i, j, arr,
            opts = instance._o,
            isMinYear = year === opts.minYear,
            isMaxYear = year === opts.maxYear,
            html = '<div class="pika-title">',
            monthHtml,
            yearHtml,
            prev = true,
            next = true;

        for (arr = [], i = 0; i < 12; i++) {
            arr.push('<option value="' + (year === refYear ? i - c : 12 + i - c) + '"' +
                (i === month ? ' selected': '') +
                ((isMinYear && i < opts.minMonth) || (isMaxYear && i > opts.maxMonth) ? 'disabled' : '') + '>' +
                opts.i18n.months[i] + '</option>');
        }
        monthHtml = '<div class="pika-label">' + opts.i18n.months[month] + '<select class="pika-select pika-select-month" tabindex="-1">' + arr.join('') + '</select></div>';

        if (isArray(opts.yearRange)) {
            i = opts.yearRange[0];
            j = opts.yearRange[1] + 1;
        } else {
            i = year - opts.yearRange;
            j = 1 + year + opts.yearRange;
        }

        for (arr = []; i < j && i <= opts.maxYear; i++) {
            if (i >= opts.minYear) {
                arr.push('<option value="' + i + '"' + (i === year ? ' selected': '') + '>' + (i) + '</option>');
            }
        }
        yearHtml = '<div class="pika-label">' + year + opts.yearSuffix + '<select class="pika-select pika-select-year" tabindex="-1">' + arr.join('') + '</select></div>';

        if (opts.showMonthAfterYear) {
            html += yearHtml + monthHtml;
        } else {
            html += monthHtml + yearHtml;
        }

        if (isMinYear && (month === 0 || opts.minMonth >= month)) {
            prev = false;
        }

        if (isMaxYear && (month === 11 || opts.maxMonth <= month)) {
            next = false;
        }

        if (c === 0) {
            html += '<button class="pika-prev' + (prev ? '' : ' is-disabled') + '" type="button">' + opts.i18n.previousMonth + '</button>';
        }
        if (c === (instance._o.numberOfMonths - 1) ) {
            html += '<button class="pika-next' + (next ? '' : ' is-disabled') + '" type="button">' + opts.i18n.nextMonth + '</button>';
        }

        return html += '</div>';
    },

    renderTable = function(opts, data)
    {
        return '<table cellpadding="0" cellspacing="0" class="pika-table">' + renderHead(opts) + renderBody(data) + '</table>';
    },


    /**
     * Pikaday constructor
     */
    Pikaday = function(options)
    {
        var self = this,
            opts = self.config(options);

        self._onMouseDown = function(e)
        {
            if (!self._v) {
                return;
            }
            e = e || window.event;
            var target = e.target || e.srcElement;
            if (!target) {
                return;
            }

            if (!hasClass(target.parentNode, 'is-disabled')) {
                if (hasClass(target, 'pika-button') && !hasClass(target, 'is-empty')) {
                    self.setDate(new Date(target.getAttribute('data-pika-year'), target.getAttribute('data-pika-month'), target.getAttribute('data-pika-day')));
                    if (opts.bound) {
                        sto(function() {
                            self.hide();
                            if (opts.field) {
                                opts.field.blur();
                            }
                        }, 100);
                    }
                    return;
                }
                else if (hasClass(target, 'pika-prev')) {
                    self.prevMonth();
                }
                else if (hasClass(target, 'pika-next')) {
                    self.nextMonth();
                }
            }
            if (!hasClass(target, 'pika-select')) {
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                    return false;
                }
            } else {
                self._c = true;
            }
        };

        self._onChange = function(e)
        {
            e = e || window.event;
            var target = e.target || e.srcElement;
            if (!target) {
                return;
            }
            if (hasClass(target, 'pika-select-month')) {
                self.gotoMonth(target.value);
            }
            else if (hasClass(target, 'pika-select-year')) {
                self.gotoYear(target.value);
            }
        };

        self._onInputChange = function(e)
        {
            var date;

            if (e.firedBy === self) {
                return;
            }
            if (hasMoment) {
                date = moment(opts.field.value, opts.format);
                date = (date && date.isValid()) ? date.toDate() : null;
            }
            else {
                date = new Date(Date.parse(opts.field.value));
            }
            if (isDate(date)) {
              self.setDate(date);
            }
            if (!self._v) {
                self.show();
            }
        };

        self._onInputFocus = function()
        {
            self.show();
        };

        self._onInputClick = function()
        {
            self.show();
        };

        self._onInputBlur = function()
        {
            // IE allows pika div to gain focus; catch blur the input field
            var pEl = document.activeElement;
            do {
                if (hasClass(pEl, 'pika-single')) {
                    return;
                }
            }
            while ((pEl = pEl.parentNode));

            if (!self._c) {
                self._b = sto(function() {
                    self.hide();
                }, 50);
            }
            self._c = false;
        };

        self._onClick = function(e)
        {
            e = e || window.event;
            var target = e.target || e.srcElement,
                pEl = target;
            if (!target) {
                return;
            }
            if (!hasEventListeners && hasClass(target, 'pika-select')) {
                if (!target.onchange) {
                    target.setAttribute('onchange', 'return;');
                    addEvent(target, 'change', self._onChange);
                }
            }
            do {
                if (hasClass(pEl, 'pika-single') || pEl === opts.trigger) {
                    return;
                }
            }
            while ((pEl = pEl.parentNode));
            if (self._v && target !== opts.trigger && pEl !== opts.trigger) {
                self.hide();
            }
        };

        self.el = document.createElement('div');
        self.el.className = 'pika-single' + (opts.isRTL ? ' is-rtl' : '') + (opts.theme ? ' ' + opts.theme : '');

        addEvent(self.el, 'ontouchend' in document ? 'touchend' : 'mousedown', self._onMouseDown, true);
        addEvent(self.el, 'change', self._onChange);

        if (opts.field) {
            if (opts.container) {
                opts.container.appendChild(self.el);
            } else if (opts.bound) {
                document.body.appendChild(self.el);
            } else {
                opts.field.parentNode.insertBefore(self.el, opts.field.nextSibling);
            }
            addEvent(opts.field, 'change', self._onInputChange);

            if (!opts.defaultDate) {
                if (hasMoment && opts.field.value) {
                    opts.defaultDate = moment(opts.field.value, opts.format).toDate();
                } else {
                    opts.defaultDate = new Date(Date.parse(opts.field.value));
                }
                opts.setDefaultDate = true;
            }
        }

        var defDate = opts.defaultDate;

        if (isDate(defDate)) {
            if (opts.setDefaultDate) {
                self.setDate(defDate, true);
            } else {
                self.gotoDate(defDate);
            }
        } else {
            self.gotoDate(new Date());
        }

        if (opts.bound) {
            this.hide();
            self.el.className += ' is-bound';
            addEvent(opts.trigger, 'click', self._onInputClick);
            addEvent(opts.trigger, 'mousedown', self._onInputClick);
            addEvent(opts.trigger, 'focus', self._onInputFocus);
            addEvent(opts.trigger, 'blur', self._onInputBlur);
        } else {
            this.hide();
            //this.show();
        }
    };


    /**
     * public Pikaday API
     */
    Pikaday.prototype = {


        /**
         * configure functionality
         */
        config: function(options)
        {
            if (!this._o) {
                this._o = extend({}, defaults, true);
            }

            var opts = extend(this._o, options, true);

            opts.isRTL = !!opts.isRTL;

            opts.field = (opts.field && opts.field.nodeName) ? opts.field : null;

            opts.theme = (typeof opts.theme) === 'string' && opts.theme ? opts.theme : null;

            opts.bound = !!(opts.bound !== undefined ? opts.field && opts.bound : opts.field);

            opts.trigger = (opts.trigger && opts.trigger.nodeName) ? opts.trigger : opts.field;

            opts.disableWeekends = !!opts.disableWeekends;

            opts.disableDayFn = (typeof opts.disableDayFn) === 'function' ? opts.disableDayFn : null;

            var nom = parseInt(opts.numberOfMonths, 10) || 1;
            opts.numberOfMonths = nom > 4 ? 4 : nom;

            if (!isDate(opts.minDate)) {
                opts.minDate = false;
            }
            if (!isDate(opts.maxDate)) {
                opts.maxDate = false;
            }
            if ((opts.minDate && opts.maxDate) && opts.maxDate < opts.minDate) {
                opts.maxDate = opts.minDate = false;
            }
            if (opts.minDate) {
                this.setMinDate(opts.minDate);
            }
            if (opts.maxDate) {
                setToStartOfDay(opts.maxDate);
                opts.maxYear  = opts.maxDate.getFullYear();
                opts.maxMonth = opts.maxDate.getMonth();
            }

            if (isArray(opts.yearRange)) {
                var fallback = new Date().getFullYear() - 10;
                opts.yearRange[0] = parseInt(opts.yearRange[0], 10) || fallback;
                opts.yearRange[1] = parseInt(opts.yearRange[1], 10) || fallback;
            } else {
                opts.yearRange = Math.abs(parseInt(opts.yearRange, 10)) || defaults.yearRange;
                if (opts.yearRange > 100) {
                    opts.yearRange = 100;
                }
            }

            return opts;
        },

        /**
         * return a formatted string of the current selection (using Moment.js if available)
         */
        toString: function(format)
        {
            return !isDate(this._d) ? '' : hasMoment ? moment(this._d).format(format || this._o.format) : this._d.toDateString();
        },

        /**
         * return a Moment.js object of the current selection (if available)
         */
        getMoment: function()
        {
            //return hasMoment ? moment(this._d) : null;
        },

        /**
         * set the current selection from a Moment.js object (if available)
         */
        setMoment: function(date, preventOnSelect)
        {
            if (hasMoment && moment.isMoment(date)) {
                this.setDate(date.toDate(), preventOnSelect);
            }
        },

        /**
         * return a Date object of the current selection
         */
        getDate: function()
        {
            return isDate(this._d) ? new Date(this._d.getTime()) : null;
        },

        /**
         * set the current selection
         */
        setDate: function(date, preventOnSelect)
        {
            if (!date) {
                this._d = null;

                if (this._o.field) {
                    this._o.field.value = '';
                    fireEvent(this._o.field, 'change', { firedBy: this });
                }

                return this.draw();
            }
            if (typeof date === 'string') {
                date = new Date(Date.parse(date));
            }
            if (!isDate(date)) {
                return;
            }

            var min = this._o.minDate,
                max = this._o.maxDate;

            if (isDate(min) && date < min) {
                date = min;
            } else if (isDate(max) && date > max) {
                date = max;
            }

            this._d = new Date(date.getTime());
            setToStartOfDay(this._d);
            this.gotoDate(this._d);

            if (this._o.field) {
                this._o.field.value = this.toString();
                fireEvent(this._o.field, 'change', { firedBy: this });
            }
            if (!preventOnSelect && typeof this._o.onSelect === 'function') {
                this._o.onSelect.call(this, this.getDate());
            }
        },

        /**
         * change view to a specific date
         */
        gotoDate: function(date)
        {
            var newCalendar = true;

            if (!isDate(date)) {
                return;
            }

            if (this.calendars) {
                var firstVisibleDate = new Date(this.calendars[0].year, this.calendars[0].month, 1),
                    lastVisibleDate = new Date(this.calendars[this.calendars.length-1].year, this.calendars[this.calendars.length-1].month, 1),
                    visibleDate = date.getTime();
                // get the end of the month
                lastVisibleDate.setMonth(lastVisibleDate.getMonth()+1);
                lastVisibleDate.setDate(lastVisibleDate.getDate()-1);
                newCalendar = (visibleDate < firstVisibleDate.getTime() || lastVisibleDate.getTime() < visibleDate);
            }

            if (newCalendar) {
                this.calendars = [{
                    month: date.getMonth(),
                    year: date.getFullYear()
                }];
                if (this._o.mainCalendar === 'right') {
                    this.calendars[0].month += 1 - this._o.numberOfMonths;
                }
            }

            this.adjustCalendars();
        },

        adjustCalendars: function() {
            this.calendars[0] = adjustCalendar(this.calendars[0]);
            for (var c = 1; c < this._o.numberOfMonths; c++) {
                this.calendars[c] = adjustCalendar({
                    month: this.calendars[0].month + c,
                    year: this.calendars[0].year
                });
            }
            this.draw();
        },

        gotoToday: function()
        {
            this.gotoDate(new Date());
        },

        /**
         * change view to a specific month (zero-index, e.g. 0: January)
         */
        gotoMonth: function(month)
        {
            if (!isNaN(month)) {
                this.calendars[0].month = parseInt(month, 10);
                this.adjustCalendars();
            }
        },

        nextMonth: function()
        {
            this.calendars[0].month++;
            this.adjustCalendars();
        },

        prevMonth: function()
        {
            this.calendars[0].month--;
            this.adjustCalendars();
        },

        /**
         * change view to a specific full year (e.g. "2012")
         */
        gotoYear: function(year)
        {
            if (!isNaN(year)) {
                this.calendars[0].year = parseInt(year, 10);
                this.adjustCalendars();
            }
        },

        /**
         * change the minDate
         */
        setMinDate: function(value)
        {
            setToStartOfDay(value);
            this._o.minDate = value;
            this._o.minYear  = value.getFullYear();
            this._o.minMonth = value.getMonth();
        },

        /**
         * change the maxDate
         */
        setMaxDate: function(value)
        {
            this._o.maxDate = value;
        },

        setStartRange: function(value)
        {
            this._o.startRange = value;
        },

        setEndRange: function(value)
        {
            this._o.endRange = value;
        },

        /**
         * refresh the HTML
         */
        draw: function(force)
        {
            if (!this._v && !force) {
                return;
            }
            var opts = this._o,
                minYear = opts.minYear,
                maxYear = opts.maxYear,
                minMonth = opts.minMonth,
                maxMonth = opts.maxMonth,
                html = '';

            if (this._y <= minYear) {
                this._y = minYear;
                if (!isNaN(minMonth) && this._m < minMonth) {
                    this._m = minMonth;
                }
            }
            if (this._y >= maxYear) {
                this._y = maxYear;
                if (!isNaN(maxMonth) && this._m > maxMonth) {
                    this._m = maxMonth;
                }
            }

            for (var c = 0; c < opts.numberOfMonths; c++) {
                html += '<div class="pika-lendar">' + renderTitle(this, c, this.calendars[c].year, this.calendars[c].month, this.calendars[0].year) + this.render(this.calendars[c].year, this.calendars[c].month) + '</div>';
            }

            this.el.innerHTML = html;

            if (opts.bound) {
                if(opts.field.type !== 'hidden') {
                    sto(function() {
                        opts.trigger.focus();
                    }, 1);
                }
            }

            if (typeof this._o.onDraw === 'function') {
                var self = this;
                sto(function() {
                    self._o.onDraw.call(self);
                }, 0);
            }
        },

        adjustPosition: function()
        {
            this.el.style.position = 'absolute';
            this.el.style.left = '50%';
            this.el.style.top = '50px';
            return;
            
            var field, pEl, width, height, viewportWidth, viewportHeight, scrollTop, left, top, clientRect;
            
            if (this._o.container) return;
            
            
            /*
            field = this._o.trigger;
            pEl = field;
            width = this.el.offsetWidth;
            height = this.el.offsetHeight;
            viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            scrollTop = window.pageYOffset || document.body.scrollTop || document.documentElement.scrollTop;

            if (typeof field.getBoundingClientRect === 'function') {
                clientRect = field.getBoundingClientRect();
                left = clientRect.left + window.pageXOffset;
                top = clientRect.bottom + window.pageYOffset;
            } else {
                left = pEl.offsetLeft;
                top  = pEl.offsetTop + pEl.offsetHeight;
                while((pEl = pEl.offsetParent)) {
                    left += pEl.offsetLeft;
                    top  += pEl.offsetTop;
                }
            }

            // default position is bottom & left
            if ((this._o.reposition && left + width > viewportWidth) ||
                (
                    this._o.position.indexOf('right') > -1 &&
                    left - width + field.offsetWidth > 0
                )
            ) {
                left = left - width + field.offsetWidth;
            }
            if ((this._o.reposition && top + height > viewportHeight + scrollTop) ||
                (
                    this._o.position.indexOf('top') > -1 &&
                    top - height - field.offsetHeight > 0
                )
            ) {
                top = top - height - field.offsetHeight;
            } */

        },

        /**
         * render HTML for a particular month
         */
        render: function(year, month)
        {
            var opts   = this._o,
                now    = new Date(),
                days   = getDaysInMonth(year, month),
                before = new Date(year, month, 1).getDay(),
                data   = [],
                row    = [];
            setToStartOfDay(now);
            if (opts.firstDay > 0) {
                before -= opts.firstDay;
                if (before < 0) {
                    before += 7;
                }
            }
            var cells = days + before,
                after = cells;
            while(after > 7) {
                after -= 7;
            }
            cells += 7 - after;
            for (var i = 0, r = 0; i < cells; i++)
            {
                var day = new Date(year, month, 1 + (i - before)),
                    isSelected = isDate(this._d) ? compareDates(day, this._d) : false,
                    isToday = compareDates(day, now),
                    isEmpty = i < before || i >= (days + before),
                    isStartRange = opts.startRange && compareDates(opts.startRange, day),
                    isEndRange = opts.endRange && compareDates(opts.endRange, day),
                    isInRange = opts.startRange && opts.endRange && opts.startRange < day && day < opts.endRange,
                    isDisabled = (opts.minDate && day < opts.minDate) ||
                                 (opts.maxDate && day > opts.maxDate) ||
                                 (opts.disableWeekends && isWeekend(day)) ||
                                 (opts.disableDayFn && opts.disableDayFn(day)),
                    dayConfig = {
                        day: 1 + (i - before),
                        month: month,
                        year: year,
                        isSelected: isSelected,
                        isToday: isToday,
                        isDisabled: isDisabled,
                        isEmpty: isEmpty,
                        isStartRange: isStartRange,
                        isEndRange: isEndRange,
                        isInRange: isInRange
                    };

                row.push(renderDay(dayConfig));

                if (++r === 7) {
                    if (opts.showWeekNumber) {
                        row.unshift(renderWeek(i - before, month, year));
                    }
                    data.push(renderRow(row, opts.isRTL));
                    row = [];
                    r = 0;
                }
            }
            return renderTable(opts, data);
        },

        isVisible: function()
        {
            return this._v;
        },

        show: function()
        {
            if (!this._v) {
                removeClass(this.el, 'is-hidden');
                this._v = true;
                this.draw();
                if (this._o.bound) {
                    addEvent(document, 'click', this._onClick);
                    addEvent(document, 'mousedown', this._onClick);
                    this.adjustPosition();
                }
                if (typeof this._o.onOpen === 'function') {
                    this._o.onOpen.call(this);
                }
            }
        },

        hide: function()
        {
            var v = this._v;
            if (v !== false) {
                if (this._o.bound) {
                    removeEvent(document, 'click', this._onClick);
                    removeEvent(document, 'mousedown', this._onClick);
                }
                this.el.style.position = 'absolute'; // reset
                this.el.style.left = '50%';
                this.el.style.top = '50px';
                addClass(this.el, 'is-hidden');
                this._v = false;
                if (v !== undefined && typeof this._o.onClose === 'function') {
                    this._o.onClose.call(this);
                }
            }
        },

        /**
         * GAME OVER
         */
        destroy: function()
        {
            this.hide();
            removeEvent(this.el, 'mousedown', this._onMouseDown, true);
            removeEvent(this.el, 'change', this._onChange);
            if (this._o.field) {
                removeEvent(this._o.field, 'change', this._onInputChange);
                if (this._o.bound) {
                    removeEvent(this._o.trigger, 'click', this._onInputClick);
                    removeEvent(this._o.trigger, 'focus', this._onInputFocus);
                    removeEvent(this._o.trigger, 'blur', this._onInputBlur);
                }
            }
            if (this.el.parentNode) {
                this.el.parentNode.removeChild(this.el);
            }
        }

    };

    return Pikaday;

}));
/*! nouislider - 8.3.0 - 2016-02-14 17:37:19 */

(function (factory) {

    if ( typeof define === 'function' && define.amd ) {

        // AMD. Register as an anonymous module.
        define([], factory);

    } else if ( typeof exports === 'object' ) {

        // Node/CommonJS
        module.exports = factory();

    } else {

        // Browser globals
        window.noUiSlider = factory();
    }

}(function( ){

	'use strict';


	// Removes duplicates from an array.
	function unique(array) {
		return array.filter(function(a){
			return !this[a] ? this[a] = true : false;
		}, {});
	}

	// Round a value to the closest 'to'.
	function closest ( value, to ) {
		return Math.round(value / to) * to;
	}

	// Current position of an element relative to the document.
	function offset ( elem ) {

	var rect = elem.getBoundingClientRect(),
		doc = elem.ownerDocument,
		docElem = doc.documentElement,
		pageOffset = getPageOffset();

		// getBoundingClientRect contains left scroll in Chrome on Android.
		// I haven't found a feature detection that proves this. Worst case
		// scenario on mis-match: the 'tap' feature on horizontal sliders breaks.
		if ( /webkit.*Chrome.*Mobile/i.test(navigator.userAgent) ) {
			pageOffset.x = 0;
		}

		return {
			top: rect.top + pageOffset.y - docElem.clientTop,
			left: rect.left + pageOffset.x - docElem.clientLeft
		};
	}

	// Checks whether a value is numerical.
	function isNumeric ( a ) {
		return typeof a === 'number' && !isNaN( a ) && isFinite( a );
	}

	// Rounds a number to 7 supported decimals.
	function accurateNumber( number ) {
		var p = Math.pow(10, 7);
		return Number((Math.round(number*p)/p).toFixed(7));
	}

	// Sets a class and removes it after [duration] ms.
	function addClassFor ( element, className, duration ) {
		addClass(element, className);
		setTimeout(function(){
			removeClass(element, className);
		}, duration);
	}

	// Limits a value to 0 - 100
	function limit ( a ) {
		return Math.max(Math.min(a, 100), 0);
	}

	// Wraps a variable as an array, if it isn't one yet.
	function asArray ( a ) {
		return Array.isArray(a) ? a : [a];
	}

	// Counts decimals
	function countDecimals ( numStr ) {
		var pieces = numStr.split(".");
		return pieces.length > 1 ? pieces[1].length : 0;
	}

	// http://youmightnotneedjquery.com/#add_class
	function addClass ( el, className ) {
		if ( el.classList ) {
			el.classList.add(className);
		} else {
			el.className += ' ' + className;
		}
	}

	// http://youmightnotneedjquery.com/#remove_class
	function removeClass ( el, className ) {
		if ( el.classList ) {
			el.classList.remove(className);
		} else {
			el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
		}
	}

	// https://plainjs.com/javascript/attributes/adding-removing-and-testing-for-classes-9/
	function hasClass ( el, className ) {
		return el.classList ? el.classList.contains(className) : new RegExp('\\b' + className + '\\b').test(el.className);
	}

	// https://developer.mozilla.org/en-US/docs/Web/API/Window/scrollY#Notes
	function getPageOffset ( ) {

		var supportPageOffset = window.pageXOffset !== undefined,
			isCSS1Compat = ((document.compatMode || "") === "CSS1Compat"),
			x = supportPageOffset ? window.pageXOffset : isCSS1Compat ? document.documentElement.scrollLeft : document.body.scrollLeft,
			y = supportPageOffset ? window.pageYOffset : isCSS1Compat ? document.documentElement.scrollTop : document.body.scrollTop;

		return {
			x: x,
			y: y
		};
	}

	// Shorthand for stopPropagation so we don't have to create a dynamic method
	function stopPropagation ( e ) {
		e.stopPropagation();
	}

	// todo
	function addCssPrefix(cssPrefix) {
		return function(className) {
			return cssPrefix + className;
		};
	}


	var
	// Determine the events to bind. IE11 implements pointerEvents without
	// a prefix, which breaks compatibility with the IE10 implementation.
	/** @const */
	actions = window.navigator.pointerEnabled ? {
		start: 'pointerdown',
		move: 'pointermove',
		end: 'pointerup'
	} : window.navigator.msPointerEnabled ? {
		start: 'MSPointerDown',
		move: 'MSPointerMove',
		end: 'MSPointerUp'
	} : {
		start: 'mousedown touchstart',
		move: 'mousemove touchmove',
		end: 'mouseup touchend'
	},
	defaultCssPrefix = 'noUi-';


// Value calculation

	// Determine the size of a sub-range in relation to a full range.
	function subRangeRatio ( pa, pb ) {
		return (100 / (pb - pa));
	}

	// (percentage) How many percent is this value of this range?
	function fromPercentage ( range, value ) {
		return (value * 100) / ( range[1] - range[0] );
	}

	// (percentage) Where is this value on this range?
	function toPercentage ( range, value ) {
		return fromPercentage( range, range[0] < 0 ?
			value + Math.abs(range[0]) :
				value - range[0] );
	}

	// (value) How much is this percentage on this range?
	function isPercentage ( range, value ) {
		return ((value * ( range[1] - range[0] )) / 100) + range[0];
	}


// Range conversion

	function getJ ( value, arr ) {

		var j = 1;

		while ( value >= arr[j] ){
			j += 1;
		}

		return j;
	}

	// (percentage) Input a value, find where, on a scale of 0-100, it applies.
	function toStepping ( xVal, xPct, value ) {

		if ( value >= xVal.slice(-1)[0] ){
			return 100;
		}

		var j = getJ( value, xVal ), va, vb, pa, pb;

		va = xVal[j-1];
		vb = xVal[j];
		pa = xPct[j-1];
		pb = xPct[j];

		return pa + (toPercentage([va, vb], value) / subRangeRatio (pa, pb));
	}

	// (value) Input a percentage, find where it is on the specified range.
	function fromStepping ( xVal, xPct, value ) {

		// There is no range group that fits 100
		if ( value >= 100 ){
			return xVal.slice(-1)[0];
		}

		var j = getJ( value, xPct ), va, vb, pa, pb;

		va = xVal[j-1];
		vb = xVal[j];
		pa = xPct[j-1];
		pb = xPct[j];

		return isPercentage([va, vb], (value - pa) * subRangeRatio (pa, pb));
	}

	// (percentage) Get the step that applies at a certain value.
	function getStep ( xPct, xSteps, snap, value ) {

		if ( value === 100 ) {
			return value;
		}

		var j = getJ( value, xPct ), a, b;

		// If 'snap' is set, steps are used as fixed points on the slider.
		if ( snap ) {

			a = xPct[j-1];
			b = xPct[j];

			// Find the closest position, a or b.
			if ((value - a) > ((b-a)/2)){
				return b;
			}

			return a;
		}

		if ( !xSteps[j-1] ){
			return value;
		}

		return xPct[j-1] + closest(
			value - xPct[j-1],
			xSteps[j-1]
		);
	}


// Entry parsing

	function handleEntryPoint ( index, value, that ) {

		var percentage;

		// Wrap numerical input in an array.
		if ( typeof value === "number" ) {
			value = [value];
		}

		// Reject any invalid input, by testing whether value is an array.
		if ( Object.prototype.toString.call( value ) !== '[object Array]' ){
			throw new Error("noUiSlider: 'range' contains invalid value.");
		}

		// Covert min/max syntax to 0 and 100.
		if ( index === 'min' ) {
			percentage = 0;
		} else if ( index === 'max' ) {
			percentage = 100;
		} else {
			percentage = parseFloat( index );
		}

		// Check for correct input.
		if ( !isNumeric( percentage ) || !isNumeric( value[0] ) ) {
			throw new Error("noUiSlider: 'range' value isn't numeric.");
		}

		// Store values.
		that.xPct.push( percentage );
		that.xVal.push( value[0] );

		// NaN will evaluate to false too, but to keep
		// logging clear, set step explicitly. Make sure
		// not to override the 'step' setting with false.
		if ( !percentage ) {
			if ( !isNaN( value[1] ) ) {
				that.xSteps[0] = value[1];
			}
		} else {
			that.xSteps.push( isNaN(value[1]) ? false : value[1] );
		}
	}

	function handleStepPoint ( i, n, that ) {

		// Ignore 'false' stepping.
		if ( !n ) {
			return true;
		}

		// Factor to range ratio
		that.xSteps[i] = fromPercentage([
			 that.xVal[i]
			,that.xVal[i+1]
		], n) / subRangeRatio (
			that.xPct[i],
			that.xPct[i+1] );
	}


// Interface

	// The interface to Spectrum handles all direction-based
	// conversions, so the above values are unaware.

	function Spectrum ( entry, snap, direction, singleStep ) {

		this.xPct = [];
		this.xVal = [];
		this.xSteps = [ singleStep || false ];
		this.xNumSteps = [ false ];

		this.snap = snap;
		this.direction = direction;

		var index, ordered = [ /* [0, 'min'], [1, '50%'], [2, 'max'] */ ];

		// Map the object keys to an array.
		for ( index in entry ) {
			if ( entry.hasOwnProperty(index) ) {
				ordered.push([entry[index], index]);
			}
		}

		// Sort all entries by value (numeric sort).
		if ( ordered.length && typeof ordered[0][0] === "object" ) {
			ordered.sort(function(a, b) { return a[0][0] - b[0][0]; });
		} else {
			ordered.sort(function(a, b) { return a[0] - b[0]; });
		}


		// Convert all entries to subranges.
		for ( index = 0; index < ordered.length; index++ ) {
			handleEntryPoint(ordered[index][1], ordered[index][0], this);
		}

		// Store the actual step values.
		// xSteps is sorted in the same order as xPct and xVal.
		this.xNumSteps = this.xSteps.slice(0);

		// Convert all numeric steps to the percentage of the subrange they represent.
		for ( index = 0; index < this.xNumSteps.length; index++ ) {
			handleStepPoint(index, this.xNumSteps[index], this);
		}
	}

	Spectrum.prototype.getMargin = function ( value ) {
		return this.xPct.length === 2 ? fromPercentage(this.xVal, value) : false;
	};

	Spectrum.prototype.toStepping = function ( value ) {

		value = toStepping( this.xVal, this.xPct, value );

		// Invert the value if this is a right-to-left slider.
		if ( this.direction ) {
			value = 100 - value;
		}

		return value;
	};

	Spectrum.prototype.fromStepping = function ( value ) {

		// Invert the value if this is a right-to-left slider.
		if ( this.direction ) {
			value = 100 - value;
		}

		return accurateNumber(fromStepping( this.xVal, this.xPct, value ));
	};

	Spectrum.prototype.getStep = function ( value ) {

		// Find the proper step for rtl sliders by search in inverse direction.
		// Fixes issue #262.
		if ( this.direction ) {
			value = 100 - value;
		}

		value = getStep(this.xPct, this.xSteps, this.snap, value );

		if ( this.direction ) {
			value = 100 - value;
		}

		return value;
	};

	Spectrum.prototype.getApplicableStep = function ( value ) {

		// If the value is 100%, return the negative step twice.
		var j = getJ(value, this.xPct), offset = value === 100 ? 2 : 1;
		return [this.xNumSteps[j-2], this.xVal[j-offset], this.xNumSteps[j-offset]];
	};

	// Outside testing
	Spectrum.prototype.convert = function ( value ) {
		return this.getStep(this.toStepping(value));
	};

/*	Every input option is tested and parsed. This'll prevent
	endless validation in internal methods. These tests are
	structured with an item for every option available. An
	option can be marked as required by setting the 'r' flag.
	The testing function is provided with three arguments:
		- The provided value for the option;
		- A reference to the options object;
		- The name for the option;

	The testing function returns false when an error is detected,
	or true when everything is OK. It can also modify the option
	object, to make sure all values can be correctly looped elsewhere. */

	var defaultFormatter = { 'to': function( value ){
		return value !== undefined && value.toFixed(2);
	}, 'from': Number };

	function testStep ( parsed, entry ) {

		if ( !isNumeric( entry ) ) {
			throw new Error("noUiSlider: 'step' is not numeric.");
		}

		// The step option can still be used to set stepping
		// for linear sliders. Overwritten if set in 'range'.
		parsed.singleStep = entry;
	}

	function testRange ( parsed, entry ) {

		// Filter incorrect input.
		if ( typeof entry !== 'object' || Array.isArray(entry) ) {
			throw new Error("noUiSlider: 'range' is not an object.");
		}

		// Catch missing start or end.
		if ( entry.min === undefined || entry.max === undefined ) {
			throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");
		}

		// Catch equal start or end.
		if ( entry.min === entry.max ) {
			throw new Error("noUiSlider: 'range' 'min' and 'max' cannot be equal.");
		}

		parsed.spectrum = new Spectrum(entry, parsed.snap, parsed.dir, parsed.singleStep);
	}

	function testStart ( parsed, entry ) {

		entry = asArray(entry);

		// Validate input. Values aren't tested, as the public .val method
		// will always provide a valid location.
		if ( !Array.isArray( entry ) || !entry.length || entry.length > 2 ) {
			throw new Error("noUiSlider: 'start' option is incorrect.");
		}

		// Store the number of handles.
		parsed.handles = entry.length;

		// When the slider is initialized, the .val method will
		// be called with the start options.
		parsed.start = entry;
	}

	function testSnap ( parsed, entry ) {

		// Enforce 100% stepping within subranges.
		parsed.snap = entry;

		if ( typeof entry !== 'boolean' ){
			throw new Error("noUiSlider: 'snap' option must be a boolean.");
		}
	}

	function testAnimate ( parsed, entry ) {

		// Enforce 100% stepping within subranges.
		parsed.animate = entry;

		if ( typeof entry !== 'boolean' ){
			throw new Error("noUiSlider: 'animate' option must be a boolean.");
		}
	}

	function testConnect ( parsed, entry ) {

		if ( entry === 'lower' && parsed.handles === 1 ) {
			parsed.connect = 1;
		} else if ( entry === 'upper' && parsed.handles === 1 ) {
			parsed.connect = 2;
		} else if ( entry === true && parsed.handles === 2 ) {
			parsed.connect = 3;
		} else if ( entry === false ) {
			parsed.connect = 0;
		} else {
			throw new Error("noUiSlider: 'connect' option doesn't match handle count.");
		}
	}

	function testOrientation ( parsed, entry ) {

		// Set orientation to an a numerical value for easy
		// array selection.
		switch ( entry ){
		  case 'horizontal':
			parsed.ort = 0;
			break;
		  case 'vertical':
			parsed.ort = 1;
			break;
		  default:
			throw new Error("noUiSlider: 'orientation' option is invalid.");
		}
	}

	function testMargin ( parsed, entry ) {

		if ( !isNumeric(entry) ){
			throw new Error("noUiSlider: 'margin' option must be numeric.");
		}

		// Issue #582
		if ( entry === 0 ) {
			return;
		}

		parsed.margin = parsed.spectrum.getMargin(entry);

		if ( !parsed.margin ) {
			throw new Error("noUiSlider: 'margin' option is only supported on linear sliders.");
		}
	}

	function testLimit ( parsed, entry ) {

		if ( !isNumeric(entry) ){
			throw new Error("noUiSlider: 'limit' option must be numeric.");
		}

		parsed.limit = parsed.spectrum.getMargin(entry);

		if ( !parsed.limit ) {
			throw new Error("noUiSlider: 'limit' option is only supported on linear sliders.");
		}
	}

	function testDirection ( parsed, entry ) {

		// Set direction as a numerical value for easy parsing.
		// Invert connection for RTL sliders, so that the proper
		// handles get the connect/background classes.
		switch ( entry ) {
		  case 'ltr':
			parsed.dir = 0;
			break;
		  case 'rtl':
			parsed.dir = 1;
			parsed.connect = [0,2,1,3][parsed.connect];
			break;
		  default:
			throw new Error("noUiSlider: 'direction' option was not recognized.");
		}
	}

	function testBehaviour ( parsed, entry ) {

		// Make sure the input is a string.
		if ( typeof entry !== 'string' ) {
			throw new Error("noUiSlider: 'behaviour' must be a string containing options.");
		}

		// Check if the string contains any keywords.
		// None are required.
		var tap = entry.indexOf('tap') >= 0,
			drag = entry.indexOf('drag') >= 0,
			fixed = entry.indexOf('fixed') >= 0,
			snap = entry.indexOf('snap') >= 0,
			hover = entry.indexOf('hover') >= 0;

		// Fix #472
		if ( drag && !parsed.connect ) {
			throw new Error("noUiSlider: 'drag' behaviour must be used with 'connect': true.");
		}

		parsed.events = {
			tap: tap || snap,
			drag: drag,
			fixed: fixed,
			snap: snap,
			hover: hover
		};
	}

	function testTooltips ( parsed, entry ) {

		var i;

		if ( entry === false ) {
			return;
		} else if ( entry === true ) {

			parsed.tooltips = [];

			for ( i = 0; i < parsed.handles; i++ ) {
				parsed.tooltips.push(true);
			}

		} else {

			parsed.tooltips = asArray(entry);

			if ( parsed.tooltips.length !== parsed.handles ) {
				throw new Error("noUiSlider: must pass a formatter for all handles.");
			}

			parsed.tooltips.forEach(function(formatter){
				if ( typeof formatter !== 'boolean' && (typeof formatter !== 'object' || typeof formatter.to !== 'function') ) {
					throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.");
				}
			});
		}
	}

	function testFormat ( parsed, entry ) {

		parsed.format = entry;

		// Any object with a to and from method is supported.
		if ( typeof entry.to === 'function' && typeof entry.from === 'function' ) {
			return true;
		}

		throw new Error( "noUiSlider: 'format' requires 'to' and 'from' methods.");
	}

	function testCssPrefix ( parsed, entry ) {

		if ( entry !== undefined && typeof entry !== 'string' ) {
			throw new Error( "noUiSlider: 'cssPrefix' must be a string.");
		}

		parsed.cssPrefix = entry;
	}

	// Test all developer settings and parse to assumption-safe values.
	function testOptions ( options ) {

		// To prove a fix for #537, freeze options here.
		// If the object is modified, an error will be thrown.
		// Object.freeze(options);

		var parsed = {
			margin: 0,
			limit: 0,
			animate: true,
			format: defaultFormatter
		}, tests;

		// Tests are executed in the order they are presented here.
		tests = {
			'step': { r: false, t: testStep },
			'start': { r: true, t: testStart },
			'connect': { r: true, t: testConnect },
			'direction': { r: true, t: testDirection },
			'snap': { r: false, t: testSnap },
			'animate': { r: false, t: testAnimate },
			'range': { r: true, t: testRange },
			'orientation': { r: false, t: testOrientation },
			'margin': { r: false, t: testMargin },
			'limit': { r: false, t: testLimit },
			'behaviour': { r: true, t: testBehaviour },
			'format': { r: false, t: testFormat },
			'tooltips': { r: false, t: testTooltips },
			'cssPrefix': { r: false, t: testCssPrefix }
		};

		var defaults = {
			'connect': false,
			'direction': 'ltr',
			'behaviour': 'tap',
			'orientation': 'horizontal'
		};

		// Run all options through a testing mechanism to ensure correct
		// input. It should be noted that options might get modified to
		// be handled properly. E.g. wrapping integers in arrays.
		Object.keys(tests).forEach(function( name ){

			// If the option isn't set, but it is required, throw an error.
			if ( options[name] === undefined && defaults[name] === undefined ) {

				if ( tests[name].r ) {
					throw new Error("noUiSlider: '" + name + "' is required.");
				}

				return true;
			}

			tests[name].t( parsed, options[name] === undefined ? defaults[name] : options[name] );
		});

		// Forward pips options
		parsed.pips = options.pips;

		// Pre-define the styles.
		parsed.style = parsed.ort ? 'top' : 'left';

		return parsed;
	}


function closure ( target, options ){

	// All variables local to 'closure' are prefixed with 'scope_'
	var scope_Target = target,
		scope_Locations = [-1, -1],
		scope_Base,
		scope_Handles,
		scope_Spectrum = options.spectrum,
		scope_Values = [],
		scope_Events = {},
		scope_Self;

  var cssClasses = [
    /*  0 */  'target'
    /*  1 */ ,'base'
    /*  2 */ ,'origin'
    /*  3 */ ,'handle'
    /*  4 */ ,'horizontal'
    /*  5 */ ,'vertical'
    /*  6 */ ,'background'
    /*  7 */ ,'connect'
    /*  8 */ ,'ltr'
    /*  9 */ ,'rtl'
    /* 10 */ ,'draggable'
    /* 11 */ ,''
    /* 12 */ ,'state-drag'
    /* 13 */ ,''
    /* 14 */ ,'state-tap'
    /* 15 */ ,'active'
    /* 16 */ ,''
    /* 17 */ ,'stacking'
    /* 18 */ ,'tooltip'
    /* 19 */ ,''
    /* 20 */ ,'pips'
    /* 21 */ ,'marker'
    /* 22 */ ,'value'
  ].map(addCssPrefix(options.cssPrefix || defaultCssPrefix));


	// Delimit proposed values for handle positions.
	function getPositions ( a, b, delimit ) {

		// Add movement to current position.
		var c = a + b[0], d = a + b[1];

		// Only alter the other position on drag,
		// not on standard sliding.
		if ( delimit ) {
			if ( c < 0 ) {
				d += Math.abs(c);
			}
			if ( d > 100 ) {
				c -= ( d - 100 );
			}

			// Limit values to 0 and 100.
			return [limit(c), limit(d)];
		}

		return [c,d];
	}

	// Provide a clean event with standardized offset values.
	function fixEvent ( e, pageOffset ) {

		// Prevent scrolling and panning on touch events, while
		// attempting to slide. The tap event also depends on this.
		e.preventDefault();

		// Filter the event to register the type, which can be
		// touch, mouse or pointer. Offset changes need to be
		// made on an event specific basis.
		var touch = e.type.indexOf('touch') === 0,
			mouse = e.type.indexOf('mouse') === 0,
			pointer = e.type.indexOf('pointer') === 0,
			x,y, event = e;

		// IE10 implemented pointer events with a prefix;
		if ( e.type.indexOf('MSPointer') === 0 ) {
			pointer = true;
		}

		if ( touch ) {
			// noUiSlider supports one movement at a time,
			// so we can select the first 'changedTouch'.
			x = e.changedTouches[0].pageX;
			y = e.changedTouches[0].pageY;
		}

		pageOffset = pageOffset || getPageOffset();

		if ( mouse || pointer ) {
			x = e.clientX + pageOffset.x;
			y = e.clientY + pageOffset.y;
		}

		event.pageOffset = pageOffset;
		event.points = [x, y];
		event.cursor = mouse || pointer; // Fix #435

		return event;
	}

	// Append a handle to the base.
	function addHandle ( direction, index ) {

		var origin = document.createElement('div'),
			handle = document.createElement('div'),
			additions = [ '-lower', '-upper' ];

		if ( direction ) {
			additions.reverse();
		}

		addClass(handle, cssClasses[3]);
		addClass(handle, cssClasses[3] + additions[index]);

		addClass(origin, cssClasses[2]);
		origin.appendChild(handle);

		return origin;
	}

	// Add the proper connection classes.
	function addConnection ( connect, target, handles ) {

		// Apply the required connection classes to the elements
		// that need them. Some classes are made up for several
		// segments listed in the class list, to allow easy
		// renaming and provide a minor compression benefit.
		switch ( connect ) {
			case 1:	addClass(target, cssClasses[7]);
					addClass(handles[0], cssClasses[6]);
					break;
			case 3: addClass(handles[1], cssClasses[6]);
					/* falls through */
			case 2: addClass(handles[0], cssClasses[7]);
					/* falls through */
			case 0: addClass(target, cssClasses[6]);
					break;
		}
	}

	// Add handles to the slider base.
	function addHandles ( nrHandles, direction, base ) {

		var index, handles = [];

		// Append handles.
		for ( index = 0; index < nrHandles; index += 1 ) {

			// Keep a list of all added handles.
			handles.push( base.appendChild(addHandle( direction, index )) );
		}

		return handles;
	}

	// Initialize a single slider.
	function addSlider ( direction, orientation, target ) {

		// Apply classes and data to the target.
		addClass(target, cssClasses[0]);
		addClass(target, cssClasses[8 + direction]);
		addClass(target, cssClasses[4 + orientation]);

		var div = document.createElement('div');
		addClass(div, cssClasses[1]);
		target.appendChild(div);
		return div;
	}


	function addTooltip ( handle, index ) {

		if ( !options.tooltips[index] ) {
			return false;
		}

		var element = document.createElement('div');
		element.className = cssClasses[18];
		return handle.firstChild.appendChild(element);
	}

	// The tooltips option is a shorthand for using the 'update' event.
	function tooltips ( ) {

		if ( options.dir ) {
			options.tooltips.reverse();
		}

		// Tooltips are added with options.tooltips in original order.
		var tips = scope_Handles.map(addTooltip);

		if ( options.dir ) {
			tips.reverse();
			options.tooltips.reverse();
		}

		bindEvent('update', function(f, o, r) {
			if ( tips[o] ) {
				tips[o].innerHTML = options.tooltips[o] === true ? f[o] : options.tooltips[o].to(r[o]);
			}
		});
	}


	function getGroup ( mode, values, stepped ) {

		// Use the range.
		if ( mode === 'range' || mode === 'steps' ) {
			return scope_Spectrum.xVal;
		}

		if ( mode === 'count' ) {

			// Divide 0 - 100 in 'count' parts.
			var spread = ( 100 / (values-1) ), v, i = 0;
			values = [];

			// List these parts and have them handled as 'positions'.
			while ((v=i++*spread) <= 100 ) {
				values.push(v);
			}

			mode = 'positions';
		}

		if ( mode === 'positions' ) {

			// Map all percentages to on-range values.
			return values.map(function( value ){
				return scope_Spectrum.fromStepping( stepped ? scope_Spectrum.getStep( value ) : value );
			});
		}

		if ( mode === 'values' ) {

			// If the value must be stepped, it needs to be converted to a percentage first.
			if ( stepped ) {

				return values.map(function( value ){

					// Convert to percentage, apply step, return to value.
					return scope_Spectrum.fromStepping( scope_Spectrum.getStep( scope_Spectrum.toStepping( value ) ) );
				});

			}

			// Otherwise, we can simply use the values.
			return values;
		}
	}

	function generateSpread ( density, mode, group ) {

		function safeIncrement(value, increment) {
			// Avoid floating point variance by dropping the smallest decimal places.
			return (value + increment).toFixed(7) / 1;
		}

		var originalSpectrumDirection = scope_Spectrum.direction,
			indexes = {},
			firstInRange = scope_Spectrum.xVal[0],
			lastInRange = scope_Spectrum.xVal[scope_Spectrum.xVal.length-1],
			ignoreFirst = false,
			ignoreLast = false,
			prevPct = 0;

		// This function loops the spectrum in an ltr linear fashion,
		// while the toStepping method is direction aware. Trick it into
		// believing it is ltr.
		scope_Spectrum.direction = 0;

		// Create a copy of the group, sort it and filter away all duplicates.
		group = unique(group.slice().sort(function(a, b){ return a - b; }));

		// Make sure the range starts with the first element.
		if ( group[0] !== firstInRange ) {
			group.unshift(firstInRange);
			ignoreFirst = true;
		}

		// Likewise for the last one.
		if ( group[group.length - 1] !== lastInRange ) {
			group.push(lastInRange);
			ignoreLast = true;
		}

		group.forEach(function ( current, index ) {

			// Get the current step and the lower + upper positions.
			var step, i, q,
				low = current,
				high = group[index+1],
				newPct, pctDifference, pctPos, type,
				steps, realSteps, stepsize;

			// When using 'steps' mode, use the provided steps.
			// Otherwise, we'll step on to the next subrange.
			if ( mode === 'steps' ) {
				step = scope_Spectrum.xNumSteps[ index ];
			}

			// Default to a 'full' step.
			if ( !step ) {
				step = high-low;
			}

			// Low can be 0, so test for false. If high is undefined,
			// we are at the last subrange. Index 0 is already handled.
			if ( low === false || high === undefined ) {
				return;
			}

			// Find all steps in the subrange.
			for ( i = low; i <= high; i = safeIncrement(i, step) ) {

				// Get the percentage value for the current step,
				// calculate the size for the subrange.
				newPct = scope_Spectrum.toStepping( i );
				pctDifference = newPct - prevPct;

				steps = pctDifference / density;
				realSteps = Math.round(steps);

				// This ratio represents the ammount of percentage-space a point indicates.
				// For a density 1 the points/percentage = 1. For density 2, that percentage needs to be re-devided.
				// Round the percentage offset to an even number, then divide by two
				// to spread the offset on both sides of the range.
				stepsize = pctDifference/realSteps;

				// Divide all points evenly, adding the correct number to this subrange.
				// Run up to <= so that 100% gets a point, event if ignoreLast is set.
				for ( q = 1; q <= realSteps; q += 1 ) {

					// The ratio between the rounded value and the actual size might be ~1% off.
					// Correct the percentage offset by the number of points
					// per subrange. density = 1 will result in 100 points on the
					// full range, 2 for 50, 4 for 25, etc.
					pctPos = prevPct + ( q * stepsize );
					indexes[pctPos.toFixed(5)] = ['x', 0];
				}

				// Determine the point type.
				type = (group.indexOf(i) > -1) ? 1 : ( mode === 'steps' ? 2 : 0 );

				// Enforce the 'ignoreFirst' option by overwriting the type for 0.
				if ( !index && ignoreFirst ) {
					type = 0;
				}

				if ( !(i === high && ignoreLast)) {
					// Mark the 'type' of this point. 0 = plain, 1 = real value, 2 = step value.
					indexes[newPct.toFixed(5)] = [i, type];
				}

				// Update the percentage count.
				prevPct = newPct;
			}
		});

		// Reset the spectrum.
		scope_Spectrum.direction = originalSpectrumDirection;

		return indexes;
	}

	function addMarking ( spread, filterFunc, formatter ) {

		var style = ['horizontal', 'vertical'][options.ort],
			element = document.createElement('div'),
			out = '';

		addClass(element, cssClasses[20]);
		addClass(element, cssClasses[20] + '-' + style);

		function getSize( type ){
			return [ '-normal', '-large', '-sub' ][type];
		}

		function getTags( offset, source, values ) {
			return 'class="' + source + ' ' +
				source + '-' + style + ' ' +
				source + getSize(values[1]) +
				'" style="' + options.style + ': ' + offset + '%"';
		}

		function addSpread ( offset, values ){

			if ( scope_Spectrum.direction ) {
				offset = 100 - offset;
			}

			// Apply the filter function, if it is set.
			values[1] = (values[1] && filterFunc) ? filterFunc(values[0], values[1]) : values[1];

			// Add a marker for every point
			out += '<div ' + getTags(offset, cssClasses[21], values) + '></div>';

			// Values are only appended for points marked '1' or '2'.
			if ( values[1] ) {
				out += '<div '+getTags(offset, cssClasses[22], values)+'>' + formatter.to(values[0]) + '</div>';
			}
		}

		// Append all points.
		Object.keys(spread).forEach(function(a){
			addSpread(a, spread[a]);
		});
		element.innerHTML = out;

		return element;
	}

	function pips ( grid ) {

	var mode = grid.mode,
		density = grid.density || 1,
		filter = grid.filter || false,
		values = grid.values || false,
		stepped = grid.stepped || false,
		group = getGroup( mode, values, stepped ),
		spread = generateSpread( density, mode, group ),
		format = grid.format || {
			to: Math.round
		};

		return scope_Target.appendChild(addMarking(
			spread,
			filter,
			format
		));
	}


	// Shorthand for base dimensions.
	function baseSize ( ) {
		var rect = scope_Base.getBoundingClientRect(), alt = 'offset' + ['Width', 'Height'][options.ort];
		return options.ort === 0 ? (rect.width||scope_Base[alt]) : (rect.height||scope_Base[alt]);
	}

	// External event handling
	function fireEvent ( event, handleNumber, tap ) {

		if ( handleNumber !== undefined && options.handles !== 1 ) {
			handleNumber = Math.abs(handleNumber - options.dir);
		}

		Object.keys(scope_Events).forEach(function( targetEvent ) {

			var eventType = targetEvent.split('.')[0];

			if ( event === eventType ) {
				scope_Events[targetEvent].forEach(function( callback ) {

					callback.call(
						// Use the slider public API as the scope ('this')
						scope_Self,
						// Return values as array, so arg_1[arg_2] is always valid.
						asArray(valueGet()),
						// Handle index, 0 or 1
						handleNumber,
						// Unformatted slider values
						asArray(inSliderOrder(Array.prototype.slice.call(scope_Values))),
						// Event is fired by tap, true or false
						tap || false,
						// Left offset of the handle, in relation to the slider
						scope_Locations
					);
				});
			}
		});
	}

	// Returns the input array, respecting the slider direction configuration.
	function inSliderOrder ( values ) {

		// If only one handle is used, return a single value.
		if ( values.length === 1 ){
			return values[0];
		}

		if ( options.dir ) {
			return values.reverse();
		}

		return values;
	}


	// Handler for attaching events trough a proxy.
	function attach ( events, element, callback, data ) {

		// This function can be used to 'filter' events to the slider.
		// element is a node, not a nodeList

		var method = function ( e ){

			if ( scope_Target.hasAttribute('disabled') ) {
				return false;
			}

			// Stop if an active 'tap' transition is taking place.
			if ( hasClass(scope_Target, cssClasses[14]) ) {
				return false;
			}

			e = fixEvent(e, data.pageOffset);

			// Ignore right or middle clicks on start #454
			if ( events === actions.start && e.buttons !== undefined && e.buttons > 1 ) {
				return false;
			}

			// Ignore right or middle clicks on start #454
			if ( data.hover && e.buttons ) {
				return false;
			}

			e.calcPoint = e.points[ options.ort ];

			// Call the event handler with the event [ and additional data ].
			callback ( e, data );

		}, methods = [];

		// Bind a closure on the target for every event type.
		events.split(' ').forEach(function( eventName ){
			element.addEventListener(eventName, method, false);
			methods.push([eventName, method]);
		});

		return methods;
	}

	// Handle movement on document for handle and range drag.
	function move ( event, data ) {

		// Fix #498
		// Check value of .buttons in 'start' to work around a bug in IE10 mobile (data.buttonsProperty).
		// https://connect.microsoft.com/IE/feedback/details/927005/mobile-ie10-windows-phone-buttons-property-of-pointermove-event-always-zero
		// IE9 has .buttons and .which zero on mousemove.
		// Firefox breaks the spec MDN defines.
		if ( navigator.appVersion.indexOf("MSIE 9") === -1 && event.buttons === 0 && data.buttonsProperty !== 0 ) {
			return end(event, data);
		}

		var handles = data.handles || scope_Handles, positions, state = false,
			proposal = ((event.calcPoint - data.start) * 100) / data.baseSize,
			handleNumber = handles[0] === scope_Handles[0] ? 0 : 1, i;

		// Calculate relative positions for the handles.
		positions = getPositions( proposal, data.positions, handles.length > 1);

		state = setHandle ( handles[0], positions[handleNumber], handles.length === 1 );

		if ( handles.length > 1 ) {

			state = setHandle ( handles[1], positions[handleNumber?0:1], false ) || state;

			if ( state ) {
				// fire for both handles
				for ( i = 0; i < data.handles.length; i++ ) {
					fireEvent('slide', i);
				}
			}
		} else if ( state ) {
			// Fire for a single handle
			fireEvent('slide', handleNumber);
		}
	}

	// Unbind move events on document, call callbacks.
	function end ( event, data ) {

		// The handle is no longer active, so remove the class.
		var active = scope_Base.querySelector( '.' + cssClasses[15] ),
			handleNumber = data.handles[0] === scope_Handles[0] ? 0 : 1;

		if ( active !== null ) {
			removeClass(active, cssClasses[15]);
		}

		// Remove cursor styles and text-selection events bound to the body.
		if ( event.cursor ) {
			document.body.style.cursor = '';
			document.body.removeEventListener('selectstart', document.body.noUiListener);
		}

		var d = document.documentElement;

		// Unbind the move and end events, which are added on 'start'.
		d.noUiListeners.forEach(function( c ) {
			d.removeEventListener(c[0], c[1]);
		});

		// Remove dragging class.
		removeClass(scope_Target, cssClasses[12]);

		// Fire the change and set events.
		fireEvent('set', handleNumber);
		fireEvent('change', handleNumber);

		// If this is a standard handle movement, fire the end event.
		if ( data.handleNumber !== undefined ) {
			fireEvent('end', data.handleNumber);
		}
	}

	// Fire 'end' when a mouse or pen leaves the document.
	function documentLeave ( event, data ) {
		if ( event.type === "mouseout" && event.target.nodeName === "HTML" && event.relatedTarget === null ){
			end ( event, data );
		}
	}

	// Bind move events on document.
	function start ( event, data ) {

		var d = document.documentElement;

		// Mark the handle as 'active' so it can be styled.
		if ( data.handles.length === 1 ) {
			addClass(data.handles[0].children[0], cssClasses[15]);

			// Support 'disabled' handles
			if ( data.handles[0].hasAttribute('disabled') ) {
				return false;
			}
		}

		// Fix #551, where a handle gets selected instead of dragged.
		event.preventDefault();

		// A drag should never propagate up to the 'tap' event.
		event.stopPropagation();

		// Attach the move and end events.
		var moveEvent = attach(actions.move, d, move, {
			start: event.calcPoint,
			baseSize: baseSize(),
			pageOffset: event.pageOffset,
			handles: data.handles,
			handleNumber: data.handleNumber,
			buttonsProperty: event.buttons,
			positions: [
				scope_Locations[0],
				scope_Locations[scope_Handles.length - 1]
			]
		}), endEvent = attach(actions.end, d, end, {
			handles: data.handles,
			handleNumber: data.handleNumber
		});

		var outEvent = attach("mouseout", d, documentLeave, {
			handles: data.handles,
			handleNumber: data.handleNumber
		});

		d.noUiListeners = moveEvent.concat(endEvent, outEvent);

		// Text selection isn't an issue on touch devices,
		// so adding cursor styles can be skipped.
		if ( event.cursor ) {

			// Prevent the 'I' cursor and extend the range-drag cursor.
			document.body.style.cursor = getComputedStyle(event.target).cursor;

			// Mark the target with a dragging state.
			if ( scope_Handles.length > 1 ) {
				addClass(scope_Target, cssClasses[12]);
			}

			var f = function(){
				return false;
			};

			document.body.noUiListener = f;

			// Prevent text selection when dragging the handles.
			document.body.addEventListener('selectstart', f, false);
		}

		if ( data.handleNumber !== undefined ) {
			fireEvent('start', data.handleNumber);
		}
	}

	// Move closest handle to tapped location.
	function tap ( event ) {

		var location = event.calcPoint, total = 0, handleNumber, to;

		// The tap event shouldn't propagate up and cause 'edge' to run.
		event.stopPropagation();

		// Add up the handle offsets.
		scope_Handles.forEach(function(a){
			total += offset(a)[ options.style ];
		});

		// Find the handle closest to the tapped position.
		handleNumber = ( location < total/2 || scope_Handles.length === 1 ) ? 0 : 1;
		
		// Check if handler is not disablet if yes set number to the next handler
		if (scope_Handles[handleNumber].hasAttribute('disabled')) {
			handleNumber = handleNumber ? 0 : 1;
		}

		location -= offset(scope_Base)[ options.style ];

		// Calculate the new position.
		to = ( location * 100 ) / baseSize();

		if ( !options.events.snap ) {
			// Flag the slider as it is now in a transitional state.
			// Transition takes 300 ms, so re-enable the slider afterwards.
			addClassFor( scope_Target, cssClasses[14], 300 );
		}

		// Support 'disabled' handles
		if ( scope_Handles[handleNumber].hasAttribute('disabled') ) {
			return false;
		}

		// Find the closest handle and calculate the tapped point.
		// The set handle to the new position.
		setHandle( scope_Handles[handleNumber], to );

		fireEvent('slide', handleNumber, true);
		fireEvent('set', handleNumber, true);
		fireEvent('change', handleNumber, true);

		if ( options.events.snap ) {
			start(event, { handles: [scope_Handles[handleNumber]] });
		}
	}

	// Fires a 'hover' event for a hovered mouse/pen position.
	function hover ( event ) {

		var location = event.calcPoint - offset(scope_Base)[ options.style ],
			to = scope_Spectrum.getStep(( location * 100 ) / baseSize()),
			value = scope_Spectrum.fromStepping( to );

		Object.keys(scope_Events).forEach(function( targetEvent ) {
			if ( 'hover' === targetEvent.split('.')[0] ) {
				scope_Events[targetEvent].forEach(function( callback ) {
					callback.call( scope_Self, value );
				});
			}
		});
	}

	// Attach events to several slider parts.
	function events ( behaviour ) {

		var i, drag;

		// Attach the standard drag event to the handles.
		if ( !behaviour.fixed ) {

			for ( i = 0; i < scope_Handles.length; i += 1 ) {

				// These events are only bound to the visual handle
				// element, not the 'real' origin element.
				attach ( actions.start, scope_Handles[i].children[0], start, {
					handles: [ scope_Handles[i] ],
					handleNumber: i
				});
			}
		}

		// Attach the tap event to the slider base.
		if ( behaviour.tap ) {

			attach ( actions.start, scope_Base, tap, {
				handles: scope_Handles
			});
		}

		// Fire hover events
		if ( behaviour.hover ) {
			attach ( actions.move, scope_Base, hover, { hover: true } );
			for ( i = 0; i < scope_Handles.length; i += 1 ) {
				['mousemove MSPointerMove pointermove'].forEach(function( eventName ){
					scope_Handles[i].children[0].addEventListener(eventName, stopPropagation, false);
				});
			}
		}

		// Make the range draggable.
		if ( behaviour.drag ){

			drag = [scope_Base.querySelector( '.' + cssClasses[7] )];
			addClass(drag[0], cssClasses[10]);

			// When the range is fixed, the entire range can
			// be dragged by the handles. The handle in the first
			// origin will propagate the start event upward,
			// but it needs to be bound manually on the other.
			if ( behaviour.fixed ) {
				drag.push(scope_Handles[(drag[0] === scope_Handles[0] ? 1 : 0)].children[0]);
			}

			drag.forEach(function( element ) {
				attach ( actions.start, element, start, {
					handles: scope_Handles
				});
			});
		}
	}


	// Test suggested values and apply margin, step.
	function setHandle ( handle, to, noLimitOption ) {

		var trigger = handle !== scope_Handles[0] ? 1 : 0,
			lowerMargin = scope_Locations[0] + options.margin,
			upperMargin = scope_Locations[1] - options.margin,
			lowerLimit = scope_Locations[0] + options.limit,
			upperLimit = scope_Locations[1] - options.limit;

		// For sliders with multiple handles,
		// limit movement to the other handle.
		// Apply the margin option by adding it to the handle positions.
		if ( scope_Handles.length > 1 ) {
			to = trigger ? Math.max( to, lowerMargin ) : Math.min( to, upperMargin );
		}

		// The limit option has the opposite effect, limiting handles to a
		// maximum distance from another. Limit must be > 0, as otherwise
		// handles would be unmoveable. 'noLimitOption' is set to 'false'
		// for the .val() method, except for pass 4/4.
		if ( noLimitOption !== false && options.limit && scope_Handles.length > 1 ) {
			to = trigger ? Math.min ( to, lowerLimit ) : Math.max( to, upperLimit );
		}

		// Handle the step option.
		to = scope_Spectrum.getStep( to );

		// Limit to 0/100 for .val input, trim anything beyond 7 digits, as
		// JavaScript has some issues in its floating point implementation.
		to = limit(parseFloat(to.toFixed(7)));

		// Return false if handle can't move
		if ( to === scope_Locations[trigger] ) {
			return false;
		}

		// Set the handle to the new position.
		// Use requestAnimationFrame for efficient painting.
		// No significant effect in Chrome, Edge sees dramatic
		// performace improvements.
		if ( window.requestAnimationFrame ) {
			window.requestAnimationFrame(function(){
				handle.style[options.style] = to + '%';
			});
		} else {
			handle.style[options.style] = to + '%';
		}

		// Force proper handle stacking
		if ( !handle.previousSibling ) {
			removeClass(handle, cssClasses[17]);
			if ( to > 50 ) {
				addClass(handle, cssClasses[17]);
			}
		}

		// Update locations.
		scope_Locations[trigger] = to;

		// Convert the value to the slider stepping/range.
		scope_Values[trigger] = scope_Spectrum.fromStepping( to );

		fireEvent('update', trigger);

		return true;
	}

	// Loop values from value method and apply them.
	function setValues ( count, values ) {

		var i, trigger, to;

		// With the limit option, we'll need another limiting pass.
		if ( options.limit ) {
			count += 1;
		}

		// If there are multiple handles to be set run the setting
		// mechanism twice for the first handle, to make sure it
		// can be bounced of the second one properly.
		for ( i = 0; i < count; i += 1 ) {

			trigger = i%2;

			// Get the current argument from the array.
			to = values[trigger];

			// Setting with null indicates an 'ignore'.
			// Inputting 'false' is invalid.
			if ( to !== null && to !== false ) {

				// If a formatted number was passed, attemt to decode it.
				if ( typeof to === 'number' ) {
					to = String(to);
				}

				to = options.format.from( to );

				// Request an update for all links if the value was invalid.
				// Do so too if setting the handle fails.
				if ( to === false || isNaN(to) || setHandle( scope_Handles[trigger], scope_Spectrum.toStepping( to ), i === (3 - options.dir) ) === false ) {
					fireEvent('update', trigger);
				}
			}
		}
	}

	// Set the slider value.
	function valueSet ( input ) {

		var count, values = asArray( input ), i;

		// The RTL settings is implemented by reversing the front-end,
		// internal mechanisms are the same.
		if ( options.dir && options.handles > 1 ) {
			values.reverse();
		}

		// Animation is optional.
		// Make sure the initial values where set before using animated placement.
		if ( options.animate && scope_Locations[0] !== -1 ) {
			addClassFor( scope_Target, cssClasses[14], 300 );
		}

		// Determine how often to set the handles.
		count = scope_Handles.length > 1 ? 3 : 1;

		if ( values.length === 1 ) {
			count = 1;
		}

		setValues ( count, values );

		// Fire the 'set' event for both handles.
		for ( i = 0; i < scope_Handles.length; i++ ) {

			// Fire the event only for handles that received a new value, as per #579
			if ( values[i] !== null ) {
				fireEvent('set', i);
			}
		}
	}

	// Get the slider value.
	function valueGet ( ) {

		var i, retour = [];

		// Get the value from all handles.
		for ( i = 0; i < options.handles; i += 1 ){
			retour[i] = options.format.to( scope_Values[i] );
		}

		return inSliderOrder( retour );
	}

	// Removes classes from the root and empties it.
	function destroy ( ) {

		cssClasses.forEach(function(cls){
			if ( !cls ) { return; } // Ignore empty classes
			removeClass(scope_Target, cls);
		});

		while (scope_Target.firstChild) {
			scope_Target.removeChild(scope_Target.firstChild);
		}

		delete scope_Target.noUiSlider;
	}

	// Get the current step size for the slider.
	function getCurrentStep ( ) {

		// Check all locations, map them to their stepping point.
		// Get the step point, then find it in the input list.
		var retour = scope_Locations.map(function( location, index ){

			var step = scope_Spectrum.getApplicableStep( location ),

				// As per #391, the comparison for the decrement step can have some rounding issues.
				// Round the value to the precision used in the step.
				stepDecimals = countDecimals(String(step[2])),

				// Get the current numeric value
				value = scope_Values[index],

				// To move the slider 'one step up', the current step value needs to be added.
				// Use null if we are at the maximum slider value.
				increment = location === 100 ? null : step[2],

				// Going 'one step down' might put the slider in a different sub-range, so we
				// need to switch between the current or the previous step.
				prev = Number((value - step[2]).toFixed(stepDecimals)),

				// If the value fits the step, return the current step value. Otherwise, use the
				// previous step. Return null if the slider is at its minimum value.
				decrement = location === 0 ? null : (prev >= step[1]) ? step[2] : (step[0] || false);

			return [decrement, increment];
		});

		// Return values in the proper order.
		return inSliderOrder( retour );
	}

	// Attach an event to this slider, possibly including a namespace
	function bindEvent ( namespacedEvent, callback ) {
		scope_Events[namespacedEvent] = scope_Events[namespacedEvent] || [];
		scope_Events[namespacedEvent].push(callback);

		// If the event bound is 'update,' fire it immediately for all handles.
		if ( namespacedEvent.split('.')[0] === 'update' ) {
			scope_Handles.forEach(function(a, index){
				fireEvent('update', index);
			});
		}
	}

	// Undo attachment of event
	function removeEvent ( namespacedEvent ) {

		var event = namespacedEvent.split('.')[0],
			namespace = namespacedEvent.substring(event.length);

		Object.keys(scope_Events).forEach(function( bind ){

			var tEvent = bind.split('.')[0],
				tNamespace = bind.substring(tEvent.length);

			if ( (!event || event === tEvent) && (!namespace || namespace === tNamespace) ) {
				delete scope_Events[bind];
			}
		});
	}

	// Updateable: margin, limit, step, range, animate, snap
	function updateOptions ( optionsToUpdate ) {

		var v = valueGet(), i, newOptions = testOptions({
			start: [0, 0],
			margin: optionsToUpdate.margin,
			limit: optionsToUpdate.limit,
			step: optionsToUpdate.step,
			range: optionsToUpdate.range,
			animate: optionsToUpdate.animate,
			snap: optionsToUpdate.snap === undefined ? options.snap : optionsToUpdate.snap
		});

		['margin', 'limit', 'step', 'range', 'animate'].forEach(function(name){
			if ( optionsToUpdate[name] !== undefined ) {
				options[name] = optionsToUpdate[name];
			}
		});

		// Save current spectrum direction as testOptions in testRange call
		// doesn't rely on current direction
		newOptions.spectrum.direction = scope_Spectrum.direction;
		scope_Spectrum = newOptions.spectrum;

		// Invalidate the current positioning so valueSet forces an update.
		scope_Locations = [-1, -1];
		valueSet(v);

		for ( i = 0; i < scope_Handles.length; i++ ) {
			fireEvent('update', i);
		}
	}


	// Throw an error if the slider was already initialized.
	if ( scope_Target.noUiSlider ) {
		throw new Error('Slider was already initialized.');
	}

	// Create the base element, initialise HTML and set classes.
	// Add handles and links.
	scope_Base = addSlider( options.dir, options.ort, scope_Target );
	scope_Handles = addHandles( options.handles, options.dir, scope_Base );

	// Set the connect classes.
	addConnection ( options.connect, scope_Target, scope_Handles );

	if ( options.pips ) {
		pips(options.pips);
	}

	if ( options.tooltips ) {
		tooltips();
	}

	scope_Self = {
		destroy: destroy,
		steps: getCurrentStep,
		on: bindEvent,
		off: removeEvent,
		get: valueGet,
		set: valueSet,
		updateOptions: updateOptions,
		options: options, // Issue #600
		target: scope_Target, // Issue #597
		pips: pips // Issue #594
	};

	// Attach user events.
	events( options.events );

	return scope_Self;

}


	// Run the standard initializer
	function initialize ( target, originalOptions ) {

		if ( !target.nodeName ) {
			throw new Error('noUiSlider.create requires a single element.');
		}

		// Test the options and create the slider environment;
		var options = testOptions( originalOptions, target ),
			slider = closure( target, options );

		// Use the public value method to set the start values.
		slider.set(options.start);

		target.noUiSlider = slider;
		return slider;
	}

	// Use an object instead of a function for future expansibility;
	return {
		create: initialize
	};

}));

	window.LJ.admin = _.merge( window.LJ.admin || {}, {

		init: function(){
			LJ.log('Initializing admin script');
		}

	});

	window.LJ.analytics = _.merge( window.LJ.analytics || {}, {

		init: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.analytics.initGoogleAnalytics();
				resolve();

			});

		},
		initGoogleAnalytics: function(){

			// Google Analytics Tracking Landing Page
			$('body').on('ga', function( e, data ){
				LJ.fn.log( data );
				ga('send', data.hit_type, data.url );
			});

			var tracked_elements = [];

			// Elements relative to the Landing Page
			tracked_elements.concat([
			
				{ el : '#landingWrap #facebook_connect', url: '/landingpage/connection-top' },
				{ el : '#landingWrap .landing-map-button', url: '/landingpage/connection-bottom' },
				{ el : '#landingWrap .moving-arrow', url: '/landingpage/movingarrow' },
				{ el : '#landingWrap .pick-lang[data-code="fr"]:not(.active)', url: '/landingpage/changelang/fr' },
				{ el : '#landingWrap .pick-lang[data-code="en"]:not(.active)', url: '/landingpage/changelang/en'},
				{ el : '#landingWrap [href="/legals"', url: '/landingpage/legals' },
				{ el : '#landingWrap #contact', url: '/landingpage/contact' },
				{ el : '#landingWrap .icon-facebook', url: '/landingpage/socials/facebook '},
				{ el : '#landingWrap .icon-twitter', url: '/landingpage/socials/twitter '},
				{ el : '#landingWrap .icon-youtube', url: '/landingpage/socials/youtube '},
				{ el : '#landingWrap .icon-instagram', url: '/landingpage/socials/instagram '}
				
			]);

			// Elements relative to the Main Page
			tracked_elements.concat([

				{ el : '#profile', url: '/mainpage/profile' },
				{ el : '#events', url: '/mainpage/events' },
				{ el : '#settings', url: '/mainpage/settings' }

			]);

			tracked_elements.forEach(function( element ){

				var $el = $( element.el );

				if( $el.length == 0 ){
					return LJ.fn.warn('Cant track element ' + element.el + ', doesnt exist');
				}

				// Send to Google Analytics
				$el.on('click', function(){
					LJ.fn.log('Tracked a click');
					ga('send', 'pageview', element.url );
				});
				
			});

		}

	});
	
	
	window.LJ.autologin = _.merge( window.LJ.autologin || {}, {

		init: function(){

			return LJ.promise(function( resolve, reject ){

				if( document.location.hash == "#1" ){
					LJ.log('Logging in with test user Victoriale...');
					var tk = "EAAXR2Qo4lc4BAChEDRcMA17PowABdrp711d8Fl03VzjB1ptsqMFaKn2jhB4xOF70HpTfELjUVTtcSkJN1Ju9s0WZA5o1Rrez9uW0mgXsbJsxCMe650gLb3o92MLugROZAuQTKsAC2ZAMNwCSJwxIk1sLTEpv5kZD";
					return resolve( tk );
				}

				if( document.location.hash == "#2" ){
					LJ.log('Logging in with test user Angelah...');
					var tk = "EAAXR2Qo4lc4BAMUbS4HfY6Uvk5sM1HkOpan12pCAd3tCZAZCGrXGPJXJBj8dazV5OMDqx6aCuX09VfZAb8CVqeEOfmGyCUUoSUzSHmng6GX9FWtpuzCdAPpVzWFxHXWE2VPjb4ybUCQ6ZClAggtLlNn232EZASEIZD";
					return resolve( tk );
				}

				if( document.location.hash == "#3" ){
					LJ.log('Logging in with test user Davida...');
					var tk = "EAAXR2Qo4lc4BAOEKyewke6ibcU0zB0BvxJSyKdNsOdJFzTGD52MB1QFA1Ay3HHG1XD9WF747zF88rrBmZCODWXHx46Jp8hEWxi5PTZC3G9zjH4pyaZCcj586ZAZAvBExU0Jt8aKfVC9LR2XAzvjGBq8chED7EGlUZD";
					return resolve( tk );
				}

				// Quick reference to the local store
				var s = LJ.store;

				if( !s.get('facebook_access_token') ){
					return reject('No local data available, initializing lp...');
				}

				var facebook_access_token = s.get('facebook_access_token');

				var token      = facebook_access_token.token;
				var expires_at = facebook_access_token.expires_at;

				if( !token || !expires_at ){
					return reject('Missing init preference param, initializing lp...');
				}

				if( moment( expires_at ) < moment() ){
					return reject('Facebook token found but has expired, initializing lp...');
				} 

				var remaining_days  = moment( expires_at ).diff( moment(), 'd' );
				if( remaining_days < 30 ) {
					return reject('Facebook token found but will expire soon, refresh is needed.');
				}

				// Unexpected error
				if( s.get('reconnecting') && !token ){
					return reject('User trying to reconnect but missing token from local store (unexpected)');
				}

				// Check if the app is trying to reconnect him 
				if( s.get('reconnecting') && token ){
					LJ.log('Reconnecting user from previous loss of connexion...');
					s.remove('reconnecting');
					return resolve( token );
				}

				if( s.get("autologin") == false ){
					return reject("Autologin isnt activated, initializing lp...");
				}

				LJ.log('Init data ok, auto logging in...');
				resolve( token );
							
			});
		},
		startLogin: function( facebook_token ){
			return LJ.promise(function( resolve, reject ){
				LJ.log('Starting login...');
				LJ.start( facebook_token );
			});

		},
		startLanding: function( message ){
			return LJ.promise(function( resolve, reject ){
				LJ.log( message );
				LJ.log('Starting landing... v' + 1 );

				$( LJ.static.renderStaticImage('slide_loader') )
					.hide()
					.appendTo('.curtain')
					.velocity('shradeIn', { duration: 800 });

				$('.curtain').find('.slide__loader').velocity('shradeOut', {
					duration: 600,
					complete: function(){
						LJ.ui.hideCurtain({ duration: 800 });
						LJ.landing.activateLanding( 2 );
						 // Login flow
									
					}
				})
			});
		}

	});




	window.LJ.api = _.merge( window.LJ.api || {}, {

		fetched_users : [],
		fetched_users_full: [],

		app_token_url 			  	 	 	: '/auth/facebook',
		me_url		  			  	 	 	: '/api/v1/users/:user_id/self',
		user_url 							: '/api/v1/users/:user_id',
		me_friends				 	 	 	: '/api/v1/users/:user_id/friends',
		invite_code_url 			 	 	: '/api/v1/users/:user_id/invite-code',
		fetch_shared_url		  	 	 	: '/api/v1/users/:user_id/shared',
		fetch_meepass_url 		  	 	 	: '/api/v1/users/:user_id/meepass',
		fetch_cheers_url 		  	 	 	: '/api/v1/users/:user_id/cheers',
		fetch_user_url 	   	  	  	 	 	: '/api/v1/users/:user_id/core',
		fetch_user_profile_url    	 	 	: '/api/v1/users/:user_id/full',
		fetch_more_channels_url 	 	 	: '/api/v1/users/:user_id/channels',
		update_profile_url  	  	 	 	: '/api/v1/users/:user_id/update-profile',
		upload_picture_dt		  	 	 	: '/api/v1/users/:user_id/update-picture-client',
		upload_picture_fb		  	 	 	: '/api/v1/users/:user_id/update-picture-url',
		update_pictures_url		  	 	 	: '/api/v1/users/:user_id/update-pictures',
		fetch_cloudinary_tags_url 	 	 	: '/api/v1/users/:user_id/cloudinary-tags',
		mailchimp_status_url    	 	 	: '/api/v1/users/:user_id/mailchimp-status',
		delete_my_account_url        	 	: '/api/v1/users/:user_id/delete',
		get_online_users_url 		 	 	: '/api/v1/users/online',
		fetch_more_users_url 		 	 	: '/api/v1/users.more',
		share_url 					 	 	: '/api/v1/share',
		distinct_countries_url 		 	 	: '/api/v1/users.countries',
		create_before_url 			 	 	: '/api/v1/befores',
		fetch_nearest_before_url     	 	: '/api/v1/befores.nearest',
		fetch_before_url 		 	 	 	: '/api/v1/befores/:before_id',
		change_before_status_url 	 	 	: '/api/v1/befores/:before_id/status',
		before_request_url 			 	 	: '/api/v1/befores/:before_id/request',
		send_chat_message_url 	     	 	: '/api/v1/chats/:chat_id',
		fetch_chat_history_url 	 	 	 	: '/api/v1/chats/:chat_id',
		change_group_status_url		 	 	: '/api/v1/befores/:before_id/groups',
		update_chat_seen_by_url 	 	 	: '/api/v1/chats/:chat_id/seen_by',
		update_notifications_seen_at_url 	: '/api/v1/users/:user_id/notifications/seen_at',
		update_notifications_clicked_at_url : '/api/v1/users/:user_id/notifications/clicked_at',

		init: function(){
			return LJ.promise(function( resolve, reject ){

				return resolve();

			});
		},
		ajax: function( url, method, data ){	
			return LJ.promise(function( resolve, reject ){

				// LJ.log('['+method+'] ' + url);
				data = data || {};
				if( LJ.user && LJ.user.facebook_id ){
					data.facebook_id = LJ.user.facebook_id;
				}

				if( LJ.realtime.getSocketId() && data ){
					data.socket_id = LJ.realtime.getSocketId();
				}

				var call_started = new Date();

				$.ajax({

					method: method,
					dataType: 'json',
					data: data,
					url: url,
					beforeSend: function( req ){
                    	req.setRequestHeader('x-access-token', LJ.app_token );

                   

                	},
					success: function( data ){
						setTimeout(function(){
							if( data.user ){
								LJ.cacheUser( data.user );
							}
							return resolve( data );
	                    }, LJ.ui.minimum_api_delay - ( new Date() - call_started ) );
					},
					error: function( err ){

						setTimeout(function( err ){
							var err = err.responseJSON;
							var formatted_err = LJ.api.makeFormattedError( err );
							
							return reject( formatted_err );

	                    }, LJ.ui.minimum_api_delay - ( new Date() - call_started ), err );
					}

				});

			});
		},
		get: function( url, data ){
			return LJ.api.ajax( url, 'get', data );

		},
		post: function( url, data ){
			return LJ.api.ajax( url, 'post', data );
			
		},
		patch: function( url, data ){
			return LJ.api.ajax( url, 'patch', data );

		},
		makeFormattedError: function( err ){

			var formatted_err = {};

			if( err.namespace ){
				formatted_err.namespace = err.namespace;
			}

			if( err.call_id ){
				formatted_err.call_id = err.call_id;
			}

			if( err.error ){
				formatted_err = _.merge( formatted_err, err.error );

			} else {
				err = Array.isArray( err.errors ) ? err.errors[0] : err.errors;
				err = err.data ? err.data : err;
				formatted_err = _.merge( formatted_err, err );

			}

			return formatted_err;

		},
		fetchAppToken: function( access_token ){

			LJ.log('Fetching app token...');

			return LJ.api.post( LJ.api.app_token_url, {
					token: access_token

				}).then(function( data ){
					LJ.facebook_id = data.facebook_id
					LJ.app_token   = data.app_token;

			});

		},
		fetchMe: function(){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.me_url.replace(':user_id', LJ.facebook_id ) )

					  .then(function( exposed ){
							LJ.cacheUser( exposed.me );
							LJ.app_settings = exposed.settings
							LJ.store.set("facebook_access_token", exposed.me.facebook_access_token );
					  		return resolve();

					  }, function( err ){
					  		return reject( err );
					  });
			});
		},
		fetchMeShared: function(){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_shared_url.replace(':user_id', LJ.user.facebook_id ) )
					  .then(function( exposed ){
					  		return resolve( exposed );
					  }, function( err ){
					  		return reject( err );
					  });
			});

		},
		fetchMeMeepass: function(){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_meepass_url.replace(':user_id', LJ.user.facebook_id) )
					  .then(function( exposed ){
					  		return resolve( exposed );
					  }, function( err ){
					  		return reject( err );
					  });
			});
		},
		fetchMeCheers: function(){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_cheers_url.replace(':user_id', LJ.user.facebook_id) )
					  .then(function( exposed ){
					  		return resolve( exposed );
					  }, function( err ){
					  		return reject( err );
					  });
			});
		},
		fetchMeFriends: function(){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.me_friends.replace(':user_id', LJ.user.facebook_id ))
					  .then(function( exposed ){
					  	return resolve( exposed );

					  }, function( err ){
					  	return reject( err );

					  });

			});

		},
		syncMeFriends: function( friend_ids ){

			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.me_friends.replace(':user_id', LJ.user.facebook_id), { friend_ids: friend_ids })
					  .then(function( exposed ){
					  	return resolve( exposed );
					  }, function( err ){
					  	return reject( err );
					  });

			});

		},
		fetchUser: function( facebook_id ){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_user_url.replace(':user_id', facebook_id ) )
					  .then(function( exposed ){
					  	if( exposed.user ){
					  		// Append the Facebook id, cause not present in cache 
					  		// for space (cost!) optimisation
					  		exposed.user.facebook_id = facebook_id;
					  	}
					  	return resolve( exposed );

					  }, function( err ){
					  	return reject( err );
					  });

			});

		},
		fetchUsers: function( facebook_ids ){

			var promises = [];
			facebook_ids = facebook_ids || [];
			facebook_ids.forEach(function( fb_id ){
				promises.push( LJ.api.fetchUser( fb_id ) )
			});

			return LJ.Promise.all( promises );
							 

		},
		// Fetch a random amount of users that is not already fetched (not in facebook_ids array)
		fetchMoreUsers: function( facebook_ids, filters ){
			return  LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.fetch_more_users_url, { facebook_ids: facebook_ids || [], filters: filters })
					.then(function( exposed ){
						if( exposed.users ){
							return resolve({ users_count: exposed.users_count, users: exposed.users, call_id: exposed.call_id }); 
						} else {
							LJ.wlog('The server didnt respond with the expected users object');
						}
					}, function( err ){
						return reject( err );
					});

			});
		},
		fetchUserProfile: function( facebook_id ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_user_profile_url.replace(':user_id', facebook_id ) )
					  .then(function( exposed ){
					  	return resolve( exposed );
					  }, function( err ){
					  	return reject( err );
					  });

			});
		},	
		updateProfile: function( data ){

			// Needed to keep track of parallel api calls and matching loaders
			var loader_id = LJ.generateId();
			LJ.ui.showLoader( loader_id );

			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.update_profile_url.replace(':user_id', LJ.user.facebook_id ), data )
					  .then(function( exposed ){
					  		return resolve( exposed );
					  }, function( err ){
					  		return reject( err );
					  }).then(function(){
					  	LJ.ui.hideLoader( loader_id );
					  });
			});
		},
		fetchCloudinaryTags: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_cloudinary_tags_url.replace(':user_id', LJ.user.facebook_id ) )
					  .then(function( exposed ){
					  	if( exposed.cloudinary_tags ){
							return resolve( exposed.cloudinary_tags );
					  	} else {
					  		LJ.wlog('The server didnt respond with expected cloudinary_tags object' );
					  	}
					  }, function( err ){
					  	return reject( err );
					  });

			});

		},
		uploadNewPicture: function( update ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.upload_picture_dt.replace(':user_id', LJ.user.facebook_id ), update )
					  .then(function( exposed ){
					  	if( exposed.new_picture ){
					  		return resolve( exposed.new_picture )
					  	} else {
					  		LJ.wlog('The server didnt respond with expected new_picture object' );
					  	}
					  }, function( err ){
					  	return reject( err );
					  });

			});
		},
		updatePicture: function( update ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.update_pictures_url.replace(':user_id', LJ.user.facebook_id ), update )
					  .then(function( exposed ){
					  	if( exposed.pictures ){
					  		return resolve({ pictures: exposed.pictures, call_id: exposed.call_id });
					  	} else {
					  		LJ.wlog('The server didnt respond with expected pictures object');
					  	}
					  }, function( err ){
					  	return reject( err );
					  });

			});
		},
		uploadNewPictureUrl: function( update ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.upload_picture_fb.replace(':user_id', LJ.user.facebook_id ), update )
					  .then(function( exposed ){
					  	if( exposed.pictures ){
					  		return resolve({ pictures: exposed.pictures, call_id: exposed.call_id });
					  	} else {
					  		LJ.wlog('The server didnt respond with expected pictures object');
					  	}
					  }, function( err ){
					  	return reject( err );
					  });

			});	
		},
		getMailchimpStatus: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.mailchimp_status_url.replace(':user_id', LJ.user.facebook_id ))
					.then(function( exposed ){
						return resolve( exposed );
					}, function( err ){
						return reject( err );
					})

			});
		},
		updateInviteCode: function( update ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.invite_code_url.replace(':user_id', LJ.user.facebook_id ), update )
					.then(function( exposed ){
						return resolve( exposed );
					}, function( err ){
						return reject( err );
					})

			});
		},
		deleteMyAccount: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.delete_my_account_url.replace(':user_id', LJ.user.facebook_id ) )
					.then(function( exposed ){
						return resolve( exposed );
					}, function( err ){
						return reject( err );
					});

			});
		},
		shareWithFriends: function( opt ){
			return LJ.promise(function( resolve, reject ){

				if( ! (opt.target_type && opt.shared_with && opt.user_id ) ){
					LJ.wlog('Missing parameters, not calling the api');
					return reject();
				}

				LJ.api.post( LJ.api.share_url, opt )

					.then(function( exposed ){
						return resolve( exposed );

					}, function( err ){
						return reject( err );

					});

			});
		},
		fetchBefore: function( before_id ){

			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_before_url.replace(':before_id', before_id ) )
					  .then(function( exposed ){

					  	if( !exposed.before ){
					  		return reject({ err_id: "ghost_before" });
					  	} else {
					  		return resolve( exposed.before );
					  	}

					  }, function( err ){
					  	return reject({ err_id: "ghost_before" });

					  });

			});

		},
		fetchBefores: function( before_ids ){

			var promises = [];
			before_ids.forEach(function( be_id ){
				promises.push( LJ.api.fetchBefore( be_id ) );
			});

			return LJ.Promise.all( promises );
							 

		},
		fetchDistinctCountries: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.distinct_countries_url )
					.then(function( exposed ){

						if( exposed.countries ){
							return resolve( exposed.countries );

						} else {
							LJ.wlog('The server didnt respond with the expected countries object');

						}
					}, function( err ){
						return reject( err );

					});

			});
		},
		createBefore: function( before ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.create_before_url, before )
					.then(function( exposed ){
						
						if( exposed.before && exposed.before_item ){
							return resolve( exposed );

						} else {
							LJ.wlog('The server didnt respond with the expected before object');

						}
					}, function( err ){
						return reject( err );

					});

			});
		},
		fetchNearestBefores: function( latlng, options ){
			return LJ.promise(function( resolve, reject ){

				var request = _.extend({}, { latlng: latlng }, options );

				LJ.api.get( LJ.api.fetch_nearest_before_url, request )
					.then(function( exposed ){

						if( exposed.befores ){
							return resolve( exposed.befores );

						} else {
							LJ.wlog('The server didnt respond with the expected before collection');

						}

					}, function( err ){
						return reject( err );

					});

			});
		},
		changeBeforeStatus: function( before_id, status ){

			if( ['open', 'suspended', 'canceled'].indexOf( status ) == -1 ){
				return LJ.wlog('Unsupported before status type');
			}

			var request = {
				status: status				
			};

			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.change_before_status_url.replace(':before_id', before_id ), request )
					.then(function( exposed ){

						if( exposed.before ){
							return resolve( exposed.before );

						} else {
							LJ.wlog('The server didnt respond with the expected before object');
						}


					}, function( err ){
						return reject( err );
						
					});

			});

		},
		requestParticipation: function( before_id, members ){

			var request = {
				before_id : before_id,
				members   : members
			};

			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.before_request_url.replace(':before_id', before_id), request )
					.then(function( exposed ){

						return resolve( exposed );

					}, function( err ){
						return reject( err );

					}) ;

			});

		},
		sendChatMessage: function( data ){

			if( !( data.message && data.chat_id ) ){
				return LJ.wlog('Cannot request the api without all required parameters');
			}

			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.send_chat_message_url.replace(':chat_id', data.chat_id ), data )
					.then(function( exposed ){
						resolve();

					}, function( err ){
						return reject( err );

					});

			});

		},
		fetchChatHistory: function( chat_id, opts ){

			// opts == sent_at (iso_string) & limit (number);
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.fetch_chat_history_url.replace(':chat_id', chat_id ), opts )
					.then(function( exposed ){

						if( !exposed.messages ){
							return LJ.wlog('The server didnt respond with the expected messages object');

						} else {
							return resolve({
								messages : exposed.messages,
								seen_by  : exposed.seen_by
							});
						}

					}, function( err ){
						return reject( err );

					});

			});

		},
		changeGroupStatus: function( data ){
			return LJ.promise(function( resolve, reject ){
				
				var cheers_id = data.cheers_id;
				var before_id = data.before_id;
				var members   = data.members;
				var status    = data.status;

				if( !( cheers_id && before_id && status && members ) ){
					return LJ.wlog('Cannot call the api without required parameters');
				}

				var url = LJ.api.change_group_status_url.replace(':before_id', before_id );
				LJ.api.post( url, data )
					.then(function( exposed ){
						return resolve( exposed );

					}, function( err ){
						return reject( err );
					});

				});
		},
		fetchMoreChannels: function( fetched_chat_ids ){
			return LJ.promise(function( resolve, reject ){

				var url = LJ.api.fetch_more_channels_url.replace( ':user_id', LJ.user.facebook_id );
				LJ.api.post( url, { fetched_chat_ids: fetched_chat_ids })
					.then(function( exposed ){
						if( !exposed.channels ){
							return LJ.wlog('The server didnt respond with the expected channels parameter');
						} else {
							return resolve( exposed.channels );
						}
					}, function( err ){
						return reject( err );
					});

			});

		},
		fetchOnlineUsers: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.get( LJ.api.get_online_users_url )
					.then(function( exposed ){

						if( !exposed.online_users ){
							return LJ.wlog('The server didnt respond with the expected online_users parameter');
						} else {
							return resolve( exposed.online_users );
						}

					}, function( err ){
						return reject( err );
					});

			});
		},
		updateChatSeenBy: function( chat_id ){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.update_chat_seen_by_url.replace( ':chat_id', chat_id ))
					.then(function( exposed ){
						return resolve( exposed );
						
					}, function( err ){
						return reject( err );
					})
			});


		},
		updateNotificationsSeenAt: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.api.post( LJ.api.update_notifications_seen_at_url.replace( ':user_id', LJ.user.facebook_id ) )
					.then(function( exposed ){
						return resolve( exposed );

					}, function( err ){
						return reject( err );

					});

			});
		},
		updateNotificationClickedAt: function( notification_id ){
			return LJ.promise(function( resolve, reject ){

				var data = { notification_id: notification_id };
				
				LJ.api.post( LJ.api.update_notifications_clicked_at_url.replace( ':user_id', LJ.user.facebook_id ), data )
					.then(function( exposed ){
						return resolve( exposed );

					}, function( err ){
						return reject( err );

					});

			});
		},
		updateUser: function( update ){
			return LJ.promise(function( resolve, reject ){

				var url = LJ.api.user_url.replace(':user_id', LJ.user.facebook_id );
				LJ.api.patch( url, update )
					.then(function( exposed ){

						if( !exposed.user ){
							return LJ.wlog('The server didnt respond with the expected user object');
						} else {
							return resolve( exposed );
						}

					}, function( err ){
						return reject( err );

					});

			});
		}

	});

	window.LJ.before = _.merge( window.LJ.before || {}, {

		fetched_befores: [],


		init: function(){
			
			LJ.before.handleDomEvents();
			LJ.before.initBrowser();

			return LJ.before.fetchNearestBefores__UserLocation()
					.then(function(){
						return LJ.before.initCreateBefore();
					});

		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.map__icon.--create-before', LJ.before.handleShowCreateBefore );
			LJ.ui.$body.on('click', '.be-create__close', LJ.before.handleHideCreateBefore );
			LJ.ui.$body.on('click', '.be-dates__date', LJ.before.activateBrowserDate );
			LJ.ui.$body.on('click', '.be-create.--ready .be-create__button', LJ.before.handleCreateBefore );
			LJ.ui.$body.on('click', '.be-inview .user-row', LJ.before.handleClickOnUserRow );
			// LJ.ui.$body.on('click', '.be-actions__action.--share', LJ.before.handleShareBefore );
			LJ.ui.$body.on('click', '.js-cancel-before', LJ.before.handleCancelBefore );
			LJ.ui.$body.on('click', '.slide.--before .js-show-options', LJ.before.showBeforeOptions );
			LJ.ui.$body.on('click', '.js-request', LJ.before.handleRequest );
			LJ.ui.$body.on('click', '.js-request-pending', LJ.before.handleClickOnRequestPending );
			LJ.ui.$body.on('click', '.js-request-accepted', LJ.before.handleClickOnRequestAccepted );


		},
		initBrowser: function(){

			LJ.before.addBrowser();

		},
		initCreateBefore: function(){

		 	LJ.before.initHostsPicker();
			LJ.before.initDatePicker();
		 	LJ.before.initHourPicker( 17, 2, 30 );

		 	return LJ.seek.activatePlacesInCreateBefore()
		 			.then(function(){
					 	LJ.before.initPlacePicker();
					 	return;
		 			});


		},
		handleShowCreateBefore: function(){

			LJ.before.hideBrowser();
			LJ.before.showCreateBefore();

		},
		handleHideCreateBefore: function(){

			LJ.before.showBrowser();
			LJ.before.hideCreateBefore();

		},
		findById: function( before_id ){

			var bfr = _.find( LJ.before.fetched_befores, function( b ){
				return b._id == before_id;
			});

			return bfr;

		},
		findMyGroup: function( before ){

			var g = _.find( before.groups, function( g ){
				return g.members.indexOf( LJ.user.facebook_id ) != -1;
			});

			return g;

		},
		activateBrowserDate: function(){

			var $s = $( this );

			if( $s.hasClass('--active') ) return;

			var date = $s.attr('data-day');
			var m = moment( date, 'DD/MM' );

			LJ.map.activateDate( m );

		},
		sortIsoDates: function( iso_dates ){

			return iso_dates.sort(function( i1, i2 ){
				return moment( i1 ).dayOfYear() - moment( i2 ).dayOfYear();
			});

		},	
		findDistinctDays: function( iso_dates ){

			var days = [];
			LJ.before.sortIsoDates( iso_dates ).forEach(function( isodate, i ){

				days.push({
					id        : i,
					day_word  : LJ.text('day')[ parseInt(moment( isodate ).format('d')) ],
					day_digit : moment( isodate ).format('DD/MM')
				});

			});

			var distinct_days = [];
			var found = [];

			days.forEach(function( day ){

				if( found.indexOf( day.day_digit ) == -1 ){
					found.push( day.day_digit );
					distinct_days.push( day );
				}

			});

			return distinct_days;

		},
		addBrowser: function(){

			$('.be-browser').remove();
			$('.app-section.--map')
				.append( LJ.before.renderBrowser() );			

		},
		preRefreshBrowserLocation: function(){

			$('.js-current-location')
				.children()
				.velocity({ opacity: [ 0.5, 1 ]}, {
					duration: 100
				});

		},
		refreshBrowserLocation: function(){

			var center_latlng = LJ.meemap.center;
			LJ.map.findAddressWithLatLng( center_latlng )
				.then(function( address ){

					$('.js-current-location')
						.children()
						.velocity({ opacity: [ 0, 0.5 ]}, {
							duration: 200,
							complete: function(){

								$('.js-current-location').find('.js-closeto').html( address );
								$( this ).velocity('fadeIn', {
										duration: 400,
										display: 'flex'
									});

							}
						});
				});

		},
		findActiveDateIndex: function(){

			var i = 0;
			var $bd = $('.be-dates__date.--active');
			if( $bd.length > 0 ){
				$('.be-dates__date').each(function( j, el ){
					if( $(el).hasClass('--active') ){
						i = j;
					}
				});
			}
			return i;

		},
		handleClickOnUserRow: function(){

			var facebook_id = $(this).attr('data-facebook-id');
			LJ.profile_user.showUserProfile( facebook_id );

		},
		refreshBrowserDates: function(){

			var iso_dates  = _.map( LJ.before.fetched_befores, 'begins_at' );
			var dates_html = [];

			if( iso_dates.length == 0 ){

				LJ.wlog('No iso_dates found');
				dates_html.push( LJ.before.renderBrowserDatesEmpty() );

			} else {

				var dates = LJ.before.findDistinctDays( iso_dates );
				dates.forEach(function( date, i ){

					var d = date.day_digit;
					var w = date.day_word.slice( 0, 3 );

					var active = ( i == LJ.before.findActiveDateIndex() ) ? '--active' : '';

					dates_html.push([
						'<div class="be-dates__date '+ active +'" data-day="'+ d +'">',
							w + '.<span>'+ d +'</span>',
							'<div class="be-dates__bar"></div>',
						'</div>'
						].join(''));
				});
				
			}


			$('.js-be-dates').html( dates_html.join('') );
			LJ.ui.turnToJsp( $('.js-be-dates'), {
				jsp_id: 'before_dates'
			});

		},
		renderBrowser: function(){

			return LJ.ui.render([

				'<div class="be-browser">',
					'<div class="be-dates js-be-dates">',
					'</div>',
					'<div class="be-address js-current-location">',
						'<i class="icon icon-location"></i>',
						'<span data-lid="be_close_to"></span>',
						'<span class="js-closeto"></span>',
					'</div>',
				'</div>',

			].join(''));

		},
		renderBrowserDatesEmpty: function(){

			return LJ.ui.render([
				'<div class="be-browser__empty">',
					'<span data-lid="be_browser_empty"></span>',
				'</div>'
			].join(''));

		},
		hideBrowser: function(){

			$('.be-browser').velocity('slideUpOut', {
				duration: 500
			});

		},
		showBrowser: function(){

			$('.be-browser').velocity('slideDownIn', {
				duration: 500,
				display : 'flex'
			});

		},
		showCreateBeforeBtn: function(){

			$('.js-create-before').velocity('bounceInQuick', { duration: 800, display: 'flex' });

		},
		hideCreateBeforeBtn: function(){
			$('.js-create-before').velocity('bounceOut', { duration: 800, display: 'none' });
		},
		fetchBefores: function(){

			LJ.log('Fetching befores...');
			return LJ.api.fetchBefores();

		},
		fetchNearestBefores__UserLocation: function( max_distance ){

			var latlng = LJ.user.location;
			return LJ.before.fetchNearestBefores( latlng, max_distance );


		},
		fetchNearestBefores__MapCenter: function( max_distance ){

			var latlng = {
				lat: LJ.meemap.center.lat(),
				lng: LJ.meemap.center.lng()
			};

			return LJ.before.fetchNearestBefores( latlng, max_distance );


		},
		refreshNearestBefores: function( max_distance ){

			LJ.before.fetchNearestBefores__MapCenter( max_distance )
				.then(function( befores ){
					return LJ.before.displayBeforeMarkers( befores );

				});

		},
		fetchNearestBefores: function( latlng, max_distance ){

			max_distance = max_distance || null;

			return LJ.api.fetchNearestBefores( latlng, max_distance )
					.then(function( befores ){
						LJ.before.fetched_befores = befores;
						return befores;

					});

		},
		displayBeforeMarkers: function( befores ){

			befores.forEach(function( before ){
				LJ.map.addBeforeMarker( before );
			});

			LJ.map.updateMarkers__byDate();


		},
		setPicturesSizes: function( $content ){
			
			var $pictures = $content.find('.be-pictures__pic');
			var n_pics 	  = $pictures.length;

			var left_step = Object.create({
				2: 50, 3: 33.333333, 4: 25 }
			)[ n_pics ];

			var shadolay = Object.create({
				 2: { opacity : 0,   right: 0 },
				 3: { opacity : 0.5, right: 33.33333 },
				 4: { opacity : 1,   right: 50 } 
			})[ n_pics ];

			$pictures.each(function( i, pic ){

				var $p = $( pic );

				$p.css({ 'width'  : '50%' })
				  .css({ 'z-index': i + 1 })
				  .css({ 'left'   : (i * left_step)+'%' })

				$p.find('.be-pictures__shadolay')
				  .css({ 'right'  : shadolay.right+'%' })
				  .css({ 'opacity': shadolay.opacity })

			});


        },
        fetchBeforeAndHosts: function( before_id ){

        	var before_ref;
        	return LJ.api.fetchBefore( before_id )
        			.then(function( before ){
        				before_ref = before;
        				var host_ids = before.hosts;
        				return LJ.api.fetchUsers( host_ids );

        			})
        			.then(function( expose ){
        				expose.before = before_ref;
        				return expose;
        			});

        },
        fetchAndShowBeforeInview: function( before_id ){
			
			var before;

        	LJ.before.hideBrowser();
        	return LJ.ui.showSlideAndFetch({

				"type"			: "before",

				"fetchPromise"	: LJ.before.fetchBeforeAndHosts,
				"promise_arg"   : before_id,

				"complete"      : LJ.before.showBrowser,
				"errHandler"    : LJ.before.handleShowBeforeInviewError

			})
			.then(function( expose ){	
				host_profiles = _.map( expose, 'user' );
				before        = expose.before;
				
				return LJ.before.renderBeforeInview( before, host_profiles );

			})
			.then(function( before_html ){
				$container = $('.slide.--before').find('.slide-body');
				LJ.before.addBefore( before_html, $container );
				$content = $container.children(':not(.slide__loader)');

			})
			.then(function(){
				return LJ.ui.shradeOut( $container.find('.slide__loader'), LJ.ui.slide_hide_duration );

			})
			.then(function(){
				return LJ.before.processBeforePreDisplay( before );

			})
			.then(function(){
				LJ.ui.shradeIn( $content, LJ.profile_user.slide_show_duration );				

			});


        },
        handleShowBeforeInviewError: function( err ){

        	if( err.err_id == "ghost_before" ){
        		LJ.before.ghostifyBeforeInview();
        	}

        },
        ghostifyBeforeInview: function(){

        	var duration      = 400;
        	var $before_ghost = $( LJ.before.renderBeforeGhost() );

        	$('.slide.--before')
        		.find('.slide__loader')
        		.velocity('shradeOut', {
        			duration: duration,
        			complete: function(){
        				$( this ).remove();
        			}
        		});

        	$before_ghost
        		.hide()
        		.appendTo( $('.slide-body') )
        		.velocity('shradeIn', {
        			duration: duration,
        			delay   : duration,
        			display : 'flex'
        		});

        },
        renderBeforeGhost: function(){

        	return LJ.ui.render([

        		'<div class="slide-ghost">',
        			'<div class="slide-ghost__icon --round-icon">',
        				'<i class="icon icon-search-light"></i>',
        			'</div>',
        			'<div class="slide-ghost__title">',
        				'<span data-lid="be_ghost_title"></span>',
        			'</div>',
        			'<div class="slide-ghost__subtitle">',
        				'<span data-lid="be_ghost_subtitle"></span>',
        			'</div>',
        			'<div class="slide-ghost__action">',
        				'<button data-lid="be_ghost_btn" class="slide__close"></button>',
        			'</div>',
        		'</div>'

        	].join(''));

        },
        showBeforeInview: function( before ){

        	LJ.before.hideBrowser();

			var host_ids  = before.hosts;

			var host_profiles;
			var $container;
			var $content;

        	return LJ.ui.showSlideAndFetch({

				"type"			: "before",

				"fetchPromise"	: LJ.api.fetchUsers,
				"promise_arg"   : host_ids,

				"complete"      : LJ.before.showBrowser,
				"errHandler"    : LJ.before.handleShowBeforeInviewError

			})
			.then(function( expose ){	
				host_profiles = _.map( expose, 'user' );
				return LJ.before.renderBeforeInview( before, host_profiles );

			})
			.then(function( before_html ){
				$container = $('.slide.--before').find('.slide-body');
				LJ.before.addBefore( before_html, $container );
				$content = $container.children(':not(.slide__loader)');

			})
			.then(function(){
				return LJ.ui.shradeOut( $container.find('.slide__loader'), LJ.ui.slide_hide_duration );

			})
			.then(function(){
				return LJ.before.processBeforePreDisplay( before );

			})
			.then(function(){
				LJ.ui.shradeIn( $content, LJ.profile_user.slide_show_duration );				

			});

            
        },
        processBeforePreDisplay: function( before ){

			var $w        = $('.be-inview[data-before-id="'+ before._id +'"]');
			var main_host = before.main_host;

        	// Dynamically render the size of the pictures to fit, with a shade
        	LJ.before.setPicturesSizes( $w );

        	// Make sure the host is always on top of the list
        	LJ.mainifyUserRow( $w, main_host );

        	// Set the ux preferences
        	LJ.settings.applyUxPreferences();

        	// Prepend and hide the content, so that jsp compute the right height
			$w.css({ 'opacity': 0 }).show();

			LJ.ui.turnToJsp( $w.find('.be-users'), {
				jsp_id: 'before_inview'
			});

			// Little delay to give Jsp the time to act
			return LJ.delay(100)

        },
        addBefore: function( before_html, $container ){
        	return $container.append( before_html );

        },
        renderCreateBefore: function(){

            return LJ.ui.render([
                '<div class="map__icon --round-icon --create-before js-create-before">',
                    '<i class="icon icon-plus"></i>',
                '</div>'
                ].join(''));

        },
		renderBeforePictures: function( hosts ){

			var be_pictures = [];
			hosts.forEach(function( h ){

				var img_medium = LJ.pictures.makeImgHtml( h.img_id, h.img_vs, "user-before" );
				be_pictures.push([
					'<div class="be-pictures__pic">',
						'<div class="be-pictures__shadolay"></div>',
						img_medium,
					'</div>'
				].join(''));

			});

			return be_pictures.join('');

		},
		renderBeforeDate: function( date ){

			var m = moment( date );
			return LJ.text("before_date", m );

		},
		renderBeforeAddress: function( address ){
			return address.place_name;

		},
		renderBeforeInview: function( before, host_profiles ){

			var html;
			if( before.hosts.indexOf( LJ.user.facebook_id ) != -1 ){
        		html = LJ.before.renderBeforeInview__Host( before, host_profiles );

        	} else {
        		var my_before = _.find( LJ.user.befores, function( bfr ){
        			return bfr.before_id == before._id;
        		});

        		if( !my_before ){
        			html = LJ.before.renderBeforeInview__UserDefault( before, host_profiles );
        			
        		} else {
        			if( my_before.status == "pending" ){
        				html = LJ.before.renderBeforeInview__UserPending( before, host_profiles );

        			} else {
        				html = LJ.before.renderBeforeInview__UserAccepted( before, host_profiles );

        			}
        		}

        	}
        	return html;

		},
		renderBeforeInview__Host: function( before, hosts ){

			return LJ.before.renderBeforeInview__Base( before, hosts, {

				be_action: '<div class="be-actions__action --settings --round-icon js-show-options"><i class="icon icon-cog"></i></div>',
				be_button: LJ.before.renderBeforeInviewBtn__Host()

			});

		},
		renderBeforeInview__UserDefault: function( before, hosts ){

			return LJ.before.renderBeforeInview__Base( before, hosts, {

				// be_action: '<div class="be-actions__action --share --round-icon"><i class="icon icon-forward"></i></div>',
				be_button:  LJ.before.renderBeforeInviewBtn__UserDefault()

			});

		},
		renderBeforeInview__UserPending: function( before, hosts ){

			return LJ.before.renderBeforeInview__Base( before, hosts, {

				// be_action: '<div class="be-actions__action --share --round-icon"><i class="icon icon-forward"></i></div>',
				be_button:  LJ.before.renderBeforeInviewBtn__UserPending()

			});

		},
		renderBeforeInview__UserAccepted: function( before, hosts ){

			return LJ.before.renderBeforeInview__Base( before, hosts, {

				// be_action: '<div class="be-actions__action --share --round-icon"><i class="icon icon-forward"></i></div>',
				be_button:  LJ.before.renderBeforeInviewBtn__UserAccepted()

			});

		},
		renderBeforeInviewBtn__Host: function(){
			return '<div class="be-ended"><span data-lid="be_hosted"></span></div>';
		},
		renderBeforeInviewBtn__UserAccepted: function(){
			return '<button class="--round-icon --accepted js-request-accepted"><i class="icon icon-chat-bubble-duo"></i></button>'

		},
		renderBeforeInviewBtn__UserPending: function(){
			return '<button class="--round-icon --pending js-request-pending"><i class="icon icon-pending"></i></button>'

		},
		renderBeforeInviewBtn__UserDefault: function(){
			return '<button class="--round-icon js-request"><i class="icon icon-drinks"></i></button>'

		},
		renderBeforeInview__Base: function( before, hosts, options ){

			options = options || [];

			if( !before || !hosts ){
				return LJ.wlog('Cannot render before without before object and hosts profiles');
			}

			var be_pictures = LJ.before.renderBeforePictures( hosts );
			var user_rows   = LJ.renderUserRows( hosts );

			var be_action  = options.be_action;
			var be_request = '<div class="be-request">' + options.be_button + '</div>';

			if( moment( before.begins_at ).dayOfYear() < moment().dayOfYear() ){
				be_request = LJ.ui.render('<div class="be-ended"><span data-lid="be_ended"></span></div>');
			}

			var be_date = LJ.before.renderBeforeDate( before.begins_at );
			var be_addr = LJ.before.renderBeforeAddress( before.address );
 
			return LJ.ui.render([

				'<div class="be-inview" data-before-id="'+ before._id +'">',
			      	'<div class="be-pictures">',
			          '<div class="be-actions">',
			          	be_action,
			          '</div>',
			          be_pictures,
			        '</div>',
			        '<div class="be-inview-address">',
			          '<div class="be-inview-address__date">',
			            '<span>'+ be_date +'</span>',
			          '</div>',
			          '<div class="be-inview-address__address">',
			            '<span>'+ be_addr +'</span>',
			          '</div>',
			        '</div>',
			        '<div class="be-users">',
			        	user_rows,
			        '</div>',
			        be_request,
		      	'</div>'

			].join(''));

		},
		handleCancelBefore: function(){

			var $s = $(this);

			var before_id  = $s.closest('.slide').find('[data-before-id]').attr('data-before-id');
			var new_status = "canceled";

			LJ.ui.showLoader("canceling_before");

			LJ.api.changeBeforeStatus( before_id, new_status )
				.then(function( before ){

					LJ.ui.hideLoader("canceling_before");
					LJ.ui.showToast( LJ.text('to_cancel_before_success') );

					LJ.before.removeOneBefore( before_id );
					LJ.before.refreshBrowserDates();
					
					LJ.map.removeBeforeMarker( before_id );
					LJ.ui.hideSlide({ type: 'before' });

				})
				.catch(function( err ){
					LJ.wlog(err);

				});

		},
		removeOneBefore: function( before_id ){

			_.remove( LJ.before.fetched_befores, function( bfr ){
				return bfr._id == before_id;
			});

		},
		renderBeforeOptions: function(){

			return LJ.ui.render([

				'<div class="ioptions__actions">',
					'<div class="ioptions__action-message">',
						'<span data-lid="slide_overlay_before_message"></span>',
					'</div>',
					'<div class="ioptions__action js-cancel-before">',
						'<span data-lid="slide_overlay_before_cancel"></span>',
					'</div>',
					'<div class="ioptions__action --back js-ioptions-close">',
						'<span data-lid="slide_overlay_back"></span>',
					'</div>',
				'</div>'

				].join(''));

		},
		showBeforeOptions: function(){

			var $wrap = $('.slide.--before');

			if( $wrap.length != 1 ){
				return LJ.wlog('Cannot uniquely identify the wrapper');
			}

			LJ.ui.showSlideOverlay( LJ.before.renderBeforeOptions() );

		},
		showChatOptions: function(){

			var duration = LJ.ui.show_slide_duration;

			$('.chat-inview-options').velocity('fadeIn', {
				display : 'flex',
				duration: duration
			});

			$( LJ.chat.renderChatOptions() )
				.hide()
				.appendTo( $('.chat-inview-options') )
				.velocity('shradeIn', {
					duration: duration,
					display: 'flex',
					delay: duration/2,
					complete: function(){
						$(this).find('.js-close-overlay')
							   .on('click', LJ.ui.hideSlideOverlay );
					}
				});

		},
		handleShareBefore: function(){	

			var target_id = $( this ).closest('[data-before-id]').attr('data-before-id');

			LJ.ui.showModal({
				"title"			: LJ.text('modal_share_title_before'),
				"type"      	: "share",
				"search_input"	: true,
				"jsp_body" 	    : true,
				"attributes"	: [{ name: "item-id", val: target_id }],
				"subtitle"		: LJ.text('modal_share_subtitle_before'),
				"body"  		: LJ.friends.renderFriendsInModal(),
				"footer"		: "<button class='--rounded'><i class='icon icon-check'></i></button>"
			})
			.then(function(){
				return LJ.ui.getModalItemIds();

			})
			.then(function( item_ids ){

				var d = LJ.static.renderStaticImage('search_loader');
				$( d ).addClass('modal__search-loader').hide().appendTo('.modal').velocity('fadeIn', {
					duration: 400
				});

				return LJ.api.shareWithFriends({
					target_id   : target_id,
					target_type : 'before',
					shared_with : item_ids
				});

			})
			.then(function( exposed ){
				return LJ.ui.hideModal();

			})
			.then(function(){
				LJ.ui.showToast( LJ.text('to_before_shared_success') );
				
			})
			.catch(function(e){
				LJ.wlog(e);
				LJ.ui.hideModal();

			});

		},
		getBefore: function( before_id ){
			return LJ.promise(function( resolve, reject ){

				var before = _.find( LJ.before.fetched_befores, function( bfr ){
					return bfr._id == before_id;
				});

				if( before ){
					resolve( before );
				} else {
					return LJ.api.fetchBefore( before_id )
						.then(function( before ){
							LJ.before.fetched_befores.push( before );
							resolve( before );
						});
				}

			});
		},
		getBeforeItem: function( before_id ){

			return _.find( LJ.user.befores, function( bfr ){
				return bfr.before_id == before_id;
			});

		},
		updateBeforeItem: function( before_id, opts ){

			var before_item = LJ.before.getBeforeItem( before_id );

			_.keys( before_item ).forEach(function( key ){
				if( opts[ key ] && typeof opts[ key ] == typeof before_item[ key ] ){
					before_item[ key ] = opts[ key ];
				}
			});

		},
		getChannelItem( before_id ){

			return _.find( LJ.user.channels, function( chan ){
				return chan.before_id == before_id;
			});
		},
		cancelifyBeforeInview: function(){

			LJ.ui.cancelify({

				"$wrap"        : $('.slide.--before'),
				"duration"     : 8000,
				"message_html" : "<span>"+ LJ.text("before_just_canceled") +"</span>",
				"callback"     : function(){
					LJ.ui.hideSlide({ type: 'before' });
				}

			});

		}

	});

	window.LJ.before = _.merge( window.LJ.before || {}, {

		initHostsPicker: function(){

			LJ.before.handleDomEvents__HostsPicker();

		},
		initDatePicker: function(){

			LJ.before.date_picker = new Pikaday({ 

                field   : document.getElementsByClassName('be-create-row --date')[0],
                container : document.getElementsByClassName('be-create')[0],
                i18n	: LJ.text_source[ "pikaday" ][ LJ.lang.getAppLang() ],
                format  : 'DD/MM/YY',
                minDate : new Date(),
                bound   : false

            });

            $('.pika-single').insertAfter( $('.be-create') );
            LJ.before.handleDomEvents__DatePicker();

		},
		initHourPicker: function( begin, stop, step ){

			$('.be-create-row.--hour')
				.append( LJ.before.renderHourPicker( begin, stop, step ) );

			LJ.before.hideHourPicker();
			LJ.before.handleDomEvents__HourPicker();

		},
		initPlacePicker: function(){

			LJ.before.handleDomEvents__PlacePicker();

		},
		handleDomEvents__PlacePicker: function(){

			LJ.seek.be_create.addListener('place_changed', function(){

				var place = LJ.seek.be_create.getPlace();

				var place_id    = place.place_id;
				var place_name  = place.formatted_address;
				var lat 		= place.geometry.location.lat();
				var lng 		= place.geometry.location.lng();

				$('.be-create-row.--location')
					.attr('data-place-id', place_id )
					.attr('data-place-name', place_name )
					.attr('data-lat', lat )
					.attr('data-lng', lng );

				$('.be-create-row.--location').removeClass('--unset');
				LJ.before.validateInputs();

			});

		},
		handleDomEvents__HostsPicker: function(){

			LJ.ui.$body.on('click', '.be-create-row.--hosts', function(){

				LJ.ui.showModal({
					"type"      	: "be-create",
					"title"			: LJ.text('modal_be_create_title'),
					"subtitle"		: LJ.text('modal_be_create_subtitle'),
					"body"  		: LJ.friends.renderFriendsInModal(),
					"footer"		: "<button class='--rounded'><i class='icon icon-check'></i></button>",
					"search_input"	: true,
					"max_items"     : (LJ.app_settings.app.max_hosts - 1),
					"jsp_body" 	    : true
				})
				.then(function(){
					return LJ.ui.getModalItemIds()
				})
				.then(function( facebook_ids ){
					$('.be-create-row.--hosts').attr('data-host-ids', facebook_ids.join(',') ).removeClass('--unset');
					LJ.before.validateInputs();
					return LJ.before.addHostsNames( facebook_ids );

				})
				.then(function(){
					return LJ.ui.hideModal();
				})
				.catch(function( e ){
					LJ.wlog(e);
					LJ.wlog('User has stopped selecting people');
				});

			});


		},
		handleDomEvents__HourPicker: function(){

			LJ.ui.$body.on('mousedown', '.be-create .hourpicker__hour', function(){

				var hour = $(this).attr('data-hour');

				$('.be-create-row.--hour input').val( hour );
				$('.be-create-row.--hour')
					.attr('data-hh', hour.split(':')[0])
					.attr('data-mm', hour.split(':')[1]);

				LJ.before.hideHourPicker();
				$('.be-create-row.--hour').removeClass('--unset');
				LJ.before.validateInputs();

			});

			LJ.ui.$body.on('click', '.be-create-row.--hour input', function(){
				LJ.before.showHourPicker();

			});

			LJ.ui.$body.on('mouseleave', '.hourpicker', function(){
				LJ.before.hideHourPicker();              

            });

		},
		handleDomEvents__DatePicker: function(){

			  /* Date picker custom handling for better ux */
            LJ.ui.$body.on('mousedown', '.pika-day:not(.pika-prev,.pika-next)', function(e){

                var $self = $(this);
                var date_str =  moment({ 

                    D: $self.attr('data-pika-day'),
                    M: $self.attr('data-pika-month'),
                    Y: $self.attr('data-pika-year') })

                .format('DD/MM/YY');

            	$('.be-create-row.--date')
               		.attr('data-dd', date_str.split('/')[0] )
               		.attr('data-mm', date_str.split('/')[1] )
               		.attr('data-yy', date_str.split('/')[2] )
               		.find('input')
               		.val( date_str );

            	LJ.before.date_picker.hide();

            	$('.be-create-row.--date').removeClass('--unset');
				LJ.before.validateInputs();

            });

            LJ.ui.$body.on('mousedown', '.pika-next', function(e){             
                LJ.before.date_picker.nextMonth();
            });

            LJ.ui.$body.on('mousedown', '.pika-prev', function(e){             
                LJ.before.date_picker.prevMonth();
            });


            LJ.ui.$body.on('mouseleave', '.pika-single', function(){
                LJ.before.hovering_datepicker_nav = false;
                LJ.before.date_picker.hide();
            });

            LJ.ui.$body.on('focus', '.be-create-row.--date input', function(){
                LJ.before.date_picker.show();
            });


		},
		addHostsNames: function( hosts_facebook_id ){

			var profiles = LJ.friends.getFriendsProfiles( hosts_facebook_id );
			var names    = _.map( profiles, 'name' );
			names = LJ.renderMultipleNames( names );

			$('.be-create-row.--hosts')
				.find('input')
				.val( names );

			return;

		},
		generateHourRange: function( begin, stop, step ){

			if( !begin || !stop || !step ){
				return LJ.wlog('Cannot generate hour range without begin, stop and step params');
			}

			var html = [];
			var start_date = moment({ hour: begin });
			var stop_date  = moment({ hour: stop });

			if( stop_date < start_date ){
				stop_date.add( 1, 'day' );
			}

			while( start_date <= stop_date ){
				var s = start_date.format('HH:mm');
				html.push( s );
				start_date.add( step, 'minute' );
			}

			return html;

		},
		renderHourPicker: function( begin, stop, step ){

			var html_hours = LJ.before.generateHourRange( begin, stop, step );
			var html = [];

			html_hours.forEach(function( hs, i ){
				if( i == 0 ){
					html.push('<div class="hourpicker-col">');
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				} else if ( i%4 == 0 ){
					html.push('</div><div class="hourpicker-col">');
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				} else {
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				}
			});
			html.push('</div>');

			return LJ.ui.render([

				'<div class="hourpicker">',
					html.join(''),
				'</div>'

				].join(''));

		},
		showHourPicker: function(){
			$('.hourpicker').show();

		},
		hideHourPicker: function(){
			$('.hourpicker').hide();

		},
		validateInputs: function(){

			var $unset = $('.be-create-row.--unset');

			if( $unset.length == 0 ){
				return $('.be-create').addClass('--ready');
			}

		},
		showCreateBefore: function(){

			var $i = $('.map__icon.--create-before');
			var $w = $('.be-create');
			var d  = LJ.search.filters_duration || 300;

			LJ.before.clearCreateBefore();
			LJ.ui.adjustWrapperHeight( $('.be-create') );

			$i.velocity('shradeOut', {
				duration : d,
				display  : 'none'
			});

			LJ.delay( d )
				.then(function(){
					return LJ.ui.shradeIn( $w, d );
				});


		},
		hideCreateBefore: function(){

			var $i  = $('.map__icon.--create-before');
			var $w  = $('.be-create');
			var d   = LJ.search.filters_duration;

			$w.velocity('shradeOut', {
				duration : d,
				display  : 'none'
			});

			LJ.delay( d )
				.then(function(){
					return LJ.ui.shradeIn( $i, d );
				});

		},
		clearCreateBefore: function(){

			$('.be-create__loader').remove();
			$('.be-create').removeClass('--pending').removeClass('--ready');
			$('.be-create-row.--hosts').addClass('--unset').find('input').val('');
			$('.be-create-row.--date').addClass('--unset').find('input').val('');
			$('.be-create-row.--hour').addClass('--unset').find('input').val('');
			$('.be-create-row.--location').addClass('--unset').find('input').val('');

		},
		readCreateAttributes: function(){

			var req = {};

			req.hosts_facebook_id = $('.be-create-row.--hosts').attr('data-host-ids').split(',');
			req.hosts_facebook_id.push( LJ.user.facebook_id );

			req.begins_at = moment().set({

				h: $('.be-create-row.--hour').attr('data-hh'),
				m: $('.be-create-row.--hour').attr('data-mm'),
				D: $('.be-create-row.--date').attr('data-dd'),
				M: parseInt( $('.be-create-row.--date').attr('data-mm') ) - 1, // month starts at 0...
				Y: $('.be-create-row.--date').attr('data-yyyy')

			}).toISOString();

			// Important! Timezone is only known by the client and used to uniquely identify his..
			// well, timezone, when updating multiple events every hours on the scheduler
			req.timezone = moment().utcOffset();

			req.address = {

				place_id   : $('.be-create-row.--location').attr('data-place-id'),
				place_name : $('.be-create-row.--location').attr('data-place-name'),
				lat 	   : $('.be-create-row.--location').attr('data-lat'),
				lng 	   : $('.be-create-row.--location').attr('data-lng')

			}

			return req;

		},
		readAndCreateBefore: function(){

			var req = LJ.before.readCreateAttributes();

			if( !(req.hosts_facebook_id && req.begins_at && req.timezone && req.address ) ){
				return LJ.wlog('Missing parameter in the req object : ' + JSON.stringify( req, null, 4 ));
			}

			return LJ.api.createBefore( req );


		},
		showCreateBeforeOverlay: function(){

			$('<div class="loader__overlay"></div>')
				.hide()
				.appendTo( $('.be-create') )
				.velocity('fadeIn', {
					duration: 500
				});

		},
		hideCreateBeforeOverlay: function(){

			$('.be-create')
				.find('.loader__overlay')
				.remove();

		},
		showCreateBeforeLoader: function(){

			$( LJ.static.renderStaticImage('be_create_loader') )
				.hide()
				.appendTo('.be-create')
				.show();

		},
		hideCreateBeforeLoader: function(){

			$('.be-create')
				.find('.be-create__loader')
				.remove();

		},
		pendifyCreateBefore: function(){

			$('.be-create').addClass('--pending');
			LJ.before.showCreateBeforeOverlay();
			LJ.before.showCreateBeforeLoader();
			
			return;

		},
		dependifyCreateBefore: function(){

			$('.be-create').removeClass('--pending');
			LJ.before.hideCreateBeforeLoader();
			LJ.before.hideCreateBeforeOverlay();

			return;

		},
		endCreateBefore: function( expose ){
			
			// Friendly loggin
			var before      = expose.before;
			var before_item = expose.before_item;

			// Ui update
			LJ.before.hideCreateBefore();
			LJ.before.showBrowser();
			LJ.delay( 1000 ).then(function(){

				LJ.before.dependifyCreateBefore();
				LJ.map.activateDate( moment( before.begins_at ) );

			});

		},	
		handleCreateBefore: function(){

			LJ.log('Handling create before...');

			var ux_done    = LJ.before.pendifyCreateBefore();
			var be_created = LJ.before.readAndCreateBefore();

			LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
				var expose = res[0];

				return LJ.before.endCreateBefore( expose );

			})
			.catch(function( e ){
				LJ.before.handleCreateBeforeError(e);

			});

		},
		handleCreateBeforeError: function( err ){
			
			if( !err ){
				return LJ.wlog('Something went wrong, but no err object was provided');
			}

			var err_id = err.err_id;
			var err_msg = '';

			if( err_id == "missing_parameter" ){

				if( err.parameter == "hosts_facebook_id" ){
					err_msg = LJ.text('err_be_create_missing_hosts');

				}
				if( err.parameter == "begins_at" ){
					err_msg = LJ.text('err_be_create_missing_date');

				}
				if( err.parameter == "address" ){
					err_msg = LJ.text('err_be_create_missing_location');

				}
			}

			if( err_id == "already_hosting" ){
				
				var profiles = LJ.friends.getFriendsProfiles( err.host_ids );
				var names    = _.map( profiles, 'name' );
				var formatted_names = LJ.renderMultipleNames( names );

				if( err.host_ids.indexOf( LJ.user.facebook_id ) == -1 ){
					err_msg = LJ.text('err_be_create_already_hosting').replace('%names', formatted_names );

				} else {
					err_msg = LJ.text('err_be_create_already_hosting_me');
				}

			}

			LJ.ui.showToast( err_msg ,'error' );
			LJ.before.dependifyCreateBefore();

		}



	});

	window.LJ.before = _.merge( window.LJ.before || {}, {

		generateHourRange: function( begin, stop, step ){

			if( !begin || !stop || !step ){
				return LJ.wlog('Cannot generate hour range without begin, stop and step params');
			}

			var html = [];
			var start_date = moment({ hour: begin });
			var stop_date  = moment({ hour: stop });

			if( stop_date < start_date ){
				stop_date.add( 1, 'day' );
			}

			while( start_date <= stop_date ){
				var s = start_date.format('HH:mm');
				html.push( s );
				start_date.add( step, 'minute' );
			}

			return html;

		},
		renderHourPicker: function( begin, stop, step ){

			var html_hours = LJ.before.generateHourRange( begin, stop, step );
			var html = [];

			html_hours.forEach(function( hs, i ){
				if( i == 0 ){
					html.push('<div class="hourpicker-col">');
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				} else if ( i%4 == 0 ){
					html.push('</div><div class="hourpicker-col">');
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				} else {
					html.push('<div class="hourpicker__hour" data-hour="'+ hs +'">'+ hs +'</div>');
				}
			});
			html.push('</div>');

			return LJ.ui.render([

				'<div class="hourpicker">',
					html.join(''),
				'</div>'

				].join(''));

		},
		showHourPicker: function(){

			$('.hourpicker').show();

		},
		hideHourPicker: function(){

			$('.hourpicker').hide();

		}

	});

	window.LJ.before = _.merge( window.LJ.before || {}, {

		processRequest: function( before_id ){

			return LJ.ui.getModalItemIds()
				.then(function( item_ids ){

					var d = LJ.static.renderStaticImage('search_loader')
					$( d ).addClass('modal__search-loader').hide().appendTo('.modal').velocity('fadeIn', {
						duration: 400
					});
					
					item_ids.push( LJ.user.facebook_id );
					return LJ.api.requestParticipation( before_id, item_ids );

				})
				.then(function( exposed ){
					return LJ.ui.hideModal();

				})
				.catch(function(e){
					LJ.wlog(e);
					return LJ.before.handleRequestError( e, before_id );

				});

		},
		handleRequest: function(){

        	LJ.log('Handling request, waiting for friend ids...');

        	var before_id = $( this ).closest('[data-before-id]').attr('data-before-id');

			LJ.ui.showModal({
				"title"			: LJ.lang.sayCheers(),
				"type"      	: "request",
				"search_input"	: true,
				"jsp_body" 	    : true,
				"attributes"	: [{ name: "item-id", val: before_id }],
				"subtitle"		: LJ.text('modal_request_subtitle'),
				"body"  		: LJ.friends.renderFriendsInModal(),
				"max_items"     : (LJ.app_settings.app.max_group - 1),
				"footer"		: "<button class='--rounded'><i class='icon icon-check'></i></button>"
			})
			.then(function(){
				return LJ.before.processRequest( before_id );

			});


        },
        handleRequestError: function( err, before_id ){

        	var err_id  = err.err_id;
        	var err_msg = null;

			if( err_id == "missing_parameter" ){
				LJ.wlog('Missing parameter...!');

			}
			if( err_id == "already_there" ){
				//var profiles = LJ.friends.getFriendsProfiles( _.map( err.already_there, 'member_id') );
				//var names    = _.map( profiles, 'name' );
				//var formatted_names = LJ.renderMultipleNames( names );
				_.map( err.already_there, 'member_id').forEach(function( member_id ){
					LJ.ui.noSelectModalRow( member_id, LJ.text('be_request_already_there'));
				});

				$('.modal')
					.removeClass('--pending')
                    .addClass('--disabled')
					.find('.modal__search-loader').hide();
					
				return LJ.before.processRequest( before_id );

			}
			if( err_msg ){
				LJ.ui.showToast( err_msg ,'error' );

			}

			LJ.ui.hideModal();

        },
        handleClickOnRequestPending: function(){

        	LJ.ui.showToast( LJ.text('to_request_pending') );

        },
        handleClickOnRequestAccepted: function(){

        	LJ.log('Redirecting to chat...');
            var $self = $( this );

            var before_id = $self.closest('.be-inview').attr('data-before-id');
            var chat_id   = LJ.before.getChannelItem( before_id ).chat_id;

            if( LJ.chat.getChatState() == "hidden" ){
                LJ.chat.showChatWrap();
            }

            LJ.chat.hideChatInview();
            LJ.chat.activateChat( chat_id );
            LJ.chat.showChatInview( chat_id );

        },
        defaultifyBeforeInview: function( before_id ){

        	var $be = $('.be-inview[data-before-id="'+ before_id +'"]');

        	$be.find('.be-request button')
        		.velocity('shradeOut', {
        			duration: 300,
        			complete: function(){
        				var $new = $( LJ.before.renderBeforeInviewBtn__UserDefault() ).hide();
        				$(this).replaceWith( $new );
        				$new.velocity('shradeIn', { duration: 300, 'display': 'flex' });
        			}
        		});

        },
        pendifyBeforeInview: function( before_id ){

        	var $be = $('.be-inview[data-before-id="'+ before_id +'"]');

        	$be.find('.be-request button')
        		.velocity('shradeOut', {
        			duration: 300,
        			complete: function(){
        				var $new = $( LJ.before.renderBeforeInviewBtn__UserPending() ).hide();
        				$(this).replaceWith( $new );
        				$new.velocity('shradeIn', { duration: 300, 'display': 'flex' });
        			}
        		});

        },
        acceptifyBeforeInview: function( before_id ){

        	var $be = $('.be-inview[data-before-id="'+ before_id +'"]');

        	$be.find('.be-request button')
        		.velocity('shradeOut', {
        			duration: 300,
        			complete: function(){
        				var $new = $( LJ.before.renderBeforeInviewBtn__UserAccepted() ).hide();
        				$(this).replaceWith( $new );
        				$new.velocity('shradeIn', { duration: 300, 'display': 'flex' });
        			}
        		});

        },
        pendifyBeforeMarker: function( before_id ){

        	LJ.map.markers.forEach(function( mrk ){

        		if( mrk.marker_id == before_id ){
        			var icon = LJ.map.makeIcon( LJ.map.getBeforeMarkerUrlByType("pending") );
        			mrk.marker.setIcon( icon );

        		}

        	});

        },
        acceptifyBeforeMarker: function( before_id ){

        	LJ.map.markers.forEach(function( mrk ){

        		if( mrk.marker_id == before._id ){
        			var icon = LJ.map.makeIcon( LJ.map.getBeforeMarkerUrlByType("accepted") );
        			mrk.marker.setIcon( icon );
        			
        		}

        	});

        }

	});
window.LJ.before = _.merge( window.LJ.before || {}, {

		test: {
				iso_dates: [
					"2016-07-22T22:30:48.1234Z",
					"2016-07-22T21:30:22.1234Z",
					"2016-07-23T19:35:43.1234Z",
					"2016-07-25T18:30:45.1234Z",
					"2016-07-24T16:20:25.1234Z",
					"2016-07-27T22:32:45.1234Z",
					"2016-07-27T22:45:15.1234Z",
					"2016-07-27T20:30:42.1234Z",
					"2016-07-28T16:20:25.1234Z",
					"2016-07-29T21:32:41.1234Z",
					"2016-07-30T22:25:11.1234Z",
					"2016-07-30T20:10:12.1234Z",
					"2016-08-22T22:30:48.1234Z",
					"2016-08-22T22:33:55.1234Z",
					"2016-08-23T19:35:43.1234Z",
					"2016-08-25T18:34:45.1234Z",
					"2016-08-24T16:24:24.1234Z",
					"2016-08-27T22:32:45.1234Z",
					"2016-08-27T22:45:45.1234Z",
					"2016-08-27T20:30:44.1234Z",
					"2016-08-28T19:20:25.1234Z",
					"2016-08-29T21:32:41.1234Z",
					"2016-08-30T22:24:11.1234Z",
					"2016-08-30T20:14:12.1234Z",

			],
			before_data: {

				hosts_facebook_id: ["152108635187978","149685995430834"],
				address: {
					lat: "48.8526266",
					lng: "2.332816600000001",
					place_id: "ChIJHcrWXNdx5kcRssJewNDrBRM",
					place_name: "Rue du Four, 75006 Paris, France"
				},
				begins_at: "2016-04-27T09:21:11.519Z",
				timezone: 120

			},
			readAndCreateBefore: function( param ){

				var req = {};

				req.hosts_facebook_id = _.shuffle( LJ.user.friends ).slice(0,1).concat( LJ.user.facebook_id );
				req.address   		  = _.shuffle( LJ.map.test.places )[0];
				req.begins_at		  = '2016-0'+LJ.randomInt(6,9)+'-' + LJ.randomInt(10,30)+'T18:18:18Z'
				req.timezone 		  = 120;

				if( param && req[ param ] ){
					delete req[ param ];
				}

				return LJ.api.createBefore( req );

			},
			handleCreateBefore: function(){

				LJ.log('Handling create before...');

				var ux_done    = LJ.before.pendifyCreateBefore();
				var be_created = LJ.before.test.readAndCreateBefore();

				LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
					return LJ.before.endCreateBefore( res[0] );

				})
				.catch(function( e ){
					LJ.before.handleCreateBeforeError(e);

				});

			},
			handleCreateBeforeWithSpecificFriend: function( facebook_id ){

				LJ.log('Handling create before with friend...');

				var ux_done    = LJ.before.pendifyCreateBefore();
				var be_created = LJ.before.test.readAndCreateBeforeWithFriend( facebook_id );

				LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
					return LJ.before.endCreateBefore( res[0] );

				})
				.catch(function( e ){
					LJ.before.handleCreateBeforeError(e);

				});

			},
			readAndCreateBeforeWithFriend: function( friend_id ){

				var req = {};

				req.hosts_facebook_id = [ LJ.user.facebook_id, friend_id ];
				req.address   		  = _.shuffle( LJ.map.test.places )[0];
				req.begins_at		  = '2016-0'+LJ.randomInt(6,9)+'-' + LJ.randomInt(10,30)+'T18:18:18Z'
				req.timezone 		  = 120;

				return LJ.api.createBefore( req );

			},
			handleCreateBefore__MissingHosts: function(){

				LJ.log('Handling create before...');

				var ux_done    = LJ.before.pendifyCreateBefore();
				var be_created = LJ.before.test.readAndCreateBefore('hosts_facebook_id');

				LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
					return LJ.before.endCreateBefore( res[0] );

				})
				.catch(function( e ){
					LJ.before.handleCreateBeforeError(e);

				});
			},
			handleCreateBefore__MissingLocation: function(){

				LJ.log('Handling create before...');

				var ux_done    = LJ.before.pendifyCreateBefore();
				var be_created = LJ.before.test.readAndCreateBefore('address');

				LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
					return LJ.before.endCreateBefore( res[0] );

				})
				.catch(function( e ){
					LJ.before.handleCreateBeforeError(e);

				});
			},
			handleCreateBefore__MissingDate: function(){

				LJ.log('Handling create before...');

				var ux_done    = LJ.before.pendifyCreateBefore();
				var be_created = LJ.before.test.readAndCreateBefore('begins_at');

				LJ.Promise.all([ be_created, ux_done ]).then(function( res ){
					return LJ.before.endCreateBefore( res[0] );

				})
				.catch(function( e ){
					LJ.before.handleCreateBeforeError(e);

				});
			}
		}

	});

	 window.bc  = LJ.before.test.handleCreateBefore;
	 window.bcf = LJ.before.test.handleCreateBeforeWithSpecificFriend
	 window.fid = function(){ return LJ.user.facebook_id;}


	window.LJ.chat = _.merge( window.LJ.chat || {}, {

		parallel_fetches_count: 30,

		state: 'hidden',
		fetched_profiles: {},
		fetched_chats: {},

		init: function(){
				
			LJ.chat.handleDomEvents();
			LJ.chat.setupChat();
			
			LJ.chat.setupChatRowsJsp()
				.then(function(){
					LJ.chat.emptifyChatRows();
					return LJ.chat.fetchAndAddChats();
				})
				.then(function(){
					LJ.chat.refreshLocalChats();
				})
			// Non blocking promise, return now
			return;

		},
		handleDomEvents: function(){

			$('.app__menu-item.--chats').on('click', LJ.chat.handleToggleChatWrap );
			$('.chat__close').on('click', LJ.chat.hideChatWrap );
			$('.chat').on('click', '.chat-row', LJ.chat.handleChatRowClicked );

			LJ.chat.handleDocumentVisibilityChangeEvents();

			LJ.chat.handleDomEvents__Inview();

		},
		handleDocumentVisibilityChangeEvents: function(){

			var hidden, state, visibilityChange; 
			if (typeof document.hidden !== "undefined") {

				hidden = "hidden";
				visibilityChange = "visibilitychange";
				state = "visibilityState";

			} else if (typeof document.mozHidden !== "undefined") {

				hidden = "mozHidden";
				visibilityChange = "mozvisibilitychange";
				state = "mozVisibilityState";

			} else if (typeof document.msHidden !== "undefined") {

				hidden = "msHidden";
				visibilityChange = "msvisibilitychange";
				state = "msVisibilityState";

			} else if (typeof document.webkitHidden !== "undefined") {

				hidden = "webkitHidden";
				visibilityChange = "webkitvisibilitychange";
				state = "webkitVisibilityState";

			}

			// Add a listener that constantly changes the title
			document.addEventListener( visibilityChange, function() {

				var is_tab_active = !/hidden/i.test( state );
				if( is_tab_active ){

					LJ.store.set("chats_tabbed_at", moment().toISOString() );
					LJ.chat.refreshChatStates();
		        	
				} 

			}, false);

		},
		setupChat: function(){

			// Set chat dimensions for jsp compliance
			LJ.ui.adjustWrapperHeight( $('.chat') );
			var height = $( window ).height() - LJ.ui.slide_top;
			$('.chat-rows').css({
				height : height - ( $('.chat-header').height() + $('.chat-subheader').height() )
			});

		},
		getChatState: function(){

			return LJ.chat.state;

		},
		refreshChatRowsJsp: function(){

			return LJ.delay( 40 ).then(function(){
				LJ.ui.jsp[ "chat_rows" ].reinitialise();
			});

		},
		// Sort all chat messages by descendant order : messages[0] is the oldest
		sortChatMessages: function( chat_id ){

			LJ.chat.getChat( chat_id ).messages.sort(function( ch1, ch2 ){
				return moment( ch2.sent_at ) - moment( ch1.sent_at );
			})

		},
		cacheChatMessage: function( chat_id, message ){

			var chat = LJ.chat.getChat( chat_id );
			var chan = LJ.chat.getChannelItem( chat_id );

			if( !chat ){
				return LJ.wlog('Cannot cache chat message, chat has not been set');
			}

			chan.last_sent_at = message.sent_at;
			chat.messages.push( message );
			LJ.chat.sortChatMessages( chat_id ); 

		},
		cacheChatMessages: function( chat_id, messages, channel_item ){

			if( !Array.isArray( messages ) ){
				return LJ.wlog('Cannot setup cache for chat without a messages array');
			}

			var chat = LJ.chat.getChat( chat_id ) 
					 ? LJ.chat.getChat( chat_id ) 
					 : LJ.chat.setChat( chat_id, channel_item );
			
			messages.forEach(function( message_object ){
				chat.messages.push( message_object );
			});

			LJ.chat.sortChatMessages( chat_id );


		},
		getActiveChatId: function(){

			var active_chat_id = null;
			LJ.chat.getChatIds().forEach(function( chat_id ){
				if( LJ.chat.getChat( chat_id ).ui_status == "active" ){
					active_chat_id = chat_id;
				}
			});
			return active_chat_id;

		},
		seenifyChatInview: function( chat_id, facebook_id ){

			var chat = LJ.chat.getChat( chat_id );

			chat.messages.forEach(function( m ){
					
				m.seen_by.push( facebook_id );
				m.seen_by = _.uniq( m.seen_by );

			});
			

		},
		// Legacy functions, old behavior
		// refreshChatIconBubble_NoNumbers: function(){

		// 	LJ.chat.resetBubbleToChatIcon();
		// 	var display_bubble = false;
			
		// 	LJ.chat.getChatIds().forEach(function( chat_id ){

		// 		if( LJ.chat.getLastMessage( chat_id ) && LJ.chat.getUnseenMessagesCount( chat_id ) > 0 ){
		// 			display_bubble = true;
		// 		} else {
		// 			if( !LJ.chat.getLastMessage( chat_id ) && LJ.chat.wasNeverSeen( chat_id ) ){
		// 				display_bubble = true;
		// 			}
		// 		}

		// 	});

		// 	if( display_bubble ){
		// 		LJ.chat.addBubbleToChatIcon();
		// 	}

		// },
		refreshChatRowBubbles: function( chat_id ){

			var chat = LJ.chat.getChat( chat_id );

			LJ.chat.resetBubbleToChatRow( chat_id );
			
			if( chat.messages.length == 0 ){

				if( LJ.chat.wasNeverSeen( chat_id ) ){
					LJ.chat.addBubbleToChatRow( chat_id );
				} 
				
			} else {

				chat.messages.forEach(function( m ){

					if( m.seen_by.indexOf( LJ.user.facebook_id ) == -1 ){
						LJ.chat.addBubbleToChatRow( chat_id );
					} 

				});

			}

		},
		getRelatedChats: function( team_chat_id ){

			var team_id       = LJ.chat.getChannelItem( team_chat_id ).team_id;
			var related_chats = [];

			LJ.chat.getChatIds().forEach(function( chat_id ){

				var chan = LJ.chat.getChannelItem( chat_id );
				if( chan.type == "chat_all" && chan.team_id == team_chat_id ){
					related_chats.push( chat_id );
				}

			});

			return related_chats;

		},
		// Remove from the cache the out-dated chat_ids that would stay here permanently otherwise
		refreshLocalChats: function(){

			var seen_chats = LJ.store.get('seen_chats');

			_.remove( seen_chats, function( seen_chat_id ){
				return LJ.chat.getChatIds().indexOf( seen_chat_id ) == -1;
			});

			LJ.store.set( "seen_chats", seen_chats );

		},
		refreshChatIconBubble: function(){

			var nu_messages = 0;
			LJ.chat.resetBubbleToChatIcon();	
			LJ.chat.getChatIds().forEach(function( chat_id ){

				if( LJ.chat.getLastMessage( chat_id ) && LJ.chat.getUncheckedMessagesCount( chat_id ) > 0 ){
					nu_messages += LJ.chat.getUncheckedMessagesCount( chat_id );
				} else {
					if( !LJ.chat.getLastMessage( chat_id ) && LJ.chat.wasNeverChecked( chat_id ) ){
						nu_messages += 1;
					}
				}

			});

			LJ.chat.addBubbleToChatIcon( nu_messages );

		},
		getUnseenMessagesCount: function( chat_id ){

			var i    = 0;
			var chat = LJ.chat.getChat( chat_id );

			chat.messages.forEach(function( m ){

				 if( m.seen_by.indexOf( LJ.user.facebook_id ) == -1 ){
					i++;
				} 
			});

			return i;

		},
		wasNeverSeen: function( chat_id ){

			var seen_chats = LJ.store.get('seen_chats') || [];

			return seen_chats.indexOf( chat_id ) == -1 ? true : false;

		},
		// In this version, a message is considered to be "checked" if its sent_at is later
		// than the time the user clicked the chat_icon
		getUncheckedMessagesCount: function( chat_id ){

			var i    = 0;
			var chat = LJ.chat.getChat( chat_id );

			chat.messages.forEach(function( m ){

				var chats_checked_at = moment( LJ.store.get('chats_checked_at') );
				var is_unchecked     = !chats_checked_at || chats_checked_at < moment( m.sent_at );

				if( m.seen_by.indexOf( LJ.user.facebook_id ) == -1 && is_unchecked ){
					i++;
				} 

			});

			return i;

		},
		wasNeverChecked: function( chat_id ){

			var channel 	  = LJ.chat.getChannelItem( chat_id );
			var never_checked = false;

			if( LJ.chat.getChat( chat_id ).messages.length > 0 ){
				LJ.wlog('Warning, calling was never checked on a chat that has messages. Use getUncheckedMessagesCount instead');
			}

			// The last_sent_at param is mostly used for fetching chats. Best use the formed_at or
			// requested_at depending of the type of chat to know the date at which a chat was created at
			var last_activated_at = channel.formed_at ? channel.formed_at : channel.requested_at;
			if( moment( LJ.store.get('chats_checked_at') ) < moment( last_activated_at ) ){
				never_checked = true;
			}

			return never_checked;

		},
		// In this version, a message is considered to be "tabbed" if its sent_at is later
		// than the time the user activatd the tab window
		getUntabbedMessagesCount: function( chat_id ){

			var i    = 0;
			var chat = LJ.chat.getChat( chat_id );

			chat.messages.forEach(function( m ){

				var is_untabbed = moment( LJ.store.get('chats_tabbed_at') ) < moment( m.sent_at );
				if( m.seen_by.indexOf( LJ.user.facebook_id ) == -1 && is_untabbed ){
					i++;
				} 
			});

			return i;

		},
		addBubbleToChatIcon: function( n ){

			LJ.ui.setBubble( $('.app__menu-item.--chats'), n );

		},
		resetBubbleToChatIcon: function(){

			LJ.ui.setBubble( $('.app__menu-item.--chats'), 0 );

		},
		addBubbleToChatRow: function( chat_id ){

			var $chatrowpic = LJ.chat.getChatRow( chat_id ).find('.chat-row-pictures');
			LJ.ui.showBubble( $chatrowpic );

		},
		resetBubbleToChatRow: function( chat_id ){

			var $chatrowpic = LJ.chat.getChatRow( chat_id ).find('.chat-row-pictures');
			LJ.ui.hideBubble( $chatrowpic );

		},
		getChatIds: function(){

			return _.keys( LJ.chat.fetched_chats );

		},
		setChat: function( chat_id, channel_item ){

			LJ.chat.fetched_chats[ chat_id ] = {};
			
			var chat = LJ.chat.fetched_chats[ chat_id ];

			chat.messages = [];
			// Copy extra properties on chat objects that are chat-related and useful. Functions regarding 
			// the ui will base their behavior on the state that is stored here
			if( channel_item ){
				[ 'before_id', 'requested_at', 'last_sent_at' ].forEach(function( prop ){
					if( chat[ prop ] ){
						chat[ prop ] = channel_item[ prop ];
					}
				});
			} else {
				LJ.wlog('Setting chat somewhere without channel_item');
			}

			return chat;

		},
		getChat: function( chat_id ){

			var c = LJ.chat.fetched_chats[ chat_id ];

			if( !c ){
				return null;
			} else {
				return c;
			}

		},
		getChatIdByBeforeId: function( before_id ){

			var channel_item = _.find( LJ.user.channels, function( chan ){

				if( chan.chat_id && chan.before_id && chan.before_id == before_id ){
					return chan.chat_id;
				}

			});

			if( channel_item && channel_item.chat_id ){
				return channel_item.chat_id;
			} else {
				return null;
			}

		},
		fetchAndAddChats: function(){

			// Keep only the channels that are chat-related (= have a team_id parameter)
			var channels = _.filter( LJ.user.channels, 'team_id' );

			var sorted_channels = channels.sort(function( ch1, ch2 ){
				return moment( ch2.last_sent_at ) - moment( ch1.last_sent_at );
			});

			var last_channels    = sorted_channels.slice( 0, LJ.chat.parallel_fetches_count );
			var all_chat_fetched = [];

			last_channels.forEach(function( channel_item ){

				var chat_fetched = LJ.chat.fetchAndAddOneChat( channel_item, {
					row_insert_mode: "top"
				});

				all_chat_fetched.push( chat_fetched );

			});

			return LJ.Promise.all( all_chat_fetched );

		},
		refetchAndAddChats: function(){

			LJ.log('Refetching more group ids');

			return LJ.chat.fetchMoreChannels()
				.then(function( channels ){

					if( channels.length == 0 ){
						return LJ.chat.allChannelsFetched();
					}

					var all_chat_fetched = [];

					channels.forEach(function( channel_item ){
						var chat_fetched = LJ.chat.fetchAndAddOneChat( channel_item, {
							row_insert_mode: "bottom"
						});

						all_chat_fetched.push( chat_fetched );
					});

					return LJ.Promise.all( all_chat_fetched );

				});
			
		},
		allChannelsFetched: function(){

			LJ.wlog('All channels have been fetched');
			LJ.ui.showToast('All channels have been fetched');

		},
		fetchAndAddOneChat: function( channel_item, opts ){

			var type 		 = channel_item.type;
			var chat_id      = channel_item.chat_id;
			var hosts        = channel_item.hosts;
			var members      = channel_item.members;

			if( LJ.chat.getChat( chat_id ) ){
				return LJ.log('Chat already initialized, stop fetching');
			}

			LJ.log('Initializing one chat...');
			LJ.chat.deemptifyChatRows();

			return LJ.Promise.resolve()
					// Render static HTML that will be dynamically filled (sync)
					.then(function(){
						LJ.chat.setupChatRow( channel_item, opts );
						LJ.chat.setupChatInview( channel_item );
						
					})
					// Find the profiles of everyone 
					.then(function(){
						var hosts_profiles   = LJ.api.fetchUsers( hosts );
						var members_profiles = LJ.api.fetchUsers( members );

						return LJ.Promise.all([ hosts_profiles, members_profiles ]);

					})
					// Update the pictures based on users id (async)
					.then(function( res ){

						var hosts_profiles   = _.map( res[0], 'user' );
						var members_profiles = _.map( res[1], 'user' );

						// need to use uniqBy here, to specify the parameter on which to compute the uniqueness
						LJ.chat.fetched_profiles = _.uniqBy( _.concat( LJ.chat.fetched_profiles, hosts_profiles, members_profiles ), 'facebook_id' );
						
					})
					// Fetch the last chat messages (async)
					.then(function(){
						return LJ.api.fetchChatHistory( chat_id );

					})
					// Add them to the DOM (sync)
					.then(function( res ){

						// Add messages to the all chat
						LJ.chat.cacheChatMessages( chat_id,  res.messages, _.cloneDeep( channel_item ) );

						
						// Set all chats internal ui_status to "inactive";
						LJ.chat.deactivateChats();
						
						// Add chat messages to the chat inview
						LJ.chat.addChatMessages({
							channel_item  : channel_item,
							chat_messages : res.messages
						});

						// Turn the chat inview to a jscrollpane element and bind the handle to fetch chat history
						LJ.chat.setupChatInviewJsp( chat_id );

						// Remove loaders
						LJ.chat.deloaderifyChatRow( chat_id );
						LJ.chat.deloaderifyChatInview( chat_id );

						// Update the inview header with dynamic parameters
						// This may be an async operation. If the before isnt part of the user location
						LJ.chat.setChatInviewHeader( channel_item );

						// Set the picture and the default
						LJ.chat.setChatRowPicture( channel_item );
						LJ.chat.setChatRowPreview( channel_item );
						LJ.chat.setChatRowTime( channel_item );
						return;

					})
					.then(function(){
						return LJ.chat.refreshChatState( chat_id );

					})
					.catch(function( e ){
						LJ.wlog(e);

					});


		},
		fetchMoreChannels: function(){

			return LJ.api.fetchMoreChannels( LJ.chat.getChatIds() );

		},
		setupChatRowsJsp: function(){

			var $w = $('.chat-rows');

			// Jspify the chat rows container
			return LJ.ui.turnToJsp('.chat-rows', {
					jsp_id: 'chat_rows',
					handlers: [{
						'event_name' : 'jsp-scroll-y',
						'callback'   : function( e, scroll_pose_y, is_at_top, is_at_bottom ){

							if( is_at_bottom
								&& !$w.hasClass('--fetching-history')
								&& !$w.hasClass('--fetching-done')
								&& !$w.find('.chat-row').length >= LJ.chat.parallel_fetches_count
							){	

								// Find all the group ids that have been fetched so far
								// Server will respond n more ids orderered by most recent activity
								// excluding the ones passed in
								LJ.log('Fetching history... (rows)');
								LJ.chat.refetchAndAddChats();
							}

						}
					}]
				});

		},
		setupChatInviewJsp: function( chat_id ){

			var $w = $('.chat-inview-item[data-chat-id="'+ chat_id +'"]');

			return LJ.ui.turnToJsp('.chat-inview-item[data-chat-id="'+ chat_id +'"] .chat-inview-messages', {
					jsp_id   : chat_id,
					handlers : [{
						'event_name' : 'jsp-scroll-y',
						'callback'   : function( e, scroll_pose_y, is_at_top, is_at_bottom ){

							// To make sure the first time usr loads the chat, no automatic refetch takes place
							if( !$w.hasClass('--fetch-ready') ){
								return //LJ.log('Cant fetch history, the chat is not set as ready');
							}

							// After a fetch history, the 'seen_by' element might be bugged (half hidden)
							// This will that when scroll down, the chat will be like "magneted" down 
							// and properly display the 'seen_by' element
							if( is_at_bottom ){
								return LJ.chat.refreshChatJsp( chat_id );
							}

							if( is_at_top
								&& !$w.hasClass('--fetching-history')
								&& !$w.hasClass('--fetching-done') 
								&& $w.find('.chat-inview-message__bubble:not(.--pending)').length >= LJ.app_settings.app.chat_fetch_count
							){
								LJ.log('Fetching history...(inview)');
								LJ.chat.refetchChatHistory( chat_id );
							} 

						}
					}]
				});

		},
		setupChatRow: function( channel_item , opts ){
			
			var type	= channel_item.type;
			var chat_id = channel_item.chat_id;
			
			var html = LJ.chat.renderChatRow( chat_id );

			// Add chat row in a different location, based on the type
			type == "chat_all" ? 
				LJ.chat.addChatRow( html, _.extend( {}, opts, { $wrap: $('.chat-rows-body.--all') }) ):
				LJ.chat.addChatRow( html, _.extend( {}, opts, { $wrap: $('.chat-rows-body.--team') }) );

			LJ.chat.refreshChatRowsJsp()
			LJ.chat.loaderifyChatRow( chat_id );
			LJ.chat.showChatRow( chat_id );

		},
		setupChatInview: function( channel_item ){

			var chat_id = channel_item.chat_id;

			chat_inview_html = LJ.chat.renderChatInview( channel_item );

			LJ.chat.addChatInview( chat_inview_html );
			LJ.chat.adjustChatInviewDimensions( chat_id );
			LJ.chat.loaderifyChatInview( chat_id );


		},
		adjustChatInviewDimensions: function( chat_id ){

			var $chat               = $('.chat');
			var $chat_inview        = $('.chat-inview[data-chat-id="'+ chat_id +'"]');
			
			var $chat_inview_header = $chat_inview.find('.chat-inview-header');
			var $chat_inview_footer = $chat_inview.find('.chat-inview-footer');

			$chat_inview.find('.chat-inview-messages').css({
				height: $chat.height() - ( $chat_inview_header.height() + $chat_inview_footer.height() )
			});


		},
		loaderifyChatRow: function( chat_id ){

			var $chatrow = LJ.chat.getChatRow( chat_id );
			var $loader  = LJ.static.renderStaticImage("chat_loader");

			$chatrow.children().hide();
			$chatrow.append( $loader );

		},
		deloaderifyChatRow: function( chat_id ){

			var $chatrow = LJ.chat.getChatRow( chat_id );
			var $loader  = $chatrow.find('.chat__loader');

			$chatrow.children().show();
			$loader.remove();

		},
		addChatInview: function( html ){

			$( html )
				.hide()
				.appendTo('.chat-inview-wrap');

		},
		refreshChatRowsOrder: function(){

			var ordered_channel_items = LJ.chat.getOrderedChats();

			ordered_channel_items.forEach(function( channel_item, i ){
				LJ.chat.getChatRow( channel_item.chat_id ).css({ 'order': i });
			});

		},
		getLastMessage: function( chat_id ){

			var last_message  = LJ.chat.getChat( chat_id ).messages[0];

			// If no messages was sent, let's use the fact that each chat has at least a last_sent_at attribute
			// that is equals to requested_at. It is set server-side to help clientside deal with issues when no
			// messages have been sent. 
			if( !last_message ){
				return null;
			} else {
				return last_message;
			}

		},
		getOrderedChats: function(){

			var ordered_channel_items = [];
			var chat_ids = LJ.chat.getChatIds();

			if( chat_ids.length == 0 ){
				return LJ.log('No chat to order (empty array)');
			}

			chat_ids.forEach(function( chat_id ){
				ordered_channel_items.push( LJ.chat.getChannelItem( chat_id ) );				
			});

			// Clear the array
			ordered_channel_items = ordered_channel_items.filter( Boolean );

			// Lowest order are displayed the highest, so sort by desc
			ordered_channel_items.sort(function( m1, m2 ){
 
				var last_m1 = LJ.chat.getLastMessage( m1.chat_id ) && LJ.chat.getLastMessage( m1.chat_id ).sent_at || m1.last_sent_at;
				var last_m2 = LJ.chat.getLastMessage( m2.chat_id ) && LJ.chat.getLastMessage( m2.chat_id ).sent_at || m2.last_sent_at;
				
				return moment( last_m2 ) - moment( last_m1 );
			});

			return ordered_channel_items;

		},
		getLastMessageOfAll: function(){

			var ordered_channel_items = LJ.chat.getOrderedChats();

			if( ordered_channel_items[ 0 ] ){
				return LJ.chat.getLastMessage( ordered_channel_items[ 0 ].chat_id );
			}

		},
		addChatRow: function( html, opts ){
			
			var $html = $( html );
			$html.css({ opacity: 0 }); // jsp compliance

			if( opts.row_insert_mode == "bottom" ){
				$html.css({ 'order': $('.chat-rows').length + 1 }).appendTo( opts.$wrap );

			} else {
				$html.css({ 'order': '-1' }).prependTo( opts.$wrap );

			}

		},
		sortChatRows: function(){

			var L = $('.chat-row').length;
			for( var i = 0; i < L; i++ ){
				for( var j = i; j < L; j++ ){

					var e1 = $('.chat-row').eq(i);
					var e2 = $('.chat-row').eq(j);

					var t1 = e1.attr('data-last-message-at');
					var t2 = e2.attr('data-last-message-at');

					if( t1 < t2 ){
						LJ.swapNodes( t1[0], t2[0] );
					}
				}
			}

		},
		showChatRow: function( chat_id ){

			var $chatrow = LJ.chat.getChatRow( chat_id );
			$chatrow.css({ display: 'flex', opacity: 1 });

		},
		removeChatRow: function( chat_id ){
			LJ.chat.getChatRow( chat_id ).remove();

		},
		removeChatChannelItem: function( chat_id ){

			LJ.chat.getChannelItem( chat_id ) = undefined;

		},
		addChatMessages: function( opts ){

			LJ.log('Adding chat messages...');
			
			var type          = opts.channel_item.type;
			var chat_id 	  = opts.channel_item.chat_id;
			var status        = opts.channel_item.status;
			var role          = opts.channel_item.role;

			var chat_messages = opts.chat_messages;

			var $wrap = $('.chat-inview-item[data-chat-id="'+ chat_id +'"]').find('.chat-inview-messages');
			var html;

			// No chat messages to append, render the proper empty view based on status
			if( chat_messages.length == 0 ){

				LJ.chat.emptifyChatInview( chat_id );

			} else {

				chat_messages.forEach(function( message_object ){
					// Generate a local call_id to allow merge, horodate fn etc to properly work
					// We cant use the messages real _id cause at this stage, it is unknown. So 
					// for consistency, let's always use a client-side generated one everywhere
					message_object.call_id = LJ.generateId();
					LJ.chat.addChatLine( message_object, {
						insert_mode: "prepend"
					});

				});

			}
		},
		handleChatRowClicked: function(){

			var $s        = $( this );
			var chat_id   = $s.attr('data-chat-id');

			LJ.chat.showAndActivateChatInview( chat_id );
			
		},
		showAndActivateChatInview: function( chat_id ){

			if( LJ.chat.getChatIds().indexOf( chat_id ) == -1 ){
				return LJ.wlog('The chat ' + chat_id + ' doesnt exist.');
			}
			// Store in local storage the info to know if user has "seen" a chat. Only used when no messages
			// have been sent. Act like a "seen_by"  property, even if none is available (cause no message)
			LJ.chat.setChatRowSeenLocal( chat_id );

			// Show the chat panel
			LJ.chat.showChatInview( chat_id );

			// Toggle the ui_status property to determine which what is active
			LJ.chat.activateChat( chat_id );

			// Update the fact that user has seen all messages. Needs to be placed before viewify, otherwise
			// the local state will alrady have changed and no api call will happen to prevent api spam
			LJ.chat.sendSeenBy( chat_id ); 

			// Update the local state of the "seen_by" property for all messages of this chat
			LJ.chat.seenifyChatInview( chat_id, LJ.user.facebook_id );

			// Focus on the input for better ease of use
			LJ.chat.focusOnInput( chat_id );

			// Refresh the jsp for the ui and tallify all chatlines (need to happen after the jsp process);
			LJ.chat.refreshChatJsp( chat_id );
			LJ.chat.tallifyAllChatLines( chat_id );

			// Finally, refresh the whole chat state (only bubbles and newified should be affected)
			LJ.chat.refreshChatState( chat_id );


		},
		handleToggleChatWrap: function( e ){

			e.preventDefault();
			var $s = $(this);

			LJ.chat.toggleChatWrap();

		},
		toggleChatWrap: function(){

			LJ.chat.checkAllChats();

			if( LJ.chat.state == 'hidden' ){
				LJ.chat.refreshChatStates();
				LJ.chat.showChatWrap();

			} else {
				LJ.chat.hideChatWrap();

			}

		},
		showChatWrap: function( opts ){
			
			opts = opts || {};

			LJ.chat.state = 'visible';
			$('.app__menu-item.--chats').addClass('--active');

			LJ.ui.adjustWrapperHeight( $('.chat') );

			var duration  = 300;

			LJ.ui.shradeIn( $('.chat'), duration );
			LJ.chat.refreshChatRowsJsp();

			return LJ.delay( duration );

		},
		hideChatWrap: function(){

			if( LJ.cheers.getActiveCheersBack() ){
				LJ.log('Cheers back is active, resolving now');
				return LJ.Promise.resolve();
			}

			LJ.chat.state = 'hidden';
			$('.app__menu-item.--chats').removeClass('--active');

			var duration = 200;
			$('.chat').velocity('shradeOut', {
				duration: duration
			});

			return LJ.delay( duration );

		},
		loaderifyChatWrap: function( duration ){

			duration = duration || 450;
        	return LJ.promise(function( resolve, reject ){	

        		// Hiding logic
        		$('.chat')
        			.children()
        			.velocity('fadeOut', { duration: duration, display: 'none' });

        		// Showing logic
				$( LJ.static.renderStaticImage('slide_loader') )
					  .addClass('js-chat-loader')
					  .hide()
					  .appendTo('.chat')
					  .velocity('fadeIn', { duration: duration, delay: duration } );

				// Promise resolve at the right time
				LJ.delay( 2 * duration ).then( resolve );

        	});
		},
		deloaderifyChatWrap: function( duration ){

			duration = duration || 450;
			return LJ.promise(function( resolve, reject ){	

        		// Hiding logic
				$('.chat .js-chat-loader')
					  .velocity('fadeOut', { duration: duration, complete: function(){
					  	$( this ).remove();
					  }});

        		// Showing logic
        		$('.chat')
        			.children(':not(.js-chat-loader)')
        			.velocity('fadeIn', { duration: duration, delay: duration, display: 'flex' });

        		// Refresh the jsp ui state
        		LJ.chat.refreshChatRowsJsp();

				// Promise resolve at the right time
				LJ.delay( 2 * duration ).then( resolve );

        	});
		},
		emptifyChatRows: function(){

			$('.chat-rows').find('.chat-rows-title').addClass('none');
			$('.chat-rows').append( LJ.chat.renderChatRowEmpty() );

			return LJ.chat.refreshChatRowsJsp();

		},
		deemptifyChatRows: function(){

			$('.chat-rows').find('.chat-rows-title').removeClass('none');
			$('.chat-rows').find('.chat-empty').remove();

			return LJ.chat.refreshChatRowsJsp();

		},	
		renderChatRowEmpty: function(){

			return LJ.chat.renderChatEmpty({
				type 	 : 'row',
				subtitle : '<span data-lid="chat_empty_subtitle_row"></span>'
			});

		},
		renderChatEmpty: function( opts ){

			var subtitle = opts.subtitle;
			var type 	 = opts.type;

			var title    = opts.title || '<span data-lid="chat_empty_title"></span>';
			var icon 	 = opts.icon  || '<i class="icon icon-telescope"></i>';

			return LJ.ui.render([

				'<div class="chat-empty --'+ type + '">',
					'<div class="chat-empty__icon --round-icon">',
						icon,
					'</div>',
					'<div class="chat-empty__title">',
						title,
					'</div>',
					'<div class="chat-empty__subtitle">',
						subtitle,
					'</div>',
				'</div>'

			].join(''));

		},
		setChatRowPicture: function( channel_item ){

			LJ.log('Setting chat row pictures..');

			var chat_id = channel_item.chat_id;
			var type    = channel_item.type;

			if( type == "chat_all" ){

				var users = channel_item.role == "requested" ?
					LJ.chat.getHosts( chat_id ) :
					LJ.chat.getMembers( chat_id );

			} else {

				var users = LJ.chat.getMembers( chat_id );

			}
			
			var pictures = [];

			// Only allow 2-rosaces maximum. More, rosace appearance is confusing...
			users.slice(0,2).forEach(function( user ){
				pictures.push({
					img_id: user.img_id,
					img_vs: user.img_vs
				});
			});

			// Insert rosace into the markup
			var pictures_html = LJ.pictures.makeRosaceHtml( pictures, 'chat-row' );

			LJ.chat.updateChatRowElements( chat_id, {
				picture: pictures_html
			});

			return;

		},
		setChatRowPreview: function( channel_item ){

			LJ.log('Setting chat row preview..');

			var chat_id = channel_item.chat_id;
			var type    = channel_item.type;

			if( type == "chat_all" ){

				var names = channel_item.role == "requested" ?
					_.map( LJ.chat.getHosts( chat_id ), 'name' ) :
					_.map( LJ.chat.getMembers( chat_id ), 'name' );

				names = LJ.renderMultipleNames( names );

				LJ.chat.updateChatRowElements( chat_id, {
					h1: LJ.text("chat_row_request_all_title"),
					h2: LJ.text("chat_row_request_all_subtitle", names )
				});

			} else {

				var names = _.map( LJ.chat.getMembers( chat_id ), 'name' );

				names = LJ.renderMultipleNames( names, { lastify_user: LJ.user.name });

				LJ.chat.updateChatRowElements( chat_id, {
					h1: LJ.text("chat_row_request_team_title"),
					h2: LJ.text("chat_row_request_team_subtitle", names )
				});

			}


		},
		setChatRowTime: function( channel_item ){

			LJ.log('Setting chat row time...');
			
			var chat_id      = channel_item.chat_id;
			var last_sent_at = channel_item.last_sent_at;

			var s_date = LJ.text( "chatrow_date", moment( last_sent_at ) );
			
			LJ.chat.updateChatRowElements( chat_id, {
				date: s_date
			});

		},
		setChatInviewHeader: function( channel_item ){

			var chat_id = channel_item.chat_id;

			if( channel_item.type == "chat_all" ){

				LJ.before.getBefore( channel_item.before_id )
					.then(function( before ){

					if( !before ){
						return LJ.wlog('Unable to find user before details (event after fetch)');
					}

					var m              = moment( before.begins_at );
					var place_name     = before.address.place_name;
					var formatted_date = LJ.text("chatinview_date", m );

					LJ.chat.updateChatInviewElements( chat_id, {

						header_h1  : '<span class="--date">'+ formatted_date +'</span>',
						header_h2  : '<span class="--place-name">'+ place_name +'</span>'

					});
				});	
			    
			} else {

				var names = _.map( LJ.chat.getMembers( chat_id ), 'name' );
				names     = LJ.renderMultipleNames( names, { lastify_user: LJ.user.name });

				LJ.chat.updateChatInviewElements( chat_id, {
					header_h1: '<span data-lid="chat_groupname_team"></span>',
					header_h2: '<span>' + names + '</span>'
				});

			}

		},
		refreshChatStates: function(){

			LJ.chat.getChatIds().forEach(function( chat_id ){
				LJ.chat.refreshChatState( chat_id );
			});
			
		},
		clearChatState: function( chat_id ){

			LJ.chat.unsetChat( chat_id );
			LJ.chat.removeChatRow( chat_id );
			LJ.chat.removeChatInview( chat_id );

		},
		clearChatStates: function(){

			LJ.chat.getChatIds().forEach(function( chat_id ){
				LJ.chat.clearChatState( chat_id );
			});

			LJ.chat.emptifyChatRows();

		},
		unsetChat: function( chat_id ){

			delete LJ.chat.fetched_chats[ chat_id ];

		},
		checkAllChats: function(){

			LJ.log('Checking all chats');
			LJ.store.set("chats_checked_at", moment().toISOString() );

		},
		refreshChatState: function( chat_id ){

			// Refresh the chatrow preview : either with last messages, or with the state. And update the time
			LJ.chat.refreshChatRowPicture( chat_id );
			LJ.chat.refreshChatRowPreview( chat_id );
			LJ.chat.refreshChatRowTime( chat_id );

			// Refresh the bubbles on the row, and inside the chat inview
			// Only refresh the state if the panel is hidden
			if( LJ.chat.getChatState() == "visible" ){
				LJ.chat.checkAllChats();
			}

			LJ.chat.refreshChatRowBubbles( chat_id );
			LJ.chat.refreshChatIconBubble();
			LJ.chat.refreshAppTitle( true );

			// Order rows in the right position before moving the ui, requires access to cached messages to work properly
			LJ.chat.refreshChatRowsOrder();

			// Refresh chat seenby, needs to be first
			LJ.chat.refreshChatSeenBy( chat_id );
			
			// Obsolete (?)
			LJ.chat.newifyChatRows( chat_id );

		},
		refreshChatRowPicture: function( chat_id ){

			var last_message = LJ.chat.getLastMessage( chat_id );

			if( !last_message ){
				return;
			}

			var sender = LJ.chat.getUser( last_message.sender_id );
			var pictures_html = LJ.pictures.makeRosaceHtml([{
				img_id: sender.img_id,
				img_vs: sender.img_vs
			}], 'chat-row' );

			LJ.chat.updateChatRowElements( chat_id, {
				picture: pictures_html
			});

		},
		refreshChatRowPreview: function( chat_id ){

			var last_message = LJ.chat.getLastMessage( chat_id );

			if( !last_message ){
				return;
			}

			var sender = LJ.chat.getUser( last_message.sender_id );

			LJ.chat.updateChatRowElements( chat_id, {
				sender_id: sender.facebook_id,
				h1: sender.name,
				h2: last_message.message
			});

		},
		refreshChatRowTime: function( chat_id ){

			var last_message = LJ.chat.getLastMessage( chat_id );

			if( !last_message ){
				return;
			}

			var s_date = LJ.text("chatrow_date", moment( last_message.sent_at ) );

			LJ.chat.updateChatRowElements( chat_id, {
				date: s_date
			});

		},
		updateChatRowElements: function( chat_id, opts ){

			var $chatrow = LJ.chat.getChatRow( chat_id );

			if( opts.h1 ){
				$chatrow.find('.chat-row-infos__name .--name').text( opts.h1 );
			}

			if( opts.h2 ){
				$chatrow.find('.chat-row-infos__preview').text( opts.h2 );
			}

			if( opts.date ){
				$chatrow.find('.chat-row-time span').text( opts.date );
			}

			if( opts.picture ){
				$chatrow.find('.chat-row-pictures').html( opts.picture );
			}

			if( opts.sender_id ){
				$chatrow.find('.js-user-online').attr('data-facebook-id', opts.sender_id );

				if( LJ.connecter.getUserStatus( opts.sender_id ) == "online" ){
					$chatrow.find('.js-user-online').addClass('--online');
				}
			}

			LJ.lang.translate( $chatrow );

		},
		updateChatInviewElements: function( chat_id, opts ){

			var $chatinview = LJ.chat.getChatInview( chat_id );

			if( opts.header_h1 ){	
				$chatinview.find('.chat-inview-title__h1').html( opts.header_h1 );
			}
			if( opts.header_h2 ){
				$chatinview.find('.chat-inview-title__h2').html( opts.header_h2 );
			}

			LJ.lang.translate( $chatinview );

		},
		newifyChatRows: function(){

			var chat_ids = LJ.chat.getChatIds();

			chat_ids.forEach(function( chat_id ){

				var $chatrow     = LJ.chat.getChatRow( chat_id );
				var last_message = LJ.chat.getLastMessage( chat_id );
				var last_seen_by = last_message && last_message.seen_by;
				
				if( !last_seen_by ){

					// Localstorage strategy to determine if a user has seen or not a "new" chatrow. 
					// This isnt store on the serverside, because it only happens when the chat is 
					// empty of any messages. So no need to track each click on that section.

					if( LJ.chat.wasNeverSeen( chat_id ) ){
						$chatrow.addClass('--new');
					} else {
						$chatrow.removeClass('--new');
					}

				} else {

					if( last_seen_by.indexOf( LJ.user.facebook_id ) == -1 ){
						$chatrow.addClass('--new');
					} else {
						$chatrow.removeClass('--new');
					}

				}
			});			
		},
		renderChatRowPictures__Placeholder: function(){

			return LJ.ui.render([

				'<div class="chat-row-pictures">',
					LJ.pictures.makeImgHtml( LJ.app_settings.placeholder.img_id, LJ.app_settings.placeholder.img_version, 'chat-row' ),
				'</div>'

			].join(''));


		},
		renderChatRowInfos__Placeholder: function(){

			return LJ.ui.render([

				'<div class="chat-row-infos">',
					'<div class="chat-row-infos__name">',
						'<span class="--name"></span>',
						'<span class="js-user-online user-online"></span>',
					'</div>',
					'<div class="chat-row-infos__preview">',
		              '<span></span>',
		            '</div>',
				'</div>'

			].join(''));

		},
		renderChatRowTime__Placeholder: function(){

			return LJ.ui.render([

				'<div class="chat-row-time">',
					'<span>00:00</span>',
				'</div>'

			].join(''));

		},
		renderChatRow: function( chat_id ){

			var infos_html = LJ.chat.renderChatRowInfos__Placeholder();
			var time_html  = LJ.chat.renderChatRowTime__Placeholder();
			var pics_html  = LJ.chat.renderChatRowPictures__Placeholder();

			return LJ.ui.render([

				'<div class="chat-row" data-chat-id="'+ chat_id +'">',
					pics_html,
					infos_html,
					time_html,
				'</div>'

			].join(''));


		},
		setChatRowSeenLocal: function( chat_id ){

			var seen_chats = LJ.store.get('seen_chats') || [];
			seen_chats.push( chat_id );
			LJ.store.set( 'seen_chats', _.uniq(seen_chats) );

		},
		getUser: function( facebook_id ){

			if( !/^\d+$/i.test( facebook_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}
			
			return _.find( LJ.chat.fetched_profiles, function( u ){
				return u.facebook_id == facebook_id;
			});

		},
		getUsers: function( facebook_ids ){

			return _.filter( LJ.chat.fetched_profiles, function( u ){
				return facebook_ids.indexOf( u.facebook_id ) != -1;
			});

		},
		getHosts: function( chat_id ){

			if( !/^\w+$/i.test( chat_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}

			var hosts = LJ.chat.getChannelItem( chat_id ).hosts;

			return LJ.chat.getUsers( hosts );

		},
		getMembers: function( chat_id ){

			if( !/^\w+$/i.test( chat_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}

			var members = LJ.chat.getChannelItem( chat_id ).members;

			return LJ.chat.getUsers( members );

		},
		getMainHost: function( chat_id ){

			if( !/^\w+$/i.test( chat_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}

			// The link between hosts & members and chats are stored in channel object
			var main_host = LJ.chat.getChannelItem( chat_id ).main_host;

			return LJ.chat.getUser( main_host );

		},
		getMainMember: function( chat_id ){

			if( !/^\w+$/i.test( chat_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}

			// The link between hosts & members and chats are stored in channel object
			var main_member = LJ.chat.getChannelItem( chat_id ).main_member;

			return LJ.chat.getUser( main_member );

		},
		getChannelItem: function( chat_id ){

			if( !/^\w+$/i.test( chat_id ) ){
				return LJ.wlog('facebook_id didnt match pattern, facebook_id=' +facebook_id );
			}

			return _.find( LJ.user.channels, function( chan ){
				return chan.chat_id == chat_id;
			});

		},
		getChatRow: function( chat_id ){

			if( !chat_id ){
				return LJ.wlog('Cannot target chat row without chat_id');
			}

			return $('.chat-row[data-chat-id="'+ chat_id +'"]');

		},
		updatePageTitle: function( title ){

			document.title = title;

		},
		refreshAppTitle: function( bubble_page_title ){
	     	
		    var n_untabbed_messages = 0;
		    LJ.chat.getChatIds().forEach(function( chat_id ){
		        n_untabbed_messages += LJ.chat.getUntabbedMessagesCount( chat_id );
		    });
		     
		    if( n_untabbed_messages == 0 ){

		    	clearTimeout( LJ.chat.page_title_timer );
		        LJ.ui.updatePageTitle( LJ.text("page_title") );
		        return LJ.log('No untabbed messages to display');

		    }
		 	
		 	if( bubble_page_title ){

		 		clearTimeout( LJ.chat.page_title_timer );

		        LJ.ui.updatePageTitle("(%n) ".replace('%n',n_untabbed_messages) + (LJ.text("page_title") ));

		        return LJ.chat.page_title_timer = setTimeout(function(){
		              LJ.chat.refreshAppTitle( false );
		        }, 2000 );
		 	}		 	

		 	var last_message_of_all =  LJ.chat.getLastMessageOfAll();

		 	if( last_message_of_all ){
		    	var sender_id   = last_message_of_all.sender_id;
		    	var sender_name = LJ.chat.getUser( sender_id ).name;

			    LJ.ui.updatePageTitle("%name vous a envoy un message".replace('%name', sender_name ));
		 	} else {
		 		LJ.ui.updatePageTitle("Nouveaux messages !");
		 	}

		    LJ.chat.page_title_timer = setTimeout(function(){
		          LJ.chat.refreshAppTitle( true );
		    }, 2000 );
	    			    

		},
		cancelChatWrap: function( chat_id ){

			LJ.chat.removeChatRow( chat_id );
			LJ.chat.refreshChatRowsJsp();
			LJ.chat.hideChatInview();
			LJ.chat.removeChatInview( chat_id );

			if( $('.chat-row').length == 0 ){
				LJ.chat.emptifyChatRows();
			}

		},	
		resyncAllChats: function(){

			var ux_done = LJ.ui.synchronify({
				$wrap        : $('.chat-wrap'),
				message_html : LJ.text("chat_just_canceled")
			});

			ux_done.then(function(){

				var current_active_chat = LJ.chat.getActiveChatId();
				
				LJ.chat.clearChatStates();
				LJ.chat.hideChatInviewWrap();
				
				var refresh_all_chats  = LJ.chat.refetchAndAddChats();

				refresh_all_chats
					.then(function(){

						LJ.chat.showAndActivateChatInview( current_active_chat );
						LJ.ui.desynchronify({ $wrap: $('.chat-wrap') });
						LJ.ui.showToast( LJ.text("chat_sync_done") );

					})
					.catch(function( err ){
						console.log( err );

					});

			});
				
		}


	});

	window.LJ.chat = _.merge( window.LJ.chat || {}, {

		groupname_show_duration: 500,
		groupname_hide_duration: 150,

		handleDomEvents__Inview: function(){

			$('.chat').on('click', '.js-user-profile', LJ.chat.handleShowUserProfile );
			$('.chat').on('click', '.chat-inview__icon.--options', LJ.chat.handleShowOptions );
			$('.chat').on('click', '.js-show-before', LJ.chat.handleShowBefore );
			$('.chat').on('click', '.js-show-users', LJ.chat.handleShowUsers );
			$('.chat').on('click', '.js-chat-back', LJ.chat.handleChatBack );
			$('.chat').on('keydown', '.js-send-message', LJ.chat.handleSendMessage );

		},
		handleChatBack: function(){

			LJ.chat.hideChatInview();

		},
		loaderifyChatInview: function( chat_id ){
			
			var $chatinview = LJ.chat.getChatInview( chat_id );
			var $mwrap      = $chatinview.find('.chat-inview-messages');
			var $messages   = $chatinview.find('.chat-inview-message');
			var $loader     = $( LJ.static.renderStaticImage("chat_loader") );

			$messages.velocity({ opacity: [ 0.3, 1 ]}, {
				duration: 350
			});

			$loader.hide().appendTo( $chatinview ).velocity('fadeIn', {
				duration: 350
			});
				

		},
		deloaderifyChatInview: function( chat_id, callback ){

			var $chatinview = LJ.chat.getChatInview( chat_id );
			var $messages   = $chatinview.find('.chat-inview-message');
			var $loader     = $chatinview.find('.chat__loader');

			$messages.velocity({ opacity: [ 1, 0.3 ]}, {
				duration: 350
			});

			$loader.velocity('fadeOut', {
				duration: 350,
				complete: function(){
					$(this).remove();
					if( typeof callback == "function" ){
						callback();
					}
				}
			});


		},
		activateChat: function( chat_id ){
			
			// Never have more than one chat with the active status
			LJ.chat.deactivateChats(); 
			LJ.chat.getChat( chat_id ).ui_status = "active";
			
		},
		focusOnInput: function( chat_id ){

			LJ.chat.getChatInview( chat_id ).find('chat-inview-input__text').last().focus();

		},
		deactivateChats: function(){

			LJ.chat.getChatIds().forEach(function( chat_id ){
				LJ.chat.getChat( chat_id ).ui_status = "inactive";
			});

		},
		showChatInview: function( chat_id ){

			var $chat_inview  = LJ.chat.getChatInview( chat_id ).closest('.chat-inview');
			var $chat_inviews = LJ.chat.getChatInviews();

			if( $chat_inview.length == 0 ){
				return LJ.wlog('Unable to target chatinview for id : ' + chat_id );
			}

			$chat_inviews.hide();
			$chat_inview.show();
			
			LJ.chat.showChatInviewWrap();

		},
		hideChatInview: function(){
			
			if( !LJ.chat.getActiveChatId() ) return;
			
			var $chat_rows        = $('.chat-row-wrap');
			var $chat_inview_wrap = $('.chat-inview-wrap');
			
			LJ.chat.saveActiveChatInviewScrollPose();
						
			LJ.chat.hideChatInviewWrap();
			LJ.chat.deactivateChats();

		},
		removeChatInview: function( chat_id ){

			if( LJ.chat.getActiveChatId() == chat_id ){
				LJ.chat.deactivateChats();
				LJ.chat.hideChatInviewWrap();
			}

			LJ.chat.getChatInview( chat_id ).remove();

		},
		showChatInviewWrap: function(){

			$('.chat-inview-wrap').show();

		},
		hideChatInviewWrap: function(){

			$('.chat-inview-wrap').hide();

		},
		saveActiveChatInviewScrollPose: function(){
			
			var chat_id = LJ.chat.getActiveChatId();
			LJ.chat.getChat( chat_id ).last_position_y = LJ.ui.jsp[ chat_id ].getContentPositionY();
				
		},
		handleShowUserProfile: function(){

			var facebook_id = $( this ).attr('data-facebook-id');
			LJ.profile_user.showUserProfile( facebook_id );

		},
		renderChatInview__AllEmpty: function( group_name ){

			return LJ.chat.renderChatEmpty({
				type 	 : 'accepted',
				icon 	 : '<i class="icon icon-chat-bubble-duo"></i>',
				title 	 : '<span data-lid="chat_empty_title_inview_accepted"></span>',
				subtitle : '<span data-lid="chat_empty_subtitle_inview_accepted" data-lpm="'+ group_name +'"></span>'
			});

		},
		renderChatInview__TeamEmpty: function( group_name ){

			return LJ.chat.renderChatEmpty({
				type 	 : 'team',
				icon 	 : '<i class="icon icon-chat-bubble-duo"></i>',
				title 	 : '<span data-lid="chat_empty_title_inview_team" data-lpm="'+ group_name +'"></span>',
				subtitle : '<span data-lid="chat_empty_subtitle_inview_team"></span>'
			});

		},
		handleSendMessage: function( e ){

			var $s      = $( this );
			var chat_id = $s.closest('[data-chat-id]').attr('data-chat-id');
			var keyname = LJ.chat.getKeyname( e.keyCode || e.which );
			var $input  = LJ.chat.getChatInview( chat_id ).find('input');
			var message = $input.val();

            if( keyname == "enter" ){

				if( message.length == 0 ) return;

            	$input.val('');

                LJ.chat.sendAndAddMessage({
                	chat_id  : chat_id,
                	message  : message
                });
                return;

            }

            if( keyname == "arrow-left" ){

            }

            if( keyname == "arrow-right" ){

            }

            LJ.chat.updateInputState( chat_id, e );


		},
		getKeyname: function( key_code ){

			if( key_code == 13 ){
				return "enter";
			}

			if( key_code == 37 ){
				return "arrow-left";
			}

			if( key_code == 39 ){
				return "arrow-right";
			}

			if( key_code == 8 ){
				return "return";
			}

		},
		sendAndAddMessage: function( data ){

			LJ.log('Sending and adding message...');

			var chat_id = data.chat_id;

			data.sender_id = LJ.user.facebook_id;
			data.call_id   = LJ.generateId();

			LJ.chat.emptifyChatSeenBy( chat_id );
			LJ.chat.addChatLine( data );
			LJ.chat.pendifyChatLine( data.call_id );

			LJ.api.sendChatMessage( data )
				.then(function( res ){
					LJ.log('Message sent')

				});

		},
		getMessageElById: function( call_id ){

			return $('.chat-inview-message__bubble[data-call-id="'+ call_id +'"]');

		},
		addChatLine: function( data, opts ){

			opts = opts || {};

			var chat_id        = data.chat_id;
			var call_id 	   = data.call_id;
			var chat_line_html = LJ.chat.renderChatLine( data );
			
			var $seen_by = LJ.chat.popSeenBy( chat_id );
			LJ.chat.insertChatLine( chat_id, chat_line_html, opts.insert_mode );
			LJ.chat.tallifyChatLine( call_id );
			LJ.chat.horodateChatLine( call_id );
			LJ.chat.mergeChatLine( call_id ); 
			LJ.chat.refreshChatJsp( chat_id );
			LJ.chat.classifyChatLine( call_id );
			LJ.chat.showChatLine( call_id );
			LJ.chat.pushBackSeenBy( chat_id, $seen_by );
 

		},
		popSeenBy: function( chat_id ){

			var $w = LJ.chat.getChatInview( chat_id );
			var $e = $w.find('.chat-inview-seen-by');
			var $b = _.clone( $e );
			
			$e.remove();
			
			return $b;
				
		},	
		pushBackSeenBy: function( chat_id, $seen_by ){

			var $w = LJ.chat.getChatInview( chat_id );

			$seen_by.insertAfter( $w.find('.chat-inview-message').last() )
			  
		},
		dependifyChatLine: function( call_id ){
			LJ.chat.getMessageElById( call_id ).removeClass('--pending');

		},
		pendifyChatLine: function( call_id ){
			LJ.chat.getMessageElById( call_id ).addClass('--pending');

		},
		classifyChatLine: function( call_id ){

			var $msg = LJ.chat.getMessageElById( call_id ).closest('.chat-inview-message');
			var sender_id = $msg.attr('data-sender-id');

			if( LJ.user.facebook_id == sender_id ){
				return $msg.addClass('--me');
			}

			if( LJ.user.friends.indexOf( sender_id ) != -1 ){
				return $msg.addClass('--friend');
			}

		},
		tallifyAllChatLines: function( chat_id ){

			var $w = LJ.chat.getChatInview( chat_id );
			$w.find('.chat-inview-message__bubble').each(function( i, el ){
				LJ.chat.tallifyChatLine( $( el ).attr('data-call-id') );
			});

		},
		tallifyChatLine: function( call_id ){

			var $m = LJ.chat.getMessageElById( call_id );
			// Detect when the message is written on more than one line
			if( $m.height() > 20 ){
				$m.addClass('--tall');
			}

		},
		refetchChatHistory: function( chat_id ){

			var $w = LJ.chat.getChatInview( chat_id );
			var $g = $w.find('.chat-inview-message').first();

			var sent_at = $w.find('.chat-inview-message__bubble:not(.--pending)').first().attr('data-sent-at');
			var call_id = $w.find('.chat-inview-message__bubble').first().attr('data-call-id');

			if( $w.hasClass('--fetching-history') ){
				LJ.log('Cant fetch chat history, already fetching...');
				return;
			}

			$w.addClass('--fetching-history');
			$g.addClass('--glue');

			LJ.chat.horodateChatLine( call_id, { force: true });
			LJ.chat.loaderifyChatInview( chat_id );
			LJ.chat.saveActiveChatInviewScrollPose();

			LJ.api.fetchChatHistory( chat_id, { 
				sent_at: sent_at 
			})
			.then(function( res ){

				var chat_messages = res.messages;

				if( chat_messages.length == 0 ){
					return LJ.chat.allMessagesFetched( chat_id );
				}

				LJ.chat.deloaderifyChatInview( chat_id, function(){

					chat_messages.sort(function( ch1, ch2 ){
						return moment( ch2.sent_at ) - moment( ch1.sent_at );
					});

					chat_messages.forEach(function( message_object ){
						message_object.call_id = LJ.generateId();
						LJ.chat.addChatLine( message_object, { insert_mode: "prepend" });
					});
					
					LJ.chat.cacheChatMessages( chat_id, chat_messages );
					$w.removeClass('--fetching-history');
					$g.removeClass('--glue');
					
				});
			});
		},
		allMessagesFetched: function( chat_id ){

			var $w      = LJ.chat.getChatInview( chat_id );
			var call_id = $w.find('.chat-inview-message__bubble').first().attr('data-call-id');

			LJ.chat.deloaderifyChatInview( chat_id );
			LJ.chat.horodateChatLine( call_id );
			LJ.chat.getChatInview( chat_id ).removeClass('--fetching-history').addClass('--fetching-done');
			LJ.wlog('All messages have been fetched');

		},
		refreshChatJsp: function( chat_id ){

			LJ.log('Refreshing chat jsp!');

			var j = LJ.ui.jsp[ chat_id ];

			if( !j ){
				return // LJ.log('Chat hasnt been jsp-initialized yet, nothing to reinitialize');
			}

			var $w   = LJ.chat.getChatInview( chat_id );
			var $g   = $w.find('.--glue');
			var chat = LJ.chat.getChat( chat_id );

			var is_fetching_history = $w.hasClass('--fetching-history');
			var has_few_chat_lines  = $w.find('.chat-inview-message__bubble').length < 16;
			var is_almost_at_bottom = j.getPercentScrolledY() > 0.85;
			var is_at_top 			= j.getContentPositionY() == 0;
			var last_position_y     = chat.last_position_y;

			// Prevent an arriving chatline to accidentaly triggering a fetch history
			// by removing the fetch ready class right before reinitialise happens.
			$w.removeClass('--fetch-ready');
			j.reinitialise();
			
			LJ.delay( 300 )
				.then(function(){
					$w.addClass('--fetch-ready');
				});

			// fetching history state, started when the loading happens and ends after all 
			// chat messages have been added. During this, always stick to the saved position
			if( is_fetching_history ){
				// LJ.log('User is fetching history, scrolling to the glued element...');
	           	j.scrollToElement( $g, true );
                j.scrollToY( j.getContentPositionY() );
	           	return;
			}

			if( !last_position_y ){
				// LJ.log('User has unknown last position, first time he opens the chat. Put him to bottom...');
				j.scrollToBottom();
				return;
			}

			// User is almost at the end of the chat, scroll to the bottom to display the last message
			if( is_almost_at_bottom ){
				// LJ.log('User is almost at bottom, scrolling bottom...');
				j.scrollToBottom();
				return;
			}

			// In order to allow for one single fixed ratio (see just above), split the algorithm into a fix part
			// where the use is forced to go down when too few chat lines.
			if( has_few_chat_lines ){
				// LJ.log('User has too few chat lines, forcing to scroll down ');
				j.scrollToBottom();
				return;
			}
			// User happens to be at top without fetching history state, which means that either the history
			// is complete, or that its a jsp anomaly. Put him back right where he was before coming
			if( is_at_top ){
				// LJ.log('User is at top for some weird reason, scrolling to the last position...');
				j.scrollToY( last_position_y );
				return;
			}

			// LJ.log('Nothing special happened, let the user exactly where he is...');


		},
		horodateChatLine: function( call_id, opts ){

			opts = opts || {};

			var $curr_message = LJ.chat.getMessageElById( call_id ).closest('.chat-inview-message');
			var $prev_message = $curr_message.prev();
			var $next_message = $curr_message.next();

			var $curr_message_bubble = $curr_message.find('.chat-inview-message__bubble').last();
			var $prev_message_bubble = $prev_message.find('.chat-inview-message__bubble').last();
			var $next_message_bubble = $next_message.find('.chat-inview-message__bubble').last();

			var curr_message_sent_at = $curr_message_bubble.attr('data-sent-at');
			var prev_message_sent_at = $prev_message_bubble.attr('data-sent-at');
			var next_message_sent_at = $next_message_bubble.attr('data-sent-at');

			var date_html = LJ.chat.renderChatLine__Date( curr_message_sent_at );
			var $date     = $( date_html );

			// if( $prev_message.length == 0 && $('.chat-inview-message').length > 1 ){
			// 	$date.insertBefore( $curr_message );
			// }

			if( opts.force == true ){
				return $date.insertBefore( $curr_message );
			}

			if( $next_message.length == 0 && $prev_message.length != 0 ){
				var diff = curr_message_sent_at - prev_message_sent_at;
				if( diff >= 7200 ){
					$date.insertBefore( $curr_message );
				}
			}

			if( $prev_message.length == 0 && $next_message.length != 0 ){
				var diff = next_message_sent_at - curr_message_sent_at;
				if( diff >= 7200 ){
					$date.insertBefore( $next_message );
				}
			}

		},
		mergeChatLine: function( call_id ){

			var $bubble = LJ.chat.getMessageElById( call_id );
			var $w      = $bubble.closest('.chat-inview-message');

			var $prev   = $w.prev();
			var $next   = $w.next();

			if( $prev.hasClass('chat-inview-message__date') && $next.length == 0 ){
				return LJ.log('Cant merge chat, already horodated');
			}

			if( $prev.attr('data-sender-id') != $w.attr('data-sender-id') && $next.length == 0 ){
				return LJ.log('Cant merge chat, not the same sender');
			}

			if( $next.hasClass('chat-inview-message__date') && $prev.length == 0 ){
				return LJ.log('Cant merge chat, already horodated');
			}

			if( $next.attr('data-sender-id') != $w.attr('data-sender-id') && $prev.length == 0 ){
				return LJ.log('Cant merge chat, not the same sender');
			}

			if( $next.length == 0 ){
				var $bubbles_wrap = $prev.find('.chat-inview-message__bubble-wrap');
				$bubble.appendTo( $bubbles_wrap );
			} else {
				var $bubbles_wrap = $next.find('.chat-inview-message__bubble-wrap');
				$bubble.prependTo( $bubbles_wrap );
			}

			$w.remove();

			var $children = $bubbles_wrap.children();			

			$children.each(function( i, bubble ){

				var $b = $( bubble );

				$b.removeClass('--last'); // Reset the last each time new bubbles are merged

				if( i == 0 ){
					$b.addClass('--first');
				}

				if( i == $bubbles_wrap.children().length - 1 ){
					$b.addClass('--last')
				}
				
				$b.addClass('--merged');

			});

		},
		insertChatLine: function( chat_id, chat_line_html, insert_mode ){

			var $w = LJ.chat.getChatInview( chat_id ).find('.chat-inview-messages')						

			if( $w.find('.jspPane').length != 0 ){
				$w = $w.find('.jspPane');
			}

			LJ.chat.deemptifyChatInview( chat_id );
			$( chat_line_html ).css({
				'opacity': 0 // If display "none", its not detected by jScrollPane when refreshing the overflow
			}); 

			if( insert_mode == "prepend" ){
				$( chat_line_html ).prependTo( $w );

			} else {
				$( chat_line_html ).appendTo( $w );

			}

		},
		showChatLine: function( call_id ){
			
			var $set;
			var $message = LJ.chat.getMessageElById( call_id );

			if( $message.hasClass('--merged') ){
				$set = $message;

			} else {
				$set = $message.closest('.chat-inview-message');
			}
			$set.velocity({ opacity: [ 1, 0 ] }, {
					duration: 450,
					complete: function(){
						
					}
				});		

		},
		renderChatLine: function( data ){

			var sender_id   = data.sender_id;
			var message     = data.message;
			var sent_at     = data.sent_at;
			var call_id 	= data.call_id;
			
			var sender = LJ.chat.getUser( sender_id );
			var m      = moment( sent_at );

			var img_html = LJ.pictures.makeImgHtml( sender.img_id, sender.img_vs, "chat-line" );

			return LJ.ui.render([

				'<div class="chat-inview-message" data-sender-id="'+ sender_id +'">',
	              '<div class="chat-inview-message-head">',
	                '<div class="chat-inview-message__picture js-user-profile" data-facebook-id="'+ sender_id +'">',
	               	  '<span class="hint hint--top hint--rounded hint--no-animate" data-hint="'+ m.format('HH:mm') +'"></span>',
	                  img_html, // size 35
	                  '<span class="js-user-online user-online --online" data-facebook-id="'+ sender_id +'"></span>',
	                '</div>',
	                '<div class="chat-inview-message__name">'+ sender.name +'</div>',
	              '</div>',
	              '<div class="chat-inview-message-body">',
	                '<div class="chat-inview-message__bubble-wrap">',
	                  '<span class="chat-inview-message__bubble" data-call-id="'+ call_id +'" data-sent-at="'+ m.toISOString() +'">',
	                  	message,
	                  '</span>',
	                '</div>',
	              '</div>',
	            '</div>'

			].join(''));


		},
		renderChatLine__Date: function( sent_at ){

			var m = moment( sent_at );

			var day_week  = LJ.text("day")[ m.day() ];
			var day_digit = m.format('DD/MM');
			var day_hour  = m.format('HH:mm'); 

			return LJ.ui.render([

				 '<div class="chat-inview-message__date">',
	              '<span class="--day">'+ day_week +'</span>',
	              '<span class="--month">'+ day_digit +',</span>',
	              '<span class="--hour">'+ day_hour +'</span>',
             	'</div>'

			].join(''));

		},
		renderChatOptions__All: function(){

			return LJ.chat.renderChatOptions({
				show_users_html  : '<span data-lid="chat_inview_options_message_show_users_all"></span>',
				show_before_html : '<span data-lid="chat_inview_options_message_show_before"></span>'
			});

		},
		renderChatOptions__Team: function(){

			return LJ.chat.renderChatOptions({
				show_users_html: '<span data-lid="chat_inview_options_message_show_users_team"></span>'
			});

		},
		renderChatOptions: function( opts ){

			var show_users_html = opts.show_users_html ?
				'<div class="ioptions__action js-show-users">' + opts.show_users_html + '</div>' : '';

			var show_before_html = opts.show_before_html ?
				'<div class="ioptions__action js-show-before">' + opts.show_before_html + '</div>' : '';

			return LJ.ui.render([

				'<div class="ioptions__actions">',
		            '<div class="ioptions__action-message">',
		              '<span data-lid="chat_inview_options_message"></span>',
		            '</div>',
		            show_before_html,
		            show_users_html,
		            '<div class="ioptions__action --back js-ioptions-close">',
		             ' <span data-lid="slide_overlay_back"></span>',
		            '</div>',
	          	'</div>'

			].join(''));


		},
		renderChatOptions__GroupHosts: function( hosts_html ){

			return LJ.ui.render([

				'<div class="chat-inview-users__group">',
	              	// '<i class="icon icon-star"></i>',
	              	'<span data-lid="chat_inview_users_group_hosts"></span>',
		        '</div>',
		        hosts_html

		    ].join(''));

		},
		renderChatOptions__GroupMembers: function( members_html ){

			return LJ.ui.render([

				'<div class="chat-inview-users__group">',
		              // '<i class="icon icon-bookmark"></i>',
		              '<span data-lid="chat_inview_users_group_users"></span>',
			    '</div>',
			    members_html

		    ].join(''));

		},
		renderChatOptions__Group: function( opts ){

			return LJ.ui.render([
				
				'<div class="chat-inview-options__close --round-icon js-ioptions-close">',
		            '<i class="icon icon-cancel"></i>',
		        '</div>',
		        '<div class="chat-inview-users">',
		        	opts.hosts_group_html,
		        	opts.members_group_html,
		        '</div>'

			].join(''));

		},
		renderChatInviewHeader: function(){

			return [
					'<div class="chat-inview-header">',
						'<div class="chat-inview__icon --previous js-chat-back --round-icon">',
		            		'<i class="icon icon-arrow-left"></i>',
				        '</div>',
				        '<div class="chat-inview__icon --options --round-icon">',
				            '<i class="icon icon-pending-vertical"></i>',
				        '</div>',		          
			          '<div class="chat-inview-title">',
			            '<div class="chat-inview-title__h1">',
			            	// Dynamically injected
			            '</div>',
			            '<div class="chat-inview-title__h2">',
			            	// Dynamically injected
			            '</div>',
			          '</div>',
			        '</div>'
			    ].join('');

		},
		renderChatInview: function( channel_item ){

			var team_id = channel_item.team_id;
			var chat_id = channel_item.chat_id;

			var chat_inview_header_html = LJ.chat.renderChatInviewHeader();

			return LJ.ui.render([

				'<div class="chat-inview" data-team-id="'+ team_id +'" data-chat-id="'+ chat_id +'">',
			        chat_inview_header_html,
			        '<div class="chat-inview-item --'+ channel_item.type +'" data-chat-id="'+ chat_id +'">',
			        	'<div class="chat-inview-options"></div>',
	          			'<div class="chat-inview-messages">',
		          			'<div class="chat-inview-seen-by">',
				          		'<span class="chat-inview-seen-by__label"></span>',
				          	'</div>',
	          				// Dynamically injected
	          			'</div>',
	          		'</div>',
		          	'<div class="chat-inview-footer">',
			            '<div class="chat-inview-input js-send-message">',
			             	'<input data-lid="chat_input_placeholder" placeholder="lol">',
			            '</div>',
		          	'</div>', 
			    '</div>'

			].join(''));

		},
		handleShowOptions: function(){

			var $s      = $( this );
			var $wrap   = $s.closest('.chat-inview');
			var chat_id = $wrap.attr('data-chat-id');
			var chan    = LJ.chat.getChannelItem( chat_id );

			var html;
			if( chan.type == "chat_all" ){
				html = LJ.chat.renderChatOptions__All();
			} else {
				html = LJ.chat.renderChatOptions__Team();
			}

			LJ.ui.showIoptions( $wrap, html );

		},
		handleShowUsers: function(){

			var $s      = $( this );
			var $w      = $s.closest('.chat-inview');
			var chat_id = $w.attr('data-chat-id');
			var chan    = LJ.chat.getChannelItem( chat_id );
	
			// In each case, members will be there			
			var members_profiles = LJ.chat.getMembers( chat_id );
			var members_html = LJ.renderUserRows( members_profiles );

			if( chan.type == "chat_all" ){

				var hosts_profiles = LJ.chat.getHosts( chat_id );
				var hosts_html     = LJ.renderUserRows( hosts_profiles );

				var h = LJ.chat.renderChatOptions__Group({
					members_group_html : LJ.chat.renderChatOptions__GroupMembers( members_html ),
					hosts_group_html   : LJ.chat.renderChatOptions__GroupHosts( hosts_html )
				});	

			} else {
				
				var h = LJ.chat.renderChatOptions__Group({
					members_group_html : LJ.chat.renderChatOptions__GroupMembers( members_html ),
				});	

			}

			LJ.ui.updateIoptions( h );
			

		},
		handleShowBefore: function(){
			
			var $s        = $( this) ;
			var $w        = $s.closest('.chat-inview');
			var chat_id   = $w.attr('data-chat-id');
			var chan      = LJ.chat.getChannelItem( chat_id );
			var before_id = chan.before_id;

			LJ.before.fetchAndShowBeforeInview( before_id );

		},
        getLastChatMessage: function( chat_id ){

        	var chat = LJ.chat.getChat( chat_id );
        	var last_message = chat && chat.messages && chat.messages[0];

        	return last_message;

        },
        sendSeenBy: function( chat_id ){

        	var last_message = LJ.chat.getLastChatMessage( chat_id );

			if( !last_message ){
				return;
			}

			var last_seen_by = last_message.seen_by;

			if( !Array.isArray( last_seen_by ) ){
				return LJ.wlog('Last_seen_by aint no array');
			}

			if( last_seen_by.indexOf( LJ.user.facebook_id ) != -1 ){
				return LJ.log('Already sent seen by, not calling the api');
			}

			// Reset the parameters of the proxy version, since were about to call the api no matter what
			var chat = LJ.chat.getChat( chat_id );
			clearTimeout( chat.seen_by_timeout );
			chat.seen_by_batch = 0;

        	LJ.log('Sending seen by...');
        	LJ.api.updateChatSeenBy( chat_id )
        		.then(function(){ LJ.log("...success!"); })
        		.catch(function( err ){ LJ.wlog( err ); });


        },
        sendSeenByProxy: function( chat_id, skip_cache ){

        	var last_message = LJ.chat.getLastChatMessage( chat_id );

			if( !last_message ){
				return;
			}

			var last_seen_by = last_message.seen_by;

			if( !Array.isArray( last_seen_by ) ){
				return LJ.wlog('Last_seen_by aint no array');
			}

			if( last_seen_by.indexOf( LJ.user.facebook_id ) != -1 && !skip_cache ){
				return LJ.log('Already sent seen by, not calling the api');
			}

			// Proxy the request because everytime a message is received and the user
			// has the chat in active state, a request must be made. Hence, send a request
			// every 10 messages, or every 10 seconds. Huge performance boost.
			var chat = LJ.chat.getChat( chat_id );

			chat.seen_by_batch = chat.seen_by_batch || 0;

			if( chat.seen_by_batch < 10 && !skip_cache ){

				chat.seen_by_batch += 1;

				if( chat.seen_by_timeout ){
					clearTimeout( chat.seen_by_timeout );
				}

				chat.seen_by_timeout = setTimeout(function(){
					LJ.chat.sendSeenByProxy( chat_id, true );

				}, 10000 );
				

			} else {

	        	LJ.log('Sending seen by...');
	        	LJ.api.updateChatSeenBy( chat_id )
	        		.then(function(){ LJ.log("...success!"); })
	        		.catch(function( err ){ LJ.wlog( err ); });

	        	chat.seen_by_batch = 0;				

			}

        },

        getUsersCountById: function( chat_id ){

        	var channel   = LJ.chat.getChannelItem( chat_id );

        	var n_hosts   = channel.hosts && channel.hosts.length;
        	var n_members = channel.members && channel.members.length;

        	if( !n_hosts && n_members ){
        		return n_members;
        	}

        	if( !n_members && n_hosts ){
        		return n_hosts;
        	}

        	return n_members + n_hosts;

        },
        // Update the "seen by..." element
        refreshChatSeenBy: function( chat_id ){

			var $w           = LJ.chat.getChatInview( chat_id );
			var last_message = LJ.chat.getLastChatMessage( chat_id );

			if( !last_message ){
				return;
			}

			var seen_by   = last_message.seen_by;
			var sender_id = last_message.sender_id;

			var names = [];
			seen_by.forEach(function( facebook_id ){

				// It would be dumb to let others know that the sender has read its own message
				// and weird for the user to see his own name on the "seen_by" list
				if( facebook_id != sender_id ){
					names.push( LJ.chat.getUser( facebook_id ).name );
				}

			});

			// Substract 1 because the user owns id has already been removed
			var c = LJ.chat.getUsersCountById( chat_id );
        	var s = LJ.chat.makeSeenByText( names, seen_by.length, c );

        	$w.find('.chat-inview-seen-by__label').html( s );
        	LJ.chat.refreshChatJsp( chat_id );

        },
        makeSeenByText: function( names, seen_by_length, count ){

        	if( names.length == 0 ){
        		return '';
        	}

        	// This rule is in conflict with the fact that users can choose not to activate the readby feature
        	// if( seen_by_length == count ){
        	// 	return LJ.text('seen_by_everyone') + '<i class="icon icon-check"></i>';
        	// }

        	return LJ.text('seen_by_some', names );

        },
        emptifyChatInview: function( chat_id ){

        	var chan = LJ.chat.getChannelItem( chat_id );

        	if( chan.type == "chat_team" ){
				
				var members    = LJ.chat.getMembers( chat_id );
				var names      = _.map( members, 'name' );
				var group_name = LJ.renderMultipleNames( names, { lastify_user: LJ.user.name });

				html = LJ.chat.renderChatInview__TeamEmpty( group_name );

			} else {

				var user_profile = chan.role == "hosted" ?
					LJ.chat.getMainMember( chat_id ) :
					LJ.chat.getMainHost( chat_id );

				var group_name = LJ.renderGroupName( user_profile.name );

				html = LJ.chat.renderChatInview__AllEmpty( group_name );
				
			}

        	LJ.chat.getChatInview( chat_id )
        		.find('.chat-inview-item')
        		.append( html )
        		.find('.chat-inview-messages')
        		.hide();

        	LJ.chat.refreshChatJsp( chat_id );

        },	
        deemptifyChatInview: function( chat_id ){

        	LJ.chat.getChatInview( chat_id ).find('.chat-empty').remove();
        	LJ.chat.getChatInview( chat_id ).find('.chat-inview-messages').show();
        	LJ.chat.refreshChatJsp( chat_id );

        },
        acceptifyChatInview: function( chat_id ){

        	LJ.chat.getChatInview( chat_id )
        		.find('button')
        		.replaceWith( LJ.before.renderBeforeInviewBtn__UserAccepted());

        },
        getChatInview: function( chat_id ){

        	if( !chat_id ){
				return LJ.wlog('Cannot target chat row without chat_id');
			}

			return $('.chat-inview[data-chat-id="'+ chat_id +'"]');

        },
        getChatInviews: function(){

        	return $('.chat-inview');

        },
        bounceChatHeaderIcons: function( chat_id, delay ){

        	LJ.chat.getChatInview( chat_id )
        		.closest('.chat-inview')
        		.find('.chat-inview__icon')
        		.hide()
        		.velocity('slideUpIn', {
        			duration : 750,
        			delay    : delay,
        			display  : 'flex'
        		});

        },
        emptifyChatSeenBy: function( chat_id ){

        	LJ.chat.getChatInview( chat_id )
        		.find('.chat-inview-seen-by__label').text('');

        },
        updateInputState: function( chat_id, e ){

        	var chat = LJ.chat.getChat( chat_id );

        	if( LJ.chat.getKeyname == "return" ){
        		chat.input = chat.input.substring( 0, chat.input.length - 1 );
        	} else {
        		chat.input = chat.input + e.key;
        	}

        },
        renderTextInputElement: function( reset ){

			return LJ.ui.render( '<div class="chat-inview-input__text" contenteditable="true"></div>' );

		},
		placeholderifyChatInput: function( chat_id ){

			var placeholder_text = LJ.text("chat_input_placeholder");
			var placeholder_html = LJ.ui.render( '<div class="chat-inview-input__placeholder">'+ placeholder_text +'</div>' );

			LJ.chat.getChatInview( chat_id )
				.find('.chat-inview-input')
				.prepend( placeholder_html );

		},
		deplaceholderifyChatInput: function( chat_id ){

			LJ.chat.getChatInview( chat_id )
				.find('.chat-inview-input__placeholder')
				.remove();

		},
		parseChatInput: function( chat_id ){

		},
		refreshChatInput: function( chat_id ){

		}


	});




	window.LJ.chat = _.merge( window.LJ.chat || {}, {

		test: {
			messages : [

				'Salut tout le monde',
				'Coucou',
				'Vous allez bien ?',
				'Qui fait quoi ce soir ?',
				'Bon a me chauffe bien cette histoire ! Qui est partant,  part moi ?? Allerrrr !!',
				'Hmm... je sais pas quoi rpondre ahah',
				'Okay...',
				'Merci',
				'^^'

			],
			setup: function(){

				var chat_id  = $('.chat-inview-item.--active').attr('data-chat-id');
				var group_id = $('.chat-inview-item.--active').attr('data-group-id');

				var m = moment();

				var group_object  = LJ.chat.fetched_groups[ group_id ];
				var possible_ids = _.map( _.concat( group_object.members_profiles, group_object.hosts_profiles ), 'facebook_id' );

				var data = {
					sender_id   : _.shuffle( possible_ids )[0],
					message     : _.shuffle( LJ.chat.test.messages )[ 0 ],
					chat_id     : chat_id,
					group_id    : group_id
				}; 

				var call_id = LJ.generateId();
				var chat_line_html = LJ.chat.renderChatLine( data, call_id );

				window.testInsertChat = function(){
					LJ.chat.insertChatLine( chat_id, chat_line_html, call_id );
					LJ.chat.showChatLine( call_id );
				}

				window.testPendifyChatLine = function(){
					LJ.chat.pendifyChatLine( call_id );
				}

				window.testClassifyChatLine = function(){
					LJ.chat.classifyChatLine( call_id );
				}

				window.testRefreshChatJsp = function(){
					LJ.chat.refreshChatJsp( chat_id );
				}

				window.testHorodateChatLine = function(){
					LJ.chat.horodateChatLine( chat_id );
				}

				window.testAddChatLine = function(){

					m.add( _.shuffle( [1,1,1,1,1,3] )[0], 'hour' );

					var data = {
						sender_id   : _.shuffle( possible_ids )[0],
						message     : _.shuffle( LJ.chat.test.messages )[ 0 ],
						chat_id     : chat_id,
						group_id    : group_id,
						sent_at     : m.toISOString()
					}; 

					var call_id = LJ.generateId();

					LJ.chat.addChatLine( data, call_id );
					//LJ.chat.updateChatRow__NewMessage( _.merge(data, { sender: LJ.chat.findChatSender( group_id, data.facebook_id )} ) );
					LJ.chat.pendifyChatLine( call_id );
					LJ.delay(1000).then(function(){
						LJ.chat.dependifyChatLine( call_id );
					});

				}

			}

		}


	});

	window.LJ.cheers = _.merge( window.LJ.cheers || {}, {

		cheers_back_duration: 450,

		fetched_cheers     : [],
		fetched_profiles   : [],
		active_cheers_back : null,
		cheers_back_state  : "idle",

		init: function(){

			LJ.cheers.handleDomEvents();
			LJ.cheers.activateCheers("received");
			return;

		},
		handleDomEvents: function(){

			$('.menu-section.--cheers').on('click', '.segment__part', LJ.cheers.handleSegmentClicked );
			$('.menu-item.--cheers').one('click', LJ.cheers.handleCheersClicked );
			$('.cheers').on('click', '.cheers__item', LJ.cheers.handleCheersItemClicked );
			$('.chat').on('click', '.js-validate', LJ.cheers.handleValidate );
			$('body').on('click', '.js-close-cheers-back', LJ.cheers.handleCloseCheersBack );

		},
		handleSegmentClicked: function(){

			var $seg = $( this );
			var link = $seg.attr('data-link');

			LJ.cheers.activateCheers( link );

		},
		handleCloseCheersBack: function(){

			var close_type = LJ.cheers.getCloseType();

			LJ.chat.refreshChatRowsJsp().then(function(){

				LJ.cheers.resetCheersBackState()

				if( close_type == "hide_all" ){
					LJ.chat.hideChatWrap().then(function(){
						$('.cheers-back').remove();
					});
				}

				if( close_type == "hide_cheers_back" ){
					$('.cheers-back').remove();
				}


			});
		},
		activateCheers: function( link ){

			var $seg = $('.menu-section.--cheers').find('.segment__part[data-link="'+ link +'"]');

			if( $seg.hasClass('--active') ){
				return LJ.wlog('Already activated');
			}

			$seg.siblings().removeClass('--active');
			$seg.addClass('--active');

			LJ.cheers.filterCheersItems( link );

		},
		filterCheersItems: function( link ){

			$('.cheers').children().css({ display: 'none' });
			$('.cheers [data-link="' + link + '"]').css({ display: 'flex' });

		},
		clearAllCheers: function(){

			$('.cheers').html('');

		},
		showCheersLoader: function(){

			LJ.cheers.$loader = $( LJ.static.renderStaticImage('menu_loader') );

			LJ.cheers.$loader.addClass('none').appendTo('.cheers')
				.velocity('bounceInQuick', {
				   	delay: 125,
				   	duration: 500,
				   	display: 'block'
				});		

		},
		hideCheersLoader: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.cheers.$loader.velocity('shradeOut', {
					duration: 250,
					complete: function(){
						$( this ).remove();
						resolve();
					}
				});

			});
		},
		showCheersBackLoader: function(){

			$( LJ.static.renderStaticImage('slide_loader') )
				.addClass('cheers-back__loader')
				.hide()
				.appendTo($('.cheers-back'))
				.show();

		},
		hideCheersBackLoader: function(){

			$('.cheers-back').find('.cheers-back__loader').remove();

		},
		showCheersBackOverlay: function(){

			$('<div class="loader__overlay"></div>')
				.hide()
				.appendTo( $('.cheers-back') )
				.velocity('fadeIn', {
					duration: 500
				});

		},
		hideCheersBackOverlay: function(){

			$('.cheers-back').find('.cheers-back__overlay').remove();

		},
		handleCheersClicked: function(){

			LJ.cheers.showCheersLoader();
			LJ.cheers.clearAllCheers();
			LJ.cheers.fetchAndAddCheers();

		},	
		fetchAndAddCheers: function(){

			LJ.log('Fetching and setting cheers items...');

			LJ.cheers.removeAllCheers();
			LJ.cheers.showCheersLoader();

			LJ.api.fetchMeCheers()
				.then(function( res ){
					LJ.cheers.fetched_cheers = res.cheers;

				})
				.then(function(){

					var main_hosts     = _.map( LJ.cheers.fetched_cheers, 'main_host' );
					var members        = _.flatten( _.map( LJ.cheers.fetched_cheers, 'members' ) );

					var facebook_ids = _.uniq( _.concat( main_hosts, members ) );
					return LJ.api.fetchUsers( facebook_ids )

				})
				.then(function( res ){
					LJ.cheers.fetched_profiles = _.filter( _.map( res, 'user' ), Boolean );
					return LJ.cheers.renderCheersItems( LJ.cheers.fetched_cheers, LJ.cheers.fetched_profiles );

				})
				.then(function( cheers_html ){
					return LJ.cheers.addCheersItems( cheers_html );

				})
				.then(function( $cheers ){
					return LJ.cheers.hideCheersLoader();

				})
				.then(function(){
					var type = LJ.cheers.getActiveCheersType();
					return LJ.cheers.showCheersItems( type );

				})
				.catch(function( e ){
					LJ.cheers.hideCheersLoader();
					LJ.wlog(e);

				});

		},
		getCheersItem: function( cheers_id ){

			return _.find( LJ.cheers.fetched_cheers, function( ch ){
				return ch.cheers_id == cheers_id;
			});

		},
		handleCheersItemClicked: function(){

			var $s        = $( this );
			var cheers_id = $s.attr('data-cheers-id');

			var cheers_item = LJ.cheers.getCheersItem( cheers_id );

			if( cheers_item.status == "accepted" ){

				if( LJ.chat.getChatState() == "hidden" ){
					LJ.chat.showChatWrap();
				}

				LJ.chat.hideChatInview();
				LJ.cheers.removeCheersBack();
				LJ.chat.activateChat( cheers_item.chat_id );
				LJ.chat.showChatInview( cheers_item.chat_id );

			} else {

			// Cheers is in the pending state
			cheers_item.cheers_type == "sent" ?
				LJ.before.fetchAndShowBeforeInview( cheers_item.before_id ) :
				LJ.cheers.validatifyCheersItem( cheers_id );

			}

		},
		refreshCheersItems: function(){

			var cheers   = LJ.cheers.fetched_cheers;
			var profiles = LJ.cheers.fetched_profiles;

			if( profiles.length == 0 ){
				return LJ.cheers.fetchAndAddCheers();
			}

			var type 		= LJ.cheers.getActiveCheersType();
			var cheers_html = LJ.cheers.renderCheersItems( cheers, profiles );

			LJ.cheers.removeAllCheers();
			LJ.cheers.addCheersItems( cheers_html );
			LJ.cheers.showCheersItems( type, 1 );


		},
		removeAllCheers: function(){

			$('.cheers').children().remove();

		},
		getActiveCheersType: function(){

			return $('.menu-section.--cheers').find('.segment__part.--active').attr('data-link');

		},
		renderCheersItems: function( cheers, user_profiles ){

			var html = [];
			
			var no_cheers_received = true;
			var no_cheers_sent     = true;
				
			cheers.forEach(function( ch ){

				if( ch.cheers_type == "received" ){

					no_cheers_received = false;
					var main_member_profile = _.find( user_profiles, function( u ){
						return u.facebook_id == ch.main_member;
					});
					html.push( LJ.cheers.renderCheersItem__Received( ch, main_member_profile, ch.place_name ) );

				}

				if( ch.cheers_type == "sent" ){

					no_cheers_sent = false;
					var main_host_profile = _.find( user_profiles, function( u ){
						return u.facebook_id == ch.main_host;
					})
					var requested_with_profiles = _.filter( user_profiles, function( u ){
						return ch.members.indexOf( u.facebook_id ) != -1 && u.facebook_id != LJ.user.facebook_id;
					});
					html.push( LJ.cheers.renderCheersItem__Sent( ch, main_host_profile, requested_with_profiles, ch.place_name ));
				}

			});

			if( no_cheers_sent ){
				html.push( LJ.cheers.renderCheersItem__SentEmpty() );
			}

			if( no_cheers_received ){
				html.push( LJ.cheers.renderCheersItem__ReceivedEmpty() );
			}

			return html.join('');

		},
		addCheersItems: function( cheers_html ){

			var $w = $('.cheers');

			$( cheers_html ).hide().appendTo( $w );

		},
		showCheersItems: function( type, duration ){

			type = type || "sent";

			var $w = $('.cheers');

			$w.find('[data-link="' + type + '"]').velocity('shradeIn', {
				duration : duration || 250,
				display  : 'flex'
			});

		},
		renderCheersItem__ReceivedEmpty: function(){

			return LJ.ui.render([

				'<div class="empty" data-link="received">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-drinks"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_cheers_received_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_cheers_received_subtitle"></p>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderCheersItem__SentEmpty: function(){

			return LJ.ui.render([

				'<div class="empty" data-link="sent">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-drinks"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_cheers_sent_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_cheers_sent_subtitle"></p>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderCheersItemIcon__Received: function( status ){

			if( status == "pending" ){
				return [ '<div data-hint="'+ LJ.text("hint_cheers_pending") +'" class="row-pic__icon --round-icon --pending hint--left hint--rounded">',
					'<i class="icon icon-drinks"></i>',
				'</div>'].join('');
			}

			if( status == "accepted" ){
				return [ '<div data-hint="'+ LJ.text("hint_cheers_accepted") +'" class="row-pic__icon --round-icon --accepted hint--left hint--rounded">',
					'<i class="icon icon-chat-bubble-duo"></i>',
				'</div>'].join('');
			}

		},
		renderCheersItem__Received: function( cheers_object, main_requester, address ){

			var ch = cheers_object;

			var formatted_date = LJ.text( "menurow_date", moment(ch.requested_at) );
			var img_html       = LJ.pictures.makeImgHtml( main_requester.img_id, main_requester.img_vs, 'menu-row' );

			var groupname 	   = LJ.renderGroupName( main_requester.name );
			var groupname_html = LJ.text('cheers_item_title_received').replace('%groupname', groupname);

			var address  	   = ch.place_name;

			return LJ.ui.render([

				'<div class="cheers__item" data-link="received" data-before-id="'+ ch.before_id +'" data-cheers-id="' + ch.cheers_id + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + img_html + '</div>',
						LJ.cheers.renderCheersItemIcon__Received( ch.status ),
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + groupname_html +'</h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon"><i class="icon icon-location"></i></div>',
							'<h4>' + address + '</h4>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderCheersItemIcon__Sent: function( status ){

			if( status == "pending" ){
				return [ '<div data-hint="'+ LJ.text("hint_cheers_pending") +'" class="row-pic__icon --round-icon --pending hint--left hint--rounded">',
					'<i class="icon icon-pending"></i>',
				'</div>'].join('');
			}

			if( status == "accepted" ){
				return [ '<div data-hint="'+ LJ.text("hint_cheers_accepted") +'" class="row-pic__icon --round-icon --accepted hint--left hint--rounded">',
					'<i class="icon icon-chat-bubble-duo"></i>',
				'</div>'].join('');
			}

		},
		renderCheersItem__Sent: function( cheers_object, main_host_profile, requested_with_profiles, address ){

			var ch = cheers_object;

			var formatted_date       = LJ.text( "menurow_date", moment(ch.requested_at) );
			var img_html             = LJ.pictures.makeImgHtml( main_host_profile.img_id, main_host_profile.img_vs, 'menu-row' );

			var groupname            = LJ.renderGroupName( main_host_profile.name );
			var groupname_html       = LJ.text('cheers_item_title_sent').replace('%groupname', groupname );

			var requested_with_names = LJ.renderMultipleNames( _.map( requested_with_profiles, 'name' ) );
			var requested_with_html  = LJ.text("cheers_requested_with").replace( '%names', requested_with_names );

			var address              = ch.place_name;

			return LJ.ui.render([

				'<div class="cheers__item" data-link="sent" data-before-id="'+ ch.before_id +'" data-cheers-id="' + ch.cheers_id + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + img_html + '</div>',
						LJ.cheers.renderCheersItemIcon__Sent( ch.status ),
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + groupname_html +'</h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon"><i class="icon icon-users"></i></div>',
							'<h4>' + requested_with_html + '</h4>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon"><i class="icon icon-location"></i></div>',
							'<h4>' + address + '</h4>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		setCloseType: function( close_type ){

			LJ.cheers.close_type = close_type;

		},
		getCloseType: function(){

			return LJ.cheers.close_type;

		},
		validatifyCheersItem: function( cheers_id ){

			if( LJ.cheers.getActiveCheersBack() == cheers_id ){
				return;
			}

			LJ.cheers.setActiveCheersBack( cheers_id );

			LJ.cheers.makeCheersBack( cheers_id );
			LJ.cheers.refreshChatBackUsersJsp();

			if( LJ.chat.getChatState() == "hidden" ){
				LJ.cheers.setCloseType("hide_all");
				LJ.chat.showChatWrap();
			} else {
				// Chat was already opened. Only set a cheers_mode if none was set before
				if( !LJ.cheers.getCloseType() ){
					LJ.cheers.setCloseType("hide_cheers_back");
				}
			}
			LJ.cheers.showCheersBack();

		},
		setCheersBackState: function( state ){

			LJ.cheers.cheers_back_state = state;

		},
		getCheersBackState: function(){

			return LJ.cheers.cheers_back_state;

		},
		pendifyCheersItem: function(){

			if( LJ.cheers.getCheersBackState() != "idle" ){
				return LJ.wlog('Cheers back object isnt in an idle state');
			}

			LJ.cheers.setCheersBackState("pending");
			LJ.cheers.showCheersBackLoader();
			LJ.cheers.showCheersBackOverlay();

		},
		dependifyCheersItem: function(){

			if( LJ.cheers.getCheersBackState() != "pending" ){
				return LJ.wlog('Cheers back object isnt in an pending state');
			}

			LJ.cheers.setCheersBackState("idle");
			LJ.cheers.hideCheersBackLoader();
			LJ.cheers.hideCheersBackOverlay();

		},
		makeCheersBack: function( cheers_id ){

			var cheers_item = LJ.cheers.getCheersItem( cheers_id );

			var members_profiles = _.filter( LJ.cheers.fetched_profiles, function(m){
				return cheers_item.members.indexOf( m.facebook_id ) != -1;
			});

			var html = LJ.cheers.renderCheersBack( members_profiles );

			LJ.cheers.addCheersBack( html );
			LJ.mainifyUserRow( $('.cheers-back'), cheers_item.main_member );
			LJ.cheers.setCheersBackHeader( cheers_item )
			return;

		},
		acceptifyCheersItem: function( chat_id ){

			LJ.log('Acceptifying cheers item... !');

			// Prepare the chat in the background
			LJ.chat.hideChatInview();
			LJ.chat.activateChat( chat_id );
			LJ.chat.showChatInview( chat_id );

			LJ.chat.bounceChatHeaderIcons( chat_id, 400 );

			// Fade out the chatback wrapper
			LJ.cheers.hideCheersBack();

		},
		resetCheersBackState: function(){

			LJ.cheers.setCloseType( null );
			LJ.cheers.setActiveCheersBack( null );
			LJ.cheers.setCheersBackState("idle");

		},
		removeCheersBack: function(){

			LJ.cheers.resetCheersBackState();
			$('.cheers-back').remove();

		},	
		hideCheersBack: function(){

			$('.cheers-back').velocity('shradeOut', {
				duration: 500,
				complete: function(){

					$( this ).remove();
					LJ.cheers.resetCheersBackState();
				}
			});

		},
		updateCheersItem: function( cheers_id, opts ){

			var cheers_item = LJ.cheers.getCheersItem( cheers_id );

			_.keys( cheers_item ).forEach(function( key ){
				if( opts[ key ] && typeof opts[ key ] == typeof cheers_item[ key ] ){
					cheers_item[ key ] = opts[ key ];
				}
			});

		},
		getCheersRow: function( cheers_id ){

			return $('.cheers__item[data-cheers-id="'+ cheers_id +'"]');

		},
		acceptifyCheersRow: function( cheers_id ){

			var $row        = LJ.cheers.getCheersRow( cheers_id );
			var cheers_item = LJ.cheers.getCheersItem( cheers_id );
			
			if( $row.length == 0 ){
				return;
			}
			
			var $icon;
			if( cheers_item.cheers_type == "sent" ){
				$icon = LJ.cheers.renderCheersItemIcon__Sent( "accepted" );
			} else {
				$icon = LJ.cheers.renderCheersItemIcon__Received( "accepted" );
			}

			$row.find('.row-pic__icon').replaceWith( $icon );

		},	
		setActiveCheersBack: function( cheers_id ){

			LJ.cheers.active_cheers_back = cheers_id;

		},
		getActiveCheersBack: function(){

			return LJ.cheers.active_cheers_back;

		},
		addCheersBack: function( html ){

			$('.chat').find('.cheers-back').remove();
			$( html ).hide().appendTo( $('.chat') );

		},
		showCheersBack: function(){

			$('.chat').css({ 'display': 'flex' }).find('.cheers-back').show();

		},
		renderChatHeaderCloseIcon: function(){

			return [
				'<div class="chat-inview__icon --close js-close-cheers-back --round-icon">',
					'<i class="icon icon-cancel"></div>',
				'</div>'
			].join('');

		},
		setCheersBackHeader: function( cheers_item ){
			
			var $chat_header = $('.cheers-back').find('.chat-inview-header');
			// Replace icons
			$chat_header.find('.chat-inview__icon').remove();
			$chat_header.append( LJ.cheers.renderChatHeaderCloseIcon() );

			var formatted_date = LJ.text('chatinview_date', moment(cheers_item.begins_at) );
			$chat_header.find('.chat-inview-title__h1').html( '<span class="--date">'+ formatted_date +'</span>' );
			$chat_header.find('.chat-inview-title__h2').html( '<span class="--place">'+ cheers_item.place_name +'</span>' );

		},
		acceptifyChat: function(){

			
			
		},
		refreshChatBackUsersJsp: function(){
			
			var $w = $('.cheers-back');
			
			return LJ.ui.turnToJsp( $w.find('.cheers-back-users'), {
				jsp_id: 'cheers_back'
			});

		},
		renderCheersBack: function( members_profiles ){

			var pictures = [];
			members_profiles.forEach(function( u ){
				pictures.push({ img_id: u.img_id, img_vs: u.img_vs });
			});
			var pictures  = LJ.pictures.makeRosaceHtml( pictures, 'cheers-back' );
			var user_rows = LJ.renderUserRows( members_profiles );

			var cheers_back_html = LJ.chat.renderChatInviewHeader(); // Borrow it to the chat module

			return LJ.ui.render([

				'<div class="cheers-back">',
					cheers_back_html,
					'<div class="cheers-back-pictures">',
			        	pictures, 
			        '</div>',
					'<div class="cheers-back-groupname">',
						'<div class="cheers-back-groupname__h1">',
							'<span data-lid="cheers_back_groupname"></span>',
						'</div>',
					'</div>',
			        '<div class="cheers-back-users">',
			        	user_rows,
			        '</div>',
			        '<div class="cheers-back-actions">',
			        	'<button class="--round-icon js-validate">',
			        		'<i class="icon icon-drinks"></i>',
			        		'<span data-lid="chat_inview_validate"></span>',
			        	'</button>',
			        '</div>',
				'</div>'

			].join(''));

		},
        handleValidate: function(){

			var $s = $( this );

			if( LJ.cheers.getCheersBackState() == "pending" ){
				return;
			}

			var cheers_id = LJ.cheers.getActiveCheersBack();

        	LJ.log('Cheering back...');
        	LJ.cheers.cheersBack( cheers_id );

        },
        cheersBack: function( cheers_id ){

			var before_id = LJ.cheers.getCheersItem( cheers_id ).before_id;
			var members   = LJ.cheers.getCheersItem( cheers_id ).members;
			
			LJ.cheers.pendifyCheersItem();
        	LJ.api.changeGroupStatus({
        		cheers_id : cheers_id,
        		before_id : before_id,
        		members   : members,
        		status    : "accepted" 
        	})
    		.then(function( res ){
    			LJ.log("Cheers back successfully");

    		})
    		.catch(function( e ){
				
				LJ.log(e);
    			LJ.ui.showToast( LJ.text("to_default_error"), "error" );
    			LJ.cheers.dependifyCheersItem();

    		});

        },
        loaderifyCheersBack: function(){
        	return LJ.promise(function( resolve, reject ){	

        		var d = LJ.cheers.cheers_back_duration;

        		$('.cheers-back')
        			.children()
        			.velocity('shradeOut', { duration: d, display: 'none' });

	        	var d = LJ.static.renderStaticImage('slide_loader');
				$( d ).addClass('js-cheers-back-loader')
					  .hide().appendTo('.cheers-back')
					  .velocity('shradeIn', { duration: d, delay: d } );

				LJ.delay( 2*d ).then( resolve );

        	});

        },
        deloaderifyCheersBack: function(){
        	return LJ.promise(function( resolve, reject ){

	        	var d = LJ.cheers.cheers_back_duration;

				$('.js-cheers-back-loader')
					  .velocity('shradeOut', { duration: d, complete: function(){ $(this).remove(); }} );

        		$('.cheers-back')
        			.children()
        			.velocity('shradeIn', { duration: d, delay: d, display: 'flex' });


				LJ.delay( 2*d ).then( resolve );

        	});
        }

	});
		

	window.LJ.connecter = _.merge( window.LJ.connecter || {}, {

		online_users: [],

		init: function(){

			LJ.connecter.refreshOnlineUsers();
			LJ.connecter.handleDomEvents();
			return;

		},
		handleDomEvents: function(){

		},
		getUserStatus: function( facebook_id ){

			return LJ.connecter.online_users.indexOf( facebook_id ) == -1 ? "offline" : "online";

		},
		refreshOnlineUsers: function(){

			LJ.log('Refreshing online users...');
			var thirty_seconds = 30000;

			LJ.api.fetchOnlineUsers()
				.then(function( online_users ){

					$('.js-user-online').removeClass('--online');
					LJ.connecter.online_users = online_users;
					online_users.forEach(function( facebook_id ){

						$('.js-user-online[data-facebook-id="'+ facebook_id +'"]').addClass('--online');

					});

				})
				.then(function(){
					return LJ.delay( thirty_seconds )

				})
				.then(function(){
					return LJ.connecter.refreshOnlineUsers();

				})

		}

	});

	window.LJ.dev = _.merge( window.LJ.dev || {}, {

		n_cloudinary_api_calls: 0,
		t_login_process: 0,

		view_ids: {
			"before": "/img/ios/before.jpg",
			"chat"  : "/img/ios/chat.png",
			"chat_inview": "/img/ios/chat_inview.png",
			"request": "/img/ios/request.png"

		},
		init: function(){

			Mousetrap.bind('command+c', LJ.dev.toggleColorPalette );
			Mousetrap.bind('command+v', function(){
				LJ.dev.toggleAppView();
			});

		},
		toggleColorPalette: function(){

			if( $('.palette').length > 0 ){
				return $('.palette').toggleClass('nonei');
			}

			LJ.log('Showing color palette');
			var $div = $([
				'<div class="palette">',
					'<div class="palette__color --gentle"></div>',
					'<div class="palette__color --royal"></div>',
					'<div class="palette__color --odebo"></div>',
					'<div class="palette__color --mushia"></div>',
					'<div class="palette__color --purplepills"></div>',
					'<div class="palette__color --blueboy"></div>',
					'<div class="palette__color --pinkirl"></div>',
					'<div class="palette__color --greenected"></div>',
					'<div class="palette__color --validateen"></div>',
				'</div>'
				].join('')
			);

			$div.appendTo('body');

		},
		toggleAppView: function( view_id ){

			if( $('.ios').length > 0 ){
				return $('.ios').toggleClass('nonei');
			}

		},
		showAppView: function( view_id ){

			if( $('.ios').length > 0 ){
				$('.ios').remove();
			}

			LJ.log('Showing ios view');
	      
	        var $div = $('<div class="ios"></div>');
	        var url = LJ.dev.view_ids[ view_id ];

	        if( !url ){
	            return LJ.wlog('Couldnt find the url');
	        }

	        var img = '<img width="100%" src="' + url + '"/>';
	        $div
	            .appendTo('body')
	            .hide()
	            .append( img )
	            .show();

		},
		showAppView__Before: function(){
			return LJ.dev.showAppView('before');
		},
		showAppView__Chat: function(){
			return LJ.dev.showAppView('chat');
		},
		showAppView__ChatInview: function(){
			return LJ.dev.showAppView('chat_inview');
		},
		showAppView__Request: function(){
			return LJ.dev.showAppView('request');
		}

	});

window.LJ.facebook = _.merge( window.LJ.facebook || {}, {

	required_permissions : ['public_profile', 'email', 'user_friends', 'user_photos'],

	friends_url			 : '/me/friends',
	profile_url			 : '/me?fields=id,email,name,link,locale,gender',
	album_url  			 : '/me?fields=albums{name,id}',
	album_pictures_url   : '{{album_id}}/photos?fields=images',

	init: function(){

		LJ.facebook.startFacebookSdk();
		
	},
	startFacebookSdk: function(){

		FB.init({
			appId: window.facebook_app_id,
			xfbml: true, // parse social plugins on this page
			version: 'v2.6' 
		});

	},
	fetchFacebookToken: function(){
		return LJ.promise(function( resolve, reject ){

			LJ.log('Fetching facebook token...');
			FB.login(function( res ){

				if( res.status == 'not_authorized' ){
					return reject( Error("User didnt let Facebook access informations") )
				}

				if( res.status == 'connected' ){
					var access_token = res.authResponse.accessToken;
					LJ.login.data.access_token = access_token;

					console.log('Short lived access token : ' + access_token.substring(0,20) + '.....');
					return resolve( access_token );
				}

			}, { scope: LJ.facebook.required_permissions } );
		});

	},
	fetchMe: function(){

	},
	fetchFriends: function(){
		return LJ.promise(function( resolve, reject ){

			LJ.facebook.GraphAPI( LJ.facebook.friends_url, function( res ){

				if( res.err ){
					return reject( err );
				}

				var fb_friends  = res.data;
                var friend_ids  = _.pluck( fb_friends, 'id' );

                var data = {
                    'friend_ids' : friend_ids
                };

                resolve( data );

			});

		});
	},
	fetchFacebookProfile: function( facebook_token ){
		return LJ.promise(function( resolve, reject ){

			LJ.log('Fetching facebook profile...');
			
			FB.api( LJ.facebook.profile_url, { access_token: facebook_token }, function( facebookProfile ){
				
				// Store it for reconnexion purposes
				LJ.facebook_profile = facebookProfile;

				if( facebookProfile.error ){
					return reject( facebookProfile.error );
				} else {
					return resolve( facebookProfile );
				}
			});

		});

	},
	GraphAPI: function( url, callback, opts ){

        var s = LJ.store;

        var access_token = LJ.user.facebook_access_token || s.get("facebook_access_token") || s.get("reconn_data");

        if( !access_token || !access_token.token ){
            return LJ.wlog('Cannot call the graph api without being able to find a valid facebook token');
        }

        FB.api( url, { access_token: access_token.token }, callback );

    },
    renderPicture: function( src ){

    	return [
    				'<div class="modal__facebook-picture" data-img-src="' + src + '">',
    					'<img src="' + src + '" width="75"/>',
    					'<div class="modal__picture-icon">',
    						LJ.ui.renderIcon('check'), 
    					'</div>', 
    				'</div>'
    	].join('');

    },
    fetchPictures: function( album_id ){
    	return LJ.promise(function( resolve, reject ){

 			LJ.facebook.GraphAPI( LJ.facebook.album_pictures_url.replace( '{{album_id}}', album_id ), function( res ){
		
 				if( !res || res.error ){
 					return reject( res.error );
 				} else {
 					return resolve( res );
 				}

 			});

    	});
    },
    fetchProfilePictures: function(){

		return LJ.facebook.fetchProfilePicturesAlbumId().then( LJ.facebook.fetchPictures );

    },
	fetchProfilePicturesAlbumId: function( next_page ){
		return LJ.promise(function( resolve, reject ){

			LJ.log('Fetching facebook profile picture album id...');

			var album_url = next_page || LJ.facebook.album_url;
			var album_id  = null;

			LJ.facebook.GraphAPI( album_url, function( res ){

				if( !res.albums ){
					return reject('No album id to display');
				}

				var albums = res.albums.data;
				albums.forEach(function( album ){

					if( album.name == "Profile Pictures" ){
						album_id = album.id;
					}

				});

				if( !album_id && res.albums.paging && res.albums.paging.cursor && res.albums.paging.cursor.next ){

					var next = res.albums.paging.cursor.next;

					LJ.log('Didnt find on first page, trying with next page : ' + next );
					return LJ.facebook.fetchProfilePicturesAlbumId( next );
				}

				if( !album_id && res.albums.paging && res.albums.paging.cursor && !res.albums.paging.cursor.next ){
					return reject('Couldnt find album id, no next page to browse' );
				}

				LJ.log('Album id found, ' + album_id );
				return resolve( album_id );

			});

		});

	},
	hasPictureRightDimensions: function( image_object ){

		if( image_object.width > LJ.ui.facebook_img_min_width && image_object.width < LJ.ui.facebook_img_max_width ){
			return true;
		} else {
			return false;
		}

	},
	showFacebookPicturesInModal: function( img_place ){

		LJ.ui.showModalAndFetch({

			"type"			: "facebook",
			"title"			: LJ.text("mod_facebook_pictures_title"),
			"subtitle"		: LJ.text("mod_facebook_pictures_subtitle"),
			"footer"		: "<button class='--rounded'>" + LJ.ui.renderIcon('check') + "</button>",
			"attributes"	: [{ name: "img-place", val: img_place }],

			"fetchPromise"	: LJ.facebook.fetchProfilePictures

		})
		.then( LJ.facebook.displayFacebookPicturesInModal )
		.catch( LJ.facebook.displayFacebookPicturesInModal_Error );
			

	},
	displayFacebookPicturesInModal: function( results ){
		
		console.log('Displaying images...');
		var img_place = $('.modal').attr('data-img-place');

		var html = LJ.facebook.$profile_pictures || [];

			if( html.length == 0 ){
				results.data.forEach(function( picture_object ){
					picture_object.images.forEach(function( image_object ){
						if( LJ.facebook.hasPictureRightDimensions( image_object )){
							html.push( LJ.facebook.renderPicture( image_object.source ) );
						}
					});
				});
			}

			LJ.facebook.$profile_pictures = html;
			
			$('.modal-body')
				.append( html.join('') )	
				.find('.modal__loader')
				.velocity('bounceOut', { duration: 500, delay: 500,
					complete: function(){

						$('.modal__facebook-picture')
							   .velocity('bounceInQuick', {
							   		display: 'block'
							   });

						LJ.ui.turnToJsp('.modal-body', {
							jsp_id: 'modal_facebook_pictures'
						});

					}
				});

				

	},
	displayFacebookPicturesInModal_Error: function( err ){

		console.log( err );

		LJ.delay( 1000 ).then(function(){

			$('.modal-body')
					.append('<div class="modal__loading-error none">' + LJ.text('modal_err_empty_fetch') + '</div>')

			$('.modal__loader')
			.velocity('bounceOut', { duration: 500, delay: 500,
				complete: function(){

					$('.modal-body').find('.modal__loading-error').velocity('bounceInQuick', {
						display: 'block'
					});

				}
			});

		});


	},
	showModalSendMessageToFriends: function(){

		FB.ui({
			method: 'send',
			link: 'http://www.meefore.com'
		});

	}

});

	window.LJ.friends = _.merge( window.LJ.friends || {}, {

		friends_profiles: null,
		show_friends_duration: 600,
		init: function(){

			LJ.friends.handleDomEvents();
			return LJ.friends.fetchAndAddFacebookFriends();

		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.js-invite-friends', LJ.facebook.showModalSendMessageToFriends );
			LJ.ui.$body.on('click', '.js-show-friend', LJ.friends.handleFriendProfileClicked );
			LJ.ui.$body.on('click', '.js-close-friends-popup', LJ.friends.hideInviteFriendsPopup );

		},
		handleFriendsClicked: function(){

			var $loader = $( LJ.static.renderStaticImage('menu_loader') );

			$('.friends').html('');

			$loader.addClass('none')
				   .appendTo('.friends')
				   .velocity('bounceInQuick', {
				   	delay: 125,
				   	duration: 500,
				   	display: 'block'
				   });

			LJ.friends.fetchAndAddFacebookFriends();

		},	
		handleFriendProfileClicked: function(){

			var $s = $(this);
			var facebook_id = $s.attr('data-facebook-id');

			LJ.profile_user.showUserProfile( facebook_id );

		},
		fetchAndAddFacebookFriends: function(){

			var friend_ids = LJ.user.friends;
			return LJ.api.fetchUsers( friend_ids )

				.then(function( friends_profiles ){
					friends_profiles = _.map( friends_profiles, 'user' );
					return LJ.friends.setFriendsProfiles( friends_profiles );

				})
				.then(function( friends_profiles ){
					return LJ.friends.renderFriends( friends_profiles );

				})
				.then(function( friends_html ){
					return LJ.friends.displayFriends( friends_html );

				})
				.catch(function( e ){
					LJ.wlog(e);
				});


		}, 
		getFriendProfile: function( facebook_id ){

			return _.find( LJ.friends.getFriendsProfiles(), function( f ){
				return f.facebook_id == facebook_id;
			});

		},
		getFriendsProfiles: function( facebook_ids ){

			LJ.friends.friends_profiles = LJ.friends.friends_profiles.filter( Boolean );

			if( facebook_ids ){
				return _.filter( LJ.friends.friends_profiles, function( f ){
					return ( facebook_ids.indexOf( f.facebook_id ) != -1 );
				});

			} else {
				return LJ.friends.friends_profiles;

			}

		},
		fetchFriendsProfiles: function(){

			LJ.api.fetchMeFriends()
				.then(function( friend_ids ){
					return LJ.api.fetchUsers( friend_ids )
				})
				.then(function( friends_profiles ){
					friends_profiles = _.map( friends_profiles, 'user' );
					return LJ.friends.setFriendsProfiles( friends_profiles );
				});


		},
		setFriendsProfiles: function( friends_profiles ){

			LJ.friends.friends_profiles = friends_profiles;
			return LJ.Promise.resolve( friends_profiles );

		},
		renderFriends: function( friends_profiles ){

			var html = [];

			if( friends_profiles.length == 0 ){
				html.push( LJ.friends.renderFriendItem__Empty() );

			} else {
				friends_profiles.forEach(function( friend ){
					html.push( LJ.friends.renderFriendItem( friend ) );

				});

				html.push( LJ.friends.renderFriendItem__Last() );

			}

			return html.join('');

		},
		displayFriends: function( html ){

			var $base;
			if( $('.friends').children().length == 0 ){
				$( html )
					.hide()
					.appendTo('.friends')
					.velocity('shradeIn', {
						duration : LJ.friends.show_friends_duration,
						display  : 'flex',
						stagger  : (LJ.friends.show_friends_duration / 4)
					});

			} else {
				$('.friends')
					.children()
					.velocity('shradeOut', {
						duration : LJ.friends.show_friends_duration / 2,
						display  : 'none',
						complete : function(){
							$( html )
								.hide()
								.appendTo('.friends')
								.velocity('shradeIn', {
									duration : LJ.friends.show_friends_duration,
									display  : 'flex',
									stagger  : (LJ.friends.show_friends_duration / 4)
								});

						}
					});

			}

		},
		renderFriendItem__Empty: function(){

			return LJ.ui.render([

				'<div class="empty">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-telescope"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_friends_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_friends_subtitle"></p>',
					'</div>',
					'<div class="empty__subicon --round-icon js-invite-friends">',
						'<i class="icon icon-gift"></i>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderFriendItem: function( friend ){

			var filterlay = 'js-filterlay';
			var nonei 	  = '';

			if( !friend ){
				LJ.wlog('Trying to render undefined friend, rendering ghost user instead');
				friend = LJ.getGhostUser();
				filterlay = '';
				nonei 	  = 'nonei';
			}

			var img_html = LJ.pictures.makeImgHtml( friend.img_id, friend.img_vs, 'menu-row' );

			return LJ.ui.render([

				'<div class="friend__item js-show-friend '+ nonei +'" data-facebook-id="' + friend.facebook_id + '">',
					'<div class="row-pic">',
						'<div class="row-pic__image '+ filterlay +'">' + img_html + '</div>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + friend.name + ', <span class="row-body__age">' + friend.age + '</span></h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon">',
								'<i class="icon icon-education"></i>',
							'</div>',
							'<span>' + friend.job + '</span>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderFriendItem__Last: function(){

			return '';

			return LJ.ui.render([

				'<div class="friend__item --invite-friends js-invite-friends" >',
					'<div class="row-pic">',
						'<i class="icon icon-gift"></i>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2> ' + LJ.text('friends_title_invite') + '</h2>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderFriendsInModal: function(){

			var friends = LJ.friends.getFriendsProfiles();
 
			if( friends.length == 0 ){

				return LJ.friends.renderFriendsInModal__Empty();

			} else {

				var html = [];

				friends.forEach(function( f ){
					html.push( LJ.friends.renderFriendInModal( f ) );
				});

				return html.join('');
			}

		},
		renderFriendsInModal__Empty: function(){

			return LJ.ui.render([

				'<div class="no-friends">',
					'<span data-lid="modal_no_friends_text"></span>',
					'<button class="js-invite-friends" data-lid="modal_no_friends_btn"></button>',
				'</div>'

			].join(''));

		},
		renderFriendInModal: function( f ){

			if( !f ){
				f = LJ.getGhostUser();
			}
			
			var img_html = LJ.pictures.makeImgHtml( f.img_id, f.img_vs, 'user-modal' );

			return LJ.ui.render([

				'<div class="modal-item friend-modal" data-name="' + f.name.toLowerCase() + '" data-item-id="' + f.facebook_id + '">',
					'<div class="friend-modal__pic">',
						img_html,
						'<div class="friend-modal__icon --round-icon">',
							'<i class="icon icon-check"></i>',
						'</div>',
					'</div>',
					'<div class="friend-modal__name">',
						'<span>' + f.name + '</span>',
					'</div>',
				'</div>'

				].join(''));

		},
		displayInviteFriendsPopup: function(){

			LJ.friends.invite_popup_timer = setTimeout(function(){

				$( LJ.friends.renderInviteFriendsPopup() )
					.hide()
					.appendTo('body')
					.velocity('shradeIn', {
						duration: 400,
						display : 'flex'
					});

			}, 2500 );

		},
		hideInviteFriendsPopup: function(){

			clearTimeout( LJ.friends.invite_popup_timer );
			$('.invite-friends-popup').remove();

		},
		renderInviteFriendsPopup: function(){

			return LJ.ui.render([

				'<div class="invite-friends-popup">',
					'<div class="invite-friends-popup__close js-close-friends-popup --round-icon">',
						'<i class="icon icon-cancel"></i>',
					'</div>',
					'<div class="invite-friends-popup__icon --round-icon">',
						'<i class="icon icon-heart"></i>',
					'</div>',
					'<div class="invite-friends-popup-message">',
						'<div class="invite-friends-popup__h1">',
							'<span data-lid="invite_friends_popup_h1"></span>',
						'</div>',
						'<div class="invite-friends-popup__h2">',
							'<span data-lid="invite_friends_popup_h2"></span>',
						'</div>',
					'</div>',
					'<div class="invite-friends-popup__btn js-invite-friends">',
						'<button data-lid="invite_friends_popup_btn"></button>',
					'</div>',
				'</div>'

			].join(''));

		}

	});
	
	window.LJ = _.merge( window.LJ || {}, 

{
    settings: {
        app: {}
    },
	app_token: '',
	ui:{
		nearest_event_opacity: '.5',
		artificialDelay: 700,
		minimum_loading_time: 500,

        //Down
		slideDownInLight:  { opacity: [1, 0], translateY: [0, 10]   },
        slideDownInVeryLight:  { opacity: [1, 0], translateY: [0, 7]   },

        //Up
		slideUpOutLight: { opacity: [0, 1], translateY: [-10, 0]   },
		slideUpOutVeryLight: { opacity: [0, 1], translateY: [-7, 0]   },
        slideUpInLight: { opacity: [1, 0], translateY: [0, -10]   },
        slideUpInVeryLight: { opacity: [1, 0], translateY: [0, -7]   },

        //Left
		slideLeftInLight:  { opacity: [1, 0], translateX: [0, -10]   },
		slideLeftOutLight:  { opacity: [0, 1], translateX: [-10, 0]   },
        slideLeftInVeryLight:  { opacity: [1, 0], translateX: [0, -7]   },
        slideLeftOutVeryLight:  { opacity: [0, 1], translateX: [-7, 0]   },

        //Right
        slideRightInLight: { opacity: [1, 0], translateX: [0, 10]   },
		slideRightOutLight: { opacity: [0, 1], translateX: [10, 0]   },
        slideRightInVeryLight: { opacity: [1, 0], translateX: [0, 7]   },
        slideRightOutVeryLight: { opacity: [, 1], translateX: [7, 0]   }
	},
    event_markers: [],
    party_markers: [],
    page_default_title: "Meefore | Home",
    intro: {
        event_data: {
            "__v": 0,
            "begins_at": "2025-11-02T19:30:07.000Z",
            "timezone": 60,
            "created_at": "2015-11-02T12:18:07.000Z",
            "_id": "5637547fff83d96c44fe3aa8",
            "meta": [],
            "groups": [],
            "agerange": "20-26",
            "party": {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            },
            "address": {
                "city_name": "Paris",
                "place_name": "Rue du Bac",
                "place_id": "ChIJOQ6CxtVx5kcRd4vbzGeYf_w",
                "lng": 2.3249530000000505,
                "lat": 48.85537069999999
            },
            "type": "before",
            "status": "open",
            "hosts": [
                {
                    "main_picture": {
                        "hashtag": "meerofka",
                        "is_main": true,
                        "img_place": 1,
                        "img_version": "1445890265",
                        "img_id": "55e85819bc81dcecc1601e4d--1"
                    },
                    "channels": {
                        "me": "121428001540741",
                        "public_chan": "app"
                    },
                    "country_code": "us",
                    "mood": "happy",
                    "drink": "shots",
                    "name": "Jennifer Jenr",
                    "job": "",
                    "gender": "female",
                    "age": 18,
                    "signup_date": "2015-09-03T14:24:25.000Z",
                    "facebook_url": "https://www.facebook.com/app_scoped_user_id/121428001540741/",
                    "facebook_id": "jenn"
                },
                {
                    "main_picture": {
                        "hashtag": "classic",
                        "is_main": true,
                        "img_place": 0,
                        "img_version": "1444491565",
                        "img_id": "55e85897bc81dcecc1601e4e--0"
                    },
                    "channels": {
                        "me": "142944122715258",
                        "public_chan": "app"
                    },
                    "country_code": "fr",
                    "mood": "happy",
                    "drink": "water",
                    "name": "Kaitlin Kal",
                    "job": "",
                    "gender": "female",
                    "age": 18,
                    "signup_date": "2015-09-03T14:26:31.000Z",
                    "facebook_url": "https://www.facebook.com/app_scoped_user_id/142944122715258/",
                    "facebook_id": "kait"
                },
                {
                    "main_picture": {
                        "hashtag": "meerofka",
                        "is_main": true,
                        "img_place": 1,
                        "img_version": "1445890096",
                        "img_id": "561ec5f190a94cdc5229a0f5--1"
                    },
                    "channels": {
                        "me": "122537181435106",
                        "public_chan": "app"
                    },
                    "country_code": "fr",
                    "mood": "happy",
                    "drink": "water",
                    "name": "Ben Beaumec",
                    "job": "",
                    "gender": "male",
                    "age": 18,
                    "signup_date": "2015-10-14T21:15:29.000Z",
                    "facebook_url": "https://www.facebook.com/app_scoped_user_id/122537181435106/",
                    "facebook_id": "benb"
                },
                {
                    "main_picture": {
                        "img_id": "5622110750ccf4741d63be8f--0",
                        "img_version": "1445890920",
                        "img_place": 0,
                        "is_main": true,
                        "hashtag": "classic"
                    },
                    "channels": {
                        "me": "139625316382924",
                        "public_chan": "app"
                    },
                    "country_code": "us",
                    "mood": "happy",
                    "drink": "water",
                    "name": "David Dav",
                    "job": "",
                    "gender": "male",
                    "age": 18,
                    "signup_date": "2015-10-17T09:12:39.000Z",
                    "facebook_url": "https://www.facebook.com/app_scoped_user_id/139625316382924/",
                    "facebook_id": "will"
                }
            ]
        },
        party_data: {
            "_id": "5629550f2157aaf81eb43a2c",
            "address" : {
                "city_name" : "Paris",
                "place_name": "Bastille",
                "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                "lng": 2.369002000000023,
                "lat": 48.853082
            },
            "attendees" : "280-450",
            "begins_at" : "2014-10-22T20:00:00.923Z",
            "created_at" : "2015-10-22T21:28:47.000Z",
            "ends_at" : "2014-10-23T20:00:00.926Z",
            "hosted_by" : "OMG Nightclub",
            "link" : "http://www.bitoku.com",
            "name" : "The Gamma Party",
            "picture_url" : "http://res.cloudinary.com/radioreve/image/upload/v1445867671/lp1.jpg",
            "status" : "open",
            "timezone" : 120,
            "type" : "school"
        },
        message_data_user_1: {
            name: "Will",
            img_id: "5622110750ccf4741d63be8f--0",
            img_vs: "1445890920",
            facebook_id: "will"
        },
        message_data_user_2: {
            name: "Sandy",
            img_id: "55e85897bc81dcecc1601e4e--0",
            img_vs: "1444491565",
            facebook_id: "sandy"
        },
        events_data: [{
            _id: 'intro_1',
            party: {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            },
            address: {
                lat: 48.84726471793433,
                lng: 2.3407745361328125
            }
        }, {
            _id: 'intro_2',
            party: {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            },
            address: {
                lat: 48.84189859515306,
                lng: 2.3596572875976562
            }
        }, {
            _id: 'intro_3',
            party: {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            },
            address: {
                lat: 48.860931611800865,
                lng: 2.3534774780273438
            }
        }, {
            _id: 'intro_4',
            party: {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            }, address: {
                lat: 48.85968932107463,
                lng: 2.3886680603027344
            }
        }, {
            _id: 'intro_5',
            party: {
                "type": "anytype",
                "address": {
                    "city_name": "Earth",
                    "place_name": "Bastille",
                    "place_id": "ChIJS_r6rAFy5kcRmEpmy97_TnA",
                    "lng": 2.369002000000023,
                    "lat": 48.853082
                }
            },
            address: {
                lat: 48.84613505565775,
                lng: 2.377767562866211
            }
        }]
    },
	jsp_api: {},
	cache: {
        events : [],
        users  : []
	},
    bot_profile: {
        name        : "meebot",
        facebook_id : "1337",
        img_id      : "logo_black_on_white",
        img_version : "1438073167"

    },
	cloudinary:{
		uploadParams: { cloud_name:"radioreve", api_key:"835413516756943" },

		/* Image de l'host dans un event */
		displayParamsEventHost: { cloud_name :"radioreve", width: 80, height: 80, crop: 'fill', gravity: 'face', radius: '2' },

        /* Image des askers dans la vue event */
        displayParamsEventAsker: { cloud_name: "radioreve", width:45, height:45, crop:'fill', gravity:'face', radius:'0' },

		/* Image du user dans le header */
		displayParamsHeaderUser: { cloud_name: "radioreve",width: 50,height: 50, crop: 'fill', gravity: 'face', radius: 'max' },

		/* Image zoom lorsqu'on clique sur une photo*/
		displayParamsOverlayUser: { cloud_name: "radioreve", width: 280, height: 280, crop: 'fill', gravity: 'face', radius: 'max' },

        /* Image principale des askers dans vue managemnt */
        displayParamsAskerMain: { cloud_name: "radioreve", width:120, height:120, crop:'fill', gravity:'face', radius:3 },

		/* Image secondaire des askers dans vue management */
        displayParamsAskerThumb: { cloud_name: "radioreve", width:45, height:45, crop:'fill', gravity:'face', radius:'max' },

        /* Image secondaire des askers dans vue management, lorsqu'ils sont refus */
        displayParamsAskerThumbRefused: { cloud_name: "radioreve", width:45, height:45, crop:'fill', effect:'grayscale', gravity:'face', radius:'max' },
        
		/* Image of friends in profile view */
		profile: {
			me: {
				params: { cloud_name: "radioreve", width: 150, height: 150, crop: 'fill', gravity: 'face' }
			},
			friends: {
				params: { cloud_name: "radioreve", 'class': '', width: 65, height: 65, crop: 'fill', gravity: 'face' }
			}
		},
		events:
		{
			mapview: {
				hosts: {
					params: { cloud_name: "radioreve", 'class': 'rounded detailable', width: 42, height: 42, crop: 'fill', gravity: 'face'}
				}
			},
            sideview: {
                hosts: {
                    params: { cloud_name: "radioreve", "class": "rounded detailable", width: 35, height: 35, crop: 'fill', gravity: 'face' }
                }
            },
			preview: {
				hosts: {
					params: { cloud_name: "radioreve", 'class': 'rounded detailable', width: 62, height: 62, crop: 'fill', gravity: 'face'}
				}
			},
			group: {
				params: { cloud_name: "radioreve", 'class': 'rounded detailable', width: 40, height: 40, crop: 'fill', gravity: 'face' }
			},
			chat: {
				params: { cloud_name: "radioreve", 'class': 'rounded', width: 30, height: 30, crop: 'fill', gravity: 'face' }
			}
		},
		create: {
			friends: {
				params: { cloud_name: "radioreve", 'class': 'friend-img none rounded', width: 24, height: 24, crop: 'fill', gravity: 'face' }
			}
		},
		search: {
			user: {
				params: { cloud_name: "radioreve", 'class': 'super-centered rounded', width: 40, height: 40, crop: 'fill', gravity: 'face'}
			}
		},
		markers: {
			base: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418376/marker_dark.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418376/marker_dark_full.png'
                }
            },
            base_active: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418425/marker_pink.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418425/marker_pink_full.png'
                }
            },
            hosting: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1443787505/marker_host_dark.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1443787505/marker_host_dark_full.png'
                }
            },
            hosting_active: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1443787504/marker_host_pink.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1443787504/marker_host_pink_full.png'
                }
            },
            pending: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442431311/marker_pending_dark.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442431311/marker_pending_dark_full.png'
                }
            },
            pending_active: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442867837/marker_pending_pink.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442867837/marker_pending_pink_full.png'
                }
            },
            kicked: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442431311/marker_pending_dark.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442431311/marker_pending_dark_full.png'
                }
            },
            kicked_active: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442867837/marker_pending_pink.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442867837/marker_pending_pink_full.png'
                }
            },
            accepted: {
                open: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418560/marker_chat_dark.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418560/marker_chat_dark_full.png'
                }
            },
            accepted_active: {
                open: {
                  url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418507/marker_chat_pink.png'
                }, full: {
                    url: 'http://res.cloudinary.com/radioreve/image/upload/v1442418507/marker_chat_pink_full.png'
                }
            },
            party: {
                url: 'http://res.cloudinary.com/radioreve/image/upload/v1442436513/marker_party_dark.png'
            },
            party_active: {
                url:'http://res.cloudinary.com/radioreve/image/upload/v1442436750/marker_party_pink.png'
            }
		},
        curtain: {
        	main: {
        		params: { cloud_name: "radioreve", 'class': 'modal-main-picture etiquette', width: 300, height: 300, crop: 'fill', gravity: 'face' }
        	},
        	main_active: {
        		params: { cloud_name: "radioreve", 'class': 'modal-main-picture etiquette active', width: 300, height: 300, crop: 'fill', gravity: 'face' }
        	},
        	thumb: {
        		params: { cloud_name: "radioreve", 'class': 'modal-thumb-picture', crop: 'fill', gravity: 'face' }	
        	},
        	thumb_active: {
        		params: { cloud_name: "radioreve", 'class': 'modal-thumb-picture active', crop: 'fill', gravity: 'face' }
        	}
        },
        logo: {
        	black_on_white: {
        		id:'logo_black_on_white'
        	},
        	white_on_black: {
        		id:'logo_white_on_black'
        	}
        },
        placeholder: {
        	id: 'placeholder_picture',
        	params: { version: "1444912756", cloud_name :"radioreve", html: { 'class': 'mainPicture' }, width: 150 }
        },
    	loaders: {
    		main: {
    			id: 'main_loader',
    			params: { cloud_name :"radioreve", 'class': 'ajax-loader' }
    		},
            main_curtain: {
                id: 'main_loader_curtain',
                params: { cloud_name: "radioreve" }
            },
    		mobile: {
    			id: 'mobile_loader',
    			params: { cloud_name :"radioreve", 'class': 'ajax-loader', width: 25 }
    		},
    		bar: {
    			id: 'bar_loader',
    			params: { cloud_name :"radioreve" }
    		},
    		spinner: {
    			id: 'spinner_loader',
    			params: { cloud_name: "radioreve" }
    		},
    		curtain: {
    			id: 'curtain_loader_v4',
    			params: { cloud_name :"radioreve", 'class': 'curtain-loader super-centered', width: 20 }
    		},
            spinner_2: {
                id: 'spinner_loader_2',
                params: { cloud_name: "radioreve" }
            }
    	},
	},
	google: {
        map_center: {
            lat: 48.8566140,
            lng: 2.3522219
        },
		map: {
            style: {
                meemap: [
    {
        "featureType": "administrative",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "simplified"
            },
            {
                "hue": "#ff0000"
            },
            {
                "weight": "0.27"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "color": "#444444"
            }
        ]
    },
    {
        "featureType": "administrative.country",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "administrative.locality",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "administrative.neighborhood",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "administrative.land_parcel",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#fdfdfd"
            }
        ]
    },
    {
        "featureType": "landscape.man_made",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "hue": "#ff0000"
            }
        ]
    },
    {
        "featureType": "landscape.man_made",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "landscape.man_made",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "landscape.natural.terrain",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "landscape.natural.terrain",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "hue": "#ff0000"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.park",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "simplified"
            },
            {
                "hue": "#37ff00"
            },
            {
                "lightness": "70"
            }
        ]
    },
    {
        "featureType": "poi.school",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.school",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.sports_complex",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.sports_complex",
        "elementType": "labels.text",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "all",
        "stylers": [
            {
                "saturation": -100
            },
            {
                "lightness": 45
            },
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "labels",
        "stylers": [
            {
                "color": "#a39bb2"
            }
        ]
    },
    {
        "featureType": "road",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "hue": "#ff0000"
            },
            {
                "weight": "0.65"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "weight": "0.20"
            },
            {
                "lightness": "82"
            },
            {
                "gamma": "1.19"
            },
            {
                "saturation": "-42"
            },
            {
                "color": "#d59ca6"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "road.highway.controlled_access",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "road.highway.controlled_access",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            },
            {
                "lightness": "16"
            }
        ]
    },
    {
        "featureType": "road.highway.controlled_access",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "weight": "0.4"
            },
            {
                "color": "#dbdbdb"
            },
            {
                "lightness": "10"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "simplified"
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "transit.line",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "transit.station",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "all",
        "stylers": [
            {
                "color": "#dae7f2"
            },
            {
                "visibility": "on"
            }
        ]
    }
] 

            }
        }
	}

});
    /*
        Initialisation script
        Recursively try to initialize the Facebook pluggin
        When it's loaded, app starts.
        Follow the code...
        Lo Jacquemin, 10/03/16, 17h56
    */
    

	window.LJ = _.merge( window.LJ || {}, { 

		init: function( time ){

            $( window ).scrollTop( 0 )

            // The application only starts when the Facebook pluggin has loaded
            if( typeof FB === 'undefined' )
                return setTimeout(function(){ LJ.init( time ); }, time );
            
            // Language, Lodash & jQuery augmentations
            LJ.initAugmentations();
            // Translate the whole page based on sourcetext & data-lid attributes
            LJ.lang.init();
            // Cache static assets images used accross modules
            LJ.static.init();
            // Store mechanism (local storage / cookie)
            LJ.store.init();
            // Analytics for tracking what's going on
            LJ.analytics.init();
            // Starts the Facebook SDK
            LJ.facebook.init();
            // Basic routing functionalities to prevent user from accidentally leaving the page
            LJ.router.init();
            // Menu dom interactions
            LJ.menu.init();
            // Navigation for macro views 
            LJ.nav.init();
            // Scrolling globals etc
            LJ.ui.init();
            // Cheers
            LJ.cheers.init();
            // Shared module
            // LJ.shared.init();  // Keep it for ulterior version
            // Profile user
            LJ.profile_user.init();

            // Autologin for users who asked the "remember me" feature in their settings
            LJ.autologin.init()
                .then(  LJ.autologin.startLogin )
                .catch( LJ.autologin.startLanding )


        },
        start: function( facebook_token ){

            return LJ.Promise.resolve( facebook_token )
                .then( LJ.login.enterLoginProcess )  
                .then(function(){
                    return LJ.api.fetchAppToken( facebook_token );
                })
                .then( LJ.login.stepCompleted )
                // Enter the following step with a valid app token
                // Two kinds of data are fetch :
                // - datas that are self-related  : profile infos, pictures, friends, notifications, chats...
                // - datas that are users-related : search users module, map events...
                .then( LJ.profile.init )
                .then( LJ.login.firstSetup )
                .then( LJ.login.stepCompleted )
                .then( LJ.map.initGeocoder )
                // .then(function(){ return LJ.delayd[ lol ]})
                .then(function(){
                    var a = LJ.friends.init();
                    var b = LJ.search.init();
                    var c = LJ.realtime.init();
                    return LJ.Promise.all([ a, b, c ]);
                })
                .then( LJ.notifications.init )
                .then( LJ.before.init )
                .then( LJ.chat.init )
                .then( LJ.login.hideLoginSteps )
                .then( LJ.map.init ) // Must be as close as possible to terminateLogin. Map doesnt render sometimes..
                .then( LJ.login.terminateLoginProcess )
                .then( LJ.onboarding.init )
                // .then( LJ.connecter.init )
                .then( LJ.dev.init )

        }


	});


	
	window.LJ.invite = _.merge( window.LJ.invite || {}, {

		init: function(){
			
		}

	});

	window.LJ.ladder = _.merge( window.LJ.ladder || {}, {

		initLadder: function( options ){

			if( typeof( options ) != "object" )
				return LJ.fn.log('Param error, object needed');

			var max_level  = options.max_level,
				base_point = options.base_point,
				coef_point = options.coef_point;

			if( !max_level || !base_point || !coef_point )
				return LJ.fn.log('Param error, missing key');

			var skill_ladder = [];
			for( var i = 1; i <= max_level; i++ ){
				var item = {}
				item.level = i;
				item.min_xp = ( i * base_point ) + Math.pow( base_coef, i-1 ); 
				item.max_xp = ( i * base_point ) + Math.pow( base_coef, i   )
				skill_ladder.push( item );
			}
			return skill_ladder;

		},
		findUserLevel: function(){

			return _.find( LJ.settings.skill_ladder, function(el){ 
				return ( el.min_xp < LJ.user.skill.xp && el.max_xp > LJ.user.skill.xp ) 
			}).level

		},
		setUserXp: function( new_xp ){

			LJ.user.skill.xp = new_xp;
			$('body').trigger('change-user-xp');

		},
		updateUserXp: function(){

			var user_level = LJ.fn.findUserLevel(),
				user_xp = LJ.user.skill.xp,
				ladder_level = LJ.settings.skill_ladder[ user_level - 1 ],
				xp_range = ladder_level.max_xp - ladder_level.min_xp;

			$('.xp-amount').html( user_xp );
			$('.xp-fill').css({ width: ( user_xp - ladder_level.min_xp ) * 100 / xp_range +'%'});

		},
		fromServer: {

			// Builds a ladder system as an array of ladder items
			// Based on the range of levels necesary, the base points
			// And the coef to determine how hard it is to climb the ladder
			// Each item contains a level and a range of xp
			ladder_max_level: 30,
			ladder_base_point: 100,
			ladder_base_coef: 1.5,

			initLadder2: function initLadder( options ){ 

				var options = options || {};

				var max_level  = options.max_level  || this.ladder_max_level,
					base_point = options.base_point || this.ladder_base_point,
					base_coef  = options.base_coef  || this.ladder_base_coef;

				if( !max_level || !base_coef || !base_point )
					return console.log('Missing parameter, max_level: ' + max_level + ', base_point: ' + base_point + ', base_coef: ' + base_coef );

				var skill_ladder = [{ 
					level: 1,
					min_xp: base_point,
					max_xp: base_point + base_point * base_coef 
				}];

				for( var i = 1; i <= max_level; i++ ){

					var item = {}

					item.level = i+1;
					item.min_xp = skill_ladder[i-1].max_xp; 

					var max_xp = ( i * base_point ) + Math.floor( base_point * Math.pow( base_coef, i+1 ) ),
						max_xp_length = ( max_xp + '' ).length,
						rounder = Math.pow( 10, max_xp_length - 3 );

					item.max_xp = Math.floor( max_xp / rounder ) * rounder;

					skill_ladder.push( item );
					
				}

				return skill_ladder;

			}

		}

	});




	window.LJ.landing = _.merge( window.LJ.landing || {}, {

		activateLanding: function( landing_version ){

			var landing_html = LJ.landing.renderLanding( landing_version );
			$('.multi-landing').html( landing_html );

			LJ.login.init()
                .then( LJ.facebook.fetchFacebookToken )
                .then( LJ.start );

		},
		renderLanding: function( landing_version ){

			// Add the texts that are needed 
			LJ.textAdd( LJ.landing.texts );
			// Render the html
			var landing_object = LJ.landing[ "v" + landing_version ];

			if( !landing_object ){
				return LJ.wlog('This version of the landing page (v'+ landing_version +') doesnt exist');
			}

			return LJ.ui.render( landing_object.html.join('') );

		},
		texts: {

			"landing_browse_title": {
				"fr" :"Trouvez votre before",
				"us": "Find your pregame"
			},
			"landing_browse_subtitle": {
				"fr" :"Reprez les before qui s\'organisent prs de chez vous en parcourant la Map.",
				"us": "Spot the pregames around you by browsing the map"
			},
			"landing_cheers_title": {
				"fr" :"Un before vous intresse ?",
				"us": "Interested in a pregame ?"
			},
			"landing_cheers_subtitle": {
				"fr" :"Envois un Cheers pour montrer ton intrt",
				"us": "Send a Cheers to show our interest"
			},
			"landing_chat_title": {
				"fr" :"Faites connaissance",
				"us": "Faites connaissance"
			},
			"landing_chat_subtitle": {
				"fr" :"Discutez entre groupes dans le chat",
				"us": "Chat with the other group"
			},
			"landing_privacy": {
				"fr": [
						'En continuant, vous acceptez nos <span class="js-terms landing-bold">Conditions d\'Utilisation</span>',
						'et <span class="js-privacy landing-bold">Politique de Confidentialit.</span>',
						'Nous ne publierons <span class="landing-bold">rien</span> sur Facebook.'
					].join(''),
				"us": [
						'By continuing, you\'re agreeing to our <span class="js-terms landing-bold">Terms</span>',
						'and <span class="js-privacy landing-bold">Confidentiality.</span>',
						'Will will <span class="landing-bold">never</span> publish on Facebook.'
					].join('')
			},
			"landing_connexion_btn": {
				"fr": "Se connecter via <span class=\"landing-bold\">Facebook</span>",
				"us": "Connection with <span class=\"landing-bold\">Facebook</span>"
			},
			"landing_terms": {
				"fr": "Conditions d\'Utilisation",
				"us": "Terms"
			},
			"landing_policy": {
				"fr": "Politique de Confidentialit",
				"us": "Confidentiality"
			},
			"landing_faq": {
				"fr": "FAQ",
				"us": "FAQ"
			},
			"landing_contact" :{
				"fr": "Contact",
				"us": "Contact"
			},
			"landing_facebook_page": {
				"fr": "Page Facebook",
				"us": "Facebook page"
			}

		},
		v0: {
			name: "Blank page",
			desc: "Blank page for test purposes only",
			html: []
		},
		v2: {
			"name": "Landing Light",
			"desc": "Light theme, clear landing with phone in mid screen and almost nothing",

			"html": [
					'<div class="landing">',
					    '<div class="landing-logo --round-icon">',
					      '<span>M</span>',
					    '</div>',
					    '<div class="landing-lang">',
					      '<button class="js-changelang" data-lid="settings_ux_changelang_button"></button>',
					    '</div>',
					    '<div class="landing-body">',
					      '<div class="landing-title">',
					        '<h1 data-lid="landing_browse_title"></h1>',
					      '</div>',
					      '<div class="landing-subtitle">',
					        '<h2 data-lid="landing_browse_subtitle"></h2>',
					      '</div>',
					      '<div class="landing-screenshots">',
					        '<div class="landing__phone">',
					          '<img src="/img/iphone.png" alt=iPhone">',
					        '</div>',
					        '<div class="landing__screenshot">',
					          '<img src="/img/lp.png" alt="Find ur love" width="100%">',
					        '</div>',
					      '</div>',
					      '<div class="landing-bullets">',
					        '<div class="landing__bullet --active"></div>',
					        '<div class="landing__bullet"></div>',
					        '<div class="landing__bullet"></div>',
					        '<div class="landing__bullet"></div>',
					      '</div>',
					      '<div class="landing-privacy">',
					      	'<h3 data-lid="landing_privacy"></h3>',
					      '</div>',
					      '<div class="landing-connexion">',
					        '<button class="js-login" data-lid="landing_connexion_btn"></button>',
					      '</div>',
					    '</div>',
					    '<footer class="landing-footer">',
					      '<div class="landing-footer__item">',
					        '<span data-lid="landing_terms"></span>',
					      '</div>',
					      '<div class="landing-footer__item">',
					        '<span data-lid="landing_policy"></span>',
					      '</div>',
					       '<div class="landing-footer__item">',
					        '<span data-lid="landing_contact"></span>',
					      '</div>',
					       '<div class="landing-footer__item">',
					        '<span data-lid="landing_faq"></span>',
					      '</div>',
					       '<div class="landing-footer__item">',
					        '<span data-lid="landing_facebook_page"></span>',
					      '</div>',
					    '</footer>',
					  '</div>'
					],
				activateScreenshot: function( link ){

				}


		}

	});



LJ.text_source = _.merge( LJ.text_source || {}, {

   country_af: {
      "us": "Afghanistan",
      "fr": "Afghanistan"
   },
   country_ax: {
      "us": "land Islands",
      "fr": "land"
   },
   country_al: {
      "us": "Albania",
      "fr": "Albanie"
   },
   country_dz: {
      "us": "Algeria",
      "fr": "Algrie"
   },
   country_as: {
      "us": "American Samoa",
      "fr": "Samoa Amricaines"
   },
   country_ad: {
      "us": "Andorra",
      "fr": "Andorre"
   },
   country_ao: {
      "us": "Angola",
      "fr": "Angola"
   },
   country_ai: {
      "us": "Anguilla",
      "fr": "Anguilla"
   },
   country_aq: {
      "us": "Antarctica",
      "fr": "Antarctique"
   },
   country_ag: {
      "us": "Antigua and Barbuda",
      "fr": "Antigua-et-Barbuda"
   },
   country_ar: {
      "us": "Argentina",
      "fr": "Argentine"
   },
   country_am: {
      "us": "Armenia",
      "fr": "Armnie"
   },
   country_aw: {
      "us": "Aruba",
      "fr": "Aruba"
   },
   country_au: {
      "us": "Australia",
      "fr": "Australie"
   },
   country_at: {
      "us": "Austria",
      "fr": "Autriche"
   },
   country_az: {
      "us": "Azerbaijan",
      "fr": "Azerbadjan"
   },
   country_bs: {
      "us": "Bahamas",
      "fr": "Bahamas"
   },
   country_bh: {
      "us": "Bahrain",
      "fr": "Bahren"
   },
   country_bd: {
      "us": "Bangladesh",
      "fr": "Bangladesh"
   },
   country_bb: {
      "us": "Barbados",
      "fr": "Barbade"
   },
   country_by: {
      "us": "Belarus",
      "fr": "Bilorussie"
   },
   country_be: {
      "us": "Belgium",
      "fr": "Belgique"
   },
   country_bz: {
      "us": "Belize",
      "fr": "Blize"
   },
   country_bj: {
      "us": "Benin",
      "fr": "Bnin"
   },
   country_bm: {
      "us": "Bermuda",
      "fr": "Bermudes"
   },
   country_bt: {
      "us": "Bhutan",
      "fr": "Bhoutan"
   },
   country_bo: {
      "us": "Bolivia",
      "fr": "Bolivie"
   },
   country_ba: {
      "us": "Bosnia and Herzegovina",
      "fr": "Bosnie-Herzgovine"
   },
   country_bw: {
      "us": "Botswana",
      "fr": "Botswana"
   },
   country_bv: {
      "us": "Bouvet Island",
      "fr": "le Bouvet"
   },
   country_br: {
      "us": "Brazil",
      "fr": "Brsil"
   },
   country_io: {
      "us": "British Indian Ocean Territory",
      "fr": "Territoire britannique de l'ocan Indien"
   },
   country_bn: {
      "us": "Brunei Darussalam",
      "fr": "Brunei"
   },
   country_bg: {
      "us": "Bulgaria",
      "fr": "Bulgarie"
   },
   country_bf: {
      "us": "Burkina Faso",
      "fr": "Burkina Faso"
   },
   country_bi: {
      "us": "Burundi",
      "fr": "Burundi"
   },
   country_kh: {
      "us": "Cambodia",
      "fr": "Cambodge"
   },
   country_cm: {
      "us": "Cameroon",
      "fr": "Cameroun"
   },
   country_ca: {
      "us": "Canada",
      "fr": "Canada"
   },
   country_cv: {
      "us": "Cape Verde",
      "fr": "Cap-Vert"
   },
   country_ky: {
      "us": "Cayman Islands",
      "fr": "les Camans"
   },
   country_cf: {
      "us": "Central African Republic",
      "fr": ""
   },
   country_td: {
      "us": "Chad",
      "fr": "Tchad"
   },
   country_cl: {
      "us": "Chile",
      "fr": "Chili"
   },
   country_cn: {
      "us": "China",
      "fr": "Chine"
   },
   country_cx: {
      "us": "Christmas Island",
      "fr": "le Christmas"
   },
   country_cc: {
      "us": "Cocos (Keeling) Islands",
      "fr": "les Cocos"
   },
   country_co: {
      "us": "Colombia",
      "fr": "Colombie"
   },
   country_km: {
      "us": "Comoros",
      "fr": "Comores"
   },
   country_cg: {
      "us": "Congo",
      "fr": "Congo"
   },
   country_cd: {
      "us": "Congo, The Democratic Republic of the",
      "fr": "Congo, Rpublique Dmocratique du"
   },
   country_ck: {
      "us": "Cook Islands",
      "fr": "les Cook"
   },
   country_cr: {
      "us": "Costa Rica",
      "fr": "Costa Rica"
   },
   country_ci: {
      "us": "Ivory Coast",
      "fr": "Cte dIvoire"
   },
   country_hr: {
      "us": "Croatia",
      "fr": "Croatie"
   },
   country_cu: {
      "us": "Cuba",
      "fr": "Cuba"
   },
   country_cy: {
      "us": "Cyprus",
      "fr": "Chypre"
   },
   country_cz: {
      "us": "Czech Republic",
      "fr": "Rpublique tchque"
   },
   country_dk: {
      "us": "Denmark",
      "fr": "Danemark"
   },
   country_dj: {
      "us": "Djibouti",
      "fr": "Djibouti"
   },
   country_dm: {
      "us": "Dominica",
      "fr": "Dominique"
   },
   country_do: {
      "us": "Dominican Republic",
      "fr": "Rpublique dominicaine"
   },
   country_ec: {
      "us": "Ecuador",
      "fr": "quateur"
   },
   country_eg: {
      "us": "Egypt",
      "fr": "gypte"
   },
   country_sv: {
      "us": "El Salvador",
      "fr": "Salvador"
   },
   country_gq: {
      "us": "Equatorial Guinea",
      "fr": "Guine quatoriale"
   },
   country_er: {
      "us": "Eritrea",
      "fr": "rythre"
   },
   country_ee: {
      "us": "Estonia",
      "fr": "Estonie"
   },
   country_et: {
      "us": "Ethiopia",
      "fr": "Ethiopie"
   },
   country_fk: {
      "us": "Falkland Islands (Malvinas)",
      "fr": "les Malouines"
   },
   country_fo: {
      "us": "Faroe Islands",
      "fr": "les Fro"
   },
   country_fj: {
      "us": "Fiji",
      "fr": "Fidji"
   },
   country_fi: {
      "us": "Finland",
      "fr": "Finlande"
   },
   country_fr: {
      "us": "France",
      "fr": "France"
   },
   country_gf: {
      "us": "French Guiana",
      "fr": "Guine franaise"
   },
   country_pf: {
      "us": "French Polynesia",
      "fr": "Polynsie franaise"
   },
   country_tf: {
      "us": "French Southern Territories",
      "fr": ""
   },
   country_ga: {
      "us": "Gabon",
      "fr": "Gabon"
   },
   country_gm: {
      "us": "Gambia",
      "fr": "Gambie"
   },
   country_ge: {
      "us": "Georgia",
      "fr": "Gorgie"
   },
   country_de: {
      "us": "Germany",
      "fr": "Allemagne"
   },
   country_gh: {
      "us": "Ghana",
      "fr": "Ghana"
   },
   country_gi: {
      "us": "Gibraltar",
      "fr": "Gibraltar"
   },
   country_gr: {
      "us": "Greece",
      "fr": "Grce"
   },
   country_gl: {
      "us": "Greenland",
      "fr": "Greenland"
   },
   country_gd: {
      "us": "Grenada",
      "fr": "Grenade"
   },
   country_gp: {
      "us": "Guadeloupe",
      "fr": "Guadeloupe"
   },
   country_gu: {
      "us": "Guam",
      "fr": "Guam"
   },
   country_gt: {
      "us": "Guatemala",
      "fr": "Guatemala"
   },
   country_gg: {
      "us": "Guernsey",
      "fr": "Guernesey"
   },
   country_gn: {
      "us": "Guinea",
      "fr": "Guine"
   },
   country_gw: {
      "us": "Guinea-Bissau",
      "fr": "Guine-Bissau"
   },
   country_gy: {
      "us": "Guyana",
      "fr": "Guyane"
   },
   country_ht: {
      "us": "Haiti",
      "fr": "Hati"
   },
   country_hm: {
      "us": "Heard Island and Mcdonald Islands",
      "fr": "les Heard-et-MacDonald"
   },
   country_va: {
      "us": "Holy See (Vatican City State)",
      "fr": "Vatican"
   },
   country_hn: {
      "us": "Honduras",
      "fr": "Honduras"
   },
   country_hk: {
      "us": "Hong Kong",
      "fr": "Hong Kong"
   },
   country_hu: {
      "us": "Hungary",
      "fr": "Hongrie"
   },
   country_is: {
      "us": "Iceland",
      "fr": "Islande"
   },
   country_in: {
      "us": "India",
      "fr": "Inde"
   },
   country_id: {
      "us": "Indonesia",
      "fr": "Indonsie"
   },
   country_ir: {
      "us": "Iran",
      "fr": "Iran"
   },
   country_iq: {
      "us": "Iraq",
      "fr": "Irak"
   },
   country_ie: {
      "us": "Ireland",
      "fr": "Irlande"
   },
   country_im: {
      "us": "Isle of Man",
      "fr": "le de Man"
   },
   country_il: {
      "us": "Israel",
      "fr": "Isral"
   },
   country_it: {
      "us": "Italy",
      "fr": "Italie"
   },
   country_jm: {
      "us": "Jamaica",
      "fr": "Jamaque"
   },
   country_jp: {
      "us": "Japan",
      "fr": "Japon"
   },
   country_je: {
      "us": "Jersey",
      "fr": "Jersey"
   },
   country_jo: {
      "us": "Jordan",
      "fr": "Jordanie"
   },
   country_kz: {
      "us": "Kazakhstan",
      "fr": "Kazakhstan"
   },
   country_ke: {
      "us": "Kenya",
      "fr": "Kenya"
   },
   country_ki: {
      "us": "Kiribati",
      "fr": "Kiribati"
   },
   country_kp: {
      "us": "Korea, Democratic People's Republic of",
      "fr": "Core du Nord"
   },
   country_kr: {
      "us": "Korea, Republic of",
      "fr": "Core du Sud"
   },
   country_kw: {
      "us": "Kuwait",
      "fr": "Kowet"
   },
   country_kg: {
      "us": "Kyrgyzstan",
      "fr": "Kirghizistan"
   },
   country_la: {
      "us": "Laos",
      "fr": "Laos"
   },
   country_lv: {
      "us": "Latvia",
      "fr": "Lettonie"
   },
   country_lb: {
      "us": "Lebanon",
      "fr": "Liban"
   },
   country_ls: {
      "us": "Lesotho",
      "fr": "Lesotho"
   },
   country_lr: {
      "us": "Liberia",
      "fr": "Liberia"
   },
   country_ly: {
      "us": "Libya",
      "fr": "Libye"
   },
   country_li: {
      "us": "Liechtenstein",
      "fr": "Liechtenstein"
   },
   country_lt: {
      "us": "Lithuania",
      "fr": ""
   },
   country_lu: {
      "us": "Luxembourg",
      "fr": "Lituanie"
   },
   country_mo: {
      "us": "Macao",
      "fr": "Macao"
   },
   country_mk: {
      "us": "Macedonia",
      "fr": "Macdoine"
   },
   country_mg: {
      "us": "Madagascar",
      "fr": "Madagascar"
   },
   country_mw: {
      "us": "Malawi",
      "fr": "Malawi"
   },
   country_my: {
      "us": "Malaysia",
      "fr": "Malaisie"
   },
   country_mv: {
      "us": "Maldives",
      "fr": "Maldives"
   },
   country_ml: {
      "us": "Mali",
      "fr": "Mali"
   },
   country_mt: {
      "us": "Malta",
      "fr": "Malte"
   },
   country_mh: {
      "us": "Marshall Islands",
      "fr": "les Marshall"
   },
   country_mq: {
      "us": "Martinique",
      "fr": "Martinique"
   },
   country_mr: {
      "us": "Mauritania",
      "fr": "Mauritanie"
   },
   country_mu: {
      "us": "Mauritius",
      "fr": "Maurice"
   },
   country_yt: {
      "us": "Mayotte",
      "fr": "Mayotte"
   },
   country_mx: {
      "us": "Mexico",
      "fr": "Mexique"
   },
   country_fm: {
      "us": "Micronesia",
      "fr": "Micronsie"
   },
   country_md: {
      "us": "Moldova",
      "fr": "Moldavie"
   },
   country_mc: {
      "us": "Monaco",
      "fr": "Monaco"
   },
   country_mn: {
      "us": "Mongolia",
      "fr": "Mongolie"
   },
   country_ms: {
      "us": "Montserrat",
      "fr": "Montserrat"
   },
   country_ma: {
      "us": "Morocco",
      "fr": "Maroc"
   },
   country_mz: {
      "us": "Mozambique",
      "fr": "Mozambique"
   },
   country_mm: {
      "us": "Myanmar",
      "fr": "Myanmar"
   },
   country_na: {
      "us": "Namibia",
      "fr": "Namibie"
   },
   country_nr: {
      "us": "Nauru",
      "fr": "Nauru"
   },
   country_np: {
      "us": "Nepal",
      "fr": "Npal"
   },
   country_nl: {
      "us": "Netherlands",
      "fr": "Pays-Bas"
   },
   country_an: {
      "us": "Netherlands Antilles",
      "fr": "Antilles nerlandaises"
   },
   country_nc: {
      "us": "New Caledonia",
      "fr": "Nouvelle-Caldonie"
   },
   country_nz: {
      "us": "New Zealand",
      "fr": "Nouvelle-Zlande"
   },
   country_ni: {
      "us": "Nicaragua",
      "fr": "Nicaragua"
   },
   country_ne: {
      "us": "Niger",
      "fr": "Niger"
   },
   country_ng: {
      "us": "Nigeria",
      "fr": "Nigria"
   },
   country_nu: {
      "us": "Niue",
      "fr": "Niue"
   },
   country_nf: {
      "us": "Norfolk Island",
      "fr": "le Norfolk"
   },
   country_mp: {
      "us": "Northern Mariana Islands",
      "fr": "les Mariannes du Nord"
   },
   country_no: {
      "us": "Norway",
      "fr": "Norvge"
   },
   country_om: {
      "us": "Oman",
      "fr": "Oman"
   },
   country_pk: {
      "us": "Pakistan",
      "fr": "Pakistan"
   },
   country_pw: {
      "us": "Palau",
      "fr": "Palau"
   },
   country_ps: {
      "us": "Palestine",
      "fr": "Palestine"
   },
   country_pa: {
      "us": "Panama",
      "fr": "Panama"
   },
   country_pg: {
      "us": "Papua New Guinea",
      "fr": "Papouasie-Nouvelle-Guine"
   },
   country_py: {
      "us": "Paraguay",
      "fr": "Paraguay"
   },
   country_pe: {
      "us": "Peru",
      "fr": "Prou"
   },
   country_ph: {
      "us": "Philippines",
      "fr": "Philippines"
   },
   country_pn: {
      "us": "Pitcairn",
      "fr": "le Pitcairn"
   },
   country_pl: {
      "us": "Poland",
      "fr": "Pologne"
   },
   country_pt: {
      "us": "Portugal",
      "fr": "Portugal"
   },
   country_pr: {
      "us": "Puerto Rico",
      "fr": "Puerto Rico"
   },
   country_qa: {
      "us": "Qatar",
      "fr": "Qatar"
   },
   country_re: {
      "us": "Reunion",
      "fr": "La Runion"
   },
   country_ro: {
      "us": "Romania",
      "fr": "Roumanie"
   },
   country_ru: {
      "us": "Russia",
      "fr": "Russie"
   },
   country_rw: {
      "us": "Rwanda",
      "fr": "Rwanda"
   },
   country_sh: {
      "us": "Saint Helena",
      "fr": "Sainte-Hlne"
   },
   country_kn: {
      "us": "Saint Kitts and Nevis",
      "fr": "Saint-Christophe-et-Nivs"
   },
   country_lc: {
      "us": "Saint Lucia",
      "fr": "Sainte-Lucie"
   },
   country_pm: {
      "us": "Saint Pierre and Miquelon",
      "fr": "Saint-Pierre-et-Miquelon"
   },
   country_vc: {
      "us": "Saint Vincent and the Grenadines",
      "fr": "Saint-Vincent-et-les-Grenadines"
   },
   country_ws: {
      "us": "Samoa",
      "fr": "Samoa"
   },
   country_sm: {
      "us": "San Marino",
      "fr": "Saint-Marin"
   },
   country_st: {
      "us": "Sao Tome and Principe",
      "fr": "Sao Tom-et-Principe"
   },
   country_sa: {
      "us": "Saudi Arabia",
      "fr": "Arabie saoudite"
   },
   country_sn: {
      "us": "Senegal",
      "fr": "Sngal"
   },
   country_cs: {
      "us": "Serbia and Montenegro",
      "fr": "Serbie-et-Montngro"
   },
   country_sc: {
      "us": "Seychelles",
      "fr": "Seychelles"
   },
   country_sl: {
      "us": "Sierra Leone",
      "fr": "Sierra Leone"
   },
   country_sg: {
      "us": "Singapore",
      "fr": "Singapour"
   },
   country_sk: {
      "us": "Slovakia",
      "fr": "Slovaquie"
   },
   country_si: {
      "us": "Slovenia",
      "fr": "Slovnie"
   },
   country_sb: {
      "us": "Solomon Islands",
      "fr": "les Salomon"
   },
   country_so: {
      "us": "Somalia",
      "fr": "Somalie"
   },
   country_za: {
      "us": "South Africa",
      "fr": "Afrique du Sud"
   },
   country_gs: {
      "us": "South Georgia and the South Sandwich Islands",
      "fr": "Gorgie du Sud-et-les les Sandwich du Sud"
   },
   country_es: {
      "us": "Spain",
      "fr": "Espagne"
   },
   country_lk: {
      "us": "Sri Lanka",
      "fr": "Sri Lanka"
   },
   country_sd: {
      "us": "Sudan",
      "fr": "Soudan"
   },
   country_sr: {
      "us": "Suriname",
      "fr": "Suriname"
   },
   country_sj: {
      "us": "Svalbard and Jan Mayen",
      "fr": "le Jan Mayen"
   },
   country_sz: {
      "us": "Swaziland",
      "fr": "Swaziland"
   },
   country_se: {
      "us": "Sweden",
      "fr": "Sude"
   },
   country_ch: {
      "us": "Switzerland",
      "fr": "Suisse"
   },
   country_sy: {
      "us": "Syria",
      "fr": "Syrie"
   },
   country_tw: {
      "us": "Taiwan",
      "fr": "Tawan"
   },
   country_tj: {
      "us": "Tajikistan",
      "fr": "Tajikistan"
   },
   country_tz: {
      "us": "Tanzania",
      "fr": "Tanzanie"
   },
   country_th: {
      "us": "Thailand",
      "fr": "Thalande"
   },
   country_tl: {
      "us": "Timor-Leste",
      "fr": "Timor oriental"
   },
   country_tg: {
      "us": "Togo",
      "fr": "Togo"
   },
   country_tk: {
      "us": "Tokelau",
      "fr": "Tokelau"
   },
   country_to: {
      "us": "Tonga",
      "fr": "Tonga"
   },
   country_tt: {
      "us": "Trinidad and Tobago",
      "fr": "Trinit-et-Tobago"
   },
   country_tn: {
      "us": "Tunisia",
      "fr": "Tunisie"
   },
   country_tr: {
      "us": "Turkey",
      "fr": "Turquie"
   },
   country_tm: {
      "us": "Turkmenistan",
      "fr": "Turkmnistan"
   },
   country_tc: {
      "us": "Turks and Caicos Islands",
      "fr": "les Turques-et-Caques"
   },
   country_tv: {
      "us": "Tuvalu",
      "fr": "Tuvalu"
   },
   country_ug: {
      "us": "Uganda",
      "fr": "Ouganda"
   },
   country_ua: {
      "us": "Ukraine",
      "fr": "Ukraine"
   },
   country_ae: {
      "us": "United Arab Emirates",
      "fr": "mirats arabes unis"
   },
   country_gb: {
      "us": "United Kingdom",
      "fr": "Royaume-Uni"
   },
   country_us: {
      "us": "United States",
      "fr": "tats-Unis"
   },
   country_um: {
      "us": "United States Minor Outlying Islands",
      "fr": "les mineures loignes des tats-Unis"
   },
   country_uy: {
      "us": "Uruguay",
      "fr": "Uruguay"
   },
   country_uz: {
      "us": "Uzbekistan",
      "fr": "Ouzbkistan"
   },
   country_vu: {
      "us": "Vanuatu",
      "fr": "Vanuatu"
   },
   country_ve: {
      "us": "Venezuela",
      "fr": "Venezuela"
   },
   country_vn: {
      "us": "Viet Nam",
      "fr": "Vit Nam"
   },
   country_vg: {
      "us": "Virgin Islands, British",
      "fr": "les Vierges britanniques"
   },
   country_vi: {
      "us": "Virgin Islands, U.S.",
      "fr": "les Vierges amricaines"
   },
   country_wf: {
      "us": "Wallis and Futuna",
      "fr": "Wallis et Futuna"
   },
   country_eh: {
      "us": "Western Sahara",
      "fr": "Sahara occidental"
   },
   country_ye: {
      "us": "Yemen",
      "fr": "Ymen"
   },
   country_zm: {
      "us": "Zambia",
      "fr": "Zambie"
   },
   country_zw: {
      "us": "Zimbabwe",
      "fr": " Zimbabw"
   }
});




	window.LJ.lang = _.merge( window.LJ.lang || {}, {

		'supported_languages': ['fr','us'],

		init: function(){

			LJ.Promise.resolve()
				   .then( LJ.lang.findAppLang )
				   .then( LJ.lang.setAppLang )
				   .then( LJ.lang.translateApp )
				   .then( LJ.lang.handleDomEvents )

		},
		handleDomEvents: function(){

			$('body').on('click', '.js-changelang', LJ.lang.changeAppLang );

		},
		sayCheers: function(){

			return "Cheers";

			// Legacy
			return _.shuffle([

				'Sant',
				'Saluti',
				'Cheers',
				'Skl',
				'Na zdrowie',
				'Noroc',
				'Salud',
				'Chok dee',
				'Kanpai',
				'Prost',
				'Kippis'

			])[0] + ' !';

		},
		getAppLang: function(){

			return LJ.lang.app_language;

		},
		setAppLang: function( app_language ){
			return LJ.promise(function( resolve, reject ){

				if( !LJ.lang.isLangSupported( app_language ) ){
					return console.error('This language (' + app_language + ') is not currently supported');
				}
					

				// Internal state variable
				LJ.lang.app_language = app_language;

				// Dom update
				$('.app-lang').find('i').removeClass('--active');
				$('.app-lang').find('[data-cc="' + app_language + '"]').addClass('--active');

				// Local storage update
				LJ.store.set('app_language', app_language )
				

				return resolve();
			});

		},
		findAppLang: function(){
			return LJ.promise(function( resolve, reject ){

				var app_language;

				if( LJ.store.get("app_language") ){
					app_language = LJ.store.get('app_language');
				} else {
					app_language = "us";
				}

				return resolve( app_language );		

			});

		},
		isLangSupported: function( app_language ){

			return LJ.lang.supported_languages.indexOf( app_language ) == -1 ? false : true;

		},
		translateApp: function(){

			LJ.lang.translate('body');

		},	
		translate: function( container, options ){

			options = options || {};
			
			app_language = options.app_language || LJ.lang.getAppLang();

			if( ! LJ.lang.isLangSupported( app_language ) ){
				return LJ.elog('This language (' + app_language + ') is not currently supported');
			}
			
			var $container = container instanceof jQuery ? container : $(container);

			$container.find('[data-lid]').each(function( i, el ){
				
				var $el  = $(el);
				var type = $el.prop('nodeName').toLowerCase();
				var lid  = $el.attr('data-lid');
				var lpm  = $el.attr('data-lpm') && $el.attr('data-lpm');
				var lpmt = $el.attr('data-lpmt') && $el.attr('data-lpmt');

				var text_object = LJ.text_source[ lid ];
				if( !text_object ){
					return LJ.elog('Cannot find the lang object for lid : ' + lid );
				}

				var translated_text = LJ.text_source[ lid ][ app_language ];

				if( typeof translated_text == "function" ){
					if( lpmt == "array" ){
						lpm = lpm.split(',');
					}
					translated_text = translated_text( lpm );

				}

				if( /placeholder/i.test( lid ) ){
					$el.attr('placeholder', translated_text );
					
					if( $('#searchbar').find('input').length > 1 ){
						$('#searchbar').find('input').first().attr('placeholder', null);
					}
					return;
				}

				$el.html( translated_text );

			});

		},
		changeAppLang: function(){

			LJ.ui.showModalAndFetch({

			"type"			: "changelang",
			"title"			: LJ.text("mod_change_lang_title"),
			"subtitle"		: LJ.text("mod_change_lang_subtitle"),
			"no_footer"     : true,

			"fetchPromise"	: LJ.lang.fetchSupportedLanguages

		})
		.then( LJ.lang.displayChangeLangInModal )

		},
		fetchSupportedLanguages: function(){

			return LJ.delay( 300 ).then(function(){
				return ["fr","us"];
			});

		},
		displayChangeLangInModal: function( result ){

			var html = LJ.lang.renderChangeAppLang( result );

			$( html ).hide().appendTo( $('.modal-body') );

			$('.modal-body')
				.find('.modal__loader')
				.velocity('bounceOut', { duration: 500, delay: 100,
					complete: function(){

						$('.change-lang')
						   .velocity('shradeIn', {
						   		display: 'flex',
						   		duration: 500
						   })
						   .find('[data-cc="' + LJ.lang.getAppLang() + '"]').addClass('--active');

						$('.change-lang__choice:not(.--unavailable)').click(function(){

							var new_language = $( this ).attr('data-cc');

							LJ.lang.setAppLang( new_language );
							LJ.lang.translateApp();

							$('.modal__close').click();

							LJ.delay( 500 ).then(function(){
								LJ.ui.showToast( LJ.text('t_language_changed') );
							});

						});	


					}
				});


		},
		changeAppLang2: function(){

			var duration = 550;
			LJ.ui.showModal({
				duration: duration,


			})
			.then(function( $curtain ){
				return LJ.promise(function( resolve, reject ){

					$curtain
						.html( LJ.lang.renderChangeAppLang() )
						.find('[data-cc="' + LJ.lang.getAppLang() + '"]').addClass('--active');

					$curtain
						.children()
						.velocity('fadeIn', {
							duration: duration,
							display: 'flex',
							complete: resolve
						});
				});
			})
			.then(function(){
				return LJ.promise(function( resolve, reject ){

					$('.change-lang__choice:not(.--unavailable)').click(function(){

						var new_language = $(this).attr('data-cc');
						if( ! LJ.lang.isLangSupported( new_language ) ){
							return reject('This language (' + new_language + ') is not currently supported');
						}
						resolve( new_language );

					});	
				});
			})
			.then(function( app_language ){

				$('.change-lang').velocity('bounceOut', {
					duration: duration
				});

				LJ.delay( duration/1.5 ).then(function(){

					LJ.lang.setAppLang( app_language );
					LJ.lang.translateApp();
					LJ.ui.showToast( LJ.text('t_language_changed') );

				});
				
				LJ.ui.hideCurtain({
					duration: duration, delay: duration/2,
				}).then(function(){
				});


			}, function( err ){

				LJ.wlog( err );
				LJ.ui.hideCurtain({ duration: duration });

			});

		},
		renderChangeAppLang: function( languages ){

			var choices = [];
			languages.forEach(function( cc ){
				choices.push([

						'<div class="change-lang__choice" data-cc="'+ cc +'">',
							'<i class="flag-icon flag-icon-'+ cc +'"></i>',
						'</div>'

					].join(''));
			});

			return LJ.ui.render([

				'<div class="change-lang">',
					'<div class="change-lang-available">',
						choices.join(''),
						'<div class="change-lang__choice --unavailable" data-cc="es">',
							'<i class="flag-icon flag-icon-es"></i>',
							'<div class="soon" data-lid="lang_soon">Prochanement</div>',
						'</div>',
						'<div class="modal__close nonei"></div>',
					'</div>',
				'</div>'

				].join(''));

		}

	});


	
	LJ.text = function( text_id, param ){
		var app_lang = LJ.lang.getAppLang();
		var text_src = LJ.text_source[ text_id ];

		if( !text_src ){
			return LJ.wlog('Error, couldnt find text source for text_id : ' + text_id );
		} else {
			if( typeof text_src[ app_lang ] == "function" ){
				return text_src[ app_lang ]( param );
			} else {
				return text_src[ app_lang ];
			}
		}
	};

	LJ.textAdd = function( new_text_source ){

		LJ.text_source = _.merge( LJ.text_source || {}, new_text_source );
	}

	LJ.text_source = _.merge( LJ.text_source || {}, {

		page_title: {
			"fr": "Des rencontres avant d'aller en soire",
			"us": "Meet new people before going out"
		},
		pikaday: {
			"us": {
                previousMonth : 'Previous Month',
                nextMonth     : 'Next Month',
                months        : ['January','February','March','April','May','June','July','August','September','October','November','December'],
                weekdays      : ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
                weekdaysShort : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']
            },
            "fr": {
            	previousMonth : 'Mois Prcdant',
                nextMonth     : 'Mois Suivant',
                months        : ['Janvier','Fvrier','Mars','Avril','Mai','Juin','Juillet','Aot','Septembre','Octobre','Novembre','Dcembre'],
                weekdays      : ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'],
                weekdaysShort : ['Dim','Lun','Ma','Me','Jeu','Ven','Sam']
            }
		},
		day: {
			"fr": [ "Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi" ],
			"us": [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ]
		},
		month: {
			"fr": ['Janvier','Fvrier','Mars','Avril','Mai','Juin','Juillet','Aot','Septembre','Octobre','Novembre','Dcembre'],
			"us": ['January','February','March','April','May','June','July','August','September','October','November','December']
		},
		h_sec_ago: {
			"fr": " l'instant !",
			"us": "just now !"
		},
		h_min_ago: {
			"fr": "il y a quelques minutes",
			"us": "a few minuts ago"
		},
		h_hour_ago: {
			"fr": "il y a moins d'une heure",
			"us": "less than an hour ago"
		},
		today: {
			"fr": "Aujourd'hui",
			"us": "Today"
		},
		tomorrow: {
			"fr": "Demain",
			"us": "Tomorrow"
		},
		yesterday: {
			"fr": "Hier",
			"us": "Yesterday"
		},
		before_date_hour: {
			"fr": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			},
			"us": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			}
		},
		chatrow_date_hour: {
			"fr": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			},
			"us": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			}
		},
		chatinview_date_hour: {
			"fr": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			},
			"us": function( m ){
				return [ m.format('HH'), m.format('mm') ].join(':');
			}
		},
		before_date_day: {
			"fr": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return LJ.text_source['today']["fr"];
				}

				if( m.dayOfYear() == moment().dayOfYear() + 1 || ( moment().dayOfYear() + 1 == 1 ) ){
					return LJ.text_source['tomorrow']["fr"];
				}

				var d = LJ.text_source['day']['fr'][ m.day() ];
				var n = m.format('DD').replace(/^0/,'');
				var m = LJ.text_source['month']['fr'][ m.month() ].toLowerCase();

				return [ d, n, m ].join(' ');
			},
			"us": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return LJ.text_source['today']["us"];
				}

				if(  m.dayOfYear() == moment().dayOfYear() + 1 || ( moment().dayOfYear() + 1 == 1 ) ){
					return LJ.text_source['tomorrow']["us"];
				}

				var d = LJ.text_source['day']['us'][ m.day() ];
				var n = m.format('DD').replace(/^0/,'');
				var m = LJ.text_source['month']['us'][ m.month() ];

				m = m[0].toUpperCase() + m.slice(1); // english style

				return [ d, n, m ].join(' ');
			}
		},
		chatrow_date_day: {
			"fr": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return '';
				}

				if(  m.dayOfYear() == moment().dayOfYear() - 1 || ( moment().dayOfYear() - 1 == 365 ) ){
					return LJ.text_source['yesterday']["fr"].toLowerCase() + ', ';
				}

				var n = m.format('DD').replace(/^0/,'');
				var m = LJ.text_source['month']['fr'][ m.month() ].toLowerCase();

				return [ n, m ].join(' ') + ', ';
			},
			"us": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return '';
				}

				if(  m.dayOfYear() == moment().dayOfYear() + 1 || ( moment().dayOfYear() + 1 == 1 ) ){
					return LJ.text_source['yesterday']["us"].toLowerCase() + ', ';
				}

				var n = m.format('DD').replace(/^0/,'');
				var m = LJ.text_source['month']['us'][ m.month() ];

				m = m[0].toUpperCase() + m.slice(1); // english style

				return [ n, m ].join(' ') + ', ';
			}
		},
		chatinview_date_day: {
			"fr": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return LJ.text_source['today']["fr"];
				}

				if( m.dayOfYear() == moment().dayOfYear() + 1 || ( moment().dayOfYear() + 1 == 1 ) ){
					return LJ.text_source['tomorrow']["fr"];
				}

				var d = LJ.text_source['day']['fr'][ m.day() ];
				var n = m.format('DD').replace(/^0/,'');
				var m = m.format('MM');

				return [ d, [ n, m ].join('/') ].join(' ');
			},
			"us": function( m ){

				if( m.dayOfYear() == moment().dayOfYear() ){
					return LJ.text_source['today']["us"];
				}

				if(  m.dayOfYear() == moment().dayOfYear() + 1 || ( moment().dayOfYear() + 1 == 1 ) ){
					return LJ.text_source['tomorrow']["us"];
				}

				var d = LJ.text_source['day']['fr'][ m.day() ];
				var n = m.format('DD').replace(/^0/,'');
				var m = m.format('MM');

				return [ d, [ n, m ].join('/') ].join(' ');

			}
		},
		before_date: {
			"fr": function( m ){

				var day  = LJ.text_source["before_date_day"]["fr"]( m );
				var hour = LJ.text_source["before_date_hour"]["fr"]( m );

				return [ day, hour ].join(', ');

			},
			"us": function( m ){

				var day  = LJ.text_source["before_date_day"]["us"]( m );
				var hour = LJ.text_source["before_date_hour"]["us"]( m );

				return [ day, hour ].join(', ');

			}
		},
		chatrow_date: {
			"fr": function( m ){

				var day  = LJ.text_source["chatrow_date_day"]["fr"]( m );
				var hour = LJ.text_source["chatrow_date_hour"]["fr"]( m );

				return [ day, hour ].join('');

			},
			"us": function( m ){

				var day  = LJ.text_source["chatrow_date_day"]["us"]( m );
				var hour = LJ.text_source["chatrow_date_hour"]["us"]( m );

				return [ day, hour ].join('');

			}
		},
		chatinview_date: {
			"fr": function( m ){

				var day  = LJ.text_source["chatinview_date_day"]["fr"]( m );
				var hour = LJ.text_source["chatinview_date_hour"]["fr"]( m );

				return [ day, hour ].join(', ');

			},
			"us": function( m ){

				var day  = LJ.text_source["chatinview_date_day"]["us"]( m );
				var hour = LJ.text_source["chatinview_date_hour"]["us"]( m );

				return [ day, hour ].join('');

			}
		},
		menurow_date: {
			"fr": function( m ){ return LJ.text_source.before_date["fr"]( m ); },
			"us": function( m ){ return LJ.text_source.before_date["us"]( m ); }
		},
		h_today: {
			"fr": "aujourd'hui,  %hh%m",
			"us": "today, %hh%m"
		},
		h_past: {
			"fr": "Le %moment,  %hh%m",
			"us": "%moment, %hh%m"
		},
		t_language_changed: {
			"fr": "La langue a t change",
			"us": "The language has been changed"
		},
		lang_change_title: {
			"fr": "Changer de langue",
			"us": "Change language"
		},
		lang_change_subtitle: {
			"fr": "La langue ne devrait jamais tre une barrire pour sortir faire la fte.",
			"us": "Language should never get in the way of partying. Ever."
		},
		lang_soon: {
			"fr": "Prochainement",
			"us": "Soon"
		},
		lang_before: {
			"fr": "before",
			"us": "pregame"
		},
		lang_profile: {
			"fr": "profil",
			"us": "profile"
		},
		menu_profile: {
			"fr": "Profil",
			"us": "Profile"
		},
		menu_subsection_pictures: {
			"fr": "Mes 5 photos",
			"us": "My 5 photos"
		},
		menu_subsection_informations: {
			"fr": "A propos de moi",
			"us": "About me"
		},
		menu_subsection_account: {
			"fr": "Paramtres du compte",
			"us": "Account settings"
		},
		menu_subsection_code: {
			"fr": "Code d'invitation",
			"us": "Invite code"
		},
		menu_subsection_notifications: {
			"fr": "Notifications",
			"us": "Notifications"
		},
		menu_subsection_emails: {
			"fr": "Emails",
			"us": "Emails"
		},
		menu_subsection_ux: {
			"fr": "Exprience d'utilisation",
			"us": "User experience"
		},
		menu_shared: {
			"fr": "Partags",
			"us": "Shared"
		},
		menu_cheers: {
			"fr": "Cheers",
			"us": "Cheers"
		},
		menu_friends: {
			"fr": "Mes amis",
			"us": "Friends"
		},
		menu_invite: {
			"fr": "Inviter des amis",
			"us": "Invite"
		},
		menu_settings: {
			"fr": "Prfrences",
			"us": "Settings"
		},
		p_name_label: {
			"fr": "Nom",
			"us": "Name"
		},
		p_name_placeholder: {
			"fr": "Prad Bitt",
			"us": "Prad Bitt"
		},
		p_age_placeholder: {
			"fr": "18",
			"us": "18"
		},
		p_job_placeholder: {
			"fr": "Etudiant",
			"us": "Student"
		},
		p_ideal_night_placeholder: {
			"fr": "Les amis, les soires, les rencontres...",
			"us": "Friends, parties, new people..."
		},
		p_age_label: {
			"fr": "ge",
			"us": "Age"
		},
		p_country_label: {
			"fr": "Pays",
			"us": "Country"
		},
		p_job_label: {
			"fr": "Situation",
			"us": "Occupation"
		},
		p_location_label: {
			"fr": "Ville actuelle",
			"us": "Current city"
		},
		p_ideal_night_label: {
			"fr": "Ma soire idale",
			"us": "My dream night"
		},
		p_name_explanation: {
			"fr": "Pseudonyme par lequel les autres membres vous appelerons. Choose wisely.",
			"us": "Pseudo everyone will call you as. Choose wisely."
		},
		p_age_explanation: {
			"fr": "On vite de mentir ;-)",
			"us": "Please don't lie ;-)"
		},
		p_country_explanation: {
			"fr": "Votre nationalit est celle indique sur Facebook. En cas d'erreur, envoyez-nous un mail.",
			"us": "Your nationality is the one indicated on Facebook. If there is a mistake, please email us."
		},
		p_job_explanation: {
			"fr": "Concrtement, vous faites quoi dans la vie ?",
			"us": "So, how do you keep busy everyday ?"
		},
		p_location_explanation: {
			"fr": "O sortez-vous en ce moment ? Meefore works everywhere",
			"us": "Where do you get out these days ? Meefore works everywhere"
		},
		p_ideal_night_explanation: {
			"fr": "Sans alcool, la fte est plus...",
			"us": "Knock yourself out"
		},
		p_friends_title: {
			"fr": "Mes amis Facebook",
			"us": "Everybody is on Meefore"
		},
		p_friends_subtitle: {
			"fr": "Vos amis Facebook sont tous sur Meefore. Il en manque? Invitez-les  vous rejoindre!",
			"us": "All your Facebook friends are on Meefore. Are some of them missing? Invite them to join!"
		},
		p_friends_nofriends: {
			"fr": "Vous n'avez aucun ami Facebook inscrit sur Meefore. Invitez-les pour commencer  participer  des meefore!",
			"us": "You don't have any Facebook friends on Meefore. Invite them all to start taking part in meefore!"
		},
		p_button_validate: {
			"fr": "Valider",
			"us": "OK"
		},
		p_button_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		p_picture_upload_success: {
			"fr": "Votre photo a t mise  jour",
			"us": "Your photo has been uploaded"
		},
		p_picture_upload_error: {
			"fr": "Une erreur s'est produite lors de l'envoie de la photo",
			"us": "An error occured during the upload, please try again later"
		},
		p_facebook_upload_title: {
			"fr": "Vos photos de profil Facebook",
			"us": "Your Facebook profile pictures"
		},
		h_search_placeholder: {
			"fr": "Rechercher quelqu'un",
			"us": "Looking for someone?"
		},
		search_title: {
			"fr": "Tous les membres",
			"us": "All our members"
		},
		h_logout: {
			"fr": "Se dconnecter",
			"us": "Log out"
		},
		e_title: {
			"fr": "Tous les meefore",
			"us": "Get the party started"
		},
		e_subtitle: {
			"fr": "L'abus de soires est bon pour la sant",
			"us": "Non-stop partying is actually healthy"
		},
		e_create_button: {
			"fr": "Proposer un meefore",
			"us": "Create a meefore"
		},
		e_create_title: {
			"fr": "Proposer un meefore",
			"us": "Create a meefore"
		},
		e_create_hosts: {
			"fr": "Organisateurs",
			"us": "Hosts"
		},
		e_create_hosts_placeholder: {
			"fr": "Slectionnez parmi vos amis (1 minimum)",
			"us": "Select among your friends (1 minimum)"
		},
		e_create_begins_at: {
			"fr": "Date du before",
			"us": "Before date"
		},
		e_create_begins_at_placeholder: {
			"fr": "Quel jour? ",
			"us": "Which day?"
		},
		e_create_hour: {
			"fr": "Heure du Before",
			"us": "Before hour"
		},
		e_create_hour_placeholder: {
			"fr": "Quelle heure?",
			"us": "What time?"
		},
		e_create_address: {
			"fr": "Lieu du before",
			"us": "Location"
		},
		e_create_address_placeholder: {
			"fr": "O vous rejoignez-vous?",
			"us": "Where will you meet?"
		},
		e_create_party: {
			"fr": "Lieu de la soire",
			"us": "Party location"
		},
		e_create_party_placeholder: {
			"fr": "O allez-vous ensuite?",
			"us": "Where are you going next?"
		},
		e_create_agerange: {
			"fr": "ge souhait",
			"us": "Age preference"
		},
		e_create_ambiance: {
			"fr": "Ambiance",
			"us": "Ambiance"
		},
		e_create_ambiance_placeholder: {
			"fr": "#hashtagTonMeefore",
			"us": "#hashtagYourMeefore"
		},
		e_create_guests_type: {
			"fr": "Type d'invits",
			"us": "Guests type"
		},
		e_create_button_validate: {
			"fr": "Crer un meefore",
			"us": "Create a meefore"
		},
		e_create_button_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		e_create_loading_text: {
			"fr": "Votre meefore a t cr avec succs ! ",
			"us": "Your meefore has been successully created !"
		},
		e_request_title: {
			"fr": "Demande de participation",
			"us": "Participation request"
		},
		e_request_button_validate: {
			"fr": "Rejoindre ce meefore",
			"us": "Join this meefore"
		},
		e_request_group_name: {
			"fr": "Nom de ton groupe",
			"us": "Your group name"
		},
		e_request_group_members: {
			"fr": "Membres de ton groupe",
			"us": "Members of your group"
		},
		e_request_group_message: {
			"fr": "Message",
			"us": "Message"
		},
		e_request_group_name_placeholder: {
			"fr": "Ce nom apparatra dans le chat",
			"us": "This name will be displayed in the chat"
		},
		e_request_group_members_placeholder: {
			"fr": "Choisissez les personnes avec qui vous souhaitez sortir",
			"us": "Choose the people you wanna go out with"
		},
		e_request_group_message_placeholder: {
			"fr": "Dites-nous en plus  propos de votre groupe",
			"us": "Tell us more about your group"
		},
		e_request_button_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		e_request_event_got_canceled: {
			"fr": "Le meefore vient d'tre annul :/",
			"us": "The meefore just got canceled :/"
		},
		e_preview_participate: {
			"fr": "Participer",
			"us": "Participate"
		},
		e_preview_manage: {
			"fr": "Organiser",
			"us": "Organize"
		},
		e_mapview_first_to_create: {
			"fr": "Proposer un meefore",
			"us": "Create a meefore"
		},
		e_preview_chat: {
			"fr": "Discuter",
			"us": "Chat"
		},
		e_preview_pending: {
			"fr": "En attente",
			"us": "Pending"
		},
		e_filters_location: {
			"fr": "Changer d'endroit",
			"us": "Change location"
		},
		e_filters_date: {
			"fr": "Date(s)",
			"us": "Date(s)"
		},
		e_create_party_button: {
			"fr": "Soire partenaire",
			"us": "Partner event"
		},
		e_mapview_empty_text: {
			"fr": "Aucun meefore de prvu",
			"us": "No meefore is scheduled"
		},
		e_sideview_empty_text: {
			"fr": "Aucun meefore de prvu ce jour-ci. Essayez un autre jour ou soyez le premier  en proposer un.",
			"us": "No meefore is scheduled for this day. Try another day or be the first to create one."
		},
		p_sideview_default_text: {
			"fr": "Slectionner une soire sur la carte pour voir plus de dtails",
			"us": "Select a party on the map to display more details"
		},
		p_sideview_header: {
			"fr": "La o est l'ambiance",
			"us": "Where the fun is"
		},
		e_sideview_header: {
			"fr": "Ils vont y aller",
			"us": "They are going"
		},
		e_preview_planned: {
			"fr": "%n meefore  venir",
			"us": "%n meefore are planned"
		},
		s_title: {
			"fr": "Prfrences",
			"us": "Preferences"
		},
		s_app_title: {
			"fr": "Application",
			"us": "In app"
		},
		s_app_subtitle: {
			"fr": "Modifier le comportement gnral de l'application",
			"us": "Modify the general behavior of the app"
		},
		s_contact_title: {
			"fr": "Informations de contact",
			"us": "Contact information"
		},
		s_contact_subtitle: {
			"fr": "Restez inform",
			"us": "Stay in touch'"
		},
		s_contact_email_label: {
			"fr": "Email de contact",
			"us": "Contact email"
		},
		s_contact_email_desc: {
			"fr": "Indiquez-nous l'email sur lequel vous souhaitez tre contact",
			"us": "Let us know at what email address we can reach you"
		},
		s_autologin_label: {
			"fr": "Connexion automatique",
			"us": "AutoLogin"
		},
		s_autologin_desc: {
			"fr": "Activez cette option pour accder directement  Meefore sans passer par la page d'accueil",
			"us": "Activate this option to reach directly Meefore and skip the landing page"
		},
		s_message_seen_by_label: {
			"fr": "Connexion automatique",
			"us": "AutoLogin"
		},
		s_message_seen_by_desc: {
			"fr": "Activez cette option pour accder directement  Meefore sans passer par la page d'accueil",
			"us": "Activate this option to reach directly Meefore and skip the landing page"
		},
		s_news_title: {
			"fr": "Newsletter et Invitations",
			"us": "Newsletter and Invitations"
		},
		s_news_subtitle: {
			"fr": "Recevez nos emails concernant soires, bons plans et rencontres.",
			"us": "Receive our emails that deal with parties, opportunities and meetups."
		},
		s_newsletter_label: {
			"fr": "Newsletter",
			"us": "Newsletter"
		},
		s_newsletter_desc: {
			"fr": "Notre newsletter est envoye chaque semaine",
			"us": "Our newsletter is sent every week"
		},
		s_invits_label: {
			"fr": "Invitations",
			"us": "Invitations"
		},
		s_invits_desc: {
			"fr": "Bons plans pour tre invit  des soires exclusives",
			"us": "Get invited to exclusive parties"
		},
		s_alerts_title: {
			"fr": "Alertes et notifications",
			"us": "Alerts and notifications"
		},
		s_alerts_subtitle: {
			"fr": "Soyez alert ds que de l'activit vous concernant se prsente",
			"us": "Be informed when anything about you happens"
		},
		s_accepted_in_label: {
			"fr": "Accept dans un meefore",
			"us": "Accepted in a meefore"
		},
		s_accepted_in_desc: {
			"fr": "Recevez un email ds que vous tes accept dans un meefore",
			"us": "Receive an email when you are accepted in a meefore"
		},
		s_new_message_received_label: {
			"fr": "Message reu hors-ligne",
			"us": "Unread message"
		},
		s_new_message_received_desc: {
			"fr": "Recevez un email ds que vous tes hors-ligne et que vous recevez un nouveau message",
			"us": "Receive an email when you're offline and someone sends you a new message"
		},
		s_message_seen_by_label: {
			"fr": "Signaler message lu",
			"us": "Signal message read"
		},
		s_message_seen_by_desc: {
			"fr": "Signalez automatiquement aux autres utilisateurs que vous avez vu leur message",
			"us": "Signal to other users that you have read their message"
		},
		s_min_frequency_label: {
			"fr": "Temps entre chaque email",
			"us": "Time lapse between each emails"
		},
		s_min_frequency_desc: {
			"fr": "Pour viter d'tre spamm par l'application",
			"us": "To avoid any spam by the app"
		},
		s_0min: {
			"fr": "Aucune limite",
			"us": "No limit"
		},
		s_15min: {
			"fr": "15min",
			"us": "15min"
		},
		s_60min: {
			"fr": "1h",
			"us": "1h"
		},
		s_360min: {
			"fr": "6h",
			"us": "6h"
		},
		s_720min: {
			"fr": "12h",
			"us": "12h"
		},
		s_1440min: {
			"fr": "24h",
			"us": "24h"
		},
		s_yes: {
			"fr": "Oui",
			"us": "Yes"
		},
		s_no: {
			"fr": "Non",
			"us": "No"
		},
		s_delete_goodbye: {
			"fr": "Votre compte a bien t supprim",
			"us": "Your account has been deleted"
		},
		s_delete_title: {
			"fr": "Supprimer mon profil",
			"us": "Delete my profile"
		},
		s_delete_text: {
			"fr": "Toutes les donnes vous concernant seront supprimes",
			"us": "All your data will be deleted"
		},
		s_delete_validate: {
			"fr": "Supprimer",
			"us": "Delete"
		},
		s_delete_profile_btn: {
			"fr": "Supprimer mon profil",
			"us": "Delete my profile"
		},
		s_delete_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		ch_hosts: {
			"fr": "Organisateurs",
			"us": "Hosts"
		},
		ch_placeholder: {
			"fr": "Message...",
			"us": "Message..."
		},
		ch_button_update: {
			"fr": "Mettre  jour",
			"us": "Update"
		},
		ch_button_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		ch_settings_status_label: {
			"fr": "Statut du meefore",
			"us": "Meefore status"
		},
		ch_settings_status_open: {
			"fr": "Ouvert",
			"us": "Opened"
		},
		ch_settings_status_suspended: {
			"fr": "Suspendu/Complet",
			"us": "Suspended/Full"
		},
		ch_settings_status_canceled: {
			"fr": "Supprim",
			"us": "Removed"
		},
		ch_bot_msg_group_pending: {
			"fr": "Votre groupe a t suspendu de la discussion",
			"us": "Your group has been suspended from the discussion"
		},
		ch_bot_msg_group_accepted: {
			"fr": "Votre groupe vient d'tre accept dans la discussion!",
			"us": "Your group just got accepted in the discussion"
		},
		ch_first_msg_host_channel: {
			"fr": "Votre meefore a t cr avec succs. <br> Ce chat est priv entre vous et les autres organisateurs.",
			"us": "Your meefore has been successully created. <br> This chat is dedicated to you and the other hosts."
		},
		ch_first_msg_host: {
			"fr": "  a demand  rejoindre votre meefore : ",
			"us": "  has asked to join your meefore : "
		},
		ch_first_msg_group: {
			"fr": "Votre demande a bien t envoye. <br> Ds que l'un des organisateurs vous aura accept, vous aurez accs  la discussion.",
			"us": "Your request has been sent. <br> As soon as one of the hosts has approved your request, you'll have access to the chat."
		},
		ch_request_validate: {
			"fr": "Accepter ce groupe",
			"us": "Chat with this group"
		},
		ch_button_send: {
			"fr": "Envoyer",
			"us": "Send"
		},
		ch_button_whisper: {
			"fr": "Chuchoter",
			"us": "Whisper"
		},
		to_invite_code_already_taken: {
			"fr": "Ce code est dj utilis par un autre utilisateur",
			"us": "This code is already used by another user"
		},
		to_invite_code_bad_pattern: {
			"fr": "Votre code ne doit contenir que des chiffres & des lettres",
			"us": "Your code must contain only letters & numbers"
		},
		to_easy_on_api: {
			"fr": "Une photo est dj en cours de tlchargement",
			"en ": "A photo is already downloading"
		},
		to_new_meefore: {
			"fr": "%name propose un meefore le %date",
			"us": "%name hosts a meefore the %date"
		},
		to_new_meefore_host: {
			"fr": "Un ami vous a ajout en tant qu'organisateur de son meefore",
			"us": "A friend added you as host of his meefore"
		},
		to_default_error: {
			"fr": "Une erreur est survenue",
			"us": "Something went wrong"
		}, 
		to_chat_inp_not_in: {
			"fr": "Vous n'avez pas encore t accept!",
			"us": "You haven't been accepted yet"
		},
		to_chat_inp_too_quick: {
			"fr": "Moins vite",
			"us": "Slow down"
		},
		to_chat_inp_empty: {
			"fr": "Le message est vide!",
			"us": "The message is empty"
		},
		to_event_created_success_2: {
			"fr": "Que la fte commence...",
			"us": "May the party get started..."
		},
		to_party_created_success: {
			"fr": "La soire a t ajoute",
			"us": "The party has been added"
		},
		to_event_group_accepted: { 
			"fr": "Le groupe %s a t accept",
			"us": "The group %s has been accepted"
		},
		to_event_group_pending: {
			"fr": "Le groupe %s a t mis en attente",
			"us": "The group %s has been put on hold"
		},
		to_request_sent: {
			"fr": "Votre demande a t envoye!",
			"us": "Your request has been sent"
		},
		to_request_event_status_modified: {
			"fr": "Le statut de l'vnement a t modifi",
			"us": "The event status has been modified"
		},
		// to_init_no_friends: {
		// 	"fr": "Aucun de vos amis n'est sur Meefore? Invitez-les  vous rejoindre!",
		// 	"us": "None of your friends is on Meefore? Invite them all!"
		// },
		to_noupload_necessary: {
			"fr": "Aucune mise  jour n'est ncessaire!",
			"us": "No update is necessary!"
		},
		to_upload_singlepic: {
			"fr": "Ne tlchargez qu'une seule image  la fois",
			"us": "Please, don't upload more than one picture at once"
		},
		to_profile_update_success: {
			"fr": "Vos informations ont t modifies",
			"us": "Your informations has been updated"
		},
		to_settings_update_success: {
			"fr": "Vos prfrences ont t modifies",
			"us": "Your settings have been updated"
		},
		to_upload_pic_success: {
			"fr": "Votre photo a t modifie",
			"us": "Your picture has been updated"
		},
		to_update_pic_success: {
			"fr": "Vos photos ont t mise  jour",
			"us": "Your pictures have been updated"
		},
		to_host_push_new_group: {
			"fr": "Un groupe souhaite rejoindre votre meefore",
			"us": "A group has requested to join your meefore"
		},
		to_push_new_request_by_friend: {
			"fr": "Un ami vous a ajout  un meefore",
			"us": "A friend of yours has added you to a meefore"
		},
		to_push_new_status_by_friend: {
			"fr": "Un de vos amis a modifi le statut d'un de vos meefore",
			"us": "A friend of yours has modified the status of one of your meefore"
		},
		to_push_request_accepted: {
			"fr": "Vous avez t accept dans un meefore!",
			"us": "You have been accepted in a meefore!"
		},
		to_push_group_validated_by_friend: {
			"fr": "Un de vos amis a valid un groupe",
			"us": "A friend of yours has validated a group"
		},
		to_push_group_suspended_by_friend: {
			"fr": "Un de vos amis a suspendu un groupe de la discussion",
			"us": "A friend of yours has suspended a group from the chat"
		},
		to_welcome: {
			"fr": "Bienvenue sur Meefore",
			"us": "Welcome to Meefore"
		},

		//mp stands for missing parameter
		err_create_n_hosts: {
			"fr": "Il faut tre entre %min et %max pour organiser un before",
			"us": "You must be between %min and %max to organize a pregame party",
		},
		err_create_mp_ambiance: {
			"fr": "Hashtag ton meefore pour le dcrire",
			"us": "Hashtag your meefore to describe it"
		},
		err_create_mp_party: {
			"fr": "Adresse de la soire manquante",
			"us": "Missing the address of the party"
		},
		err_create_mp_address: {
			"fr": "Adresse du meefore manquante",
			"us": "Missing meefore's address"
		},
		err_create_mp_begins_at: {
			"fr": "Date manquante/incomplte",
			"us": "Missing the date"
		},
		err_create_mp_default: {
			"fr": "Une des valeurs semble manquer",
			"us": "There is a field that seems to be missing "
		},
		err_create_already_hosting_me: {
			"fr": "Vous organisez dj un meefore ce jour l",
			"us": "You have already planned a meefore this day"
		},
		err_create_already_hosting_other: {
			"fr": "%s organise dj un meefore ce jour l",
			"us": "%s has already planned a meefore this day"
		},
		err_create_twin_hosts: {
			"fr": "Tous les organisateurs doivent tre diffrents",
			"us": "Every host must be different"
		},
		err_create_time_travel: {
			"fr": "La date de dbut ne peut tre une date passe",
			"us": "The date seems to be wrong"
		},
		err_create_ghost_hosts: {
			"fr": "Un des organisateurs n'a pas t trouv",
			"us": "One of the hosts can't be found"
		},
		err_request_mp_members_facebook_id: {
			"fr": "Il faut tre au moins deux pour rejoindre un meefore",
			"us": "You must be at least two to organize a meefore"
		},
		err_request_mp_name: {
			"fr": "En manque d'inspiration? Un petit effort!",
			"us": "Lacking inspiration? A little bit of extra effort!"
		},
		err_request_mp_message: {
			"fr": "Un message de bienvenue est indispensable!",
			"us": "A welcome message is much-needed!"
		},
		err_request_mp_default: {
			"fr": "Une des valeurs semble manquer",
			"us": "One of the values seems to be missing"
		},
		err_request_already_there: {
			"fr": " dj prsent en tant ",
			"us": " already there "
		},
		err_request_already_there_role_host: {
			"fr": "qu'organisateur",
			"us": "as host"
		},
		err_request_already_there_role_asker: {
			"fr": "que participant",
			"us": "as participant"
		},
		err_request_already_there_me: {
			"fr": "Tu es",
			"us": "You are"
		},
		err_request_already_there_other: {
			"fr": "%s est",
			"us": "%s is"
		},
		err_unknown: {
			"fr": "Une erreur inconnue s'est produite",
			"us": "An unknown error has occured"
		},
		err_request_name_bad_length: {
			"fr": "Le nom doit avoir entre %min et %max caractres",
			"us": "The name must be composed of a minimum of %min and a maximum of %max characters"
		},
		err_request_message_bad_length: {
			"fr": "Le message doit avoir entre %min et %max caractres",
			"us": "The message must be composed of a minimum of %min and a maximun of %max characters"
		},
		err_request_n_group: {
			"fr": "Votre groupe doit avoir entre %min et %max personnes",
			"us": "Your group must have between %min and %max people"
		},
		err_request_ghost_members: {
			"fr": "Des membres ne sont pas encore inscrits sur Meefore",
			"us": "Some members have not signed up to Meefore yet"
		},
		err_request_event_not_open: {
			"fr": "Les organisateurs ont suspendu momentanment le meefore",
			"us": "The hosts have suspended the meefore at the moment"
		},
		err_chat_send_message: {
			"fr": "Une erreur inconnue s'est produite suite  l'envoie du message",
			"us": "An unknown error has occured when sending the message"
		},
		err_chat_fetch_unauth_group: {
			"fr": "Tu n'es pas autoris  participer  cette discussion!",
			"us": "You are not authorized to take part in this discussion"
		},
		err_chat_fetch_unauth_fetch: {
			"fr": "Tu n'es pas autoris  demander les messages de cette discussion",
			"us": "You are not authorized to request this discussion's messages"
		},
		err_chat_fetch_unauth_admin: {
			"fr": "Vous n'tes pas autoris  participer  cette discussion! (admin)",
			"us": "You are not authorized to take part in this discussion"
		},
		err_chat_mp: {
			"fr": "Il manque un paramtre pour envoyer le message",
			"us": "A parameter is missing to send the message"
		},
		err_chat_seen_by: {
			"fr": "Une erreur inconnue s'est produite  la lecture du message",
			"us": "An unknown error has occured when reading the message"
		},
		err_pusher_unauth: {
			"fr": "",
			"us": "Cannot join the channel (access denied, auth failed)"
		},
		err_settings_invalid_email: {
			"fr": "Nous avons besoin d'un email de contact valide pour changer vos prfrences",
			"us": "We need a valid contact email to change your preferences"
		},
		err_update_profile_age: {
			"fr": "Votre ge ne semble pas avoir le bon format",
			"us": "Your age doesnt seem to be properly formatted"
		},
		err_update_profile_mainify_placeholder: {
			"fr": "Votre photo de profil doit vous reprsenter",
			"us": "Your profile picture must represent yourself"
		},
		err_update_profile_delete_main_picture: {
			"fr": "Vous ne pouvez pas supprimer votre photo de profil",
			"us": "You can't delete your profile picture"
		},
		err_update_profile_default: {
			"fr": "Une erreur inattendue s'est produite",
			"us": "Something unexpected happened"
		},
		err_unexpected_message: {
			"fr": "Une erreur inattendue s'est produite. <br> Cette erreur peut-tre due  des circonstances exceptionnelles ou  un bug !" 
			       + "<br> Nous vous invitons  retenter votre action plus tard et  nous contacter si l'erreur persiste :/",
			"us": "Something unexpected happened. <br> This error might be caused by exceptionnal circumstances or simply bug a bug."
				   + "<br> Please try again later and we thank you in advance to contact us if the problem persists :/"
		},
		lp_subtitle: {
			"fr": "<div class='lp-subpart'>Des rencontres <div class='lp-avant'><span>avant</span><img src='/img/app/avant.png' width='90%' /></div> d'aller en soire.   " ,
			"us": "<div class='lp-subpart'>Meeting new people <div class='lp-avant'><span>before</span><img src='/img/app/avant.png' width='90%' /></div> partying.</div>"
		},
		lp_subtitle_sub: {
			"fr": "Participez  des before prs de chez vous.",
			"us": "Join pregame parties around you."
		},
		lp_conn_button: {
			"fr": "Connexion",
			"us": "Connection"
		},
		lp_reason_1_h1: {
			"fr": "Trouvez votre before",
			"us": "Find a pregame party"
		},
		lp_reason_2_h1: {
			"fr": "Demandez  participer",
			"us": "Request to join"
		},
		lp_reason_3_h1: {
			"fr": "Faites connaissance",
			"us": "Get to know each other"
		},
		lp_reason_1_h2: {
			"fr": "Parcourez et reprez sur la map les before qui s'organisent prs de chez vous.",
			"us": "Go on the map and find all the pregame parties happening around you."
		},
		lp_reason_2_h2: {
			"fr": "Envoyez une demande de participation pour rejoindre le before qui vous ambiance le plus avec au moins un de vos amis.",
			"us": "Request to join the pregame party that seems to fit you the most with at least one of your friends."
		},
		lp_reason_3_h2: {
			"fr": "Une fois accept, discutez avec les organisateurs pour prparer votre soire avant de vous retrouver.",
			"us": "Once accepted, chat with the hosts to plan your evening before you meet with them."
		},
		lp_footer_followus: {
			"fr": "Nous suivre",
			"us": "Follow us"
		},
		lp_contact_title: {
			"fr": "Contactez-nous",
			"us": "Contact us"
		},
		lp_contact_name: {
			"fr": "Nom*",
			"us": "Name*"
		},
		lp_contact_email: {
			"fr": "Email*",
			"us": "Email*"
		},
		lp_contact_message: {
			"fr": "Message*",
			"us": "Message*"
		},
		lp_contact_send_success: {
			"fr": "Votre message a bien t envoy <br> Merci !",
			"us": "Your message has been sent <br> Thank you !"
		},
		lp_contact_error_fields: {
			"fr": "Il manque certains champs",
			"us": "Some fields are missing"
		},
		lp_contact_error_email: {
			"fr": "L'adresse email indique semble avoir une petite erreur",
			"us": "Your email address doesn't look like one "
		},
		lp_contact_error_generic: {
			"fr": "Une erreur s'est produite. Contactez-nous directement  contact@meefore.com",
			"us": "Something wrong happened. Mail us directly at contact@meefore.com"
		},
		login_loading_msg: {
			"fr": "Chargement de l'application",
			"us": "Loading the app"
		},
		app_mobile_warning: {
			"fr": "Meefore est en mode navigation limite sur web mobile. L'application sera bientt disponible sur iOS !",
			"us": "Meefore in limited mode on web mobile. The iOS app should be soon available on the AppleStore"
		},
		app_event_unavailable: {
			"fr": "Ce before n'est plus d'actualit",
			"us": "This before is no longer available"
		},
		app_reconnect: {
			"fr": "Vous avez t dconnect. <br> L'application redmarrera ds que vous aurez retrouv la connexion.",
			"us": "You have been disconnected. <br> App will reboot automatically once your connection is back."
		},
		app_button_invite: {
			"fr": "Invitez vos amis",
			"us": "Invite your friends"
		},
		app_searching_text: {
			"fr": "Recherche...",
			"us": "Searching..."
		},
		app_no_results_invite: {
			"fr": "Aucun rsultats  afficher",
			"us": "The search returned no results"
		},
		n_new_meefore_text: {
			"fr": "Nouveau meefore propos pour %place",
			"us": "New meefore created for %place"
		},
		n_new_meefore_subtext: {
			"fr": "Il y a actuellement %n meefore pour cette soire",
			"us": "There are currently %n meefore for this party"
		},
		n_accepted_in_text: {
			"fr": "Vous avez un Match !",
			"us": "It's a Match !"
		},
		n_accepted_in_subtext: {
			"fr": "Faites connaissance ds maintenant",
			"us": "Get to know each other now"
		},
		n_group_request_hosts_text: {
			"fr": "Cheers reu",
			"us": "Cheers received"
		},
		n_group_request_hosts_subtext: {
			"fr": "Un groupe a montr un intrt pour votre before",
			"us": "A group seems to be interested by your pregame"
		},
		n_group_request_members_text: {
			"fr": "Cheers envoy",
			"us": "Cheers sent"
		},
		n_group_request_members_subtext: {
			"fr": "%name a envoy un Cheers avec vous",
			"us": "%name has sent a Cheers with you"
		},
		n_marked_as_host_text: {
			"fr": "Marqu coorganisateur par %name",
			"us": "Marked as co-host by %name"
		},
		n_marked_as_host_subtext: {
			"fr": "%address - %date",
			"us": "%address - %date"
		},
		n_fill_profile_text: {
			"fr": "Compltez votre profil",
			"us": "Complete your profile"
		},
		n_fill_profile_subtext: {
			"fr": "Vous augmenterez vos chances d'avoir des Cheers",
			"us": "That will increase your chances to get a Cheers"
		},
		n_new_friends_text: {
			"fr": "Nouveaux amis",
			"us": "New friends"
		},
		n_new_friends_subtext: {
			"fr": function( names ){
				return "Bienvenue  " + LJ.renderManyMultipleNames( names, 3 );
				var came = names.length == 1 ? "vient" : "viennent";
				return LJ.renderManyMultipleNames( names, 3 ) + ' ami(e)s '+ came +' de rejoindre Meefore';
			},
			"us": function( names ){
				return "Welcome to " + LJ.renderManyMultipleNames( names, 3 );
				return LJ.renderManyMultipleNames( names, 3 ) + ' friends just joined Meefore';
			},
		},
		n_inscription_success_text: {
			"fr": "Bienvenue sur Meefore",
			"us": "Welcome on Meefore"
		},
		n_inscription_success_subtext: {
			"fr": "Faites des rencontres avant d'aller en soire",
			"us": "Meet new people before going out"
		},
		n_before_canceled_text: {
			"fr": "Before annul",
			"us": "Pregame canceled"
		},
		n_before_canceled_subtext: {
			"fr": "%address",
			"us": "%address"
		},
		n_item_shared_text: {
			"fr": "Partag par %name",
			"us": "Shared by %name"
		},
		n_item_shared_subtext: {
			"fr": "%name vient de vous partager un %type",
			"us": "%name just shared a %type with you"
		},
		n_check_email_text: {
			"fr": "Votre addresse email est-elle  jour ?",
			"us": "Is your email address up-to-date ?"
		},
		n_check_email_subtext: {
			"fr": "L'addresse rcupre avec Facebook est parfois trs ancienne !",
			"us": "The email address we got from Facebook might be outdated !"
		},
		n_new_notification: {
			"fr": "Vous avez une nouvelle notification",
			"us": "You have a new notification"
		},
		n_header_text: {
			"fr": "Notifications",
			"us": "Notifications"
		},
		n_footer_text: {
			"fr": "Dlivr avec <3 par meefore",
			"us": "Delivered with <3 by meefore"
		},
		mod_facebook_pictures_title: {
			"fr": "Photos Facebook",
			"en ": "Facebook photos"
		},
		mod_facebook_pictures_subtitle: {
			"fr": "Slectionner la photo que vous souhaitez importer  partir de Facebook",
			"en ": "Select the photo you wish to import from Facebook"
		},
		mod_change_lang_title: {
			"fr": "Changer de langue",
			"us": "Change language"
		},
		mod_change_lang_subtitle: {
			"fr": "La langue ne devrait pas tre une barrire pour faire la fte. L'application se traduit instantanment dans le langage de votre choix.",
			"us": "The language should never be an obstacle to partying. The application translates itself instantaneously in the language of your choosing"
		},
		segment_cheers_received: {
			"fr": "Reus",
			"us": "Received"
		},
		segment_cheers_sent: {
			"fr": "Envoys",
			"us": "Sent"
		},
		cheers_requested_with: {
			"fr": "Avec %names",
			"us": "With %names"
		},
		shared_by_item_subtitle: {
			"fr": "%type partag par %name",
			"us": "%type shared by %name"
		},
		shared_with_item_subtitle: {
			"fr": "%type partag avec %names",
			"us": "%type shared with %names"
		},
		friends_title_invite: {
			"fr": "Invitez plus d'amis",
			"us": "Invite more friends"
		},
		cheers_item_title_sent: {
			"fr": "%groupname",
			"us": "%groupname"
		},
		cheers_item_title_received: {
			"fr": "%groupname",
			"us": "%groupname"
		},
		cheers_item_subtitle: {
			"fr": "Pour un before le %date",
			"us": "The pregame starts the %date"
		},
		w_profile: {
			"fr": "profil",
			"us": "profile"
		},
		w_and: {
			"fr": "et",
			"us": "and"
		},
		w_more: {
			"fr": "autre(s)",
			"us": "more"
		},
		w_you: {
			"fr": "vous",
			"us": "you"
		},
		w_na: {
			"fr": "Non renseign(e)",
			"us": "Unfilled"
		},
		ghost_user_name: {
			"fr": "Inconnu(e)",
			"us": "Unknown"
		},
		ghost_user_job: {
			"fr": "Cet utilisateur a suspendu son compte",
			"us": "This user has suspended his account"
		},
		settings_ux_message_seen_label: {
			"fr": "Signaler messages lus",
			"us": "Signal read messages"
		},
		settings_ux_message_seen_explanation: {
			"fr": "Les autres utilisateurs sauront que vous avez lu leurs messages",
			"us": "Other users will know that you have read their messages"
		},
		settings_ux_country_label: {
			"fr": "Afficher les nationalits",
			"us": "Display the nationalities"
		},
		settings_ux_country_explanation: {
			"fr": "Afficher les nationalits autre que la mienne sur les miniatures",
			"us": "Display nationalities other than mine on the thumbnail"
		},
		settings_ux_gender_label: {
			"fr": "Afficher le sexe (H/F)",
			"us": "Display the gender (H/F)"
		},
		settings_ux_gender_explanation: {
			"fr": "Afficher le sexe des utilisateurs sur leur miniature pour les distinguer plus facilement",
			"us": "Display the user's gender on his thumbnail"
		},
		settings_ux_auto_login_label: {
			"fr": "Login automatique",
			"us": "Auto login"
		},
		settings_ux_changelang_label: {
			"fr": "Langue par dfaut",
			"us": "Default language"
		},
		settings_ux_changelang_explanation: {
			"fr": "L'application est disponible dans plusieurs langues",
			"us": "The application is available in several languages"
		},
		settings_ux_auto_login_explanation: {
			"fr": "Se connecter directement sans passer par la page d'accueil",
			"us": "Connect directly skipping the homepage"
		},
		settings_part_title_email: {
			"fr": "Emails",
			"us": "Emails"
		},
		settings_part_title_notifications_email: {
			"fr": "Notifications par email",
			"us": "Email notifications"
		},
		settings_emails_new_message_label: {
			"fr": "Nouveau message reu",
			"us": "New message received"
		},
		settings_emails_new_message_explanation: {
			"fr": "Envoy  chaque nouveau message",
			"us": "Sent every time you receive a new message"
		},
		settings_emails_marked_as_host_label: {
			"fr": "Marqu(e) coorganisateur",
			"us": "Marked as host"
		},
		settings_emails_marked_as_host_explanation: {
			"fr": "Envoy lorsqu'un ami vous dsigne comme tant coorganisateur de son before",
			"us": "Sent when your friends tags you as co-host of his pregame"
		},
		settings_emails_new_match_label: {
			"fr": "Nouveau Match",
			"us": "New Match"
		},
		settings_emails_new_match_explanation: {
			"fr": "Envoy lorsque vous avez un nouveau Match",
			"us": "Sent when you have a new Match"
		},
		settings_emails_new_cheers_label: {
			"fr": "Nouveau Cheers",
			"us": "New Cheers"
		},
		settings_emails_new_cheers_explanation: {
			"fr": "Envoye lorsque vous reu avez un nouveau Cheers",
			"us": "Sent when you have received a new Cheers"
		},
		settings_notifs_newsletter_label: {
			"fr": "Newsletter",
			"us": "Newsletter"
		},
		settings_notifs_newsletter_explanation: {
			"fr": "Notre newsletter hebdomadaire",
			"us": "Our weekly newsletter"
		},
		settings_notifs_invitations_label: {
			"fr": "Invitations",
			"us": "Invitations"
		},
		settings_notifs_invitations_explanation: {
			"fr": "Bon plans et invitations  des soires spciales",
			"us": "Invitations to special events"
		},
		settings_code_sponsor_button: {
			"fr": "Activer un code d'invitation",
			"us": "Activate an invitation code"
		},
		settings_code_sponsor_explanation: {
			"fr": "Partagez ce code avec vos amis pour les parrainer",
			"us": "Share this code with your friends to sponsor them"
		},
		settings_part_title_code: {
			"fr": "Code d'invitation",
			"us": "Invite code"
		},
		settings_modal_sponsor_title: {
			"fr": "Code parrainage",
			"us": "Sponsor code"
		},
		settings_modal_sponsor_subtitle: {
			"fr": "Entrez le code de votre parrain et bnficiez chacun de 5 meepass",
			"us": "Enter your sponsor's code and receive both 5 meepass"
		},
		settings_modal_sponsor_button: {
			"fr": "Activer",
			"us": "Activate"
		},
		picture_main_label: {
			"fr": "Photo principale",
			"us": "Main picture"
		},
		empty_shared_title: {
			"fr": "Rien  l'horizon...",
			"us": "Nothing on the horizon..."
		},
		empty_shared_subtitle: {
			"fr": "Partagez des profils ou des before avec vos amis pour pouvoir vous organiser plus rapidement.",
			"us": "Share profiles or pregame with your friends to help you organize your nights."
		},
		empty_cheers_sent_title: {
			"fr": "Aucun Cheers envoys",
			"us": "No Cheers sent"
		},
		empty_cheers_sent_subtitle: {
			"fr": "Les Cheers permettent  chaque membre de montrer  des organisateurs qu'ils sont intress par leur before.",
			"us": "Cheers allow each member to let hosts of pregames know that they are interested in their pregame."
		},
		empty_cheers_received_title: {
			"fr": "Aucun Cheers reus",
			"us": "No Cheers received"
		},
		empty_cheers_received_subtitle: {
			"fr": "Les Cheers permettent  chaque membre de montrer  des organisateurs qu'ils sont intress par leur before.",
			"us": "Cheers allow each member to let hosts of pregames know that they are interested in their pregame."
		},
		empty_friends_title: {
			"fr": "Pas encore d'amis",
			"us": "No friends yet"
		},
		empty_friends_subtitle: {
			"fr": "Il faut tre au moins 2 pour crer ou participer  un before. Invitez vos amis  vous rejoindre pour sortir et faire de nouvelles rencontres.",
			"us": "You need to be at least 2 in order to pregrame. Invite your friends to join you to get out and meet new people."
		},
		hint_cheers_pending: {
			"fr": "En attente de Match",
			"us": "Waitinf for a Match"
		},
		hint_cheers_accepted: {
			"fr": "Match !",
			"us": "It's a Match !"
		},
		to_group_accepted_hosts: {
			"fr": "Vous avez un Match !",
			"us": "You have a new Match !"
		},
		to_group_accepted_users: {
			"fr": "Vous avez un Match !",
			"us": "You have a new Match !"
		},
		disconnected_title: {
			"fr": "Vous tes dconnect",
			"us": "You are offline"
		},
		disconnected_subtitle: {
			"fr": "Vous serez reconnect automatiquement ds que vous aurez retrouv internet.",
			"us": "You will be automatically reconnected when you're back online. "
		},
		init_location_title: {
			"fr": "Bienvenidos !",
			"us": "Bienvenidos !"
		},
		init_location_subtitle_placeholder: {
			"fr": "O souhaitez-vous sortir ?",
			"us": "Where would you like to go out ?"
		},
		init_location_explanation: {
			"fr": "Vous pourrez toujours changer de ville ultrieurement",
			"us": "You'll still be able to change that later"
		},
		init_location_geoloc: {
			"fr": "Utiliser ma position",
			"us": "Use my location"
		},
		user_profile_about: {
			"fr": "Dtails",
			"us": "Details"
		},
		user_profile_ideal_night: {
			"fr": "Sa soire idale",
			"us": "The dream night"
		},
		logout_title: {
			"fr": "A bientt",
			"us": "See you soon"
		},
		logout_subtitle: {
			"fr": "tes vous-sr de vouloir vous dconnecter ?",
			"us": "Are you sure you want to log out ?"
		},
		modal_err_empty_fetch: {
			"fr": "Nous n'avons pas trouv vos photos de profil",
			"us": "We were unable to find your profile pictures album"
		},
		settings_account_email: {
			"fr": "Tous nos emails seront envoys  cette addresse",
			"us": "All our emails will be sent to this address"
		},
		settings_account_delete_button: {
			"fr": "Supprimer mon compte",
			"us": "Delete my account"
		},
		settings_modal_delete_title: {
			"fr": "A bientt !",
			"us": "See you around !"
		},
		settings_modal_delete_subtitle: {
			"fr": "En supprimant votre compte, toutes les donnes vous concernant seront supprimes de nos serveurs."
				  + "<br><br><b>Attention, cette opration est irrversible.</b>",
			"us": "By deleting your account, every data about you will be deleted from our servers."
				  + "<br><br><b>Careful, this cannot be undone.</b>"
		},
		settings_modal_delete_button_confirm: {
			"fr": "Supprimer mon compte",
			"us": "Delete my account"
		},
		settings_modal_delete_button_cancel: {
			"fr": "Annuler",
			"us": "Cancel"
		},
		search_filters_gender_title: {
			"fr": "Montrez-moi seulement :",
			"us": "Show me only : "
		},
		search_filters_gender_explanations: {
			"fr": "Slectionner le sexe des personnes que vous recherchez.",
			"us": "Select the gender of the people you wish to see."
		},
		search_filters_age_title: {
			"fr": "Afficher les personnes de <span class='search-filters-min-age'></span>  <span class='search-filters-max-age'></span> ans",
			"us": "Display people from <span class='search-filters-min-age'></span> to <span class='search-filters-max-age'></span> years old"
		},
		search_filters_age_explanations: {
			"fr": "Seuls les utilisateurs dans la tranche d'ge slectionne apparatront dans la recherche.",
			"us": "Only the users within the selected agerange will be displayed."
		},
		search_filters_countries_title: {
			"fr": "Filtrer par pays :",
			"us": "Filter by country :"
		},
		search_filters_countries_explanations: {
			"fr": "Les pays proposs sont ceux comptant au moins un utilisateur.",
			"us": "The countries displayed are those for which there is at least one user."
		},
		search_filters_gender_label_male: {
			"fr": "Des hommes",
			"us": "Men"
		},
		search_filters_gender_label_female: {
			"fr": "Des femmes",
			"us": "Women"
		},
		nav_search_title: {
			"fr": "Tous les membres",
			"us": "All members"
		},
		nav_menu_title: {
			"fr": "Menu",
			"us": "Menu"
		},
		nav_map_title: {
			"fr": "Carte des soires",
			"us": "The Meemap"
		},
		modal_search_input_placeholder: {
			"fr": "Rechercher",
			"us": "Search"
		},
		modal_share_title_profile: {
			"fr": "Partager un profil",
			"us": "Share a profile"
		},
		modal_share_subtitle_profile: {
			"fr": "Slectionnez dans la liste les personnes avec qui vous souhaitez partager ce profil.",
			"us": "Select in your friendlist who you wish to share this profile with."
		},
		to_profile_shared_success: {
			"fr": "Le profil a bien t partag",
			"us": "The profile has been shared"
		},
		modal_share_title_before: {
			"fr": "Partager un before",
			"us": "Share a pregame"
		},
		modal_share_subtitle_before: {
			"fr": "Slectionnez dans la liste les personnes avec qui vous souhaitez partager ce before.",
			"us": "Select in your friendlist who you wish to share this pregame with."
		},
		to_before_shared_success: {
			"fr": "Le before a bien t partag",
			"us": "The pregame has been shared"
		},
		to_cheers_sent_success: {
			"fr": "Votre Cheers a bien t envoye",
			"us": "Your Cheers has been sent"
		},
		to_cheers_received_success: {
			"fr": "Vous avez reu un Cheers",
			"us": "You have received a Cheers"
		},
		to_cheers_sent_success_friend: {
			"fr": "Un ami souhaite participer  un before avec vous",
			"us": "A friend wishes to join a before with you"
		},
		meepass_ribbon2: {
			"fr": "Il vous reste <span class='n_meepass'>%n</span> meepass",
			"us": "You have <span class='n_meepass'>%n</span> meepass left"
		},
		meepass_ribbon: {
			fr: function(){
				var n_meepass = LJ.user.meepass.length;
				return "Il vous reste <span class='n_meepass'>" + n_meepass + "</span> meepass";
			},
			us: function(){
				var n_meepass = LJ.user.meepass.length;
				return "You have <span class='n_meepass'>" + n_meepass + "</span> meepass left";
			}
		},
		settings_ux_changelang_button: {
			"fr": "Changer de langue",
			"us": "Change the language"
		},
		be_close_to: {
			"fr": "A proximit de",
			"us": "Close to"
		},
		"be_create_title": {
			"fr": "Crer un before",
			"us": "Create a pregame"
		},
		be_create_subtitle_hosts: {
			"fr": "Membres du groupe",
			"us": "Hosts"
		},
		be_create_hosts_explanations: {
			"fr": "Slectionnez les autres coorganisateurs parmis vos amis",
			"us": "Select the other hosts among your friends"
		},
		be_create_subtitle_before: {
			"fr": "Le before",
			"us": "The pregame"
		},
		be_create_hosts_placeholder: {
			"fr": "Coorganisateurs",
			"us": "Other hosts"
		},
		be_create_date_placeholder: {
			"fr": "Date",
			"us": "Date"
		},
		be_create_hour_placeholder: {
			"fr": "Heure",
			"us": "Hour"
		},
		be_create_location_placeholder: {
			"fr": "Lieu",
			"us": "Address"
		},
		be_create_before_explanations: {
			"fr": "O et quand vous rejoignez-vous ?",
			"us": "Where and when will you guys meet ?"
		},
		be_create_button: {
			"fr": "Crer",
			"us": "Create"
		},
		modal_be_create_title: {
			"fr": "Membres du groupe",
			"us": "Group members"
		},
		modal_be_create_subtitle: {
			"fr": function(){
				var min = LJ.app_settings.app.min_hosts - 1;
				var max = LJ.app_settings.app.max_hosts - 1;
				return "Slectionnez les autres organisateurs parmis vos amis <br> (%min minimum, %max maximum)".replace('%min', min).replace('%max', max);
			},
			"us": function(){
				var min = LJ.app_settings.app.min_hosts - 1;
				var max = LJ.app_settings.app.max_hosts - 1;
				return "Select the other hosts among your friends <br> (%min minimum, %max maximum)".replace('%min', min).replace('%max', max);
			}
		},
		err_be_create_missing_hosts: {
			"fr": "Les coorganisateurs sont manquants",
			"us": "Cohosts are missing"
		},
		err_be_create_missing_date: {
			"fr": "La date de dbut est manquante",
			"us": "The date is missing"
		},
		err_be_create_missing_location: {
			"fr": "L'addresse est manquante",
			"us": "The address is missing"
		},
		err_be_create_already_hosting_me: {
			"fr": "Vous organisez dj un before ce jour-l",
			"us": "You already host an event on this day"
		},
		err_be_create_already_hosting: {
			"fr": "%names organise(nt) dj un before ce jour-l",
			"us": "%names are already hosting a before on this day"
		},
		shared_before_title: {
			"fr": function( names ){
				return 'Before avec ' + LJ.renderMultipleNames( names );
			},
			"us": function( names ){
				return 'Pregame with ' + LJ.renderMultipleNames( names );
			}
		},
		slide_overlay_before_message: {
			"fr": "Que souhaitez-vous faire ?",
			"us": "What would you like to do ?"
		},
		slide_overlay_before_cancel: {
			"fr": "Annuler mon before",
			"us": "Cancel my pregame"
		},
		slide_overlay_back: {
			"fr": "Retour",
			"us": "Back"
		},
		to_cancel_before_success: {
			"fr": "Le before a bien t annul",
			"us": "The pregame have been canceled"
		},
		before_just_canceled: {
			"fr": "Nous sommes dsols, ce before vient d'tre annul par un des organisateurs.",
			"us": "We are sorry, this pregame just got canceled by one of the hosts."
		},
		chat_just_canceled: {
			"fr": "Un de vos Match vient d'annul son before. <span>Synchronization en cours...</span>",
			"us": "One of your Match just canceled his pregame.<span>Resync..."
		},
		be_ended: {
			"fr": "Le before est termin",
			"us": "The pregame is over"
		},
		be_hosted: {
			"fr": "Vous faites parti des organisateurs",
			"us": "You are one of the hosts"
		},
		to_friend_canceled_event: {
			"fr": "%name vient d'annul un before que vous organisiez ensemble",
			"us": "%name just canceled a pregame that you organized together"
		},
		modal_request_subtitle: {
			"fr": "Slectionnez au plus 3 amis avec lesquels vous souhaiteriez participer.",
			"us": "Select at most 3 friends you would like to go with."
		},
		to_before_create_success: {
			"fr": "Votre before vient d'tre cr",
			"us": "Your pregame was created successfully"
		},
		to_before_create_success_friends: {
			"fr": "%name vous a marqu coorganisateur de son before",
			"us": "%name marked you as host of his pregame"
		},
		modal_no_friends_btn: {
			"fr": "Invitez des amis",
			"us": "Invite your friends"
		},
		modal_no_friends_text: {
			"fr": "Il faut tre au moins 2 pour effectuer cette action",
			"us": "You need to be at least two to perform this action"
		},
		be_request_already_there: {
			"fr": "a dj envoy un Cheers pour ce before",
			"us": "has already sent a Cheers for this before"
		},
		to_request_pending: {
			"fr": "Vous pourrez discuter ds que vous aurez un Match",
			"us": "You can start chatting when you have a Match"
		},
		chat_header_title: {
			"fr": "Discussions",
			"us": "Conversations"
		},
		chat_segment_all: {
			"fr": "Toutes",
			"us": "All"
		},
		chat_segment_hosted: {
			"fr": "J'organise",
			"us": "I host"
		},
		chat_segment_requested: {
			"fr": "Je participe",
			"us": "I join"
		},
		chat_empty_title: {
			"fr": "Rien  l'horizon...",
			"us": "Nothing on the horizon..."
		},
		chat_empty_subtitle_row: {
			"fr": "Vous pourrez discuter avec vos amis et faire connaissance avec les autres membres lorsque vous aurez cr un before ou obtenu un Match",
			"us": "You will be able to chat with your friends and the other members once you have created a pregame or obtained a Match"
		},
		chat_empty_title_inview_hosts: {
			"fr": "Vous avez un Match !",
			"us": "It's a Match !"
		},
		chat_empty_subtitle_inview_hosts: {
			"fr": function( group_name ){
				return  "Fates connaissance avec " + group_name + " ds maintenant."
			},
			"us": function( group_name ){
				return "Get to know " + group_name + " now."
			} 
		},
		chat_empty_title_inview_accepted: {
			"fr": "Vous avez un Match !",
			"us": "It's a Match !"
		},
		chat_empty_subtitle_inview_accepted: {
			"fr": function( group_name ){
				return  "Fates connaissance avec " + group_name + " ds maintenant."
			},
			"us": function( group_name ){
				return "Get to know " + group_name + " now."
			} 
		},
		chat_empty_title_inview_team: {
			"fr": function( group_name ){ return group_name; },
			"us": function( group_name ){ return group_name; }
		},
		chat_empty_subtitle_inview_team: {
			"fr": "Seuls vous et les autres membres de ce groupe recevront les messages qui seront envoys sur cette discussion.",
			"us": "Only you and the other members of your group will receive messages that are sent on this chat."
		},
		chat_empty_title_inview_pending: {
			"fr": "Un peu de patience...",
			"us": "Be patient..."
		},
		chat_empty_subtitle_inview_pending: {
			"fr": "Vous pourrez faire connaissance ds que vous aurez un Match avec les organisateurs.",
			"us": "You'll be able to start chatting as soon as there is a Match with the hosts."
		},
		chat_rows_team_title: {
			"fr": "Amis",
			"us": "Friends"
		},
		chat_rows_all_title: {
			"fr": "Match",
			"us": "Match"
		},
		chat_inview_options_message: {
			"fr": "Que souhaitez-vous faire ?",
			"us": "What would you like to do ?"
		},
		chat_inview_options_message_show_users_all: {
			"fr": "Voir tous les participants",
			"us": "See everyone"
		},
		chat_inview_options_message_show_users_team: {
			"fr": "Voir les membres de mon groupe",
			"us": "See members of my group"
		},
		chat_inview_options_message_show_before: {
			"fr": "Voir le before",
			"us": "See the pregame"
		},
		chat_inview_users_group_users: {
			"fr": "Votre groupe",
			"us": "Your group"
		},
		chat_inview_users_group_hosts: {
			"fr": "Organisateurs",
			"us": "Hosts"
		},
		chat_groupname_all: {
			"fr": "Tout le monde",
			"us": "All"
		},
		chat_groupname_team: {
			"fr": "Mon groupe",
			"us": "My group"
		},
		chat_row_request_all_title: {
			"fr": "Vous avez un Match !",
			"us": "It's a Match !"
		},
		chat_row_request_all_subtitle: {
			"fr": function( names ){ return "avec " + names; },
			"us": function( names ){ return  "with " + names; } 
		},
		chat_row_request_team_title: {
			"fr": "Nouvelle conversation de groupe",
			"us": "New group conversation"
		},
		chat_row_request_team_subtitle: {
			"fr": function( names ){ return "entre " + names; },
			"us": function( names ){ return  "between " + names; } 
		},
		chat_inview_validate_later: {
			"fr": "Plus tard",
			"us": "Later"
		},
		chat_inview_validate: {
			"fr": "Cheers !",
			"us": "Cheers !"
		},
		seen_by_everyone: {
			"fr": "Vu par tout le monde",
			"us": "Seen by everyone"
		},
		seen_by_some: {
			"fr": function( names ){
				return "Vu par " + LJ.renderMultipleNames( names );
			},
			"us": function( names ){
				return "Seen by " + LJ.renderMultipleNames( names );
			}
		},
		cheers_back_groupname: {
			"fr": "Vous avez reu un Cheers de...",
			"us": "You have been sent a Cheers by..."
		},
		be_ghost_title: {
			"fr": "404 !",
			"us": "404 !"
		},
		be_ghost_subtitle: {
			"fr": "Ce before n'a pas t trouv dans notre base de donnes, Cela peut vouloir dire qu'il a t annul.",
			"us": "This before is nowhere to be found in our database. This may mean that it has been canceled."
		},
		be_ghost_btn: {
			"fr": "Fermer",
			"us": "Close"
		},
		profile_ghost_title: {
			"fr": "404 !",
			"us": "404 !"
		},
		profile_ghost_subtitle: {
			"fr": "Ce membre n'a pas t trouv dans notre base de donnes. C'est le cas lorsqu'un utilisateur dsactive son compte.",
			"us": "This member is nowhere to be found in our database. This may mean that he has suspended his account."
		},
		profile_ghost_btn: {
			"fr": "Fermer",
			"us": "Close"
		},
		invite_friends_popup_h1: {
			"fr": "Parlez-en  vos amis",
			"us": "Bring your friends"
		},
		invite_friends_popup_h2: {
			"fr": "En leur partageant par message Facebook ",
			"us": "Share with them by message on Facebook"
		},
		invite_friends_popup_btn: {
			"fr": "Message Facebook",
			"us": "Facebook message"
		},
		chat_input_placeholder: {
			"fr": "Ecrivez un message...",
			"us": "Write a message..."
		},
		be_browser_empty: {
			"fr": "Aucun before n'est prvu dans cette ville dans les jours  venir",
			"us": "No pregame is scheduled in this town for the days to come"
		},
		chat_sync_done: {
			"fr": "Synchronization termine",
			"us": "Sync completed"
		},
		n_before_canceled: {
			"fr": "Ce before a t annul",
			"us": "This pregame has been canceled"
		},
		n_outdated_notification: {
			"fr": "Cette notification n'est plus d'actualit",
			"us": "This notification is out of date"
		}



	});



	window.LJ.login = _.merge( window.LJ.login || {}, {

			'$trigger_login': '.js-login',
			'$trigger_logout': '.js-logout',
			'$modal_logout'  : '.modal.--logout',
			'opening_duration': 1000,
			'prompt_duration': 600,
			'prompt_buttons_duration': 900,
			'completed_steps': 0,
			'break_duration': 400,

			'data': {},

			init: function(){
				return LJ.promise(function( resolve, reject ){
					LJ.login.handleDomEvents( resolve, reject );
				});
			},
			handleDomEvents: function( resolve, reject ){

				$( LJ.login.$trigger_login ).on('click', resolve );
				$( LJ.login.$trigger_logout ).on('click', LJ.login.handleLogout );
				LJ.ui.$body.on('click', '.modal.--logout .modal-footer button', LJ.login.logUserOut );

			},
			showLandingElements: function(){

				var duration = 600;

				$('.landing').find('.landing-logo')
					.velocity('slideLeftIn', {
						duration: duration,
						display : 'flex'
					});

				$('.landing').find('.landing-lang')
					.velocity('slideRightIn', {
						duration: duration,
						display : 'flex'
					});

				$('.landing').find('.landing-body')
					.velocity('shradeIn', {
						duration: duration*2,
						display : 'flex'
					});

				$('.landing').find('.landing-footer')
					.velocity('slideUpIn', {
						duration: duration,
						display : 'flex'
					});


			},
			hideLandingElements: function(){

				$('.landing')
					.children()
					.velocity('shradeOut', {
						duration : 800,
						display  : 'none'
					});

			},
			showLoginProgressBar: function(){

				$('.login__message').velocity('shradeIn', {
			 		duration: 1600, delay: LJ.login.opening_duration/2
			 	});

			},
			addLoginProgression: function(){

				$( LJ.login.renderLoginProgression() ).hide().appendTo( $('.curtain') )

			},
			showLoginProgression: function(){

				$('.login').velocity('shradeIn', {
					duration: 1000
				});

			},
			showLoginProgressMessage: function(){

				$('.login__message').velocity('shradeIn', {
					duration: 1000
				});

			},
			hideLoginProgressBar: function(){

				$('.login__progress-bar').velocity('shradeIn', {
			 		duration: 1000
			 	});

			},
			enterLoginProcess: function(){

				LJ.login.hideLandingElements();
				LJ.ui.deactivateHtmlScroll();

				return LJ.delay( 1000 )
						 .then(function(){

						 	LJ.ui.showCurtain({ duration: 600, theme: "light", sticky: true });
						 	LJ.login.addLoginProgression();
						 	LJ.login.showLoginProgression();
						 	// LJ.login.showLoginProgressMessage();
						 	// LJ.login.showLoginProgressBar();

						 });

			},
			hideLoginSteps: function(){
				return LJ.promise(function( resolve, reject ){

					$('.app').removeClass('nonei');
					$('.landing').remove();

					$('.login__message, .login__progress-bar, .login__loader').velocity('shradeOut', {
						duration: 400,
						complete: resolve
						
					});

				});
			},
			firstSetup: function(){
				// the app requires a user's location to boot properly
				// - to be visible in the search section
				// - to allow for geo requests to fetch the right befores
				// - to allow the map to load in the right city
				var L = LJ.user.location;
				if( L && L.place_id && L.place_name && L.lat && L.lng ){
					return;
				}

				if( LJ.user.access.indexOf('bot') == -1 ){
					LJ.pictures.uploadFacebookPicture_Intro();
				}
				
	            return LJ.login.break()
	            		.then(function(){
	            			return LJ.login.promptUserLocation();

	            		})
	            		.then(function(){
	            			return LJ.login.debreak();

	            		});

			},
			break: function(){
				return LJ.ui.shradeOut( $('.login'), LJ.login.break_duration );

			},
			debreak: function(){
				return LJ.ui.shradeIn( $('.login'), LJ.login.break_duration );

			},
			stepCompleted: function( fill_ratio ){

				if( typeof fill_ratio != "number" ){
					fill_ratio = 33.33;
				}

				LJ.login.completed_steps += 1;
				LJ.login.fillProgressBar( fill_ratio );
			},
			fillProgressBar: function( fill_ratio ){

				var max_width = $('.login__progress-bar').width();
				var add_width = max_width * fill_ratio/100;
				var cur_width = (LJ.login.completed_steps) * add_width;
				var new_width = cur_width + add_width;

				$('.login__progress-bar-bg')
					.css({ 'width':  new_width });

			},
			renderLoginProgression: function(){

				return LJ.ui.render([

					'<div class="login">',
						'<div class="login__loader">',
							LJ.static.renderStaticImage('slide_loader'),
						'</div>',
						'<div class="login__message">',
							'<h1 data-lid="login_loading_msg"></h1>',
						'</div>',
						'<div class="login__progress-bar">',
							'<div class="login__progress-bar-bg"></div>',
						'</div>',
					'</div>'

				].join(''));

			},
			promptUserLocation: function(){
				return LJ.promise(function( resolve, reject ){

					LJ.log('Requesting the user to provide a location...');

					$( LJ.login.renderLocationPrompt() )
						.hide()
						.appendTo('.curtain')
						.velocity('shradeIn', {
							duration: LJ.login.prompt_duration,
							display: 'flex'
						});

					LJ.seek.activatePlacesInFirstLogin();
					LJ.seek.login_places.addListener('place_changed', function(){

						var place = LJ.seek.login_places.getPlace();
						$('.init-location').attr('data-place-id'   , place.place_id )
							  			   .attr('data-place-name' , place.formatted_address )
							  			   .attr('data-place-lat'  , place.geometry.location.lat() )
							  			   .attr('data-place-lng'  , place.geometry.location.lng() );

						LJ.login.showPlayButton();

					});

					// Resolve the promise when the user picked a location
					$('.init-location .action__validate').click(function(){
						var $block = $( this ).closest('.init-location');

						if( $block.hasClass('--validating') ) return
						$block.addClass('--validating');

						LJ.login.updateProfileFirstLogin()
							.then(function(){

								$block
									.removeClass('--validating')
									.velocity('bounceOut', {
										duration : LJ.login.prompt_duration,
										complete : resolve
									});
								

							}, function( err ){
								LJ.wlog('An error occured');
								LJ.log(err);

							});
					});
				});	
			},
			updateProfileFirstLogin: function(){

				LJ.log('Updating user location for the first time...');

				var place_id   = $('.init-location').attr('data-place-id');
				var place_name = $('.init-location').attr('data-place-name');
				var lat        = $('.init-location').attr('data-place-lat');
				var lng        = $('.init-location').attr('data-place-lng');

				if( !( place_id && place_name && lat && lng) ){
					return LJ.wlog('Missing place attributes on the dom, cannot contine with login');
				}

				var update = {};
				update.location = {
					place_name : place_name,
					place_id   : place_id,
					lat 	   : lat,
					lng 	   : lng
				};

				return LJ.api.updateProfile( update )
						  .then(function( exposed ){
							  	LJ.profile.setMyInformations();
							  	return;
						});

			},
			showPlayButton: function(){

				var $elm = $('.init-location').find('.init-location-action');

				if( $elm.css('opacity') != "0" ) return;

				$elm.velocity('bounceInQuick', {
					duration : LJ.login.prompt_buttons_duration,
					display  : 'flex',
					delay    : 500,
					complete : function(){
						$( this ).addClass('pound-light');
					}
				});

			},
			// Do a bunch of functions right before the login happens
			terminateLoginProcess: function(){

				LJ.ui.activateHtmlScroll();

				$('.curtain')
						.children('.login')
						.velocity('bounceOut', {
							duration: LJ.login.prompt_duration
						});

				$('.curtain')
					.children('.login__bg')
					.velocity({ 'opacity': [ 0, 0.09 ]}, {
						duration: LJ.login.prompt_duration/2,
						complete: function(){
							$(this).remove();
						}
					});

				return LJ.ui.hideCurtain({
					delay: LJ.login.prompt_duration * 1.3,
					duration: 1000

				}).then(function(){
					LJ.before.showBrowser();
					LJ.delay( 250 ).then( LJ.before.showCreateBeforeBtn );
					LJ.before.refreshBrowserDates();
					LJ.map.updateMarkers__byDate();
					return
				});	

			},
			renderLocationPrompt: function(){

				return LJ.ui.render([

					'<div class="init-location">',
						'<div class="init-location__title">',
							'<h2 data-lid="init_location_title"></h2>',
						'</div>',
						'<div class="init-location__subtitle">',
							'<input id="init-location__input" type="text" data-lid="init_location_subtitle_placeholder">',
						'</div>',
						'<div class="init-location__splitter"></div>',
						'<div class="init-location__explanation">',
							'<p data-lid="init_location_explanation"></p>',
						'</div>',
						'<div class="init-location__geoloc">',
							'<button data-lid="init_location_geoloc"></button>',
						'</div>',
						'<div class="init-location-action">',
							'<div class="action__validate --round-icon">',
								'<i class="icon icon-play"></i>',
							'</div>',
						'</div>',
					'</div>'

				].join(''));

			},
			handleLogout: function(){

				LJ.ui.showModal({
					"title"	   : LJ.text("logout_title"),
					"subtitle" : LJ.text("logout_subtitle"),
					"type"     : "logout",
					"footer"   : "<button class='--rounded'><i class='icon icon-power'></i></button>"
				});

			},
			logUserOut: function(){

				var p1 = LJ.ui.shadeModal();
				var p2 = LJ.api.updateUser({
					"app_preferences": {
						ux: {
							auto_login: false
						}
					}
				});

				LJ.Promise.all([ p1, p2 ]).then(function(){
					LJ.store.remove('facebook_access_token');
					location.reload();
				});

			}


	});

	window.LJ.map = _.merge( window.LJ.map || {}, {		

        markers: [],

       	// Called as soon as the script finished loading everything
		init: function(){

			LJ.map.setupMap();

			LJ.map.handleDomEvents();
            LJ.map.handleMapEvents();
			LJ.map.initPlacesServices();

            LJ.before.displayBeforeMarkers( LJ.before.fetched_befores );

            
            return LJ.before.refreshBrowserLocation();
			
		},
        initGeocoder: function(){
            LJ.meegeo = new google.maps.Geocoder();
            return;

        },
        initPlacesServices: function(){
            LJ.meeservices = new google.maps.places.PlacesService( LJ.meemap );
            return;

        },
		sayHello: function(){
			LJ.ilog('Map has been successfully loaded');

		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.map__icon.--geoloc', LJ.map.centerMapAtUserLocation );
			LJ.ui.$body.on('click', '.map__icon.--change-location', LJ.map.toggleMapBrowser );

		},
		setupMap: function(){

			LJ.log('Setting up google map...');

            var latlng = {
                lat: parseFloat( LJ.user.location.lat ),
                lng: parseFloat( LJ.user.location.lng )
            };

			var options = {
				center: latlng,
	            zoom: 13,
	            disableDefaultUI: true,
	            zoomControlOptions: {
	                style    : google.maps.ZoomControlStyle.SMALL,
	                position : google.maps.ControlPosition.RIGHT_TOP
	            },
	            mapTypeControlOptions: {
	                mapTypeIds: ['meemap']
	            }
			}

			var $wrap = document.getElementsByClassName('js-map-wrap')[0];

			LJ.meemap = new google.maps.Map( $wrap, options );
			
            LJ.map.setMapStyle('creamy');
            LJ.map.setMapIcons();
            LJ.map.setMapOverlay();
            LJ.map.setMapBrowser();

            setTimeout(function(){
                LJ.map.refreshMap();
            }, 1000 );

			return;

        },
        setMapStyle: function( map_style ){

        	var custom_style = LJ.map.style[ map_style ];
        	if( !custom_style ){
        		return LJ.wlog('Unable to find a custom style for : ' + map_style );
        	}

        	var styled_map = new google.maps.StyledMapType( custom_style, {
                name: 'meemap'
            });
            // Set map styling 
            LJ.meemap.mapTypes.set('meemap', styled_map );
            LJ.meemap.setMapTypeId('meemap');

        },
        setMapIcons: function(){

        	$('.app-section.--map')
        		.append( LJ.map.renderChangeLocation() )
        		.append( LJ.map.renderGeoLocation() )
                .append( LJ.map.renderCreateBefore() )
        		.append( LJ.map.renderPinLocation() );


        },
        setMapOverlay: function(){

        	$('.app-section.--map')
        		.append( LJ.map.renderMapOverlay() );

        },
        setMapBrowser: function(){

        	$('.app-section.--map')
        		.append( LJ.map.renderMapBrowser() );

            return LJ.seek.activatePlacesInMap()
                    .then(function(){

                    	LJ.seek.map_browser_places.addListener('place_changed', function( place ){

                    		var place  = LJ.seek.map_browser_places.getPlace();
                    		var latlng = place.geometry.location;

                    		LJ.meemap.setCenter( latlng );

                    	});
                        
                    });

        },
        handleMapEvents: function(){

            LJ.meemap.addListener('dragstart', function(){
                LJ.before.preRefreshBrowserLocation();
            });

            LJ.meemap.addListener('dragend', function(){
                LJ.before.refreshBrowserLocation();
            });

            LJ.meemap.addListener('click', function(e){
                
            });
            
            LJ.meemap.addListener('center_changed', function(){
                // LJ.before.refreshNearestBefores();
            });


        },
        refreshMap: function(){
        	return google.maps.event.trigger( LJ.meemap, 'resize' );

        },
        activateDate: function( m ){

            var $date_activated   = $('.be-dates__date.--active');
            var $date_to_activate = $('.be-dates__date[data-day="'+ m.format('DD/MM') +'"]');

             if( $date_to_activate.length != 1 ){
                return LJ.wlog('Unable to find the date : ' + m.format('DD/MM') );
            }

            $date_activated
                .removeClass('--active')
                .find('.be-dates__bar')
                .velocity('bounceOut', { duration: 450, display: 'none' });

            $date_to_activate
                .addClass('--active')
                .find('.be-dates__bar')
                .velocity('bounceInQuick', { duration: 450, display: 'block' });

            // Specifics
            LJ.map.updateMarkers__byDate();

        },
        findLocationWithLatLng: function( latlng ){
            return LJ.promise(function( resolve, reject ){

                if( !latlng ){
                    return LJ.wlog('Cant find address without latlng');
                }

                LJ.meegeo.geocode({ location: latlng }, function( res, status ){

                    if( status === google.maps.GeocoderStatus.OK && res[0] ){
                        resolve( res[0] );
                    } else {
                        reject( status );
                    }
                });

            });


        },
        findAddressWithLatLng: function( latlng ){
            return LJ.map.findLocationWithLatLng( latlng )

                    .then(function( location ){
                        return location.formatted_address;
                    });

        },
        findLatLngWithAddress: function( address ){
        	return LJ.promise(function( resolve, reject ){

	        	if( !address ){
	        		return LJ.wlog('Cant find LatLng without adress');
	        	}

	        	LJ.meegeo.geocode({ address: address }, function( res, status ){

	        		if( status === google.maps.GeocoderStatus.OK && res[0] ){
	        			resolve( res[0].geometry.location );
	        		} else {
	        			reject( status );
	        		}
	        	});

        	});
        	
        },
        getDevicePixelRatio: function(){

            if( window.devicePixelRatio ){
                return window.devicePixelRatio;
            } else {
                return 1;
            }

        },
        findLatLngWithPlaceId: function( place_id ){
        	return LJ.promise(function( resolve, reject ){

	        	if( !place_id ){
	        		return LJ.wlog('Cant find LatLng without place_id');
	        	}

	        	LJ.meegeo.geocode({ placeId: place_id }, function( res, status ){

	        		if( status === google.maps.GeocoderStatus.OK && res[0] ){
	        			resolve( res[0].geometry.location );
	        		} else {
	        			reject( status );
	        		}
	        	});

        	});
        	
        },
        toggleMapBrowser: function(){

        	var $mb = $('.map-browse');

        	if( $mb.hasClass('--active') ){

        		$mb.removeClass('--active');
        		$mb.velocity('shradeOut', { duration: 200, display: 'none' });

        	} else {

        		$mb.addClass('--active');
        		$mb.velocity('shradeIn', { duration: 200, display: 'flex' });

        	}
        },
        centerMapAtUserLocation: function( pan ){

        	var place_id = LJ.user.location.place_id;
        	return LJ.map.findLatLngWithPlaceId( place_id )
        			.then(function( latlng ){
        				pan ? LJ.meemap.panTo( latlng ) : LJ.meemap.setCenter( latlng );
        			});

        },
        distanceBetweenTwoLatLng: function( latlng1, latlng2 ){

            var a = new google.maps.LatLng( latlng1 );
            var b = new google.maps.LatLng( latlng2 );

            return google.maps.geometry.spherical.computeDistanceBetween( a, b );

        },
        shiftLatLng: function( latlng ){

            var a   = new google.maps.LatLng( latlng );
            var rdm =  google.maps.geometry.spherical.computeOffset( a, LJ.randomInt(25,50), LJ.randomInt(0, 180) );

            return {
                lng: rdm.lng(),
                lat: rdm.lat()
            };

        },
        findClosestMarkers: function( latlng, distance ){

            var markers = [];
            LJ.map.markers.forEach(function( mrk ){

                if( LJ.map.distanceBetweenTwoLatLng( latlng, mrk.latlng ) < distance ){
                    markers.push( mrk );
                }

            });

            return markers; 

        },
        offsetLatLng: function( latlng ){

            var offsetted = false;
            LJ.map.markers.forEach(function( mrk ){

                if( LJ.map.distanceBetweenTwoLatLng( latlng, mrk.latlng ) < 100 && !offsetted){

                    LJ.wlog('Markers are too close, shifting latlng');
                    offsetted = true;
                    latlng = LJ.map.shiftLatLng( latlng );

                }
                
            });

            return latlng;

        },
        offsetLatLngRecursive: function( latlng, i ){

            // Display the marker in a more intelligent way, to put it randomy close to where its supposed to be
            // But also taking into account where other markers are places :) 

        },
        validateMarkerOptions: function( opts ){

        	var ok = true;

        	if( !opts.url ){
        		ok = false;
        		LJ.wlog('Cannot add marker without url: %s', opts.url );
        	}
        	if( !opts.latlng ){
        		ok = false;
        		LJ.wlog('Cannot add marker without latlng: %s', opts.latlng );
        	}
        	if( !opts.marker_id ){
        		ok = false;
        		LJ.wlog('Cannot add marker without marke_id: %s', opts.marker_id );
        	}
        	if( !opts.type ){
        		ok = false;
        		LJ.wlog('Cannot add marker without type: %s', opts.tpye );
        	}
        	
        	return ok

        },
        markerAlreadyExists: function( marker_id ){

            return _.find( LJ.map.markers, function( mrk ){
                return mrk && (mrk.marker_id == marker_id );
            });
            
        },
        makeIcon: function( url ){
            return {
                url        : url,
                scaledSize : new google.maps.Size( 27, 31 )
            };

        },
        addMarker: function( opts ){

        	if( !LJ.map.validateMarkerOptions( opts ) ) return;

            if( LJ.map.markerAlreadyExists( opts.marker_id ) ){
                return LJ.wlog('A marker with id : ' + opts.marker_id + ' is already set on the map');
            }

            var latlng = LJ.map.offsetLatLng( opts.latlng );
            var icon   = LJ.map.makeIcon( opts.url );

        	var marker = new google.maps.Marker({
                map        : LJ.meemap,
                position   : latlng,
                icon       : icon
            });

            var data = opts.data || null;

        	// Store the reference for further usage
        	LJ.map.markers.push({
        		marker_id : opts.marker_id,
        		marker 	  : marker,
        		data      : data,
                type      : opts.type,
                latlng    : latlng
        	});

        	// Attach listenres if there are any
        	if( Array.isArray( opts.listeners )){
                opts.listeners.forEach(function( listener ){
                    marker.addListener( listener.event_type, function(){
                    	listener.callback( marker, data );
                    });
                });

            }

        },
        getBeforeMarkerUrlByType: function( type ){

            var px  = LJ.map.getDevicePixelRatio() + 'x';

            if( type == 'drink' ){
                url = LJ.map.markers_url['drink'];
            }

            if( type == 'drinknew' ){
                url = LJ.map.markers_url['drinknew'];
            }

            if( type == 'hosting' ){
                url = LJ.map.markers_url['chat'];
            }

            if( type == 'pending' ){
                url = LJ.map.markers_url['pending'];
            }

            if( type == 'accepted' ){
                url = LJ.map.markers_url['chat'];
            }

            return url[ px ];


        },  
        getBeforeMarkerUrl: function( before ){

            var url  = null;

            var my_before = _.find( LJ.user.befores, function( bfr ){
                return bfr.before_id == before._id;
            });

            if( !my_before ){
                // Moment.js expresses the difference between 2 dates in ms
                var diff_in_hour = (moment() - moment( before.created_at ))/(3600*1000);
                if( diff_in_hour > 24 ){
                    url = LJ.map.getBeforeMarkerUrlByType("drink");

                } else {
                    url = LJ.map.getBeforeMarkerUrlByType("drinknew");

                }

            } else {
                url = LJ.map.getBeforeMarkerUrlByType( my_before.status );
            }

            if( !url ){
                return LJ.wlog('Cant render marker, unable to find marker type');

            } else {
                return url;
            }

        },
        // Before must be the whole before object and not an itemized version;
        addBeforeMarker: function( before ){

        	var before_id = before._id;

            var latlng  = {
                lat: before.address.lat,
                lng: before.address.lng
            };

           var url = LJ.map.getBeforeMarkerUrl( before );

            LJ.map.addMarker({
                marker_id : before_id,
                latlng    : latlng,
                url       : url,
                type      : 'before',
                data      : before,
                listeners : [
                    {
                        'event_type': 'click',
                        'callback'  : LJ.map.handleClickOnEventMarker
                    }]

            });

        },
        removeBeforeMarker: function( before_id ){

            LJ.map.markers.forEach(function( mrk, i){

                if( mrk.marker_id == before_id ){
                    mrk.marker.setMap( null );
                    delete LJ.map.markers[ i ];
                }

            });

        },
        handleClickOnEventMarker: function( marker, before ){

            LJ.log(marker);

            LJ.before.showBeforeInview( before );


        },
        renderCreateBefore: function(){

            return LJ.ui.render([
                '<div class="map__icon --round-icon --create-before js-create-before">',
                    '<i class="icon icon-plus"></i>',
                '</div>'
                ].join(''));

        },
        renderChangeLocation: function(){

        	return LJ.ui.render([
        		'<div class="map__icon --round-icon --change-location js-map-change-location">',
        			'<i class="icon icon-search-planet"></i>',
        		'</div>'
        		].join(''));

        },
        renderGeoLocation: function(){

        	return LJ.ui.render([
        		'<div class="map__icon --round-icon --geoloc js-map-geoloc">',
        			'<i class="icon icon-geoloc"></i>',
        		'</div>'
        		].join(''));
        },
        renderPinLocation: function(){

        	return LJ.ui.render([
        		'<div class="map__icon --round-icon --location js-map-location">',
        			'<i class="icon icon-location"></i>',
        		'</div>'
        		].join(''));
        },
        renderMapOverlay: function(){

        	return LJ.ui.render([
        		'<div class="map__overlay"></div>'
        		].join(''));

        },
        renderMapBrowser: function(){

        	return LJ.ui.render([
        		'<div class="map-browse">',
        			'<input id="map-browser-input"/>',
        		'</div>'
        		].join(''));

        },
        updateMarkers__byDate: function(){

            var active_day = moment( $('.be-dates__date.--active').attr('data-day'), 'DD/MM' ).dayOfYear();

            LJ.map.markers.forEach(function( mrk ){

                if( mrk.type == "before" ){

                    if( mrk.data && mrk.data.begins_at && moment( mrk.data.begins_at ).dayOfYear() == active_day ){
                        mrk.marker.setOpacity( 1 );
                    } else {
                        mrk.marker.setOpacity( 0.15 );
                    }

                }

            });
        }


	});		

	
	testClearAllMarkers = function(){
		if( LJ.map.marker_test ){

			LJ.map.marker_test.forEach(function(mrk){
				mrk.marker.setMap(null);
			});
		}			
	};	






	window.LJ.map = _.merge( window.LJ.map || {}, {


		renderEventMapview_User: function( evt ){

			return LJ.fn.renderEventMapview( evt, {
				request_html: '<button  data-lid="e_preview_participate" class="theme-btn btn-requestin mapview-action__btn">Participer</div>'
			});

		},
		renderEventMapview_MemberPending: function( evt ){

			return LJ.fn.renderEventMapview( evt, {
				request_html: '<button  data-lid="e_preview_pending" class="theme-btn btn-jumpto mapview-action__btn">Participer</div>'
			});

		},
		renderEventMapview_MemberAccepted: function( evt ){

			return LJ.fn.renderEventMapview( evt, {
				request_html: '<button  data-lid="e_preview_chat" class="theme-btn btn-jumpto mapview-action__btn">Participer</div>'
			});

		},
		renderEventMapview_Host: function( evt ){

			return LJ.fn.renderEventMapview( evt, {
				request_html: '<button  data-lid="e_preview_manage" class="theme-btn btn-jumpto mapview-action__btn">Participer</div>'
			});

		},
		renderEventMapview: function( evt, opts ){

			//Hosts pictures 
			var hosts_pictures_html = '';

			hosts_pictures_html = '<div class="mapview-hosts">';
			evt.hosts.forEach(function( host ){

			var display_params     = LJ.cloudinary.events.mapview.hosts.params;
			display_params.version = LJ.fn.findMainImage( host ).img_version;

			var img_tag = $.cloudinary.image( LJ.fn.findMainImage( host ).img_id, display_params ).prop('outerHTML');
			var country = '<div class="user-flag mapview-host__flag"><span class="flag-icon flag-icon-' + host.country_code + '"></span></div>';

			hosts_pictures_html += '<div class="mapview-host" data-userid="' + host.facebook_id + '">' 
										+ img_tag + country 
									+'</div>'

			});
			hosts_pictures_html += '</div>';


			// Context
			var context_html = '<div class="mapview-context">';

			// Address
			var address_html = '';
			address_html += '<div class="mapview-address mapview-context__element">'
				+ '<i class="mapview-address__icon icon icon-location mapview-context__icon"></i>'
				+ '<div class="mapview-address__name">'+evt.address.place_name+'</div>'
			+'</div>';

			// Date
			var date = moment( evt.begins_at ).format('DD/MM');
			var hour = moment( evt.begins_at ).format('HH/MM').replace('/', 'H');

			var date_html = ['<div class="mapview-date mapview-context__element">',
				'<i class="icon icon-calendar mapview-context__icon mapview-date__icon"></i>',
				'<div class="mapview-date__day">'+ date +'</div>',
				'<div class="mapview-date__splitter">, </div>',
				'<div class="mapview-date__hour">'+ hour +'</div>',
			'</div>'].join('');


			// Host names
			var hosts_names_html = '<div class="mapview-hostnames mapview-context__element">';
			evt.hosts.forEach(function( host ){ hosts_names_html += '<div class="mapview-hostnames__name">'+ host.name +'</div>'; });
			hosts_names_html += '</div>';

			context_html += address_html;
			context_html += date_html;
			context_html += hosts_names_html;

			context_html += '</div>';


			// Action buttons
			var action_html = ['<div class="mapview-action">',
			opts.request_html,
			'</div>'].join('');

			// Main HTML
			var divider_html = '<div class="mapview__divider--md"></div>';
			var close_html   = '<i class="mapview__close icon icon-minus"></i>';

			var html = '<div class="mapview mapview--event" data-eventid="'+evt._id+'">'
							+ close_html
							+ hosts_pictures_html
							+ divider_html
							+ context_html
							+ divider_html
							+ action_html
					  '</div>';


			return LJ.fn.translateView( html );


		},
		renderPartyMapview_Event: function( party, opts ){

			// Icon party to ambience everyone
			var main_icon_html = [
				'<div class="mapview-main-icon">',
					'<i class="icon icon-glass mapview-main-icon__icon"></i>',
				'</div>'
			].join('');


			// Party context & various informations
			var context_html = '<div class="mapview-context mapview-context--party">';

			// Address
			var address_html = '';
			address_html += '<div class="mapview-address mapview-context__element">'
								+ '<i class="mapview-address__icon icon icon-location mapview-context__icon"></i>'
								+ '<div class="mapview-address__name">'+ party.address.place_name +'</div>'
							+'</div>';


			// Closing context part
			context_html += address_html;
			context_html += '</div>';

			var divider_html = '<div class="mapview__divider--md"></div>';
			var close_html   = '<i class="mapview__close icon icon-minus"></i>';

			var html = '<div class="mapview mapview--party" data-placeid="'+ party.address.place_id +'">'
				+ close_html
				+ context_html
				+ '</div>'

			return LJ.fn.translateView( html );


		},
		renderPartyMapview_Party: function( party ){

			LJ.fn.renderPartyPreview_Event( party );

		},
		renderPartyMapview_Empty: function( party ){

			var context_html = [
				'<div class="mapview-context">',
					'<div class="mapview-address mapview-context__element">',
					'<i class="mapview-address__icon icon icon-location mapview-context__icon"></i>',
					'<div class="mapview-address__name">'+ party.address.place_name +'</div>',
				'</div>',
				'<div class="mapview-emptytext mapview-context__element">',
					'<i class="mapview-emptytext__icon icon icon-star-empty mapview-context__icon"></i>',
					'<div class="mapview-emptytext__name" data-lid="e_mapview_empty_text">...</div>',
					'</div>',
				'</div>'
			].join('');

			var action_html = [
				'<div class="mapview-action">',
					'<div class="theme-btn mapview-action__btn js-create-event" data-lid="e_mapview_first_to_create">...</div>',
				'</div>'
			].join('');

			var divider_html = '<div class="mapview__divider--md"></div>';
			var close_html   = '<i class="mapview__close icon icon-minus"></i>';

			var html = [
				'<div class="mapview mapview-empty mapview--party">',
					close_html,
					context_html,
					divider_html,
					action_html,
				'</div>'
			].join('');

			return LJ.fn.translateView( html );

		}
	});

	window.LJ.map = _.merge( window.LJ.map || {}, {
        
		markers_url: {
            
			drink: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462314105/marker_dark_drink_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462313591/marker_dark_drink_2x.png'
            },
            drink_active: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_blue_drink_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_blue_drink_2x.png'
            },
            drinknew: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_dark_drinknew_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_dark_drinknew_2x.png'
            },
            drinknew_active: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_blue_drinknew_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_blue_drinknew_2x.png'
            },
            star: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462314105/marker_dark_star_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462313591/marker_dark_star_2x.png'
            },
            star_active: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_blue_star_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_blue_star_2x.png'
            },
            pending: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462314105/marker_dark_pending_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462313591/marker_dark_pending_2x.png'
            },
            pending_active: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_blue_pending_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_blue_pending_2x.png'
            },
            chat: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462314105/marker_dark_chat_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462313591/marker_dark_chat_2x.png'
            },
            chat_active: {
                '1x': 'http://res.cloudinary.com/radioreve/image/upload/v1462358245/marker_blue_chat_1x.png',
                '2x': 'http://res.cloudinary.com/radioreve/image/upload/v1462357673/marker_blue_chat_2x.png'
            }
        }

	});

	window.LJ.map = _.merge( window.LJ.map || {}, {


	});

window.LJ.map.style = _.merge(window.LJ.map.style || {}, {
    snow: [{
        "featureType": "administrative",
        "elementType": "all",
        "stylers": [{
            "visibility": "simplified"
        }, {
            "hue": "#ff0000"
        }, {
            "weight": "0.27"
        }]
    }, {
        "featureType": "administrative",
        "elementType": "labels.text.fill",
        "stylers": [{
            "color": "#444444"
        }]
    }, {
        "featureType": "administrative.country",
        "elementType": "geometry.fill",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "administrative.locality",
        "elementType": "all",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "administrative.neighborhood",
        "elementType": "all",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "administrative.land_parcel",
        "elementType": "all",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "landscape",
        "elementType": "all",
        "stylers": [{
            "visibility": "on"
        }, {
            "color": "#fdfdfd"
        }]
    }, {
        "featureType": "landscape.man_made",
        "elementType": "geometry",
        "stylers": [{
            "visibility": "on"
        }, {
            "hue": "#ff0000"
        }]
    }, {
        "featureType": "landscape.man_made",
        "elementType": "geometry.fill",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "landscape.man_made",
        "elementType": "geometry.stroke",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "landscape.natural.terrain",
        "elementType": "geometry.fill",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "landscape.natural.terrain",
        "elementType": "geometry.stroke",
        "stylers": [{
            "hue": "#ff0000"
        }]
    }, {
        "featureType": "poi",
        "elementType": "all",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "poi.park",
        "elementType": "all",
        "stylers": [{
            "visibility": "simplified"
        }, {
            "hue": "#37ff00"
        }, {
            "lightness": "70"
        }]
    }, {
        "featureType": "poi.school",
        "elementType": "geometry",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "poi.school",
        "elementType": "labels",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "poi.sports_complex",
        "elementType": "geometry",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "poi.sports_complex",
        "elementType": "labels.text",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "road",
        "elementType": "all",
        "stylers": [{
            "saturation": -100
        }, {
            "lightness": 45
        }, {
            "visibility": "simplified"
        }]
    }, {
        "featureType": "road",
        "elementType": "geometry",
        "stylers": [{
            "visibility": "simplified"
        }]
    }, {
        "featureType": "road",
        "elementType": "labels",
        "stylers": [{
            "color": "#a39bb2"
        }]
    }, {
        "featureType": "road",
        "elementType": "labels.icon",
        "stylers": [{
            "visibility": "simplified"
        }]
    }, {
        "featureType": "road.highway",
        "elementType": "all",
        "stylers": [{
            "visibility": "simplified"
        }]
    }, {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [{
            "hue": "#ff0000"
        }, {
            "weight": "0.65"
        }]
    }, {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [{
            "weight": "0.20"
        }, {
            "lightness": "82"
        }, {
            "gamma": "1.19"
        }, {
            "saturation": "-42"
        }, {
            "color": "#d59ca6"
        }]
    }, {
        "featureType": "road.highway",
        "elementType": "labels",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "road.highway.controlled_access",
        "elementType": "all",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "road.highway.controlled_access",
        "elementType": "labels",
        "stylers": [{
            "visibility": "off"
        }, {
            "lightness": "16"
        }]
    }, {
        "featureType": "road.highway.controlled_access",
        "elementType": "labels.icon",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "road.arterial",
        "elementType": "geometry",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "road.arterial",
        "elementType": "geometry.stroke",
        "stylers": [{
            "visibility": "on"
        }, {
            "weight": "0.4"
        }, {
            "color": "#dbdbdb"
        }, {
            "lightness": "10"
        }]
    }, {
        "featureType": "road.arterial",
        "elementType": "labels.icon",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "road.local",
        "elementType": "all",
        "stylers": [{
            "visibility": "simplified"
        }]
    }, {
        "featureType": "road.local",
        "elementType": "geometry.fill",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "road.local",
        "elementType": "geometry.stroke",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "transit",
        "elementType": "all",
        "stylers": [{
            "visibility": "on"
        }]
    }, {
        "featureType": "transit.line",
        "elementType": "all",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "transit.station",
        "elementType": "all",
        "stylers": [{
            "visibility": "off"
        }]
    }, {
        "featureType": "water",
        "elementType": "all",
        "stylers": [{
            "color": "#dae7f2"
        }, {
            "visibility": "on"
        }]
    }],
    creamy: [{
        "featureType": "landscape",
        "stylers": [{
            "hue": "#FFBB00"
        }, {
            "saturation": 43.400000000000006
        }, {
            "lightness": 37.599999999999994
        }, {
            "gamma": 1
        }]
    }, {
        "featureType": "road.highway",
        "stylers": [{
            "hue": "#FFC200"
        }, {
            "saturation": -61.8
        }, {
            "lightness": 45.599999999999994
        }, {
            "gamma": 1
        }]
    }, {
        "featureType": "road.arterial",
        "stylers": [{
            "hue": "#FF0300"
        }, {
            "saturation": -100
        }, {
            "lightness": 51.19999999999999
        }, {
            "gamma": 1
        }]
    }, {
        "featureType": "road.local",
        "stylers": [{
            "hue": "#FF0300"
        }, {
            "saturation": -100
        }, {
            "lightness": 52
        }, {
            "gamma": 1
        }]
    }, {
        "featureType": "water",
        "stylers": [{
            "hue": "#0078FF"
        }, {
            "saturation": -13.200000000000003
        }, {
            "lightness": 2.4000000000000057
        }, {
            "gamma": 1
        }]
    }, {
        "featureType": "poi",
        "stylers": [{
            "hue": "#00FF6A"
        }, {
            "saturation": -1.0989010989011234
        }, {
            "lightness": 11.200000000000017
        }, {
            "gamma": 1
        }]
    }]
});

window.LJ.map = _.merge( window.LJ.map || {}, {

	test: {

		addOneMarker_Url: function( url ){

			var i = LJ.randomInt( 0, LJ.map.test.places.length -1 );
			var latlng = LJ.map.test.places[ i ];	
			
			LJ.map.addMarker({
				latlng    : latlng,
				url       : url,
				type      : 'test',
				marker_id : 'test-' + LJ.generateId()
			})		

		},
		addOneMarker: function( i ){

			i = i || LJ.randomInt( 0, LJ.map.test.places.length -1 );
			var latlng = LJ.map.test.places[ i ];

			LJ.map.addBeforeMarker({
				_id    : i + '--' + LJ.generateId(),
				address: {
					place_id : 'lol',
					'lat'    : latlng.lat,
					'lng' 	 : latlng.lng
				},
				begins_at: _.shuffle(LJ.before.test.iso_dates)[0]
			});

		},
		showMarkers: function(){
			LJ.map.test.places.forEach(function( latlng, i ){
				LJ.map.test.addOneMarker( i );
			});
		},
		buildPlaces: function(){

			LJ.meemap.addListener('click', function( e ){
				LJ.map.findLocationWithLatLng( e.latLng )
					.then(function( location ){
						LJ.map.test.places.push({
							place_name: location.formatted_address,
							place_id  : location.place_id,
							lat       : e.latLng.lat(),
							lng 	  : e.latLng.lng()
						});
					});
			});

		},
		places: [
			{
		        "place_name": "50 Boulevard Voltaire, 75011 Paris, France",
		        "place_id": "ChIJBUAfVPxt5kcRS88-nrqe0Mw",
		        "lat": 48.8630208493969,
		        "lng": 2.3704749436319617
		    },
		    {
		        "place_name": "16 Rue Dugommier, 75012 Paris, France",
		        "place_id": "ChIJ1WUGhWty5kcRY2JuVjGxkOw",
		        "lat": 48.83975198504333,
		        "lng": 2.391417631620243
		    },
		    {
		        "place_name": "157 Rue du Chteau des Rentiers, 75013 Paris, France",
		        "place_id": "ChIJZRaVxYlx5kcRwiZA6MdV-9g",
		        "lat": 48.82867853499684,
		        "lng": 2.3634368271768835
		    },
		    {
		        "place_name": "21 Passage Montbrun, 75014 Paris, France",
		        "place_id": "EigyMSBQYXNzYWdlIE1vbnRicnVuLCA3NTAxNCBQYXJpcywgRnJhbmNl",
		        "lat": 48.82822650545324,
		        "lng": 2.3291045517862585
		    },
		    {
		        "place_name": "92-100 Boulevard du Montparnasse, 75014 Paris, France",
		        "place_id": "EjU5Mi0xMDAgQm91bGV2YXJkIGR1IE1vbnRwYXJuYXNzZSwgNzUwMTQgUGFyaXMsIEZyYW5jZQ",
		        "lat": 48.84235050134804,
		        "lng": 2.328417906278446
		    },
		    {
		        "place_name": "29 Rue Dombasle, 75015 Paris, France",
		        "place_id": "ChIJn89KGkBw5kcR-gtCxLs84DE",
		        "lat": 48.83613643374479,
		        "lng": 2.298377165311649
		    },
		    {
		        "place_name": "121 Rue Saint-Jacques, 75005 Paris, France",
		        "place_id": "ChIJO537Cudx5kcRHlyK46hFZEQ",
		        "lat": 48.84867675994344,
		        "lng": 2.3457557053507117
		    },
		    {
		        "place_name": "132 Boulevard de Charonne, 75020 Paris, France",
		        "place_id": "ChIJrbkp-olt5kcRZIKCJOkaQ14",
		        "lat": 48.85545400732256,
		        "lng": 2.3953658432901648
		    },
		    {
		        "place_name": "1 Cit de l'Ermitage, 75020 Paris, France",
		        "place_id": "ChIJj9Qqb5Nt5kcRof-N1p88Vw8",
		        "lat": 48.86957032627758,
		        "lng": 2.3922759385050085
		    },
		    {
		        "place_name": "40 Quai de Jemmapes, 75010 Paris, France",
		        "place_id": "ChIJ52rI3Alu5kcRTNSL-ANtmsE",
		        "lat": 48.86934449651679,
		        "lng": 2.3672133774698523
		    },
		    {
		        "place_name": "115 Rue Raumur, 75002 Paris, France",
		        "place_id": "ChIJS-wuAz1u5kcRIzAAtPyAXgg",
		        "lat": 48.86821533242417,
		        "lng": 2.3426658005655554
		    },
		    {
		        "place_name": "115 Rue Saint-Dominique, 75007 Paris, France",
		        "place_id": "ChIJXYBKLt9v5kcRMPaVcBVFqfs",
		        "lat": 48.85895522569791,
		        "lng": 2.304900297635868
		    },
		    {
		        "place_name": "3 Rue de Lourmel, 75015 Paris, France",
		        "place_id": "ChIJvxSayBtw5kcR9jRaZn6tw0Y",
		        "lat": 48.850258199721495,
		        "lng": 2.2923690171182898
		    },
		    {
		        "place_name": "64 Avenue Victor Hugo, 75116 Paris, France",
		        "place_id": "ChIJV42nCPFv5kcR2zE8Exqq-uw",
		        "lat": 48.87047363512827,
		        "lng": 2.2865325303018835
		    },
		    {
		        "place_name": "44 Rue de Rome, 75008 Paris, France",
		        "place_id": "ChIJQeqxR7Vv5kcRGeKJKSkSCfY",
		        "lat": 48.87792531090652,
		        "lng": 2.3236113877237585
		    },
		    {
		        "place_name": "7 Boulevard de Rochechouart, 75009 Paris, France",
		        "place_id": "ChIJJxdCsGlu5kcRPp5zWKxWq0c",
		        "lat": 48.8832311306673,
		        "lng": 2.348845610135868
		    },
		    {
		        "place_name": "155 Rue de Rome, 75017 Paris, France",
		        "place_id": "ChIJQVlaJLBv5kcRxJknss5CnGw",
		        "lat": 48.8866175298428,
		        "lng": 2.3151999802530554
		    },
		    {
		        "place_name": "45 Boulevard de Rochechouart, 75009 Paris, France",
		        "place_id": "EjE0NSBCb3VsZXZhcmQgZGUgUm9jaGVjaG91YXJ0LCA3NTAwOSBQYXJpcywgRnJhbmNl",
		        "lat": 48.882328052158506,
		        "lng": 2.343352446073368
		    },
		    {
		        "place_name": "41 Rue de la Chapelle, 75018 Paris, France",
		        "place_id": "ChIJWWWH03xu5kcRXwkbrq-Plxo",
		        "lat": 48.89338964026286,
		        "lng": 2.358801969999149
		    },
		    {
		        "place_name": "43-45 Rue de l'Evangile, 75018 Paris, France",
		        "place_id": "Eiw0My00NSBSdWUgZGUgbCdFdmFuZ2lsZSwgNzUwMTggUGFyaXMsIEZyYW5jZQ",
		        "lat": 48.89395394139533,
		        "lng": 2.367041716092899
		    },
		    {
		        "place_name": "10 Rue de l'Encheval, 75019 Paris, France",
		        "place_id": "ChIJ0UA45sBt5kcRH8AEd97H0vc",
		        "lat": 48.87905425586569,
		        "lng": 2.3891860337198523
		    },
		    {
		        "place_name": "17 Rue Vitruve, 75020 Paris, France",
		        "place_id": "ChIJ59Ierodt5kcRLJVhtGyE6Fk",
		        "lat": 48.85703523304221,
		        "lng": 2.402747282499149
		    },
		    {
		        "place_name": "9 Rue de la Rvolution, 93100 Montreuil, France",
		        "place_id": "ChIJx0cAjGFt5kcRJdx3tOBZV8U",
		        "lat": 48.85601873652745,
		        "lng": 2.4291831345499304
		    },
		    {
		        "place_name": "7 Place de la Republique, 92110 Clichy, France",
		        "place_id": "ChIJXe6oJA9v5kcR2gOs5pzwe2w",
		        "lat": 48.90309473234857,
		        "lng": 2.3124533982218054
		    },
		    {
		        "place_name": "22 Rue Saint-Pierre, 92200 Neuilly-sur-Seine, France",
		        "place_id": "ChIJ6WfmJmRl5kcRnhsL-FQlZ7U",
		        "lat": 48.883118246745475,
		        "lng": 2.2717696518839148
		    },
		    {
		        "place_name": "1 Avenue Andr Morizet, 92100 Boulogne-Billancourt, France",
		        "place_id": "ChIJY25Wt-h65kcRaYJKfJ1WavU",
		        "lat": 48.83365059084553,
		        "lng": 2.2425872178018835
		    },
		    {
		        "place_name": "87 Rue du Point du Jour, 92100 Boulogne-Billancourt, France",
		        "place_id": "ChIJU0YgEO165kcRu1yP4bPfHFI",
		        "lat": 48.829582581850715,
		        "lng": 2.250311979764774
		    },
		    {
		        "place_name": "31 Avenue Verdier, 92120 Montrouge, France",
		        "place_id": "ChIJrWyMvf9w5kcRkZ4Wg0nGaJo",
		        "lat": 48.815228912154815,
		        "lng": 2.3169165940225867
		    },
		    {
		        "place_name": "68 Avenue Raspail, 94250 Gentilly, France",
		        "place_id": "ChIJt4bSOnRx5kcRIVVq02VkWAw",
		        "lat": 48.81251594581754,
		        "lng": 2.3455840439737585
		    },
		    {
		        "place_name": "22 Quai d'Orlans, 75004 Paris, France",
		        "place_id": "ChIJ0aztRONx5kcRiYkOqMVLaao",
		        "lat": 48.851726634791916,
		        "lng": 2.354338774198368
		    },
		    {
		        "place_name": "7-11 Quai de Conti, 75006 Paris, France",
		        "place_id": "Eic3LTExIFF1YWkgZGUgQ29udGksIDc1MDA2IFBhcmlzLCBGcmFuY2U",
		        "lat": 48.8568093467116,
		        "lng": 2.3402625412882117
		    },
		    {
		        "place_name": "42 Quai des Orfvres, 75001 Paris, France",
		        "place_id": "ChIJA6bfiN9x5kcR_FBUHRIFm7M",
		        "lat": 48.85579284560999,
		        "lng": 2.342322477811649
		    },
		    {
		        "place_name": "5-7 Rue du Sabot, 75006 Paris, France",
		        "place_id": "EiU1LTcgUnVlIGR1IFNhYm90LCA3NTAwNiBQYXJpcywgRnJhbmNl",
		        "lat": 48.85251731276075,
		        "lng": 2.3316794724405554
		    },
		    {
		        "place_name": "9 Avenue de Lowendal, 75007 Paris, France",
		        "place_id": "ChIJTZPVeCZw5kcRb-MkJcrj1mw",
		        "lat": 48.85217845230312,
		        "lng": 2.3081618637979773
		    },
		    {
		        "place_name": "23 Rue de la Forge Royale, 75011 Paris, France",
		        "place_id": "ChIJDd0e4ghy5kcRiAMxGj3923o",
		        "lat": 48.85206549830757,
		        "lng": 2.380602964872196
		    }
		]
	}

});




	window.LJ.menu = _.merge( window.LJ.menu || {}, {

		$menu: $('.menu'),
		shrink_menu_height_limit: 0,
		menu_slide_duration: 240,

		init: function(){

			LJ.menu.handleDomEvents();
			LJ.menu.activateMenuSection('profile');
			LJ.menu.shrinkMenu();

			return;

		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.menu-item', LJ.menu.showMenuItem );
			LJ.ui.$window.on('scroll', _.debounce( LJ.menu.handleMenuApparition, 100 ) );

		},
		showMenuItem: function(){

			var $self = $(this);

			var section_id = $self.attr('data-link');
			LJ.menu.activateMenuSection( section_id );

		},
		activateMenuSection: function( section_id ){	

			var current_section_id = $('.menu-item.--active').attr('data-link');

			var $menu_item_activated    = $('.menu-item[data-link="' + current_section_id + '"]');
			var $menu_item_to_activate  = $('.menu-item[data-link="' + section_id + '"]');

			var $menu_block_activated   = $('.menu-section[data-link="' + current_section_id + '"]');
			var $menu_block_to_activate = $('.menu-section[data-link="' + section_id + '"]');


			if( !current_section_id ){
				$menu_item_to_activate.addClass('--active');
				return $('.app-section.--menu').find('[data-link="' + section_id + '"]').css({ 'display': 'flex' });
			}

			if( section_id == current_section_id ){
				
				if( current_section_id == "shared" ){
					return LJ.shared.handleShareClicked();
				}
				if( current_section_id == "cheers" ){
					return LJ.cheers.handleCheersClicked();
				}
				if( current_section_id == "friends" ){
					return LJ.friends.handleFriendsClicked();
				}

				return LJ.log('Section is already activated');
			}

			$menu_item_activated
				.removeClass('--active')
				.find('.menu-item__bar')
				.velocity('bounceOut', { duration: 450, display: 'none' });

			$menu_item_to_activate
				.addClass('--active')
				.find('.menu-item__bar')
				.velocity('bounceInQuick', { duration: 450, display: 'block' });

			$menu_block_activated.hide();
			$menu_block_to_activate.css({ display: 'flex' });

			// Specifics
			section_id == "friends" ?
				LJ.friends.displayInviteFriendsPopup():
				LJ.friends.hideInviteFriendsPopup();


		},
		handleMenuApparition: function( e ){
			
			return;

			var current_scrolltop = LJ.ui.$window.scrollTop();

			if( LJ.ui.getScrollDirection() == "down" && LJ.ui.scrolltop > LJ.menu.shrink_menu_height_limit && $('--resizing').length == 0 ){
				LJ.menu.shrinkMenu();
			}

			if( LJ.ui.getScrollDirection() == "up" && LJ.ui.scrolltop < LJ.menu.shrink_menu_height_limit  && $('--resizing').length == 0 ){
				LJ.menu.expandMenu();
			}

				
		},
		toggleMenuState: function(){

			var $m = LJ.menu.$menu;

			if( $m.hasClass('--downsized') ){
				LJ.menu.expandMenu();
			} else {
				LJ.menu.shrinkMenu();
			}

		},
		shrinkMenu: function(){

			var $m = LJ.menu.$menu;

			if( $m.hasClass('--downsized') || $m.hasClass('--resizing') ) return;

			$m.addClass('--resizing');
			$m.velocity('slideUpOut', {
				duration: LJ.menu.menu_slide_duration,
				complete: function(){

					if( LJ.ui.scrolltop < LJ.menu.shrink_menu_height_limit ){
						return $m.velocity('slideDownIn', {
							duration: LJ.menu.menu_slide_duration,
							display: 'flex',
							complete: function(){
								$m.removeClass('--resizing');
							}
						})
					}

					$m.addClass('--downsized');
					$m.closest('.app-section').addClass('--downsized');
					$m.removeClass('--resizing');
					$m.velocity('slideDownIn', {
						duration: LJ.menu.menu_slide_duration,
						display: 'flex'
					});

				}
			});

		},
		expandMenu: function(){

			var $m = LJ.menu.$menu;

			if( !$m.hasClass('--downsized') || $m.hasClass('--resizing') ) return;

			$m.addClass('--resizing');
			$m.velocity('slideUpOut', {
				duration: LJ.menu.menu_slide_duration,
				complete: function(){

					$m.removeClass('--resizing');
					$m.removeClass('--downsized')
					$m.closest('.app-section').removeClass('--downsized');
					$m.velocity('slideDownIn', {
						duration: LJ.menu.menu_slide_duration,
						display: 'flex'
					});

				}
			});

		}

	});

	window.LJ.meepass = _.merge( window.LJ.meepass || {}, {

		init: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.meepass.handleDomEvents();
				resolve();
			});


		},
		handleDomEvents: function(){

			$('.menu-section.--meepass').on('click', '.segment__part', LJ.meepass.refreshSegmentView );
			$('.menu-item.--meepass').one('click', LJ.meepass.handleMeepassClicked );
			LJ.ui.$body.on('click', '.js-send-meepass', LJ.meepass.handleSendMeepass );

		},
		refreshSegmentView: function(){

			var $seg = $(this);
			var link = $seg.attr('data-link');

			if( $seg.hasClass('--active') ) return;

			$seg.siblings().removeClass('--active');
			$seg.addClass('--active');

			$('.meepass').children().css({ display: 'none' });
			$('.meepass [data-link="' + link + '"]').css({ display: 'flex' });

		},
		handleSendMeepass: function(){

			// User is hosting more than one event...
			if( 0 ){
				LJ.ui.showModal({
					"title"		: "Flicitations !",
					"subtitle"	: "Vous allez dsormais pouvoir crer votre propre vnement priv avec vos amis.",
					"body"  	: LJ.meepass.renderEventsInModal(),
					"footer"	: "<button class='--rounded'><i class='icon icon-check'></i></button>"
				});

			} else {
				
				var event_id = '';
			//	LJ.meepass.sendMeepass()
			//		.then( LJ.meepass.handleSendMeepassSuccess )
			//		.catch( LJ.meepass.handleApiError );

			}

		},
		renderMeepassRibbon: function(){

			var n_meepass = LJ.user.meepass.length;

			return LJ.ui.render([

				'<div class="meepass-ribbon">',
					'<h2 data-lid="meepass_ribbon"></h2>',
				'</div>'

				].join('')).replace('%n', n_meepass );

		},
		sendMeepass: function(){
			
		},
		handleSendMeepassSuccess: function(){

		},
		handleApiError: function(){

		},
		renderEventsInModal: function(){

		},
		handleMeepassClicked: function(){

			var $loader = $( LJ.static.renderStaticImage('menu_loader') );

			$('.meepass').html('');

			$loader.addClass('none')
				   .appendTo('.meepass')
				   .velocity('bounceInQuick', {
				   	delay: 125,
				   	duration: 500,
				   	display: 'block'
				   });

			LJ.meepass.fetchMeepassItems();

		},	
		fetchMeepassItems: function(){

			LJ.api.fetchMeMeepass()
				  .then( LJ.meepass.handleFetchMeMeepassSuccess, LJ.meepass.handleFetchMeMeepassError );


		},
		handleFetchMeMeepassSuccess: function( expose ){

			var meepass = expose.meepass;

			LJ.meepass.setMeepassItems( meepass );

		},
		setMeepassItems: function( meepass ){

			var html = [];
			meepass.sort();

			var facebook_ids = _.pluck( meepass, 'sent_by' ).concat( _.pluck( meepass, 'sent_to' ) ).filter( Boolean );

			LJ.api.fetchUsers( facebook_ids )
				.then(function( res ){

					var no_meepass_received = true;
					var no_meepass_sent     = true;
					meepass.forEach(function( mp ){

						for( var i=0; i<res.length; i++ ){

							var user = res[ i ].user;

							if( mp.sent_by == user.facebook_id ){
								no_meepass_received = false;
								return html.push( LJ.meepass.renderMeepassItem__Received( mp, user ) );
							}

							if( mp.sent_to == user.facebook_id ){
								no_meepass_sent = false;
								return html.push( LJ.meepass.renderMeepassItem__Sent( mp, user ) );
							}
						}
					});

					if( no_meepass_sent ){
						html.push( LJ.meepass.renderMeepassItem__SentEmpty() );
					}

					if( no_meepass_received ){
						html.push( LJ.meepass.renderMeepassItem__ReceivedEmpty() );
					}

					$('.meepass').html( html.join('') )
								 .find('[data-link="received"]')
								 .velocity('fadeIn', {
									duration: 250,
									display: 'flex'
								});

					$('.menu-section.--meepass')
								.find('.segment__part')
								.removeClass('--active')
								.first()
								.addClass('--active');

				});

		},		
		handleFetchMeMeepassError: function(){

			LJ.elog('Error fetching meepass :/');

		},
		renderMeepassItem__ReceivedEmpty: function(){

			return LJ.ui.render([

				'<div class="empty" data-link="received">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-meepass"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_meepass_received_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_meepass_received_subtitle"></p>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderMeepassItem__SentEmpty: function(){

			return LJ.ui.render([

				'<div class="empty" data-link="sent">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-meepass"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_meepass_sent_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_meepass_sent_subtitle"></p>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderMeepassItem__Received: function( meepass_object, target ){

			var mp 	   = meepass_object;
			var target = target;

			var formatted_date = LJ.renderDate( mp.sent_at );
			var img_html       = LJ.pictures.makeImgHtml( target.img_id, target.img_vs, 'menu-row' );

			return LJ.ui.render([

				'<div class="meepass__item" data-link="received" data-event-id="' + mp.target_id + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + img_html + '</div>',
						'<div class="row-pic__icon --round-icon"><i class="icon icon-meepass"></i></div>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + LJ.text('meepass_item_title_received').replace('%name', target.name) +'</h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon"><i class="icon icon-location"></i></div>',
							'<h4>' + LJ.text('meepass_item_subtitle').replace('%date',  '22/04/16' ).capitalize() + '</h4>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderMeepassItem__Sent: function( meepass_object, target, meepass_by ){

			var mp 	   = meepass_object;
			var target = target;

			var formatted_date = LJ.renderDate( mp.sent_at );
			var img_html       = LJ.pictures.makeImgHtml( target.img_id, target.img_vs, 'menu-row' );

			return LJ.ui.render([

				'<div class="meepass__item" data-link="sent" data-event-id="' + mp.target_id + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + img_html + '</div>',
						'<div class="row-pic__icon --round-icon"><i class="icon icon-meepass"></i></div>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + LJ.text('meepass_item_title_sent').replace('%name', target.name) +'</h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							'<div class="row-body__icon --round-icon"><i class="icon icon-location"></i></div>',
							'<h4>' + LJ.text('meepass_item_subtitle').replace('%date',  '22/04/16' ).capitalize() + '</h4>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		}

	});
		

	window.LJ.nav = _.merge( window.LJ.nav || {}, {

		$nav: $('.app-nav'),
		current_link: null,

		init: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.nav.handleDomEvents();
				LJ.nav.navigate('map');
				resolve();

			});
		},
		handleDomEvents: function(){

			LJ.nav.$nav.on('click', 'li[data-link]', LJ.nav.handleNavigate );

		},
		handleNavigate: function(e){

			e.preventDefault();
			var $li = $(this);
			var lk  = $li.attr('data-link');
			LJ.nav.navigate( lk );

		},
		navigate: function( target_link ){

			var current_link = LJ.nav.current_link;

			var $target_section  = $('.app-section[data-link="' + target_link + '"]');
			var $current_section = $('.app-section[data-link="' + current_link + '"]') || $target_section; // For the first activation

			var $target_menuitem = $('.app__menu-item[data-link="' + target_link + '"]');
			var $current_menuitem = $('.app__menu-item[data-link="' + current_link + '"]') || $target_menuitem

			var $target_headertitle  = $('.app-header__title[data-link="' + target_link + '"]');
			var $current_headertitle = $('.app-header__title[data-link="' + current_link + '"]') || $target_headertitle;

			if( $target_section.length + $target_menuitem.length + $target_headertitle.length != 3 ){
				return LJ.wlog('Ghost target for link : ' + link );
			}

			// Set the internal state
			LJ.nav.current_link = target_link

			// Update the Header ui
			$current_menuitem.removeClass('--active');
			$target_menuitem.addClass('--active');

			// Update the header title
			/*var duration = 220;
			LJ.ui.shradeOut( $current_headertitle, duration )
				.then(function(){
					LJ.ui.shradeIn( $target_headertitle, duration );
				});
			*/
			
			// Display the view
			$current_section.hide();
			$target_section.css({ display: 'flex' });

			// Specificities
			var duration = 220;
			var hasMeepassRibbon = $('.meepass-ribbon').length > 0;

			if( target_link == 'search' && hasMeepassRibbon ) {
				LJ.ui.shradeIn( $('.meepass-ribbon'), duration )
			} 

			if( target_link != 'search' && hasMeepassRibbon ){
				LJ.ui.shradeOut( $('.meepass-ribbon'), duration )
			}

			if( target_link == 'map' ){
				$('.app').removeClass('padded');
			} else {
				$('.app').addClass('padded');
			}

			if( target_link != "menu" ){
				LJ.friends.hideInviteFriendsPopup();
			}


		}

	});



	
	window.LJ.notifications = _.merge( window.LJ.notifications || {}, {

		state : 'hidden',
		jsp_id: 'notifications',

		init: function(){

			return LJ.notifications.addNotificationsPanel()
					.then(function(){
						LJ.notifications.refreshNotifications();
						LJ.notifications.handleDomEvents();
					});

		},
		handleDomEvents: function(){

			$('.app__menu-item.--notifications').click( LJ.notifications.handleToggleNotifications );
			$('.app__menu-item.--notifications').click( LJ.notifications.updateNotificationsSeenAt );
			$('.notifications-panel').on('click', '.notification', LJ.notifications.updateNotificationClickedAt );

			LJ.ui.$body.on('click', LJ.notifications.handleHideNotifications );

		},
		getNotification: function( n_id ){

			return _.find( LJ.user.notifications, function( n ){
				return n.notification_id == n_id;
			});

		},
		cacheNotification: function( notification ){

			LJ.user.notifications.push( notification );

		},
		refreshNotifications: function(){

			LJ.notifications.addAndShowNotifications();
			LJ.notifications.refreshNotificationsOrder();
			LJ.notifications.refreshNotificationsJsp();
			LJ.notifications.classifyNotifications();  
			LJ.notifications.refreshNotificationsBubble();   

		},
		resetBubbleToNotificationsIcon: function(){

			var $i = $('.app__menu-item.--notifications');
			LJ.ui.setBubble( $i, 0 );

		},
		addBubbleToNotificationsIcon: function(){

			var $i = $('.app__menu-item.--notifications');
			LJ.ui.bubbleUp( $i );

		},
		refreshNotificationsBubble: function(){

			var $w = $('.notifications-panel');

			LJ.notifications.resetBubbleToNotificationsIcon();

			LJ.user.notifications.forEach(function( n ){

				if( !n.seen_at ){
					return LJ.notifications.addBubbleToNotificationsIcon();
				}

			});

		},
		classifyNotifications: function(){

			var $w = $('.notifications-panel');

			$w.find('.notification').removeClass('--seen').removeClass('--clicked');

			LJ.user.notifications.forEach(function( n ){

				var $n = $w.find('.notification[data-notification-id="'+ n.notification_id +'"]');

				// if( n.seen_at ){
				// 	$n.addClass('--seen');
				// }

				if( n.clicked_at ){
					$n.addClass('--clicked');
				}

			});

		},
		reorderNotifications: function( i ){

			i = i || 1;

			var notifs = LJ.user.notifications;	

			notifs.sort(function( n1, n2 ){
				return ( moment( n2.happened_at ) - moment( n1.happened_at ) ) * i;
			});

		},
		refreshNotificationsOrder: function(){
			
			var notifs = LJ.user.notifications;			

			LJ.notifications.reorderNotifications();

			notifs.forEach(function( n, i ){
				$('.notification[data-notification-id="'+ n.notification_id +'"]').css({ 'order': i });
			});

		},
		refreshNotificationsJsp: function(){

			LJ.ui.jsp[ LJ.notifications.jsp_id ].reinitialise();

		},
		addAndShowNotifications: function(){

			$('.notifications-panel').find('.js-notification-item').remove();

			LJ.user.notifications.forEach(function( notification ){
            	LJ.notifications.insertNotification( notification );
            });

		},
		findById: function( n_id ){

			return _.find( LJ.user.notifications, function( n ){
				return n.notification_id == n_id;
			});

		},
		updateNotificationsSeenAt: function(){

			var unseen_notifications = _.filter( LJ.user.notifications, function( n ){
				return !n.seen_at;
			});

			// Only call the api if there is something to call
			if( unseen_notifications.length != 0 ){
				LJ.api.updateNotificationsSeenAt();
			}

		},
		updateNotificationClickedAt: function(){

			var $n              = $( this );
			var notification_id = $n.attr('data-notification-id');
			var n               = LJ.notifications.findById( notification_id );

			if( !n.clicked_at ){

				LJ.api.updateNotificationClickedAt( notification_id );
				n.clicked_at = new Date();
				LJ.notifications.refreshNotifications();
			
			}

		},
		handleToggleNotifications: function(e){

			e.preventDefault();
				
			var $self = $( this );
			// Toggle notifications pannel
			LJ.notifications.toggleNotificationsPanel();

			// Kill bubbls
			LJ.notifications.resetBubbleToNotificationsIcon();

		},
		handleHideNotifications: function(e){

			var $t = $( e.target );

			var is_not_nav_item    = !$t.closest('.app__menu-item.--notifications').length;
			var panel_visible      = $('.notifications-panel.--active').length;
			var is_not_panel_child = !$t.closest('.notifications-panel').length;
			
			if( is_not_nav_item && is_not_panel_child && panel_visible ){
				LJ.notifications.hideNotificationsPanel();
			}

		},
		addNotificationsPanel: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.ui.$body.append( LJ.notifications.renderNotificationsPanel() );
				LJ.notifications.turnToJspNotificationsPanel()
					.then( resolve, reject );

			});
		},
		turnToJspNotificationsPanel: function(){

			return LJ.ui.turnToJsp('.notifications-panel__wrapper', {
					jsp_id: LJ.notifications.jsp_id
				})

		},
		toggleNotificationsPanel: function(){

			if( LJ.notifications.state == "visible" ){
				LJ.notifications.hideNotificationsPanel();

			} else {
				LJ.notifications.showNotificationsPanel();
			}

		},
		showNotificationsPanel: function(){

			var $notif = $('.notifications-panel');
			var $icon  = $('.app__menu-item.--notifications');

			if( LJ.notifications.state == "visible" ){

				LJ.log('Notification panel already there');

			} else {

				LJ.notifications.state = "visible";
				$icon.addClass('--active');
				$notif.addClass('--active').show();

			}

			LJ.notifications.refreshNotificationsJsp();

		},
		hideNotificationsPanel: function(){

			LJ.ui.activateHtmlScroll();
			
			var $notif = $('.notifications-panel');
			var $icon  = $('.app__menu-item.--notifications');

			if( LJ.notifications.state == "visible" ){

				LJ.notifications.state = "hidden";
				$icon.removeClass('--active');
				$notif.removeClass('--active').hide();

			} else {
				LJ.log('Notification panel already hidden');

			}

		},
		renderNotificationsPanel: function(){

			return LJ.notifications.renderNotificationsElement('wrapper');

		},
		renderNotification__RequestAcceptedHosts: function( notification ){

			var options    = {};
			var group_html = LJ.notifications.renderNotificationsElement('group_name');
			
			options.icon_code   = "chat-bubble-duo";
			options.text        = LJ.text("n_accepted_in_text");
			options.subtext     = LJ.text("n_accepted_in_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		// Identical to the one just above, for now at least 
		renderNotification__RequestAcceptedMembers: function( notification ){

			var options    = {};
			var group_html = LJ.notifications.renderNotificationsElement('group_name');
			
			options.icon_code   = "chat-bubble-duo";
			options.text        = LJ.text("n_accepted_in_text");
			options.subtext     = LJ.text("n_accepted_in_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		renderNotification__FillProfile: function( notification ){

			var options = {};
			
			options.icon_code   = "question-mark";
			options.text        = LJ.text("n_fill_profile_text");
			options.subtext     = LJ.text("n_fill_profile_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );


		},
		renderNotification__GroupRequestHosts: function( notification ){

			var options = {};

			options.icon_code   = "drinks";
			options.text        = LJ.text("n_group_request_hosts_text");
			options.subtext     = LJ.text("n_group_request_hosts_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		renderNotification__GroupRequestMembers: function( notification ){

			var options = {};

			var friend = LJ.friends.getFriendProfile( notification.main_member );

			var name = friend && friend.name;

			options.icon_code   = "drinks";
			options.text        = LJ.text("n_group_request_members_text");
			options.subtext     = LJ.text("n_group_request_members_subtext").replace( '%name', name );
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		renderNotification__MarkedAsHost: function( notification ){

			var options = {};
			var main_host = notification.main_host;
			var address   = notification.address;
			var date 	  = moment( notification.begins_at ).format('DD/MM');

			var friend = LJ.friends.getFriendProfile( main_host );

			if( !friend ) return LJ.wlog('Cannot render marked as host, couldnt find friend: ' + friend );

			var friend_name = friend.name;
			
			options.icon_code   = "star";
			options.text        = LJ.text("n_marked_as_host_text").replace('%name', friend_name );
			options.subtext     = LJ.text("n_marked_as_host_subtext").replace('%date', date ).replace('%address', address );
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		renderNotification__NewFriends: function( notification ){

			var options = {};

			var new_friends = _.map( notification.new_friends, 'facebook_name' );
			
			options.icon_code   = "users";
			options.text 		= LJ.text("n_new_friends_text", new_friends );
			options.subtext     = LJ.text("n_new_friends_subtext", new_friends );
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );

		},
		renderNotification__BeforeCanceled: function( notification ){

			var options = {};
			var address = notification.address;
			
			options.icon_code   = "line";
			options.text        = LJ.text("n_before_canceled_text");
			options.subtext     = LJ.text("n_before_canceled_subtext").replace('%address', address);
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );
			
		},
		renderNotification__ItemShared: function( notification ){

			var options   = {};
			var shared_by = notification.shared_by;

			var friend = LJ.friends.getFriendProfile( shared_by );
			var name = friend && friend.name;
			var type = notification.target_type == "user" ? LJ.text('lang_profile') : LJ.text('lang_before');

			options.icon_code   = "forward";
			options.text        = LJ.text("n_item_shared_text").replace( '%name', name );
			options.subtext     = LJ.text("n_item_shared_subtext").replace( '%name', name ).replace( '%type', type );
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );
			
		},
		renderNotification__InscriptionSuccess: function( notification ){

			var options = {};
			
			options.icon_code   = "heart";
			options.text        = LJ.text("n_inscription_success_text");
			options.subtext     = LJ.text("n_inscription_success_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );


		},
		renderNotification__NoFriends: function( notification ){

			var options = {};
			
			options.icon_code   = "add-friend";
			options.text        = LJ.text("n_no_friends_text");
			options.subtext     = LJ.text("n_no_friends_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );


		},
		renderNotification__CheckEmail: function( notification ){

			var options = {};
			
			options.icon_code   = "arobat";
			options.text        = LJ.text("n_check_email_text");
			options.subtext     = LJ.text("n_check_email_subtext");
			options.happened_at = LJ.notifications.stringifyDuration( notification.happened_at );

			return LJ.notifications.renderNotificationItem( _.extend( {}, notification, options ) );


		},
		renderNotificationItem: function( options ){

			return LJ.notifications.renderNotificationsElement( 'item', options );

		},
		renderNotificationsElement: function( element, options ){

			var html = [];
			var options = options || {};

            if( element == "wrapper" ){

                return LJ.ui.render([
                    '<div class="notifications-panel">',
                        '<div class="notification notification--header">',
                       		'<div data-lid="n_header_text" class="notification--header__text">Notifications</div>',
                        '</div>',
                        '<div class="notifications-panel__wrapper">',
	                        '<div class="js-notification-appender notification--none"></div>',
							// There goes the notifications                        
						'</div>',
                        '<div class="notification notification--footer">',
                            '<div data-lid="n_footer_text" class="notification--footer_text">This is the footer</div>',
                        '</div>',
                    '</div>'
                ].join(''));

            }

            if( element == "item" ){

				var type            = options.type;
				var icon_code       = options.icon_code;
				var text            = options.text;
				var subtext         = options.subtext;
				var happened_at     = options.happened_at;
				var notification_id = options.notification_id;

				var happened_at_html = happened_at ? '<div class="notification__date">' + happened_at + '</div>' : '';

            	return LJ.ui.render([
            		'<div class="notification js-notification-item" data-type="'+ type +'" data-notification-id="'+ notification_id +'">',
                    	'<div class="notification__icon --round-icon"><i class="icon icon-' + icon_code + '"></i></div>',
                    	'<div class="notification-message">',
	                    	'<div class="notification-message__text">' + text + '</div>',
	                    	'<div class="notification-message__subtext">' + subtext + '</div>',
                    	'</div>',
                    	happened_at_html,
                    '</div>',
            	].join(''));
            }
			

		},
		stringifyDuration: function( happened_at ){

			var m = moment( happened_at );

			var hour = m.hour();
			var minute = m.minute();

			if( hour == 0 ){
				hour = "00";
			}

			if( minute < 10 ){
				minute = "0" + minute;
			}

			var now = moment();

			if( (now - m)/1000 < 5 * 60 ){
				return LJ.text("h_sec_ago");
			}

			if( (now - m)/1000 < 15 * 60 ){
				return LJ.text("h_min_ago");
			}

			if( (now - m)/1000 < 3600 ){
				return LJ.text("h_hour_ago");
			}

			if( m.dayOfYear() == now.dayOfYear() ){
				return LJ.text("h_today").replace('%h', hour ).replace('%m', minute );
			}

			return LJ.text("h_past").replace('%moment', m.format('DD/MM'))
															  .replace('%h', hour )
															  .replace('%m', minute )
			

		},
		insertNotification: function( notification ){
			
			var html = '';
			var type = notification.type;
			var type = notification.type || "default";

			var notificationCallback;

			// Accepted in a meefore
			if( type === "accepted_in_hosts" ){
				html = LJ.notifications.renderNotification__RequestAcceptedHosts( notification );
				notificationCallback = LJ.notifications.notificationCallback__AcceptedInHosts;
			}

			// Accepted in a meefore
			if( type === "accepted_in_members" ){
				html = LJ.notifications.renderNotification__RequestAcceptedMembers( notification );
				notificationCallback = LJ.notifications.notificationCallback__AcceptedInMembers;
			}


			// Profile isnt 100% complete! Especially photos...
			if( type === "fill_profile" ){
				html = LJ.notifications.renderNotification__FillProfile( notification );
				notificationCallback = LJ.notifications.notificationCallback__FillProfile;
			}


			// A group requested to join in a meefore, host version
			if( type === "group_request_hosts" ){
				html = LJ.notifications.renderNotification__GroupRequestHosts( notification );
				notificationCallback = LJ.notifications.notificationCallback__GroupRequestHosts;
			}

			// A group requested to join in a meefore, members version
			if( type === "group_request_members" ){
				html = LJ.notifications.renderNotification__GroupRequestMembers( notification );
				notificationCallback = LJ.notifications.notificationCallback__GroupRequestMembers;
			}


			// A friend taggued us as host on one of its meefore
			if( type === "marked_as_host" ){
				html = LJ.notifications.renderNotification__MarkedAsHost( notification );
				notificationCallback = LJ.notifications.notificationCallback__MarkedAsHost;
			}


			// New friends joined meefore
			if( type === "new_friends" ){
				html = LJ.notifications.renderNotification__NewFriends( notification );
				notificationCallback = LJ.notifications.notificationCallback__NewFriends;
			}


			// A before has been canceled 
			if( type === "before_canceled" ){
				html = LJ.notifications.renderNotification__BeforeCanceled( notification );
				notificationCallback = LJ.notifications.notificationCallback__BeforeCanceled;
			}

			
			// Someone has shared something
			if( type === "item_shared" ){
				html = LJ.notifications.renderNotification__ItemShared( notification );
				notificationCallback = LJ.notifications.notificationCallback__ItemShared;
			}


			// Welcome in meefore !
			if( type === "inscription_success" ){
				html = LJ.notifications.renderNotification__InscriptionSuccess( notification );
				notificationCallback = LJ.notifications.notificationCallback__InscriptionSuccess;
			}


			// Make sure user knows its important we got its right email
			if( type === "check_email" ){
				html = LJ.notifications.renderNotification__CheckEmail( notification );
				notificationCallback = LJ.notifications.notificationCallback__CheckEmail;
			}

			var $notif = $( html );

			// Fire callback if registered
			if( typeof notificationCallback == "function" ){
				$notif.on('click', function(){
					try {
						notificationCallback( notification );
					} catch( e ){
						LJ.ui.showToast( LJ.text("n_outdated_notification") );
					}
					LJ.notifications.hideNotificationsPanel();
				});
			}

			// Append the new notification on top of all
			$notif.insertAfter( $('.js-notification-appender') );
				
		},
		notificationCallback__InscriptionSuccess: function( n ){

			LJ.log('Welcome onboard !');

		},
		notificationCallback__NewFriends: function( n ){

			LJ.nav.navigate("menu");
			LJ.menu.activateMenuSection("friends");

		},
		notificationCallback__GroupRequestHosts: function( n ){

			LJ.nav.navigate("menu");
			LJ.menu.activateMenuSection("cheers");
			LJ.cheers.activateCheers("received");


		},
		notificationCallback__GroupRequestMembers: function( n ){

			LJ.nav.navigate("menu");
			LJ.menu.activateMenuSection("cheers");
			LJ.cheers.activateCheers("sent");

		},
		notificationCallback__AcceptedInMembers: function( n ){

			var before_id  = n.before_id;
			var chat_id    = LJ.chat.getChatIdByBeforeId( before_id );

			if( LJ.chat.getChatState() == "hidden" ){
				LJ.chat.showChatWrap();
			}

			LJ.chat.showChatInview( chat_id );
			LJ.chat.activateChat( chat_id );
			LJ.chat.refreshChatJsp( chat_id );
			LJ.chat.refreshChatState( chat_id );

		},
		notificationCallback__AcceptedInHosts: function( n ){

			var before_id  = n.before_id;
			var chat_id    = LJ.chat.getChatIdByBeforeId( before_id );

			if( LJ.chat.getChatState() == "hidden" ){
				LJ.chat.showChatWrap();
			}

			LJ.chat.showChatInview( chat_id );
			LJ.chat.activateChat( chat_id );
			LJ.chat.refreshChatJsp( chat_id );
			LJ.chat.refreshChatState( chat_id );

		},
		notificationCallback__MarkedAsHost: function( n ){

			var before_id  = n.before_id;
			var chat_id    = LJ.chat.getChatIdByBeforeId( before_id );

			if( LJ.chat.getChatState() == "hidden" ){
				LJ.chat.showChatWrap();
			}

			LJ.chat.showChatInview( chat_id );
			LJ.chat.activateChat( chat_id );
			LJ.chat.refreshChatJsp( chat_id );
			LJ.chat.refreshChatState( chat_id );

			LJ.before.fetchAndShowBeforeInview( before_id );

		},
		notificationCallback__FillProfile: function( n ){

			LJ.nav.navigate("menu");
			LJ.menu.activateMenuSection("profile");

		},
		notificationCallback__CheckEmail: function( n ){

			LJ.nav.navigate("menu");
			LJ.menu.activateMenuSection("settings");
			LJ.settings.activateSubmenuSection("account")

		},
		notificationCallback__BeforeCanceled: function( n ){

			LJ.ui.showToast( LJ.text("n_before_canceled") );

		}

	});

	
	window.LJ.onboarding = _.merge( window.LJ.onboarding || {}, {

        init: function(){
                
                if( LJ.user.status == "new" ){
                    //LJ.onboarding.startTour();
                }

                return


        },
        startTour: function(){

    		LJ.intro_steps = [

    			{ 
                    id      : "init",
                    next_id : "intro_instructions",
                    mode    : "cover",
    			 	callback: function(){
                        var self = this;

    			 		LJ.fn.showWelcomeLintro();
    			 		LJ.map.setZoom(14);
                        // Clear preview to prevent problems when replaying tour
                        google.maps.event.trigger( LJ.map, 'click' );

                        // Make sure doest call on undefined values
                        LJ.event_markers = LJ.event_markers || [];
                        LJ.party_markers = LJ.party_markers || [];

    			 		LJ.event_markers.forEach(function(marker){
    			 			marker.marker.setOpacity(0);
    			 		});
    			 		LJ.party_markers.forEach(function(marker){
    			 			marker.marker.setOpacity(0);
    			 		});

    			 		$('.btn-welcome').click(function(){
		    				LJ.fn.lintroStep( self.next_id );
		    			});

		    			$('.welcome-skip').click(function(){
		    				LJ.fn.clearIntro();
		    				LJ.fn.endIntro(function(){
                                LJ.fn.fetchFacebookPictureIntro();
		    				});
		    			});

                        var step_html = [
                            '<div class="lintro-next nonei" data-stepid="' + this.id + '" data-nextid="' + this.next_id + '">',
                                // LJ.text_source["intro_next"][ LJ.app_language ],
                                '>',
                            '</div>'
                        ].join('');

                        LJ.$body.append( step_html );

    			 	}
    			},
                {
                    id          : "intro_instructions",
                    next_id     : "intro_1",
                    mode        : "area",
                    upper_el    : "#mainWrap",
                    upper_cover : true,
                    delay       : 1500,
                    text        : LJ.text_source["intro_instructions"][ LJ.app_language ],
                    callback  : function(){
                        LJ.fn.showTextLintro(this);
                    }
                },
    			{ 
                    id         : "intro_1",
                    next_id    : "intro_2",
                    mode       : "area",
                    upper_el   : ".row-events-filters",
                    lower_el   : ".row-events-accepted-tabview",
                    text       : LJ.text_source["intro_text_1"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			},
    			{
                    id       : "intro_2",
                    next_id  : "intro_3",
                    mode     : "idem",
                    text     : LJ.text_source["intro_text_2"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.fn.displayEventMarker( LJ.intro.event_data, { cache: 'event_markers_intro', intro: true } );
    				}
    			},
    			{
                    id         : "intro_3",
                    next_id    : "intro_4",
                    mode       : "idem",
                    text       : LJ.text_source["intro_text_3"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.fn.displayPartyMarker_Party( LJ.intro.party_data, { cache: 'party_markers_intro', intro: true } );
    				}
    			},
    			{
                    id       : "intro_4",
                    next_id  : "intro_5",
                    duration : 5000,
                    mode     : "idem",
                    text     : LJ.text_source["intro_text_4"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
                        LJ.fn.displayPathToParty({ evt: LJ.intro.event_data });
    				}
    			},
    			{
                    id       : "intro_5",
                    next_id  : "intro_6",
                    mode     : "idem",
                    text     : LJ.text_source["intro_text_5"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);

    					LJ.intro.events_data.forEach(function( evt, i ){

    						var url = LJ.cloudinary.markers.base.open.url;

    						if( i == 0 || i == 2 ) url = LJ.cloudinary.markers.pending.open.url;
    						if( i == 1 || i == 3 ) url = LJ.cloudinary.markers.accepted.open.url;
    						if( i == 4 ) url = LJ.cloudinary.markers.base.full.url;

    						LJ.fn.displayEventMarker( evt,  { url: url, cache: 'event_markers_intro' } );

    					});

    					
                        LJ.intro.events_data.forEach(function( evt ){
                        	 LJ.fn.displayPathToParty({
		                        evt            : evt,
		                        stroke_opacity : 0.25,
		                        cache          : "half_active_paths"
		                    });
                        });
    				}
    			},
    			{
                    id       : "intro_6",
                    next_id  : "intro_10",
                    mode     : "idem",
                    text     : LJ.text_source["intro_text_6"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.event_markers_intro[0].marker.setIcon( LJ.cloudinary.markers.base_active.open.url );
    					LJ.party_markers_intro[0].marker.setIcon( LJ.cloudinary.markers.party_active.url );
    					LJ.fn.addEventMapview( LJ.intro.event_data, { marker: LJ.event_markers_intro[0].marker });
    					LJ.fn.addPartyMapview( LJ.intro.party_data, { marker: LJ.party_markers_intro[0].marker });
                        LJ.fn.timeout(1000, function(){ $('.btn-requestin').click(function(e){ e.stopPropagation(); }); })
                       
    				}
    			},
    			{
                    id         : "intro_7",
                    next_id    : "intro_8",
                    mode       : "element",
                    el         : ".event-preview",
                    text       : LJ.text_source["intro_text_7"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			// 
    			},
    			{
                    id         : "intro_8",
                    next_id    : "intro_9",
                    mode       : "element",
                    el         : ".party-preview",
                    text       : LJ.text_source["intro_text_8"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			// 
    			},
    			{
                    id         : "intro_9",
                    next_id    : "intro_10",
                    mode       : "element",
                    el         : ".btn-requestin",
                    text       : LJ.text_source["intro_text_9"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			},
    			{
                    id         : "intro_10",
                    next_id    : "intro_11",
                    mode       : "element",
                    el         : ".modal-container",
                    text       : LJ.text_source["intro_text_10"][ LJ.app_language ],
                    delay      : 1000,
    				callforward: function(){
    					LJ.fn.showRequestInModal('fake_intro_id');
    				},
    				callback: function(){
    					LJ.fn.showTextLintro(this);
                        $('.modal-container-body').find('*').each(function(i, el){
                            $(el).on('click', function(e){ e.stopPropagation(); });
                        });
                        LJ.fn.clearMapviews();
    				}
    			}, 
    			{
                    id         : "intro_11",
                    next_id    : "intro_15",
                    mode       : "element",
                    el         : ".row-requestin-group-members",
                    text       : LJ.text_source["intro_text_11"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			}, 
    			{
                    id         : "intro_12",
                    next_id    : "intro_13",
                    mode       : "area",
                    upper_el   : '.row-party-preview',
                    lower_el   : '.row-events-accepted-tabview',
                    text       : LJ.text_source["intro_text_12"][ LJ.app_language ],
                    text_align : "center",
                    delay      : 400,
    				callforward: function(){
    					$('.modal-curtain').click();
    				},
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.event_markers_intro.forEach(function( evt, i ){
    						if( i == 1 ) return;
    						evt.marker.setMap(null);
    					});
    					LJ.party_markers_intro[0].marker.setMap(null);
    					LJ.active_paths[0].setMap(null);
    					LJ.half_active_paths.forEach(function( path ){
    						path.setMap(null);
    					});

    				}
    			},
    			{
                    id         : "intro_13",
                    next_id    : "intro_14",
                    mode       : "idem",
                    text       : LJ.text_source["intro_text_13"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.event_markers_intro.forEach(function( evt, i ){
    						if( i == 1 ) return evt.marker.setIcon( LJ.cloudinary.markers.accepted.open.url );
    						evt.marker.setMap(null);
    					});
    				}
    			},
    			{
                    id         : "intro_13a",
                    next_id    : "intro_18",
                    mode       : "area",
                    upper_el   : '.row-events-filters',
                    lower_el   : '.row-events-accepted-tabview',
                    text       : LJ.text_source["intro_text_13a"][ LJ.app_language ],
                    callforward: function(){

                       // Clear preview
                        $('.row-events-accepted-inview').velocity('transition.slideDownOut', { duration: 400 }).removeClass('active');
                        $('.row-preview').velocity('transition.slideUpOut', { duration: 400, complete: function(){
                            $(this).children().remove();
                        }});
                        $('.event-tabview-intro').remove();

    					LJ.event_markers_intro.forEach(function( mrk, i ){
    						if( i == 1 ){
                                mrk.marker.setIcon( LJ.cloudinary.markers.base.full.url );
                                LJ.map.panTo( mrk.data.address );
                                return;
                            }
    						mrk.marker.setMap(null); 
    					});

                    },
                    callback: function(){
                        LJ.fn.showTextLintro(this);
    				}
    			},
    			{
                    id         : "intro_14",
                    next_id    : "intro_15",
                    mode       : "area",
                    upper_el   : '.row-events-accepted-tabview',
                    text       : LJ.text_source["intro_text_14"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					$('.row-events-accepted-tabview')
    						.append( LJ.fn.renderEventTabview( LJ.intro.event_data ) )
    						.children().last()
    						.addClass('event-tabview-intro')
                            .on('click', function(e){ e.stopPropagation(); });
                            
    				}
    			},
    			{
                    id          : "intro_15",
                    next_id     : "intro_16",
                    mode        : "element",
                    el          : '.event-inview-intro',
                    delay       : '300',
                    upper_cover : true,
                    text        : LJ.text_source["intro_text_15"][ LJ.app_language ],
                    callforward: function(){
                        $('.modal-curtain').click();
                        LJ.fn.showIntroChatInview();
                    },
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    				}
    			},
    			{
                    id          : "intro_16",
                    next_id     : "intro_18",
                    delay       : 8000,
                    mode        : "idem",
                    // lower_el : '.row-events-accepted-tabview',
                    text        : LJ.text_source["intro_text_16"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					LJ.fn.showIntroChatTalk();
    				}
    			},
    			{
                    id          : "intro_17",
                    next_id     : "intro_18",
                    mode        : "element",
                    el          : '.event-accepted-chat-typing',
                    padding     : 20,
                    // lower_el : '.row-events-accepted-tabview',
                    text        : LJ.text_source["intro_text_17"][ LJ.app_language ],
    				callback: function(){
    					LJ.fn.showTextLintro(this);
    					setTimeout(function(){
    						LJ.fn.stageUserForWhisper( 'will', 'chat-intro' );
    						setTimeout(function(){
    							LJ.fn.stageUserForWhisper( 'sandy', 'chat-intro' );
    						}, 2500 );
    					}, 3500 );
    				}
    			},
    			{
                    id         : "intro_18",
                    mode       : "cover",
                    close_step : true,
    				callback: function(){

    					LJ.fn.showEndingLintro();
    					LJ.fn.clearIntro();

    					$('.btn-fillprofile').click(function(){
    						LJ.fn.endIntro(function(){
    							$('#profile').click();
    							LJ.fn.fetchFacebookPictureIntro();
    						});
    					});

    					$('.ending-skip').click(function(){
    						LJ.fn.endIntro(function(){
                                LJ.fn.fetchFacebookPictureIntro();
    						});
    					});
    				}
    			}


    		];

    		LJ.fn.lintroStep( 'init' );


        	},
        	lintroStep: function( step_id ){

                var step = _.find( LJ.intro_steps, function( step ){
                    return step.id == step_id;
                });

                if( !step ) {
                    return LJ.fn.warn('Couldnt find matching step based on step_id : ' + step_id );
                }

                if( step == "end_intro" ){
                    return LJ.fn.endIntro( callback );
                }

                LJ.fn.highlightElement( step );

            },
            highlightElement: function( opts ){

                LJ.fn.log('Applying step : ' + opts.id );
                console.log( opts );

                if( typeof opts.callforward == 'function' ){
                    opts.callforward();
                    return setTimeout(function(){
                        delete opts.callforward;
                        LJ.fn.highlightElement( opts );
                    }, opts.delay );
                }


                var abort = false;
                if( opts.mode == "element" && ( !opts.el || !$(opts.el).length || $(opts.el).length == 0 ) ){
                    LJ.fn.warn('Couldnt find element : ' + $(opts.el), 1 );
                    abort = true;
                }
                if( opts.mode == "area" && ( !opts.upper_el && !opts.lower_el ) ){
                    LJ.fn.warn('Couldnt find all properties to highlight area', 1);
                    abort = true;
                }

                if( opts.mode == "cover" && !opts.callback ){
                    LJ.fn.warn('Didnt get any callback', 1);
                    abort = true;
                }

                if( abort ){
                    LJ.fn.warn('Aborting tour prematurely....', 1);
                    return LJ.fn.lintroStep('intro_18');
                }


                var default_opts = {
                    opacity: 0.85,
                    padding: 0
                };

                opts = _.merge( default_opts, opts );               

                var base_style = {
                    'position'   : 'absolute',
                    'background' : 'rgba(0,0,0,' + opts.opacity + ')',
                    'z-index'    : '10000',
                    'display'    : 'none'
                };

                var $curt_top    = $('<div class="lintro intro-curtain intro-curtain-top"></div>');
                var $curt_left   = $('<div class="lintro intro-curtain intro-curtain-left"></div>');
                var $curt_right  = $('<div class="lintro intro-curtain intro-curtain-right"></div>');
                var $curt_bottom = $('<div class="lintro intro-curtain intro-curtain-bottom"></div>');


                if( opts.close_step ){
                    $('.lintro-next').velocity('transition.fadeOut', { duration: 500, complete: function(){
                        $(this).remove();
                    } });
                }

				// if( opts.duration ){
				//   	LJ.intro_duration = window.setTimeout(function(){
				//   		 $('.lintro-next').click();
				//   	}, opts.duration*1.25 );
				//  }

				if( opts.mode == "idem" ){					
					if( typeof opts.callback == 'function' ){
						opts.callback();
						return;	
					}
				}

        		if( opts.mode == "element" ){

        			var $el = $( opts.el );

					var top    = $el.offset().top;
					var left   = $el.offset().left;
					var width  = $el.outerWidth();
					var height = $el.outerHeight();

					$curt_top.css({
						'width'  : '100%',
						'height' : top - opts.padding,
						'top'    : 0 
					});

					$curt_bottom.css({
                        'width'  : '100%',
                        'height' : $(window).height() - ( top + height + opts.padding ),
                        'top'    : window.scrollY + ( top + height ) + opts.padding,
					});

					$curt_left.css({
                        'width'  : left - opts.padding,
                        'height' : height + 2*opts.padding,
                        'top'    :  top - opts.padding 
					});

					$curt_right.css({
                        'left'   : left + width + opts.padding,
                        'width'  : $(window).width() - ( left + width + opts.padding),
                        'height' : height + 2*opts.padding,
                        'top'    : top - opts.padding 
					});
				}

				if( opts.mode == "area" ){

                    var upper_el_bottom_pose = $(opts.upper_el).offset().top + $(opts.upper_el).outerHeight();

					if( opts.lower_el ){
                        var lower_el_top_pose = $(opts.lower_el).offset().top;
					} else {
                        var lower_el_top_pose    = $(window).height();
                        var upper_el_bottom_pose = $(opts.upper_el).offset().top;
						if( opts.upper_cover ){
							upper_el_bottom_pose += $(opts.upper_el).outerHeight();
						}
					}

					$curt_right.css({ display: 'none'});
					$curt_left.css({ display: 'none'});

					$curt_top.css({
						'width' : '100%',
						'height': upper_el_bottom_pose - opts.padding,
						'top': 0
					});

					$curt_bottom.css({
						'width': '100%',
						'height': $(window).height() - lower_el_top_pose + opts.padding,
						'bottom': 0
					});
				}

				if( opts.mode == "cover" ){

					$curt_right.css({ display: 'none'});
					$curt_left.css({ display: 'none'});
					$curt_bottom.css({ display: 'none' });

					$curt_top.css({
						'width': '100%',
						'height': '100%',
						'top': 0
					});

				}

				// Clear everything 
				$('.lintro').velocity('transition.fadeOut', {
					duration: 700,
					complete: function(){
						$(this).remove();
					}
				});


				$curt_top
				  .add( $curt_bottom ).add( $curt_left ).add( $curt_right )
				  .appendTo('body')
				  .css( base_style )
				  .velocity('transition.fadeIn', {
				  	duration: 700,
				  	display: 'block',
				  	complete: function(){

				  		if( typeof opts.callback == 'function' ){
                            opts.callback();
                        }
				  	}
				  });


        	},
        	renderWelcome: function(){

        		var html = [
        			'<div class="welcome welcome-wrap super-centered">',
        				'<div class="welcome-header">',
        					'<h1 data-lid="intro_welcome_header" >Bienvenue sur le meilleur site de soires au monde</h1>',
        				'</div>',
        				'<div data-lid="intro_welcome_subheader" class="welcome-subheader">',
        					'Nous avons prpar un petit tour sympa trs rapide pour comprendre comment a marche.',
        				'</div>',
        				'<button data-lid="intro_welcome_btn" class="theme-btn btn-welcome">Montrez-moi</button>',
        				'<div data-lid="intro_welcome_skip" class="welcome-skip">',
        					'Je sais dj comment a marche!',
        				'</div>',
        			'</div>'
        		].join('');

                html = $(html);
                LJ.fn.setAppLanguage( LJ.app_language, html )

                return html.prop('outerHTML');

        	},
        	showWelcomeLintro: function(){

    			$('.intro-curtain-top')
    				.append( LJ.fn.renderWelcome() ).children().velocity('transition.fadeIn', {
    				duration: 400 
    			});

        	},
        	renderEnding: function(){

        		var html = [
        			'<div class="welcome welcome-wrap super-centered">',
        				'<div class="welcome-header">',
        					'<h1 data-lid="intro_ending_header" >Et c\'est tout ! </h1>',
        				'</div>',
        				'<div data-lid="intro_ending_subheader" class="welcome-subheader">',
        					'Il ne vous reste plus qu\' remplir votre profile et  en parler  vos amis. <br> A bientt en soire!',
        				'</div>',
        				'<button data-lid="intro_ending_btn" class="theme-btn btn-fillprofile">Mon profile</button>',
                        '<button data-lid="app_button_invite" class="theme-btn invite-friends"></button>',
        				'<div data-lid="intro_ending_skip" class="ending-skip">',
        					'Je remplirai mon profile plus tard...montrez-moi les soires!',
        				'</div>',
        			'</div>'
        		].join('');

        		html = $(html);
                LJ.fn.setAppLanguage( LJ.app_language, html )

                return html.prop('outerHTML')

        	},
        	showEndingLintro: function(){

        		$('.intro-curtain-top')
    				.append( LJ.fn.renderEnding() ).children().velocity('transition.fadeIn', {
    				duration: 400 
    			});

        	},
        	showTextLintro: function( opts ){

        		if( $('.lintro-text').length != 0 ){
	        		$('.lintro-text').velocity('transition.fadeOut', {
	        			duration: 500,
	        			complete: function(){
	        				$('.lintro-text').remove();
	        				LJ.fn.showTextLintro( opts );
	        			}
	        		});
	        		return;
        		}

		  		$('.intro-curtain-top')
		  			.append('<div class="lintro-text super-centered none">' + opts.text + '</div>')
		  			.find('.lintro-text')
		  			.css({ 'text-align': opts.text_align || 'center' })
                    .append('<div class="lintro-exit transparent">Quitter le tour</div>')
		  			.velocity('transition.fadeIn', {
		  				duration: 500,
                        complete: function(){

                            var $wrap = $(this);

                            $wrap
                                .append('<div class="lintro-next none"><i class="icon icon-right"></i></div>')
                                .find('.lintro-next')
                                .velocity('transition.slideLeftIn', {
                                    duration: 500,
                                    delay: opts.delay || 500,
                                    display: 'inline-block',
                                    complete: function(){
                                        $(this)
                                            .attr('data-stepid', opts.id )
                                            .attr('data-nextid', opts.next_id )
                                            .one('click', function(){
                                                var next_id = $(this).attr('data-nextid');
                                                LJ.fn.lintroStep( next_id );
                                            });
                                    }
                                })

                            $wrap
                                .find('.lintro-exit')
                                .velocity('transition.fadeIn', {
                                    duration: 500,
                                    delay: opts.delay || 500,
                                    display: 'block',
                                    complete: function(){
                                        $(this)
                                            .one('click', function(){
                                                LJ.fn.lintroStep('intro_18');
                                            });
                                    }
                                })

                            
                        }
                    })


        	},
        	showIntroChatInview: function(){	

        		$('.event-tabview-intro').attr('data-status', 'accepted').addClass('active');
				$('.row-events-accepted-inview-wrapper').append( LJ.fn.renderEventInview_Intro( LJ.intro.event_data ) );

		        var adjusted_height = $( window ).outerHeight( true )  
                                      - $('.row-events-preview').innerHeight()
                                      - parseInt( $('.row-events-preview').css('top').split('px')[0] );

                $('.event-inview-intro')
                	.css({ height: adjusted_height })
                	.velocity('transition.fadeIn', {
                		duration: 500
                	})
                	.find('.offline').eq(0).removeClass('offline').addClass('online').end().end()
                	.find('.offline').eq(1).removeClass('offline').addClass('online').end().end()
                	.find('.offline').eq(2).removeClass('offline').addClass('online')

                // Remove all handlers for the demo chat
                $('.detailable').removeClass('detailable');
                $('.readby').off().find('button').on('click', function(e){
                    e.stopPropagation();
                });


        	},
        	showIntroChatTalk: function(){

        		var messages = [];
        		messages.push({
        			html: LJ.fn.renderChatLine_Bot( LJ.text_source["ch_bot_msg_group_accepted"][ LJ.app_language ] ),
        			delay: 3500
        		}, {
        			html: LJ.fn.renderChatLine( _.merge( LJ.intro.message_data_user_1, {
        				msg: LJ.text_source["intro_chat_1"][ LJ.app_language ], 
        				sent_at: new Date() }
        			)),
        			delay: 5500
        		}, {
        			html: LJ.fn.renderChatLine( _.merge( LJ.intro.message_data_user_1, {
        				msg: LJ.text_source["intro_chat_2"][ LJ.app_language ],
        				sent_at: new Date() }
        			)),
        			delay: 7500
        		}, {
        			html: LJ.fn.renderChatLine( _.merge( LJ.intro.message_data_user_2, {
        				msg: LJ.text_source["intro_chat_3"][ LJ.app_language ], 
        				sent_at: new Date() }
        			)),
        			delay: 9500
        		});

        		var $intro = $('.event-inview-intro');
        		messages.forEach(function( msg ){

        			setTimeout(function(){

        				if( $intro.find('.event-accepted-notification-message').length != 0 ){
        					$intro.find('.event-accepted-notification-message').remove();
        				}

        				$intro
        					.find('.event-accepted-chat-messages')
        					.append( msg.html )
        					.children().last()
        					.velocity('transition.fadeIn', { duration: 500 });

        			}, msg.delay );

        		});

        	},
        	endIntro: function(callback){

        		$('.lintro').velocity('transition.fadeOut', {
        			duration: 1000,
        			complete: function(){
        				$(this).remove();
        				if( typeof callback == "function" ){
        					callback();
        				}
        			}
        		});

        	},
        	clearIntro: function(){

        		// Clear what has been added
        		$('.event-inview-intro, .event-tabview-intro').velocity('transition.fadeOut', {
        			duration: 500,
        			complete: function(){
        				$(this).remove();
        			}
        		});

        		// Clear preview
        		google.maps.event.trigger( LJ.map, 'click' );

                if( LJ.event_markers_intro ){
            		LJ.event_markers_intro.forEach(function(marker){
            			marker.marker.setMap(null);
            		});
                }

                if( LJ.party_markers_intro ){
            		LJ.party_markers_intro.forEach(function(marker){
            			marker.marker.setMap(null);
            		});
                }

                if( LJ.event_markers ){
            		LJ.event_markers.forEach(function(marker){
    		 			marker.marker.setOpacity(1);
    		 		});
                }

                if( LJ.party_markers ){
    		 		LJ.party_markers.forEach(function(marker){
    		 			marker.marker.setOpacity(1);
    		 		});
                }

        	},
        	fetchFacebookPictureIntro: function(){

        		var img_place = 0;
                var img_id    = LJ.user._id + '--0'; //important 
                var userId    = LJ.user._id;
                var url       = 'https://graph.facebook.com/' + LJ.user.facebook_id + '/picture?width=320&height=320';

				LJ.fn.updatePictureWithUrl({

			                        userId    : LJ.user._id,
			                        url       : url,
			                        img_place : img_place,
			                        img_id    : img_id

				}, function( err, data ){

					if( err ){
					    return LJ.fn.handleServerError("La synchronisation avec Facebook a choue.");
			                        }

					LJ.fn.handleServerSuccess();
					LJ.fn.toastMsg( LJ.text_source["to_welcome"][ LJ.app_language ],'info', 4000);

				$('#intro').remove();

				LJ.fn.replaceImage({
                    img_id      : data.img_id,
                    img_version : data.img_version,
                    img_place   : 0,
                    scope       : ['profile','thumb']
				});

                // Typically == LJ.user.pictures[0]
                var pic = _.find( LJ.user.pictures, function(el){
                        return el.is_main;
                    });

                pic.img_id      = data.img_id;
                pic.img_version = data.img_version;

				});

        	}

               

	});

	window.LJ.pictures = _.merge( window.LJ.pictures || {}, {

		$upload_form: $(''),
		cloudinary_cloud_name: "radioreve",
		cloudinary_upload_params: { cloud_name:"radioreve", api_key:"835413516756943" },
		uploading_image: false,
		uploading_img_place: null,
		upload_id_profile: null,
		upload_ux_duration: 600,
		img_params: {
			'me'		     : { width: 170, height: 170, crop: 'fill', gravity: 'face' },
			'me-thumbnail'   : { width: 60,  height: 60,  crop: 'fill', gravity: 'face' },
			'menu-row'       : { width: 90,  height: 90,  crop: 'fill', gravity: 'face' },
			'user-profile'   : { width: 320, height: 320, crop: 'fill', gravity: 'face' }, 
			'user-search'    : { width: 240, height: 240, crop: 'fill', gravity: 'face' },
			'user-modal'     : { width: 50,  height: 50,  crop: 'fill', gravity: 'face' },
			'user-before'    : { width: 185, height: 185, crop: 'fill', gravity: 'face' },
			'user-row'       : { width: 60,  height: 60,  crop: 'fill', gravity: 'face' },
			'chat-row'		 : { width: 90,  height: 90,  crop: 'fill', gravity: 'face' },
			'chat-line'		 : { width: 35,  height: 35,  crop: 'fill', gravity: 'face' },
			'cheers-back'    : { width: 200, height: 200, crop: 'fill', gravity: 'face' }
		},
		cached: [],

		init: function(){

			// Global configuration of the uploader. Need to be called once !
			$.cloudinary.config( LJ.pictures.cloudinary_upload_params );

			return LJ.api.fetchCloudinaryTags()
					.then(function( cloudinary_tags ){
					  	return LJ.pictures.setupCloudinary( cloudinary_tags ); 

					})
					.then(function(){
					  	return LJ.pictures.handleDomEvents();

					}); 

			
		},
		setupCloudinary: function( cloudinary_tags ){

				// Add the input that triggers the upload to the element
				// The element is signed serverside to allow upload to cloudinary
				// Just use a CSS hack to display it on top of icon with opacity 0.01
				$('.picture__icon.--upload-desktop').each(function( i, icon ){

					$( icon ).find('.cloudinary-fileupload').remove(); // Remove previous if existed

					$( icon ).append( cloudinary_tags[i] )
						     .find('.cloudinary-fileupload')
							     .click( LJ.pictures.stageFileUpload__Profile )
								 .bind('fileuploadstart', LJ.pictures.handleFileUploadStart__Profile )
								 .bind('fileuploadprogress', LJ.pictures.handleFileUploadProgress__Profile )
								 .bind('cloudinarydone', LJ.pictures.handleCloudinaryDone__Profile)
								 .cloudinary_fileupload();
							});


				// Refresh every upload tag every 45min. They become out-dated after 1 hour.
				var delay = 1000 * 60 * 45;
	            LJ.delay( delay ).then(function(){
	            	LJ.api.fetchCloudinaryTags().then( LJ.pictures.setupCloudinary );
	            	// LJ.pictures.setupCloudinary( cloudinary_tags );
	            });

		},
		handleDomEvents: function(){

			$('.pictures').on('click', LJ.pictures.handleClickOnPicture );
			LJ.ui.$body.on('click', LJ.pictures.handleClickInModal );

		},
		handleClickInModal: function( e ){

			var $tar      = $(e.target);
			var $block    = $tar.closest('.modal');
			var img_place = $block.attr('data-img-place');		

			if( $tar.is('.modal__facebook-picture img') ){
				return LJ.pictures.toggleFacebookPictureState( $tar );
			}

			if( $tar.is('.modal-footer button') || $tar.closest('.modal-footer button').length == 1 ){
				if( $block.hasClass('--active') ){
					$block.removeClass('--active');
					LJ.ui.hideModal();
					var src = $('.modal__facebook-picture.--active').attr('data-img-src');
					LJ.pictures.uploadFacebookPicture( src, img_place )
						.then( LJ.pictures.handleUpdatePicturesSuccess );
				}
			}

		},
		handleClickOnPicture: function( e ){

			var $tar      = $(e.target);
			var $block    = $tar.closest('.picture');
			var img_place = $block.attr('data-img-place');

			if( $tar.is('.picture__icon.--upload-facebook') ){
				return LJ.facebook.showFacebookPicturesInModal( img_place );
			}

			if( $tar.is('.picture__icon.--mainify') ){
				return LJ.pictures.mainifyPicture( img_place );
			}

			if( $tar.is('.picture__icon.--trash') ){
				return LJ.pictures.deletePicture( img_place );
			}

			if( $tar.is('.picture__hashtag input')){
				return LJ.pictures.activateHashtagEdit( img_place );
			}

			if( $tar.is('.hashtag__action-validate i') || $tar.is('.hashtag__action-validate') ){
				if( $tar.closest('.hashtag-action').hasClass('--pending') ) return;
				$tar.closest('.hashtag-action').addClass('--pending');
				return LJ.pictures.updateHashtag( img_place );
			}

			if( $tar.is('.hashtag__action-cancel i') || $tar.is('.hashtag__action-cancel') ){
				if( $tar.closest('.hashtag-action').hasClass('--pending') ) return;
				return LJ.pictures.deactivateHashtagEdit( img_place );
			}


		},
		toggleFacebookPictureState: function( $pic ){

			var $block = $pic.closest('.modal');
			var $pic   = $pic.closest('.modal__facebook-picture');
			
			if( $pic.hasClass('--active') ){
				return $block.add( $('.modal__facebook-picture') ).removeClass('--active');
			}
			
			$('.modal__facebook-picture').removeClass('--active');
			$block.add( $pic ).addClass('--active');


		},
		uploadFacebookPicture: function( src, img_place ){

			LJ.log('Uploading facebook picture...');

			var $picture = $('.picture[data-img-place="' + img_place + '"]');
			var img_id	 = JSON.parse( $picture.find('.cloudinary-fileupload').attr('data-form-data') ).public_id;

			var call_id = LJ.generateId();
			LJ.ui.showLoader( call_id );

			var update = {
				url 		: src,
				call_id 	: call_id,
				img_place 	: img_place,
				img_id		: img_id
			};

			return LJ.api.uploadNewPictureUrl( update );
		 	  
		},
		uploadFacebookPicture_Intro: function(){

			var src       = 'https://graph.facebook.com/' + LJ.user.facebook_id + '/picture?width=320&height=320';
			var img_place = 0;

			var $picture = $('.picture[data-img-place="' + img_place + '"]');
			var img_id	 = JSON.parse( $picture.find('.cloudinary-fileupload').attr('data-form-data') ).public_id;

			LJ.log('Uploading facebook picture [intro]...');

			var update = {
				url 		: src,
				img_place 	: img_place,
				img_id		: img_id
			};

			LJ.api.uploadNewPictureUrl( update )
				.then( LJ.pictures.handleUpdatePicturesSuccess );

		},
		updateHashtag: function( img_place ){

			var $picture = $('.picture[data-img-place="' + img_place + '"]');
			var $input 	 = $picture.find('.picture__hashtag input');

			var new_hashtag = $input.val();

			LJ.pictures.updatePicture( img_place, "hashtag", new_hashtag );

		},
		activateHashtagEdit: function( img_place ){

			var $picture = $('.picture[data-img-place="' + img_place + '"]');
			var $input   = $picture.find('.picture__hashtag input');

			$input.attr('data-restore', $input.val() );
			$input.attr( 'readonly', false );

			if( $input.hasClass('--active') ) return;

			$input.addClass('--active');

			var css_transition = $picture.css('transition');
			$picture.css({ transition: 'none' }).velocity({ height: parseInt( $picture.css('height') ) + 40 }, {
				duration: 100,
				complete: function(){
					$picture.css({ transition: css_transition })
							.find('.hashtag-action')
							.velocity('bounceInQuick', {
								duration: LJ.ui.action_show_duration,
								display: 'flex'
							});
				}
			});

		},
		deactivateHashtagEdit: function( img_place ){

			var $picture = $('.picture[data-img-place="' + img_place + '"]');
			var $input   = $picture.find('.picture__hashtag input');

			if( !$input.hasClass('--active') ) return;

			$input.attr( 'readonly', true )
				  .val( $input.attr('data-restore') )
				  .attr('data-restore', null )
				  .removeClass('--active');

			var css_transition = $picture.css('transition');
			$picture.find('.hashtag-action').velocity('bounceOut', { duration: LJ.ui.action_hide_duration });
			$picture.css({ transition: 'none' }).velocity({ height: parseInt( $picture.css('height') ) - 40 }, {
				duration: 100,
				delay: 300,
				complete: function(){
					$picture.css({ transition: css_transition })
				}
			});

		},
		updatePicture: function( img_place, action, hashtag ){

			if( ['mainify', 'delete', 'hashtag'].indexOf( action ) == -1 ){
				return LJ.wlog('Cant upload, the action ' + action + ' is not recognized');
			}

			var update_id = LJ.generateId();
			LJ.ui.showLoader( update_id );

			var updated_pictures = [{
				'img_place' : img_place,
				'action'    : action
			}];

			if( hashtag && action == 'hashtag' ){
				updated_pictures[0].new_hashtag = hashtag;
			};


			LJ.api.updatePicture({ updated_pictures: updated_pictures, call_id: update_id })
				  .then( LJ.pictures.handleUpdatePicturesSuccess, LJ.pictures.handleUpdatePicturesError );

		},
		mainifyPicture: function( img_place ){
			return LJ.pictures.updatePicture( img_place, 'mainify' );

		},
		deletePicture: function( img_place ){
			return LJ.pictures.updatePicture( img_place, 'delete' );

		},
		handleUpdatePicturesSuccess: function( res ){

			var call_id  = res.call_id;
			var pictures = res.pictures;

			if( call_id ){
				LJ.ui.hideLoader( call_id );
			}

			LJ.pictures.upload_id_profile = null;
			LJ.ui.showToast( LJ.text('to_update_pic_success') );
			LJ.user.pictures = pictures;

			// Check if the main picture has changed
			var $o_main_pic = $('.picture.--main');
			var $n_main_pic = $('.picture[data-img-place="' + LJ.findMainPic().img_place + '"]');

			if( ! $o_main_pic.is( $n_main_pic ) ){

				$o_main_pic.removeClass('--main');
				$n_main_pic.addClass('--main');

				// Update the thumbnail
				var $img = $('.app-thumbnail').find('img');
				LJ.pictures.replaceImage( $img, {
					img_id      : $n_main_pic.attr('data-img-id'),
					img_version : $n_main_pic.attr('data-img-vs')
				});
			}

			LJ.user.pictures.forEach(function( pic ){
				var $pic = $('.picture[data-img-place="' + pic.img_place + '"]');

				if( $pic.attr('data-img-vs') != pic.img_version ){

					var options = {
						img_id		: pic.img_id,
						img_version : pic.img_version
					};

					if( $pic.hasClass('--main') ){
						LJ.pictures.replaceImage( $('.app-thumbnail').find('img'), options );
					}
					LJ.pictures.replaceImage( $pic.find('img'), options );
				}

				var $hashtag_input = $pic.find('.picture__hashtag input');
				if( $hashtag_input.val() == pic.hashtag ){
					$pic.find('.hashtag-action').removeClass('--pending');
					LJ.pictures.deactivateHashtagEdit( pic.img_place );
					$hashtag_input.val( pic.hashtag );
				}
			});


		},
		handleUpdatePicturesError: function( res ){

			var call_id = res.call_id;

			LJ.ui.hideLoader( call_id );
			LJ.pictures.upload_id_profile = null;

			if( res.err_id == 'mainify_placeholder' ){
				return LJ.ui.showToast( LJ.text('err_update_profile_mainify_placeholder'), 'error' );
			}

			if( res.err_id == 'delete_main_picture' ){
				return LJ.ui.showToast( LJ.text('err_update_profile_delete_main_picture'), 'error' );
			}

		},
		findImgInCache: function( img_id, img_version, scope ){

			return null;

		},
		storeImgInCache: function( img, img_id, img_version, scope ){



		},
		makeImgHtml: function( img_id, img_version, scope ){

			var cached_img = LJ.pictures.findImgInCache( img_id, img_version, scope );
			if( cached_img ){
				return cached_img;

			} else {
				img_params            = LJ.pictures.img_params[ scope ];
				img_params.cloud_name = LJ.pictures.cloudinary_cloud_name;
				img_params.version    = img_version;

				LJ.dev.n_cloudinary_api_calls++;
				var img = $.cloudinary.image( img_id, img_params ).attr('data-scopeid', scope ).prop('outerHTML');
				LJ.pictures.storeImgInCache( img, img_id, img_version, scope );
				return img;
			}

		},
		makeRosaceHtml: function( pictures, scope ){

			var imgs_html = [];
			pictures.forEach(function( pic ){
				imgs_html.push( LJ.pictures.makeImgHtml( pic.img_id, pic.img_vs, scope ) );
			});

			var rosace_imgs_html = ['<div class="rosace">'];
			imgs_html.forEach(function( img_html, i ){

				var part = [ "--left", "--right", "--down" ][ i ];
				if( !part ) return; // Support only 3 images max
				if( pictures.length == 1 ) part = "--center"; // Fallback to plain normal img 

				rosace_imgs_html.push([

					'<div class="rosace__part ' + part + '">',
						img_html,
					'</div>'

				].join(''));
			});
			rosace_imgs_html.push('</div>');

			return rosace_imgs_html.join('');

		},
		getUploadingState: function(){
			 return LJ.pictures.uploading_image ? "uploading" : "idle";

		},
		stageFileUpload__Profile: function(e){

			if( LJ.pictures.getUploadingState() == "uploading" ){
				e.preventDefault();
				LJ.ui.showToast( LJ.text("to_easy_on_api") );
				return LJ.wlog('Cant upload multiple files at the same time');
			}

			var $input = $(this);
			var $block = $input.closest('.picture');

			LJ.pictures.uploading_img_place = $block.attr('data-img-place');
			LJ.log('Uploading img_place : ' + LJ.pictures.uploading_img_place );

			// Upload id to uniquely identify loaders
			LJ.pictures.upload_id_profile = LJ.generateId();

			$block.find('.picture__progress-bar').attr('data-uploadid', LJ.pictures.upload_id_profile )

		},
		handleFileUploadStart__Profile: function(){

			LJ.pictures.uploading_image = true;

			LJ.ui.showLoader( LJ.pictures.upload_id_profile );
			LJ.pictures.showPictureProgressBar( LJ.pictures.upload_id_profile );

		},
		handleFileUploadProgress__Profile: function( e, data ){

			LJ.pictures.getPictureProgressBar()
				.find('.picture__progress-bar-bg')
				.css('width', Math.round( (data.loaded * 100.0) / data.total) + '%');

		},
		getPictureProgressBar: function( upload_id ){

			return $('.picture__progress-bar[data-uploadid="' + LJ.pictures.upload_id_profile + '"]');

		},
		showPictureProgressBar: function( upload_id ){

			LJ.pictures.getPictureProgressBar()
				.velocity('fadeIn', { duration: LJ.pictures.upload_ux_duration });

		},
		hidePictureProgressBar: function( upload_id ){

			LJ.ui.hideLoader( upload_id );

			LJ.pictures.getPictureProgressBar()
				.velocity('fadeOut', { duration: LJ.pictures.upload_ux_duration })
				.find('.picture__progress-bar-bg').css({ width: '0%' });

		},
		handleCloudinaryDone__Profile: function( e, data ){

			// Known by the app because tied to whatever photo triggered the upload
			// These are essentially used to determine uniquely which pic is being updated
			LJ.log('Uploading now the picture to the server...');
			var img_place   = LJ.pictures.uploading_img_place;

			// Known by cloudinary
			var img_id      = data.result.public_id// important
			var img_version = data.result.version;

			var update = {
				img_id           : img_id,
				img_version      : img_version,
				img_place        : img_place
			};
			
			LJ.api.uploadNewPicture( update )
				  .then( LJ.pictures.handleNewPictureSuccess );

		},
		handleNewPictureSuccess: function( new_picture ){

			// Update cache
			LJ.user.pictures.forEach(function( pic, i ){
				if( pic.img_place == new_picture.img_place ){
					LJ.user.pictures[i] = new_picture;
				}
			})

			$('.picture__progress-bar[data-uploadid="' + LJ.pictures.upload_id_profile + '"]')
				.find('.picture__progress-bar-bg')
				.css('width', '100%');

			var $block = $('.picture[data-img-place="' + new_picture.img_place + '"]');

			LJ.ui.showToast( LJ.text("to_upload_pic_success") );

			var options = {
				img_id 		: new_picture.img_id,
				img_version	: new_picture.img_version
			};

			if( new_picture.is_main ){
				LJ.pictures.replaceImage( $block.find('img'), options );
				LJ.pictures.replaceImage( $('.app-thumbnail').find('img'), options );
			} else {
				LJ.pictures.replaceImage( $block.find('img'), options );
			}

		},
		resetUploadState: function(){
			
			LJ.pictures.uploading_image 	  = false;
			LJ.pictures.uploading_img_place   = null;
			LJ.pictures.upload_id_profile 	  = null;

		},
		replaceImage: function( o_img, options ){

			$o_img = o_img instanceof jQuery ? o_img : $( o_img );

			if( $o_img.length != 1 || !$o_img.is('img') ){
				return LJ.wlog('Cant replace image, unable to uniquely identify the image on dom, length is ' + $o_img.length);
			}

			var scope    = $o_img.attr('data-scopeid');
			var $new_img = $( LJ.pictures.makeImgHtml( options.img_id, options.img_version, scope ) );

			// Duplicate classes
			var o_classes = ( $o_img.attr('class') || '' ).split(' ');

			if( o_classes.indexOf('none') == -1 ){
				o_classes.push('none');
			}
			
			o_classes = o_classes.filter( Boolean );

			$new_img.attr('class', o_classes.join(''));
			$new_img.insertAfter( $o_img );
			$new_img.closest('.picture')
					.attr('data-img-id', options.img_id )
					.attr('data-img-vs', options.img_version );


			var duration = options.duration || LJ.pictures.upload_ux_duration;
			$o_img.velocity('fadeOut', {
				duration: duration,
				complete: function(){
					
					$(this).remove();
					$new_img.imagesLoaded(function(){

						// Special case, when the replace occurs after desktop upload
						if( LJ.pictures.upload_id_profile ){
							LJ.pictures.hidePictureProgressBar( LJ.pictures.upload_id_profile );
						}

						$new_img.velocity('fadeIn', { duration: duration });

						LJ.pictures.resetUploadState();

					});
				}
			});

		},
		applyFilterlay( $wrapper ){

			var $img_wrapper = $wrapper.find('.js-filterlay')
			if( $img_wrapper.length == 0 ){
				return;
			}

			if( $img_wrapper.find('.--filterlay').length != 0 ){
				return;
			}

			if( $img_wrapper.css('position') != "absolute" ){
				$img_wrapper.css({ 'position': 'relative' });
			}

			$img_wrapper.append( $('<div class="pictures-overlay --filterlay"></div>') );

		}


	});

	window.LJ.profile = _.merge( window.LJ.profile || {}, {

		$profile:   $('.menu-section.--profile'),
		$pictures:  $('.pictures'),
		$thumbnail: $('.app-thumbnail'),

		init: function( resolve, reject ){
			return LJ.promise(function( resolve, reject ){
				
				LJ.api.fetchMe()
					.then( LJ.log("User profile fetched"))
					.then( LJ.profile.setMyInformations )
					.then( LJ.profile.setMyThumbnail )
					.then( LJ.profile.setMyPictures )
					.then( LJ.profile.setMyHashtags )
					.then( LJ.pictures.init )
					.then( LJ.settings.init )
					.then( LJ.profile.handleDomEvents )
					.then( LJ.search.initFilters )
					.then( LJ.seek.activatePlacesInProfile )
					.then( resolve )

			});

		},
		setMyInformations: function(){

			$('#me__name').val( LJ.user.name );
			$('#me__job').val( LJ.user.job );
			$('#me__ideal-night').val( LJ.user.ideal_night );
			$('#me__location').val( LJ.user.location.place_name );
			$('#me__country').val( LJ.text_source["country_" + LJ.user.country_code ][ LJ.lang.getAppLang() ]);

			// Set age restrictions
			$('#me__age').val( LJ.user.age )
				 .attr('max', LJ.app_settings.app.max_age )
				 .attr('min', LJ.app_settings.app.min_age );

				
		},
		setMyThumbnail: function(){

			$('.thumbnail__name').text( LJ.user.name );


		},
		setMyHashtags: function(){

			LJ.user.pictures.forEach(function( picture, i ){
				var hashtag = picture.hashtag;
				$('.picture').eq( i ).find('.picture__hashtag input').val( hashtag );
			});

		},
		setMyPictures: function(){

			// Thumbnail picture
			var main_pic = LJ.findMainPic();
			LJ.profile.$thumbnail.find('img').replaceWith( LJ.pictures.makeImgHtml( main_pic.img_id, main_pic.img_version, 'me-thumbnail') );

			// Profile pictures
			var html = [];
			LJ.user.pictures.forEach(function( pic ){
				html.push( LJ.profile.renderPicture( pic ) );
			});
			LJ.profile.$pictures.append( html.join('') );

		},
		handleDomEvents: function(){

			LJ.profile.$profile.on('click', 'input, textarea, .edit',   LJ.profile.activateInput );
			LJ.profile.$profile.on('click', '.action__cancel',   		LJ.profile.deactivateInput );
			LJ.profile.$profile.on('click', '.action__validate', 		LJ.profile.updateProfile );

		},
		handleApiError: function( err ){

			var err_ns    = err.namespace;
			var err_data  = err.err_id;
			var call_id   = err.call_id

			if( err.namespace == 'update_profile_base' ){
				$('[data-callid="' + call_id + '"]').removeClass('--validating'); 
				LJ.ui.showToast('La mise  jour na pas t effectue', 'error');
				return;
			}

		},
		activateInput: function( element ){

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.me-item');
			var $input = $block.find('input, textarea');

			if( $block.hasClass('--active') || $block.hasClass('--no-edit') ){
				return;
			} else {
				$block.addClass('--active'); 
			}

			$input.attr( 'readonly', false );

			$block.find('.action')
				  .velocity('bounceInQuick', {
				  	duration: LJ.ui.action_show_duration,
				  	display: 'flex'
				  });

			$block.find('.edit')
				  .velocity('bounceOut', {
				  	duration: 10,
				  	display: 'none'
				  });

			$block.attr('data-restore', $input.val() );

		},
		deactivateInput: function( element ){

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.me-item');
			var $input = $block.find('input, textarea');

			if( $block.hasClass('--active') ){
				$block.removeClass('--active').removeClass('--validating');
			} else {
				return;
			}

			$input.attr( 'readonly', true );

			$block.find('.action')
				  .velocity('bounceOut', {
				  	duration: LJ.ui.action_hide_duration,
				  	display: 'none'
				  });

			$block.find('.edit')
				  .velocity('bounceInQuick', {
				  	duration: LJ.ui.action_show_duration,
				  	delay: 400,
				  	display: 'flex'
				  });

			var former_value = $block.attr('data-restore');
			if( former_value != null ){
				$input.val( former_value );
				$block.attr( 'data-restore', null );
			}

		},
		updateProfile: function( element ){

			var update = {};

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.me-item');
			var $input = $block.find('input, textarea');

			if( $block.length == 0 || !$block.hasClass('--active') || $block.hasClass('--validating') ){
				return LJ.wlog('Not calling the api');
			}

			if( $input.val() == $block.attr('data-restore') ){
				LJ.profile.deactivateInput.call( this, element );
				return LJ.wlog('Not calling the api (same value)');
			}

			var new_value = $block.find('input,textarea').val();
			var attribute = $block.attr('data-param');
			var call_id = LJ.generateId();

			update[ attribute ] = new_value;
			update[ 'call_id' ] = call_id;

			// Location is a specific case.
			if( attribute == "location" ){

				if( !LJ.seek.profile_places.getPlace() ) return;				
				
				$block.attr('data-store', LJ.seek.profile_places.getPlace().formatted_address );		
				update.location = {
					place_name : LJ.seek.profile_places.getPlace().formatted_address,
					place_id   : LJ.seek.profile_places.getPlace().place_id,
					lat 	   : LJ.seek.profile_places.getPlace().geometry.location.lat(),
					lng 	   : LJ.seek.profile_places.getPlace().geometry.location.lng()
				};
			}

			$block.attr( 'data-callid', call_id ).addClass('--validating');
			
			LJ.log('Updating profile...');
			LJ.api.updateProfile( update )
				  .then( LJ.profile.handleUpdateProfileSuccess, LJ.profile.handleApiError );

		},
		handleUpdateProfileSuccess: function( exposed ){

			LJ.ui.showToast( LJ.text('to_profile_update_success') );

			$('.thumbnail__name').text( exposed.user.name );

			var $block  = $('.me-item[data-callid="' + exposed.call_id + '"]');
			var $input  = $block.find('input, textarea');
			var $action = $block.find('.action');

			// For location attribute specificity
			if( $block.attr('data-store') ){
				$input.val( $block.attr('data-store') );
			}

			$block.attr('data-restore', null );
			LJ.profile.deactivateInput( $input );
			

		},
		renderPicture: function( pic ){

			var img_html = LJ.pictures.makeImgHtml( pic.img_id, pic.img_version, "me" );
			var main     = pic.is_main ? '--main' : '';
			return LJ.ui.render([

				'<div class="picture ' + main + '" data-img-place="' + pic.img_place + '" data-img-id="' + pic.img_id + '" data-img-vs="' + pic.img_version + '">',
		            img_html,
		            '<div class="picture__ribbon-main" data-lid="picture_main_label"></div>',
		            '<div class="picture__progress-bar">',
		            	'<div class="picture__progress-bar-bg"></div>',
		            '</div>',
		            '<div class="picture-icon">',
		            	LJ.ui.renderIcon('upload', 	 	 ['picture__icon', '--upload-desktop']),
		            	LJ.ui.renderIcon('facebook', 	 ['picture__icon', '--upload-facebook']),
		            	LJ.ui.renderIcon('main-picture', ['picture__icon', '--mainify']),
		            	LJ.ui.renderIcon('trash', 		 ['picture__icon', '--trash']),
		            '</div>',
		            '<div class="picture__hashtag hashtag">',
		            	'<span class="hashtag__hash">#</span>',
		            	'<input readonly type="text" placeholder="hashtag">',
		            	'<div class="hashtag-action">',
			            	'<div class="hashtag__action-validate">',
			            		LJ.ui.renderIcon('check'),
			            	'</div>',
			            	'<div class="hashtag__action-cancel">',
			            		LJ.ui.renderIcon('cancel'),
			            	'</div>',
		            	'</div>',
		            '</div>',
	          '</div>'

			].join(''));

		}
	});










































	
	window.LJ.profile_user = _.merge( window.LJ.profile_user || {}, {

		slide_show_duration: 300,
		slide_hide_duration: 300,

		init: function(){
			
			LJ.profile_user.handleDomEvents();
			
		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.user-profile .user-pics__navigate', LJ.profile_user.handlePictureNavigation );
			LJ.ui.$body.on('click', '.thumbnail__picture', LJ.profile_user.showMyUserProfile );

		},
		handlePictureNavigation: function(){

			var $self = $(this);
			var $picture_activated = $('.user-pics__img.--active');

			if( $self.hasClass('--right') ){
				var $picture_to_activate = $picture_activated.next();
			} else {
				var $picture_to_activate = $picture_activated.prev();
			}

			var img_place_to_activate = $picture_to_activate.attr('data-img-place');

			if( !img_place_to_activate ) return; // user clicked too fast, i guess :) 
			LJ.profile_user.activatePicture( img_place_to_activate );

		},
		refreshNavigationArrow: function(){

			var n_pic    = $('.user-pics__img').length;
			var duration = 50;
			
			$('.user-pics__navigate.out').removeClass('out').velocity('fadeIn', { duration: duration, display: 'flex' });

			if( $('.user-pics__img').eq(n_pic - 1).hasClass('--active') ){
				$('.user-pics__navigate.--right').addClass('out').velocity('fadeOut', { duration: duration });
			} 

			if( $('.user-pics__img').eq( 0 ).hasClass('--active') ){
				return $('.user-pics__navigate.--left').addClass('out').velocity('fadeOut', { duration: duration });
			}

		},
		activatePicture: function( img_place ){

			var $picture_activated   = $('.user-pics__img.--active');
			var $picture_to_activate = $('.user-pics__img[data-img-place="' + img_place + '"]');

			if( $picture_activated.is( $picture_to_activate ) ){
				return LJ.log('Picture already activated, doing nuttin');
			}

			var start_opa_1 = $picture_to_activate.css('opacity');
			$picture_to_activate.addClass('--active').velocity({ opacity: [ 1, start_opa_1 ] }, {
				duration: 300
			});

			var start_opa_2 = $picture_activated.css('opacity');
			$picture_activated.removeClass('--active').velocity({ opacity: [ 0, start_opa_2 ] }, {
				duration: 300
			});

			LJ.profile_user.refreshNavigationArrow();


		},
		showMyUserProfile: function(){
			LJ.profile_user.showUserProfile( LJ.user.facebook_id );

		},
		showUserProfile: function( facebook_id ){

			var user;
			var $container;
			var $content;

			LJ.ui.showSlideAndFetch({

				"type"			: "profile",

				"fetchPromise"	: LJ.api.fetchUserProfile,
				"promise_arg"   : facebook_id,

				"errHandler"    : LJ.profile_user.handleShowUserProfileError

			})
			.then(function( expose ){				
				user = expose.user;
				return LJ.profile_user.renderUserProfile( user );

			})
			.then(function( user_html ){
				$container = $('.slide.--profile').find('.slide-body');
				LJ.profile_user.addUserProfile( user_html, $container );
				$content = $container.children(':not(.slide__loader)');

			})
			.then(function(){
				return LJ.ui.shradeOut( $container.find('.slide__loader'), LJ.ui.slide_hide_duration );

			})
			.then(function(){
				return LJ.profile_user.processProfileBeforeDisplay( $content );

			})
			.then(function(){
				LJ.ui.shradeIn( $content, LJ.profile_user.slide_show_duration );				

			})

		},
		addUserProfile: function( user_html, $container ){
			return $container.append( user_html );

		},
		processProfileBeforeDisplay: function(){
			LJ.profile_user.activatePicture(0);

		},
		renderUserProfileImage: function( pic ){

			return [
					'<div class="user-pics__img"',
					'data-img-id="'    + pic.img_id + '"',
					'data-img-vs="'    + pic.img_version + '"',
					'data-img-place="' + pic.img_place + '">',
						LJ.pictures.makeImgHtml( pic.img_id, pic.img_version, 'user-profile' ),
					'</div>'
				].join('')

		},
		renderUserProfile: function( user ){

			// Dynamically translate country code into human readable country with associate flag
			var country_html = LJ.text( 'country_' + user.country_code ) + '<i class="flag-icon flag-icon-' + user.country_code + '"></i>';

			// Render the pictures block
			var pictures_html = [];
			user.pictures.forEach(function( pic ){

				// Only append picture if its not the placeholder one. In case the placeholder has changed 
				// on the server, make also a test on the name to make sure the string "placeholder" isnt in there"
				if( pic.img_id != LJ.app_settings.placeholder.img_id && !/placeholder/i.test( pic.img_id ) ){
					var pic_html = LJ.profile_user.renderUserProfileImage( pic );
					pictures_html.push( pic_html );
				}

			});
			pictures_html = pictures_html.join('');

			var job 		= user.job || LJ.text("w_na");
			var ideal_night = user.ideal_night || LJ.text("w_na");

			return LJ.ui.render([
				'<div class="user-profile" data-facebook-id="' + user.facebook_id + '">',
					'<div class="user-pics js-filterlay">',
						'<div class="user-pics__navigate --left --round-icon">',
							'<i class="icon icon-arrow-left"></i>',
						'</div>',
						'<div class="user-pics__navigate --right --round-icon">',
							'<i class="icon icon-arrow-right"></i>',
						'</div>',
						pictures_html,
					'</div>',
					'<div class="user-infos">',
						'<div class="user-actions">',
							// '<div class="user-actions__share --round-icon">',
							// 	'<i class="icon icon-forward"></i>',
							// '</div>',
							// '<div class="user-actions__meepass --round-icon">',
							// 	'<i class="icon icon-meepass"></i>',
							// '</div>',
						'</div>',
						'<div class="user-infos__item --base --'+ user.gender +'">',
							'<h2>' + user.name + '</h2>',
							'<span class="comma">,</span>',
							'<span>'+ user.age +'</span>',
						'</div>',
						// '<div class="user-infos__title">',
						// 	'<div class="user-infos__title-splitter"></div>',
						// 	'<label data-lid="user_profile_about"></label>',
						// 	'<div class="user-infos__title-splitter"></div>',
						// '</div>',
						// '<div class="user-infos__item --age">',
						// 	'<div class="user-infos__icon --round-icon">',
						// 		'<i class="icon icon-gift"></i>',
						// 	'</div>',
						// 	'<label>' + user.age + '</label>',
						// '</div>',
						'<div class="user-infos__item --job">',
							'<div class="user-infos__icon --round-icon">',
								'<i class="icon icon-education"></i>',
							'</div>',
							'<label>' + job + '</label>',
						'</div>',
						'<div class="user-infos__item --country">',
							'<div class="user-infos__icon --round-icon">',
								'<i class="icon icon-flag"></i>',
							'</div>',
							'<label>' + country_html + '</label>',
						'</div>',
						'<div class="user-infos__item --location">',
							'<div class="user-infos__icon --round-icon">',
								'<i class="icon icon-location-barred"></i>',
							'</div>',
							'<label>' + user.location.place_name.split(',').join('<span>') + '</span></label>',
						'</div>',
						'<div class="user-infos__title">',
							'<div class="user-infos__title-splitter"></div>',
							'<label data-lid="user_profile_ideal_night"></label>',
							'<div class="user-infos__title-splitter"></div>',
						'</div>',
						'<div class="user-infos__item --ideal-night">',
							'<div class="user-infos__icon --round-icon">',
								'<i class="icon icon-dj"></i>',
							'</div>',
							'<label>' + ideal_night + '</label>',
						'</div>',
					'</div>',
				'</div>'

				].join(''));


		},
		handleShowUserProfileError: function( err ){

        	if( err.err_id == "ghost_user" ){
        		LJ.profile_user.ghostifyUserProfile();
        	}

        },
		ghostifyUserProfile: function(){

        	var duration      = 400;
        	var $user_ghost = $( LJ.profile_user.renderUserProfileGhost() );

        	$('.slide.--profile')
        		.find('.slide__loader')
        		.velocity('shradeOut', {
        			duration: duration,
        			complete: function(){
        				$( this ).remove();
        			}
        		});

        	$user_ghost
        		.hide()
        		.appendTo( $('.slide-body') )
        		.velocity('shradeIn', {
        			duration: duration,
        			delay   : duration,
        			display : 'flex'
        		});

        },
        renderUserProfileGhost: function(){

        	return LJ.ui.render([

        		'<div class="slide-ghost">',
        			'<div class="slide-ghost__icon --round-icon">',
        				'<i class="icon icon-search-light"></i>',
        			'</div>',
        			'<div class="slide-ghost__title">',
        				'<span data-lid="profile_ghost_title"></span>',
        			'</div>',
        			'<div class="slide-ghost__subtitle">',
        				'<span data-lid="profile_ghost_subtitle"></span>',
        			'</div>',
        			'<div class="slide-ghost__action">',
        				'<button data-lid="profile_ghost_btn" class="slide__close"></button>',
        			'</div>',
        		'</div>'

        	].join(''));

        }

	});

	window.LJ.realtime = _.merge( window.LJ.realtime || {}, {

		state    : null,
		pusher   : {},
		channels : {},

		init: function(){

			LJ.realtime.setupRealtimeService();
			LJ.realtime.subscribeToAllChannels();
			return;

		},
		getUserChannels: function( channel_type ){

			var channels = _.filter( LJ.user.channels, function( chan ){
				return chan.type == channel_type;
			});

			return _.map( channels, 'name' );

		},
		hasSubscribed: function( channel_name ){

			return LJ.realtime.channels[ channel_name ];

		},
		addNotification: function( data ){

			if( !data.notification || (data.requester && data.requester == LJ.user.facebook_id) ){
				return;
			}

			LJ.notifications.cacheNotification( data.notification );
			LJ.notifications.refreshNotifications();

		},
		setupRealtimeService: function(){

			if( !LJ.app_token ){
				return LJ.wlog('Cannot init realtime services without a valid app_token: ' + LJ.app_token );
			}

			 LJ.realtime.pusher = new Pusher( window.pusher_app_id, {
                encrypted: true,
                // The route to be called everytime the subscrib() method is called
                authEndpoint: '/auth/pusher',
                auth: {
                    headers: {
                        "x-access-token": LJ.app_token
                    } // @48723
                }
            });

            LJ.realtime.state = "idle";
            LJ.realtime.pusher.connection.bind('state_change', function( states ) {

            	var current_state = states.current;
                LJ.ilog('Pusher state is now: ' + current_state );

                // Reconnexion cases 
                if( LJ.realtime.state == 'connected' ){

                	if( current_state == 'connecting' ){
                		LJ.ui.handleReconnection();

                	}
                	if( current_state == 'connected' ){
                		LJ.ui.reconnectUser();

                	}

                } else {
                	LJ.realtime.state = current_state;

                }
                

            });

		},
		subscribeToAllChannels: function(){

			LJ.realtime.subscribeToPrivateChannel();
			LJ.realtime.subscribeToLocationChannel();
			LJ.realtime.subscribeToBeforeChannels();
			LJ.realtime.subscribeToChatChannels();

		},
		getSocketId: function(){
			return LJ.realtime.pusher.connection ? LJ.realtime.pusher.connection.socket_id : null;

		},
		// Subscribe to private events
		// main usage is to keep track of user's online status via a webhook
		subscribeToPrivateChannel: function(){

			var channel_name = LJ.realtime.getUserChannels("personnal")[0];

			if( LJ.realtime.hasSubscribed( "personnal" ) ) return;

			LJ.log('Subscribing to personnal channel');
			LJ.realtime.channels.personnal = LJ.realtime.pusher.subscribe( channel_name );
			
			LJ.realtime.channels.personnal.bind('new hello'		 	 	    , LJ.log ); // Test channel
			LJ.realtime.channels.personnal.bind('new before hosts'   	    , LJ.realtime.handleNewMarkedAsHost );
			LJ.realtime.channels.personnal.bind('new request group'  	    , LJ.realtime.handleNewRequestGroup );
			LJ.realtime.channels.personnal.bind('new before status members' , LJ.realtime.handleNewBeforeStatusMembers );


		},
		handleNewMarkedAsHost: function( data ){

			LJ.log('Push event received, data : ');
			LJ.log( data );

			var before      = data.before;
			var before_item = data.before_item;

			var channel_item_before = data.channel_item_before;
			var channel_item_team   = data.channel_item_team;

			// Little toast to show for everyone but the main_host
			if( before.main_host != LJ.user.facebook_id ){
				var friend_name = LJ.friends.getFriendsProfiles( before.main_host )[0].name;
				LJ.ui.showToast( LJ.text('to_before_create_success_friends').replace('%name', friend_name ));
			} else {
				LJ.ui.showToast( LJ.text('to_before_create_success') );
			}

			// Update user state and add marker accordingly
			LJ.user.befores.push( before_item );

			// Cache new channels
			LJ.user.channels.push( channel_item_before );
			LJ.user.channels.push( channel_item_team );

			// Refresh all channels subscriptions
			LJ.realtime.subscribeToAllChannels();
			LJ.chat.fetchAndAddOneChat( channel_item_team );

			// Add notification in real time
			LJ.realtime.addNotification( data );

		},
		handleNewRequestGroup: function( data ){

			LJ.log(data);
			
			if( data.group.main_member != LJ.user.facebook_id ){

				LJ.log('A friend requested to participate in a before with you!');
				LJ.ui.showToast( LJ.text('to_cheers_sent_success_friend') );

			} else {

				LJ.ui.showToast( LJ.text('to_cheers_sent_success') );

			}

			LJ.user.befores.push( data.before_item );
			LJ.cheers.fetched_cheers.push( data.cheers_item );
			LJ.cheers.refreshCheersItems();
			LJ.user.channels.push( data.channel_item_team );

			LJ.before.pendifyBeforeInview( data.before_id );
			LJ.before.pendifyBeforeMarker( data.before_id );

			LJ.realtime.subscribeToAllChannels();

			LJ.chat.fetchAndAddOneChat( data.channel_item_team, {
				"row_insert_mode": "top"
			});

			// Add notification in real time
			LJ.realtime.addNotification( data );

		},
		handleNewBeforeStatusMembers: function( data ){

			var hosts     = data.hosts;
			var status    = data.status;
			var before_id = data._id;

			// Force a resync of all the chats with updated server values
			LJ.chat.resyncAllChats();

		},
		// Subcribe to events about a specific geo area 
		//to get pushed realtime notifications about newly created events
		subscribeToLocationChannel: function(){

			var channel_name =  LJ.realtime.getUserChannels("location")[0];

			if( LJ.realtime.hasSubscribed( "location" ) ) return;

			LJ.log('Subscribing to location channel');
			LJ.realtime.channels.location = LJ.realtime.pusher.subscribe( channel_name );

			LJ.realtime.channels.location.bind('new hello'		   , LJ.log ); // Test channel
			LJ.realtime.channels.location.bind('new before' 	   , LJ.realtime.handleNewBefore );
			LJ.realtime.channels.location.bind('new before status' , LJ.realtime.handleNewBeforeStatus );

		},
		handleNewBefore: function( data ){

			var before = data.before;

			LJ.map.addBeforeMarker( before );
			LJ.before.fetched_befores.push( before );
			LJ.before.refreshBrowserDates();
		
		},
		handleNewBeforeStatus: function( data ){

			LJ.log('Push event received, data : ');
			LJ.log( data );

			var before_id = data.before_id;
			var status 	  = data.status;
			var hosts 	  = data.hosts;

			if( status == "canceled" ){

				LJ.map.removeBeforeMarker( before_id );
				LJ.before.removeOneBefore( before_id );
				LJ.before.refreshBrowserDates();

				// If the user is viewing the before, take control of his ui and notify before is gone
				var $be = $('.be-inview[data-before-id="'+ before_id +'"]');
				if( $be.length > 0 ){

					LJ.ui.hideModal();
					LJ.before.cancelifyBeforeInview();

				}

			}


		},
		// Subscribe to channels for *hosts only*
		// to get pushed anytime a group request a participation
		subscribeToBeforeChannels: function(){

			var before_channels = _.filter( LJ.user.channels, function( chan ){
				return chan.type == "before";
			});

			before_channels.forEach(function( chan ){
				LJ.realtime.subscribeToBeforeChannel( chan.name );
			});

		},
		subscribeToBeforeChannel: function( channel_name ){

			// LJ.log('Subscribing to before channel : ' + channel_name );
			if( LJ.realtime.hasSubscribed( channel_name ) ) return;

			LJ.realtime.channels[ channel_name ] = LJ.realtime.pusher.subscribe( channel_name );

			LJ.realtime.channels[ channel_name ].bind('new hello'		  	   , LJ.log ); // Test channel
			LJ.realtime.channels[ channel_name ].bind('new request host'  	   , LJ.realtime.handleNewRequestHost );
			LJ.realtime.channels[ channel_name ].bind('new before status host' , LJ.realtime.handleNewBeforeStatusHosts );

		},
		handleNewRequestHost: function( data ){

			LJ.log( data );
			// LJ.log('Someone requested to participate in your before');

			LJ.ui.showToast( LJ.text('to_cheers_received_success') );
			LJ.cheers.fetched_cheers.push( data.cheers_item );
			LJ.cheers.refreshCheersItems();

			// Add notification in real time
			LJ.realtime.addNotification( data );


		},
		handleNewBeforeStatusHosts: function( data ){

			// LJ.log('Push event received, data : ');
			LJ.log( data );

			var before_id   = data.before_id;
			var hosts 	    = data.hosts;
			var status 	    = data.status;
			var requester   = data.requester;

			var friend_name = LJ.friends.getFriendsProfiles( requester )[0].name;

			if( status == "canceled" ){
				LJ.ui.showToast( LJ.text('to_friend_canceled_event').replace( '%name', friend_name ) );

			}

			// Add notification in real time
			LJ.realtime.addNotification( data );

		},
		// Subscribe to specific chat channels for hosts & requesters.
		// There are 2 chat channels per event.
		subscribeToChatChannels: function( channels ){

			var chat_channels = _.filter( LJ.user.channels, function( chan ){
				return /chat/i.test( chan.type );
			});

			chat_channels.forEach(function( chan ){
				LJ.realtime.subscribeToChatChannel( chan.name );
			});

		},
		subscribeToChatChannel: function( channel_name ){

			// LJ.log('Subscribing to chat channel : ' + channel_name );
			if( LJ.realtime.hasSubscribed( channel_name ) ) return;

			LJ.realtime.channels[ channel_name ] = LJ.realtime.pusher.subscribe( channel_name );

			LJ.realtime.channels[ channel_name ].bind('new hello'		        , LJ.log ); // Test channel
			LJ.realtime.channels[ channel_name ].bind('new group status hosts'  , LJ.realtime.handleNewGroupStatusHosts );
			LJ.realtime.channels[ channel_name ].bind('new group status users'  , LJ.realtime.handleNewGroupStatusUsers );
			LJ.realtime.channels[ channel_name ].bind('new chat message'        , LJ.realtime.handleNewChatMessage );
			LJ.realtime.channels[ channel_name ].bind('new chat seen by'        , LJ.realtime.handleNewChatSeenBy );
			
		},
		handleNewGroupStatusHosts: function( data ){

			LJ.log( data );

			var sender_id    = data.sender_id;
			var before_id    = data.before_id;
			var cheers_id    = data.cheers_id;
			var channel_item = data.channel_item;
			var status 	     = data.status;
			var n_hosts 	 = data.n_hosts;

			if( status != "accepted" ){
				return LJ.wlog('Status != "accepted", not implemented yet');
			}

			// Refresh all channels subscriptions
			LJ.user.channels.push( channel_item );
			LJ.realtime.subscribeToAllChannels();

			// Add the new chat for people to get to know each otha :)
			LJ.chat.fetchAndAddOneChat( channel_item )
				.then(function(){

					LJ.ui.showToast( LJ.text("to_group_accepted_hosts") );

					// Smooth ui transition to terminate the cheers back process
					if( sender_id == LJ.user.facebook_id ){
						LJ.cheers.acceptifyCheersItem( channel_item.chat_id );
					}

					// Update the cheers
					LJ.cheers.updateCheersItem( cheers_id, { status: status });
					LJ.cheers.acceptifyCheersRow( cheers_id );

					// Add notification in real time
					LJ.realtime.addNotification( data );

				});

		},
		handleNewGroupStatusUsers: function( data ){

			LJ.log( data );

			var sender_id    = data.sender_id;
			var before_id    = data.before_id;
			var cheers_id    = data.cheers_id;
			var channel_item = data.channel_item;
			var status 	     = data.status;
			var n_users 	 = data.n_users;

			if( status != "accepted" ){
				return LJ.wlog('Status != "accepted", not implemented yet');
			}

			// Refresh all channels subscriptions
			LJ.user.channels.push( channel_item );
			LJ.realtime.subscribeToAllChannels();


			// Add the new chat for people to get to know each otha :)
			LJ.chat.fetchAndAddOneChat( channel_item )
				.then(function(){

					LJ.ui.showToast( LJ.text("to_group_accepted_users") );

					// Update the cheer_item
					LJ.cheers.updateCheersItem( cheers_id, { status: status });
					LJ.cheers.acceptifyCheersRow( cheers_id );

					// Update the before_item and the before marker
					LJ.before.updateBeforeItem( before_id, { status: status });
					LJ.before.acceptifyBeforeMarker( before_id );

					// Add notification in real time
					LJ.realtime.addNotification( data );

				});

			// Specific to the users
			LJ.chat.acceptifyChatInview( before_id );

		},	
		handleNewChatMessage: function( data ){

			// LJ.log('Adding chatline ');

			var chat_id   = data.chat_id;
			var message   = data.message;
			var sender_id = data.sender_id;
			var call_id   = data.call_id;
			var sent_at   = data.sent_at;
			var seen_by   = data.seen_by;

			var chat = LJ.chat.getChat( chat_id );

			if( !chat ){

				LJ.wlog('New message received for a chat that wasnt fetched. Fetching first...');
				LJ.wlog('Not implemented yet! Construct the channel item, then fetch chat');
				return LJ.chat.fetchAndAddOneChat( channel_item, {
					row_insert_mode: "top"
				})
				.then(function(){
					// Recall itself after the chat has been fetched
					LJ.chat.handleNewChatMessage( data );

				});
			}

			LJ.chat.cacheChatMessage( chat_id, data );

			if( LJ.chat.getActiveChatId() == chat_id ){
				LJ.chat.sendSeenByProxy( chat_id );
				LJ.chat.seenifyChatInview( chat_id, LJ.user.facebook_id );

			}


			// Local variation regarding the inview ui of the chatline
			sender_id == LJ.user.facebook_id ? LJ.chat.dependifyChatLine( call_id ) : LJ.chat.addChatLine( data );

			LJ.chat.refreshChatState( chat_id );

		},
		handleNewChatSeenBy: function( data ){

			var chat_id = data.chat_id;
			var seen_by = data.seen_by;

			LJ.log('New message seen by : ' + seen_by );
			LJ.chat.seenifyChatInview( chat_id, seen_by );
			LJ.chat.refreshChatSeenBy( chat_id );

		}

	});
	
	// Needs to be loaded before lj-ui

	window.LJ.router = _.merge( window.LJ.router || {}, {

		init: function(){
			
		}

	});

	window.LJ.fn = _.merge( window.LJ.fn || {}, {

		initRouter: function(){

			// Reference
			var wl = window.location;

			// Routing table to map each url to a button to click
			LJ.router = {
				me: {
					elem: '#profile'
				},
				events: {
					elem     : '#events',
					callback : function(){

					}
				},
				settings: {
					elem: '#settings'
				}
			};

			LJ.$body.on('click', '[data-hash]', function(e){

				var $self = $(this);

				// Prevent trigger state visit on parents
				e.stopPropagation();

				// Move the url to the current hash state
				var hash = $self.attr('data-hash');
				wl.hash = '#' + hash;

			});

			$( window ).on('hashchange', function(){

				var hash   = wl.hash.split('#')[1]
				var target = LJ.router[ hash ].elem; 

				$( target ).click();

			});

		}

	});

	window.LJ.search = _.merge( window.LJ.search || {}, {

		fetched_users 			: [],

		users_count 			: 0,
		fetching_users			: false,
		all_fetched 		  	: false,

		fetch_more_scroll_ratio : 0.97,
		refetch_callstack: [],

		init: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.search.handleDomEvents();
				LJ.search.fetchAndShowMoreUsers();
				LJ.search.setCountriesInFilters();
				LJ.search.addLoader();
				resolve();

			});
		},
		handleDomEvents: function(){

			LJ.ui.$body.on('click', '.search-user__pic', LJ.search.handleClickUser );
			LJ.ui.$body.on('click', '.search-filters__icon', LJ.search.showFilters );
			LJ.ui.$body.on('click', '.search-filters__close', LJ.search.hideFilters );
			LJ.ui.$body.on('click', '.search-filters .toggle', LJ.search.handleToggleFilter );
			LJ.ui.$window.scroll( LJ.search.handleFetchMoreUsers );
			
		},
		addLoader: function(){

			$('.search-users').append( LJ.static.renderStaticImage('search_loader') )

		},
		handleClickUser: function(){

			var facebook_id = $(this).closest('.search-user').attr('data-facebook-id');

			LJ.profile_user.showUserProfile( facebook_id );

		},
		handleToggleFilter: function(){

			var $to = $(this);
			$to.toggleClass('--active');
			LJ.search.setFiltersState();
			LJ.search.refetchAndShowMoreUsers();

		},
		allowedToFetchMore: function(){
			
			var data_to_fetch        = !LJ.search.all_fetched;
			var scroll_almost_bottom = LJ.ui.getScrollRatio() > LJ.search.fetch_more_scroll_ratio;
			var search_panel_active  = $('.app__menu-item.--search').hasClass('--active');
			var user_not_fetching    = !LJ.search.fetching_users;

			if( data_to_fetch && scroll_almost_bottom && search_panel_active && user_not_fetching ){
				return true;
			} else {
				return false;
			}

		},
		handleFetchMoreUsers: function(){

			if( !LJ.search.allowedToFetchMore() ) return;

			LJ.log('Fetching more users...');
			LJ.search.fetchAndShowMoreUsers();

		},
		fetchMoreUsers: function(){
			return LJ.promise(function( resolve, reject ){

				LJ.search.setFiltersState();

				var facebook_ids = _.pluck( LJ.search.fetched_users, 'facebook_id' );
				var filters      = LJ.search.filter_state;

				LJ.api.fetchMoreUsers( facebook_ids, filters )
					.then(function( exposed ){

						var new_users   = exposed.users;
						var users_count = exposed.users_count;

						LJ.search.fetched_users = _.uniq( LJ.search.fetched_users.concat( new_users ) );
						LJ.search.users_count   = users_count;
						resolve( new_users );

					})
					.catch( reject );

			});
		},
		refetchAndShowMoreUsers: function(){

			LJ.log('[Re]Fetching and showing more users...');
			LJ.search.all_fetched = false;

			if( LJ.search.fetching_users ){
				return LJ.wlog('Already fetching users...');
			}

			LJ.search.fetched_users = [];
			LJ.search.hideSearchUsers()
				.then(function(){
					return LJ.search.fetchAndShowMoreUsers();
				});

		},
		fetchAndShowMoreUsers: function(){

			LJ.log('Fetching and showing more users...');
			LJ.search.fetching_users = true;

			var users;
			LJ.search.showSearchLoader()

				.then(function(){
					return LJ.search.fetchMoreUsers();
				})

				.then(function( new_users ){
					if( LJ.search.fetched_users.length == LJ.search.users_count || new_users.length == 0 ){
						LJ.wlog('Everyone has been fetched for this filter.');
						LJ.search.all_fetched = true;
					}
					users = new_users;
					return;
				})

				.then(function(){
					return LJ.search.hideSearchLoader();
				})

				.then(function(){
					return LJ.search.showMoreUsers( users );
				})
				// When users loaded, give it one second of blocking, otherwise if user scrolls
				// It will detect that he can fetch more users. One batch at a time is better :)
				.then(function(){
					setTimeout(function(){
						LJ.search.fetching_users = false;
					}, 1000 );
				});

		},
		showMoreUsers: function( users ){

			_.chunk( users, 3 ).forEach(function( user_group, i ){

				var $users = $( LJ.search.renderUserRow( user_group ) );

				$users
					.css({ 'opacity': 0 })
					.insertBefore('.search__loader');

				LJ.settings.applyUxPreferences();

				$users.velocity('slideUpIn', {
					display  : 'flex',
					duration : 700,
					delay    : 100 + 250 * i
				});

			});

		},
		showSearchLoader: function( duration ){
			return LJ.promise(function( resolve, reject ){
				var $l = $('.search__loader');
				if( $l.length == 0 ) return resolve();
				$('.search__loader').velocity('shradeIn', {
					duration: duration || 300,
					complete: resolve
				})
			});
		},
		hideSearchLoader: function( duration ){
			return LJ.promise(function( resolve, reject ){
				$('.search__loader').velocity('shradeOut', {
					duration: duration || 300,
					complete: resolve
				})
			});
		},
		hideSearchUsers: function(){

			return LJ.promise(function( resolve, reject ){

				if( $('.search-users-row').length == 0 ){
					return resolve();
				}
				
				$('.search-users-row').velocity('shradeOut', {
					duration : 300,
					complete : function(){
						$(this).remove();
						resolve();
					}
				});
			});

		},
		renderUserRow: function( users ){

			if( !users ){
				return LJ.wlog('No users to render here');
			}

			var html = ['<div class="search-users-row">'];

			for( var i=0; i<3; i++ ){
				if( users[ i ] ){
					html.push( LJ.search.renderUser( users[i] ) );
				} else {
					html.push( LJ.search.renderUserBlank() );
				}
			}

			html.push('</div>');

			return html.join('');

		},
		renderUserBlank: function(){

			return '<div class="search-user --blank"></div>';

		},
		renderUser: function( user ){

			var n = user.name;
			var a = user.age;
			var i = user.facebook_id;
			var c = user.country_code;
			var l = user.location.place_name;
			var p = user.location.place_id;
			var g = user.gender;

			var main_pic = LJ.findMainPic( user );
			var img_html = LJ.pictures.makeImgHtml( main_pic.img_id, main_pic.img_version, 'user-search');


			return LJ.ui.render([

				'<div class="search-user" data-facebook-id="'+ i +'" data-age="' + a + '" data-gender="' + g + '" data-cc="' + c + '">',
		            '<span class="user-online js-user-online" data-facebook-id="'+ i +'"></span>',
		            '<div class="search-user__pic js-filterlay">',
		            	img_html,
		               '<div class="search-user__pic-overlay"></div>',
		            '</div>',
		           '<div class="search-user-body">',
		               '<div class="search-user__h1">',
		            	  '<span class="search-user__gender user-gender js-user-gender --'+ g +'"></span>',
		                  '<span class="name">'+ n +'</span>',
			              '<span class="search-user__country js-user-country"><i class="flag-icon flag-icon-'+ c +'"></i></span>',
		               '</div>',
		               '<div class="search-user__h2">',
		                  '<span class="age">'+ a +'</span>',
		                  '<span class="comma">-</span>',
			              '<span class="location" data-place-id="'+ p +'">'+ l +'</span>',
		               '</div>',
		           '</div>',
		            '<div class="search-user__actions">',
		              '<div class="search-user__action --round-icon --share js-share-profile"><i class="icon icon-forward"></i></div>',
		              '<div class="search-user__splitter"></div>',
		              '<div class="search-user__action --round-icon --meepass js-send-meepass"><i class="icon icon-meepass"></i></div>',
		            '</div>',
	          '</div>'

				].join(''))

		}

	});
	
	window.LJ.search = _.merge( window.LJ.search || {}, {

		$filters_agerange : null,
		filters_agerange  : null,

		filters_duration: 400,

		filter_state: {
			age       : [],
			gender    : [],
			countries : []
		},

		initFilters: function(){
			return LJ.promise(function( resolve, reject ){
				LJ.search.initFiltersSlider();
				resolve();
			});

		},
		initFiltersSlider: function(){
			
			LJ.search.$filters_agerange = document.getElementById('search-filters__input');
			
			LJ.search.filters_agerange = noUiSlider.create( LJ.search.$filters_agerange, {
				start: [ LJ.app_settings.app.min_age, LJ.app_settings.app.max_age ], // Handle start position
				step: 1, 					// Slider moves in increments of '10'
				margin: 3, 					// Handles must be more than '20' apart
				connect: true, 				// Display a colored bar between the handles
				orientation: 'horizontal',  // Orient the slider vertically
				behaviour: 'tap-drag',  	// Move handle on tap, bar is draggable
				range: { 					// Slider can select '0' to '100'
					'min': LJ.app_settings.app.min_age,
					'max': LJ.app_settings.app.max_age
				}
			});

			LJ.search.filters_agerange.on('update', LJ.search.refreshFiltersSliderValues );
			LJ.search.filters_agerange.on('end', LJ.search.refetchAndShowMoreUsers );

		},
		resetFiltersState: function(){

			LJ.search.filter_state = {
				age       : [],
				gender    : [],
				countries : []
			};

		},
		setFiltersState: function(){

			LJ.search.resetFiltersState();

			$('.search-filters')
				.find('.toggle.--active')
				.each(function( i, toggle ){

					if( $( toggle ).closest('.js-filters-male').length > 0 ){
						LJ.search.filter_state.gender.push('male');
					}

					if( $( toggle ).closest('.js-filters-female').length > 0 )
						LJ.search.filter_state.gender.push('female');

					if( $( toggle ).closest('.js-filters-country').length > 0 ){
						var cc = $(toggle).closest('[data-country-code]').attr('data-country-code');
						LJ.search.filter_state.countries.push( cc );
					}

				});

			var min = $('.search-filters-min-age').html();
			var max = $('.search-filters-max-age').html();

			LJ.search.filter_state.age[0] = min;
			LJ.search.filter_state.age[1] = max;

		},
		setCountriesInFilters: function(){

			LJ.api.fetchDistinctCountries()
				.then(function( country_codes ){
					return LJ.search.renderFilterCountries( _.shuffle( country_codes ) );
				})
				.then(function( countries_html ){
					return LJ.search.addFilterCountries( countries_html );
				})

		},
		renderFilterCountries: function( country_codes ){

			var html = [];
			country_codes.forEach(function( cc ){
				html.push( LJ.search.renderFilterCountry( cc ) );
			});

			return html.join('');

		},
		renderFilterCountry: function( cc ){

			return LJ.ui.render([
				'<div class="search-filters-countries js-filters-countries" data-country-code="'+ cc +'">',
					'<div class="search-filters-row js-filters-country">',
	            		'<div class="search-filters-country__flag --round-icon">',
	            			'<i class="flag-icon flag-icon-'+ cc +'"></i>',
	              		'</div>',
		            	'<div class="search-filters-country__label">',
		            		'<label data-lid="country_'+ cc +'"></label>',
		            	'</div>',
		            	'<div class="toggle">',
		                	'<div class="toggle__background"></div>',
		                	'<div class="toggle__button"></div>',
		              	'</div>',
	            	'</div>',
	            '</div>'
				].join(''));
		},
		addFilterCountries: function( countries_html ){

			$('.js-filters-countries').children().remove();
			$('.js-filters-countries').append( countries_html );

		},
		showFilters: function(){
			
			var $fi    = $('.search-filters__icon');
			var $f     = $('.search-filters');
			var d      = LJ.search.filters_duration;

			LJ.ui.adjustWrapperHeight( $('.search-filters') );

			$fi.velocity('shradeOut', {
				duration : d,
				display  : 'none'
			});

			LJ.ui.shradeIn( $f, d );

			// LJ.delay( d )
			// 	.then(function(){
			// 		return LJ.ui.shradeIn( $f, d );
			// 	});
			

		},
		hideFilters: function(){

			var $fi    = $('.search-filters__icon');
			var $f     = $('.search-filters');
			var d      = LJ.search.filters_duration;

			$f.velocity('shradeOut', {
				duration : d,
				display  : 'none'
			});

			LJ.ui.shradeIn( $fi, d );
			
			// LJ.delay( d )
			// 	.then(function(){
			// 		return LJ.ui.shradeIn( $fi, d );
			// 	});

		},
		refreshFiltersSliderValues: function( value ){

			$('.search-filters-min-age').html( parseInt(value[0]) );
			$('.search-filters-max-age').html( parseInt(value[1]) );

			LJ.search.setFiltersState();

		}

	});
	
	window.LJ.seek = _.merge( window.LJ.seek || {}, {

		init: function(){

			return LJ.seek.activatePlacesInProfile()

				.then(function(){
					return LJ.delay(100);

				})
				.then(function(){
					return LJ.seek.activatePlacesInMap()
					
				})
				.then(function(){
					return LJ.delay(100);

				})
				.then(function(){
					return LJ.seek.activatePlacesInCreateBefore();

				});


		},
		activatePlacesInProfile: function(){	

			var input = document.getElementById('me__location');
			var options = { types: ['(cities)'] };

			// To be able to isolate him from other place containers laters
			LJ.seek.profile_places = new google.maps.places.Autocomplete( input, options );
			return LJ.delay( 100 ).then(function(){
				$('.pac-container:not(.js-alreadyhere)').addClass('seek-profile-places').addClass('js-alreadyhere');
				return;
			});


		},
		activatePlacesInFirstLogin: function(){

			var input = document.getElementById('init-location__input');
			var options = { types: ['(cities)'] };

			// To be able to isolate him from other place containers laters
			LJ.seek.login_places = new google.maps.places.Autocomplete( input, options );
			return LJ.delay( 100 ).then(function(){
				$('.pac-container:not(.js-alreadyhere)').addClass('seek-login-places').addClass('js-alreadyhere');
				return;
			});

		},
		activatePlacesInMap: function(){

			var input = document.getElementById('map-browser-input');
			var options = { types: ['(cities)'] };

			// To be able to isolate him from other place containers laters
			LJ.seek.map_browser_places = new google.maps.places.Autocomplete( input, options );
			return LJ.delay( 100 ).then(function(){
				$('.pac-container:not(.js-alreadyhere)').addClass('seek-map-browser-places').addClass('js-alreadyhere');
				return;
			});


		},
		activatePlacesInCreateBefore: function(){

			var input = $('.be-create-row.--location input')[0];
			var options = {};


			// To be able to isolate him from other place containers laters
			LJ.seek.be_create = new google.maps.places.Autocomplete( input, options );
			return LJ.delay( 100 ).then(function(){
				$('.pac-container:not(.js-alreadyhere)').addClass('seek-be-create').addClass('js-alreadyhere');
				return;
			});

		}



	});

	window.LJ.settings = _.merge( window.LJ.settings || {}, {

		$settings: $('.menu-section.--settings'),

		allowed_ids: [ 

			// 'subscribed'
			'newsletter',

			// 'ux'
			'auto_login',
			'show_gender',
			'show_country',
			'message_seen',

			// 'alerts_email'
			"new_message",
			"marked_as_host",
			"new_cheers",
			"new_match"

		],

		init: function(){

			LJ.settings.activateSubmenuSection('account');
			LJ.settings.handleDomEvents();
			LJ.settings.setMyPreferences();
			LJ.settings.applyUxPreferences();
			LJ.settings.storeAutologinPreferences();
			
			return;

		},
		findObjectLeaves: function( o ){
			
			var self   = this;
			var leaves = [];
			var keys   = Object.keys( o );
		    
		    for( var i=0; i<keys.length; i++ ){
		    	
		        var key = keys[ i ];
		    	if( o.hasOwnProperty( key ) ){
		        	if( typeof o[ key ] != "object" ){
		            	var item = { "key": key, "value": o[ key ] };
		            	leaves.push( item );
		            } else {
		            	leaves = leaves.concat( self.findObjectLeaves.call( self, o[ key ] ) );
		            }
		        } 
		    }
		    
		    return leaves;
		    
		},
		setMyPreferences: function(){

			// Reset
			$('[data-settings-type-id]').find('.toggle').removeClass('--active');
			
			// Setting the toggles to active/inactive
			LJ.settings.findObjectLeaves( LJ.user.app_preferences ).forEach(function( leaf ){

				var $toggle = $('[data-settings-type-id="' + leaf.key + '"]').find('.toggle');
				var $input  = $('[data-settings-type-id="' + leaf.key + '"]').find('input');

				if( $toggle.length > 0 && leaf.value === true ){
                    	$toggle.addClass('--active');
                }

                // if someday some preferences are of type string...
                if( $input.length > 0 ){
                	$input.val( leaf.value );
                }

			});

			$('[data-settings-type-id="contact_email"]').find('input').val( LJ.user.contact_email );
			$('[data-settings-type-id="invite_code"]').find('input').val( LJ.user.invite_code );

		},	
		applyUxPreferences: function(){

			if( LJ.user.app_preferences.ux.show_country === true ){
				$('.js-user-country').show();
			} else {
				$('.js-user-country').hide();
			}

			if( LJ.user.app_preferences.ux.show_gender === true ){
				$('.js-user-gender').css({ display: 'inline-block' });
			} else {
				$('.js-user-gender').hide();
			}

		},
		handleDomEvents: function(){

			LJ.settings.$settings.on('click', '.toggle', 		   		  	 LJ.settings.updateSettingsToggle );
			LJ.settings.$settings.on('click', 'input, textarea, .edit',   	 LJ.settings.activateInput );
			LJ.settings.$settings.on('click', '.action__cancel',   		  	 LJ.settings.deactivateInput );
			LJ.settings.$settings.on('click', '.action__validate', 		     LJ.settings.updateSettingsInput );
			LJ.settings.$settings.on('click', '.settings__button.--sponsor', LJ.settings.showSponsorshipModal );
			LJ.settings.$settings.on('click', '.segment__part', 			 LJ.settings.showSubmenuItem );
			LJ.settings.$settings.on('click', '.settings__button.--delete',  LJ.settings.showDeleteAccountModal );
			LJ.ui.$body.on('click', '.modal.--delete button',				 LJ.settings.handleDeleteAccountAction );

		},
		showSubmenuItem: function(){

			var $self = $(this);

			var link_id = $self.attr('data-link');
			LJ.settings.activateSubmenuSection( link_id );

		},
		activateSubmenuSection: function( section_id ){	

			var current_section_id = $('.menu-section.--settings').find('.segment__part.--active').attr('data-link');

			var $submenu_item_activated    = $('.menu-section.--settings').find('.segment__part[data-link="' + current_section_id + '"]');
			var $submenu_item_to_activate  = $('.menu-section.--settings').find('.segment__part[data-link="' + section_id + '"]');

			var $submenu_block_activated   = $('.settings[data-link="' + current_section_id + '"]');
			var $submenu_block_to_activate = $('.settings[data-link="' + section_id + '"]');


			if( !current_section_id ){
				$submenu_item_to_activate.addClass('--active');
				return $('.menu-section.--settings').find('[data-link="' + section_id + '"]').css({ 'display': 'flex' });
			}


			if( section_id == current_section_id ){
				return LJ.wlog('Section is already activated');
			}


			$submenu_item_activated
				.removeClass('--active')
				.find('.menu-section-submenu__bar')
				.velocity('bounceOut', { duration: 450, display: 'none' });

			$submenu_item_to_activate
				.addClass('--active')
				.find('.menu-section-submenu__bar')
				.velocity('bounceInQuick', { duration: 450, display: 'block' });

			$submenu_block_activated.hide();
			$submenu_block_to_activate.css({ display: 'flex' });

		},
		updateSettingsInput: function( element ){

			LJ.log('Updating settings input...');

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.settings-item');
			var $input = $block.find('input, textarea');

			if( $block.length == 0 || !$block.hasClass('--active') || $block.hasClass('--validating') ){
				return LJ.wlog('Not calling the api');
			}

			if( $input.val() == $block.attr('data-restore') ){
				LJ.settings.deactivateInput.call( this, element );
				return LJ.wlog('Not calling the api (same value)');
			}

			var type_id = $block.attr('data-settings-type-id');

			if( type_id == "invite_code" ){
				return LJ.settings.updateInviteCode();
			}

			if( type_id = "contact_email" ){
				return LJ.settings.updateContactEmail()
			}

		},
		updateInviteCode: function(){

			LJ.log('Updating invite code');

			var $input = $('#settings__invite-code');
			var $block = $input.closest('.settings-item');

			var new_invite_code = $input.val();

			var call_id = LJ.generateId();
			LJ.ui.showLoader( call_id );

			$block.attr('data-callid', call_id ).addClass('--validating');

			var update = {
				call_id     : call_id,
				invite_code : new_invite_code
			};

			LJ.api.updateInviteCode( update )
				.then( LJ.settings.handleUpdateSettingsSuccess, LJ.settings.handleApiError );

		},
		updateContactEmail: function(){

			LJ.log('Updating contact email');

			var $input = $('#settings__contact-email');
			var $block = $input.closest('.settings-item');

			if( $block.hasClass('--validating') ) return;

			var new_contact_email = $input.val();

			var call_id = LJ.generateId();
			LJ.ui.showLoader( call_id );

			$block.attr('data-callid', call_id ).addClass('--validating');

			var update = {
				call_id       : call_id,
				contact_email : new_contact_email
			};

			LJ.api.updateUser( update )
				.then( LJ.settings.handleUpdateSettingsSuccess, LJ.settings.handleApiError );

		},
		updateKey: function( o, target_key, value ){
			
		    var self = this;
		    var keys = Object.keys( o );
		    
		    for( var i=0; i<keys.length; i++ ){
		  
		        var key = keys[ i ];
		    	if( key === target_key && typeof o[ key ] == typeof value ){
		        	return o[ key ] = value;
		        }
		        
		        if( typeof o[ key ] == "object" ){
		        	self.updateKey.apply( self, [ o[ key ], target_key, value ]);
		        }

		    }
		    		    
		},
		updateSettingsToggle: function(){
			
			var $toggle     = $( this );
			var settings_id = $toggle.closest('.settings-item').attr('data-settings-type-id');

			var allowed_ids = LJ.settings.allowed_ids; 
			if( allowed_ids.indexOf( settings_id ) == -1 ){
				return LJ.wlog('This settings id : ' + settings_id + ' is not into the allowed list : ' + allowed_ids );
			}

			var settings_value = $toggle.hasClass('--active') ? false : true;
			LJ.settings.updateKey( LJ.user.app_preferences, settings_id, settings_value );
						
			// Update the ui
			var call_id = LJ.generateId();
			LJ.ui.showLoader( call_id );
			$toggle.toggleClass('--active');
	
			
			var update = {
				call_id         : call_id,
				app_preferences : LJ.user.app_preferences
			};
						
			LJ.api.updateUser( update )
				.then(function( res ){
					LJ.settings.handleUpdateSettingsSuccess( res );
				})
				.catch(function( err ){
					LJ.settings.handleApiError( err );
				});

		},
		handleApiError: function( err ){

			var err_ns  = err.namespace;
			var err_id  = err.errors[0].err_id || (err.errors[0].data && err.errors[0].data.err_id );
			var call_id = err.call_id;

			if( err.namespace == 'update_settings' ){

				LJ.ui.showToast('La mise  jour na pas t effectue', 'error');
				LJ.ui.hideLoader( call_id );
				$('.toggle[data-callid="' + call_id + '"]').toggleClass('--active');
				return;

			}

			if( err_id == 'already_taken' ){
				LJ.ui.showToast( LJ.text('to_invite_code_already_taken'), 'error' );
				LJ.ui.hideLoader( call_id );
				$('.settings-item[data-callid="' + call_id + '"]').removeClass('--validating');
				return;
			}

			 if( err_id == 'bad_pattern' ){
				LJ.ui.showToast( LJ.text('to_invite_code_bad_pattern'), 'error' );
				LJ.ui.hideLoader( call_id );
				$('.settings-item[data-callid="' + call_id + '"]').removeClass('--validating');
				return;
			}

			LJ.wlog('Unable to figure out what to do with this error (out of scope)');

		},
		handleUpdateSettingsSuccess: function( expose ){

			LJ.log('Update settings success');
			
			var call_id = expose.call_id;

			LJ.ui.hideLoader( call_id );
			LJ.ui.showToast( LJ.text('to_settings_update_success') );
			LJ.settings.storeAutologinPreferences();
			LJ.settings.applyUxPreferences();

			// Check if this was a textfield input;
			var $markedItem = $('.settings-item[data-callid="' + call_id + '"]');
			if( $markedItem.length == 1 ){
				$markedItem.attr('data-callid', null ).attr('data-restore', null );
				LJ.settings.deactivateInput( $markedItem );
			}

		},		
		showSponsorshipModal: function(){

			LJ.ui.showModal({
				"type"     : "sponsorship",
				"title"    : LJ.text("settings_modal_sponsor_title"),
				"subtitle" : LJ.text("settings_modal_sponsor_subtitle"),
				"body"     : LJ.settings.renderSponshipModalBody(),
				"footer"   : "<button>" + LJ.text("settings_modal_sponsor_button") + "</button>",
			});

		},
		showDeleteAccountModal: function(){

			var footer = [
				'<button data-action="confirm">' + LJ.text("settings_modal_delete_button_confirm") + '</button>',
				'<button data-action="cancel">' + LJ.text("settings_modal_delete_button_cancel") + '</button>'
			].join('');

			LJ.ui.showModal({
				"type"  : "delete",
				"title"    : LJ.text("settings_modal_delete_title"),
				"subtitle" : LJ.text("settings_modal_delete_subtitle"),
				"footer"   : footer
			});

		},
		renderSponshipModalBody: function(){
			return [
				'<div class="modal__input">',
					'<input type="text" placeholder="BL1347">',
				'</div>'
			].join('');
		},
		activateInput: function( element ){

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.settings-item');
			var $input = $block.find('input, textarea');

			if( $block.hasClass('--active') || $block.hasClass('--no-edit') ){
				return;
			} else {
				$block.addClass('--active'); 
			}

			$input.attr( 'readonly', false );

			$block.find('.action')
				  .velocity('bounceInQuick', {
				  	duration: LJ.ui.action_show_duration,
				  	display: 'flex'
				  });

			$block.find('.edit')
				  .velocity('bounceOut', {
				  	duration: 10, // LJ.ui.action_hide_duration,
				  	display: 'none'
				  });

			$block.attr('data-restore', $input.val() );

		},
		deactivateInput: function( element ){

			var $self;
			if( element instanceof jQuery ){
				$self = element;
			} else if( typeof element == 'string' ){
				$self = $( element );
			} else {
				$self = $( this );
			}

			var $block = $self.closest('.settings-item');
			var $input = $block.find('input, textarea');

			if( $block.hasClass('--active') ){
				$block.removeClass('--active')
					  .removeClass('--validating');
			} else {
				return;
			}

			$input.attr( 'readonly', true );

			$block.find('.action')
				  .velocity('bounceOut', {
				  	duration: LJ.ui.action_hide_duration,
				  	display: 'none'
				  });

			$block.find('.edit')
				  .velocity('bounceInQuick', {
				  	duration: LJ.ui.action_show_duration,
				  	delay: LJ.ui.action_show_duration,
				  	display: 'flex'
				  });

			var former_value = $block.attr('data-restore');
			if( former_value != null ){
				$input.val( former_value );
				$block.attr( 'data-restore', null );
			}

		},
		storeAutologinPreferences: function(){

			LJ.store.set( "autologin", LJ.user.app_preferences.ux.auto_login );

		},
		handleDeleteAccountAction: function(){

			var $btn = $( this );
			var action = $btn.attr('data-action');

			if( action == "cancel" ){
				return LJ.ui.hideModal();
			}

			if( $btn.hasClass('--pending') ){
				return LJ.log('Already hiding...');
			}
			
			LJ.log('Deleting user account...');
			$btn.addClass('--pending');
			LJ.api.deleteMyAccount()
				.then( LJ.ui.shadeModal )
				.then(function(){
						
					// Clear the local storage
					LJ.store.remove("autologin");
					LJ.store.remove("facebook_access_token");
					LJ.store.remove("seen_chats");

					location.reload();

				})
				.catch(function(){
					$btn.removeClass('--pending');
					LJ.ui.hideModal()
						.then(function(){
							LJ.ui.showToast("Une erreur s'est produite, nous avons t notifi", "error" );
							window.localStorage.removeItem('preferences');
						});
				});
		}

	});




	window.LJ.shared = _.merge( window.LJ.shared || {}, {

		shared_item_duration: 600,

		init: function(){

			LJ.shared.handleDomEvents();
			return;

		},
		handleDomEvents: function(){

			$('.menu-item.--shared').one('click', LJ.shared.handleShareClicked );
			LJ.ui.$body.on('click', '.js-share-profile', LJ.shared.handleShareProfile );
			LJ.ui.$body.on('keydown', '.modal-search__input input', LJ.ui.filterModalResults );
			LJ.ui.$body.on('click', '.shared__item', LJ.shared.handleSharedItemClicked )

		},
		handleSharedItemClicked: function(){

			var target_id   = $(this).attr('data-target-id');
			var target_type = $(this).attr('data-target-type');

			if( target_type == "user" ){
				return LJ.profile_user.showUserProfile( target_id );
			}

			if( target_type == "before" ){
				return LJ.before.fetchAndShowBeforeInview( target_id );
			}

		},	
		handleShareClicked: function(){

			var $loader = $( LJ.static.renderStaticImage('menu_loader') );

			$('.shared').html('');

			$loader.addClass('none')
				   .appendTo('.shared')
				   .velocity('bounceInQuick', {
				   	delay    : 125,
				   	duration : 500,
				   	display  : 'block'
				  });

			LJ.shared.fetchSharedItems();

		},	
		fetchSharedItems: function(){

			/*
				- Fetch user's share_objects, and format it
				- Fetch the befores and users data to render. Hopefully, from cache.
				- Determine which template to render (many cases)
				- Display to the screen
			*/
			var shared, facebook_ids, users, befores;

			// Fetch user's share_objects, and format it
			LJ.api.fetchMeShared()
				.then(function( expose ){
					shared = expose.shared.sort(function( s1, s2 ){
						return moment( s2.shared_at ) - moment( s1.shared_at );
					});

				})
				// Fetch the befores and users data to render
				.then(function(){
					var event_ids = _.map( _.filter( shared, function( sh ){
						return sh.target_type == "before";
					}), 'target_id' );
					return LJ.api.fetchBefores( event_ids )

				})
				.then(function( res ){
					befores = _.map( res, 'before' );

				})
				.then(function(){

					var hosts_facebook_ids = _.flatten( _.map( befores, 'hosts' ) );
					var users_facebook_ids = _.map( _.filter( shared, function( sh ){
						return sh.target_type == "user";
					}), 'target_id' );

					facebook_ids = _.uniq( hosts_facebook_ids.concat(users_facebook_ids) );
					return;

				})
				.then(function(){
					return LJ.api.fetchUsers( facebook_ids );

				})	
				.then(function( res ){
					users = _.map( res, 'user' );
					return;

				})
				// Determine which template to render (many cases)
				.then(function(){
					return LJ.shared.renderSharedItems( shared, users, befores );

				})
				// Display to the screen
				.then(function( html ){
					return LJ.shared.displaySharedItems( html );

				})
				.catch(function( e ){
					LJ.wlog(e);

				});

		},
		renderSharedItems: function( shared, users, befores ){

			var html = [];
			shared.forEach(function( sho ){

				html.push( LJ.shared.renderSharedItem( sho, {
						users   : users,
						befores : befores
					})
				);

			});

			if( html.length == 0 ){
				return [ LJ.shared.renderSharedItem__Empty() ];

			} else {
				return html;

			}

		},
		renderSharedItem: function( sho, opts ){

			var users   = opts.users;
			var befores = opts.befores;

			if( sho.target_type == "user" ){

				var target_profile = _.find( users, function( usr ){
					return usr && usr.facebook_id == sho.target_id;
				});

				if( !target_profile ){
					LJ.wlog('Couldnt find the user profile');
					return ''
				}

				if( sho.share_type == "shared_by" ){
					return LJ.shared.renderSharedByItem__User( sho, target_profile );
				}

				if( sho.share_type == "shared_with" ){
					return LJ.shared.renderSharedWithItem__User( sho, target_profile );
				}		

			}

			if( sho.target_type == "before" ){


				var before = _.find( befores, function( bfr ){
					return bfr && bfr._id == sho.target_id;
				});

				if( !before ){
					LJ.wlog('Couldnt find the before');
					return '';
				}

				var targets_profiles = [];
				users.forEach(function( user ){
					if(  before.hosts.indexOf( user.facebook_id ) != -1 ){
						targets_profiles.push( user );
					}
				});

				if( sho.share_type == "shared_by" ){
					return LJ.shared.renderSharedByItem__Before( sho, targets_profiles );
				}	

				if( sho.share_type == "shared_with" ){
					return LJ.shared.renderSharedWithItem__Before( sho, targets_profiles );
				}							
			}

		},
		displaySharedItems: function( html ){

			$('.shared')
				.children()
				.velocity('shradeOut', {
					duration : LJ.shared.shared_item_duration,
					display  : 'none',
					complete : function(){
						$( html.join('') )
							.hide()
							.appendTo('.shared')
							.velocity('shradeIn', {
								duration : LJ.shared.shared_item_duration,
								display  : 'flex',
								stagger  : (LJ.shared.shared_item_duration / 4)
							});

					}
				});


		},	
		renderSharedItem__Empty: function(){

			return LJ.ui.render([

				'<div class="empty">',
					'<div class="empty__icon --round-icon">',
						'<i class="icon icon-telescope"></i>',
					'</div>',
					'<div class="empty__title">',
						'<h2 data-lid="empty_shared_title"></h2>',
					'</div>',
					'<div class="empty__subtitle">',
						'<p data-lid="empty_shared_subtitle"></p>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderSharedItem__User: function( sh, target, subtitle ){

			var target 		   = target;
			var formatted_date = LJ.renderDate( sh.shared_at );
			var img_html       = LJ.pictures.makeImgHtml( target.img_id, target.img_vs, 'menu-row' );

			return LJ.ui.render([

				'<div class="shared__item" data-target-id="' + sh.target_id + '" data-target-type="' + sh.target_type + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + img_html + '</div>',
						'<div class="row-pic__icon --round-icon"><i class="icon icon-forward"></i></div>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2>' + target.name + ', <span class="row-body__age">' + target.age + '</span></h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							subtitle,
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderSharedItem__Before: function( sh, targets_profiles, subtitle ){

			var target 		   = target;
			var formatted_date = LJ.renderDate( sh.shared_at );

			var pictures = [];
			targets_profiles.forEach(function( tar ){
				pictures.push({ img_id: tar.img_id, img_vs: tar.img_vs });
			});
			var rosace_html    = LJ.pictures.makeRosaceHtml( pictures, 'menu-row' );

			return LJ.ui.render([

				'<div class="shared__item" data-target-id="' + sh.target_id + '" data-target-type="' + sh.target_type + '">',
					'<div class="row-date date">' + formatted_date + '</div>',
					'<div class="row-pic">',
						'<div class="row-pic__image">' + rosace_html + '</div>',
						'<div class="row-pic__icon --round-icon"><i class="icon icon-forward"></i></div>',
					'</div>',
					'<div class="row-body">',
						'<div class="row-body__title">',
							'<h2 data-lid="shared_before_title" data-lpmt="array" data-lpm="'+ _.map( targets_profiles, 'name' ) +'"></h2>',
						'</div>',
						'<div class="row-body__subtitle">',
							subtitle,
						'</div>',
					'</div>',
				'</div>'

				].join(''));

		},
		renderSharedByItem__User: function( sho, target ){

			var friend = LJ.friends.getFriendProfile( sho.shared_by );

			var subtitle = [
				'<div class="row-body__icon --round-icon">',
					'<i class="icon icon-pricetag"></i>',
				'</div>',
				'<h4>',
					LJ.text('shared_by_item_subtitle')
						.replace('%name', friend.name )
						.replace('%type', LJ.text('w_profile') )
						.capitalize(),
				'</h4>'
			].join('');

			return LJ.shared.renderSharedItem__User( sho, target, subtitle );

		},
		renderSharedWithItem__User: function( sho, target ){

			var friends = [];

			sho.shared_with.forEach(function( friend_id ){
				friends.push( LJ.friends.getFriendProfile( friend_id ) );
			});

			var names = LJ.renderMultipleNames( _.map( friends, 'name') );

			var subtitle = [
				'<div class="row-body__icon --round-icon">',
					'<i class="icon icon-forward"></i>',
				'</div>',
				'<h4>',
					LJ.text('shared_with_item_subtitle')
						.replace('%names', names )
						.replace('%type', LJ.text('w_profile') )
						.capitalize(),
				'</h4>'
			].join('');

			return LJ.shared.renderSharedItem__User( sho, target, subtitle );


		},
		renderSharedByItem__Before: function( sho, target ){

			var friend = LJ.friends.getFriendProfile( sho.shared_by );

			var subtitle = [
				'<div class="row-body__icon --round-icon">',
					'<i class="icon icon-pricetag"></i>',
				'</div>',
				'<h4>',
					LJ.text('shared_by_item_subtitle')
						.replace('%name', friend.name )
						.replace('%type', LJ.text('w_profile') )
						.capitalize(),
				'</h4>'
			].join('');

			return LJ.shared.renderSharedItem__Before( sho, target, subtitle );

		},
		renderSharedWithItem__Before: function( sho, target ){

			var friends = [];

			sho.shared_with.forEach(function( friend_id ){
				friends.push( LJ.friends.getFriendProfile( friend_id ) );
			});

			var names = LJ.renderMultipleNames( _.map( friends, 'name') );

			var subtitle = [
				'<div class="row-body__icon --round-icon">',
					'<i class="icon icon-forward"></i>',
				'</div>',
				'<h4>',
					LJ.text('shared_with_item_subtitle')
						.replace('%names', names )
						.replace('%type', LJ.text('w_profile') )
						.capitalize(),
				'</h4>'
			].join('');

			return LJ.shared.renderSharedItem__Before( sho, target, subtitle );


		},
		handleShareProfile: function(){	

			var target_id = $( this ).closest('[data-facebook-id]').attr('data-facebook-id');

			LJ.ui.showModal({
				"title"			: LJ.text('modal_share_title_profile'),
				"type"      	: "share",
				"search_input"	: true,
				"jsp_body" 	    : true,
				"attributes"	: [{ name: "item-id", val: target_id }],
				"subtitle"		: LJ.text('modal_share_subtitle_profile'),
				"body"  		: LJ.friends.renderFriendsInModal(),
				"footer"		: "<button class='--rounded'><i class='icon icon-forward'></i></button>"
			})
			.then(function(){
				return LJ.ui.getModalItemIds();

			})
			.then(function( item_ids ){

				var d = LJ.static.renderStaticImage('search_loader')
				$(d).addClass('modal__search-loader').hide().appendTo('.modal').velocity('fadeIn', {
					duration: 400
				});

				return LJ.api.shareWithFriends({
					target_id   : target_id,
					target_type : 'user',
					shared_with : item_ids
				});

			})
			.then(function( exposed ){
				return LJ.ui.hideModal()

			})
			.then(function(){
				LJ.ui.showToast( LJ.text('to_profile_shared_success') );
			})
			.catch(function(e){
				LJ.wlog(e);
				LJ.ui.hideModal()

			});

		}

	});

	
	window.LJ.static = _.merge( window.LJ.static || {}, {

		'images': [
			{
				'access_name' : 'main_loader',
				'image_id' 	  : 'app_loader',
				'param'		  : { 'class': 'app__loader', 'width': 80 }
			},
			{
				'access_name' : 'modal_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'       : { 'class': 'modal__loader', 'width': 32  }
			},
			{
				'access_name' : 'menu_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'       : { 'class': 'menu__loader', 'width': 32  }
			},
			{
				'access_name' : 'slide_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'       : { 'class': 'slide__loader', 'width': 32  }	
			},
			{
				'access_name' : 'search_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'       : { 'class': 'search__loader', 'width': 32  }	
			},
			{
				'access_name' : 'be_create_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'       : { 'class': 'be-create__loader', 'width': 32  }
			},
			{
				'access_name' : 'chat_loader',
				'image_id'    : 'loader_circular_blue_thin',
				'param'   	  : { 'class': 'chat__loader', 'width': 28  }
			},
			{ "access_name" : ":D", "image_id": "emoticon_smile" },
			{ "access_name" : "xD", "image_id": "emoticon_smilexd" },
			{ "access_name" : ";)", "image_id": "emoticon_blink" },
			{ "access_name" : ":p", "image_id": "emoticon_tongue" },
			{ "access_name" : "<3", "image_id": "emoticon_love" },
			{ "access_name" : ":%", "image_id": "emoticon_sun" },
			{ "access_name" : "-)", "image_id": "emoticon_bg" },
			{ "access_name" : ":o", "image_id": "emoticon_oh" },
			{ "access_name" : ":(", "image_id": "emoticon_sad" },
			{ "access_name" : ":", "image_id": "emoticon_angel" },
			{ "access_name" : ":z", "image_id": "emoticon_zzz" },
			{ "access_name" : ":/", "image_id": "emoticon_noop" }
		],
		// Constructs a list of static pictures hosted on Cloudinary that are available
		// to use accross all others modules
		init: function(){

			LJ.static.cacheStaticImages();
			return;

		},
		cacheStaticImages: function(){

			LJ.static.images.forEach(function( img ){

				img.param = img.param || {};
				img.param['cloud_name'] = 'radioreve';

				LJ.static[ '$' + img.access_name ] = $.cloudinary.image(
					img.image_id,
					img.param
				);


			});

		},
		getLoader: function( loader_id ){
			var $l = $('.app__loader[data-loaderid="' + loader_id + '"]');

			if( $l.length != 1 ){
				return LJ.wlog('Unable to uniquely identify the loader with id : ' + loader_id +', length is : ' + $l.length );
			} else {
				return $l;
			}
		},
		renderStaticImage: function( access_name ){

			return LJ.static[ '$' + access_name ].clone().prop('outerHTML');

		}

	});

	window.LJ.store = _.merge( window.LJ.store || {}, {

		mode: null,

		init: function(){

			LJ.store.activateStoreMode();
			return;
		},
		activateStoreMode: function(){

			if( window.localStorage ){
				LJ.store.mode = "localstorage";
			} else {
				LJ.store.mode = "cookie";
			}

		},
		changeStoreMode: function( new_mode ){

			if( [ "cookie", "localstorage" ].indexOf( new_mode ) == -1 ){
				return LJ.wlog('This storage mode is not supported, please use "cookie" or "localstorage"');
			}

			LJ.store.mode = new_mode;

		},
		getStore: function(){

			if( LJ.store.mode == "localstorage" ){
				return window.localStorage;
			} else {
				return document.cookie;
			}

		},
		get: function( name ){

			var mode = LJ.store.mode;

			if( mode == "localstorage" ){
				return LJ.store.getLocalItem( name );
			}

			if( mode == "cookie" ){
				return LJ.store.getCookie( name );
			}

		},
		set: function( key, item ){

			var mode = LJ.store.mode;

			if( mode == "localstorage" ){
				return LJ.store.setLocalItem( key, item );
			}

			if( mode == "cookie" ){
				return LJ.store.setCookie( key, item );
			}

		},
		remove: function( key ){

			var mode = LJ.store.mode;

			if( mode == "localstorage" ){
				return LJ.store.removeLocalItem( key );
			}

			if( mode == "cookie" ){
				return LJ.store.removeCookie( key );
			}

		},
		setLocalItem: function( key, item ){

			if( typeof item == "object" ){
				item = JSON.stringify( item );
			}

			window.localStorage.setItem( key, item );

		},
		getLocalItem: function( key ){

			var item = window.localStorage.getItem( key );

			try {
				item = JSON.parse( item );

			} catch( e ){
				// Do nothing
			}

			return item;

		},
		removeLocalItem: function( key ){

			window.localStorage.removeItem( key );

		},
		setCookie: function( cname, cvalue, exdays ){

		    var d = new Date();
		    d.setTime( d.getTime() + ( exdays * 24 * 60 * 60 * 1000 ) );

		    var expires = "expires="+ d.toUTCString();

		    document.cookie = cname + "=" + cvalue + "; " + expires;

		},
		getCookie: function( cname ){

		    var name = cname + "=";
		    var ca = document.cookie.split(';');

		    for( var i = 0; i <ca.length; i++ ){

		        var c = ca[i];
		        while( c.charAt(0)==' ' ){
		            c = c.substring(1);
		        }

		        if( c.indexOf( name ) == 0 ){
		            return c.substring(name.length,c.length);
		        }
		    }

		    return null;
		},
		removeCookie: function( cname ){

			LJ.store.setCookie( cname, '', -1 );

		}

	});
	

	window.LJ = _.merge( window.LJ || {} , {

		typeahead_legacy: {
			users: {
				class_names: {
					input      :'',
					hint       :'',
					menu       :'search-results-users',
					dataset    :'search-wrap',
					suggestion :'search-result-default search-result-users',
					empty      :'empty',
					open       :'open',
					cursor     :'cursor',
					highlight  :'highlight'
				}
			},
			// places: {
			// 	class_names: {
			// 		input:'',
			// 		hint:'hint-places',
			// 		menu:'search-results-autocomplete search-results-party-places',
			// 		dataset:'search-wrap',
			// 		suggestion:'search-result-default search-result-party-places',
			// 		empty:'empty',
			// 		open:'open',
			// 		cursor:'cursor',
			// 		highlight:'highlight'
			// 	}
			// },
			friends: {
				class_names: {
					input      :'',
					hint       :'hint-places',
					menu       :'search-results-autocomplete search-results-friends',
					dataset    :'search-wrap',
					suggestion :'search-result-default search-result-friend',
					empty      :'empty',
					open       :'open',
					cursor     :'cursor',
					highlight  :'highlight'
				}
			},
			groups: {
				class_names: {
					input      :'',
					hint       :'hint-places',
					menu       :'search-results-autocomplete search-results-friends search-results-groups',
					dataset    :'search-wrap',
					suggestion :'search-result-default search-result-friend',
					empty      :'empty',
					open       :'open',
					cursor     :'cursor',
					highlight  :'highlight'
				}
			}
		}

	});


	window.LJ.fn = _.merge( window.LJ.fn || {} , 

	{
		initTypeaheadUsers: function(){

			var users = new Bloodhound({
				 datumTokenizer: Bloodhound.tokenizers.whitespace,
  				 queryTokenizer: Bloodhound.tokenizers.whitespace,
  				 identify: function(o){ return o.name; },
  				 remote: {
  				 	url: '/api/v1/users?token=' + LJ.fn.getToken() + '&name=%query',
  				 	wildcard: '%query'
  				 },
  				 transform: function(res){
  				 	LJ.fn.log(res);
  				 }
			});

			users.initialize()
				 .done(function(){ })
				 .fail(function(){ LJ.fn.log('Bloodhound engine failed to initialized users'); })

			$('#search input').typeahead({
				hint: true,
				highlight: true,
				minLength: 1, // switch to 2 or 3 to reduce the amount of requests
				classNames: LJ.typeahead.users.class_names
			},
			{
				name:'users',
				display:'name',
				source: users.ttAdapter(),
				templates: {
					notFound   : LJ.fn.renderTypeaheadNotFound_Dark,
					pending    : LJ.fn.renderTypeaheadPending,
					suggestion : LJ.fn.renderTypeaheadSuggestion_Users
				}
			})
			.on('typeahead:select', function( ev, suggestion ){

				LJ.fn.displayUserProfile( suggestion.facebook_id );
				$(this).typeahead('val', '');

			});

		},
		initTypeaheadHosts: function( friends ){

			var friends = new Bloodhound({
				 datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
  				 queryTokenizer: Bloodhound.tokenizers.whitespace,
  				 identify: function(o){ return o.name; },
  				 local: friends,
  				 transform: function(res){
  				 	LJ.fn.log(res);
  				 }
			});

			friends.initialize()
				 .done(function(){ })
				 .fail(function(){ LJ.fn.log('Bloodhound engine failed to initialized friends'); })

			var names = _.pluck( LJ.user.friends, 'name' );
			var results = _.shuffle( names ).slice( 0, _.max([ names.length, 3]) );

			function friendsWithDefaults( q, sync ){
				if( q == '' ){
					sync( friends.get( results ) );
				} else {
					friends.search( q, sync );
				}
			}

			$('.row-create-friends input').typeahead({
				hint: true,
				highlight: true,
				minLength: 0,
				classNames: LJ.typeahead.friends.class_names
			},
			{
				name:'friends',
				display:'name',
				source: friendsWithDefaults,
				templates: {
					notFound   : LJ.fn.renderTypeaheadNotFound,
					pending    : LJ.fn.renderTypeaheadPending,
					suggestion : LJ.fn.renderTypeaheadSuggestion_Users
				}
			});

		},
		initTypeaheadGroups: function( friends ){

			var friends = new Bloodhound({
				 datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
  				 queryTokenizer: Bloodhound.tokenizers.whitespace,
  				 identify: function(o){ return o.name; },
  				 local: friends,
  				 transform: function(res){
  				 	LJ.fn.log(res);
  				 }
			});

			friends.initialize()
				 .done(function(){ })
				 .fail(function(){ LJ.fn.log('Bloodhound engine failed to initialized friends groups'); })

			var names = _.pluck( LJ.user.friends, 'name' );
			var results = _.shuffle( names ).slice( 0, _.max([ names.length, 3]) );

			function friendsWithDefaults( q, sync ){
				if( q == '' ){
					sync( friends.get( results ) );
				} else {
					friends.search( q, sync );
				}
			}

			$('.row-requestin-group-members input').typeahead({
				hint: true,
				highlight: true,
				minLength: 0,
				classNames: LJ.typeahead.groups.class_names
			},
			{
				name:'friends',
				display:'name',
				source: friendsWithDefaults,
				templates: {
					notFound   : LJ.fn.renderTypeaheadNotFound,
					pending    : LJ.fn.renderTypeaheadPending,
					suggestion : LJ.fn.renderTypeaheadSuggestion_Users
				}
			});

		},
		initTypeaheadPlaces: function(){

			var places = new Bloodhound({
				 datumTokenizer: Bloodhound.tokenizers.whitespace,
  				 queryTokenizer: Bloodhound.tokenizers.whitespace,
  				 identify: function(o){ return o.name; },
  				 remote: {
  				 	url: '/api/v1/places?token=' + LJ.fn.getToken() + '&name=%query',
  				 	wildcard: '%query'
  				 },
  				 transform: function(res){
  				 	LJ.fn.log(res);
  				 }
			});

			places.initialize()
				 .done(function(){ })
				 .fail(function(){ LJ.fn.log('Bloodhound engine failed to initialized places'); })

			$('.row-create-party-place input').typeahead({
				hint: true,
				highlight: true,
				minLength: 1,
				classNames: LJ.typeahead.places.class_names
			},
			{
				name:'places',
				display:'name',
				source: places.ttAdapter(),
				templates: {
					notFound   : LJ.fn.renderTypeaheadNotFound,
					pending    : LJ.fn.renderTypeaheadPending,
					suggestion : LJ.fn.renderTypeaheadSuggestion_Places
				}
			});

		}
		
	});

window.LJ.ui = _.merge( window.LJ.ui || {}, {

	$window	    : $(window),
	$body 		: $('body'),

	jsp: {},

	show_curtain_duration	: 2000,
	hide_curtain_duration	: 2000,
	minimum_api_delay		: 750,

	action_show_duration: 400,
	action_hide_duration: 400,

	shrade_duration: 300,

	minimum_reconnection_delay: 3500,
	reconnection_curtain_alpha: 0.88,
	changelang_curtain_alpha: 0.92,

	scrolltop: 0,

	//Down
	slideDownInLight:  { opacity: [1, 0], translateY: [0, 10]   },
    slideDownOutLight:  { opacity: [0, 1], translateY: [10, 0]   },
    slideDownInVeryLight:  { opacity: [1, 0], translateY: [0, 7]   },
    slideDownOutVeryLight:  { opacity: [0, 1], translateY: [7, 0]   },
    //Up
    slideUpInLight: { opacity: [1, 0], translateY: [0, -10]   },
	slideUpOutLight: { opacity: [0, 1], translateY: [-10, 0]   },
    slideUpInVeryLight: { opacity: [1, 0], translateY: [0, -7]   },
	slideUpOutVeryLight: { opacity: [0, 1], translateY: [-7, 0]   },
    //Left
	slideLeftInLight:  { opacity: [1, 0], translateX: [0, -10]   },
	slideLeftOutLight:  { opacity: [0, 1], translateX: [-10, 0]   },
    slideLeftInVeryLight:  { opacity: [1, 0], translateX: [0, -7]   },
    slideLeftOutVeryLight:  { opacity: [0, 1], translateX: [-7, 0]   },
    //Right
    slideRightInLight: { opacity: [1, 0], translateX: [0, 10]   },
	slideRightOutLight: { opacity: [0, 1], translateX: [10, 0]   },
    slideRightInVeryLight: { opacity: [1, 0], translateX: [0, 7]   },
    slideRightOutVeryLight: { opacity: [0, 1], translateX: [7, 0]   },
	
	init: function(){

		LJ.ui.$window.scroll( LJ.ui.setScrollDirection );
		LJ.ui.$body.on('keydown', '.modal-search__input input', LJ.ui.filterModalResults );

	},
	getScrollDirection: function(){
		return LJ.ui.scroll_direction;
	},
	setScrollDirection: function(){

		var current_scrolltop = LJ.ui.$window.scrollTop();

		if( LJ.ui.scrolltop > current_scrolltop ){
			LJ.ui.scroll_direction = "up";
		} else {
			LJ.ui.scroll_direction = "down";
		}

		LJ.ui.scrolltop = LJ.ui.$window.scrollTop();


	},
	updatePageTitle: function( title ){

		document.title = title;
		
	},
	getScrollRatio: function(){

		var s = $(window).scrollTop(),
		    d = $(document).height(),
		    c = $(window).height();

		return scrollPercent = (s / (d-c));

	},
	showCurtain: function( o ){

		o = o || {};

		var already_there = false;
		var $curtain;

		if( $('.curtain').length > 0 ) {
			$curtain = $('.curtain');
			already_there = true;

		} else {
			var alpha = o.opacity || 1;
			var color = o.theme == "light" ? 'rgba(255,255,255,' : 'rgba(19,19,19,';


			$curtain = $('<div class="curtain"></div>');
			$curtain.hide().css({ 'background': color + alpha + ')' }).appendTo( LJ.ui.$body );

		}

		if( o.sticky || o.stick ){
			$curtain.addClass('curtain--sticky');
		}

		return LJ.promise(function( resolve, reject ){

			if( already_there ){
				return resolve();
			}

			$('.curtain').velocity('fadeIn', {
				display  : 'flex',
				duration : o.duration || LJ.ui.show_curtain_duration,
				complete : function(){

					var $curtain = $( this );

					$curtain.click(function(e){

						if( !$(e.target).hasClass('curtain') ) return;

						if( $curtain.hasClass('curtain--sticky') ){
							return LJ.wlog('Curtain is in sticky mode');
						}

						var $modalclose = $curtain.find('.modal__close');
						if( $modalclose.length > 0 ){
							return $modalclose.click();
						}

						LJ.ui.hideCurtain({
							duration: o.duration || LJ.ui.hide_curtain_duration
						});

					});

					resolve( $curtain );
				}
			});

		});
	},
	hideCurtain: function( o ){

		o = o || {};

		var duration = LJ.ui.hide_curtain_duration;
		if( o.duration ){
			duration = o.duration;
		}

		var delay = 0;
		if( o.delay ){
			delay = o.delay;
		}

		if( o.mode == "bounce" ){

			return LJ.promise(function( resolve, reject ){
				$('.curtain')
					.children()
					.velocity( "bounceOut", { duration: duration });

				$('.curtain').velocity('fadeOut', {
					duration: duration,
					delay: duration/2,
					complete: function(){
						$('.curtain').remove();
						resolve();
					}
				});

				});
		}

		return LJ.promise(function( resolve, reject ){
			$('.curtain').velocity( 'fadeOut', {
				duration : duration,
				delay    : delay,
				complete : function(){
					$('.curtain').remove();
					resolve();
				}
			});

		});
	},
	showLoader: function( loader_id ){

		loader_id = loader_id || 'no_id';
		$( LJ.static.renderStaticImage('main_loader') )
				 .attr('data-loaderid', loader_id)
				 .appendTo('body')
				 .velocity('fadeIn', { duration: 400 });

	},
	hideLoader: function( loader_id ){

		loader_id = loader_id || 'no_id';
		LJ.static.getLoader( loader_id )
				 .velocity('fadeOut', {
				 	duration : 250,
				 	complete : function(){
				 		$( this ).remove();
				 	}
				 });

	},
	render: function( html ){

		var $html = $( html );
		LJ.lang.translate( $html );
		LJ.pictures.applyFilterlay( $html );
		
		var template = '';
		$html.each(function( i, el ){
			template += $( el ).prop('outerHTML');
		});

		return template;

	},
	turnToJsp: function( element, options ){
		return LJ.promise(function(resolve, reject){

			if( !options.jsp_id ){
				LJ.wlog('Setting jsp without jsp_id');
			}

			LJ.delay(100).then(function(){ 

				$(element).jScrollPane();

				if( options.handlers ){
					options.handlers.forEach(function( h ){
						$(element).bind( h.event_name, h.callback );
					});
				}

				LJ.ui.jsp[ options.jsp_id ] = $(element).data('jsp');
				resolve();

			});
		});
	},
	renderIcon: function( icon_id, icon_classes ){

		var icon_class = icon_id;
		if( icon_classes && Array.isArray(icon_classes) ){
			icon_class += ' ' + icon_classes.join(' ');
		}

		return '<i class="icon icon-' + icon_class + '"></i>';
	},
	renderSessionDisconnected: function(){

		return LJ.ui.render([
				'<div class="disconnected">',
					'<div class="disconnected__icon --round-icon">',
						'<i class="icon icon-pending"></i>',
					'</div>',
					'<div class="disconnected__title">',
						'<h2 data-lid="disconnected_title"></h2>',
					'</div>',
					'<div class="disconnected__subtitle">',
						'<p data-lid="disconnected_subtitle"></p>',
					'</div>',
				'</div>'
			].join(''));

	},
	handleReconnection: function(){

		if( $('.curtain').length != 0 ){
			$('.curtain').velocity('fadeOut', {
				duration: 500,
				complete: function(){
					$( this ).remove();
					LJ.ui.handleReconnection();
				}
			})
		}

		LJ.wlog('Handling loss of internet connection');
		LJ.ui.reconnected_started_at = new Date();

		LJ.ui.showCurtain({ opacity: 0.95, duration: 500, sticky: true })
			.then(function(){

				$('.curtain').velocity({
					opacity: [ LJ.ui.reconnection_curtain_alpha, 1 ]}, {
                    duration: 300
                });

				$( LJ.ui.renderSessionDisconnected() )
					.hide()
					.appendTo('.curtain')
					.velocity('shradeIn', {
						duration: 500,
						display: 'flex'
					});

			});
	},
	activateHtmlScroll: function(){
		$('html').css({ 'overflow': 'auto' });
	},
	deactivateHtmlScroll: function(){
		$('html').css({ 'overflow': 'hidden' });
	},
	reconnectUser: function(){

        var delay = 3500 - ( (new Date()) - LJ.ui.reconnected_started_at );

        LJ.delay( delay )
        	.then( LJ.ui.shadeModal )
        	.then(function(){

	        	LJ.log('Launching reconnection process', 1);

                LJ.store.set("reconnecting", true); 
                document.location = "/home";

                });
	},
	adjustWrapperHeight: function( $w ){

			var height = $( window ).height() - LJ.ui.slide_top;
			$w.css({ height: height });

	},
	shradeIn: function( $element, duration ){

		var duration = duration || LJ.ui.shrade_duration;

		return LJ.promise(function( resolve, reject ){

			$element.velocity('shradeIn', {
				duration : duration,
				display  : 'flex',
				complete : resolve
			});

		});

	},
	shradeOut: function( $element, duration ){

		var duration = duration || LJ.ui.shrade_duration;

		return LJ.promise(function( resolve, reject ){

			$element.velocity('shradeOut', {
				duration : duration,
				display  : 'none',
				complete : resolve
			});

		});

	},
	shradeAndStagger: function( $wrap, options ){

			var d   = options.duration;
			var fit = options.fit || true;

			if( fit ){
				LJ.ui.adjustWrapperHeight( $wrap );
			}

			[ $wrap, $wrap.children() ].forEach(function( $el, i ){
				$el.css({ display: 'flex', 'opacity': 0 })
					.velocity('shradeIn', {
					duration: ( d*i*1.1 ),
					display : 'flex',
					delay   : ( d*0.6*i )
				});
			});

			return LJ.promise(function( resolve, reject ){
				return LJ.delay( d*0.6 + d*1.1 ).then( resolve );
			});

		}


});






	LJ.ui.simReco = function( time_offline ){
		LJ.ui.handleReconnection();
		LJ.delay( time_offline )
			.then( LJ.ui.reconnectUser );
	}






































	

window.LJ.fn = _.merge( window.LJ.fn || {}, {

	handleDomEvents_UI: function(){

		LJ.$logout.click(function(){
			LJ.user.app_preferences.ux.auto_login = 'no';
			LJ.fn.setLocalStoragePreferences();
			location.reload();

		});

		LJ.$body.on('click', '#thumbWrap img', function(){
			LJ.fn.displayUserProfile( LJ.user.facebook_id );
		});

		$('#search').click(function(){
			$(this).find('input').focus();
		});


		$('#search').mouseover(function(){

		});

		['#profile', '#events', '#settings'].forEach(function( menuItem ){

			var $menuItem = $( menuItem );

			$menuItem.click(function(){

			$menuItem.find('.bubble').addClass('filtered').text('');
	
			  if( LJ.state.freezing_ui || $menuItem.hasClass('menu-item-active') || ($menuItem.hasClass('disabled')) )
			  	return;

			  		LJ.state.freezing_ui = true;
					
					var linkedContent = $menuItem.data('linkedcontent');
					
					var indexActive = $('.menu-item-active').offset().left,
						indexTarget = $menuItem.offset().left;

					if( indexActive > indexTarget ){
						var myWayOut = LJ.ui.slideRightOutVeryLight || 'transition.slideRightOut' ; 
							myWayIn =  LJ.ui.slideLeftInLight || 'transition.slideLeftIn' ; 
					} else {
						var myWayOut = LJ.ui.slideLeftOutVeryLight || 'transition.slideLeftOut' ; 
							myWayIn =  LJ.ui.slideRightInLight || 'transition.slideRightIn' ; 
					}

					$('.menu-item-active').removeClass('menu-item-active')
										  .find('span.underlay')
										  .velocity({ opacity: [0, 1], translateY: [-2, 0]   },
										   { duration: 250,
										   complete: function(){
										   	$menuItem.addClass('menu-item-active')
													   .find('span.underlay')
												   	   .velocity({ opacity: [1, 0], translateY: [0, -2]   }, { duration: 300 });
										   	} 
										});

					var duration_time = 500;
					if( !$menuItem.is('#events') ){

						// LJ.fn.refreshMap();
						$('.row-events-accepted-tabview').velocity('transition.slideDownOut', { duration: duration_time });
						$('.row-events-accepted-inview.active').velocity('transition.slideDownOut', { duration: duration_time });
						$('.row-events-filters, .row-preview').velocity('transition.slideUpOut', { duration: duration_time });

					} else {

						$('.row-events-accepted-tabview').velocity('transition.slideUpIn', { duration: duration_time });
						$('.row-events-accepted-inview.active').velocity('transition.slideDownIn', { duration: duration_time });
						setTimeout(function(){
							$('.row-events-filters').velocity('transition.slideDownIn', { duration: duration_time, display: 'flex' });
							if( $('.row-preview').children().length > 0 ){
								$('.row-preview').velocity('transition.slideDownIn', { duration: duration_time, display: 'flex' });
							}
						}, 300 );
						
					}

					LJ.fn.displayContent( linkedContent, {
						myWayOut: myWayOut,
						myWayIn : myWayIn, 
						prev:'revealed',
						duration: 320
					});


				
			  
			});
		});

	},
	displayContent: function( content, options ){
		
			options = options || {};

		if( !options.mode ){
			
			var prev = options.prev;			
			var $prev = $('.'+options.prev);	

			$prev.velocity( options.myWayOut || 'transition.fadeOut', {	
				duration: options.duration || 0,
				display: 'none',
				complete: function(){
					$prev.removeClass( prev )
					$(content).addClass( prev )
						   .velocity( options.myWayIn || 'transition.fadeIn', {
						   	duration: 0 || 450,
						   	display:'block',
						   	complete: function(){
						   		LJ.state.freezing_ui = false;
						   		if(LJ.user.status === 'new'){
						   			//LJ.fn.toggleOverlay('high', LJ.tpl.charte );
						   		}
						   		options.after_cb && options.after_cb();
						   		LJ.fn.adjustAllInputsWidth( content );

						   	}
						   });
				}
			});
		}

		if( options.mode == 'curtain' ) {

			var prev = options.prev;			
			var $prev = $('.'+options.prev);
			
			var parallelTheScene = function(){
				if( options.parallel_cb ){
					options.parallel_cb();
				}
			};

			var behindTheScene = function(){

				options.during_cb();
				$prev.removeClass( prev );
				$(content).addClass( prev )
					   .show()
					   .css({'display':'block'});

			};

			var afterTheScene = function(){
				options.after_cb();
			}

			LJ.fn.displayCurtain({
				parallelTheScene : parallelTheScene,
				behindTheScene   : behindTheScene,
				afterTheScene    : afterTheScene,
				delay			 : options.delay,
				static_delay     : false
			});
			
		} 


	},
	displayCurtain: function( opts ){

		var opts = opts || {};

		var behindTheScene   = opts.behindTheScene   || function(){ LJ.fn.log('Behind the scene'); },
			afterTheScene    = opts.afterTheScene    || function(){ LJ.fn.log('after the scene');  },
			parallelTheScene = opts.parallelTheScene || function(){},

			delay          = opts.delay    || 500,
			static_delay   = opts.static_delay || false,
			show_duration  = opts.duration || 800;
			hide_duration  = opts.hide_duration || show_duration;



		var $curtain = $('.curtain');

		if( $curtain.css('opacity') != '0' || $curtain.css('display') != 'none' ){
			var init_duration = 10;
		}

			$curtain
			.velocity('transition.fadeIn',
			{ 
				duration: init_duration || show_duration, //simuler l'ouverture instantane
			  	complete: function(){
			  		behindTheScene();
			  		if( static_delay ){
			  			setTimeout(function(){
			  				$curtain.trigger('curtain:behindthescene:done');
			  			}, delay );
			  		} else {
			  			// The curtain will fall down when behindTheScene has finished working
			  		}
			  	}
			})
			
			$curtain.one('curtain:behindthescene:done', function(){
				
				$(this)
				.velocity('transition.fadeOut',
				{	
					display : 'none',
					duration: hide_duration,
					complete: afterTheScene
				});

			});
			

			parallelTheScene();


	},
	toastMsg: function( msg, status, fixed ){

		var toastStatus, toast, tpl;

		if( status == 'error' ){
			    toastStatus = '.toastError',
				tpl = LJ.tpl.toastError;
		}
		if( status == 'info' ){
			    toastStatus = '.toastInfo',
				tpl = LJ.tpl.toastInfo;
		}
		if( status == 'success'){
			    toastStatus = '.toastSuccess',
				tpl = LJ.tpl.toastSuccess;
		}

		if( typeof status == 'undefined' ){
			toastStatus = '.toastInfo'; 
			tpl = LJ.tpl.toastInfo;
		}			

		if( $( '.toast' ).length === 0 )
		{
			$( tpl ).prependTo('#mainWrap');

			    toast = $( toastStatus );
				toastMsg = toast.find('.toastMsg');
				toastMsg.text( msg );

				toast.velocity('transition.slideDownIn', {
					duration: 600,
					complete: function(){

					  if( typeof(fixed) == 'string' )
					  	return

						toast.velocity('transition.slideUpOut', {
							duration:300,
							delay: fixed || 2000,
							complete: function(){
								toast.remove();
								if( LJ.msgQueue.length != 0 )
									LJ.fn.toastMsg( LJ.msgQueue[0].msg, LJ.msgQueue[0].type );
								    LJ.msgQueue.splice( 0, 1 ) //remove le premier lment
							}
							});						
					  }
				});
		}
		else
		{
			LJ.msgQueue.push({ msg: msg, type: status });
		}
	},
	replaceModalTitle: function( message, classes ){

		$('.modal-title').velocity( LJ.ui.slideUpOutLight, {
			complete: function(){
				$(this).text( message )
					.addClass( classes && classes.join(' ') )
					.velocity( LJ.ui.slideDownInLight );
			}
		});
						 

	},
	showLoaders: function(){

    	$( '.loaderWrap, .m-loaderWrap' ).velocity( 'fadeIn', { duration: 400 });

    },
    hideLoaders: function(){

        $( '.loaderWrap, .m-loaderWrap' ).velocity( 'fadeOut', { duration: 250 });

    },
    displayModal: function( callback ){
		
		$('.modal-curtain')
			.css({'display':'block'})
			.velocity({ 'opacity': [0.66,0] });

		$('.modal-container')
			.find('.modal-container-body').html( LJ.$curtain_loader ).end()
			.css({'display':'block'})
			.velocity({ 'opacity': [1,0] });

		$('.curtain-loader').velocity('transition.fadeIn', { delay: 200, duration: 300});

	},
	hideModal: function( callback ){

		$('.row-events-map').show();
		$('.modal-curtain')
			.velocity({ 'opacity': [0,0.66] }, { complete: function(){
				$('.modal-curtain').css({ display: 'none' }); }
		}).delay(500).velocity({
			complete: function(){
				typeof( callback ) == 'function' && callback();
			}
		})

		$('.modal-container')
			.velocity({ 'opacity': [0,1] }, { complete: function(){
				$('.modal-container').css({ display: 'none', height: 'auto', width: 'auto' });
				$(".modal-container-body *:not('.curtain-loader')").remove(); 
			}
		});

		$('.curtain-loader').hide();

	},
	displayInModal: function( options ){

		var options = options || {};

		var call_started = new Date();
		LJ.fn.displayModal();

		var eventName = 'display-content';

		$('.modal-container').css({ width: options.starting_width });
		$('.modal-container').on( eventName, function( e, data ){

			var content = data.html_data;
			var starts_in = LJ.ui.minimum_loading_time - ( new Date() - call_started );
			setTimeout(function(){
				
				var $content = $(content);

				options.custom_classes && options.custom_classes.forEach( function( class_itm ){
					$content.addClass( class_itm );
				});

				options.custom_data && options.custom_data.forEach(function( el ){
					$content.attr('data-'+el.key, el.val );
				}); 

				$content.hide().appendTo('.modal-container-body');

				$content.imagesLoaded(function(){


					$('.curtain-loader').velocity('transition.fadeOut', { duration: 300 });

					var old_height = $('.modal-container').innerHeight(),
						new_height = old_height + $('.modal-container-body > div').innerHeight() + ( options.fix_height || 0 );

					var old_width = options.starting_width,
						new_width = old_width + $('.modal-container-body > div').innerWidth();


					new_height = new_height > options.max_height ? options.max_height : new_height;

					var duration = new_height > 400 ? 450 : 300;

					$('.modal-container')
						.velocity({ height: [ new_height, old_height ], width: [ new_width, old_width ] }, { 
								duration: duration,
								complete: function(){
									$content.css({'display':'block','opacity':'0'});
									options.predisplay_cb && options.predisplay_cb();
									$content.velocity('transition.fadeIn');
								} 
						});
				});


			}, starts_in );

		});

		if( options.source === 'server' )
		{
			$.ajax({
				method:'GET',
				url: options.url,
				beforeSend: function( req ){
					req.setRequestHeader('x-access-token', LJ.accessToken );
				},
				success: function( data ){
					var html_data = options.render_cb( data );
					$('.modal-container').trigger( eventName, [{ html_data: html_data }]);
				},
				error: function(){
					var html_data = options.error_cb();
					$('.modal-container').trigger( eventName, [{ html_data: html_data }]);
				},
				complete: function(){
					$('.modal-container').unbind( eventName );
				}
			});
		}

		if( options.source === 'facebook' )
		{	
			LJ.fn.log('Calling Facebook graph api');
			LJ.fn.GraphAPI( options.url, function(res){

				if( !res && !res.data ) {
					LJ.fn.log('Error, cannot display photos from fb')
					LJ.fn.log(res);
					var html_data = options.error_cb();
				} else {
					var html_data = options.render_cb( res.data );
				}
				
				$('.modal-container').trigger( eventName, [{ html_data: html_data }]);
				$('.modal-container').unbind( eventName );

			});
		}

		if( options.source === 'local' )
		{
			setTimeout( function(){

				var html_data = options.render_cb();
				$('.modal-container').trigger( eventName, [{ html_data: html_data }]);
				$('.modal-container').unbind( eventName );

			}, LJ.ui.minimum_loading_time );
		}

	},
	bubbleUp: function( el, opts ){
		
		var opts = opts || {};

    	var $el = $(el);

    	if( !opts.stack ){
			if( $el.hasClass('active') ){
				return;
			}				
		}

    	var $bubble = $el.find('.bubble'),
    		n = $bubble.text().trim().length == 0 ? 0 : parseInt( $bubble.text() );

    	$bubble.removeClass('filtered').removeClass('none');

    	var add = opts.add || 1;

    		if( add > 99 ) 
    			return $bubble.text('99+');
		
		var set = opts.set || null;

		if( set == 0 )
			return $bubble.addClass('none').text('');

    	return $bubble.text( set || n + add );
		

    },
    bubbleUpMessage: function( chat_id ){

    	var event_id = chat_id.split('-')[0];
        var group_id = chat_id.split('-')[1];

        LJ.fn.bubbleUp('.row-events-accepted-inview[data-eventid="' + event_id + '"] \
            .event-accepted-chatgroup[data-groupid="' + group_id + '"]');

        // Update the tabview & page title
        LJ.fn.updateTabviewBubbles( event_id );

    },
    // Crawl all messages of each tabview for one event, and update the event tabview bubble
    // along with the page title if nmsg > 0;
    updateTabviewBubbles: function( event_id ){


    	var n_messages_unread = 0;

    	$('.row-events-accepted-inview[data-eventid="' + event_id + '"]')
    		.find('.event-accepted-chatgroup')
    		.each(function( i, chatgroup ){

    			var $chatgroup = $( chatgroup );

    			if( $chatgroup.hasClass('active') ){
    				$chatgroup.find('.bubble').addClass('none').text('');
    			} else {
    				n_messages_unread += parseInt( $chatgroup.find('.bubble').text() || 0 );
    			}

    		});

    	LJ.fn.bubbleUp('.event-accepted-tabview[data-eventid="' + event_id + '"]', {
			set   : n_messages_unread + '',
			stack : true 
    	});

    	if( n_messages_unread == 0 ){
    		document.title = LJ.page_default_title;
    	} else {
    		document.title =  n_messages_unread + "  message(s) - " + LJ.page_default_title;
    	}


    },
   	displayUserProfile: function( facebook_id ){

		LJ.fn.displayInModal({ 
			url: '/api/v1/users/' + facebook_id,
			source: 'server',
			starting_width: 300,
			render_cb: LJ.fn.renderUserProfileInCurtain,
			error_cb: LJ.fn.renderUserProfileInCurtainNone
		});
		
	},
	showLoadersInChat: function( $chat_wrap ){

	$chat_wrap.find('.event-accepted-chat-message').velocity({ opacity: [ 0.3, 1 ]});

        $('<div class="load-chat-history">Chargement des messages...</div>')
            .addClass('super-centered none')
            .appendTo( $chat_wrap )
            .velocity('transition.fadeIn', {
                duration: 400
            });

        LJ.$spinner_loader_2
            .clone()
            .addClass('super-centered none').css({ "width": "30px", "display": "none" })
            .appendTo( $chat_wrap )
            .velocity('transition.fadeIn',{
                duraton: 600
            });
	},
	stageUserForWhisper: function( facebook_id, chat_id ){

		var $chat_wrap = $('.event-accepted-chat-wrap[data-chatid="' + chat_id + '"]');
		var $user_img  = $chat_wrap.find('.event-accepted-chat-message[data-authorid="' + facebook_id + '"] img');

		if( facebook_id == LJ.user.facebook_id ){
			return console.error('Cant whisper to himself');
		}

		if( $chat_wrap.length != 1 ){
			return console.error('Couldnt find chatwrap for whisper stage');
		}

		if( $user_img.length == 0 ){
			return console.error('Couldnt find img to clone for whisper stage');
		}

		// The img tag is already there as whisper
		if( $user_img.hasClass('whispering') ){

			LJ.fn.log('Already whispering, removing...');

			$user_img.removeClass('whispering');
			$chat_wrap.find('.img-input-whisper[data-authorid="' + facebook_id + '"]')
					  .velocity('transition.slideRightOut', { duration: 500, complete: function(){ 
					  	$(this).remove();
					  	LJ.fn.adjustAllWhisperOnInput( $chat_wrap );
					  } });
		} else {

			LJ.fn.log('First time whispering, adding...');

			$user_img.addClass('whispering')
			$user_img.first().clone().addClass('img-input-whisper').attr('data-authorid', facebook_id )
					 .appendTo( $chat_wrap.find('.event-accepted-chat-typing') )
					 .velocity('transition.slideLeftIn', { duration: 500 })
					 .click(function(){
					 	LJ.fn.stageUserForWhisper( facebook_id, chat_id );
					 });
					 LJ.fn.adjustAllWhisperOnInput( $chat_wrap );



		}


	},
	adjustAllWhisperOnInput: function( $chat_wrap ){

		var imgs = $chat_wrap.find('.img-input-whisper');

		if( imgs.length == 0 ){
			$chat_wrap.find('.event-accepted-chat-typing').normalify();
			// return;
		}
		if( imgs.length == 1 ){
			$chat_wrap.find('.event-accepted-chat-typing').whisperify();
			//return;
		}

		// Adjust imgs position
		var step = imgs.first().outerWidth( true ) - 5;
		imgs.each(function( i, img ){
			$( img ).css({ "left": ( i * step )+ 'px', "z-index": 10 + i });
		});

		// Adjust input padding
		var new_padding = imgs.length == 0 ? 10 : ( step * imgs.length - 5 );
		$chat_wrap.find('input').css({ "padding-left": new_padding + 'px'});

	},
	whisperifyChatMessages: function( chat_id ){

		var $chat_wrap = $('.event-accepted-chat-wrap[data-chatid="' + chat_id + '"]');

		if( $chat_wrap.length != 1 ){
			return LJ.fn.warn('Couldnt find one chatwrap based on id : ' + chat_id );
		}

		$chat_wrap
			.find('.event-accepted-chat-message')
			.each(function( i, chat ){

				var $chat = $(chat);

				if( $chat.attr('data-whisperto') == 'null' || !$chat.attr('data-whisperto') )
					return;
				
				LJ.fn.whisperify({
					whisper_to  : $chat.attr('data-whisperto').split(','),
					facebook_id : $chat.attr('data-authorid')
				})( $chat );

			});

	},
	updateTabviewIconStatus: function(){

		var $tabviews = $('.event-accepted-tabview');

		$tabviews.each(function( i, tab ){

			var event_id = $( tab ).attr('data-eventid');
			var status = LJ.fn.iStatus( event_id );
	    	var icon_status = "star"; // default in case nothing found

		    if( status == "accepted" ){
		    	icon_status = "chat";
		    }

		    if( status == "kicked" || status == "pending" ){
		    	icon_status = "ellipsis";
		    }

		    if( status == "hosting" ){
		    	icon_status = "star-1";
		    }

		    $( tab ).attr('data-status', status );

		});

	},
	displayLink: function( width ){

		var $link = $('.row-events-link');
		if( $link.length ){
			$link.remove();
		}

		$('<div class="row-events-link"></div>').insertAfter('.row-events-preview');
		var $link = $('.row-events-link');

		var $events_preview = $('.row-events-preview');
		var $party_preview  = $('.row-party-preview');

		var offset = $events_preview.outerWidth(true) - $events_preview.css('padding-right').split('px')[0];

		$link.css({ display: 'none', width: '0' })
			 .css({ left: offset, display: 'block' })
			 .css({ width: width || 300 });

	}


});

	window.LJ.ui = _.merge( window.LJ.ui || {}, {
		
		max_bubble: 9,

		formatElem: function( elem ){

			var $elem = null;
			if( elem instanceof jQuery ){
				$elem = elem;
			}
			if( typeof elem == 'string' && $( elem ).length == 1 ){
				$elem = $( elem );
			}

			if( !$elem ){
				LJ.wlog('Unable to construct proper elem to setup a bubble');
				return null;
			} else {
				return $elem;
			}

		},
		handleDomEvents: function(){

		},
		showBubble: function( elem ){

			LJ.ui.setBubble( elem, "show" );

		},
		hideBubble: function( elem ){

			LJ.ui.setBubble( elem, "hide" );

		},
		bubbleUp: function( elem ){

			var n = parseInt( $(elem).find('.bubble__number').text().replace('+','') );
			LJ.ui.setBubble( elem, n + 1 );

		},
		bubbleDown: function( elem ){

			var n = parseInt( $(elem).find('.bubble__number').text().replace('+','') );
			LJ.ui.setBubble( elem, n - 1 );

		},
		setBubble: function( elem, n, already_added ){

			// Validation happens here because it centralizes all other calls
			var $elem = LJ.ui.formatElem( elem );
			if( !$elem ) return;

			var $bubble      = $elem.find('.bubble');
			var $bubble_text = $bubble.find('.bubble__number');

			// Bubble element doesnt exist, create it and add n bubbles
			if( $bubble_text.length != 1 ){
				if( already_added ){
					return LJ.wlog('Unable to setup bubble, element probably didnt exist');
				}
				LJ.ui.addBubble( elem );
				if( n != 0 && !n ){
					n = 1;
				}
				return LJ.ui.setBubble( elem, n, true );
			}

			if( n == "show" ){
				return $bubble.show();
			}

			if( n == "hide" ){
				return $bubble.hide();
			}

			if( n <= 0 ){
				$bubble.hide();
				$bubble_text.text(0);
				return;
			}

			if( n >= LJ.ui.max_bubble ){
				$bubble_text.text( LJ.ui.max_bubble + '+');
			} else {
				$bubble_text.text( n );
			}

			$bubble.show();

		},
		addBubble: function( elem ){

			// LJ.log('Adding bubble for the first time');
			$( LJ.ui.renderBubble() )
				.appendTo( elem );

		},
		renderBubble: function(){

			return LJ.ui.render([
				'<div class="bubble --round-icon">',
					'<div class="bubble__number"></div>',
				'</div>'
				].join(''));

		}

	});

	window.LJ.ui = _.merge( window.LJ.ui || {}, {

		ioptions_show_duration: 450,
		ioptions_hide_duration: 400,

		showIoptions: function( $wrap, html ){

			$('<div class="ioptions ioptions-overlay"></div>')
				.hide()
				.appendTo( $wrap )
				.velocity('fadeIn', {
					duration : LJ.ui.ioptions_show_duration,
					display  : 'flex'
				});

			$( html )
				.hide()
				.appendTo('.ioptions')
				.velocity('shradeIn', {
					duration : LJ.ui.ioptions_show_duration,
					delay    : LJ.ui.ioptions_show_duration/2,
					display  : 'flex'
				});

			$wrap.find('.js-ioptions-close').click( LJ.ui.hideIoptions );

		},
		updateIoptions: function( html ){

			var $iop = $('.ioptions');

			$iop
				.children()
				.velocity('shradeOut', {
					duration : LJ.ui.ioptions_hide_duration
				});

			$( html )
				.hide()
				.appendTo( $iop )
				.velocity('shradeIn', {
					duration : LJ.ui.ioptions_show_duration,
					delay    : LJ.ui.ioptions_hide_duration,
					display  : 'flex'
				});

			$iop.find('.js-ioptions-close').click( LJ.ui.hideIoptions );

		},
		hideIoptions: function(e){

			if(e) e.stopPropagation();
			
			var $w = $(this).closest('.ioptions');

			$w.velocity('fadeOut', {
				duration: LJ.ui.ioptions_hide_duration,
				complete: function(){
					$(this).remove();
				}
			});

		}

	});

	window.LJ.ui = _.merge( window.LJ.ui || {}, {

		show_modal_duration: 350,
		hide_modal_duration: 350, 
		show_modal_delay   : 200,
		hide_modal_delay   : 100,

		facebook_img_min_width: 200,
		facebook_img_max_width: 300,

		showModalAndFetch: function( options ){
			return LJ.promise(function( resolve, reject ){
				LJ.Promise.all([
					options.fetchPromise(),
					LJ.ui.showModal( _.extend(options, {show_loader: true}) )
				]).then(function( results ){
					resolve( results[0] );
				}).catch(reject);

			})

		},	
		showModal: function( options ){
			return LJ.promise(function( resolve, reject ){

				options = options || {};

				var $modal = $( LJ.ui.renderModal( options ) );

				LJ.ui.showCurtain({ duration: 500, opacity: .75 })

				$modal.hide()
					  .appendTo( $('.curtain') )
					  .velocity('shradeIn', {
					  	delay: LJ.ui.show_modal_delay,
					  	display: 'flex',
					  	duration: LJ.ui.show_modal_duration,
					  	complete: function(){

					  		if( options.jsp_body ){
					  			$('.modal-body').jScrollPane();
					  		}

					  		if( options.search_input ){
					  			var item_id = $('.modal').attr('data-item-id');
					  			$('.modal-item[data-item-id="' + item_id + '"]').remove();
					  		}

					  		return resolve();
					  	}
					  })
					  .on('click', '.modal__close', LJ.ui.hideModal )

			});
		},
		hideModal: function(){
			return LJ.promise(function( resolve, reject ){

				$('.modal').velocity('shradeOut', {
					duration: LJ.ui.hide_modal_duration
				});

				$('.curtain').velocity('fadeOut', {
					duration: LJ.ui.hide_modal_duration,
					delay: LJ.ui.hide_modal_delay,
					complete: function(){
						$(this).remove();
						resolve();
					}
				});
			})

		},
		shadeModal: function(){
			return LJ.promise(function( resolve, reject ){

				$('.modal').velocity('bounceOut', {
					duration: 600,
					display : 'none'
				});

				LJ.delay(300)
					.then(function(){
						$('.curtain')
							.css({ 'transition': 'all ease-in-out .6s' })
							.css({ 'background': 'rgba(19,19,19,1) '});
					})
					.then(function(){
						return LJ.delay(600)
					})
					.then(function(){
						$('.curtain')
							.css({ 'transition': 'none' });
						resolve();
					})

			});
		},
		renderModal: function( options ){

			var modifier  = '--' + options.type;

			if( !options.body ){
				body_html = '';
			} else {
				body_html = '<section class="modal-body">' + options.body + '</section>';
			}

			if( options.show_loader ){
				body_html = '<section class="modal-body">' + LJ.static.renderStaticImage('modal_loader') + '</section>';
			}

			var attributes = [];
			if( options.attributes ){
				options.attributes.forEach(function( attr_object ){
					attributes.push('data-' + attr_object.name  + '="' + attr_object.val + '"');
				});
			}
			if( options.max_items ){
				attributes.push('data-max-items="'+ options.max_items +'"' );
			}
			attributes = attributes.join(' ');

			var search_input_html = '';
			var disabled = '';
			if( options.search_input ){
				disabled = '--disabled';
				search_input_html = LJ.ui.renderModalSearchInput();
			}

			var footer_html = [
				'<footer class="modal-footer">',
					options.footer,
				'</footer>'
			].join('');

			if( options.no_footer ){
				footer_html = '';
			}

			return [

				'<div class="modal ' + modifier + ' ' + disabled + '" ' + attributes + '>',
					'<header class="modal-header">',
						'<div class="modal__close">',
							LJ.ui.renderIcon('cancel'),
						'</div>',
						'<div class="modal__title">',
							'<h1>' + options.title + '</h1>',
						'</div>',
					'</header>',
					'<div class="modal-subheader">',
						options.subtitle,
					'</div>',
					search_input_html,
					body_html,
					footer_html,
				'</div>'

			].join('');

		},
		renderModalSearchInput: function(){

			return LJ.ui.render([
					'<div class="modal-search__input">',
						'<input data-lid="modal_search_input_placeholder" />',
					'</div>'
				].join(''));

		},
		filterModalResults: function(){
			
			
			LJ.delay( 100 ).then(function(){
				
				
				var $modal = $('.modal');
				var $input = $modal.find('.modal-search__input input');
				var text   = $input.val().toLowerCase();

				if( text == '' ){
					return $('.modal-item').removeClass('nonei');
				}

				$('.modal-item:not(.--selected):not([data-name^="' + text + '"])')
					.addClass('nonei');

				$('.modal-item:not(.--selected)[data-name^="' + text + '"]')
					.removeClass('nonei');
					
				});	
							
		},
		handleModalItemClicked: function(){

			var $s = $(this);
			
			if( $s.hasClass('--noselect') ){
				return;
			}
			
			var max = $('.modal').attr('data-max-items');
			if( max && $('.modal-item.--selected').length == parseInt( max ) && !$s.hasClass('--selected') ){
				return LJ.wlog('Already max items');
			}

			var $modal = $('.modal');
			var $el = $('.friend-modal:not(.--selected)').first();

			$s.toggleClass('--selected').insertBefore( $el );

			if( $('.modal-item.--selected').length == 0 ){
				$modal.addClass('--disabled');
			} else {
				$modal.removeClass('--disabled');
			}
			$('.modal-search__input input').val('');
			
			LJ.ui.filterModalResults();

		},
		getModalItemIds: function( max ){
			return LJ.promise(function( resolve, reject ){

				if( !$('.modal').hasClass('js-listeners-attached') ){
					$('.modal').addClass('js-listeners-attached');
					$('.modal-item').click( LJ.ui.handleModalItemClicked );
				}

				$('.modal__close').click( reject );
				$('.modal-footer button').click(function(){

					var $modal = $('.modal');
					if( $modal.hasClass('--disabled') ){
						return;
					} else {
						$modal.addClass('--pending');
					}

					var item_ids = [];
					$('.modal-item.--selected').each(function( i, itm ){
						item_ids.push( $(itm).attr('data-item-id') );
					});
					
					resolve( item_ids );

				});


			});

		},
		noSelectModalRow: function( item_id, message ){
			
			var $item = $('.modal-item[data-item-id="'+ item_id +'"]');

			$item.find('.item-modal__noselect').remove(); // clear
			$item.removeClass('--selected')
				 .addClass('--noselect')
				 .append('<span class="item-modal__noselect">'+ message +'</span>');


		},
		cancelify: function( opts ){

			if( opts.$wrap.length == 0 ) return;

			LJ.ui.shadeify( opts.$wrap, 400 );

			var html = [ '<div class="ui-overlay__message">',
				opts.message_html,
			'</div>' ].join('');

			$( html ).hide()
					 .appendTo( opts.$wrap )
					 .velocity('shradeIn', {
					 	duration : 400,
					 	delay    : 350,
					 	display  : 'flex'
					 });

			LJ.delay( opts.duration || 5000 ).then(function(){
				if( typeof opts.callback == "function" ){
					opts.callback();
				}
			});

		},
		shadeify: function( $wrap, duration, theme ){

			var theme = theme || "dark";
			var final_opacity = theme == "dark" ? 0.7 : 1;

			$('<div class="ui-overlay ui-overlay--'+ theme +'"></div>')
				.css({ 'opacity': 0 })
				.appendTo( $wrap )
				.velocity({ opacity: [ final_opacity, 0 ] }, {
					duration : duration,
					display  : 'flex'
				});

		},
		synchronify: function( opts ){

			return LJ.promise(function( resolve, reject ){

				if( opts.$wrap.length == 0 ){
					return reject("No $wrapper element was found");
				};

				LJ.ui.shadeify( opts.$wrap, 400, 'light' );

				var content = '<div class="ui-overlay__message">' + opts.message_html + '</div>';
				var loader  = LJ.static.renderStaticImage('slide_loader');

				$('<div class="ui-synchronify">'+ content + loader + '</div>')
						 .hide()
						 .appendTo( opts.$wrap )
						 .velocity('shradeIn', {
						 	duration : 400,
						 	delay    : 350,
						 	display  : 'flex'
						 });

				LJ.delay( 400 ).then( resolve );
				
			});

		},
		desynchronify: function( opts ){

			if( opts.$wrap.length == 0 ){
				return LJ.warn("No $wrapper element was found");
			};

			$( opts.$wrap.find('.ui-overlay, .ui-synchronify') )
				.velocity('fadeOut', {
					duration : 350,
					complete : function(){
						$( this ).remove();
					}
				})


		}

	});






	testModal = function(){
		LJ.ui.showModal({
			"title": "Flicitations !",
			"subtitle": "Vous allez dsormais pouvoir crer votre propre vnement priv avec vos amis.",
			"body": "Then there goes the body...",
			"footer": "<button class='--rounded'><i class='icon icon-check'></i></button>"
		});
	};

	testModalFetch = function(){

		LJ.ui.showModalAndFetch({

			"type"			: "facebook",
			"title"			: "Flicitations fetch!",
			"subtitle"		: "Vous allez dsormais pouvoir crer votre propre vnement priv avec vos amis.",
			"footer"		: "<button class='--rounded'><i class='icon icon-plus'></i></button>",

			"fetchPromise"	: LJ.facebook.fetchProfilePictures

		}).then(function( results ){
			console.log('Call went thru!');
			
			var html = [];
			results.data.forEach(function( picture_object ){
				picture_object.images.forEach(function( image_object ){
					if( image_object.width > LJ.ui.facebook_img_min_width && image_object.width < LJ.ui.facebook_img_max_width ){
						html.push( LJ.facebook.renderPicture( image_object.source ) );
					}
				});
			});

			$('.modal-body').append( html.join('') )
							.find('.modal__loader')
							.velocity('shradeOut', {
								duration: 500,
								delay: 1000,
								complete: function(){
									$(this).siblings()
										   .velocity('shradeIn', {
										   		display: 'block'
										   });
								}
							})

		});

	}

		
	window.LJ.ui = _.merge( window.LJ.ui || {}, {

		show_slide_duration: 450,
		show_slide_duration_children: 650,
		hide_slide_duration: 450,

		replace_slide_duration: 300,

		show_slide_delay   : 0,
		show_slide_delay_children: 500,
		hide_slide_delay   : 250,

		facebook_img_min_width: 200,
		facebook_img_max_width: 300,

		slide_top: 58,

		showSlideAndFetch: function( options ){

			var uiPromise;
			if( $('.slide.--'+ options.type ).length ){
				uiPromise = LJ.ui.replaceSlide
			} else {
				uiPromise = LJ.ui.showSlide
			}

			return LJ.promise(function( resolve, reject ){
				
				LJ.Promise.all([
					options.fetchPromise( options.promise_arg ),
					uiPromise( options )

				]).then(function( results ){
					resolve( results[0] );

				}, function( err ){

					if( typeof options.errHandler == "function" ){
						options.errHandler( err );
					}
					
				});
			})

		},
		replaceSlide: function( options ){
			return LJ.promise(function( resolve, reject ){

				var $l = $('.slide.--'+ options.type ).find('.slide__loader');
				
				$l.siblings(':not(.slide__close)').velocity('shradeOut', {
					duration : LJ.ui.replace_slide_duration,
					display  : 'none',
					complete: function(){
						$(this).remove();
						resolve();
					}
				});

				$l.velocity('shradeIn', {
					duration : LJ.ui.replace_slide_duration / 1.5,
					delay    : LJ.ui.replace_slide_duration
				})

			});
		},
		showSlide: function( options ){
			return LJ.promise(function( resolve, reject ){

				options = options || {};

				var $slide = $( LJ.ui.renderSlide( options ) );
				var height = $( window ).height() - LJ.ui.slide_top;

				$slide
					  .hide()
					  .appendTo('body')
					  .css({ 'top': LJ.ui.slide_top, 'height': height })
					  .velocity('shradeIn', {
					  	delay    : LJ.ui.show_slide_delay,
					  	display  : 'flex',
					  	duration : LJ.ui.show_slide_duration,
					  	complete : resolve
					  })
					  .on('click', '.slide__close', function(){
					  	LJ.ui.hideSlide( options );
					  	if( typeof options.complete == 'function' ) {
					  		options.complete();
					  	}
					  });

			});
		},
		showSlideOverlay: function( html ){

			var $wrap = $('.slide');

			LJ.ui.showIoptions( $wrap, html );


		},
		hideSlideOverlay: function(){

			var duration = LJ.ui.hide_slide_duration;

			$('.slide-overlay').velocity('fadeOut', {
				duration: duration,
				complete : function(){
					$(this).children().remove();
				}
			});

		},
		hideSlide: function( opts ){
			
			$('.slide.--' + opts.type ).velocity('shradeOut', {
				duration: LJ.ui.hide_slide_duration,
				complete: function(){
					$(this).remove();
				}
			});


		},
		renderSlide: function( options ){

			var body_html = options.body || LJ.static.renderStaticImage('slide_loader');
			var modifier  = '--' + options.type;

			var attributes = [];
			if( options.attributes ){
				options.attributes.forEach(function( attr_object ){
					attributes.push('data-' + attr_object.name  + '="' + attr_object.val + '"');
				});
			}
			attributes = attributes.join(' ');

			var header = '';
			if( options.title ){
				header = ['<header class="slide-header">',
						'<div class="slide__title">',
							'<h1>' + options.title + '</h1>',
						'</div>',
					'</header>'
					].join('');
			}

			var subheader = '';
			if( options.subtitle ){
				subheader = ['<div class="slide-subheader">',
						options.subtitle,
					'</div>'
					].join('');
			}

			var footer = '';
			if( options.footer ){
				footer = ['<div class="slide-subheader">',
						options.subtitle,
					'</div>'
					].join('');
			}

			return [

				'<div class="slide ' + modifier + '" ' + attributes + '>',
					header,
					subheader,
					'<section class="slide-body">',
						'<div class="slide__close --round-icon">',
							LJ.ui.renderIcon('cancel'),
						'</div>',
						body_html,
					'</section>',
					footer,
				'</div>'

			].join('');

		}

	});




	testSlide = function(){
		LJ.ui.showSlide({
			"title": "Flicitations !",
			"subtitle": "Vous allez dsormais pouvoir crer votre propre vnement priv avec vos amis.",
			"body": "<div> This is my super body </div>",
			"footer": "<button class='--rounded'><i class='icon icon-check'></i></button>",
			"type": "test"
		});
	};

	testSlideFetch = function(){

		LJ.profile_user.showUserProfile( LJ.user.facebook_id );

	}

	window.LJ.ui = _.merge( window.LJ.ui || {}, {

		msg_queue: [],
		$toast_info 	: '<div class="toast toast--info" class="none">'
								+ '</span><span class="toast__msg"></span>'
							+'</div>',
		$toast_error	: '<div class="toast toast--error" class="none">'
								+'</span><span class="toast__msg"></span>'
							+ '</div>',
		$toast_success	: '<div class="toast toast--success" class="none">'
								+'</span><span class="toast__msg"></span>'
							+ '</div>',

		showToast: function( msg, type, show_duration ){

			if([ 'success', 'info', 'error' ].indexOf( type ) == -1 ){
				type = 'success';
			}

			if( type == 'error' ){
				show_duration = 5000;
			}

			if( $( '.toast' ).length === 0 ){	
				var $toast = $( LJ.ui['$toast_' + type ] );

				$toast.appendTo( LJ.ui.$body )
						.css({ 'transform': 'translateX(-50%)!important'})
						.find('.toast__msg').text( msg );

				$toast.velocity('slideDownIn', {
					duration : 600,
					display  : 'flex',
					complete : function(){
						
						$toast.velocity('slideUpOut', {
							duration: 300,
							delay: show_duration || 3000,
							complete: function(){
								$(this).remove();
								if( LJ.ui.msg_queue.length != 0 )
									LJ.ui.showToast( LJ.ui.msg_queue[0].msg, LJ.ui.msg_queue[0].type );
								    LJ.ui.msg_queue.splice( 0, 1 ) //remove le premier lment
							}
							});						
					  }
				});
			}
			else {
				LJ.ui.msg_queue.push({ 
					msg: msg, 
					type: status 
				});
			}
		}

	});

window.LJ = _.merge( window.LJ || {}, {

    initAugmentations: function(){

        String.prototype.capitalize = function() {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }

        /* La base! */
        _.mixin({
            pluckMany: function() {
                var array = arguments[0],
                    propertiesToPluck = _.rest(arguments, 1);
                return _.map(array, function(item) {
                    return _.partial(_.pick, item).apply(null, propertiesToPluck);
                });
            }
        });

        // upgrading version
        _.pluck = _.map;

        $('body').on('mouseenter', '.jspContainer', function(){
            LJ.ui.deactivateHtmlScroll();
        });

        $('body').on('mouseleave', '.jspContainer', function(){
            LJ.ui.activateHtmlScroll();
        });

                
    },
    promise: function( callback ){
        return new Promise( callback );
    },
    Promise: Promise,

    storeItem: function( key, value ){

        if( !key || !value ){
            var object = key;
            key = _.keys( object )[0];
            value = object[key];
        }

        value = typeof value == 'object' ? JSON.stringify(value) : value;
        return localStorage.setItem( key, value );

        localStorage.setItem( key, value );

    },
    cacheUser: function( user ){

        if( !LJ.user ){
            LJ.log('Caching user for the first time');
            LJ.user = user;
            LJ.user.cheers = [];
            return LJ.user;
        } else {
            if( user.facebook_id == LJ.user.facebook_id ){
                LJ.log('Facebook_id matched, updating user cache');
                _.keys( user ).forEach(function( key ){
                    if( LJ.user.hasOwnProperty( key ) ){
                        LJ.user[ key ] = user[ key ];
                    }
                });
            } else {
                
            }
        }

    },
    isSameDay: function( d1, d2 ){
        return m1.dayOfYear() == m2.dayOfYear();

    },
    findMainPic: function( user ){

        var user = user || LJ.user;

        return _.find( user.pictures, function( p ){
            return p.is_main;
        });

    },
    delay: function( delay ){

        if( typeof delay != "number" ){
            delay = 1000;
        }

        return LJ.promise(function( resolve, reject ){
            setTimeout(function(){
                resolve();
            }, delay );
        })
    },
    hashtagify: function( str ){

        var hashtag_parts = [];

        str.toLowerCase().trim().split(/[\s_-]/).forEach(function( el, i ){

            if( i == 0 ){
                hashtag_parts.push( el );
            } else {
                if( el != '') {
                    var elm = el[0].toUpperCase() + el.substring(1);
                    hashtag_parts.push( elm );
                }
            }
        });

        return hashtag_parts.join('');

    },
    log: function log( message ){

        console.log( message );

    },
    wlog: function wlog( message ){
        
        console.warn( message );

    },
    tlog: function tlog( message ){
        
        console.trace( message );

    },
    elog: function elog( message ){

        console.error( message )

    },
    ilog: function ilog( message ){

        console.info( message );
        
    },
    getGhostUser: function(){

        var ghost_user = {

            facebook_id : 'ghost',
            name        : LJ.text('ghost_user_name'),
            age         : 18,
            job         : LJ.text('ghost_user_job'),
            img_id      : "ghost_user",
            img_vs      : "1468060134"

        }

        return ghost_user;

    },
    renderUserRow: function( user ){

        var filterlay = 'js-filterlay';

        if( !user || !user.img_id || !user.img_vs ){
            LJ.log('No user was provided, rendering ghost user instead');
            user = LJ.getGhostUser();
            filterlay = '';
        }

        var img_small = LJ.pictures.makeImgHtml( user.img_id, user.img_vs, "user-row" );

        var gender = user.g  || user.gender;
        var cc     = user.cc || user.country_code;

        return LJ.ui.render([

            '<div class="user-row js-user-profile" data-facebook-id="'+ user.facebook_id +'">',
                '<div class="user-row__pic '+ filterlay +'">',
                  img_small,
                  '<div class="user-gender --'+ gender +' js-user-gender"></div>',
                  '<div class="user-country js-user-country">',
                    '<i class="flag-icon flag-icon-'+ cc +'"></i>',
                  '</div>',
                '</div>',
                '<div class="user-row__informations">',
                  '<div class="user-row__about">',
                    '<span class="user-name">'+ user.name +'</span>',
                    '<span class="user-comma">,</span>',
                    '<span class="user-age">'+ user.age +'</span>',
                    '<span class="user-online user__status js-user-online" data-facebook-id="'+ user.facebook_id +'"></span>',
                    '<i class="icon icon-star user-host-icon"></i>',
                  '</div>',
                  '<div class="user-row__education">',
                    '<span class="user-row__education-icon --round-icon">',
                      '<i class="icon icon-education"></i>',
                    '</span>',
                    '<span class="user-row__education-label">'+ user.job +'</span>',
                  '</div>',
                '</div>',
          '</div>'

        ].join(''));

    },
    renderUserRows: function( users ){

        if( !Array.isArray( users ) ){
            return LJ.wlog('Cant render users row with empty array, users='+ users );
        }

        var user_rows = [];
        users.forEach(function( u ){
            user_rows.push( LJ.renderUserRow( u ) );

        });

        return user_rows.join('');


    },
    mainifyUserRow: function( $w, main_user ){

        var $rows = $w.find('.user-row');
        $rows.each(function( i, row ){

            var $r = $( row );
            if( $r.attr('data-facebook-id') == main_user ){
                $r.addClass('--main')
                      .addClass('js-main') // do not change the class, used by the validateRequest function
                      .insertBefore( $rows.first() );
            }

        }); 

    },
    generateId: function(){
        return LJ.randomInt( 100, 100000000000 );

    },
    randomInt: function(low, high) {
        return Math.floor(Math.random() * (high - low + 1) + low);

    },
    renderDate: function( date ){
        return moment( date ).format('hh:mm')
        
    },
    renderMultipleNames: function( names, opts ){
        
        opts = opts || {};

        if( typeof names == "string" ){
            names = [ names ];
        }

        if( !Array.isArray( names ) ){
            return LJ.wlog('Cannot render multiple names, wrong argument');
        }

        names = names.filter( Boolean );

        if( names.length == 0 ){
            return LJ.wlog('Cannot render multiple names, empty array');
        }

        var name_to_replace = opts.lastify_user;
        if( name_to_replace ){

            if( names.indexOf( name_to_replace ) == -1 ){
                return LJ.wlog('Cannot lastify name, doesnt exist in the array');
            }

            names.forEach(function( name, i ){
                if( name == name_to_replace ){
                    delete names[ i ];
                }
            });

            names.push( LJ.text("w_you") );
            return LJ.renderMultipleNames( names );

        }

        if( names.length == 1 ){
            return names[0];
        } 

        if( names.length == 2 ){
            return [ names[0], names[1] ].join(' ' + LJ.text('w_and') + ' ');
        }

        return [ names[0], LJ.renderMultipleNames( names.slice(1) ) ].join(', ');

    },
    renderManyMultipleNames: function( names ){
        
        names = Array.isArray( names ) ? names : [ names ];
        names.reverse();
        var T = names.length;
        var displayed = [].slice.call( arguments, -1 );


        if( typeof displayed != "number" ){
            displayed = 2;
        }

        if( displayed >= T - 1 ){
            displayed = T - 1;
        }

         if( names.length == 1 ){
            return names[0];
        }
        if( names.length == 2 ){
            return names[0] + ' '+ LJ.text('w_and') +' ' + names[1];
        }

        var cur = 1;
        var str = names.pop();

        while ( cur < displayed ){
            str += ', ' + names.pop();
            cur++;
        }

        str += ' '+ LJ.text('w_and') +' ' + names.length + ' ' + LJ.text('w_more');
        return str;


    },
    renderGroupName: function( name ){
        return name + ' & co';

    },
    swapNodes: function( a, b ){

        var aparent = a.parentNode;
        var asibling = a.nextSibling === b ? a : a.nextSibling;
        b.parentNode.insertBefore(a, b);
        aparent.insertBefore(b, asibling);

    },
    testTemplate: function( tplName, param, wrapper ){

        var html = LJ.fn[tplName]( param );

        if( wrapper ){
            html = '<div class="' + wrapper + '">' + html + '</div>';
        }

        $( html )
            .addClass('temp')

            .css({

                'opacity'   : '1',
                'left'      : '50%',
                'top'       : '50%',
                'z-index'   :'1000000000000',
                'transform' : 'translate(-50%,-50%)'

            })

            .appendTo('body');

        $('.temp').click(function(){ 

            $(this).remove(); 
            
        });

    },
    getDisconnectedAt: function(){

        return LJ.user.disconnected_at;

    },
    roughSizeOfObject: function( object ) {

            var objectList = [];
            var stack = [ object ];
            var bytes = 0;

            while ( stack.length ) {
                var value = stack.pop();

                if ( typeof value === 'boolean' ) {
                    bytes += 4;
                }
                else if ( typeof value === 'string' ) {
                    bytes += value.length * 2;
                }
                else if ( typeof value === 'number' ) {
                    bytes += 8;
                }
                else if
                (
                    typeof value === 'object'
                    && objectList.indexOf( value ) === -1
                )
                {
                    objectList.push( value );

                    for( var i in value ) {
                        stack.push( value[ i ] );
                    }
                }
            }
            return bytes;
        },
        isElementInViewport: function(el) {

            var rect = el[0].getBoundingClientRect();
            return ( rect.top >= 0 && rect.left >= 0 && rect.bottom <=  $(window).height() && rect.right <= $(window).width() );
        }


});
